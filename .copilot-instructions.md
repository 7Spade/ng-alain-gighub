# GitHub Copilot 工作區指示（ng-alain-gighub）

> **重要**：本檔案為 VS Code workspace 層級的 Copilot 總體行為指示。  
> 詳細規範請參考 `.github/agents/` 目錄中的完整文檔。

## 🎯 基本原則

### 語言與回應格式
- **一律使用正體中文回應**，除非使用者明確要求其他語言
- 技術術語保持英文原文（如 Component、Service、Signal、OnPush）
- 回應需包含：結論、實作步驟、風險與測試、人工複核事項

### 術語對照
使用以下術語映射：
- create = 建立, object = 物件, queue = 佇列, stack = 堆疊
- information = 資訊, invocation = 呼叫, code = 程式碼
- library = 函式庫, package = 套件, function = 函式
- Dependency Injection = 相依性注入, metadata = 中繼資料
- refresh = 重新整理, document = 文件, example = 範例

## 🏗️ 專案架構概述

### 技術棧
- **前端框架**：Angular 20（Standalone Components + Signals + OnPush）
- **UI 元件庫**：NG-ZORRO + ng-alain（@delon）
- **後端服務**：Supabase（Auth / Postgres / Storage / Edge Functions）
- **開發工具**：Node 20.19.5 + Yarn 4.9.2 + TypeScript 5.9（strict mode）

### 核心架構模型
- **Git-like Branch 模型**：主分支 ↔ 組織分支 ↔ 暫存區（48h 可撤回）
- **51 張資料表**：分為 11 個模組（帳戶、協作、權限、藍圖、任務、品質、問題、溝通、分析、Bot、系統）
- **分層架構**：`routes` → `shared` → `core`（嚴格單向依賴）

## 🔧 開發規範重點

### 元件開發
1. **Standalone Components**：所有元件必須為 Standalone，使用 `imports: [SHARED_IMPORTS]`
2. **Signals API**：
   - 狀態管理使用 `signal()` / `computed()` / `effect()`
   - Input/Output 使用 `input()` / `output()`
   - Query 使用 `viewChild()` / `contentChild()`
   - 禁止使用舊式 `@Input()` / `@Output()` 裝飾器
3. **Modern Control Flow**：模板使用 `@if` / `@for` / `@switch` / `@defer`，搭配 `track` 追蹤
4. **OnPush 策略**：預設使用 `ChangeDetectionStrategy.OnPush`，避免模板直接呼叫函數

### UI 元件優先順序
1. **優先使用 NG-ZORRO**：表單、表格、佈局、導航等基礎元件
2. **其次使用 @delon/abc**：高階業務元件（如 `st`、`sv`、`se`）
3. **最後才自建元件**：確認無現成解決方案後再自行實作

### 資料與安全
1. **RLS 策略**：所有資料表必須配置 Supabase RLS Policy
2. **身份驗證**：僅透過 `@delon/auth TokenService` 存取 token
3. **權限控制**：結合 Supabase RLS 與 `@delon/acl` 前端權限
4. **禁止硬編碼**：API 金鑰、角色、URL 等敏感資訊必須使用環境變數

### 路徑別名
- `@core`：核心服務、攔截器、Supabase 整合（僅從根 index 匯出）
- `@shared`：共享元件、服務、工具（僅從根 index 匯出）
- `@env`：環境設定
- **禁止深層 alias**：不可使用 `@core/services/xxx`，只能 `@core`

### TypeScript 規範
- 啟用 strict mode，所有類型必須明確定義
- 禁止使用 `any`，必要時使用 `unknown` 並進行類型保護
- 表單使用 `NonNullableFormBuilder` 與 `FormGroup<T>` / `FormControl<T>`
- async 流程必須有完整的錯誤處理

## ✅ 必要驗證流程

### 每次變更後執行
```bash
yarn lint              # ESLint 檢查
yarn lint:style        # Stylelint 檢查
yarn type-check        # TypeScript 類型檢查（如有配置）
yarn test --watch=false # 單元測試
yarn build             # 建構驗證
```

### 安全檢查
```bash
yarn audit --groups dependencies --level moderate
# gitleaks detect --source . --no-git  # 若有安裝
```

## 📚 參考文件路徑

### 優先參考（.github/agents/）
- `copilot-instructions.md`：最小提醒與快速參考
- `ng-project-agent.md`：專案架構、分支模型、資料表概述
- `role.agent.md`：角色守則與工作流程
- `docs-index.md`：完整文件索引

### 領域檢查清單（.github/agents/domain/）
- `angular-agent.md`：Angular 20 開發規範
- `typescript-agent.md`：TypeScript 類型安全
- `security-agent.md`：安全與 RLS 策略
- `code-quality-agent.md`：程式碼品質標準
- `testing-agent.md`：測試規範
- `performance-agent.md`：效能優化
- `accessibility-agent.md`：無障礙規範

### 詳細文檔（docs/）
- `docs/00-開發作業指引.md`：開發流程與標準
- `docs/22-完整SQL表結構定義.md`：51 張資料表定義
- `docs/27-完整架構流程圖.mermaid.md`：架構視覺化
- `docs/45-SHARED_IMPORTS-使用指南.md`：共享模組使用
- `docs/50-RLS策略開發指南.md`：Supabase RLS 策略

## ⚠️ 注意事項

### 絕對禁止
- ❌ 洩漏任何 API 金鑰、密碼、PII 等敏感資訊
- ❌ 在 repo、日誌或回答中揭露機密資料
- ❌ 新增 NgModule（專案已全面改用 Standalone）
- ❌ 使用舊式 `@Input()` / `@Output()` 裝飾器
- ❌ 硬編碼 URL、角色或權限
- ❌ 深層路徑別名（如 `@core/services/xxx`）

### 需謹慎處理
- ⚠️ 資料庫結構變更：需同步更新 `docs/22-完整SQL表結構定義.md`
- ⚠️ API 變更：需同步更新 `docs/26-API-接口詳細文檔.md`
- ⚠️ 依賴升級：需執行 `yarn audit` 檢查安全性
- ⚠️ RLS 策略變更：需更新 `docs/50-RLS策略開發指南.md`

### 不確定時的處理方式
1. **優先查閱文件**：使用 `docs-index.md` 找到對應規範
2. **請求具體資訊**：要求使用者提供檔案內容或日誌
3. **避免猜測**：不要提供無法驗證的推測性答案
4. **標註風險**：明確列出潛在風險與測試方案

## 🔄 回應模板

### 標準回應格式
1. **結論**（1-2 句話）
   - 簡述問題與解決方向
   - 引用相關文件（使用 `@file` 語法）

2. **實作步驟**
   - 提供有序的操作步驟或程式碼
   - 包含完整的檔案路徑
   - 必要時提供程式碼片段

3. **風險與測試**
   - 列出必要的驗證指令
   - 說明預期結果
   - 提供回退方案

4. **人工複核事項**
   - 標註需要人工審查的部分
   - 說明為何需要人工介入

### 範例
```markdown
## 結論
需要建立新的使用者列表元件，使用 NG-ZORRO Table 與 SHARED_IMPORTS。參考 @file docs/45-SHARED_IMPORTS-使用指南.md。

## 實作步驟
1. 建立 `src/app/routes/users/list/list.component.ts`
2. 使用 `imports: [SHARED_IMPORTS]` 引入共享模組
3. 實作 `users` Signal 與 `loadUsers()` 方法
...

## 風險與測試
\`\`\`bash
yarn lint
yarn type-check
yarn test --watch=false
yarn build
\`\`\`

## 人工複核事項
- [ ] 確認 RLS Policy 是否已正確設定
- [ ] 驗證權限控制是否符合需求
```

## 📋 常見任務快速參考

### 建立新元件
1. 使用 `ng g c routes/[module]/[name] --standalone`
2. 加入 `imports: [SHARED_IMPORTS]`
3. 設定 `changeDetection: ChangeDetectionStrategy.OnPush`
4. 使用 Signals API 管理狀態

### 建立新服務
1. 使用 `ng g s core/services/[name]`
2. 在 `@core/index.ts` 匯出
3. 使用 Signals 管理內部狀態
4. 提供 typed API 與完整錯誤處理

### 資料表操作
1. 參考 `docs/22-完整SQL表結構定義.md` 確認欄位
2. 檢查 RLS Policy 是否已設定
3. 透過 Supabase Client 進行 CRUD
4. 使用 Repository Pattern 封裝

### 權限控制
1. 後端：配置 Supabase RLS Policy
2. 前端：使用 `@delon/acl` 進行 UI 權限控制
3. Token：僅透過 `TokenService` 存取
4. 測試：驗證各角色的存取權限

---

**版本**：v2.0（2025-11-18）  
**維護者**：開發團隊  
**最後更新**：2025-01-15

---

## 🔗 相關檔案連結

- `.copilot-review-instructions.md`：程式碼審查指示
- `.copilot-commit-message-instructions.md`：Commit 訊息規範
- `.copilot-test-instructions.md`：測試產生指示
- `.copilot-pull-request-description-instructions.md`：PR 描述規範
- `.github/agents/copilot-instructions.md`：完整 Copilot 指示
- `AGENTS.md`：專案規範總覽
