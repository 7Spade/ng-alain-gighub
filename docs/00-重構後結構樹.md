mindmap
  root((🏗️ 工地管理系統<br/>Complete Architecture<br/>51 Tables))
    
    🎨 **前端應用層**
      Angular 20.3.x
        控制流語法
          @if / @else
          @for
          @switch / @case
          @defer
        Signals 響應式
        RxJS 7.8.x
      NG-ALAIN 20.1.x
        企業級框架
        布局系統
        權限守衛
        路由管理
      NG-ZORRO 20.3.x
        Ant Design UI
        豐富組件庫
        響應式設計
      分層架構
        routes 路由層
          業務頁面
          懶加載
        shared 共享層
          通用組件
          管道過濾器
          指令
        core 核心層
          服務層
          守衛
          攔截器
      SHARED_IMPORTS
        統一導入模式
        模組依賴管理
    
    🔐 **身份認證層** [3 Tables]
      Supabase Auth
        JWT Token 驗證
        Session 管理
        多種登入方式
          Email/Password
          OAuth 提供商
            Google
            GitHub
          Magic Link
      帳戶系統 (accounts)
        統一身份抽象
          用戶 User
          機器人 Bot
          組織 Organization
        account_type
        profile 資料
      組織管理 (teams)
        團隊結構
        成員管理 (team_members)
        角色分配
      組織排班 (organization_schedules)
        跨藍圖成員調派
        天氣資訊整合
        工作日曆
    
    🤝 **組織協作系統** [3 Tables]
      協作關係 (organization_collaborations)
        1:1 承攬關係
        主分支↔組織分支
        協作類型
      協作邀請 (collaboration_invitations)
        邀請流程
          發送邀請
          接受/拒絕
          過期管理
        邀請狀態
          pending
          accepted
          rejected
          expired
      協作成員 (collaboration_members)
        成員角色
        權限範圍
        加入時間
        狀態管理
    
    🔒 **權限控制層** [3 Tables]
      Row Level Security
        PostgreSQL RLS
        基於 JWT Claims
        細粒度存取控制
        政策定義
      角色系統 (roles)
        預設角色
          專案經理
          工地主任
          施工人員
          品管人員
          觀察者
        自訂角色
        角色層級
      權限矩陣 (permissions)
        資源權限
          讀取 Read
          寫入 Write
          刪除 Delete
          管理 Admin
      分支權限 (branch_permissions)
        擁有者權限
          全權控制
          任務結構管理
        協作組織權限
          僅操作承攬欄位
          不可修改結構
        查看者權限
          唯讀存取
    
    🎯 **專案藍圖層** [2 Tables]
      Git-like 分支模型
      藍圖 (blueprints)
        主分支 Main
          擁有者組織控制
          任務結構完全控制
          專案資訊管理
        組織分支 Organization
          Fork 機制
          1:1 承攬關係
          僅操作承攬欄位
        分支關係
          parent_branch_id
          branch_type
      Pull Request (pull_requests)
        提交執行數據
        擁有者審核
        合併承攬欄位
        PR 狀態
          open
          merged
          closed
          rejected
      專案設定
        工作日曆
        通知規則
        自訂欄位配置
      專案擁有權
        個人專案
        組織專案
        團隊協作
    
    📋 **任務執行系統** [9 Tables]
      任務管理 (tasks)
        任務建立
          僅藍圖擁有者
          樹狀結構
          無層級限制
        任務屬性
          標題/描述
          優先級
          預估工時
          實際工時
        狀態追蹤
          待處理
          進行中
          暫存中
          品管中
          驗收中
          已完成
          已取消
      任務指派 (task_assignments)
        指派類型
          個人
          團隊
          組織
          承攬
        角色
          負責人 owner
          協作人 collaborator
          觀察者 viewer
        Realtime 通知
      任務列表 (task_lists)
        分類管理
        排序規則
        篩選條件
      任務依賴 (task_dependencies)
        前置任務
        依賴類型
          finish_to_start
          start_to_start
          finish_to_finish
        依賴鏈管理
        循環依賴檢查
      任務模板 (task_templates)
        模板管理
        快速建立任務
        標準化流程
        模板分類
      暫存區 (task_staging)
        48 小時可撤回
        分階段確認
        撤回機制
      每日報表 (daily_reports)
        工作摘要
        工作時數
        工人數量
        天氣記錄
          Edge Function API
          快取機制
      報表照片 (report_photos)
        施工照片
        Storage 儲存
        EXIF 資料保留
        位置資訊
        時間戳記
      待辦中心 (personal_todos)
        個人待辦聚合
        五種狀態
          🟦 待執行
          🟨 暫存中
          🟧 品管中
          🟥 驗收中
          ⚠️ 問題追蹤
        優先級排序
        Realtime 同步
      狀態追蹤 (todo_status_tracking)
        狀態變更歷史
        變更時間
        變更原因
        審計追蹤
    
    ✅ **品質驗收系統** [4 Tables]
      品質驗收 (quality_checks)
        檢查項目
          Checklist
          評分標準
          檢查點
        驗收流程
          待驗收
          檢查中
          通過
          不通過
        自動觸發
          開立問題
          更新進度
      品管照片 (qc_photos)
        檢查照片
        前中後對比
        缺陷記錄
        Storage 儲存
        標註功能
      最終驗收 (inspections)
        責任切割
        驗收類型
          初步驗收
          最終驗收
          保固驗收
          移交驗收
        責任轉移
        驗收報告
      驗收照片 (inspection_photos)
        驗收記錄
        對比照片
        驗收證明
        Storage 儲存
    
    ⚠️ **問題追蹤系統** [4 Tables]
      問題管理 (issues)
        問題開立
          來源
            手動回報
            驗收不合格
            系統檢測
          嚴重程度
            低/中/高/緊急
        處理流程
          新建
          指派
          處理中
          已解決
          已關閉
          重新開啟
      問題指派 (issue_assignments)
        處理人員
        審核人員
        指派時間
        Edge Function 通知
      問題照片 (issue_photos)
        問題記錄
        Storage 儲存
        缺陷追蹤
        修復前後對比
      跨分支同步 (issue_sync_logs)
        即時同步至主分支
        所有分支統一可見
        Realtime 訂閱
        同步狀態
        衝突處理
    
    💬 **協作溝通系統** [6 Tables]
      討論區 (comments)
        留言功能
          巢狀回覆
          @提及功能
          富文本編輯
        即時訊息
          Realtime 廣播
          已讀狀態
        關聯實體
          任務討論
          問題討論
          PR 討論
          驗收討論
          一般討論
      通知中心 (notifications)
        通知類型
          任務通知
          問題通知
          留言通知
          PR 狀態
          系統通知
        推送機制
          Realtime 推送
          Email 通知
          瀏覽器推播
        已讀管理
        批次操作
      通知規則 (notification_rules)
        用戶自訂規則
        通知頻道
          站內
          Email
          推播
        通知時機
        靜音設定
      通知訂閱 (notification_subscriptions)
        訂閱管理
        訂閱類型
        自動訂閱
        取消訂閱
      待辦清單 (personal_todos)
        個人任務聚合
        跨專案彙整
        優先級排序
      狀態追蹤 (todo_status_tracking)
        狀態變更記錄
        時間軸追蹤
        責任追溯
    
    📊 **資料分析系統** [6 Tables]
      文件管理 (documents)
        檔案元資料
          檔名/類型/大小
          上傳者/時間
          關聯實體
        權限控制
        軟刪除 (30天)
        Storage Buckets
          images/
            施工照片
            驗收照片
            問題照片
          documents/
            合約文件
            工程圖
            報表文件
          drawings/
            CAD 圖檔
            施工圖
      文件版本 (document_versions)
        版本歷史
        變更描述
        版本比對
        回溯功能
      圖片縮圖 (document_thumbnails)
        自動生成
        多尺寸快取
          thumbnail
          small
          medium
          large
        CDN 加速
      活動記錄 (activity_logs)
        自動記錄
          Database Triggers
          所有操作
        集中記錄
          所有分支同步主分支
          擁有者全局掌控
        記錄內容
          操作類型
          變更內容
          時間戳記
          IP/User Agent
        審計追蹤
      數據分析快取 (analytics_cache)
        預計算報表
        多層級聚合
        快取過期策略
        定期更新
      進度追蹤 (progress_tracking)
        即時進度計算
        完成率統計
        里程碑追蹤
        趨勢分析
        視覺化圖表
          Edge Function 計算
          Materialized Views
          前端互動圖表
    
    ⚙️ **系統管理模組** [8 Tables]
      系統設定 (settings)
        全域設定
        專案設定
        個人偏好
        JSON 配置
      功能開關 (feature_flags)
        灰度發布
        A/B 測試
        目標帳戶
        目標組織
        開關狀態
      天氣整合
        第三方 API
          Edge Function 調用
          錯誤處理
        天氣快取 (weather_cache)
          減少 API 調用
          資料新鮮度
        顯示整合
          日報天氣
          工地環境
          天氣警示
      機器人系統 (bots)
        定期報表機器人
        通知機器人
        備份機器人
        清理機器人
      機器人任務 (bot_tasks)
        任務佇列
        排程管理
        重試機制
        優先級
      執行日誌 (bot_execution_logs)
        執行記錄
        成功/失敗
        錯誤訊息
        執行時間
      備份管理
        PostgreSQL 備份
        Storage 備份
        自動化排程
        備份驗證
      系統監控
        效能指標
        錯誤追蹤
        使用量統計
    
    ⚡ **Supabase 核心服務**
      PostgreSQL Database
        關聯式資料庫
        ACID 保證
        Foreign Keys
        Database Triggers
          自動記錄
          資料同步
          驗證規則
        索引優化
          B-Tree
          GIN
          BRIN
        Materialized Views
          預計算聚合
          定期刷新
          效能優化
      Supabase Storage
        物件儲存
        Bucket 管理
          公開/私有
          存取策略
        CDN 加速
        自動縮圖
      Realtime
        WebSocket 連接
        Database 變更訂閱
          INSERT
          UPDATE
          DELETE
        Broadcast 廣播
          即時訊息
          狀態同步
        Presence 狀態
          線上使用者
          協作狀態
      Edge Functions
        Deno Runtime
        無伺服器運算
        第三方 API 整合
          天氣 API
          Email 服務
        複雜業務邏輯
          報表計算
          數據聚合
        背景任務
          定期清理
          自動通知
      Row Level Security
        PostgreSQL 原生
        政策定義
          SELECT
          INSERT
          UPDATE
          DELETE
        JWT 整合
        多租戶支援
        分支權限隔離