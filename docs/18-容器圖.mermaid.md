# å®¹å™¨åœ–ï¼ˆContainer Diagramï¼‰

> ğŸ“‹ **ç›®çš„**ï¼šå±•ç¤ºç³»çµ±çš„å®¹å™¨ç´šæ¶æ§‹ï¼ŒåŒ…å«å‰ç«¯æ‡‰ç”¨ã€å¾Œç«¯æœå‹™ã€è³‡æ–™åº«ç­‰ä¸»è¦å®¹å™¨çµ„ä»¶

**æœ€å¾Œæ›´æ–°**ï¼š2025-11-15  
**ç¶­è­·è€…**ï¼šé–‹ç™¼åœ˜éšŠ

---

```mermaid
C4Container
    title å®¹å™¨åœ– - å·¥åœ°ç®¡ç†ç³»çµ±æ¶æ§‹

    Person(user, "ç³»çµ±ç”¨æˆ¶", "å°ˆæ¡ˆç¶“ç†/å·¥åœ°ä¸»ä»»/<br/>æ–½å·¥äººå“¡/å“ç®¡äººå“¡")

    System_Boundary(cms_boundary, "å·¥åœ°ç®¡ç†ç³»çµ±") {
        Container(web_app, "Web æ‡‰ç”¨", "Angular 20.3.x + NG-ZORRO 20.2.x + NG-ALAIN 20.1.x", "å–®é æ‡‰ç”¨<br/>- Standalone Components<br/>- Signals éŸ¿æ‡‰å¼<br/>- ng-zorro-antd çµ„ä»¶")
        
        Container(mobile_app, "ç§»å‹•æ‡‰ç”¨", "Progressive Web App", "PWA æ‡‰ç”¨<br/>- é›¢ç·šæ”¯æ´<br/>- ç›¸æ©Ÿæ•´åˆ<br/>- æ¨é€é€šçŸ¥")
    }

    System_Boundary(supabase_boundary, "Supabase Platform") {
        ContainerDb(postgres, "PostgreSQL", "Database 15.x", "ä¸»è³‡æ–™åº«<br/>- é—œè¯å¼è³‡æ–™<br/>- RLS æ¬Šé™æ§åˆ¶<br/>- Triggers & Functions<br/>- Materialized Views")
        
        Container(auth, "Supabase Auth", "GoTrue", "èº«ä»½èªè­‰æœå‹™<br/>- JWT Token ç®¡ç†<br/>- OAuth æ•´åˆ<br/>- Session ç®¡ç†<br/>- Magic Link")
        
        Container(storage, "Supabase Storage", "Object Storage", "æª”æ¡ˆå„²å­˜æœå‹™<br/>- images/ bucket<br/>- documents/ bucket<br/>- drawings/ bucket<br/>- CDN åŠ é€Ÿ")
        
        Container(realtime, "Realtime Server", "WebSocket", "å³æ™‚é€šè¨Šæœå‹™<br/>- Database è®Šæ›´è¨‚é–±<br/>- Broadcast å»£æ’­<br/>- Presence ç‹€æ…‹")
        
        Container(edge_functions, "Edge Functions", "Deno Runtime", "ç„¡ä¼ºæœå™¨å‡½æ•¸<br/>- å¤©æ°£ API æ•´åˆ<br/>- é€šçŸ¥é‚è¼¯<br/>- é€²åº¦è¨ˆç®—<br/>- æ•¸æ“šåˆ†æ")
        
        Container(postgrest, "PostgREST", "REST API", "è‡ªå‹•ç”Ÿæˆ REST API<br/>- CRUD æ“ä½œ<br/>- RLS æ•´åˆ<br/>- JWT é©—è­‰")
    }

    System_Ext(weather_api, "å¤©æ°£ API", "ç¬¬ä¸‰æ–¹æœå‹™")
    System_Ext(email_smtp, "SMTP æœå‹™", "éƒµä»¶ç™¼é€")
    System_Ext(oauth, "OAuth æä¾›å•†", "Google/GitHub")
    ContainerDb_Ext(redis, "Redis Cache", "å¿«å–å±¤", "å¯é¸: æ•ˆèƒ½å„ªåŒ–")

    Rel(user, web_app, "ä½¿ç”¨ç³»çµ±", "HTTPS")
    Rel(user, mobile_app, "ä½¿ç”¨ç³»çµ±", "HTTPS/PWA")

    Rel(web_app, auth, "èº«ä»½é©—è­‰", "HTTPS/REST")
    Rel(web_app, postgrest, "è³‡æ–™å­˜å–", "HTTPS/REST + JWT")
    Rel(web_app, storage, "æª”æ¡ˆæ“ä½œ", "HTTPS/REST")
    Rel(web_app, realtime, "å³æ™‚è¨‚é–±", "WebSocket")
    Rel(web_app, edge_functions, "èª¿ç”¨å‡½æ•¸", "HTTPS")

    Rel(mobile_app, auth, "èº«ä»½é©—è­‰", "HTTPS/REST")
    Rel(mobile_app, postgrest, "è³‡æ–™å­˜å–", "HTTPS/REST + JWT")
    Rel(mobile_app, storage, "æª”æ¡ˆä¸Šå‚³", "HTTPS/REST")
    Rel(mobile_app, realtime, "å³æ™‚è¨‚é–±", "WebSocket")

    Rel(auth, postgres, "å­˜å„²ç”¨æˆ¶", "SQL")
    Rel(auth, oauth, "ç¬¬ä¸‰æ–¹ç™»å…¥", "OAuth 2.0")
    
    Rel(postgrest, postgres, "æŸ¥è©¢è³‡æ–™", "SQL + RLS")
    
    Rel(storage, postgres, "å…ƒè³‡æ–™å­˜å„²", "SQL")
    
    Rel(realtime, postgres, "è¨‚é–±è®Šæ›´", "PostgreSQL Logical Replication")
    
    Rel(edge_functions, postgres, "è³‡æ–™æŸ¥è©¢", "SQL")
    Rel(edge_functions, weather_api, "æŸ¥è©¢å¤©æ°£", "HTTPS/REST")
    Rel(edge_functions, email_smtp, "ç™¼é€éƒµä»¶", "SMTP/API")
    Rel(edge_functions, redis, "å¿«å–æŸ¥è©¢", "Redis Protocol", "å¯é¸")
```

## å®¹å™¨è·è²¬èªªæ˜

### å‰ç«¯æ‡‰ç”¨å±¤

#### Web æ‡‰ç”¨ (Angular 20.3.x)
- **æŠ€è¡“æ£§**: 
  - Angular 20.3.x (Standalone Components)
  - NG-ZORRO 20.2.x (UI çµ„ä»¶åº«)
  - NG-ALAIN 20.1.x (ä¼æ¥­ç´š UI è§£æ±ºæ–¹æ¡ˆ)
  - TypeScript 5
  - Angular Signals
- **åŠŸèƒ½**:
  - Standalone Components æ¶æ§‹
  - Signals éŸ¿æ‡‰å¼ç‹€æ…‹ç®¡ç†
  - å³æ™‚è³‡æ–™åŒæ­¥èˆ‡é€šçŸ¥
  - è±å¯Œçš„äº’å‹•å¼åœ–è¡¨èˆ‡å„€è¡¨æ¿
- **éƒ¨ç½²**: Supabase Hosting / Cloudflare Pages

#### ç§»å‹•æ‡‰ç”¨ (PWA)
- **æŠ€è¡“**: Progressive Web App
- **ç‰¹æ€§**:
  - é›¢ç·šå„ªå…ˆæ¶æ§‹
  - æœ¬åœ°ç›¸æ©Ÿå­˜å–
  - æ¨é€é€šçŸ¥æ”¯æ´
  - å®‰è£åˆ°ä¸»ç•«é¢
- **å„ªå‹¢**: ç„¡éœ€ App Store ç™¼å¸ƒ

### Supabase å¹³å°å±¤

#### PostgreSQL Database
- **ç‰ˆæœ¬**: PostgreSQL 15.x
- **åŠŸèƒ½**:
  - ACID äº‹å‹™ä¿è­‰
  - Row Level Security (RLS)
  - Database Triggers è‡ªå‹•åŒ–
  - Materialized Views æ•ˆèƒ½å„ªåŒ–
  - Full-text Search å…¨æ–‡æª¢ç´¢
- **æ“´å±•**: pgvector (å‘é‡æœå°‹), postgis (åœ°ç†è³‡è¨Š)

#### Supabase Auth
- **å¼•æ“**: GoTrue
- **åŠŸèƒ½**:
  - JWT Token ç°½ç™¼èˆ‡é©—è­‰
  - Email/Password èªè­‰
  - OAuth ç¤¾äº¤ç™»å…¥
  - Magic Link ç„¡å¯†ç¢¼ç™»å…¥
  - Multi-factor Authentication (MFA)
- **æ•´åˆ**: èˆ‡ RLS ç„¡ç¸«æ•´åˆ

#### Supabase Storage
- **æ¶æ§‹**: S3-compatible Object Storage
- **Buckets**:
  - `images/`: æ–½å·¥ç…§ç‰‡ã€é©—æ”¶ç…§ç‰‡ã€å•é¡Œç…§ç‰‡
  - `documents/`: åˆç´„ã€å ±è¡¨æ–‡ä»¶
  - `drawings/`: CAD åœ–æª”ã€æ–½å·¥åœ–
- **åŠŸèƒ½**:
  - è‡ªå‹• CDN åŠ é€Ÿ
  - åœ–ç‰‡è½‰æ›èˆ‡å„ªåŒ–
  - æ¬Šé™æ§åˆ¶æ•´åˆ RLS
  - æª”æ¡ˆç‰ˆæœ¬ç®¡ç†

#### Realtime Server
- **å”è­°**: WebSocket
- **åŠŸèƒ½**:
  - Database Changes: è¨‚é–±è³‡æ–™è¡¨è®Šæ›´
  - Broadcast: å»£æ’­è‡ªè¨‚è¨Šæ¯
  - Presence: ç·šä¸Šç‹€æ…‹è¿½è¹¤
- **æ‡‰ç”¨å ´æ™¯**:
  - ä»»å‹™å³æ™‚æ›´æ–°
  - å•é¡Œè¿½è¹¤åŒæ­¥
  - è¨è«–å€å³æ™‚è¨Šæ¯
  - é€šçŸ¥æ¨é€

#### Edge Functions
- **é‹è¡Œæ™‚**: Deno Runtime
- **éƒ¨ç½²**: å…¨çƒé‚Šç·£ç¯€é»
- **å‡½æ•¸é¡å‹**:
  - `weather-api`: å¤©æ°£è³‡è¨Šæ•´åˆèˆ‡å¿«å–
  - `notification-handler`: é€šçŸ¥é‚è¼¯è™•ç†
  - `progress-calculator`: é€²åº¦çµ±è¨ˆè¨ˆç®—
  - `analytics-processor`: æ•¸æ“šåˆ†æè™•ç†
  - `report-generator`: å ±è¡¨ç”Ÿæˆ
- **å„ªå‹¢**: ä½å»¶é²ã€è‡ªå‹•æ“´å±•

#### PostgREST
- **åŠŸèƒ½**: è‡ªå‹•å°‡ PostgreSQL è¡¨è½‰æ›ç‚º REST API
- **ç‰¹æ€§**:
  - è‡ªå‹• CRUD ç«¯é»
  - è¤‡é›œæŸ¥è©¢æ”¯æ´ (filter, order, join)
  - RLS æ¬Šé™è‡ªå‹•æ‡‰ç”¨
  - JWT Token é©—è­‰
- **æ•ˆèƒ½**: é«˜æ•ˆèƒ½æŸ¥è©¢å„ªåŒ–

### å¤–éƒ¨æœå‹™

#### Redis Cache (å¯é¸)
- **ç”¨é€”**: 
  - å¤©æ°£è³‡æ–™å¿«å–
  - Session å¿«å–
  - ç†±é»è³‡æ–™å¿«å–
- **å„ªåŒ–**: æ¸›å°‘è³‡æ–™åº«æŸ¥è©¢å£“åŠ›

#### å¤©æ°£ API
- **æœå‹™å•†**: OpenWeather / WeatherAPI.com
- **èª¿ç”¨**: é€é Edge Function
- **å¿«å–**: weather_cache è¡¨

#### SMTP æœå‹™
- **ç”¨é€”**: ç³»çµ±é€šçŸ¥éƒµä»¶
- **æœå‹™å•†**: SendGrid / AWS SES / Mailgun
- **è§¸ç™¼**: Edge Function å‘¼å«

#### OAuth æä¾›å•†
- **æ”¯æ´**: Google OAuth, GitHub OAuth
- **æ•´åˆ**: Supabase Auth é…ç½®
- **å„ªå‹¢**: ç°¡åŒ–ç”¨æˆ¶è¨»å†Šæµç¨‹

## æŠ€è¡“å †ç–Šå°ç…§

### å‰ç«¯æŠ€è¡“æ£§
| å±¤ç´š | æŠ€è¡“ | èªªæ˜ |
|------|------|------|
| **UI Layer** | Angular 20.3.x + NG-ZORRO 20.2.x + NG-ALAIN 20.1.x | Standalone Componentsã€Signals |
| **Shared Layer** | Angular Shared Modules | å¯é‡ç”¨å…ƒä»¶ã€æ¨¡å‹ã€å·¥å…· |
| **Core Layer** | Angular Services | Domain Serviceã€Repositoryã€Facade |
| **Infrastructure** | Supabase Client | å°è£ Supabase API |

### å¾Œç«¯æŠ€è¡“æ£§
| å±¤ç´š | æŠ€è¡“ | èªªæ˜ |
|------|------|------|
| **Database** | PostgreSQL | 51 å¼µè³‡æ–™è¡¨ï¼ˆ11 å€‹æ¨¡çµ„ï¼‰ã€RLS æ¬Šé™ |
| **Storage** | Supabase Storage | Bucket çµ„ç¹”çµæ§‹ |
| **Compute** | Edge Functions (Deno) | ç„¡ä¼ºæœå™¨é‹ç®— |
| **Realtime** | Supabase Realtime | WebSocket æ¨é€ |

## è³‡æ–™æµ

```
ç”¨æˆ¶æ“ä½œ â†’ Angular å‰ç«¯ â†’ Edge Functions / PostgREST â†’ PostgreSQL
                â†“
          Supabase Auth (é©—è­‰)
                â†“
          Supabase Storage (æª”æ¡ˆ)
                â†“
          Realtime (å³æ™‚æ¨é€)
```

## é–‹ç™¼èˆ‡æ¸¬è©¦ç’°å¢ƒ

### Playwright æ¸¬è©¦
- **E2E æ¸¬è©¦æ¡†æ¶**ï¼šPlaywright
- **è¦†è“‹ç¯„åœ**ï¼šé—œéµç”¨æˆ¶æµç¨‹ã€ç€è¦½å™¨å…¼å®¹æ€§
- **åŸ·è¡Œæ–¹å¼**ï¼š`yarn e2e`

### CI/CD ç®¡é“
- **GitHub Actions**ï¼šè‡ªå‹•åŒ–å»ºç½®èˆ‡éƒ¨ç½²
- **æµç¨‹**ï¼šLint â†’ Type Check â†’ Test â†’ Build â†’ Deploy
- **å“è³ªæª¢æŸ¥**ï¼š`yarn qa:verify` é›¶è­¦å‘Šè¦æ±‚
```