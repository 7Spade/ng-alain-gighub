# 探索功能 RLS 策略修复说明

> **日期**：2025-01-20  
> **问题**：探索功能只能搜索到自己，无法搜索到其他用户  
> **状态**：✅ 已修复

---

## 🔍 问题原因

`accounts` 表的 RLS 策略只允许用户查看自己的账户，导致探索功能无法搜索到其他用户。

### 原始策略限制

原始 SELECT 策略只允许用户查看：
- 自己的账户（`auth_user_id = auth.uid()`）
- 自己创建的组织账户
- 自己创建的 Bot 账户
- 自己所属组织的账户和 Bot

---

## ✅ 修复方案

### 已添加的新策略

```sql
CREATE POLICY "Authenticated users can search active accounts for explore"
ON accounts FOR SELECT
TO authenticated
USING (
  status = 'active'
  AND (
    type = 'User'
    OR
    type = 'Organization'
  )
);
```

### 策略说明

1. **允许范围**：已认证用户（`authenticated` 角色）
2. **操作类型**：只读（`SELECT`）
3. **条件限制**：
   - ✅ 只显示活跃账户（`status = 'active'`）
   - ✅ 只允许用户和组织类型（`type IN ('User', 'Organization')`）
   - ❌ 不允许 Bot 账户（由现有策略控制）

### 策略关系

新策略与现有策略是 **OR** 关系：
- ✅ 用户仍然可以查看自己的账户（通过现有策略）
- ✅ 用户现在也可以搜索和查看其他活跃用户的账户（通过新策略）
- ✅ 组织相关的权限仍然由现有策略控制
- ✅ Bot 账户的权限仍然由现有策略控制

---

## 🧪 验证步骤

### 1. 验证策略已创建

```sql
SELECT 
  policyname,
  cmd,
  qual
FROM pg_policies 
WHERE tablename = 'accounts'
  AND policyname = 'Authenticated users can search active accounts for explore';
```

### 2. 测试搜索功能

1. 登录系统
2. 进入"探索"页面
3. 搜索其他用户的名称
4. 应该能看到搜索结果

### 3. 预期结果

- ✅ 可以搜索到其他活跃用户
- ✅ 可以搜索到其他活跃组织
- ✅ 无法搜索到非活跃账户
- ✅ 无法搜索到 Bot 账户（除非有权限）
- ✅ 仍然可以查看自己的账户

---

## 📝 关于蓝图搜索

### 当前状态

`blueprints` 表的 RLS 策略只允许用户查看：
- 自己拥有的蓝图
- 自己协作的蓝图

### 是否需要修复？

根据设计文档，蓝图搜索应该显示规划中或进行中的蓝图。但是：

1. **业务逻辑考虑**：蓝图可能不应该完全公开，需要根据业务需求决定
2. **当前实现**：Repository 的 `search` 方法已经过滤了状态（只搜索 `planning` 和 `active`）
3. **建议**：如果需要允许用户搜索所有公开的蓝图，可以添加类似的策略

### 如果需要添加蓝图搜索策略

```sql
-- 允许已认证用户搜索规划中或进行中的蓝图（用于探索功能）
CREATE POLICY "Authenticated users can search active blueprints for explore"
ON blueprints FOR SELECT
TO authenticated
USING (
  status IN ('planning', 'active')
);
```

**注意**：这个策略会允许用户查看所有规划中或进行中的蓝图，请根据业务需求决定是否添加。

---

## 🔒 安全考虑

### 隐私保护

1. **只显示活跃账户**：非活跃账户不会被搜索到
2. **只显示用户和组织**：Bot 账户不会被搜索到（除非用户有权限）
3. **只读权限**：策略只允许 SELECT，不允许修改

### 数据暴露

1. **公开信息**：搜索功能只暴露账户的基本信息（名称、邮箱等）
2. **敏感信息**：敏感信息（如 metadata）仍然受现有策略保护
3. **权限控制**：详细的账户信息仍然受现有策略控制

---

## 📚 相关文档

- [探索功能设计文档](./探索功能设计文档.md)
- [RLS 策略开发指南](./50-RLS策略開發指南.md)
- [探索功能代码分析报告](./探索功能代码分析报告-2025-01-19.md)

---

**最后更新**：2025-01-20  
**维护者**：开发团队

