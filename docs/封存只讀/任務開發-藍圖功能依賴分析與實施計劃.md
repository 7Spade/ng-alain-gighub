# ä»»å‹™é–‹ç™¼ - è—åœ–åŠŸèƒ½ä¾è³´åˆ†æèˆ‡å¯¦æ–½è¨ˆåŠƒ

> **åˆ†ææ—¥æœŸ**: 2025-01-15  
> **åˆ†æç¯„åœ**: ä»»å‹™ï¼ˆTaskï¼‰é–‹ç™¼å°è—åœ–ï¼ˆBlueprintï¼‰åŠŸèƒ½çš„ä¾è³´é—œä¿‚  
> **æ¶æ§‹ç‰ˆæœ¬**: v2.0ï¼ˆGit-like åˆ†æ”¯æ¨¡å‹ï¼Œ51 å¼µè³‡æ–™è¡¨ï¼‰

---

## ğŸ“Š åŸ·è¡Œæ‘˜è¦

**ä»»å‹™é–‹ç™¼éœ€è¦è—åœ–å…ˆå®Œæˆä»¥ä¸‹åŠŸèƒ½**ï¼š

| å„ªå…ˆç´š | åŠŸèƒ½ | ç‹€æ…‹ | å®Œæˆåº¦ | é˜»å¡ç¨‹åº¦ |
|--------|------|------|--------|----------|
| ğŸ”´ **P0** | PR åˆä½µé‚è¼¯å®Œæ•´å¯¦ç¾ | âš ï¸ éƒ¨åˆ†å¯¦ç¾ | 30% | **é˜»å¡** |
| ğŸŸ¡ **P1** | Activity Service | âŒ æœªå¯¦ç¾ | 0% | **å½±éŸ¿å®Œæ•´æ€§** |
| ğŸŸ¡ **P1** | èšåˆåˆ·æ–°æ©Ÿåˆ¶ | âŒ æœªå¯¦ç¾ | 0% | **å½±éŸ¿å®Œæ•´æ€§** |
| ğŸŸ¢ **P2** | åˆ†æ”¯æ¬Šé™æ§åˆ¶ | âš ï¸ éƒ¨åˆ†å¯¦ç¾ | 40% | å„ªåŒ–åŠŸèƒ½ |
| ğŸŸ¢ **P2** | Realtime æ•´åˆ | âŒ æœªå¯¦ç¾ | 0% | å„ªåŒ–åŠŸèƒ½ |

---

## ğŸ” ä¾è³´é—œä¿‚åˆ†æ

### 1. ä»»å‹™èˆ‡è—åœ–çš„é—œä¿‚

æ ¹æ“šè³‡æ–™åº«æ¶æ§‹åˆ†æï¼š

```sql
-- tasks è¡¨çµæ§‹
CREATE TABLE tasks (
  id UUID PRIMARY KEY,
  blueprint_id UUID NOT NULL REFERENCES blueprints(id),  -- ä»»å‹™å±¬æ–¼è—åœ–
  branch_id UUID REFERENCES blueprint_branches(id),      -- ä»»å‹™å¯ä»¥åœ¨åˆ†æ”¯ä¸­
  contractor_fields JSONB DEFAULT '{}',                  -- æ‰¿æ”¬æ¬„ä½ï¼ˆé—œéµï¼‰
  -- ... å…¶ä»–æ¬„ä½
);
```

**é—œéµä¾è³´**ï¼š
- âœ… ä»»å‹™å¿…é ˆå±¬æ–¼ä¸€å€‹è—åœ–ï¼ˆ`blueprint_id`ï¼‰
- âœ… ä»»å‹™å¯ä»¥åœ¨åˆ†æ”¯ä¸­ï¼ˆ`branch_id`ï¼‰
- âœ… ä»»å‹™æœ‰æ‰¿æ”¬æ¬„ä½ï¼ˆ`contractor_fields`ï¼‰ï¼Œé€™æ˜¯ Git-like åˆ†æ”¯æ¨¡å‹çš„æ ¸å¿ƒ

### 2. Git-like åˆ†æ”¯æ¨¡å‹å·¥ä½œæµç¨‹

```
ä¸»åˆ†æ”¯ï¼ˆæ“æœ‰è€…çµ„ç¹”ï¼‰
  â”œâ”€ å‰µå»ºä»»å‹™çµæ§‹ï¼ˆtasksï¼‰
  â”œâ”€ æŒ‡æ´¾çµ¦å”ä½œçµ„ç¹”
  â”‚
å”ä½œçµ„ç¹”åˆ†æ”¯
  â”œâ”€ Fork ä»»å‹™åˆ°åˆ†æ”¯
  â”œâ”€ ä¿®æ”¹ contractor_fieldsï¼ˆå¯¦éš›å·¥æ™‚ã€æˆæœ¬ã€ç…§ç‰‡ç­‰ï¼‰
  â”œâ”€ æäº¤ PRï¼ˆPull Requestï¼‰
  â”‚
PR å¯©æ ¸æµç¨‹
  â”œâ”€ æ“æœ‰è€…å¯©æ ¸
  â”œâ”€ æ‰¹å‡†å¾Œåˆä½µ
  â””â”€ æ›´æ–°ä¸»åˆ†æ”¯çš„ contractor_fields  â† **é—œéµæ­¥é©Ÿ**
```

**å•é¡Œ**ï¼šç•¶å‰ PR åˆä½µåªæ›´æ–° PR ç‹€æ…‹ï¼Œ**æœªå¯¦ç¾å¯¦éš›åˆä½µé‚è¼¯**ã€‚

---

## ğŸ”´ å„ªå…ˆç´š 0ï¼šPR åˆä½µé‚è¼¯å®Œæ•´å¯¦ç¾ï¼ˆå¿…é ˆå®Œæˆï¼‰

### ç•¶å‰ç‹€æ³

**å·²å¯¦ç¾**ï¼š
- âœ… `PullRequestService.mergePullRequest()` æ–¹æ³•å­˜åœ¨
- âœ… PR ç‹€æ…‹ç®¡ç†å®Œæ•´ï¼ˆOPEN â†’ REVIEWING â†’ APPROVED â†’ MERGEDï¼‰
- âœ… PR å¯©æ ¸æµç¨‹å®Œæ•´

**ç¼ºå¤±**ï¼š
- âŒ `mergePullRequest()` åªæ›´æ–° PR ç‹€æ…‹ï¼Œ**æœªå¯¦ç¾å¯¦éš›åˆä½µé‚è¼¯**
- âŒ ç¼ºå°‘ `TaskService.updateTaskContractorFields()` æ–¹æ³•
- âŒ æœªæ›´æ–° `tasks.contractor_fields` æ¬„ä½
- âŒ æœªèª¿ç”¨ Edge Function æˆ–ç›´æ¥æ›´æ–°è³‡æ–™åº«

### å¯¦æ–½è¨ˆåŠƒ

#### Step 1: å¯¦ç¾ `TaskService.updateTaskContractorFields()` æ–¹æ³•

**ä½ç½®**: `src/app/shared/services/task/task.service.ts`

**å¯¦ç¾**ï¼š
```typescript
/**
 * æ›´æ–°ä»»å‹™çš„æ‰¿æ”¬æ¬„ä½ï¼ˆcontractor_fieldsï¼‰
 * 
 * ç”¨æ–¼ PR åˆä½µæ™‚æ›´æ–°ä¸»åˆ†æ”¯çš„ä»»å‹™æ‰¿æ”¬æ¬„ä½
 * 
 * @param taskId ä»»å‹™ ID
 * @param contractorFields æ‰¿æ”¬æ¬„ä½æ•¸æ“šï¼ˆæœƒåˆä½µåˆ°ç¾æœ‰æ•¸æ“šï¼‰
 * @returns æ›´æ–°å¾Œçš„ä»»å‹™
 */
async updateTaskContractorFields(
  taskId: string,
  contractorFields: Record<string, unknown>
): Promise<Task> {
  this.loadingState.set(true);
  this.errorState.set(null);

  try {
    // 1. ç²å–ç•¶å‰ä»»å‹™
    const currentTask = await firstValueFrom(this.taskRepository.findById(taskId));
    if (!currentTask) {
      throw new Error('ä»»å‹™ä¸å­˜åœ¨');
    }

    // 2. åˆä½µæ‰¿æ”¬æ¬„ä½ï¼ˆä¿ç•™ç¾æœ‰æ•¸æ“šï¼Œæ›´æ–°æ–°æ•¸æ“šï¼‰
    const currentContractorFields = (currentTask.contractorFields || {}) as Record<string, unknown>;
    const mergedContractorFields = {
      ...currentContractorFields,
      ...contractorFields,
      // æ·»åŠ æ›´æ–°æ™‚é–“æˆ³
      _lastUpdated: new Date().toISOString()
    };

    // 3. æ›´æ–°ä»»å‹™
    const task = await firstValueFrom(
      this.taskRepository.update(taskId, {
        contractorFields: mergedContractorFields
      } as any)
    );

    // 4. æ›´æ–°æœ¬åœ°ç‹€æ…‹
    this.tasksState.update(tasks => tasks.map(t => (t.id === taskId ? task : t)));
    if (this.selectedTaskState()?.id === taskId) {
      this.selectedTaskState.set(task);
    }

    return task;
  } catch (error) {
    this.errorState.set(error instanceof Error ? error.message : 'æ›´æ–°æ‰¿æ”¬æ¬„ä½å¤±æ•—');
    throw error;
  } finally {
    this.loadingState.set(false);
  }
}
```

#### Step 2: å®Œå–„ `PullRequestService.mergePullRequest()` æ–¹æ³•

**ä½ç½®**: `src/app/shared/services/blueprint/pull-request.service.ts`

**å¯¦ç¾**ï¼š
```typescript
/**
 * åˆä½µ PRï¼ˆå°‡åˆ†æ”¯æ•¸æ“šåˆä½µåˆ°ä¸»åˆ†æ”¯ï¼‰
 * 
 * PR åˆä½µé‚è¼¯ï¼š
 * 1. å¾ PR çš„ changes_summary JSONB å­—æ®µä¸­æå–è®Šæ›´æ•¸æ“š
 * 2. åˆä½µåˆ°ä¸»åˆ†æ”¯çš„ tasks è¡¨ï¼šæ›´æ–° tasks.contractor_fields
 * 3. åŒæ­¥ç›¸é—œæ•¸æ“šï¼ˆdaily_reportsã€quality_checks ç­‰ï¼‰
 * 4. æ›´æ–° PR ç‹€æ…‹ç‚º MERGED
 * 5. è§¸ç™¼æ´»å‹•è¨˜éŒ„å’Œé€šçŸ¥
 * 
 * @param prId PR ID
 * @param mergedBy åˆä½µè€… ID
 * @returns åˆä½µå¾Œçš„ PR
 */
async mergePullRequest(prId: string, mergedBy: string): Promise<PullRequest> {
  this.loadingState.set(true);
  this.errorState.set(null);

  try {
    // 1. ç²å– PR æ•¸æ“š
    const pr = await this.loadPullRequestById(prId);
    if (!pr) {
      throw new Error('PR ä¸å­˜åœ¨');
    }

    // 2. æª¢æŸ¥ PR ç‹€æ…‹å¿…é ˆç‚º APPROVED
    if (pr.status !== PRStatus.APPROVED) {
      throw new Error('PR å¿…é ˆå…ˆè¢«æ‰¹å‡†æ‰èƒ½åˆä½µ');
    }

    // 3. ç²å– PR çš„è®Šæ›´æ•¸æ“šï¼ˆå¾ changes_summary JSONBï¼‰
    const changesSummary = pr.changesSummary as {
      tasks?: Array<{
        taskId: string;
        contractorFields: Record<string, unknown>;
      }>;
      dailyReports?: Array<any>;
      qualityChecks?: Array<any>;
    } | null;

    if (!changesSummary) {
      throw new Error('PR æ²’æœ‰è®Šæ›´æ•¸æ“š');
    }

    // 4. åˆä½µåˆ°ä¸»åˆ†æ”¯
    // 4.1 æ›´æ–° tasks è¡¨çš„æ‰¿æ”¬æ¬„ä½
    if (changesSummary.tasks) {
      const taskService = inject(TaskService);
      for (const taskChange of changesSummary.tasks) {
        await taskService.updateTaskContractorFields(
          taskChange.taskId,
          taskChange.contractorFields
        );
      }
    }

    // 4.2 åŒæ­¥ daily_reportsï¼ˆå¦‚æœéœ€è¦ï¼‰
    // TODO: å¯¦ç¾ daily_reports åŒæ­¥é‚è¼¯

    // 4.3 åŒæ­¥ quality_checksï¼ˆå¦‚æœéœ€è¦ï¼‰
    // TODO: å¯¦ç¾ quality_checks åŒæ­¥é‚è¼¯

    // 5. æ›´æ–° PR ç‹€æ…‹ç‚º MERGED
    const mergedPR = await this.updatePullRequest(prId, {
      status: PRStatus.MERGED,
      mergedBy,
      mergedAt: new Date().toISOString(),
      changesSummary: changesSummary
    } as any);

    // 6. è§¸ç™¼æ´»å‹•è¨˜éŒ„ï¼ˆå¦‚æœ Activity Service å·²å¯¦ç¾ï¼‰
    // TODO: await this.activityService.record({ ... });

    // 7. è§¸ç™¼èšåˆåˆ·æ–°ï¼ˆå¦‚æœ Aggregation Refresh Service å·²å¯¦ç¾ï¼‰
    // TODO: this.aggregationRefreshService.emit(pr.blueprintId, ['tasks', 'progress']);

    return mergedPR;
  } catch (error) {
    this.errorState.set(error instanceof Error ? error.message : 'åˆä½µ PR å¤±æ•—');
    throw error;
  } finally {
    this.loadingState.set(false);
  }
}
```

#### Step 3: æ¸¬è©¦èˆ‡é©—è­‰

**æ¸¬è©¦å ´æ™¯**ï¼š
1. âœ… å‰µå»º PR ä¸¦åŒ…å«ä»»å‹™è®Šæ›´
2. âœ… æ‰¹å‡† PR
3. âœ… åˆä½µ PR
4. âœ… é©—è­‰ä¸»åˆ†æ”¯çš„ `tasks.contractor_fields` å·²æ›´æ–°
5. âœ… é©—è­‰ PR ç‹€æ…‹è®Šç‚º MERGED

**é©—è­‰æ­¥é©Ÿ**ï¼š
```typescript
// æ¸¬è©¦ä»£ç¢¼ç¤ºä¾‹
const pr = await prService.createPullRequest({
  blueprintId: 'blueprint-id',
  branchId: 'branch-id',
  title: 'æäº¤åŸ·è¡Œæ•¸æ“š',
  submittedBy: 'user-id',
  changesSummary: {
    tasks: [{
      taskId: 'task-id',
      contractorFields: {
        actualHours: 8,
        actualCost: 1000,
        photos: ['photo1.jpg', 'photo2.jpg']
      }
    }]
  }
});

// æ‰¹å‡† PR
await prService.approvePullRequest(pr.id, 'reviewer-id');

// åˆä½µ PR
await prService.mergePullRequest(pr.id, 'merger-id');

// é©—è­‰ä»»å‹™æ‰¿æ”¬æ¬„ä½å·²æ›´æ–°
const task = await taskService.loadTaskById('task-id');
expect(task.contractorFields).toMatchObject({
  actualHours: 8,
  actualCost: 1000,
  photos: ['photo1.jpg', 'photo2.jpg']
});
```

### å®Œæˆæ¨™æº–

- [ ] `TaskService.updateTaskContractorFields()` æ–¹æ³•å·²å¯¦ç¾
- [ ] `PullRequestService.mergePullRequest()` å¯¦éš›åˆä½µé‚è¼¯å·²å¯¦ç¾
- [ ] PR åˆä½µå¾Œä¸»åˆ†æ”¯çš„ `tasks.contractor_fields` æ­£ç¢ºæ›´æ–°
- [ ] å–®å…ƒæ¸¬è©¦é€šé
- [ ] æ•´åˆæ¸¬è©¦é€šé

---

## ğŸŸ¡ å„ªå…ˆç´š 1ï¼šActivity Serviceï¼ˆæ‡‰è©²å®Œæˆï¼‰

### ç•¶å‰ç‹€æ³

**å·²å¯¦ç¾**ï¼š
- âœ… `activity_logs` è¡¨å­˜åœ¨
- âœ… `ActivityLogRepository` å¯èƒ½å·²å­˜åœ¨ï¼ˆéœ€ç¢ºèªï¼‰

**ç¼ºå¤±**ï¼š
- âŒ `BlueprintActivityService` æœªå¯¦ç¾
- âŒ ä»»å‹™æ“ä½œæœªè‡ªå‹•è¨˜éŒ„åˆ° `activity_logs` è¡¨
- âŒ ç¼ºå°‘æ´»å‹•è¨˜éŒ„æŸ¥è©¢å’Œé¡¯ç¤ºåŠŸèƒ½

### å¯¦æ–½è¨ˆåŠƒ

#### Step 1: å‰µå»º `BlueprintActivityService`

**ä½ç½®**: `src/app/shared/services/blueprint/blueprint-activity.service.ts`

**å¯¦ç¾**ï¼š
```typescript
import { Injectable, inject, signal } from '@angular/core';
import { ActivityLogRepository } from '@core';
import { firstValueFrom } from 'rxjs';

export interface ActivityLogRecord {
  entityType: 'blueprint' | 'task' | 'pull_request' | 'branch';
  entityId: string;
  action: 'created' | 'updated' | 'deleted' | 'status_changed' | 'merged' | 'approved' | 'rejected';
  actorId: string;
  changes?: Record<string, unknown>;
  metadata?: Record<string, unknown>;
}

@Injectable({
  providedIn: 'root'
})
export class BlueprintActivityService {
  private activityLogRepository = inject(ActivityLogRepository);
  private activitiesState = signal<ActivityLog[]>([]);

  readonly activities = this.activitiesState.asReadonly();

  /**
   * è¨˜éŒ„æ´»å‹•
   */
  async record(record: ActivityLogRecord): Promise<void> {
    try {
      await firstValueFrom(
        this.activityLogRepository.create({
          entityType: record.entityType,
          entityId: record.entityId,
          action: record.action,
          actorId: record.actorId,
          changes: record.changes || {},
          metadata: record.metadata || {},
          createdAt: new Date().toISOString()
        } as any)
      );
    } catch (error) {
      console.error('è¨˜éŒ„æ´»å‹•å¤±æ•—:', error);
      // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œé¿å…å½±éŸ¿ä¸»æµç¨‹
    }
  }

  /**
   * æŸ¥è©¢æ´»å‹•è¨˜éŒ„
   */
  async loadActivitiesByEntity(
    entityType: string,
    entityId: string
  ): Promise<ActivityLog[]> {
    const activities = await firstValueFrom(
      this.activityLogRepository.findByEntity(entityType, entityId)
    );
    this.activitiesState.set(activities);
    return activities;
  }
}
```

#### Step 2: æ•´åˆåˆ°ç¾æœ‰ Service å±¤

**æ•´åˆé»**ï¼š
- `TaskService.createTask()` - è¨˜éŒ„ä»»å‹™å‰µå»º
- `TaskService.updateTask()` - è¨˜éŒ„ä»»å‹™æ›´æ–°
- `TaskService.deleteTask()` - è¨˜éŒ„ä»»å‹™åˆªé™¤
- `TaskService.updateTaskStatus()` - è¨˜éŒ„ç‹€æ…‹è®Šæ›´
- `PullRequestService.mergePullRequest()` - è¨˜éŒ„ PR åˆä½µ

**ç¤ºä¾‹**ï¼š
```typescript
// åœ¨ TaskService ä¸­æ•´åˆ
async createTask(data: TaskInsert): Promise<Task> {
  // ... ç¾æœ‰é‚è¼¯ ...
  const task = await firstValueFrom(this.taskRepository.create(data));

  // è¨˜éŒ„æ´»å‹•
  await this.activityService.record({
    entityType: 'task',
    entityId: task.id,
    action: 'created',
    actorId: data.createdBy || 'system',
    changes: data
  });

  return task;
}
```

### å®Œæˆæ¨™æº–

- [ ] `BlueprintActivityService` å·²å‰µå»º
- [ ] ä»»å‹™æ“ä½œè‡ªå‹•è¨˜éŒ„åˆ° `activity_logs` è¡¨
- [ ] PR æ“ä½œè‡ªå‹•è¨˜éŒ„
- [ ] æ´»å‹•è¨˜éŒ„æŸ¥è©¢åŠŸèƒ½å·²å¯¦ç¾
- [ ] å–®å…ƒæ¸¬è©¦é€šé

---

## ğŸŸ¡ å„ªå…ˆç´š 1ï¼šèšåˆåˆ·æ–°æ©Ÿåˆ¶ï¼ˆæ‡‰è©²å®Œæˆï¼‰

### ç•¶å‰ç‹€æ³

**ç¼ºå¤±**ï¼š
- âŒ `BlueprintAggregationRefreshService` æœªå¯¦ç¾
- âŒ ç¼ºå°‘äº‹ä»¶é©…å‹•åˆ·æ–°æ©Ÿåˆ¶
- âŒ ä»»å‹™è®Šæ›´å¾Œæœªè§¸ç™¼è—åœ–èšåˆåˆ·æ–°

### å¯¦æ–½è¨ˆåŠƒ

#### Step 1: å‰µå»º `BlueprintAggregationRefreshService`

**ä½ç½®**: `src/app/shared/services/blueprint/blueprint-aggregation-refresh.service.ts`

**å¯¦ç¾**ï¼š
```typescript
import { Injectable, inject } from '@angular/core';
import { Subject, Observable } from 'rxjs';
import { filter } from 'rxjs/operators';

export interface AggregationRefreshEvent {
  blueprintId: string;
  aggregationTypes: Array<'tasks' | 'progress' | 'quality' | 'documents' | 'activities'>;
}

@Injectable({
  providedIn: 'root'
})
export class BlueprintAggregationRefreshService {
  private refreshSubject = new Subject<AggregationRefreshEvent>();

  /**
   * ç™¼é€åˆ·æ–°äº‹ä»¶
   */
  emit(blueprintId: string, aggregationTypes: AggregationRefreshEvent['aggregationTypes']): void {
    this.refreshSubject.next({ blueprintId, aggregationTypes });
  }

  /**
   * ç›£è½åˆ·æ–°äº‹ä»¶
   */
  listen(blueprintId: string, aggregationTypes?: AggregationRefreshEvent['aggregationTypes']): Observable<AggregationRefreshEvent> {
    return this.refreshSubject.pipe(
      filter(event => {
        if (event.blueprintId !== blueprintId) return false;
        if (aggregationTypes && !aggregationTypes.some(type => event.aggregationTypes.includes(type))) {
          return false;
        }
        return true;
      })
    );
  }
}
```

#### Step 2: æ•´åˆåˆ°ç¾æœ‰ Service å±¤

**æ•´åˆé»**ï¼š
- `TaskService.updateTask()` - è§¸ç™¼ä»»å‹™èšåˆåˆ·æ–°
- `TaskService.updateTaskStatus()` - è§¸ç™¼é€²åº¦èšåˆåˆ·æ–°
- `PullRequestService.mergePullRequest()` - è§¸ç™¼å¤šå€‹èšåˆåˆ·æ–°

**ç¤ºä¾‹**ï¼š
```typescript
// åœ¨ TaskService ä¸­æ•´åˆ
async updateTask(id: string, data: TaskUpdate): Promise<Task> {
  // ... ç¾æœ‰é‚è¼¯ ...
  const task = await firstValueFrom(this.taskRepository.update(id, data));

  // è§¸ç™¼èšåˆåˆ·æ–°
  if (task.blueprintId) {
    this.aggregationRefreshService.emit(task.blueprintId, ['tasks', 'progress']);
  }

  return task;
}
```

### å®Œæˆæ¨™æº–

- [ ] `BlueprintAggregationRefreshService` å·²å‰µå»º
- [ ] äº‹ä»¶ç™¼é€å’Œæ¥æ”¶æ©Ÿåˆ¶å·²å¯¦ç¾
- [ ] ä»»å‹™è®Šæ›´å¾Œè§¸ç™¼è—åœ–èšåˆåˆ·æ–°
- [ ] PR åˆä½µå¾Œè§¸ç™¼èšåˆåˆ·æ–°
- [ ] å–®å…ƒæ¸¬è©¦é€šé

---

## ğŸ“‹ å¯¦æ–½å„ªå…ˆç´šèˆ‡æ™‚é–“ä¼°ç®—

### Phase 1: æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¿…é ˆå®Œæˆï¼‰

| ä»»å‹™ | å„ªå…ˆç´š | è¤‡é›œåº¦ | é è¨ˆæ™‚é–“ | ä¾è³´ |
|------|--------|--------|----------|------|
| å¯¦ç¾ `TaskService.updateTaskContractorFields()` | ğŸ”´ P0 | 3/10 | 2 å°æ™‚ | ç„¡ |
| å®Œå–„ `PullRequestService.mergePullRequest()` | ğŸ”´ P0 | 5/10 | 4 å°æ™‚ | TaskService |
| PR åˆä½µé‚è¼¯æ¸¬è©¦ | ğŸ”´ P0 | 3/10 | 2 å°æ™‚ | ä¸Šè¿°å…©é … |

**Phase 1 ç¸½è¨ˆ**: 8 å°æ™‚

### Phase 2: å¢å¼·åŠŸèƒ½ï¼ˆæ‡‰è©²å®Œæˆï¼‰

| ä»»å‹™ | å„ªå…ˆç´š | è¤‡é›œåº¦ | é è¨ˆæ™‚é–“ | ä¾è³´ |
|------|--------|--------|----------|------|
| å‰µå»º `BlueprintActivityService` | ğŸŸ¡ P1 | 4/10 | 3 å°æ™‚ | ActivityLogRepository |
| æ•´åˆ Activity Service åˆ°ç¾æœ‰ Service | ğŸŸ¡ P1 | 3/10 | 2 å°æ™‚ | BlueprintActivityService |
| å‰µå»º `BlueprintAggregationRefreshService` | ğŸŸ¡ P1 | 3/10 | 2 å°æ™‚ | ç„¡ |
| æ•´åˆèšåˆåˆ·æ–°æ©Ÿåˆ¶ | ğŸŸ¡ P1 | 3/10 | 2 å°æ™‚ | BlueprintAggregationRefreshService |

**Phase 2 ç¸½è¨ˆ**: 9 å°æ™‚

### Phase 3: å„ªåŒ–åŠŸèƒ½ï¼ˆå¯é¸ï¼‰

| ä»»å‹™ | å„ªå…ˆç´š | è¤‡é›œåº¦ | é è¨ˆæ™‚é–“ | ä¾è³´ |
|------|--------|--------|----------|------|
| åˆ†æ”¯æ¬Šé™æ§åˆ¶ | ğŸŸ¢ P2 | 6/10 | 6 å°æ™‚ | ç„¡ |
| Realtime æ•´åˆ | ğŸŸ¢ P2 | 5/10 | 4 å°æ™‚ | ç„¡ |

**Phase 3 ç¸½è¨ˆ**: 10 å°æ™‚

---

## âœ… æª¢æŸ¥æ¸…å–®

### Phase 1: æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¿…é ˆå®Œæˆï¼‰

- [ ] `TaskService.updateTaskContractorFields()` æ–¹æ³•å·²å¯¦ç¾
- [ ] `PullRequestService.mergePullRequest()` å¯¦éš›åˆä½µé‚è¼¯å·²å¯¦ç¾
- [ ] PR åˆä½µå¾Œä¸»åˆ†æ”¯çš„ `tasks.contractor_fields` æ­£ç¢ºæ›´æ–°
- [ ] å–®å…ƒæ¸¬è©¦é€šé
- [ ] æ•´åˆæ¸¬è©¦é€šé
- [ ] ä»£ç¢¼å¯©æŸ¥é€šé

### Phase 2: å¢å¼·åŠŸèƒ½ï¼ˆæ‡‰è©²å®Œæˆï¼‰

- [ ] `BlueprintActivityService` å·²å‰µå»º
- [ ] ä»»å‹™æ“ä½œè‡ªå‹•è¨˜éŒ„åˆ° `activity_logs` è¡¨
- [ ] PR æ“ä½œè‡ªå‹•è¨˜éŒ„
- [ ] `BlueprintAggregationRefreshService` å·²å‰µå»º
- [ ] äº‹ä»¶ç™¼é€å’Œæ¥æ”¶æ©Ÿåˆ¶å·²å¯¦ç¾
- [ ] ä»»å‹™è®Šæ›´å¾Œè§¸ç™¼è—åœ–èšåˆåˆ·æ–°
- [ ] å–®å…ƒæ¸¬è©¦é€šé

### Phase 3: å„ªåŒ–åŠŸèƒ½ï¼ˆå¯é¸ï¼‰

- [ ] åˆ†æ”¯æ¬Šé™æ§åˆ¶å·²å¯¦ç¾
- [ ] Realtime æ•´åˆå·²å¯¦ç¾

---

## ğŸ¯ çµè«–

**ä»»å‹™é–‹ç™¼éœ€è¦è—åœ–å…ˆå®Œæˆä»¥ä¸‹åŠŸèƒ½**ï¼š

1. **ğŸ”´ å¿…é ˆå®Œæˆï¼ˆé˜»å¡ä»»å‹™é–‹ç™¼ï¼‰**ï¼š
   - PR åˆä½µé‚è¼¯å®Œæ•´å¯¦ç¾ï¼ˆæ›´æ–° `tasks.contractor_fields`ï¼‰
   - é è¨ˆæ™‚é–“ï¼š8 å°æ™‚

2. **ğŸŸ¡ æ‡‰è©²å®Œæˆï¼ˆå½±éŸ¿åŠŸèƒ½å®Œæ•´æ€§ï¼‰**ï¼š
   - Activity Serviceï¼ˆæ“ä½œè¨˜éŒ„ï¼‰
   - èšåˆåˆ·æ–°æ©Ÿåˆ¶ï¼ˆè‡ªå‹•åˆ·æ–°ï¼‰
   - é è¨ˆæ™‚é–“ï¼š9 å°æ™‚

3. **ğŸŸ¢ å¯é¸å®Œæˆï¼ˆå„ªåŒ–åŠŸèƒ½ï¼‰**ï¼š
   - åˆ†æ”¯æ¬Šé™æ§åˆ¶
   - Realtime æ•´åˆ
   - é è¨ˆæ™‚é–“ï¼š10 å°æ™‚

**å»ºè­°**ï¼š
- å„ªå…ˆå®Œæˆ Phase 1ï¼ˆPR åˆä½µé‚è¼¯ï¼‰ï¼Œé€™æ˜¯ä»»å‹™é–‹ç™¼çš„é˜»å¡é»
- ç„¶å¾Œå®Œæˆ Phase 2ï¼ˆActivity Service å’Œèšåˆåˆ·æ–°ï¼‰ï¼Œæå‡åŠŸèƒ½å®Œæ•´æ€§
- Phase 3 å¯ä»¥åœ¨ä»»å‹™é–‹ç™¼éç¨‹ä¸­é€æ­¥å®Œå–„

---

**åˆ†æå®Œæˆæ™‚é–“**: 2025-01-15  
**åˆ†æå·¥å…·**: Sequential Thinking + Software Planning Tool + Context7 + Supabase MCP  
**åˆ†æç‹€æ…‹**: âœ… å®Œæˆ

