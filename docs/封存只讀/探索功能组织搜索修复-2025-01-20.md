# 探索功能组织搜索修复

> **日期**：2025-01-20  
> **问题**：切换到组织搜索不到结果  
> **状态**：✅ 已修复

---

## 🔍 问题原因

### 问题 1：Repository 不允许空查询

**问题**：`AccountRepository.search()` 方法在 query 为空时直接返回空数组

```typescript
// 修复前
if (!query || query.trim().length === 0) {
  return of([]);
}
```

**影响**：当用户切换到组织标签但没有输入搜索关键词时，无法显示所有组织

### 问题 2：函数中组织搜索条件错误

**问题**：函数中限制了 `auth_organization_id IS NULL`，但所有组织账户的 `auth_organization_id` 都不为 NULL

```sql
-- 修复前（错误的限制）
AND (
  p_type IS NULL 
  OR p_type != 'Organization' 
  OR a.auth_organization_id IS NULL  -- ❌ 这个条件导致所有组织被过滤
)
```

**影响**：所有组织账户都被过滤掉，无法搜索到任何组织

---

## ✅ 修复方案

### 1. 修复 Repository：允许空查询

```typescript
// 修复后
search(query: string, type?: AccountType, options?: QueryOptions): Observable<Account[]> {
  // 允许空查询，函数内部会处理（返回所有匹配类型的账户）
  const trimmedQuery = query?.trim() || '';
  // ...
}
```

### 2. 修复函数：移除错误的组织限制条件

```sql
-- 修复后：移除了 auth_organization_id IS NULL 的限制
-- 搜索用户时，限制 auth_user_id IS NOT NULL（确保是真正的用户账户）
AND (
  p_type IS NULL 
  OR p_type != 'User' 
  OR a.auth_user_id IS NOT NULL
)
-- 移除了组织搜索的 auth_organization_id 限制
```

### 3. 优化函数：支持空查询

```sql
-- 搜索条件：如果查询为空，则返回所有匹配类型的账户
AND (
  p_query IS NULL 
  OR p_query = ''
  OR a.name ILIKE '%' || p_query || '%'
  OR a.email ILIKE '%' || p_query || '%'
)
```

---

## 🧪 验证结果

### 测试 1：空查询搜索组织

```sql
SELECT * FROM public.search_accounts_for_explore(
  '',
  'Organization',
  1,
  20,
  'name',
  'asc'
);
```

**结果**：✅ 成功返回 3 个组织账户

### 测试 2：有查询关键词搜索组织

```sql
SELECT * FROM public.search_accounts_for_explore(
  '11',
  'Organization',
  1,
  20,
  'name',
  'asc'
);
```

**结果**：✅ 成功返回匹配的组织（名称包含 "11"）

### 测试 3：空查询搜索用户

```sql
SELECT * FROM public.search_accounts_for_explore(
  '',
  'User',
  1,
  20,
  'name',
  'asc'
);
```

**结果**：✅ 成功返回用户账户

---

## 📝 修改的文件

1. **数据库函数**：`public.search_accounts_for_explore`（修复组织搜索条件，支持空查询）
2. **Repository**：`src/app/core/infra/repositories/account.repository.ts`（允许空查询）

---

## 🔍 关于 auth_organization_id 字段

**发现**：所有组织账户的 `auth_organization_id` 都不为 NULL

**含义**：`auth_organization_id` 可能表示：
- 组织是由某个用户创建的（创建者的 auth_user_id）
- 或者组织的拥有者

**结论**：不应该限制 `auth_organization_id IS NULL`，因为这会过滤掉所有组织账户

---

## ✅ 修复完成

- ✅ Repository 允许空查询
- ✅ 函数移除了错误的组织限制条件
- ✅ 函数支持空查询（返回所有匹配类型的账户）
- ✅ 组织搜索测试通过
- ✅ 用户搜索测试通过
- ✅ 代码通过 lint 检查

---

**最后更新**：2025-01-20  
**维护者**：开发团队

