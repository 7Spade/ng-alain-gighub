# æ¢ç´¢åŠŸèƒ½æœç´¢ä¿®å¤

> **æ—¥æœŸ**ï¼š2025-01-20  
> **é—®é¢˜**ï¼šæ¢ç´¢åŠŸèƒ½åªèƒ½æœç´¢åˆ°è‡ªå·±ï¼Œæ— æ³•æœç´¢åˆ°å…¶ä»–ç”¨æˆ·  
> **çŠ¶æ€**ï¼šâœ… å·²ä¿®å¤

---

## ğŸ” é—®é¢˜åŸå› 

1. **RLS ç­–ç•¥é™åˆ¶**ï¼š`accounts` è¡¨çš„ RLS ç­–ç•¥åªå…è®¸ç”¨æˆ·æŸ¥çœ‹è‡ªå·±çš„è´¦æˆ·
2. **æŸ¥è¯¢æ–¹å¼é—®é¢˜**ï¼šç›´æ¥ä½¿ç”¨ Supabase æŸ¥è¯¢ä¼šå—åˆ° RLS é™åˆ¶

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. åˆ›å»º SECURITY DEFINER å‡½æ•°

åˆ›å»ºäº† `public.search_accounts_for_explore` å‡½æ•°ï¼Œç”¨äºç»•è¿‡ RLS é™åˆ¶ï¼š

**æ³¨æ„**ï¼šå‡½æ•°å¿…é¡»åœ¨ `public` schema ä¸­ï¼Œå› ä¸º Supabase RPC åªèƒ½è°ƒç”¨ `public` schema ä¸­çš„å‡½æ•°ã€‚

```sql
CREATE OR REPLACE FUNCTION public.search_accounts_for_explore(
  p_query TEXT,
  p_type TEXT DEFAULT NULL,
  p_page INTEGER DEFAULT 1,
  p_page_size INTEGER DEFAULT 20,
  p_order_by TEXT DEFAULT 'name',
  p_order_direction TEXT DEFAULT 'asc'
)
RETURNS TABLE (...)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = ''
```

### 2. æœç´¢é€»è¾‘

æŒ‰ç…§ä½ çš„å»ºè®®å®ç°ï¼š
- **æœç´¢ç”¨æˆ·æ—¶**ï¼šå…ˆé™åˆ¶ `type = 'User'` å’Œ `auth_user_id IS NOT NULL`
- **ç„¶åæœç´¢**ï¼šæŒ‰ `name` å­—æ®µè¿›è¡Œæ¨¡ç³ŠåŒ¹é…

### 3. ä¿®æ”¹ Repository

æ›´æ–° `AccountRepository.search()` æ–¹æ³•ï¼Œä½¿ç”¨ SECURITY DEFINER å‡½æ•°ï¼š

```typescript
search(query: string, type?: AccountType, options?: QueryOptions): Observable<Account[]> {
  // ä½¿ç”¨ SECURITY DEFINER å‡½æ•°æœç´¢è´¦æˆ·ï¼Œç»•è¿‡ RLS é™åˆ¶
  return from(
    this.supabaseService.client.rpc('search_accounts_for_explore', {
      p_query: trimmedQuery,
      p_type: type || null,
      p_page: page,
      p_page_size: pageSize,
      p_order_by: orderBy === 'createdAt' ? 'created_at' : 'name',
      p_order_direction: orderDirection
    })
  ).pipe(...);
}
```

---

## ğŸ§ª éªŒè¯

### æµ‹è¯•ç»“æœ

å‡½æ•°å·²é€šè¿‡æµ‹è¯•ï¼Œå¯ä»¥è¿”å›å¤šä¸ªç”¨æˆ·è´¦æˆ·ï¼š
- âœ… å¯ä»¥æœç´¢åˆ°å…¶ä»–æ´»è·ƒç”¨æˆ·
- âœ… æœç´¢ç”¨æˆ·æ—¶é™åˆ¶ `auth_user_id IS NOT NULL`
- âœ… æŒ‰ `name` å­—æ®µè¿›è¡Œæ¨¡ç³ŠåŒ¹é…

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. **æ•°æ®åº“å‡½æ•°**ï¼š`private.search_accounts_for_explore`ï¼ˆæ–°å»ºï¼‰
2. **Repository**ï¼š`src/app/core/infra/repositories/account.repository.ts`ï¼ˆä¿®æ”¹ search æ–¹æ³•ï¼‰

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

1. **SECURITY DEFINER**ï¼šå‡½æ•°ä»¥åˆ›å»ºè€…æƒé™æ‰§è¡Œï¼Œå¯ä»¥ç»•è¿‡ RLS
2. **SET search_path = ''**ï¼šé˜²æ­¢ search_path æ³¨å…¥æ”»å‡»
3. **public schema**ï¼šå‡½æ•°å¿…é¡»åœ¨ `public` schema ä¸­æ‰èƒ½è¢« Supabase RPC è°ƒç”¨ï¼ˆè¿™æ˜¯ Supabase çš„é™åˆ¶ï¼‰
4. **åªè¯»æ“ä½œ**ï¼šå‡½æ•°åªæ‰§è¡Œ SELECT æŸ¥è¯¢ï¼Œä¸ä¿®æ”¹æ•°æ®
5. **å‚æ•°éªŒè¯**ï¼šå‡½æ•°å†…éƒ¨æœ‰å®Œæ•´çš„å‚æ•°éªŒè¯å’Œç±»å‹æ£€æŸ¥

---

**æœ€åæ›´æ–°**ï¼š2025-01-20  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ

