# è—åœ–ï¼ˆBlueprintï¼‰å¯¦ç¾ç‹€æ³åˆ†æå ±å‘Š

> **åˆ†ææ—¥æœŸ**: 2025-01-15  
> **åˆ†æç¯„åœ**: `src/app` ç›®éŒ„ä¸‹æ‰€æœ‰è—åœ–ç›¸é—œä»£ç¢¼  
> **æ¶æ§‹ç‰ˆæœ¬**: v2.0ï¼ˆGit-like åˆ†æ”¯æ¨¡å‹ï¼Œ51 å¼µè³‡æ–™è¡¨ï¼‰

---

## ğŸ“Š ç¸½é«”æ¦‚è¦½

| é …ç›® | ç‹€æ…‹ | å®Œæˆåº¦ |
|------|------|--------|
| **Repository å±¤** | âœ… å·²å¯¦ç¾ | 100% |
| **Service å±¤** | âœ… å·²å¯¦ç¾ | 80% |
| **Routes å±¤** | âœ… å·²å¯¦ç¾ | 70% |
| **Git-like åˆ†æ”¯æ¨¡å‹** | âš ï¸ éƒ¨åˆ†å¯¦ç¾ | 60% |
| **èšåˆåˆ·æ–°æ©Ÿåˆ¶** | âŒ æœªå¯¦ç¾ | 0% |
| **æ´»å‹•è¨˜éŒ„** | âŒ æœªå¯¦ç¾ | 0% |
| **å·¥ä½œæµæ¨¡å¼** | âŒ æœªå¯¦ç¾ | 0% |

---

## âœ… å·²å¯¦ç¾åŠŸèƒ½

### 1. Repository å±¤ï¼ˆCore/Infraï¼‰

#### âœ… BlueprintRepository
**ä½ç½®**: `src/app/core/infra/repositories/blueprint.repository.ts`

**å·²å¯¦ç¾æ–¹æ³•**:
- âœ… `findAll()` - æŸ¥è©¢æ‰€æœ‰è—åœ–
- âœ… `findById()` - æ ¹æ“š ID æŸ¥è©¢
- âœ… `create()` - å‰µå»ºè—åœ–
- âœ… `update()` - æ›´æ–°è—åœ–
- âœ… `delete()` - åˆªé™¤è—åœ–
- âœ… `findByOwnerId()` - æ ¹æ“šæ“æœ‰è€…æŸ¥è©¢
- âœ… `findByStatus()` - æ ¹æ“šç‹€æ…‹æŸ¥è©¢
- âœ… `findByProjectCode()` - æ ¹æ“šé …ç›®ä»£ç¢¼æŸ¥è©¢
- âœ… `findActive()` - æŸ¥è©¢æ´»èºè—åœ–

**ç‰¹é»**:
- âœ… ç¹¼æ‰¿ `BaseRepository`ï¼Œè‡ªå‹•è™•ç† snake_case â†” camelCase è½‰æ›
- âœ… ä½¿ç”¨ Observable è¿”å›æ•¸æ“š
- âœ… é¡å‹å®‰å…¨ï¼ˆTypeScriptï¼‰

#### âœ… BlueprintBranchRepository
**ä½ç½®**: `src/app/core/infra/repositories/blueprint-branch.repository.ts`

**å·²å¯¦ç¾æ–¹æ³•**:
- âœ… `findByBlueprintId()` - æ ¹æ“šè—åœ– ID æŸ¥è©¢åˆ†æ”¯
- âœ… `findByOrganizationId()` - æ ¹æ“šçµ„ç¹” ID æŸ¥è©¢åˆ†æ”¯
- âœ… `findByStatus()` - æ ¹æ“šç‹€æ…‹æŸ¥è©¢
- âœ… `findByBranchType()` - æ ¹æ“šåˆ†æ”¯é¡å‹æŸ¥è©¢
- âœ… `findActive()` - æŸ¥è©¢æ´»èºåˆ†æ”¯
- âœ… `findByBlueprintAndOrganization()` - å”¯ä¸€æŸ¥è©¢
- âœ… `createFork()` - å‰µå»º Fork åˆ†æ”¯

#### âœ… BranchForkRepository
**ä½ç½®**: `src/app/core/infra/repositories/branch-fork.repository.ts`

**å·²å¯¦ç¾æ–¹æ³•**:
- âœ… `findByBlueprintId()` - æ ¹æ“šè—åœ– ID æŸ¥è©¢ Fork è¨˜éŒ„
- âœ… `findByBranchId()` - æ ¹æ“šåˆ†æ”¯ ID æŸ¥è©¢ Fork è¨˜éŒ„
- âœ… `findByForkedFromTaskId()` - æ ¹æ“šæºä»»å‹™ ID æŸ¥è©¢
- âœ… `findByForkedBy()` - æ ¹æ“š Fork è€… ID æŸ¥è©¢

#### âœ… PullRequestRepository
**ä½ç½®**: `src/app/core/infra/repositories/pull-request.repository.ts`

**å·²å¯¦ç¾æ–¹æ³•**:
- âœ… `findByBlueprintId()` - æ ¹æ“šè—åœ– ID æŸ¥è©¢ PR
- âœ… `findByBranchId()` - æ ¹æ“šåˆ†æ”¯ ID æŸ¥è©¢ PR
- âœ… `findByStatus()` - æ ¹æ“šç‹€æ…‹æŸ¥è©¢
- âœ… `findOpen()` - æŸ¥è©¢æ‰“é–‹çš„ PR
- âœ… `findReviewing()` - æŸ¥è©¢å¯©æ ¸ä¸­çš„ PR
- âœ… `findMerged()` - æŸ¥è©¢å·²åˆä½µçš„ PR
- âœ… `findBySubmittedBy()` - æ ¹æ“šæäº¤è€…æŸ¥è©¢
- âœ… `findByReviewedBy()` - æ ¹æ“šå¯©æ ¸è€…æŸ¥è©¢

#### âœ… BlueprintConfigRepository
**ä½ç½®**: `src/app/core/infra/repositories/blueprint-config.repository.ts`

**å·²å¯¦ç¾æ–¹æ³•**:
- âœ… `findByBlueprintId()` - æ ¹æ“šè—åœ– ID æŸ¥è©¢é…ç½®
- âœ… `findByConfigKey()` - æ ¹æ“šé…ç½®éµæŸ¥è©¢
- âœ… `upsertConfig()` - æ›´æ–°æˆ–å‰µå»ºé…ç½®

### 2. Service å±¤ï¼ˆSharedï¼‰

#### âœ… BlueprintService
**ä½ç½®**: `src/app/shared/services/blueprint/blueprint.service.ts`

**å·²å¯¦ç¾åŠŸèƒ½**:
- âœ… ä½¿ç”¨ Signals ç®¡ç†ç‹€æ…‹
- âœ… æš´éœ² ReadonlySignal çµ¦çµ„ä»¶
- âœ… Computed signalsï¼ˆactiveBlueprints, planningBlueprints, completedBlueprintsï¼‰
- âœ… CRUD æ“ä½œï¼ˆcreate, update, deleteï¼‰
- âœ… æŸ¥è©¢æ–¹æ³•ï¼ˆloadBlueprints, loadBlueprintById, loadBlueprintsByOwnerId, loadBlueprintsByStatusï¼‰
- âœ… é…ç½®ç®¡ç†ï¼ˆloadConfigs, getConfig, setConfigï¼‰

**ç‹€æ…‹ç®¡ç†**:
```typescript
// ä½¿ç”¨ Signals ç®¡ç†ç‹€æ…‹
private blueprintsState = signal<Blueprint[]>([]);
private selectedBlueprintState = signal<Blueprint | null>(null);
private configsState = signal<BlueprintConfig[]>([]);
private loadingState = signal<boolean>(false);
private errorState = signal<string | null>(null);

// æš´éœ² ReadonlySignal
readonly blueprints = this.blueprintsState.asReadonly();
readonly selectedBlueprint = this.selectedBlueprintState.asReadonly();
```

#### âœ… BranchService
**ä½ç½®**: `src/app/shared/services/blueprint/branch.service.ts`

**å·²å¯¦ç¾åŠŸèƒ½**:
- âœ… åˆ†æ”¯ CRUD æ“ä½œ
- âœ… Fork åˆ†æ”¯åŠŸèƒ½ï¼ˆ`forkBranch()`ï¼‰
- âœ… åˆ†æ”¯åŒæ­¥ï¼ˆ`syncFromMainBranch()`ï¼‰
- âœ… åˆ†æ”¯ç‹€æ…‹ç®¡ç†ï¼ˆ`closeBranch()`, `markBranchAsMerged()`ï¼‰
- âœ… Signals ç‹€æ…‹ç®¡ç†

**Fork æ©Ÿåˆ¶**:
```typescript
async forkBranch(
  blueprintId: string,
  organizationId: string,
  branchName: string,
  branchType: BranchType = BranchType.CONTRACTOR,
  forkedBy: string,
  notes?: string
): Promise<BlueprintBranch>
```

#### âœ… PullRequestService
**ä½ç½®**: `src/app/shared/services/blueprint/pull-request.service.ts`

**å·²å¯¦ç¾åŠŸèƒ½**:
- âœ… PR CRUD æ“ä½œ
- âœ… PR ç‹€æ…‹ç®¡ç†ï¼ˆ`startReview()`, `approvePullRequest()`, `rejectPullRequest()`ï¼‰
- âœ… PR åˆä½µï¼ˆ`mergePullRequest()`ï¼‰
- âœ… Signals ç‹€æ…‹ç®¡ç†

**PR æµç¨‹**:
```typescript
// å¯©æ ¸æµç¨‹
async startReview(prId: string, reviewedBy: string)
async approvePullRequest(prId: string, reviewedBy: string)
async rejectPullRequest(prId: string, reviewedBy: string)

// åˆä½µæµç¨‹
async mergePullRequest(prId: string, mergedBy: string, changesSummary?: any)
```

### 3. Routes å±¤ï¼ˆUI Componentsï¼‰

#### âœ… è—åœ–åˆ—è¡¨é é¢
**ä½ç½®**: `src/app/routes/blueprints/list/blueprint-list.component.ts`

**å·²å¯¦ç¾åŠŸèƒ½**:
- âœ… è—åœ–åˆ—è¡¨é¡¯ç¤º
- âœ… ç‹€æ…‹æ¨™ç±¤é¡¯ç¤º
- âœ… æ“æœ‰è€…ä¿¡æ¯é¡¯ç¤ºï¼ˆå€‹äºº/çµ„ç¹”ï¼‰
- âœ… æ“ä½œæŒ‰éˆ•ï¼ˆæŸ¥çœ‹ã€ç·¨è¼¯ã€åˆ†æ”¯ç®¡ç†ã€åˆªé™¤ï¼‰
- âœ… ä½¿ç”¨ Signals è¨‚é–±æ•¸æ“š

#### âœ… è—åœ–è©³æƒ…é é¢
**ä½ç½®**: `src/app/routes/blueprints/detail/blueprint-detail.component.ts`

**å·²å¯¦ç¾åŠŸèƒ½**:
- âœ… è—åœ–åŸºæœ¬ä¿¡æ¯é¡¯ç¤º
- âœ… é…ç½®ä¿¡æ¯é¡¯ç¤º
- âœ… æ“æœ‰è€…ä¿¡æ¯é¡¯ç¤º
- âœ… æ“ä½œæŒ‰éˆ•ï¼ˆç·¨è¼¯ã€åˆ†æ”¯ç®¡ç†ã€åˆªé™¤ï¼‰

#### âœ… è—åœ–è¡¨å–®é é¢
**ä½ç½®**: `src/app/routes/blueprints/form/blueprint-form.component.ts`

**å·²å¯¦ç¾åŠŸèƒ½**:
- âœ… å‰µå»ºè—åœ–è¡¨å–®
- âœ… ç·¨è¼¯è—åœ–è¡¨å–®
- âœ… è¡¨å–®é©—è­‰
- âœ… è³¬æˆ¶é¸æ“‡å™¨æ•´åˆ

#### âœ… è·¯ç”±é…ç½®
**ä½ç½®**: `src/app/routes/blueprints/routes.ts`

**å·²é…ç½®è·¯ç”±**:
- âœ… `/blueprints/list` - è—åœ–åˆ—è¡¨
- âœ… `/blueprints/create` - å‰µå»ºè—åœ–
- âœ… `/blueprints/:id` - è—åœ–è©³æƒ…
- âœ… `/blueprints/:id/edit` - ç·¨è¼¯è—åœ–
- âœ… `/blueprints/:id/branches` - åˆ†æ”¯ç®¡ç†
- âœ… `/blueprints/:id/pull-requests` - PR åˆ—è¡¨
- âœ… `/blueprints/:id/settings` - è—åœ–è¨­å®š
- âœ… `/blueprints/:id/fork` - Fork è—åœ–
- âœ… `/blueprints/branches/detail` - åˆ†æ”¯è©³æƒ…
- âœ… `/blueprints/pull-requests/detail` - PR è©³æƒ…
- âœ… `/blueprints/:id/pull-requests/:prId/review` - PR å¯©æŸ¥

### 4. åˆ†æ”¯ä¸Šä¸‹æ–‡ç®¡ç†

#### âœ… BranchContextService
**ä½ç½®**: `src/app/core/services/branch-context.service.ts`

**å·²å¯¦ç¾åŠŸèƒ½**:
- âœ… ç•¶å‰åˆ†æ”¯ç‹€æ…‹ç®¡ç†ï¼ˆä½¿ç”¨ Signalsï¼‰
- âœ… ä¸»åˆ†æ”¯/çµ„ç¹”åˆ†æ”¯åˆ¤æ–·
- âœ… åˆ†æ”¯åˆ‡æ›åŠŸèƒ½
- âœ… åˆ†æ”¯ ID å’Œè—åœ– ID æŸ¥è©¢

**ç‰¹é»**:
- âœ… ä½¿ç”¨ Signals ç®¡ç†åˆ†æ”¯ä¸Šä¸‹æ–‡
- âœ… èˆ‡ BranchService æ•´åˆ
- âœ… æä¾› computed signalsï¼ˆisMainBranch, isOrganizationBranchï¼‰

---

## âš ï¸ éƒ¨åˆ†å¯¦ç¾åŠŸèƒ½

### 1. Git-like åˆ†æ”¯æ¨¡å‹

#### âœ… å·²å¯¦ç¾
- âœ… Fork æ©Ÿåˆ¶ï¼ˆ`BranchService.forkBranch()`ï¼‰
- âœ… åˆ†æ”¯å‰µå»ºï¼ˆ`BlueprintBranchRepository.createFork()`ï¼‰
- âœ… Fork è¨˜éŒ„ï¼ˆ`BranchForkRepository`ï¼‰
- âœ… PR æ©Ÿåˆ¶ï¼ˆ`PullRequestService`ï¼‰
- âœ… åˆ†æ”¯ç‹€æ…‹ç®¡ç†

#### âš ï¸ éƒ¨åˆ†å¯¦ç¾
- âš ï¸ **PR åˆä½µé‚è¼¯ä¸å®Œæ•´**: `mergePullRequest()` åªæ›´æ–° PR ç‹€æ…‹ï¼Œæœªå¯¦ç¾å¯¦éš›çš„åˆä½µé‚è¼¯ï¼ˆæ›´æ–°ä»»å‹™æ‰¿æ”¬æ¬„ä½ï¼‰
- âš ï¸ **åˆ†æ”¯æ¬Šé™æ§åˆ¶**: ç¼ºå°‘ `branch_permissions` è¡¨çš„ Repository å’Œ Service
- âš ï¸ **å”ä½œé‚€è«‹æµç¨‹**: ç¼ºå°‘ `organization_collaborations` è¡¨çš„å®Œæ•´æ•´åˆ

#### âŒ æœªå¯¦ç¾
- âŒ **Edge Function åˆä½µ**: ç¼ºå°‘ `branch-merge` Edge Function èª¿ç”¨
- âŒ **æ‰¿æ”¬æ¬„ä½æ›´æ–°**: PR åˆä½µæ™‚æœªæ›´æ–°ä»»å‹™çš„æ‰¿æ”¬æ¬„ä½
- âŒ **åˆ†æ”¯æ•¸æ“šåŒæ­¥**: ç¼ºå°‘ä¸»åˆ†æ”¯åˆ°åˆ†æ”¯çš„æ•¸æ“šåŒæ­¥æ©Ÿåˆ¶

### 2. è—åœ–é…ç½®ç®¡ç†

#### âœ… å·²å¯¦ç¾
- âœ… é…ç½® CRUD æ“ä½œ
- âœ… é…ç½®æŸ¥è©¢ï¼ˆ`findByBlueprintId`, `findByConfigKey`ï¼‰
- âœ… é…ç½®æ›´æ–°ï¼ˆ`upsertConfig`ï¼‰

#### âš ï¸ éƒ¨åˆ†å¯¦ç¾
- âš ï¸ **é…ç½®é©—è­‰**: ç¼ºå°‘é…ç½®å€¼çš„é©—è­‰é‚è¼¯
- âš ï¸ **é…ç½®é¡å‹**: ç¼ºå°‘é…ç½®é¡å‹çš„å®šç¾©å’Œé©—è­‰

---

## âŒ ç¼ºå¤±åŠŸèƒ½

### 1. Aggregation Refresh Pattern

#### âŒ æœªå¯¦ç¾
- âŒ **BlueprintAggregationRefreshService**: ç¼ºå°‘èšåˆåˆ·æ–°æœå‹™
- âŒ **äº‹ä»¶é©…å‹•åˆ·æ–°**: ç¼ºå°‘äº‹ä»¶ç™¼é€å’Œæ¥æ”¶æ©Ÿåˆ¶
- âŒ **è‡ªå‹•åˆ·æ–°**: ç¼ºå°‘ Facade å±¤çš„è‡ªå‹•åˆ·æ–°é‚è¼¯

**é æœŸå¯¦ç¾**:
```typescript
// æ‡‰è©²åœ¨ TaskServiceã€DocumentService ç­‰å®Œæˆ mutate å¾Œèª¿ç”¨
BlueprintAggregationRefreshService.emit(blueprintId, ['tasks', 'progress']);

// Blueprint Facade æ‡‰è©²ç›£è½äº‹ä»¶ä¸¦è‡ªå‹•åˆ·æ–°
this.aggregationRefreshService.listen(blueprintId, ['tasks', 'progress'])
  .subscribe(() => this.loadAggregation());
```

### 2. Activity Serviceï¼ˆæ´»å‹•è¨˜éŒ„ï¼‰

#### âŒ æœªå¯¦ç¾
- âŒ **BlueprintActivityService**: ç¼ºå°‘æ´»å‹•è¨˜éŒ„æœå‹™
- âŒ **æ´»å‹•è¨˜éŒ„**: ç¼ºå°‘è‡ªå‹•è¨˜éŒ„æ“ä½œåˆ° `activity_logs` è¡¨
- âŒ **æ´»å‹•æŸ¥è©¢**: ç¼ºå°‘æ´»å‹•è¨˜éŒ„çš„æŸ¥è©¢å’Œé¡¯ç¤º

**é æœŸå¯¦ç¾**:
```typescript
// æ‡‰è©²åœ¨æ‰€æœ‰ CUD æ“ä½œå¾Œè‡ªå‹•è¨˜éŒ„
await this.activityService.record({
  entityType: 'blueprint',
  entityId: blueprintId,
  action: 'created',
  changes: { ... }
});
```

### 3. Workflow Pattern

#### âŒ æœªå¯¦ç¾
- âŒ **å·¥ä½œæµæœå‹™**: ç¼ºå°‘çµ±ä¸€çš„å·¥ä½œæµè™•ç†æœå‹™
- âŒ **æ´»å‹•è¨˜éŒ„æ•´åˆ**: ç¼ºå°‘èˆ‡ Activity Service çš„æ•´åˆ
- âŒ **é€šçŸ¥æ•´åˆ**: ç¼ºå°‘èˆ‡ Notification Service çš„æ•´åˆ

**é æœŸå¯¦ç¾**:
```typescript
// æ‡‰è©²åœ¨è—åœ–æ“ä½œå¾Œçµ±ä¸€è™•ç†
await this.workflowService.process({
  action: 'blueprint.created',
  blueprintId: blueprint.id,
  // è‡ªå‹•è¨˜éŒ„æ´»å‹•ã€ç™¼é€é€šçŸ¥ã€è§¸ç™¼èšåˆåˆ·æ–°
});
```

### 4. èšåˆæœå‹™ï¼ˆAggregation Serviceï¼‰

#### âŒ æœªå¯¦ç¾
- âŒ **BlueprintAggregationService**: ç¼ºå°‘èšåˆè¨ˆç®—æœå‹™
- âŒ **KPI è¨ˆç®—**: ç¼ºå°‘é€²åº¦ã€çµ±è¨ˆç­‰ KPI è¨ˆç®—
- âŒ **Materialized Views**: ç¼ºå°‘ç‰©åŒ–è¦–åœ–çš„æŸ¥è©¢å’Œæ›´æ–°

**é æœŸåŠŸèƒ½**:
- é€²åº¦èšåˆï¼ˆ`progress`ï¼‰
- ä»»å‹™èšåˆï¼ˆ`tasks`ï¼‰
- å“è³ªèšåˆï¼ˆ`quality`ï¼‰
- æ–‡ä»¶èšåˆï¼ˆ`documents`ï¼‰
- æ´»å‹•èšåˆï¼ˆ`activities`ï¼‰

### 5. åˆ†æ”¯æ¬Šé™æ§åˆ¶

#### âŒ æœªå¯¦ç¾
- âŒ **BranchPermissionRepository**: ç¼ºå°‘åˆ†æ”¯æ¬Šé™ Repository
- âŒ **æ¬Šé™é©—è­‰**: ç¼ºå°‘åˆ†æ”¯æ¬Šé™çš„é©—è­‰é‚è¼¯
- âŒ **æ¬Šé™çŸ©é™£**: ç¼ºå°‘æ¬Šé™çŸ©é™£çš„å¯¦ç¾

**é æœŸåŠŸèƒ½**:
- æ“æœ‰è€…ï¼šå…¨æ¬Šæ§åˆ¶
- å”ä½œçµ„ç¹”ï¼šåƒ…æ“ä½œæ‰¿æ”¬æ¬„ä½
- æŸ¥çœ‹è€…ï¼šå”¯è®€

### 6. PR åˆä½µé‚è¼¯

#### âŒ æœªå¯¦ç¾
- âŒ **å¯¦éš›åˆä½µ**: `mergePullRequest()` åªæ›´æ–°ç‹€æ…‹ï¼Œæœªå¯¦ç¾å¯¦éš›åˆä½µ
- âŒ **æ‰¿æ”¬æ¬„ä½æ›´æ–°**: ç¼ºå°‘æ›´æ–°ä»»å‹™æ‰¿æ”¬æ¬„ä½çš„é‚è¼¯
- âŒ **Edge Function èª¿ç”¨**: ç¼ºå°‘èª¿ç”¨ `branch-merge` Edge Function

**é æœŸå¯¦ç¾**:
```typescript
async mergePullRequest(prId: string, mergedBy: string): Promise<void> {
  // 1. ç²å– PR æ•¸æ“š
  const pr = await this.loadPullRequestById(prId);
  
  // 2. èª¿ç”¨ Edge Function åŸ·è¡Œåˆä½µ
  await this.edgeFunctionService.call('branch-merge', {
    pullRequestId: prId,
    blueprintId: pr.blueprint_id,
    branchId: pr.branch_id,
    payload: pr.payload
  });
  
  // 3. æ›´æ–° PR ç‹€æ…‹
  await this.updatePullRequest(prId, {
    status: PRStatus.MERGED,
    mergedBy,
    mergedAt: new Date().toISOString()
  });
}
```

### 7. Realtime æ•´åˆ

#### âŒ æœªå¯¦ç¾
- âŒ **Realtime è¨‚é–±**: ç¼ºå°‘è—åœ–ç›¸é—œçš„ Realtime è¨‚é–±
- âŒ **å³æ™‚æ›´æ–°**: ç¼ºå°‘è—åœ–è®Šæ›´çš„å³æ™‚æ¨é€
- âŒ **åˆ†æ”¯åŒæ­¥**: ç¼ºå°‘åˆ†æ”¯è®Šæ›´çš„å³æ™‚åŒæ­¥

**é æœŸå¯¦ç¾**:
```typescript
// æ‡‰è©²åœ¨ Service å±¤è¨‚é–± Realtime
this.realtimeService.subscribe('blueprints', {
  event: '*',
  filter: `blueprint_id=eq.${blueprintId}`
}).subscribe(payload => {
  // è‡ªå‹•æ›´æ–°æœ¬åœ°ç‹€æ…‹
  this.blueprintsState.update(blueprints => {
    // æ›´æ–°é‚è¼¯
  });
});
```

### 8. éŒ¯èª¤è™•ç†

#### âš ï¸ éƒ¨åˆ†å¯¦ç¾
- âš ï¸ **åŸºæœ¬éŒ¯èª¤è™•ç†**: Service å±¤æœ‰åŸºæœ¬çš„ try-catch
- âš ï¸ **éŒ¯èª¤ç‹€æ…‹**: ä½¿ç”¨ Signals ç®¡ç†éŒ¯èª¤ç‹€æ…‹

#### âŒ æœªå¯¦ç¾
- âŒ **ErrorStateService**: ç¼ºå°‘çµ±ä¸€çš„éŒ¯èª¤ç‹€æ…‹ç®¡ç†æœå‹™
- âŒ **éŒ¯èª¤åˆ†é¡**: ç¼ºå°‘éŒ¯èª¤åˆ†é¡å’Œè™•ç†ç­–ç•¥
- âŒ **éŒ¯èª¤é‡è©¦**: ç¼ºå°‘è‡ªå‹•é‡è©¦æ©Ÿåˆ¶

---

## ğŸ“‹ æ¶æ§‹å°ç…§æª¢æŸ¥

### âœ… ç¬¦åˆæ¶æ§‹è¨­è¨ˆ

1. **åˆ†å±¤æ¶æ§‹**: âœ… åš´æ ¼éµå¾ª `routes` â†’ `shared` â†’ `core` åˆ†å±¤
2. **Repository æ¨¡å¼**: âœ… æ‰€æœ‰æ•¸æ“šè¨ªå•éƒ½é€šé Repository
3. **Signals ç‹€æ…‹ç®¡ç†**: âœ… Service å±¤ä½¿ç”¨ Signalsï¼Œæš´éœ² ReadonlySignal
4. **é¡å‹å®‰å…¨**: âœ… ä½¿ç”¨ TypeScript åš´æ ¼é¡å‹
5. **ä¾è³´æ³¨å…¥**: âœ… ä½¿ç”¨ `inject()` å‡½æ•¸

### âš ï¸ éœ€è¦æ”¹é€²

1. **èšåˆåˆ·æ–°æ©Ÿåˆ¶**: âŒ æœªå¯¦ç¾ Aggregation Refresh Pattern
2. **æ´»å‹•è¨˜éŒ„**: âŒ æœªå¯¦ç¾ Activity Service
3. **å·¥ä½œæµæ¨¡å¼**: âŒ æœªå¯¦ç¾ Workflow Pattern
4. **PR åˆä½µé‚è¼¯**: âš ï¸ éƒ¨åˆ†å¯¦ç¾ï¼Œç¼ºå°‘å¯¦éš›åˆä½µé‚è¼¯

---

## ğŸ” ä»£ç¢¼è³ªé‡åˆ†æ

### âœ… å„ªé»

1. **ä»£ç¢¼çµæ§‹æ¸…æ™°**: åš´æ ¼éµå¾ªåˆ†å±¤æ¶æ§‹
2. **é¡å‹å®‰å…¨**: å®Œæ•´çš„ TypeScript é¡å‹å®šç¾©
3. **ç‹€æ…‹ç®¡ç†è¦ç¯„**: ä½¿ç”¨ Signals ç®¡ç†ç‹€æ…‹
4. **éŒ¯èª¤è™•ç†**: åŸºæœ¬çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
5. **æ–‡æª”å®Œæ•´**: ä»£ç¢¼è¨»é‡‹æ¸…æ™°

### âš ï¸ éœ€è¦æ”¹é€²

1. **ç¼ºå°‘ Facade å±¤**: çµ„ä»¶ç›´æ¥ä½¿ç”¨ Serviceï¼Œç¼ºå°‘ Facade å±¤å°è£
2. **ç¼ºå°‘èšåˆæœå‹™**: ç¼ºå°‘èšåˆè¨ˆç®—å’Œ KPI æœå‹™
3. **ç¼ºå°‘æ´»å‹•è¨˜éŒ„**: ç¼ºå°‘æ“ä½œè¨˜éŒ„å’Œå¯©è¨ˆè¿½è¹¤
4. **ç¼ºå°‘ Realtime**: ç¼ºå°‘å³æ™‚æ›´æ–°æ©Ÿåˆ¶
5. **PR åˆä½µä¸å®Œæ•´**: åˆä½µé‚è¼¯åªæ›´æ–°ç‹€æ…‹ï¼Œæœªå¯¦ç¾å¯¦éš›åˆä½µ

---

## ğŸ“Š å¯¦ç¾å®Œæ•´åº¦è©•ä¼°

### Repository å±¤: 100% âœ…

| Repository | å®Œæˆåº¦ | ç‹€æ…‹ |
|-----------|--------|------|
| BlueprintRepository | 100% | âœ… å®Œæ•´ |
| BlueprintBranchRepository | 100% | âœ… å®Œæ•´ |
| BranchForkRepository | 100% | âœ… å®Œæ•´ |
| PullRequestRepository | 100% | âœ… å®Œæ•´ |
| BlueprintConfigRepository | 100% | âœ… å®Œæ•´ |

### Service å±¤: 80% âš ï¸

| Service | å®Œæˆåº¦ | ç‹€æ…‹ |
|---------|--------|------|
| BlueprintService | 90% | âœ… åŸºæœ¬å®Œæ•´ |
| BranchService | 85% | âœ… åŸºæœ¬å®Œæ•´ |
| PullRequestService | 70% | âš ï¸ ç¼ºå°‘åˆä½µé‚è¼¯ |
| BlueprintAggregationService | 0% | âŒ æœªå¯¦ç¾ |
| BlueprintActivityService | 0% | âŒ æœªå¯¦ç¾ |
| BlueprintAggregationRefreshService | 0% | âŒ æœªå¯¦ç¾ |

### Routes å±¤: 70% âš ï¸

| Component | å®Œæˆåº¦ | ç‹€æ…‹ |
|-----------|--------|------|
| BlueprintListComponent | 90% | âœ… åŸºæœ¬å®Œæ•´ |
| BlueprintDetailComponent | 80% | âœ… åŸºæœ¬å®Œæ•´ |
| BlueprintFormComponent | 85% | âœ… åŸºæœ¬å®Œæ•´ |
| BranchManagementComponent | 60% | âš ï¸ éƒ¨åˆ†å¯¦ç¾ |
| PullRequestCenterComponent | 60% | âš ï¸ éƒ¨åˆ†å¯¦ç¾ |
| BlueprintAggregationFacade | 0% | âŒ æœªå¯¦ç¾ |

### æ ¸å¿ƒåŠŸèƒ½: 60% âš ï¸

| åŠŸèƒ½ | å®Œæˆåº¦ | ç‹€æ…‹ |
|------|--------|------|
| è—åœ– CRUD | 100% | âœ… å®Œæ•´ |
| åˆ†æ”¯ç®¡ç† | 80% | âœ… åŸºæœ¬å®Œæ•´ |
| Fork æ©Ÿåˆ¶ | 85% | âœ… åŸºæœ¬å®Œæ•´ |
| PR æ©Ÿåˆ¶ | 60% | âš ï¸ ç¼ºå°‘åˆä½µé‚è¼¯ |
| èšåˆåˆ·æ–° | 0% | âŒ æœªå¯¦ç¾ |
| æ´»å‹•è¨˜éŒ„ | 0% | âŒ æœªå¯¦ç¾ |
| Realtime æ•´åˆ | 0% | âŒ æœªå¯¦ç¾ |

---

## ğŸ¯ å„ªå…ˆç´šæ”¹é€²å»ºè­°

### ğŸ”´ é«˜å„ªå…ˆç´šï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

1. **å¯¦ç¾ PR åˆä½µé‚è¼¯**
   - å¯¦ç¾ `mergePullRequest()` çš„å¯¦éš›åˆä½µé‚è¼¯
   - èª¿ç”¨ Edge Function `branch-merge`
   - æ›´æ–°ä»»å‹™æ‰¿æ”¬æ¬„ä½

2. **å¯¦ç¾ Activity Service**
   - å‰µå»º `BlueprintActivityService`
   - è‡ªå‹•è¨˜éŒ„æ‰€æœ‰ CUD æ“ä½œ
   - æ•´åˆåˆ°ç¾æœ‰ Service å±¤

3. **å¯¦ç¾ Aggregation Refresh Pattern**
   - å‰µå»º `BlueprintAggregationRefreshService`
   - å¯¦ç¾äº‹ä»¶ç™¼é€å’Œæ¥æ”¶æ©Ÿåˆ¶
   - æ•´åˆåˆ°ç¾æœ‰ Service å±¤

### ğŸŸ¡ ä¸­å„ªå…ˆç´šï¼ˆå¢å¼·åŠŸèƒ½ï¼‰

4. **å¯¦ç¾èšåˆæœå‹™**
   - å‰µå»º `BlueprintAggregationService`
   - å¯¦ç¾ KPI è¨ˆç®—
   - æ•´åˆ Materialized Views

5. **å¯¦ç¾åˆ†æ”¯æ¬Šé™æ§åˆ¶**
   - å‰µå»º `BranchPermissionRepository`
   - å¯¦ç¾æ¬Šé™é©—è­‰é‚è¼¯
   - æ•´åˆåˆ°åˆ†æ”¯ç®¡ç†æµç¨‹

6. **å¯¦ç¾ Realtime æ•´åˆ**
   - åœ¨ Service å±¤æ·»åŠ  Realtime è¨‚é–±
   - å¯¦ç¾å³æ™‚æ›´æ–°æ©Ÿåˆ¶
   - æ•´åˆåˆ°ç¾æœ‰ç‹€æ…‹ç®¡ç†

### ğŸŸ¢ ä½å„ªå…ˆç´šï¼ˆå„ªåŒ–åŠŸèƒ½ï¼‰

7. **å‰µå»º Facade å±¤**
   - å‰µå»º `BlueprintFacade`
   - å°è£ Service å±¤é‚è¼¯
   - æä¾›çµ±ä¸€çš„çµ„ä»¶æ¥å£

8. **å¢å¼·éŒ¯èª¤è™•ç†**
   - å‰µå»º `ErrorStateService`
   - å¯¦ç¾éŒ¯èª¤åˆ†é¡å’Œè™•ç†ç­–ç•¥
   - æ·»åŠ è‡ªå‹•é‡è©¦æ©Ÿåˆ¶

---

## ğŸ“ è©³ç´°ä»£ç¢¼åˆ†æ

### 1. BlueprintService åˆ†æ

#### âœ… å„ªé»
- ä½¿ç”¨ Signals ç®¡ç†ç‹€æ…‹ï¼Œç¬¦åˆ Angular 20 æœ€ä½³å¯¦è¸
- æš´éœ² ReadonlySignalï¼Œé˜²æ­¢çµ„ä»¶ç›´æ¥ä¿®æ”¹ç‹€æ…‹
- ä½¿ç”¨ computed signals æä¾›æ´¾ç”Ÿç‹€æ…‹
- å®Œæ•´çš„ CRUD æ“ä½œ

#### âš ï¸ æ”¹é€²å»ºè­°
```typescript
// å»ºè­°æ·»åŠ èšåˆåˆ·æ–°æ©Ÿåˆ¶
async createBlueprint(data: BlueprintInsert): Promise<Blueprint> {
  const blueprint = await firstValueFrom(this.blueprintRepository.create(data));
  
  // å»ºè­°ï¼šè¨˜éŒ„æ´»å‹•
  await this.activityService.record({
    entityType: 'blueprint',
    entityId: blueprint.id,
    action: 'created',
    changes: data
  });
  
  // å»ºè­°ï¼šè§¸ç™¼èšåˆåˆ·æ–°
  this.aggregationRefreshService.emit(blueprint.id, ['blueprints']);
  
  this.blueprintsState.update(blueprints => [...blueprints, blueprint]);
  return blueprint;
}
```

### 2. BranchService åˆ†æ

#### âœ… å„ªé»
- Fork æ©Ÿåˆ¶å¯¦ç¾å®Œæ•´
- åˆ†æ”¯ç‹€æ…‹ç®¡ç†æ¸…æ™°
- ä½¿ç”¨ Signals ç®¡ç†ç‹€æ…‹

#### âš ï¸ æ”¹é€²å»ºè­°
```typescript
// å»ºè­°ï¼šæ·»åŠ æ¬Šé™é©—è­‰
async forkBranch(...): Promise<BlueprintBranch> {
  // å»ºè­°ï¼šé©—è­‰ç”¨æˆ¶æ˜¯å¦æœ‰ Fork æ¬Šé™
  const hasPermission = await this.permissionService.checkBranchPermission(
    blueprintId,
    'fork'
  );
  if (!hasPermission) {
    throw new Error('æ²’æœ‰ Fork æ¬Šé™');
  }
  
  // ç¾æœ‰é‚è¼¯...
}
```

### 3. PullRequestService åˆ†æ

#### âœ… å„ªé»
- PR ç‹€æ…‹ç®¡ç†å®Œæ•´
- å¯©æ ¸æµç¨‹æ¸…æ™°

#### âŒ ç¼ºå¤±åŠŸèƒ½
```typescript
// ç•¶å‰å¯¦ç¾ï¼šåªæ›´æ–°ç‹€æ…‹
async mergePullRequest(prId: string, mergedBy: string, changesSummary?: any): Promise<PullRequest> {
  return await this.updatePullRequest(prId, {
    status: PRStatus.MERGED,
    mergedBy,
    mergedAt: new Date().toISOString(),
    changesSummary: changesSummary || {}
  } as any);
}

// å»ºè­°å¯¦ç¾ï¼šå¯¦éš›åˆä½µé‚è¼¯
async mergePullRequest(prId: string, mergedBy: string): Promise<PullRequest> {
  const pr = await this.loadPullRequestById(prId);
  if (!pr) throw new Error('PR ä¸å­˜åœ¨');
  
  // 1. èª¿ç”¨ Edge Function åŸ·è¡Œåˆä½µ
  await this.edgeFunctionService.call('branch-merge', {
    pullRequestId: prId,
    blueprintId: pr.blueprint_id,
    branchId: pr.branch_id,
    payload: pr.payload,
    mergedBy
  });
  
  // 2. æ›´æ–° PR ç‹€æ…‹
  const mergedPR = await this.updatePullRequest(prId, {
    status: PRStatus.MERGED,
    mergedBy,
    mergedAt: new Date().toISOString()
  } as any);
  
  // 3. è¨˜éŒ„æ´»å‹•
  await this.activityService.record({
    entityType: 'pull_request',
    entityId: prId,
    action: 'merged',
    changes: { status: PRStatus.MERGED }
  });
  
  // 4. è§¸ç™¼èšåˆåˆ·æ–°
  this.aggregationRefreshService.emit(pr.blueprint_id, ['tasks', 'progress']);
  
  return mergedPR;
}
```

---

## ğŸ”— ç›¸é—œæ–‡ä»¶å°ç…§

### æ¶æ§‹æ–‡æª”å°ç…§

| æ¶æ§‹æ–‡æª” | å¯¦ç¾ç‹€æ³ | å°ç…§çµæœ |
|---------|---------|---------|
| `01-ç³»çµ±æ¶æ§‹æ€ç¶­å°åœ–.mermaid.md` | âœ… åŸºæœ¬ç¬¦åˆ | æ ¸å¿ƒåŠŸèƒ½å·²å¯¦ç¾ |
| `04-æ¥­å‹™æµç¨‹åœ–.mermaid.md` | âš ï¸ éƒ¨åˆ†ç¬¦åˆ | ç¼ºå°‘æ´»å‹•è¨˜éŒ„å’Œèšåˆåˆ·æ–° |
| `05-å¸³æˆ¶å±¤æµç¨‹åœ–.mermaid.md` | âœ… ç¬¦åˆ | å¸³æˆ¶æ•´åˆå®Œæ•´ |
| `20-å®Œæ•´æ¶æ§‹æµç¨‹åœ–.mermaid.md` | âš ï¸ éƒ¨åˆ†ç¬¦åˆ | æ ¸å¿ƒæµç¨‹å·²å¯¦ç¾ï¼Œç¼ºå°‘é«˜ç´šåŠŸèƒ½ |

### æ•¸æ“šåº«çµæ§‹å°ç…§

| è³‡æ–™è¡¨ | Repository | Service | ç‹€æ…‹ |
|--------|-----------|---------|------|
| `blueprints` | âœ… | âœ… | å®Œæ•´ |
| `blueprint_branches` | âœ… | âœ… | å®Œæ•´ |
| `branch_forks` | âœ… | âœ… | å®Œæ•´ |
| `pull_requests` | âœ… | âœ… | åŸºæœ¬å®Œæ•´ |
| `blueprint_configs` | âœ… | âœ… | å®Œæ•´ |
| `branch_permissions` | âŒ | âŒ | æœªå¯¦ç¾ |
| `activity_logs` | âœ… | âŒ | Repository å­˜åœ¨ï¼ŒService æœªæ•´åˆ |
| `pull_request_reviews` | âŒ | âŒ | æœªå¯¦ç¾ |

---

## ğŸ“ˆ å¯¦ç¾è·¯ç·šåœ–

### Phase 1: æ ¸å¿ƒåŠŸèƒ½å®Œå–„ï¼ˆå„ªå…ˆç´šï¼šğŸ”´ é«˜ï¼‰

1. **å¯¦ç¾ PR åˆä½µé‚è¼¯**
   - [ ] å‰µå»º Edge Function èª¿ç”¨æœå‹™
   - [ ] å¯¦ç¾ `mergePullRequest()` å¯¦éš›åˆä½µé‚è¼¯
   - [ ] æ›´æ–°ä»»å‹™æ‰¿æ”¬æ¬„ä½

2. **å¯¦ç¾ Activity Service**
   - [ ] å‰µå»º `BlueprintActivityService`
   - [ ] æ•´åˆåˆ°ç¾æœ‰ Service å±¤
   - [ ] å¯¦ç¾æ´»å‹•è¨˜éŒ„æŸ¥è©¢

3. **å¯¦ç¾ Aggregation Refresh Pattern**
   - [ ] å‰µå»º `BlueprintAggregationRefreshService`
   - [ ] å¯¦ç¾äº‹ä»¶ç™¼é€å’Œæ¥æ”¶
   - [ ] æ•´åˆåˆ°ç¾æœ‰ Service å±¤

### Phase 2: å¢å¼·åŠŸèƒ½ï¼ˆå„ªå…ˆç´šï¼šğŸŸ¡ ä¸­ï¼‰

4. **å¯¦ç¾èšåˆæœå‹™**
   - [ ] å‰µå»º `BlueprintAggregationService`
   - [ ] å¯¦ç¾ KPI è¨ˆç®—
   - [ ] æ•´åˆ Materialized Views

5. **å¯¦ç¾åˆ†æ”¯æ¬Šé™æ§åˆ¶**
   - [ ] å‰µå»º `BranchPermissionRepository`
   - [ ] å¯¦ç¾æ¬Šé™é©—è­‰é‚è¼¯
   - [ ] æ•´åˆåˆ°åˆ†æ”¯ç®¡ç†

6. **å¯¦ç¾ Realtime æ•´åˆ**
   - [ ] åœ¨ Service å±¤æ·»åŠ  Realtime è¨‚é–±
   - [ ] å¯¦ç¾å³æ™‚æ›´æ–°æ©Ÿåˆ¶

### Phase 3: å„ªåŒ–åŠŸèƒ½ï¼ˆå„ªå…ˆç´šï¼šğŸŸ¢ ä½ï¼‰

7. **å‰µå»º Facade å±¤**
   - [ ] å‰µå»º `BlueprintFacade`
   - [ ] å°è£ Service å±¤é‚è¼¯

8. **å¢å¼·éŒ¯èª¤è™•ç†**
   - [ ] å‰µå»º `ErrorStateService`
   - [ ] å¯¦ç¾éŒ¯èª¤åˆ†é¡å’Œè™•ç†

---

## ğŸ¯ çµè«–

### ç¸½é«”è©•ä¼°

**è—åœ–ï¼ˆBlueprintï¼‰æ ¸å¿ƒåŠŸèƒ½å·²åŸºæœ¬å¯¦ç¾ï¼Œä½†ç¼ºå°‘é«˜ç´šåŠŸèƒ½å’Œæ¶æ§‹æ¨¡å¼ã€‚**

- âœ… **åŸºç¤åŠŸèƒ½å®Œæ•´**: CRUDã€åˆ†æ”¯ç®¡ç†ã€PR æ©Ÿåˆ¶åŸºæœ¬å¯¦ç¾
- âš ï¸ **é«˜ç´šåŠŸèƒ½ç¼ºå¤±**: èšåˆåˆ·æ–°ã€æ´»å‹•è¨˜éŒ„ã€å·¥ä½œæµæ¨¡å¼æœªå¯¦ç¾
- âš ï¸ **PR åˆä½µä¸å®Œæ•´**: åªæ›´æ–°ç‹€æ…‹ï¼Œæœªå¯¦ç¾å¯¦éš›åˆä½µé‚è¼¯
- âœ… **æ¶æ§‹è¨­è¨ˆè‰¯å¥½**: åš´æ ¼éµå¾ªåˆ†å±¤æ¶æ§‹ï¼Œä»£ç¢¼çµæ§‹æ¸…æ™°

### å»ºè­°

1. **å„ªå…ˆå¯¦ç¾ PR åˆä½µé‚è¼¯**: é€™æ˜¯ Git-like åˆ†æ”¯æ¨¡å‹çš„æ ¸å¿ƒåŠŸèƒ½
2. **å¯¦ç¾ Activity Service**: æä¾›æ“ä½œå¯©è¨ˆå’Œè¿½è¹¤èƒ½åŠ›
3. **å¯¦ç¾ Aggregation Refresh Pattern**: æä¾›è‡ªå‹•èšåˆåˆ·æ–°æ©Ÿåˆ¶
4. **é€æ­¥å®Œå–„å…¶ä»–åŠŸèƒ½**: æŒ‰ç…§å„ªå…ˆç´šé€æ­¥å¯¦ç¾ç¼ºå¤±åŠŸèƒ½

---

**åˆ†æå®Œæˆæ™‚é–“**: 2025-01-15  
**åˆ†æå·¥å…·**: Cursor AI + Codebase Search  
**åˆ†æç‹€æ…‹**: âœ… å®Œæˆ

