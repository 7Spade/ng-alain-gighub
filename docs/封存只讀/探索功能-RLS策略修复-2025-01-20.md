# 探索功能 RLS 策略修复

> **日期**：2025-01-20  
> **问题**：探索功能只能搜索到自己，无法搜索到其他用户  
> **原因**：`accounts` 表的 RLS 策略只允许用户查看自己的账户

---

## 🔍 问题分析

### 当前 RLS 策略

`accounts` 表的 SELECT 策略只允许用户查看：
1. 自己的账户（`auth_user_id = auth.uid()`）
2. 自己创建的组织账户（`auth_organization_id = auth.uid()`）
3. 自己创建的 Bot 账户（`auth_bot_id = auth.uid()`）
4. 自己所属组织的 Bot 账户
5. 自己所属的组织账户

### 问题根源

探索功能需要允许用户搜索和查看其他用户的公开信息，但当前的 RLS 策略限制了只能看到自己的账户，导致无法搜索到其他用户。

---

## 🔧 解决方案

### 添加新的 RLS 策略

添加一个新的 RLS 策略，允许已认证用户查看所有活跃的账户（用于搜索功能）：

```sql
-- 为探索功能添加 RLS 策略：允许已认证用户搜索和查看所有活跃的账户
CREATE POLICY "Authenticated users can search active accounts for explore"
ON accounts FOR SELECT
TO authenticated
USING (
  -- 只允许查看活跃状态的账户
  status = 'active'
  AND (
    -- 允许查看所有用户类型的账户（用于搜索）
    type = 'User'
    OR
    -- 允许查看所有组织类型的账户（用于搜索）
    type = 'Organization'
  )
);
```

### 策略说明

1. **策略名称**：`Authenticated users can search active accounts for explore`
2. **适用范围**：`authenticated` 角色（已认证用户）
3. **操作类型**：`SELECT`（只读）
4. **条件**：
   - `status = 'active'` - 只显示活跃账户
   - `type IN ('User', 'Organization')` - 只允许用户和组织类型
   - 不允许查看 Bot 账户（除非用户有权限，由现有策略控制）

### 策略关系

新策略与现有策略是 **OR** 关系，所以：
- ✅ 用户仍然可以查看自己的账户（通过现有策略）
- ✅ 用户现在也可以搜索和查看其他活跃用户的账户（通过新策略）
- ✅ 组织相关的权限仍然由现有策略控制
- ✅ Bot 账户的权限仍然由现有策略控制

---

## 📝 执行步骤

### 方法 1：使用 Supabase MCP 工具（推荐）

```sql
-- 使用 mcp_supabase_apply_migration 执行迁移
```

### 方法 2：手动执行 SQL

1. 登录 Supabase Dashboard
2. 进入 SQL Editor
3. 执行以下 SQL：

```sql
-- 为探索功能添加 RLS 策略：允许已认证用户搜索和查看所有活跃的账户
CREATE POLICY "Authenticated users can search active accounts for explore"
ON accounts FOR SELECT
TO authenticated
USING (
  -- 只允许查看活跃状态的账户
  status = 'active'
  AND (
    -- 允许查看所有用户类型的账户（用于搜索）
    type = 'User'
    OR
    -- 允许查看所有组织类型的账户（用于搜索）
    type = 'Organization'
  )
);
```

### 方法 3：使用 Supabase CLI

```bash
# 创建迁移文件
supabase migration new add_explore_search_policy_for_accounts

# 在迁移文件中添加 SQL
# 然后执行迁移
supabase db push
```

---

## ✅ 验证步骤

### 1. 验证策略已创建

```sql
-- 检查 accounts 表的 RLS 策略
SELECT 
  policyname,
  cmd,
  qual
FROM pg_policies 
WHERE tablename = 'accounts'
ORDER BY cmd, policyname;
```

应该能看到新的策略：`Authenticated users can search active accounts for explore`

### 2. 测试搜索功能

1. 登录系统
2. 进入"探索"页面
3. 搜索其他用户的名称
4. 应该能看到搜索结果

### 3. 验证权限控制

- ✅ 可以搜索到其他活跃用户
- ✅ 可以搜索到其他活跃组织
- ✅ 无法搜索到非活跃账户
- ✅ 无法搜索到 Bot 账户（除非有权限）
- ✅ 仍然可以查看自己的账户

---

## 🔒 安全考虑

### 隐私保护

1. **只显示活跃账户**：非活跃账户不会被搜索到
2. **只显示用户和组织**：Bot 账户不会被搜索到（除非用户有权限）
3. **只读权限**：策略只允许 SELECT，不允许修改

### 数据暴露

1. **公开信息**：搜索功能只暴露账户的基本信息（名称、邮箱等）
2. **敏感信息**：敏感信息（如 metadata）仍然受现有策略保护
3. **权限控制**：详细的账户信息仍然受现有策略控制

---

## 📚 相关文档

- [探索功能设计文档](./探索功能设计文档.md)
- [RLS 策略开发指南](./50-RLS策略開發指南.md)
- [账户系统架构文档](./docs/账户系统MVP实施完成总结.md)

---

**最后更新**：2025-01-20  
**维护者**：开发团队

