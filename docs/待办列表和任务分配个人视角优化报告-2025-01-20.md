# 待办列表和任务分配个人视角优化报告

> **优化日期**：2025-01-20  
> **问题**：在个人视角下，待办列表和任务分配不应该显示"请先选择蓝图"

---

## 🔍 问题分析

### 问题描述

在个人视角（user context）下：
- **待办列表**：显示"请先选择蓝图"，但个人视角应该自动显示用户的所有待办任务
- **任务分配**：显示"请先选择蓝图"，但个人视角应该自动显示用户的所有任务分配

### 根本原因

1. 组件没有根据当前上下文（contextType）区分处理逻辑
2. 所有视角都要求先选择蓝图，没有考虑个人视角的特殊性
3. 缺少按用户加载任务和任务分配的逻辑

---

## ✅ 解决方案

### 1. 根据上下文类型调整显示逻辑

**个人视角（user）**：
- 自动加载当前用户的所有待办任务
- 自动加载当前用户的所有任务分配
- 不显示蓝图选择器
- 不显示"请先选择蓝图"提示

**组织/团队视角（organization/team）**：
- 需要选择蓝图
- 显示蓝图选择器
- 显示"请先选择蓝图"提示（如果未选择）

### 2. 添加批量加载任务的方法

- 在 `TaskRepository` 中添加 `findByIds` 方法，支持批量查询任务
- 在 `TaskService` 中添加 `loadTasksByIds` 方法

### 3. 使用 TaskAssignmentService 加载用户分配

- 使用 `TaskAssignmentService.loadByAssigneeId` 加载用户的所有任务分配
- 根据任务分配获取任务 ID 列表
- 批量加载任务详情

---

## 📝 代码变更详情

### 1. `src/app/core/infra/repositories/task.repository.ts`

**添加批量查询方法**：

```typescript
/**
 * 根据任务 ID 列表批量查询任务
 *
 * @param taskIds 任务 ID 列表
 * @param options 查询选项
 * @returns Observable<Task[]>
 */
findByIds(taskIds: string[], options?: QueryOptions): Observable<Task[]> {
  if (taskIds.length === 0) {
    return from(Promise.resolve([]));
  }

  // 使用 Supabase 的 in 操作符批量查询
  let query = this.supabase.from(this.tableName as any)
    .select(options?.select || '*')
    .in('id', taskIds) as any;

  // 应用排序和分页...
  return from(Promise.resolve(query) as Promise<PostgrestResponse<any>>).pipe(
    map((response: PostgrestResponse<any>) => {
      const data = handleSupabaseResponse(response, `${this.constructor.name}.findByIds`);
      return Array.isArray(data) 
        ? data.map(item => toCamelCaseData<Task>(item)) 
        : [toCamelCaseData<Task>(data)];
    })
  );
}
```

### 2. `src/app/shared/services/task/task.service.ts`

**添加批量加载方法**：

```typescript
/**
 * 根据任务 ID 列表批量加载任务
 *
 * @param taskIds 任务 ID 列表
 */
async loadTasksByIds(taskIds: string[]): Promise<void> {
  if (taskIds.length === 0) {
    this.tasksState.set([]);
    return;
  }

  this.loadingState.set(true);
  this.errorState.set(null);

  try {
    const tasks = await firstValueFrom(this.taskRepository.findByIds(taskIds));
    this.tasksState.set(tasks);
  } catch (error) {
    this.errorState.set(error instanceof Error ? error.message : '加载任务列表失败');
    throw error;
  } finally {
    this.loadingState.set(false);
  }
}
```

### 3. `src/app/routes/tasks/todo/task-todo.component.ts`

**主要变更**：

1. **注入依赖**：
   - 添加 `WorkspaceContextFacade` 用于获取当前上下文
   - 添加 `TaskAssignmentService` 用于加载任务分配

2. **添加上下文判断**：
   ```typescript
   readonly isUserContext = computed(() => this.contextFacade.contextType() === 'user');
   ```

3. **条件显示蓝图选择器**：
   ```html
   @if (!isUserContext()) {
     <nz-select ...>...</nz-select>
   }
   ```

4. **条件显示空状态**：
   ```html
   @if (!isUserContext() && !selectedBlueprintId()) {
     <nz-empty nzNotFoundContent="请先选择蓝图"></nz-empty>
   } @else if (todoTasks().length === 0) {
     <nz-empty nzNotFoundContent="暂无待办任务"></nz-empty>
   }
   ```

5. **添加个人视角加载方法**：
   ```typescript
   async loadUserTodos(): Promise<void> {
     const currentUserAccountId = this.contextFacade.currentUserAccountId();
     if (!currentUserAccountId) {
       this.message.warning('无法获取当前用户信息');
       return;
     }

     try {
       // 加载用户的所有任务分配
       await this.taskAssignmentService.loadByAssigneeId(currentUserAccountId);
       const assignments = this.taskAssignmentService.assignments();
       const taskIds = assignments.map(a => a.task_id);

       if (taskIds.length === 0) {
         await this.taskService.loadTasksByIds([]);
         return;
       }

       // 批量加载所有任务
       await this.taskService.loadTasksByIds(taskIds);
     } catch (error) {
       console.error('加载用户待办任务失败:', error);
       this.message.error('加载待办列表失败');
     }
   }
   ```

### 4. `src/app/routes/tasks/assignments/task-assignments.component.ts`

**主要变更**：

1. **注入依赖**：
   - 添加 `WorkspaceContextFacade` 用于获取当前上下文
   - 添加 `TaskAssignmentService` 用于加载任务分配

2. **添加上下文判断**：
   ```typescript
   readonly isUserContext = computed(() => this.contextFacade.contextType() === 'user');
   ```

3. **使用 computed 信号**：
   ```typescript
   readonly assignments = computed(() => {
     if (this.isUserContext()) {
       // 个人视角：使用 TaskAssignmentService 的状态
       return this.taskAssignmentService.assignments();
     }
     // 其他视角：使用本地状态
     return this.localAssignments();
   });
   ```

4. **条件显示蓝图选择器**：
   ```html
   @if (!isUserContext()) {
     <nz-select ...>...</nz-select>
   }
   ```

5. **添加个人视角加载方法**：
   ```typescript
   async loadUserAssignments(): Promise<void> {
     const currentUserAccountId = this.contextFacade.currentUserAccountId();
     if (!currentUserAccountId) {
       this.message.warning('无法获取当前用户信息');
       return;
     }

     try {
       // 加载用户的所有任务分配
       await this.taskAssignmentService.loadByAssigneeId(currentUserAccountId);

       // 加载相关任务信息（用于显示任务标题）
       const assignments = this.taskAssignmentService.assignments();
       const taskIds = assignments.map(a => a.task_id);
       if (taskIds.length > 0) {
         await this.taskService.loadTasksByIds(taskIds);
       }
     } catch (error) {
       console.error('加载用户任务分配失败:', error);
       this.message.error('加载任务分配失败');
     }
   }
   ```

---

## ✅ 验证检查清单

### 功能验证

- [x] 个人视角下，待办列表自动加载用户的所有待办任务
- [x] 个人视角下，任务分配自动加载用户的所有任务分配
- [x] 个人视角下，不显示蓝图选择器
- [x] 个人视角下，不显示"请先选择蓝图"提示
- [x] 组织/团队视角下，仍然需要选择蓝图
- [x] 组织/团队视角下，显示蓝图选择器
- [x] 组织/团队视角下，未选择蓝图时显示"请先选择蓝图"提示

### 代码质量

- [x] 所有 lint 错误已修复
- [x] 类型检查通过
- [x] 符合架构分层原则
- [x] 使用 Signals 管理状态
- [x] 错误处理完善

---

## 🎯 功能说明

### 待办列表（个人视角）

**行为**：
1. 自动加载当前用户的所有任务分配
2. 根据任务分配获取任务 ID 列表
3. 批量加载任务详情
4. 过滤出待办任务（待处理、已指派、进行中）
5. 显示任务列表

**空状态**：
- 如果没有待办任务，显示"暂无待办任务"

### 任务分配（个人视角）

**行为**：
1. 自动加载当前用户的所有任务分配
2. 加载相关任务信息（用于显示任务标题）
3. 显示任务分配列表

**空状态**：
- 如果没有任务分配，显示"暂无任务分配"

### 组织/团队视角

**行为**：
- 需要先选择蓝图
- 选择蓝图后加载该蓝图下的任务和任务分配
- 显示蓝图选择器

---

## 📚 相关文档

- [accounts 模块后续工作实施完成报告](./accounts模块后续工作实施完成报告-2025-01-20.md)
- [org 模块三视角设计方案](./org模块三视角设计方案-2025-01-20.md)

---

**最後更新**：2025-01-20  
**維護者**：開發團隊

