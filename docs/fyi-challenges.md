# 問題與挑戰記錄 (FYI - Challenges)

> 參考：[@fyi.md](./fyi.md)

記錄專案在開發過程中遇到的問題、挑戰及其解決方案。

---

## 📋 記錄格式

每個問題/挑戰應包含：
- **日期**：問題發現或解決的日期
- **問題描述**：問題的詳細描述
- **影響範圍**：問題影響的模組或功能
- **解決方案**：採用的解決方法
- **經驗教訓**：從中學到的經驗或最佳實踐

---

## 🐛 問題與挑戰

### 2025-01-15: 權限系統設計權衡

#### 問題描述
在設計權限服務時，需要平衡以下幾個方面：
- 性能：權限檢查頻繁，需要快速響應
- 實時性：權限變更需要及時生效
- 一致性：多層緩存需要保持數據一致

#### 影響範圍
- 權限檢查性能
- 權限更新延遲
- 系統響應速度

#### 解決方案
採用三層緩存策略：
1. **ACLService 緩存**（框架級）：最快，但需要手動同步
2. **內存緩存**（應用級）：5 分鐘 TTL，平衡性能和實時性
3. **數據庫**（持久化）：權威數據源，實時更新

#### 權衡決策
- **緩存時間選擇**：5 分鐘 TTL
  - 過短（< 1 分鐘）：增加數據庫查詢，影響性能
  - 過長（> 10 分鐘）：權限更新延遲，影響實時性
  - 5 分鐘：平衡兩者，適合大多數場景

#### 經驗教訓
- 多層緩存需要明確的更新策略
- 緩存時間需要根據業務場景調整
- 需要提供手動刷新機制應對緊急情況

---

### 2025-11-14: Supabase 與 @delon/auth 整合挑戰

#### 問題描述
需要整合兩個不同的認證系統：
- Supabase Auth：使用 Session 格式
- @delon/auth：使用 Token 格式
- 需要零破壞性整合，保留所有現有代碼

#### 影響範圍
- 認證流程
- 現有業務代碼
- 系統兼容性

#### 解決方案
採用適配器模式：
- 創建 `SupabaseAuthAdapterService` 作為橋樑
- 自動轉換 Session 格式為 Token 格式
- 自動同步到 TokenService
- 保留所有現有 @delon/auth 使用方式

#### 權衡決策
- **增加抽象層**：增加一層適配器，但換來兼容性
- **零破壞性**：避免大規模重構，降低風險

#### 經驗教訓
- 適配器模式適合整合不同系統
- 格式轉換需要考慮所有字段映射
- 自動同步機制需要處理邊界情況

---

### 2025-01-15: 账户系统架构违规修复

#### 问题描述
在账户系统实施过程中，发现了两个严重的架构违规问题：
1. **架构依赖违规**：`core` 层依赖 `shared` 层
   - `core/infra/repositories/account.repository.ts` 导入 `@shared` 的 `AccountType` 和 `AccountStatus`
   - `core/infra/repositories/team-member.repository.ts` 导入 `@shared` 的 `TeamMemberRole`
   - 违反了分层架构：`routes → shared → core`，`core` 不应该依赖 `shared`

2. **路径别名使用错误**：使用深层路径别名
   - 使用 `@core/infra/repositories/team.repository` 深层路径
   - 路径别名只配置到 `@core` 和 `@shared`，不支持深层路径
   - 导致 TypeScript 编译错误

#### 影响范围
- 架构合规性
- 代码可维护性
- 类型检查和编译
- 未来扩展性

#### 解决方案

**1. 架构违规修复**：
- 将 `AccountType`、`AccountStatus`、`TeamMemberRole` 枚举移到 `core/infra/types/account.types.ts`
- Repository 层使用相对路径导入：`import { AccountType, AccountStatus } from '../types/account.types'`
- 在 `shared/models/account/types.ts` 重新导出，保持向后兼容

**2. 路径别名修复**：
- 统一使用根导出：`import { TeamRepository } from '@core'`
- core 层内部使用相对路径
- 确保所有类型和类都从根导出文件导出

#### 权衡决策
- **类型定义位置**：基础设施类型应该在基础设施层定义
  - 被 Repository 使用的类型 → 放在 `core/infra/types/`
  - 被 Service 使用的类型 → 可以放在 `shared/models/`
- **向后兼容**：在 shared 层重新导出 core 层的类型，避免大规模重构

#### 经验教训
1. **分层架构的重要性**：
   - 严格遵循分层架构原则，避免循环依赖
   - 基础设施类型应该在基础设施层定义
   - 使用工具自动检测架构违规

2. **路径别名使用规范**：
   - 路径别名只配置到根导出文件，不支持深层路径
   - 统一使用根导出，保持导入路径一致性
   - 确保导出链完整：`具体文件` → `子模块 index.ts` → `根 index.ts`

3. **类型定义位置决策**：
   - 根据使用场景决定类型定义位置
   - 被基础设施使用的类型必须在基础设施层
   - 保持向后兼容，逐步迁移

#### 相关文档
- [账户系统架构违规修复总结](./账户系统架构违规修复总结.md) ⭐ 详细修复记录
- [分層架構規範](../.cursor/rules/architecture.mdc)
- [Core 模組規範](../.cursor/rules/core-specific.mdc)

---

### 待補充

當遇到新問題時，請按照上述格式記錄。

---

**最後更新**：2025-01-15  
**維護者**：開發團隊

