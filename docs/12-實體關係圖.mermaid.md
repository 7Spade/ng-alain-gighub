erDiagram
    %% ==================== 帳戶與身份系統 ====================
    AUTH_USERS ||--o{ ACCOUNTS : "extends"
    AUTH_USERS {
        uuid id PK "Supabase Auth UUID"
        string email UK "電子郵件"
        timestamp created_at "建立時間"
        jsonb raw_user_meta_data "Auth 元資料"
    }
    
    ACCOUNTS ||--o{ BLUEPRINTS : "owns"
    ACCOUNTS ||--o{ TEAMS : "belongs_to"
    ACCOUNTS ||--o{ USER_ROLES : "has"
    ACCOUNTS ||--o{ ACTIVITY_LOGS : "performs"
    ACCOUNTS {
        uuid id PK "帳戶 ID"
        uuid auth_user_id FK "Auth User ID"
        enum account_type "user|bot|organization"
        string display_name "顯示名稱"
        string avatar_url "頭像 URL (Storage)"
        jsonb metadata "擴展資料"
        timestamp created_at "建立時間"
        timestamp updated_at "更新時間"
    }
    
    TEAMS ||--o{ TEAM_MEMBERS : "contains"
    TEAMS {
        uuid id PK "團隊 ID"
        uuid organization_id FK "所屬組織"
        string name "團隊名稱"
        string description "團隊描述"
        timestamp created_at "建立時間"
    }
    
    TEAM_MEMBERS }o--|| ACCOUNTS : "is_member"
    TEAM_MEMBERS {
        uuid id PK "成員 ID"
        uuid team_id FK "團隊 ID"
        uuid account_id FK "帳戶 ID"
        enum role "admin|member|viewer"
        timestamp joined_at "加入時間"
    }
    
    %% ==================== 權限系統 ====================
    ROLES ||--o{ USER_ROLES : "assigned_to"
    ROLES ||--o{ ROLE_PERMISSIONS : "has"
    ROLES {
        uuid id PK "角色 ID"
        string name UK "角色名稱"
        string description "角色描述"
        int priority "優先級"
    }
    
    USER_ROLES }o--|| ACCOUNTS : "belongs_to"
    USER_ROLES }o--|| BLUEPRINTS : "scoped_to"
    USER_ROLES {
        uuid id PK "用戶角色 ID"
        uuid account_id FK "帳戶 ID"
        uuid role_id FK "角色 ID"
        uuid blueprint_id FK "藍圖 ID (可選)"
        timestamp assigned_at "指派時間"
    }
    
    ROLE_PERMISSIONS }o--|| PERMISSIONS : "grants"
    ROLE_PERMISSIONS {
        uuid id PK "角色權限 ID"
        uuid role_id FK "角色 ID"
        uuid permission_id FK "權限 ID"
    }
    
    PERMISSIONS {
        uuid id PK "權限 ID"
        string resource UK "資源名稱"
        string action UK "動作 (read|write|delete)"
        string description "權限描述"
    }
    
    %% ==================== 藍圖/專案系統 ====================
    BLUEPRINTS ||--o{ TASKS : "contains"
    BLUEPRINTS ||--o{ ISSUES : "tracks"
    BLUEPRINTS ||--o{ DOCUMENTS : "stores"
    BLUEPRINTS ||--o{ PROGRESS_TRACKING : "monitors"
    BLUEPRINTS {
        uuid id PK "藍圖 ID"
        uuid owner_id FK "擁有者 ID"
        string name "專案名稱"
        string description "專案描述"
        date start_date "開始日期"
        date end_date "結束日期"
        enum status "planning|active|paused|completed"
        jsonb settings "專案設定"
        timestamp created_at "建立時間"
        timestamp updated_at "更新時間"
    }
    
    %% ==================== Git-like 分支與協作 ====================
    BLUEPRINTS ||--o{ BRANCH_FORKS : "forked_to"
    BRANCH_FORKS ||--o{ BLUEPRINT_BRANCHES : "spawns"
    BLUEPRINTS ||--o{ ORGANIZATION_COLLABORATIONS : "invites"
    BLUEPRINT_BRANCHES ||--o{ PULL_REQUESTS : "submits"
    PULL_REQUESTS ||--o{ PULL_REQUEST_REVIEWS : "reviewed_by"
    
    BRANCH_FORKS {
        uuid id PK "Fork ID"
        uuid blueprint_id FK "來源藍圖"
        uuid contractor_org_id FK "承攬組織"
        timestamp forked_at "建立時間"
        text scope "承攬範圍描述"
    }
    
    BLUEPRINT_BRANCHES {
        uuid id PK "分支 ID"
        uuid fork_id FK "來源 Fork"
        uuid organization_id FK "執行組織"
        enum branch_type "org|team|bot"
        enum status "active|frozen|merged|closed"
        timestamp created_at "建立時間"
    }
    
    ORGANIZATION_COLLABORATIONS {
        uuid id PK "協作邀請 ID"
        uuid owner_org_id FK "擁有者組織"
        uuid invited_org_id FK "受邀組織"
        enum status "pending|accepted|rejected|revoked"
        timestamp created_at "建立時間"
        timestamp responded_at "回覆時間"
    }
    
    PULL_REQUESTS {
        uuid id PK "PR ID"
        uuid branch_id FK "來源分支"
        uuid blueprint_id FK "目標藍圖"
        uuid submitter_id FK "提交者"
        enum pr_status "open|reviewing|approved|rejected|merged"
        jsonb payload "提交欄位 JSON"
        timestamp submitted_at "提交時間"
        timestamp merged_at "合併時間"
    }
    
    PULL_REQUEST_REVIEWS {
        uuid id PK "PR Review ID"
        uuid pull_request_id FK "PR ID"
        uuid reviewer_id FK "審查者"
        enum decision "approved|changes_requested|rejected"
        text comments "審查意見"
        timestamp reviewed_at "審查時間"
    }
    
    %% ==================== 分支權限 ====================
    BLUEPRINT_BRANCHES ||--o{ BRANCH_ROLES : "scopes"
    BRANCH_ROLES ||--o{ BRANCH_PERMISSIONS : "grants"
    
    BRANCH_ROLES {
        uuid id PK "分支角色 ID"
        uuid branch_id FK "分支 ID"
        string name "角色名稱"
        text description "描述"
    }
    
    BRANCH_PERMISSIONS {
        uuid id PK "分支權限 ID"
        uuid branch_role_id FK "分支角色"
        uuid permission_id FK "對應權限"
        boolean allow_write "允許寫入承攬欄位"
    }
    
    %% ==================== 任務系統 ====================
    TASKS ||--o{ DAILY_REPORTS : "generates"
    TASKS ||--o{ QUALITY_CHECKS : "requires"
    TASKS ||--o{ COMMENTS : "discusses"
    TASKS ||--o{ TASK_ASSIGNMENTS : "assigned_to"
    TASKS ||--o{ STAGING_SUBMISSIONS : "queued_in"
    TASKS {
        uuid id PK "任務 ID"
        uuid blueprint_id FK "藍圖 ID"
        uuid parent_task_id FK "父任務 ID (可選)"
        string title "任務標題"
        text description "任務描述"
        enum status "pending|assigned|in_progress|completed|cancelled"
        enum priority "low|medium|high|urgent"
        date start_date "開始日期"
        date due_date "截止日期"
        decimal estimated_hours "預估工時"
        decimal actual_hours "實際工時"
        timestamp created_at "建立時間"
        timestamp updated_at "更新時間"
    }
    
    TASK_ASSIGNMENTS }o--|| ACCOUNTS : "assigned_to"
    TASK_ASSIGNMENTS {
        uuid id PK "任務指派 ID"
        uuid task_id FK "任務 ID"
        uuid account_id FK "帳戶 ID"
        enum role "owner|assignee|reviewer"
        timestamp assigned_at "指派時間"
    }
    
    STAGING_SUBMISSIONS }o--|| ACCOUNTS : "submitted_by"
    STAGING_SUBMISSIONS {
        uuid id PK "暫存提交 ID"
        uuid task_id FK "任務 ID"
        uuid submitter_id FK "提交人 ID"
        enum submission_type "daily_report|quality_check|issue_update"
        jsonb payload "提交內容快照"
        timestamp submitted_at "提交時間"
        timestamp expires_at "48h 到期時間"
        boolean recalled "是否已撤回"
    }
    
    %% ==================== 每日報表系統 ====================
    DAILY_REPORTS ||--o{ REPORT_PHOTOS : "includes"
    DAILY_REPORTS }o--|| WEATHER_CACHE : "references"
    DAILY_REPORTS {
        uuid id PK "日報 ID"
        uuid task_id FK "任務 ID"
        uuid reporter_id FK "填報人 ID"
        date report_date "報表日期"
        text work_summary "工作摘要"
        decimal work_hours "工作時數"
        int worker_count "工人數量"
        text notes "備註"
        timestamp created_at "建立時間"
    }
    
    REPORT_PHOTOS {
        uuid id PK "照片 ID"
        uuid daily_report_id FK "日報 ID"
        string storage_path "Storage 路徑"
        string caption "照片說明"
        jsonb metadata "EXIF 資料"
        timestamp taken_at "拍攝時間"
    }
    
    WEATHER_CACHE {
        uuid id PK "天氣 ID"
        uuid blueprint_id FK "藍圖 ID"
        date weather_date "日期"
        string condition "天氣狀況"
        decimal temperature "溫度"
        decimal humidity "濕度"
        decimal wind_speed "風速"
        jsonb raw_data "原始 API 資料"
        timestamp cached_at "快取時間"
    }
    
    %% ==================== 品質驗收系統 ====================
    QUALITY_CHECKS ||--o{ QC_PHOTOS : "includes"
    QUALITY_CHECKS ||--o| ISSUES : "may_create"
    QUALITY_CHECKS {
        uuid id PK "驗收 ID"
        uuid task_id FK "任務 ID"
        uuid inspector_id FK "驗收人 ID"
        enum status "pending|inspecting|passed|failed"
        text checklist "檢查項目 (JSON)"
        text findings "發現事項"
        decimal score "評分"
        timestamp inspected_at "驗收時間"
        timestamp created_at "建立時間"
    }
    
    QC_PHOTOS {
        uuid id PK "驗收照片 ID"
        uuid quality_check_id FK "驗收 ID"
        string storage_path "Storage 路徑"
        enum photo_type "before|during|after|defect"
        string caption "照片說明"
        timestamp taken_at "拍攝時間"
    }
    
    %% ==================== 問題追蹤系統 ====================
    ISSUES ||--o{ ISSUE_ASSIGNMENTS : "assigned_to"
    ISSUES ||--o{ ISSUE_PHOTOS : "includes"
    ISSUES ||--o{ COMMENTS : "discusses"
    ISSUES {
        uuid id PK "問題 ID"
        uuid blueprint_id FK "藍圖 ID"
        uuid task_id FK "任務 ID (可選)"
        uuid quality_check_id FK "驗收 ID (可選)"
        uuid reporter_id FK "回報人 ID"
        string title "問題標題"
        text description "問題描述"
        enum severity "low|medium|high|critical"
        enum status "new|assigned|in_progress|resolved|closed|reopened"
        timestamp resolved_at "解決時間"
        timestamp closed_at "關閉時間"
        timestamp created_at "建立時間"
        timestamp updated_at "更新時間"
    }
    
    ISSUE_ASSIGNMENTS }o--|| ACCOUNTS : "assigned_to"
    ISSUE_ASSIGNMENTS {
        uuid id PK "問題指派 ID"
        uuid issue_id FK "問題 ID"
        uuid account_id FK "帳戶 ID"
        enum role "handler|reviewer"
        timestamp assigned_at "指派時間"
    }
    
    ISSUE_PHOTOS {
        uuid id PK "問題照片 ID"
        uuid issue_id FK "問題 ID"
        string storage_path "Storage 路徑"
        string caption "照片說明"
        timestamp taken_at "拍攝時間"
    }
    
    %% ==================== 協作溝通系統 ====================
    COMMENTS }o--|| ACCOUNTS : "posted_by"
    COMMENTS {
        uuid id PK "留言 ID"
        uuid parent_id FK "父留言 ID (可選)"
        uuid task_id FK "任務 ID (可選)"
        uuid issue_id FK "問題 ID (可選)"
        uuid author_id FK "作者 ID"
        text content "留言內容"
        jsonb mentions "提及的用戶"
        timestamp created_at "建立時間"
        timestamp updated_at "更新時間"
    }
    
    NOTIFICATIONS }o--|| ACCOUNTS : "sent_to"
    NOTIFICATIONS {
        uuid id PK "通知 ID"
        uuid recipient_id FK "接收者 ID"
        enum notification_type "task|issue|comment|mention|system"
        string title "通知標題"
        text content "通知內容"
        jsonb metadata "額外資料"
        boolean is_read "是否已讀"
        timestamp read_at "閱讀時間"
        timestamp created_at "建立時間"
    }
    
    TODOS }o--|| ACCOUNTS : "assigned_to"
    TODOS {
        uuid id PK "待辦 ID"
        uuid account_id FK "帳戶 ID"
        uuid task_id FK "關聯任務 (可選)"
        uuid issue_id FK "關聯問題 (可選)"
        string title "待辦標題"
        text description "待辦描述"
        enum priority "low|medium|high"
        boolean is_completed "是否完成"
        timestamp due_date "截止時間"
        timestamp completed_at "完成時間"
        timestamp created_at "建立時間"
    }
    
    %% ==================== 文件管理系統 ====================
    DOCUMENTS {
        uuid id PK "文件 ID"
        uuid blueprint_id FK "藍圖 ID"
        uuid uploader_id FK "上傳者 ID"
        string filename "檔案名稱"
        string storage_path "Storage 路徑"
        enum document_type "drawing|contract|report|photo|other"
        bigint file_size "檔案大小 (bytes)"
        string mime_type "MIME 類型"
        jsonb metadata "文件元資料"
        timestamp uploaded_at "上傳時間"
    }
    
    %% ==================== 進度追蹤系統 ====================
    PROGRESS_TRACKING {
        uuid id PK "進度 ID"
        uuid blueprint_id FK "藍圖 ID"
        date tracking_date "追蹤日期"
        decimal completion_rate "完成率 (%)"
        int total_tasks "總任務數"
        int completed_tasks "已完成任務數"
        int pending_issues "待處理問題數"
        jsonb metrics "其他指標"
        timestamp calculated_at "計算時間"
    }
    
    %% ==================== 活動記錄系統 ====================
    ACTIVITY_LOGS {
        uuid id PK "活動 ID"
        uuid account_id FK "帳戶 ID"
        uuid blueprint_id FK "藍圖 ID (可選)"
        enum entity_type "task|issue|document|comment|etc"
        uuid entity_id "實體 ID"
        enum action "create|update|delete|complete"
        jsonb changes "變更內容"
        string ip_address "IP 位址"
        string user_agent "User Agent"
        timestamp created_at "記錄時間"
    }
    
    %% ==================== 系統設定 ====================
    SETTINGS {
        uuid id PK "設定 ID"
        uuid blueprint_id FK "藍圖 ID (可選)"
        string key UK "設定鍵"
        jsonb value "設定值"
        string description "設定描述"
        timestamp updated_at "更新時間"
    }