# å¯¦é«”é—œä¿‚åœ–ï¼ˆER Diagramï¼‰

> ğŸ“‹ **ç›®çš„**ï¼šå±•ç¤ºè³‡æ–™åº« 51 å¼µè³‡æ–™è¡¨çš„å¯¦é«”é—œä¿‚ï¼ŒåŒ…å« 11 å€‹æ¥­å‹™æ¨¡çµ„çš„å®Œæ•´çµæ§‹

**æœ€å¾Œæ›´æ–°**ï¼š2025-11-15  
**ç¶­è­·è€…**ï¼šé–‹ç™¼åœ˜éšŠ

---

```mermaid
erDiagram
    %% ==================== å¸³æˆ¶èˆ‡èº«ä»½ç³»çµ± ====================
    AUTH_USERS ||--o{ ACCOUNTS : "extends"
    AUTH_USERS {
        uuid id PK "Supabase Auth UUID"
        string email UK "é›»å­éƒµä»¶"
        timestamp created_at "å»ºç«‹æ™‚é–“"
        jsonb raw_user_meta_data "Auth å…ƒè³‡æ–™"
    }
    
    ACCOUNTS ||--o{ BLUEPRINTS : "owns"
    ACCOUNTS ||--o{ TEAMS : "belongs_to"
    ACCOUNTS ||--o{ USER_ROLES : "has"
    ACCOUNTS ||--o{ ACTIVITY_LOGS : "performs"
    ACCOUNTS {
        uuid id PK "å¸³æˆ¶ ID"
        uuid auth_user_id FK "Auth User ID"
        enum account_type "user|bot|organization"
        string display_name "é¡¯ç¤ºåç¨±"
        string avatar_url "é ­åƒ URL (Storage)"
        jsonb metadata "æ“´å±•è³‡æ–™"
        timestamp created_at "å»ºç«‹æ™‚é–“"
        timestamp updated_at "æ›´æ–°æ™‚é–“"
    }
    
    TEAMS ||--o{ TEAM_MEMBERS : "contains"
    TEAMS {
        uuid id PK "åœ˜éšŠ ID"
        uuid organization_id FK "æ‰€å±¬çµ„ç¹”"
        string name "åœ˜éšŠåç¨±"
        string description "åœ˜éšŠæè¿°"
        timestamp created_at "å»ºç«‹æ™‚é–“"
    }
    
    TEAM_MEMBERS }o--|| ACCOUNTS : "is_member"
    TEAM_MEMBERS {
        uuid id PK "æˆå“¡ ID"
        uuid team_id FK "åœ˜éšŠ ID"
        uuid account_id FK "å¸³æˆ¶ ID"
        enum role "admin|member|viewer"
        timestamp joined_at "åŠ å…¥æ™‚é–“"
    }
    
    %% ==================== æ¬Šé™ç³»çµ± ====================
    ROLES ||--o{ USER_ROLES : "assigned_to"
    ROLES ||--o{ ROLE_PERMISSIONS : "has"
    ROLES {
        uuid id PK "è§’è‰² ID"
        string name UK "è§’è‰²åç¨±"
        string description "è§’è‰²æè¿°"
        int priority "å„ªå…ˆç´š"
    }
    
    USER_ROLES }o--|| ACCOUNTS : "belongs_to"
    USER_ROLES }o--|| BLUEPRINTS : "scoped_to"
    USER_ROLES {
        uuid id PK "ç”¨æˆ¶è§’è‰² ID"
        uuid account_id FK "å¸³æˆ¶ ID"
        uuid role_id FK "è§’è‰² ID"
        uuid blueprint_id FK "è—åœ– ID (å¯é¸)"
        timestamp assigned_at "æŒ‡æ´¾æ™‚é–“"
    }
    
    ROLE_PERMISSIONS }o--|| PERMISSIONS : "grants"
    ROLE_PERMISSIONS {
        uuid id PK "è§’è‰²æ¬Šé™ ID"
        uuid role_id FK "è§’è‰² ID"
        uuid permission_id FK "æ¬Šé™ ID"
    }
    
    PERMISSIONS {
        uuid id PK "æ¬Šé™ ID"
        string resource UK "è³‡æºåç¨±"
        string action UK "å‹•ä½œ (read|write|delete)"
        string description "æ¬Šé™æè¿°"
    }
    
    %% ==================== è—åœ–/å°ˆæ¡ˆç³»çµ± ====================
    BLUEPRINTS ||--o{ TASKS : "contains"
    BLUEPRINTS ||--o{ ISSUES : "tracks"
    BLUEPRINTS ||--o{ DOCUMENTS : "stores"
    BLUEPRINTS ||--o{ PROGRESS_TRACKING : "monitors"
    BLUEPRINTS {
        uuid id PK "è—åœ– ID"
        uuid owner_id FK "æ“æœ‰è€… ID"
        string name "å°ˆæ¡ˆåç¨±"
        string description "å°ˆæ¡ˆæè¿°"
        date start_date "é–‹å§‹æ—¥æœŸ"
        date end_date "çµæŸæ—¥æœŸ"
        enum status "planning|active|paused|completed"
        jsonb settings "å°ˆæ¡ˆè¨­å®š"
        timestamp created_at "å»ºç«‹æ™‚é–“"
        timestamp updated_at "æ›´æ–°æ™‚é–“"
    }
    
    %% ==================== Git-like åˆ†æ”¯èˆ‡å”ä½œ ====================
    BLUEPRINTS ||--o{ BRANCH_FORKS : "forked_to"
    BRANCH_FORKS ||--o{ BLUEPRINT_BRANCHES : "spawns"
    BLUEPRINTS ||--o{ ORGANIZATION_COLLABORATIONS : "invites"
    BLUEPRINT_BRANCHES ||--o{ PULL_REQUESTS : "submits"
    PULL_REQUESTS ||--o{ PULL_REQUEST_REVIEWS : "reviewed_by"
    
    BRANCH_FORKS {
        uuid id PK "Fork ID"
        uuid blueprint_id FK "ä¾†æºè—åœ–"
        uuid contractor_org_id FK "æ‰¿æ”¬çµ„ç¹”"
        timestamp forked_at "å»ºç«‹æ™‚é–“"
        text scope "æ‰¿æ”¬ç¯„åœæè¿°"
    }
    
    BLUEPRINT_BRANCHES {
        uuid id PK "åˆ†æ”¯ ID"
        uuid fork_id FK "ä¾†æº Fork"
        uuid organization_id FK "åŸ·è¡Œçµ„ç¹”"
        enum branch_type "org|team|bot"
        enum status "active|frozen|merged|closed"
        timestamp created_at "å»ºç«‹æ™‚é–“"
    }
    
    ORGANIZATION_COLLABORATIONS {
        uuid id PK "å”ä½œé‚€è«‹ ID"
        uuid owner_org_id FK "æ“æœ‰è€…çµ„ç¹”"
        uuid invited_org_id FK "å—é‚€çµ„ç¹”"
        enum status "pending|accepted|rejected|revoked"
        timestamp created_at "å»ºç«‹æ™‚é–“"
        timestamp responded_at "å›è¦†æ™‚é–“"
    }
    
    PULL_REQUESTS {
        uuid id PK "PR ID"
        uuid branch_id FK "ä¾†æºåˆ†æ”¯"
        uuid blueprint_id FK "ç›®æ¨™è—åœ–"
        uuid submitter_id FK "æäº¤è€…"
        enum pr_status "open|reviewing|approved|rejected|merged"
        jsonb payload "æäº¤æ¬„ä½ JSON"
        timestamp submitted_at "æäº¤æ™‚é–“"
        timestamp merged_at "åˆä½µæ™‚é–“"
    }
    
    PULL_REQUEST_REVIEWS {
        uuid id PK "PR Review ID"
        uuid pull_request_id FK "PR ID"
        uuid reviewer_id FK "å¯©æŸ¥è€…"
        enum decision "approved|changes_requested|rejected"
        text comments "å¯©æŸ¥æ„è¦‹"
        timestamp reviewed_at "å¯©æŸ¥æ™‚é–“"
    }
    
    %% ==================== åˆ†æ”¯æ¬Šé™ ====================
    BLUEPRINT_BRANCHES ||--o{ BRANCH_ROLES : "scopes"
    BRANCH_ROLES ||--o{ BRANCH_PERMISSIONS : "grants"
    
    BRANCH_ROLES {
        uuid id PK "åˆ†æ”¯è§’è‰² ID"
        uuid branch_id FK "åˆ†æ”¯ ID"
        string name "è§’è‰²åç¨±"
        text description "æè¿°"
    }
    
    BRANCH_PERMISSIONS {
        uuid id PK "åˆ†æ”¯æ¬Šé™ ID"
        uuid branch_role_id FK "åˆ†æ”¯è§’è‰²"
        uuid permission_id FK "å°æ‡‰æ¬Šé™"
        boolean allow_write "å…è¨±å¯«å…¥æ‰¿æ”¬æ¬„ä½"
    }
    
    %% ==================== ä»»å‹™ç³»çµ± ====================
    TASKS ||--o{ DAILY_REPORTS : "generates"
    TASKS ||--o{ QUALITY_CHECKS : "requires"
    TASKS ||--o{ COMMENTS : "discusses"
    TASKS ||--o{ TASK_ASSIGNMENTS : "assigned_to"
    TASKS ||--o{ STAGING_SUBMISSIONS : "queued_in"
    TASKS {
        uuid id PK "ä»»å‹™ ID"
        uuid blueprint_id FK "è—åœ– ID"
        uuid parent_task_id FK "çˆ¶ä»»å‹™ ID (å¯é¸)"
        string title "ä»»å‹™æ¨™é¡Œ"
        text description "ä»»å‹™æè¿°"
        enum status "pending|assigned|in_progress|completed|cancelled"
        enum priority "low|medium|high|urgent"
        date start_date "é–‹å§‹æ—¥æœŸ"
        date due_date "æˆªæ­¢æ—¥æœŸ"
        decimal estimated_hours "é ä¼°å·¥æ™‚"
        decimal actual_hours "å¯¦éš›å·¥æ™‚"
        timestamp created_at "å»ºç«‹æ™‚é–“"
        timestamp updated_at "æ›´æ–°æ™‚é–“"
    }
    
    TASK_ASSIGNMENTS }o--|| ACCOUNTS : "assigned_to"
    TASK_ASSIGNMENTS {
        uuid id PK "ä»»å‹™æŒ‡æ´¾ ID"
        uuid task_id FK "ä»»å‹™ ID"
        uuid account_id FK "å¸³æˆ¶ ID"
        enum role "owner|assignee|reviewer"
        timestamp assigned_at "æŒ‡æ´¾æ™‚é–“"
    }
    
    STAGING_SUBMISSIONS }o--|| ACCOUNTS : "submitted_by"
    STAGING_SUBMISSIONS {
        uuid id PK "æš«å­˜æäº¤ ID"
        uuid task_id FK "ä»»å‹™ ID"
        uuid submitter_id FK "æäº¤äºº ID"
        enum submission_type "daily_report|quality_check|issue_update"
        jsonb payload "æäº¤å…§å®¹å¿«ç…§"
        timestamp submitted_at "æäº¤æ™‚é–“"
        timestamp expires_at "48h åˆ°æœŸæ™‚é–“"
        boolean recalled "æ˜¯å¦å·²æ’¤å›"
    }
    
    %% ==================== æ¯æ—¥å ±è¡¨ç³»çµ± ====================
    DAILY_REPORTS ||--o{ REPORT_PHOTOS : "includes"
    DAILY_REPORTS }o--|| WEATHER_CACHE : "references"
    DAILY_REPORTS {
        uuid id PK "æ—¥å ± ID"
        uuid task_id FK "ä»»å‹™ ID"
        uuid reporter_id FK "å¡«å ±äºº ID"
        date report_date "å ±è¡¨æ—¥æœŸ"
        text work_summary "å·¥ä½œæ‘˜è¦"
        decimal work_hours "å·¥ä½œæ™‚æ•¸"
        int worker_count "å·¥äººæ•¸é‡"
        text notes "å‚™è¨»"
        timestamp created_at "å»ºç«‹æ™‚é–“"
    }
    
    REPORT_PHOTOS {
        uuid id PK "ç…§ç‰‡ ID"
        uuid daily_report_id FK "æ—¥å ± ID"
        string storage_path "Storage è·¯å¾‘"
        string caption "ç…§ç‰‡èªªæ˜"
        jsonb metadata "EXIF è³‡æ–™"
        timestamp taken_at "æ‹æ”æ™‚é–“"
    }
    
    WEATHER_CACHE {
        uuid id PK "å¤©æ°£ ID"
        uuid blueprint_id FK "è—åœ– ID"
        date weather_date "æ—¥æœŸ"
        string condition "å¤©æ°£ç‹€æ³"
        decimal temperature "æº«åº¦"
        decimal humidity "æ¿•åº¦"
        decimal wind_speed "é¢¨é€Ÿ"
        jsonb raw_data "åŸå§‹ API è³‡æ–™"
        timestamp cached_at "å¿«å–æ™‚é–“"
    }
    
    %% ==================== å“è³ªé©—æ”¶ç³»çµ± ====================
    QUALITY_CHECKS ||--o{ QC_PHOTOS : "includes"
    QUALITY_CHECKS ||--o| ISSUES : "may_create"
    QUALITY_CHECKS {
        uuid id PK "é©—æ”¶ ID"
        uuid task_id FK "ä»»å‹™ ID"
        uuid inspector_id FK "é©—æ”¶äºº ID"
        enum status "pending|inspecting|passed|failed"
        text checklist "æª¢æŸ¥é …ç›® (JSON)"
        text findings "ç™¼ç¾äº‹é …"
        decimal score "è©•åˆ†"
        timestamp inspected_at "é©—æ”¶æ™‚é–“"
        timestamp created_at "å»ºç«‹æ™‚é–“"
    }
    
    QC_PHOTOS {
        uuid id PK "é©—æ”¶ç…§ç‰‡ ID"
        uuid quality_check_id FK "é©—æ”¶ ID"
        string storage_path "Storage è·¯å¾‘"
        enum photo_type "before|during|after|defect"
        string caption "ç…§ç‰‡èªªæ˜"
        timestamp taken_at "æ‹æ”æ™‚é–“"
    }
    
    %% ==================== å•é¡Œè¿½è¹¤ç³»çµ± ====================
    ISSUES ||--o{ ISSUE_ASSIGNMENTS : "assigned_to"
    ISSUES ||--o{ ISSUE_PHOTOS : "includes"
    ISSUES ||--o{ COMMENTS : "discusses"
    ISSUES {
        uuid id PK "å•é¡Œ ID"
        uuid blueprint_id FK "è—åœ– ID"
        uuid task_id FK "ä»»å‹™ ID (å¯é¸)"
        uuid quality_check_id FK "é©—æ”¶ ID (å¯é¸)"
        uuid reporter_id FK "å›å ±äºº ID"
        string title "å•é¡Œæ¨™é¡Œ"
        text description "å•é¡Œæè¿°"
        enum severity "low|medium|high|critical"
        enum status "new|assigned|in_progress|resolved|closed|reopened"
        timestamp resolved_at "è§£æ±ºæ™‚é–“"
        timestamp closed_at "é—œé–‰æ™‚é–“"
        timestamp created_at "å»ºç«‹æ™‚é–“"
        timestamp updated_at "æ›´æ–°æ™‚é–“"
    }
    
    ISSUE_ASSIGNMENTS }o--|| ACCOUNTS : "assigned_to"
    ISSUE_ASSIGNMENTS {
        uuid id PK "å•é¡ŒæŒ‡æ´¾ ID"
        uuid issue_id FK "å•é¡Œ ID"
        uuid account_id FK "å¸³æˆ¶ ID"
        enum role "handler|reviewer"
        timestamp assigned_at "æŒ‡æ´¾æ™‚é–“"
    }
    
    ISSUE_PHOTOS {
        uuid id PK "å•é¡Œç…§ç‰‡ ID"
        uuid issue_id FK "å•é¡Œ ID"
        string storage_path "Storage è·¯å¾‘"
        string caption "ç…§ç‰‡èªªæ˜"
        timestamp taken_at "æ‹æ”æ™‚é–“"
    }
    
    %% ==================== å”ä½œæºé€šç³»çµ± ====================
    COMMENTS }o--|| ACCOUNTS : "posted_by"
    COMMENTS {
        uuid id PK "ç•™è¨€ ID"
        uuid parent_id FK "çˆ¶ç•™è¨€ ID (å¯é¸)"
        uuid task_id FK "ä»»å‹™ ID (å¯é¸)"
        uuid issue_id FK "å•é¡Œ ID (å¯é¸)"
        uuid author_id FK "ä½œè€… ID"
        text content "ç•™è¨€å…§å®¹"
        jsonb mentions "æåŠçš„ç”¨æˆ¶"
        timestamp created_at "å»ºç«‹æ™‚é–“"
        timestamp updated_at "æ›´æ–°æ™‚é–“"
    }
    
    NOTIFICATIONS }o--|| ACCOUNTS : "sent_to"
    NOTIFICATIONS {
        uuid id PK "é€šçŸ¥ ID"
        uuid recipient_id FK "æ¥æ”¶è€… ID"
        enum notification_type "task|issue|comment|mention|system"
        string title "é€šçŸ¥æ¨™é¡Œ"
        text content "é€šçŸ¥å…§å®¹"
        jsonb metadata "é¡å¤–è³‡æ–™"
        boolean is_read "æ˜¯å¦å·²è®€"
        timestamp read_at "é–±è®€æ™‚é–“"
        timestamp created_at "å»ºç«‹æ™‚é–“"
    }
    
    TODOS }o--|| ACCOUNTS : "assigned_to"
    TODOS {
        uuid id PK "å¾…è¾¦ ID"
        uuid account_id FK "å¸³æˆ¶ ID"
        uuid task_id FK "é—œè¯ä»»å‹™ (å¯é¸)"
        uuid issue_id FK "é—œè¯å•é¡Œ (å¯é¸)"
        string title "å¾…è¾¦æ¨™é¡Œ"
        text description "å¾…è¾¦æè¿°"
        enum priority "low|medium|high"
        boolean is_completed "æ˜¯å¦å®Œæˆ"
        timestamp due_date "æˆªæ­¢æ™‚é–“"
        timestamp completed_at "å®Œæˆæ™‚é–“"
        timestamp created_at "å»ºç«‹æ™‚é–“"
    }
    
    %% ==================== æ–‡ä»¶ç®¡ç†ç³»çµ± ====================
    DOCUMENTS {
        uuid id PK "æ–‡ä»¶ ID"
        uuid blueprint_id FK "è—åœ– ID"
        uuid uploader_id FK "ä¸Šå‚³è€… ID"
        string filename "æª”æ¡ˆåç¨±"
        string storage_path "Storage è·¯å¾‘"
        enum document_type "drawing|contract|report|photo|other"
        bigint file_size "æª”æ¡ˆå¤§å° (bytes)"
        string mime_type "MIME é¡å‹"
        jsonb metadata "æ–‡ä»¶å…ƒè³‡æ–™"
        timestamp uploaded_at "ä¸Šå‚³æ™‚é–“"
    }
    
    %% ==================== é€²åº¦è¿½è¹¤ç³»çµ± ====================
    PROGRESS_TRACKING {
        uuid id PK "é€²åº¦ ID"
        uuid blueprint_id FK "è—åœ– ID"
        date tracking_date "è¿½è¹¤æ—¥æœŸ"
        decimal completion_rate "å®Œæˆç‡ (%)"
        int total_tasks "ç¸½ä»»å‹™æ•¸"
        int completed_tasks "å·²å®Œæˆä»»å‹™æ•¸"
        int pending_issues "å¾…è™•ç†å•é¡Œæ•¸"
        jsonb metrics "å…¶ä»–æŒ‡æ¨™"
        timestamp calculated_at "è¨ˆç®—æ™‚é–“"
    }
    
    %% ==================== æ´»å‹•è¨˜éŒ„ç³»çµ± ====================
    ACTIVITY_LOGS {
        uuid id PK "æ´»å‹• ID"
        uuid account_id FK "å¸³æˆ¶ ID"
        uuid blueprint_id FK "è—åœ– ID (å¯é¸)"
        enum entity_type "task|issue|document|comment|etc"
        uuid entity_id "å¯¦é«” ID"
        enum action "create|update|delete|complete"
        jsonb changes "è®Šæ›´å…§å®¹"
        string ip_address "IP ä½å€"
        string user_agent "User Agent"
        timestamp created_at "è¨˜éŒ„æ™‚é–“"
    }
    
    %% ==================== ç³»çµ±è¨­å®š ====================
    SETTINGS {
        uuid id PK "è¨­å®š ID"
        uuid blueprint_id FK "è—åœ– ID (å¯é¸)"
        string key UK "è¨­å®šéµ"
        jsonb value "è¨­å®šå€¼"
        string description "è¨­å®šæè¿°"
        timestamp updated_at "æ›´æ–°æ™‚é–“"
    }