# æ¢ç´¢åŠŸèƒ½ä¼ä¸šçº§éšç§æƒæ§åˆ¶æ–¹æ¡ˆ

> **æ—¥æœŸ**ï¼š2025-01-20  
> **ç›®çš„**ï¼šè®¾è®¡ç¬¦åˆä¼ä¸šçº§æ ‡å‡†çš„éšç§æƒæ§åˆ¶æ–¹æ¡ˆï¼Œæ”¯æŒåˆè§„æ€§ã€å®¡è®¡ã€æ•°æ®åˆ†ç±»å’Œç»†ç²’åº¦è®¿é—®æ§åˆ¶  
> **çŠ¶æ€**ï¼šğŸ“‹ ä¼ä¸šçº§è®¾è®¡æ–¹æ¡ˆ  
> **æ ‡å‡†å‚è€ƒ**ï¼šISO 27001, GDPR, CCPA, NIST Privacy Framework

---

## ğŸ¯ ä¼ä¸šçº§è®¾è®¡ç›®æ ‡

### 1. åˆè§„æ€§è¦æ±‚

- âœ… **GDPR åˆè§„**ï¼šæ•°æ®æœ€å°åŒ–ã€ç”¨æˆ·åŒæ„ã€æ•°æ®å¯æºå¸¦æ€§ã€è¢«é—å¿˜æƒ
- âœ… **CCPA åˆè§„**ï¼šæ•°æ®é€æ˜åº¦ã€ç”¨æˆ·æƒåˆ©ã€æ•°æ®åˆ é™¤
- âœ… **ISO 27001**ï¼šä¿¡æ¯å®‰å…¨ç®¡ç†ä½“ç³»
- âœ… **SOC 2**ï¼šå®‰å…¨ã€å¯ç”¨æ€§ã€å¤„ç†å®Œæ•´æ€§ã€ä¿å¯†æ€§ã€éšç§æ€§

### 2. å®‰å…¨è¦æ±‚

- âœ… **é›¶ä¿¡ä»»æ¨¡å‹**ï¼šä»ä¸ä¿¡ä»»ï¼Œæ€»æ˜¯éªŒè¯
- âœ… **æœ€å°æƒé™åŸåˆ™**ï¼šåªæˆäºˆå¿…è¦çš„æƒé™
- âœ… **èŒè´£åˆ†ç¦»**ï¼šå…³é”®æ“ä½œéœ€è¦å¤šäººæˆæƒ
- âœ… **å®¡è®¡è¿½è¸ª**ï¼šæ‰€æœ‰è®¿é—®å’Œæ“ä½œéƒ½æœ‰å®Œæ•´è®°å½•

### 3. æ•°æ®ä¿æŠ¤è¦æ±‚

- âœ… **æ•°æ®åˆ†ç±»**ï¼šå…¬å¼€ã€å†…éƒ¨ã€æœºå¯†ã€å—é™
- âœ… **æ•°æ®è„±æ•**ï¼šæ•æ„Ÿæ•°æ®è‡ªåŠ¨è„±æ•
- âœ… **åŠ å¯†ä¼ è¾“**ï¼šTLS 1.3
- âœ… **åŠ å¯†å­˜å‚¨**ï¼šæ•æ„Ÿå­—æ®µåŠ å¯†å­˜å‚¨

---

## ğŸ—ï¸ ä¼ä¸šçº§æ¶æ„è®¾è®¡

### ä¸‰å±‚éšç§æ§åˆ¶æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ä¸€å±‚ï¼šæ•°æ®åˆ†ç±» (Data Classification)                  â”‚
â”‚  - Public: å…¬å¼€æ•°æ®                                      â”‚
â”‚  - Internal: å†…éƒ¨æ•°æ®                                    â”‚
â”‚  - Confidential: æœºå¯†æ•°æ®                                â”‚
â”‚  - Restricted: å—é™æ•°æ®                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬äºŒå±‚ï¼šè®¿é—®æ§åˆ¶ (Access Control)                       â”‚
â”‚  - RBAC: åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶                              â”‚
â”‚  - ABAC: åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶                              â”‚
â”‚  - å…³ç³»æ„ŸçŸ¥: åŸºäºç”¨æˆ·å…³ç³»çš„æƒé™åˆ¤æ–­                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ä¸‰å±‚ï¼šå­—æ®µçº§åˆ«æ§åˆ¶ (Field-level Control)              â”‚
â”‚  - åŸºæœ¬ä¿¡æ¯å¯è§æ€§                                        â”‚
â”‚  - è”ç³»ä¿¡æ¯å¯è§æ€§                                        â”‚
â”‚  - è¯¦ç»†ä¿¡æ¯å¯è§æ€§                                        â”‚
â”‚  - å…ƒæ•°æ®å¯è§æ€§                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### 1. æ•°æ®åˆ†ç±»æšä¸¾

```typescript
/**
 * æ•°æ®åˆ†ç±»çº§åˆ«ï¼ˆä¼ä¸šçº§æ ‡å‡†ï¼‰
 * å‚è€ƒï¼šISO 27001, NIST Privacy Framework
 */
export enum DataClassification {
  /** å…¬å¼€ï¼šæ— é™åˆ¶è®¿é—® */
  PUBLIC = 'public',
  
  /** å†…éƒ¨ï¼šç»„ç»‡å†…éƒ¨æˆå‘˜å¯è§ */
  INTERNAL = 'internal',
  
  /** æœºå¯†ï¼šéœ€è¦ç‰¹æ®Šæˆæƒ */
  CONFIDENTIAL = 'confidential',
  
  /** å—é™ï¼šæœ€é«˜çº§åˆ«ä¿æŠ¤ */
  RESTRICTED = 'restricted'
}

/**
 * å¯è§æ€§çº§åˆ«æšä¸¾ï¼ˆç”¨æˆ·å¯é…ç½®ï¼‰
 */
export enum VisibilityLevel {
  /** å…¬å¼€ï¼šæ‰€æœ‰äººå¯è§ï¼ˆåŒ…æ‹¬æœªç™»å½•ç”¨æˆ·ï¼‰ */
  PUBLIC = 'public',
  
  /** å·²è®¤è¯ç”¨æˆ·ï¼šæ‰€æœ‰å·²ç™»å½•ç”¨æˆ·å¯è§ */
  AUTHENTICATED = 'authenticated',
  
  /** ç»„ç»‡æˆå‘˜ï¼šåŒä¸€ç»„ç»‡çš„æˆå‘˜å¯è§ */
  ORGANIZATION = 'organization',
  
  /** åä½œæˆå‘˜ï¼šæœ‰åä½œå…³ç³»çš„æˆå‘˜å¯è§ */
  COLLABORATOR = 'collaborator',
  
  /** ç§æœ‰ï¼šä»…è‡ªå·±å¯è§ */
  PRIVATE = 'private'
}
```

### 2. æ•°æ®åº“å­—æ®µè®¾è®¡

#### accounts è¡¨æ·»åŠ ä¼ä¸šçº§éšç§å­—æ®µ

```sql
-- æ·»åŠ ä¼ä¸šçº§éšç§æ§åˆ¶å­—æ®µ
ALTER TABLE accounts ADD COLUMN IF NOT EXISTS 
  -- æ•°æ®åˆ†ç±»ï¼ˆç³»ç»Ÿçº§ï¼Œä¸å¯ç”±ç”¨æˆ·ä¿®æ”¹ï¼‰
  data_classification VARCHAR(20) DEFAULT 'internal'
    CHECK (data_classification IN ('public', 'internal', 'confidential', 'restricted')),
  
  -- æœç´¢å¯è§æ€§ï¼ˆç”¨æˆ·å¯é…ç½®ï¼‰
  search_visibility VARCHAR(20) DEFAULT 'authenticated'
    CHECK (search_visibility IN ('public', 'authenticated', 'organization', 'collaborator', 'private')),
  
  -- åŸºæœ¬ä¿¡æ¯å¯è§æ€§ï¼ˆåç§°ã€å¤´åƒç­‰ï¼‰
  profile_visibility VARCHAR(20) DEFAULT 'authenticated'
    CHECK (profile_visibility IN ('public', 'authenticated', 'organization', 'collaborator', 'private')),
  
  -- è”ç³»ä¿¡æ¯å¯è§æ€§ï¼ˆé‚®ç®±ã€ç”µè¯ç­‰ï¼‰
  contact_visibility VARCHAR(20) DEFAULT 'organization'
    CHECK (contact_visibility IN ('public', 'authenticated', 'organization', 'collaborator', 'private')),
  
  -- è¯¦ç»†ä¿¡æ¯å¯è§æ€§ï¼ˆæè¿°ã€å…ƒæ•°æ®ç­‰ï¼‰
  detail_visibility VARCHAR(20) DEFAULT 'organization'
    CHECK (detail_visibility IN ('public', 'authenticated', 'organization', 'collaborator', 'private')),
  
  -- éšç§è®¾ç½®æœ€åæ›´æ–°æ—¶é—´ï¼ˆç”¨äºå®¡è®¡ï¼‰
  privacy_settings_updated_at TIMESTAMPTZ,
  
  -- éšç§è®¾ç½®æ›´æ–°è€…ï¼ˆç”¨äºå®¡è®¡ï¼‰
  privacy_settings_updated_by UUID REFERENCES accounts(id),
  
  -- ç”¨æˆ·åŒæ„çŠ¶æ€ï¼ˆGDPR åˆè§„ï¼‰
  privacy_consent_given BOOLEAN DEFAULT FALSE,
  privacy_consent_given_at TIMESTAMPTZ,
  privacy_consent_version VARCHAR(20),  -- éšç§æ”¿ç­–ç‰ˆæœ¬å·
  
  -- æ•°æ®ä¿ç•™ç­–ç•¥
  data_retention_policy VARCHAR(50) DEFAULT 'standard',  -- standard, extended, permanent
  data_retention_until TIMESTAMPTZ;  -- æ•°æ®ä¿ç•™åˆ°æœŸæ—¶é—´

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_accounts_data_classification 
  ON accounts(data_classification);
CREATE INDEX IF NOT EXISTS idx_accounts_search_visibility 
  ON accounts(search_visibility) 
  WHERE search_visibility != 'private';
CREATE INDEX IF NOT EXISTS idx_accounts_privacy_consent 
  ON accounts(privacy_consent_given, privacy_consent_given_at);
```

#### blueprints è¡¨æ·»åŠ ä¼ä¸šçº§éšç§å­—æ®µ

```sql
-- æ·»åŠ ä¼ä¸šçº§éšç§æ§åˆ¶å­—æ®µ
ALTER TABLE blueprints ADD COLUMN IF NOT EXISTS 
  -- æ•°æ®åˆ†ç±»ï¼ˆç³»ç»Ÿçº§ï¼Œä¸å¯ç”±ç”¨æˆ·ä¿®æ”¹ï¼‰
  data_classification VARCHAR(20) DEFAULT 'internal'
    CHECK (data_classification IN ('public', 'internal', 'confidential', 'restricted')),
  
  -- æœç´¢å¯è§æ€§ï¼ˆç”¨æˆ·å¯é…ç½®ï¼‰
  search_visibility VARCHAR(20) DEFAULT 'organization'
    CHECK (search_visibility IN ('public', 'authenticated', 'organization', 'collaborator', 'private')),
  
  -- åŸºæœ¬ä¿¡æ¯å¯è§æ€§ï¼ˆåç§°ã€æè¿°ç­‰ï¼‰
  profile_visibility VARCHAR(20) DEFAULT 'organization'
    CHECK (profile_visibility IN ('public', 'authenticated', 'organization', 'collaborator', 'private')),
  
  -- è¯¦ç»†ä¿¡æ¯å¯è§æ€§ï¼ˆé¡¹ç›®ä»£ç ã€å…ƒæ•°æ®ç­‰ï¼‰
  detail_visibility VARCHAR(20) DEFAULT 'collaborator'
    CHECK (detail_visibility IN ('public', 'authenticated', 'organization', 'collaborator', 'private')),
  
  -- éšç§è®¾ç½®æœ€åæ›´æ–°æ—¶é—´
  privacy_settings_updated_at TIMESTAMPTZ,
  
  -- éšç§è®¾ç½®æ›´æ–°è€…
  privacy_settings_updated_by UUID REFERENCES accounts(id),
  
  -- æ•°æ®ä¿ç•™ç­–ç•¥
  data_retention_policy VARCHAR(50) DEFAULT 'standard',
  data_retention_until TIMESTAMPTZ;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_blueprints_data_classification 
  ON blueprints(data_classification);
CREATE INDEX IF NOT EXISTS idx_blueprints_search_visibility 
  ON blueprints(search_visibility) 
  WHERE search_visibility != 'private';
```

### 3. éšç§è®¿é—®å®¡è®¡è¡¨

```sql
-- éšç§è®¿é—®å®¡è®¡è¡¨ï¼ˆè®°å½•æ‰€æœ‰éšç§æ•°æ®è®¿é—®ï¼‰
CREATE TABLE IF NOT EXISTS privacy_access_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- è®¿é—®è€…ä¿¡æ¯
  viewer_account_id UUID NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
  viewer_auth_user_id UUID REFERENCES auth.users(id),
  
  -- è¢«è®¿é—®çš„èµ„æº
  resource_type VARCHAR(50) NOT NULL CHECK (resource_type IN ('account', 'blueprint')),
  resource_id UUID NOT NULL,
  
  -- è®¿é—®çš„å­—æ®µç±»å‹
  accessed_field_type VARCHAR(50) NOT NULL CHECK (
    accessed_field_type IN ('search', 'profile', 'contact', 'detail', 'metadata')
  ),
  
  -- è®¿é—®æ–¹å¼
  access_method VARCHAR(50) NOT NULL CHECK (
    access_method IN ('search', 'view', 'api', 'export')
  ),
  
  -- è®¿é—®ç»“æœ
  access_granted BOOLEAN NOT NULL,
  access_denied_reason TEXT,
  
  -- æ•°æ®åˆ†ç±»
  data_classification VARCHAR(20),
  
  -- å®¡è®¡ä¿¡æ¯
  ip_address INET,
  user_agent TEXT,
  request_id UUID,  -- ç”¨äºè¿½è¸ªå®Œæ•´è¯·æ±‚é“¾è·¯
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- åˆè§„æ€§å­—æ®µ
  gdpr_legal_basis VARCHAR(50),  -- GDPR æ³•å¾‹ä¾æ®
  consent_required BOOLEAN DEFAULT FALSE,
  consent_given BOOLEAN
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_privacy_access_logs_viewer ON privacy_access_logs(viewer_account_id, created_at);
CREATE INDEX idx_privacy_access_logs_resource ON privacy_access_logs(resource_type, resource_id, created_at);
CREATE INDEX idx_privacy_access_logs_created ON privacy_access_logs(created_at);
CREATE INDEX idx_privacy_access_logs_granted ON privacy_access_logs(access_granted, created_at);

-- åˆ†åŒºè¡¨ï¼ˆæŒ‰æœˆåˆ†åŒºï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½ï¼‰
-- æ³¨æ„ï¼šPostgreSQL 12+ æ”¯æŒè‡ªåŠ¨åˆ†åŒº
```

### 4. æ•°æ®åˆ†ç±»ç­–ç•¥è¡¨

```sql
-- æ•°æ®åˆ†ç±»ç­–ç•¥è¡¨ï¼ˆå®šä¹‰ä¸åŒç±»å‹æ•°æ®çš„é»˜è®¤åˆ†ç±»ï¼‰
CREATE TABLE IF NOT EXISTS data_classification_policies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- èµ„æºç±»å‹
  resource_type VARCHAR(50) NOT NULL CHECK (resource_type IN ('account', 'blueprint')),
  
  -- è´¦æˆ·ç±»å‹ï¼ˆå¦‚æœæ˜¯ accountï¼‰
  account_type VARCHAR(20) CHECK (account_type IN ('User', 'Organization', 'Bot')),
  
  -- é»˜è®¤æ•°æ®åˆ†ç±»
  default_classification VARCHAR(20) NOT NULL
    CHECK (default_classification IN ('public', 'internal', 'confidential', 'restricted')),
  
  -- å…è®¸çš„å¯è§æ€§çº§åˆ«ï¼ˆåŸºäºæ•°æ®åˆ†ç±»ï¼‰
  allowed_visibility_levels VARCHAR(20)[] NOT NULL,
  
  -- ç­–ç•¥æè¿°
  description TEXT,
  
  -- æ˜¯å¦å¯ç”¨
  is_active BOOLEAN DEFAULT TRUE,
  
  -- åˆ›å»ºä¿¡æ¯
  created_by UUID REFERENCES accounts(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(resource_type, account_type)
);

-- æ’å…¥é»˜è®¤ç­–ç•¥
INSERT INTO data_classification_policies (resource_type, account_type, default_classification, allowed_visibility_levels, description) VALUES
('account', 'User', 'internal', ARRAY['public', 'authenticated', 'organization', 'collaborator', 'private'], 'ç”¨æˆ·è´¦æˆ·é»˜è®¤åˆ†ç±»ï¼šå†…éƒ¨æ•°æ®'),
('account', 'Organization', 'internal', ARRAY['public', 'authenticated', 'organization', 'collaborator', 'private'], 'ç»„ç»‡è´¦æˆ·é»˜è®¤åˆ†ç±»ï¼šå†…éƒ¨æ•°æ®'),
('account', 'Bot', 'confidential', ARRAY['organization', 'collaborator', 'private'], 'Bot è´¦æˆ·é»˜è®¤åˆ†ç±»ï¼šæœºå¯†æ•°æ®'),
('blueprint', NULL, 'internal', ARRAY['public', 'authenticated', 'organization', 'collaborator', 'private'], 'è“å›¾é»˜è®¤åˆ†ç±»ï¼šå†…éƒ¨æ•°æ®');
```

---

## ğŸ”’ ä¼ä¸šçº§æƒé™åˆ¤æ–­é€»è¾‘

### 1. ä¼ä¸šçº§å¯è§æ€§åˆ¤æ–­å‡½æ•°

```sql
-- åˆ›å»ºä¼ä¸šçº§å¯è§æ€§åˆ¤æ–­å‡½æ•°ï¼ˆåŒ…å«æ•°æ®åˆ†ç±»å’Œå®¡è®¡ï¼‰
CREATE OR REPLACE FUNCTION private.can_view_account_enterprise(
  target_account_id UUID,
  viewer_auth_user_id UUID,
  visibility_level VARCHAR(20),
  field_type VARCHAR(50) DEFAULT 'profile',
  access_method VARCHAR(50) DEFAULT 'view',
  request_id UUID DEFAULT NULL
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = ''
AS $$
DECLARE
  target_account RECORD;
  viewer_account_id UUID;
  can_view BOOLEAN := FALSE;
  data_classification VARCHAR(20);
  access_reason TEXT;
BEGIN
  -- è·å–ç›®æ ‡è´¦æˆ·ä¿¡æ¯
  SELECT * INTO target_account
  FROM public.accounts
  WHERE id = target_account_id;
  
  IF NOT FOUND THEN
    -- è®°å½•è®¿é—®å¤±è´¥ï¼ˆèµ„æºä¸å­˜åœ¨ï¼‰
    PERFORM private.log_privacy_access(
      viewer_auth_user_id,
      'account',
      target_account_id,
      field_type,
      access_method,
      FALSE,
      'Resource not found',
      NULL,
      request_id
    );
    RETURN FALSE;
  END IF;
  
  -- è·å–æŸ¥çœ‹è€…è´¦æˆ· ID
  SELECT id INTO viewer_account_id
  FROM public.accounts
  WHERE auth_user_id = viewer_auth_user_id;
  
  -- å¦‚æœæ˜¯è‡ªå·±ï¼Œæ€»æ˜¯å¯è§
  IF viewer_account_id = target_account_id THEN
    can_view := TRUE;
    access_reason := 'Self access';
  ELSE
    -- æ£€æŸ¥æ•°æ®åˆ†ç±»é™åˆ¶
    data_classification := target_account.data_classification;
    
    -- æ ¹æ®æ•°æ®åˆ†ç±»å’Œå¯è§æ€§çº§åˆ«åˆ¤æ–­
    CASE 
      WHEN data_classification = 'restricted' THEN
        -- å—é™æ•°æ®ï¼šåªæœ‰æ‹¥æœ‰è€…å’Œç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥è®¿é—®
        can_view := (viewer_account_id = target_account_id);
        access_reason := 'Restricted data - owner only';
        
      WHEN data_classification = 'confidential' THEN
        -- æœºå¯†æ•°æ®ï¼šéœ€è¦ç»„ç»‡æˆå‘˜æˆ–åä½œå…³ç³»
        can_view := (
          visibility_level IN ('organization', 'collaborator')
          AND private.has_organization_access(target_account_id, viewer_account_id)
        );
        access_reason := 'Confidential data - organization/collaborator access';
        
      WHEN data_classification = 'internal' THEN
        -- å†…éƒ¨æ•°æ®ï¼šæ ¹æ®å¯è§æ€§çº§åˆ«åˆ¤æ–­
        can_view := private.check_visibility_level(
          target_account_id,
          viewer_account_id,
          visibility_level
        );
        access_reason := 'Internal data - visibility level check';
        
      WHEN data_classification = 'public' THEN
        -- å…¬å¼€æ•°æ®ï¼šæ ¹æ®å¯è§æ€§çº§åˆ«åˆ¤æ–­ï¼ˆæ›´å®½æ¾ï¼‰
        can_view := private.check_visibility_level(
          target_account_id,
          viewer_account_id,
          visibility_level
        );
        access_reason := 'Public data - visibility level check';
        
      ELSE
        can_view := FALSE;
        access_reason := 'Unknown data classification';
    END CASE;
  END IF;
  
  -- è®°å½•è®¿é—®å®¡è®¡æ—¥å¿—
  PERFORM private.log_privacy_access(
    viewer_auth_user_id,
    'account',
    target_account_id,
    field_type,
    access_method,
    can_view,
    CASE WHEN can_view THEN access_reason ELSE 'Access denied' END,
    data_classification,
    request_id
  );
  
  RETURN can_view;
END;
$$;
```

### 2. éšç§è®¿é—®æ—¥å¿—è®°å½•å‡½æ•°

```sql
-- åˆ›å»ºéšç§è®¿é—®æ—¥å¿—è®°å½•å‡½æ•°
CREATE OR REPLACE FUNCTION private.log_privacy_access(
  p_viewer_auth_user_id UUID,
  p_resource_type VARCHAR(50),
  p_resource_id UUID,
  p_accessed_field_type VARCHAR(50),
  p_access_method VARCHAR(50),
  p_access_granted BOOLEAN,
  p_access_denied_reason TEXT,
  p_data_classification VARCHAR(20),
  p_request_id UUID
)
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = ''
AS $$
DECLARE
  v_viewer_account_id UUID;
  v_ip_address INET;
  v_user_agent TEXT;
BEGIN
  -- è·å–æŸ¥çœ‹è€…è´¦æˆ· ID
  SELECT id INTO v_viewer_account_id
  FROM public.accounts
  WHERE auth_user_id = p_viewer_auth_user_id;
  
  -- è·å– IP åœ°å€å’Œ User Agentï¼ˆä»å½“å‰ä¼šè¯ï¼‰
  -- æ³¨æ„ï¼šè¿™éœ€è¦ä»åº”ç”¨å±‚ä¼ é€’ï¼Œæˆ–ä½¿ç”¨ PostgreSQL æ‰©å±•
  
  -- æ’å…¥å®¡è®¡æ—¥å¿—
  INSERT INTO public.privacy_access_logs (
    viewer_account_id,
    viewer_auth_user_id,
    resource_type,
    resource_id,
    accessed_field_type,
    access_method,
    access_granted,
    access_denied_reason,
    data_classification,
    request_id,
    created_at
  ) VALUES (
    v_viewer_account_id,
    p_viewer_auth_user_id,
    p_resource_type,
    p_resource_id,
    p_accessed_field_type,
    p_access_method,
    p_access_granted,
    p_access_denied_reason,
    p_data_classification,
    p_request_id,
    NOW()
  );
END;
$$;
```

### 3. æ•°æ®åˆ†ç±»æ£€æŸ¥å‡½æ•°

```sql
-- åˆ›å»ºæ•°æ®åˆ†ç±»æ£€æŸ¥å‡½æ•°ï¼ˆç¡®ä¿ç”¨æˆ·è®¾ç½®çš„å¯è§æ€§çº§åˆ«ç¬¦åˆæ•°æ®åˆ†ç±»ç­–ç•¥ï¼‰
CREATE OR REPLACE FUNCTION private.validate_visibility_against_classification(
  p_resource_type VARCHAR(50),
  p_account_type VARCHAR(20),
  p_data_classification VARCHAR(20),
  p_visibility_level VARCHAR(20)
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = ''
AS $$
DECLARE
  v_allowed_levels VARCHAR(20)[];
BEGIN
  -- è·å–å…è®¸çš„å¯è§æ€§çº§åˆ«
  SELECT allowed_visibility_levels INTO v_allowed_levels
  FROM public.data_classification_policies
  WHERE resource_type = p_resource_type
    AND (account_type = p_account_type OR account_type IS NULL)
    AND is_active = TRUE
  LIMIT 1;
  
  -- å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç­–ç•¥ï¼Œä½¿ç”¨é»˜è®¤ç­–ç•¥
  IF v_allowed_levels IS NULL THEN
    -- æ ¹æ®æ•°æ®åˆ†ç±»è¿”å›é»˜è®¤å…è®¸çš„çº§åˆ«
    CASE p_data_classification
      WHEN 'public' THEN
        RETURN p_visibility_level = ANY(ARRAY['public', 'authenticated', 'organization', 'collaborator', 'private']);
      WHEN 'internal' THEN
        RETURN p_visibility_level = ANY(ARRAY['authenticated', 'organization', 'collaborator', 'private']);
      WHEN 'confidential' THEN
        RETURN p_visibility_level = ANY(ARRAY['organization', 'collaborator', 'private']);
      WHEN 'restricted' THEN
        RETURN p_visibility_level = 'private';
      ELSE
        RETURN FALSE;
    END CASE;
  END IF;
  
  -- æ£€æŸ¥å¯è§æ€§çº§åˆ«æ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­
  RETURN p_visibility_level = ANY(v_allowed_levels);
END;
$$;
```

---

## ğŸ” ä¼ä¸šçº§æœç´¢å‡½æ•°

### æ›´æ–°æœç´¢è´¦æˆ·å‡½æ•°ï¼ˆä¼ä¸šçº§ï¼‰

```sql
-- æ›´æ–°æœç´¢è´¦æˆ·å‡½æ•°ï¼Œæ·»åŠ ä¼ä¸šçº§éšç§æ§åˆ¶å’Œå®¡è®¡
CREATE OR REPLACE FUNCTION public.search_accounts_for_explore(
  p_query TEXT,
  p_type TEXT DEFAULT NULL,
  p_page INTEGER DEFAULT 1,
  p_page_size INTEGER DEFAULT 20,
  p_order_by TEXT DEFAULT 'name',
  p_order_direction TEXT DEFAULT 'asc',
  p_viewer_auth_user_id UUID DEFAULT NULL,
  p_request_id UUID DEFAULT NULL  -- æ–°å¢ï¼šè¯·æ±‚ IDï¼ˆç”¨äºå®¡è®¡è¿½è¸ªï¼‰
)
RETURNS TABLE (
  id UUID,
  name VARCHAR,
  email VARCHAR,
  type VARCHAR,
  status VARCHAR,
  auth_user_id UUID,
  auth_organization_id UUID,
  auth_bot_id UUID,
  avatar_url TEXT,
  metadata JSONB,
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ,
  -- æ–°å¢ï¼šæ•°æ®åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
  data_classification VARCHAR(20)
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = ''
AS $$
DECLARE
  v_offset INTEGER;
  v_limit INTEGER;
  v_viewer_account_id UUID;
BEGIN
  v_offset := (p_page - 1) * p_page_size;
  v_limit := p_page_size;
  
  -- è·å–æŸ¥çœ‹è€…è´¦æˆ· ID
  IF p_viewer_auth_user_id IS NOT NULL THEN
    SELECT id INTO v_viewer_account_id
    FROM public.accounts
    WHERE auth_user_id = p_viewer_auth_user_id;
  END IF;

  RETURN QUERY
  SELECT 
    a.id,
    a.name,
    -- æ ¹æ® contact_visibility å’Œæ•°æ®åˆ†ç±»å†³å®šæ˜¯å¦è¿”å›é‚®ç®±
    CASE 
      WHEN private.can_view_account_enterprise(
        a.id, 
        p_viewer_auth_user_id, 
        a.contact_visibility,
        'contact',
        'search',
        p_request_id
      )
      THEN a.email
      ELSE NULL
    END as email,
    a.type,
    a.status,
    a.auth_user_id,
    a.auth_organization_id,
    a.auth_bot_id,
    -- æ ¹æ® profile_visibility å’Œæ•°æ®åˆ†ç±»å†³å®šæ˜¯å¦è¿”å›å¤´åƒ
    CASE 
      WHEN private.can_view_account_enterprise(
        a.id, 
        p_viewer_auth_user_id, 
        a.profile_visibility,
        'profile',
        'search',
        p_request_id
      )
      THEN a.avatar_url::TEXT
      ELSE NULL
    END as avatar_url,
    -- æ ¹æ® detail_visibility å’Œæ•°æ®åˆ†ç±»å†³å®šæ˜¯å¦è¿”å›å…ƒæ•°æ®
    CASE 
      WHEN private.can_view_account_enterprise(
        a.id, 
        p_viewer_auth_user_id, 
        a.detail_visibility,
        'detail',
        'search',
        p_request_id
      )
      THEN a.metadata
      ELSE '{}'::JSONB
    END as metadata,
    a.created_at,
    a.updated_at,
    -- è¿”å›æ•°æ®åˆ†ç±»ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºæ•°æ®æ ‡ç­¾ï¼‰
    a.data_classification
  FROM public.accounts a
  WHERE 
    a.status = 'active'
    AND (p_type IS NULL OR a.type = p_type)
    -- æœç´¢ç”¨æˆ·æ—¶ï¼Œé™åˆ¶ auth_user_id IS NOT NULL
    AND (
      p_type IS NULL 
      OR p_type != 'User' 
      OR a.auth_user_id IS NOT NULL
    )
    -- ä¼ä¸šçº§éšç§æ§åˆ¶ï¼šåªè¿”å›å¯è§çš„è´¦æˆ·ï¼ˆåŸºäºæ•°æ®åˆ†ç±»å’Œå¯è§æ€§çº§åˆ«ï¼‰
    AND (
      -- å…¬å¼€æ•°æ®ï¼šæ‰€æœ‰äººå¯è§
      (a.data_classification = 'public' AND a.search_visibility = 'public')
      OR
      -- å†…éƒ¨æ•°æ®ï¼šæ ¹æ®å¯è§æ€§çº§åˆ«åˆ¤æ–­
      (a.data_classification = 'internal' AND private.can_view_account_enterprise(
        a.id, 
        p_viewer_auth_user_id, 
        a.search_visibility,
        'search',
        'search',
        p_request_id
      ))
      OR
      -- æœºå¯†æ•°æ®ï¼šéœ€è¦ç»„ç»‡æˆå‘˜æˆ–åä½œå…³ç³»
      (a.data_classification = 'confidential' AND a.search_visibility IN ('organization', 'collaborator') 
       AND private.can_view_account_enterprise(
         a.id, 
         p_viewer_auth_user_id, 
         a.search_visibility,
         'search',
         'search',
         p_request_id
       ))
      OR
      -- å—é™æ•°æ®ï¼šåªæœ‰æ‹¥æœ‰è€…å¯ä»¥æœç´¢åˆ°
      (a.data_classification = 'restricted' AND v_viewer_account_id = a.id)
    )
    -- æœç´¢æ¡ä»¶
    AND (
      p_query IS NULL 
      OR p_query = ''
      OR a.name ILIKE '%' || p_query || '%'
      OR (
        private.can_view_account_enterprise(
          a.id, 
          p_viewer_auth_user_id, 
          a.contact_visibility,
          'contact',
          'search',
          p_request_id
        )
        AND a.email ILIKE '%' || p_query || '%'
      )
    )
  ORDER BY 
    CASE 
      WHEN p_order_by = 'name' AND p_order_direction = 'asc' THEN a.name
      WHEN p_order_by = 'name' AND p_order_direction = 'desc' THEN a.name
      WHEN p_order_by = 'created_at' AND p_order_direction = 'asc' THEN a.created_at::TEXT
      WHEN p_order_by = 'created_at' AND p_order_direction = 'desc' THEN a.created_at::TEXT
      ELSE a.name
    END
  LIMIT v_limit
  OFFSET v_offset;
END;
$$;
```

---

## ğŸ“‹ åˆè§„æ€§åŠŸèƒ½

### 1. GDPR åˆè§„åŠŸèƒ½

#### æ•°æ®å¯æºå¸¦æ€§ï¼ˆData Portabilityï¼‰

```sql
-- åˆ›å»ºæ•°æ®å¯¼å‡ºå‡½æ•°ï¼ˆGDPR åˆè§„ï¼‰
CREATE OR REPLACE FUNCTION public.export_user_data(
  p_user_auth_id UUID
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = ''
AS $$
DECLARE
  v_user_account_id UUID;
  v_export_data JSONB;
BEGIN
  -- è·å–ç”¨æˆ·è´¦æˆ· ID
  SELECT id INTO v_user_account_id
  FROM public.accounts
  WHERE auth_user_id = p_user_auth_id;
  
  IF NOT FOUND THEN
    RETURN '{}'::JSONB;
  END IF;
  
  -- å¯¼å‡ºç”¨æˆ·æ•°æ®
  SELECT jsonb_build_object(
    'account', (SELECT row_to_json(a.*) FROM accounts a WHERE a.id = v_user_account_id),
    'privacy_settings', (
      SELECT jsonb_build_object(
        'search_visibility', search_visibility,
        'profile_visibility', profile_visibility,
        'contact_visibility', contact_visibility,
        'detail_visibility', detail_visibility,
        'privacy_consent_given', privacy_consent_given,
        'privacy_consent_given_at', privacy_consent_given_at
      )
      FROM accounts
      WHERE id = v_user_account_id
    ),
    'access_logs', (
      SELECT jsonb_agg(row_to_json(log.*))
      FROM privacy_access_logs log
      WHERE log.resource_type = 'account'
        AND log.resource_id = v_user_account_id
        AND log.created_at >= NOW() - INTERVAL '1 year'
    )
  ) INTO v_export_data;
  
  -- è®°å½•å¯¼å‡ºæ“ä½œ
  PERFORM private.log_privacy_access(
    p_user_auth_id,
    'account',
    v_user_account_id,
    'metadata',
    'export',
    TRUE,
    'GDPR data export',
    NULL,
    NULL
  );
  
  RETURN v_export_data;
END;
$$;
```

#### è¢«é—å¿˜æƒï¼ˆRight to be Forgottenï¼‰

```sql
-- åˆ›å»ºæ•°æ®åˆ é™¤å‡½æ•°ï¼ˆGDPR åˆè§„ï¼‰
CREATE OR REPLACE FUNCTION public.delete_user_data(
  p_user_auth_id UUID,
  p_retention_period INTERVAL DEFAULT '30 days'  -- è½¯åˆ é™¤ä¿ç•™æœŸ
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = ''
AS $$
DECLARE
  v_user_account_id UUID;
BEGIN
  -- è·å–ç”¨æˆ·è´¦æˆ· ID
  SELECT id INTO v_user_account_id
  FROM public.accounts
  WHERE auth_user_id = p_user_auth_id;
  
  IF NOT FOUND THEN
    RETURN FALSE;
  END IF;
  
  -- è½¯åˆ é™¤ï¼šæ ‡è®°ä¸ºåˆ é™¤ï¼Œè®¾ç½®ä¿ç•™æœŸ
  UPDATE accounts
  SET 
    status = 'inactive',
    data_retention_until = NOW() + p_retention_period,
    privacy_consent_given = FALSE,
    privacy_consent_given_at = NULL
  WHERE id = v_user_account_id;
  
  -- è®°å½•åˆ é™¤æ“ä½œ
  PERFORM private.log_privacy_access(
    p_user_auth_id,
    'account',
    v_user_account_id,
    'metadata',
    'delete',
    TRUE,
    'GDPR right to be forgotten',
    NULL,
    NULL
  );
  
  RETURN TRUE;
END;
$$;
```

### 2. æ•°æ®ä¿ç•™ç­–ç•¥

```sql
-- åˆ›å»ºæ•°æ®æ¸…ç†å‡½æ•°ï¼ˆå®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®ï¼‰
CREATE OR REPLACE FUNCTION public.cleanup_expired_data()
RETURNS TABLE (
  cleaned_accounts INTEGER,
  cleaned_blueprints INTEGER,
  cleaned_logs INTEGER
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = ''
AS $$
DECLARE
  v_cleaned_accounts INTEGER := 0;
  v_cleaned_blueprints INTEGER := 0;
  v_cleaned_logs INTEGER := 0;
BEGIN
  -- æ¸…ç†è¿‡æœŸçš„è´¦æˆ·æ•°æ®
  WITH deleted_accounts AS (
    DELETE FROM accounts
    WHERE status = 'inactive'
      AND data_retention_until IS NOT NULL
      AND data_retention_until < NOW()
    RETURNING id
  )
  SELECT COUNT(*) INTO v_cleaned_accounts FROM deleted_accounts;
  
  -- æ¸…ç†è¿‡æœŸçš„è“å›¾æ•°æ®
  WITH deleted_blueprints AS (
    DELETE FROM blueprints
    WHERE data_retention_until IS NOT NULL
      AND data_retention_until < NOW()
    RETURNING id
  )
  SELECT COUNT(*) INTO v_cleaned_blueprints FROM deleted_blueprints;
  
  -- æ¸…ç†è¿‡æœŸçš„å®¡è®¡æ—¥å¿—ï¼ˆä¿ç•™ 1 å¹´ï¼‰
  WITH deleted_logs AS (
    DELETE FROM privacy_access_logs
    WHERE created_at < NOW() - INTERVAL '1 year'
    RETURNING id
  )
  SELECT COUNT(*) INTO v_cleaned_logs FROM deleted_logs;
  
  RETURN QUERY SELECT v_cleaned_accounts, v_cleaned_blueprints, v_cleaned_logs;
END;
$$;
```

---

## ğŸ” å®‰å…¨å¢å¼º

### 1. æ•°æ®è„±æ•å‡½æ•°

```sql
-- åˆ›å»ºæ•°æ®è„±æ•å‡½æ•°
CREATE OR REPLACE FUNCTION private.mask_sensitive_data(
  p_data TEXT,
  p_data_type VARCHAR(50)
)
RETURNS TEXT
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
  CASE p_data_type
    WHEN 'email' THEN
      -- é‚®ç®±è„±æ•ï¼šabc@example.com -> a**@example.com
      RETURN regexp_replace(
        p_data,
        '^([^@]{1})[^@]*(@.*)$',
        '\1**\2'
      );
      
    WHEN 'phone' THEN
      -- ç”µè¯è„±æ•ï¼š13812345678 -> 138****5678
      RETURN regexp_replace(
        p_data,
        '^(\d{3})\d{4}(\d{4})$',
        '\1****\2'
      );
      
    WHEN 'name' THEN
      -- å§“åè„±æ•ï¼šå¼ ä¸‰ -> å¼ *
      IF length(p_data) <= 2 THEN
        RETURN substring(p_data, 1, 1) || '*';
      ELSE
        RETURN substring(p_data, 1, 1) || repeat('*', length(p_data) - 2) || substring(p_data, length(p_data), 1);
      END IF;
      
    ELSE
      RETURN p_data;
  END CASE;
END;
$$;
```

### 2. è®¿é—®é¢‘ç‡é™åˆ¶

```sql
-- åˆ›å»ºè®¿é—®é¢‘ç‡æ£€æŸ¥å‡½æ•°ï¼ˆé˜²æ­¢æ•°æ®çˆ¬å–ï¼‰
CREATE OR REPLACE FUNCTION private.check_access_rate_limit(
  p_viewer_auth_user_id UUID,
  p_resource_type VARCHAR(50),
  p_time_window INTERVAL DEFAULT '1 minute',
  p_max_requests INTEGER DEFAULT 100
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = ''
AS $$
DECLARE
  v_request_count INTEGER;
BEGIN
  -- ç»Ÿè®¡æ—¶é—´çª—å£å†…çš„è¯·æ±‚æ•°
  SELECT COUNT(*) INTO v_request_count
  FROM privacy_access_logs
  WHERE viewer_auth_user_id = p_viewer_auth_user_id
    AND resource_type = p_resource_type
    AND created_at >= NOW() - p_time_window;
  
  -- æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
  RETURN v_request_count < p_max_requests;
END;
$$;
```

---

## ğŸ“Š å®¡è®¡ä¸ç›‘æ§

### 1. éšç§è®¿é—®æŠ¥å‘Š

```sql
-- åˆ›å»ºéšç§è®¿é—®æŠ¥å‘Šå‡½æ•°
CREATE OR REPLACE FUNCTION public.generate_privacy_access_report(
  p_start_date TIMESTAMPTZ,
  p_end_date TIMESTAMPTZ,
  p_resource_type VARCHAR(50) DEFAULT NULL,
  p_data_classification VARCHAR(20) DEFAULT NULL
)
RETURNS TABLE (
  total_accesses BIGINT,
  granted_accesses BIGINT,
  denied_accesses BIGINT,
  by_resource_type JSONB,
  by_data_classification JSONB,
  by_access_method JSONB,
  top_viewers JSONB,
  top_resources JSONB
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = ''
AS $$
BEGIN
  RETURN QUERY
  SELECT 
    COUNT(*)::BIGINT as total_accesses,
    COUNT(*) FILTER (WHERE access_granted = TRUE)::BIGINT as granted_accesses,
    COUNT(*) FILTER (WHERE access_granted = FALSE)::BIGINT as denied_accesses,
    jsonb_object_agg(resource_type, count) FILTER (WHERE resource_type IS NOT NULL) as by_resource_type,
    jsonb_object_agg(data_classification, count) FILTER (WHERE data_classification IS NOT NULL) as by_data_classification,
    jsonb_object_agg(access_method, count) FILTER (WHERE access_method IS NOT NULL) as by_access_method,
    (
      SELECT jsonb_agg(jsonb_build_object('viewer_id', viewer_account_id, 'count', count))
      FROM (
        SELECT viewer_account_id, COUNT(*) as count
        FROM privacy_access_logs
        WHERE created_at BETWEEN p_start_date AND p_end_date
          AND (p_resource_type IS NULL OR resource_type = p_resource_type)
          AND (p_data_classification IS NULL OR data_classification = p_data_classification)
        GROUP BY viewer_account_id
        ORDER BY count DESC
        LIMIT 10
      ) top_viewers
    ) as top_viewers,
    (
      SELECT jsonb_agg(jsonb_build_object('resource_id', resource_id, 'count', count))
      FROM (
        SELECT resource_id, COUNT(*) as count
        FROM privacy_access_logs
        WHERE created_at BETWEEN p_start_date AND p_end_date
          AND (p_resource_type IS NULL OR resource_type = p_resource_type)
          AND (p_data_classification IS NULL OR data_classification = p_data_classification)
        GROUP BY resource_id
        ORDER BY count DESC
        LIMIT 10
      ) top_resources
    ) as top_resources
  FROM privacy_access_logs
  WHERE created_at BETWEEN p_start_date AND p_end_date
    AND (p_resource_type IS NULL OR resource_type = p_resource_type)
    AND (p_data_classification IS NULL OR data_classification = p_data_classification);
END;
$$;
```

---

## ğŸ¨ å‰ç«¯å®ç°

### 1. éšç§è®¾ç½®ç»„ä»¶ï¼ˆä¼ä¸šçº§ï¼‰

```typescript
@Component({
  selector: 'app-enterprise-privacy-settings',
  template: `
    <nz-card nzTitle="ä¼ä¸šçº§éšç§è®¾ç½®">
      <!-- æ•°æ®åˆ†ç±»æ˜¾ç¤ºï¼ˆåªè¯»ï¼Œç”±ç³»ç»Ÿç®¡ç†å‘˜è®¾ç½®ï¼‰ -->
      <nz-alert
        nzType="info"
        nzMessage="æ•°æ®åˆ†ç±»"
        [nzDescription]="'å½“å‰æ•°æ®åˆ†ç±»ï¼š' + dataClassification()"
        style="margin-bottom: 16px;"
      ></nz-alert>
      
      <!-- å¯è§æ€§è®¾ç½® -->
      <nz-form [formGroup]="privacyForm">
        <nz-form-item>
          <nz-form-label>æœç´¢å¯è§æ€§</nz-form-label>
          <nz-form-control>
            <nz-select formControlName="searchVisibility">
              @for (option of getVisibilityOptions(dataClassification()); track option.value) {
                <nz-option [nzValue]="option.value" [nzLabel]="option.label"></nz-option>
              }
            </nz-select>
            <nz-form-explain>
              æ§åˆ¶æ˜¯å¦èƒ½åœ¨æ¢ç´¢åŠŸèƒ½ä¸­è¢«æœç´¢åˆ°
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
        
        <!-- å…¶ä»–å¯è§æ€§è®¾ç½®... -->
      </nz-form>
      
      <!-- GDPR åˆè§„é€‰é¡¹ -->
      <nz-divider nzText="GDPR åˆè§„"></nz-divider>
      <div class="gdpr-actions">
        <button nz-button nzType="default" (click)="exportData()">
          <span nz-icon nzType="download"></span>
          å¯¼å‡ºæˆ‘çš„æ•°æ®
        </button>
        <button nz-button nzDanger (click)="requestDataDeletion()">
          <span nz-icon nzType="delete"></span>
          è¯·æ±‚åˆ é™¤æ•°æ®
        </button>
      </div>
    </nz-card>
  `
})
export class EnterprisePrivacySettingsComponent {
  readonly DataClassification = DataClassification;
  readonly VisibilityLevel = VisibilityLevel;
  
  dataClassification = signal<DataClassification>(DataClassification.INTERNAL);
  
  privacyForm = this.fb.group({
    searchVisibility: [VisibilityLevel.AUTHENTICATED],
    profileVisibility: [VisibilityLevel.AUTHENTICATED],
    contactVisibility: [VisibilityLevel.ORGANIZATION],
    detailVisibility: [VisibilityLevel.ORGANIZATION]
  });
  
  /**
   * æ ¹æ®æ•°æ®åˆ†ç±»è¿”å›å…è®¸çš„å¯è§æ€§é€‰é¡¹
   */
  getVisibilityOptions(classification: DataClassification): Array<{value: VisibilityLevel, label: string}> {
    switch (classification) {
      case DataClassification.PUBLIC:
        return [
          { value: VisibilityLevel.PUBLIC, label: 'å…¬å¼€ - æ‰€æœ‰äººå¯è§' },
          { value: VisibilityLevel.AUTHENTICATED, label: 'å·²è®¤è¯ç”¨æˆ·' },
          { value: VisibilityLevel.ORGANIZATION, label: 'ç»„ç»‡æˆå‘˜' },
          { value: VisibilityLevel.COLLABORATOR, label: 'åä½œæˆå‘˜' },
          { value: VisibilityLevel.PRIVATE, label: 'ç§æœ‰' }
        ];
      case DataClassification.INTERNAL:
        return [
          { value: VisibilityLevel.AUTHENTICATED, label: 'å·²è®¤è¯ç”¨æˆ·' },
          { value: VisibilityLevel.ORGANIZATION, label: 'ç»„ç»‡æˆå‘˜' },
          { value: VisibilityLevel.COLLABORATOR, label: 'åä½œæˆå‘˜' },
          { value: VisibilityLevel.PRIVATE, label: 'ç§æœ‰' }
        ];
      case DataClassification.CONFIDENTIAL:
        return [
          { value: VisibilityLevel.ORGANIZATION, label: 'ç»„ç»‡æˆå‘˜' },
          { value: VisibilityLevel.COLLABORATOR, label: 'åä½œæˆå‘˜' },
          { value: VisibilityLevel.PRIVATE, label: 'ç§æœ‰' }
        ];
      case DataClassification.RESTRICTED:
        return [
          { value: VisibilityLevel.PRIVATE, label: 'ç§æœ‰ - ä»…è‡ªå·±å¯è§' }
        ];
      default:
        return [];
    }
  }
  
  async exportData(): Promise<void> {
    // è°ƒç”¨ GDPR æ•°æ®å¯¼å‡º API
  }
  
  async requestDataDeletion(): Promise<void> {
    // è°ƒç”¨ GDPR æ•°æ®åˆ é™¤ API
  }
}
```

### 2. æœç´¢ç»“æœå±•ç¤ºï¼ˆä¼ä¸šçº§ï¼‰

```typescript
// æœç´¢ç»“æœç»„ä»¶ä¸­ï¼Œæ˜¾ç¤ºæ•°æ®åˆ†ç±»æ ‡ç­¾å’Œè„±æ•ä¿¡æ¯
@if (canViewContact(account)) {
  <div class="email">{{ account.email }}</div>
} @else {
  <div class="email-placeholder">
    {{ maskEmail(account.email) }}  <!-- æ˜¾ç¤ºè„±æ•åçš„é‚®ç®± -->
  </div>
}

<!-- æ•°æ®åˆ†ç±»æ ‡ç­¾ -->
<nz-tag [nzColor]="getClassificationColor(account.dataClassification)">
  {{ getClassificationLabel(account.dataClassification) }}
</nz-tag>
```

---

## ğŸ“‹ å®æ–½æ­¥éª¤ï¼ˆä¼ä¸šçº§ï¼‰

### é˜¶æ®µ 1ï¼šæ•°æ®åˆ†ç±»å’ŒåŸºç¡€å­—æ®µï¼ˆ3-5 å¤©ï¼‰

1. âœ… åˆ›å»ºæ•°æ®åˆ†ç±»æšä¸¾å’Œç­–ç•¥è¡¨
2. âœ… æ·»åŠ æ•°æ®åˆ†ç±»å­—æ®µåˆ° `accounts` å’Œ `blueprints` è¡¨
3. âœ… æ·»åŠ éšç§æ§åˆ¶å­—æ®µ
4. âœ… è®¾ç½®é»˜è®¤æ•°æ®åˆ†ç±»ç­–ç•¥

### é˜¶æ®µ 2ï¼šæƒé™åˆ¤æ–­å‡½æ•°ï¼ˆ5-7 å¤©ï¼‰

1. âœ… åˆ›å»ºä¼ä¸šçº§å¯è§æ€§åˆ¤æ–­å‡½æ•°
2. âœ… åˆ›å»ºéšç§è®¿é—®æ—¥å¿—è®°å½•å‡½æ•°
3. âœ… åˆ›å»ºæ•°æ®åˆ†ç±»éªŒè¯å‡½æ•°
4. âœ… åˆ›å»ºå…³ç³»æ£€æŸ¥å‡½æ•°ï¼ˆç»„ç»‡æˆå‘˜ã€åä½œå…³ç³»ï¼‰

### é˜¶æ®µ 3ï¼šå®¡è®¡å’Œåˆè§„åŠŸèƒ½ï¼ˆ5-7 å¤©ï¼‰

1. âœ… åˆ›å»ºéšç§è®¿é—®å®¡è®¡è¡¨
2. âœ… å®ç° GDPR æ•°æ®å¯¼å‡ºåŠŸèƒ½
3. âœ… å®ç° GDPR æ•°æ®åˆ é™¤åŠŸèƒ½
4. âœ… å®ç°æ•°æ®ä¿ç•™ç­–ç•¥

### é˜¶æ®µ 4ï¼šæœç´¢å‡½æ•°æ›´æ–°ï¼ˆ3-5 å¤©ï¼‰

1. âœ… æ›´æ–°æœç´¢è´¦æˆ·å‡½æ•°ï¼Œæ·»åŠ ä¼ä¸šçº§éšç§æ§åˆ¶
2. âœ… æ›´æ–°æœç´¢è“å›¾å‡½æ•°ï¼ˆå¦‚æœéœ€è¦ï¼‰
3. âœ… æ·»åŠ è¯·æ±‚ ID è¿½è¸ª
4. âœ… æ·»åŠ è®¿é—®é¢‘ç‡é™åˆ¶

### é˜¶æ®µ 5ï¼šå‰ç«¯å®ç°ï¼ˆ5-7 å¤©ï¼‰

1. âœ… åˆ›å»ºä¼ä¸šçº§éšç§è®¾ç½®ç»„ä»¶
2. âœ… æ›´æ–°æœç´¢ç»“æœå±•ç¤ºç»„ä»¶
3. âœ… å®ç°æ•°æ®åˆ†ç±»æ ‡ç­¾æ˜¾ç¤º
4. âœ… å®ç°æ•°æ®è„±æ•æ˜¾ç¤º

### é˜¶æ®µ 6ï¼šæµ‹è¯•ä¸åˆè§„éªŒè¯ï¼ˆ5-7 å¤©ï¼‰

1. âœ… å•å…ƒæµ‹è¯•
2. âœ… é›†æˆæµ‹è¯•
3. âœ… åˆè§„æ€§æµ‹è¯•ï¼ˆGDPRã€CCPAï¼‰
4. âœ… å®‰å…¨å®¡è®¡
5. âœ… æ€§èƒ½æµ‹è¯•

---

## ğŸ”’ ä¼ä¸šçº§å®‰å…¨è€ƒè™‘

### 1. æ•°æ®åˆ†ç±»ç­–ç•¥

| æ•°æ®åˆ†ç±» | é»˜è®¤å¯è§æ€§çº§åˆ« | å…è®¸çš„å¯è§æ€§çº§åˆ« | é€‚ç”¨åœºæ™¯ |
|---------|--------------|----------------|---------|
| **Public** | `authenticated` | `public`, `authenticated`, `organization`, `collaborator`, `private` | å…¬å¼€ä¿¡æ¯ã€è¥é”€å†…å®¹ |
| **Internal** | `organization` | `authenticated`, `organization`, `collaborator`, `private` | å†…éƒ¨æ–‡æ¡£ã€å›¢é˜Ÿä¿¡æ¯ |
| **Confidential** | `collaborator` | `organization`, `collaborator`, `private` | æ•æ„Ÿé¡¹ç›®ã€å®¢æˆ·æ•°æ® |
| **Restricted** | `private` | `private` | ä¸ªäººéšç§ã€è´¢åŠ¡æ•°æ® |

### 2. é»˜è®¤éšç§çº§åˆ«

- **ç”¨æˆ·è´¦æˆ·**ï¼š
  - æ•°æ®åˆ†ç±»ï¼š`internal`
  - æœç´¢å¯è§æ€§ï¼š`authenticated`
  - è”ç³»ä¿¡æ¯ï¼š`organization`
  
- **ç»„ç»‡è´¦æˆ·**ï¼š
  - æ•°æ®åˆ†ç±»ï¼š`internal`
  - æœç´¢å¯è§æ€§ï¼š`authenticated`
  - è”ç³»ä¿¡æ¯ï¼š`organization`
  
- **è“å›¾**ï¼š
  - æ•°æ®åˆ†ç±»ï¼š`internal`
  - æœç´¢å¯è§æ€§ï¼š`organization`
  - è¯¦ç»†ä¿¡æ¯ï¼š`collaborator`

### 3. å®¡è®¡è¦æ±‚

- âœ… æ‰€æœ‰éšç§æ•°æ®è®¿é—®éƒ½è®°å½•åˆ° `privacy_access_logs`
- âœ… æ—¥å¿—ä¿ç•™ 1 å¹´ï¼ˆåˆè§„è¦æ±‚ï¼‰
- âœ… æ”¯æŒæŒ‰èµ„æºç±»å‹ã€æ•°æ®åˆ†ç±»ã€è®¿é—®è€…æŸ¥è¯¢
- âœ… å®šæœŸç”Ÿæˆéšç§è®¿é—®æŠ¥å‘Š

### 4. åˆè§„æ€§æ£€æŸ¥

- âœ… GDPRï¼šæ•°æ®æœ€å°åŒ–ã€ç”¨æˆ·åŒæ„ã€æ•°æ®å¯æºå¸¦æ€§ã€è¢«é—å¿˜æƒ
- âœ… CCPAï¼šæ•°æ®é€æ˜åº¦ã€ç”¨æˆ·æƒåˆ©ã€æ•°æ®åˆ é™¤
- âœ… ISO 27001ï¼šä¿¡æ¯å®‰å…¨ç®¡ç†ä½“ç³»
- âœ… SOC 2ï¼šå®‰å…¨ã€å¯ç”¨æ€§ã€å¤„ç†å®Œæ•´æ€§ã€ä¿å¯†æ€§ã€éšç§æ€§

---

## ğŸ“Š ç›‘æ§å’Œå‘Šè­¦

### 1. å¼‚å¸¸è®¿é—®æ£€æµ‹

```sql
-- åˆ›å»ºå¼‚å¸¸è®¿é—®æ£€æµ‹å‡½æ•°
CREATE OR REPLACE FUNCTION public.detect_anomalous_access(
  p_time_window INTERVAL DEFAULT '1 hour',
  p_threshold INTEGER DEFAULT 1000  -- å¼‚å¸¸è®¿é—®é˜ˆå€¼
)
RETURNS TABLE (
  viewer_account_id UUID,
  access_count BIGINT,
  risk_level VARCHAR(20)
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = ''
AS $$
BEGIN
  RETURN QUERY
  SELECT 
    log.viewer_account_id,
    COUNT(*)::BIGINT as access_count,
    CASE 
      WHEN COUNT(*) > p_threshold * 2 THEN 'critical'
      WHEN COUNT(*) > p_threshold THEN 'high'
      ELSE 'medium'
    END as risk_level
  FROM privacy_access_logs log
  WHERE log.created_at >= NOW() - p_time_window
    AND log.access_granted = TRUE
  GROUP BY log.viewer_account_id
  HAVING COUNT(*) > p_threshold
  ORDER BY access_count DESC;
END;
$$;
```

### 2. åˆè§„æ€§æŠ¥å‘Š

```sql
-- åˆ›å»ºåˆè§„æ€§æŠ¥å‘Šå‡½æ•°
CREATE OR REPLACE FUNCTION public.generate_compliance_report(
  p_start_date TIMESTAMPTZ,
  p_end_date TIMESTAMPTZ
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = ''
AS $$
DECLARE
  v_report JSONB;
BEGIN
  SELECT jsonb_build_object(
    'period', jsonb_build_object('start', p_start_date, 'end', p_end_date),
    'gdpr_compliance', jsonb_build_object(
      'data_exports', (
        SELECT COUNT(*)
        FROM privacy_access_logs
        WHERE access_method = 'export'
          AND created_at BETWEEN p_start_date AND p_end_date
      ),
      'data_deletions', (
        SELECT COUNT(*)
        FROM privacy_access_logs
        WHERE access_method = 'delete'
          AND created_at BETWEEN p_start_date AND p_end_date
      ),
      'consent_rate', (
        SELECT 
          CASE 
            WHEN COUNT(*) > 0 THEN 
              COUNT(*) FILTER (WHERE consent_given = TRUE)::FLOAT / COUNT(*)::FLOAT * 100
            ELSE 0
          END
        FROM privacy_access_logs
        WHERE consent_required = TRUE
          AND created_at BETWEEN p_start_date AND p_end_date
      )
    ),
    'access_statistics', (
      SELECT jsonb_build_object(
        'total_accesses', COUNT(*),
        'granted_accesses', COUNT(*) FILTER (WHERE access_granted = TRUE),
        'denied_accesses', COUNT(*) FILTER (WHERE access_granted = FALSE),
        'by_classification', (
          SELECT jsonb_object_agg(data_classification, count)
          FROM (
            SELECT data_classification, COUNT(*) as count
            FROM privacy_access_logs
            WHERE created_at BETWEEN p_start_date AND p_end_date
            GROUP BY data_classification
          ) stats
        )
      )
      FROM privacy_access_logs
      WHERE created_at BETWEEN p_start_date AND p_end_date
    ),
    'anomalies', (
      SELECT jsonb_agg(jsonb_build_object(
        'viewer_id', viewer_account_id,
        'access_count', access_count,
        'risk_level', risk_level
      ))
      FROM public.detect_anomalous_access('24 hours', 1000)
    )
  ) INTO v_report;
  
  RETURN v_report;
END;
$$;
```

---

## ğŸ¯ ä¼ä¸šçº§ç‰¹æ€§æ€»ç»“

### 1. æ•°æ®åˆ†ç±»å’Œæ ‡è®°

- âœ… å››çº§æ•°æ®åˆ†ç±»ï¼ˆPublic, Internal, Confidential, Restrictedï¼‰
- âœ… åŸºäºæ•°æ®åˆ†ç±»çš„è®¿é—®æ§åˆ¶ç­–ç•¥
- âœ… æ•°æ®åˆ†ç±»ç­–ç•¥è¡¨ï¼ˆå¯é…ç½®ï¼‰

### 2. ç»†ç²’åº¦è®¿é—®æ§åˆ¶

- âœ… åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
- âœ… åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰
- âœ… å…³ç³»æ„ŸçŸ¥æƒé™åˆ¤æ–­
- âœ… å­—æ®µçº§åˆ«çš„éšç§æ§åˆ¶

### 3. å®¡è®¡å’Œåˆè§„

- âœ… å®Œæ•´çš„éšç§è®¿é—®å®¡è®¡æ—¥å¿—
- âœ… GDPR åˆè§„åŠŸèƒ½ï¼ˆæ•°æ®å¯¼å‡ºã€åˆ é™¤ï¼‰
- âœ… æ•°æ®ä¿ç•™ç­–ç•¥
- âœ… åˆè§„æ€§æŠ¥å‘Šç”Ÿæˆ

### 4. å®‰å…¨å¢å¼º

- âœ… æ•°æ®è„±æ•
- âœ… è®¿é—®é¢‘ç‡é™åˆ¶
- âœ… å¼‚å¸¸è®¿é—®æ£€æµ‹
- âœ… è¯·æ±‚é“¾è·¯è¿½è¸ª

### 5. ç›‘æ§å’Œå‘Šè­¦

- âœ… éšç§è®¿é—®ç»Ÿè®¡
- âœ… å¼‚å¸¸è®¿é—®æ£€æµ‹
- âœ… åˆè§„æ€§ç›‘æ§
- âœ… å®šæœŸæŠ¥å‘Šç”Ÿæˆ

---

## ğŸ“š å‚è€ƒæ ‡å‡†

- **ISO 27001**ï¼šä¿¡æ¯å®‰å…¨ç®¡ç†ä½“ç³»
- **GDPR**ï¼šé€šç”¨æ•°æ®ä¿æŠ¤æ¡ä¾‹
- **CCPA**ï¼šåŠ å·æ¶ˆè´¹è€…éšç§æ³•æ¡ˆ
- **NIST Privacy Framework**ï¼šéšç§æ¡†æ¶
- **SOC 2**ï¼šæœåŠ¡ç»„ç»‡æ§åˆ¶ 2
- **OWASP Top 10**ï¼šWeb åº”ç”¨å®‰å…¨é£é™©

---

## â“ å¾…è®¨è®ºé—®é¢˜

1. **æ•°æ®åˆ†ç±»ç®¡ç†**ï¼šè°æœ‰æƒè®¾ç½®å’Œä¿®æ”¹æ•°æ®åˆ†ç±»ï¼Ÿæ˜¯å¦éœ€è¦å®¡æ‰¹æµç¨‹ï¼Ÿ
2. **åˆè§„æ€§è¦æ±‚**ï¼šæ˜¯å¦éœ€è¦æ”¯æŒå…¶ä»–åˆè§„æ ‡å‡†ï¼ˆå¦‚ HIPAAã€PCI-DSSï¼‰ï¼Ÿ
3. **å®¡è®¡æ—¥å¿—ä¿ç•™**ï¼š1 å¹´çš„ä¿ç•™æœŸæ˜¯å¦è¶³å¤Ÿï¼Ÿæ˜¯å¦éœ€è¦æ›´é•¿çš„ä¿ç•™æœŸï¼Ÿ
4. **å¼‚å¸¸è®¿é—®å¤„ç†**ï¼šæ£€æµ‹åˆ°å¼‚å¸¸è®¿é—®åï¼Œåº”è¯¥é‡‡å–ä»€ä¹ˆæªæ–½ï¼ˆå‘Šè­¦ã€è‡ªåŠ¨é˜»æ­¢ï¼‰ï¼Ÿ
5. **æ•°æ®è„±æ•ç­–ç•¥**ï¼šæ˜¯å¦éœ€è¦æ›´å¤æ‚çš„è„±æ•ç®—æ³•ï¼ˆå¦‚å·®åˆ†éšç§ï¼‰ï¼Ÿ

---

**æœ€åæ›´æ–°**ï¼š2025-01-20  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ  
**æ ‡å‡†ç‰ˆæœ¬**ï¼šä¼ä¸šçº§ v1.0


