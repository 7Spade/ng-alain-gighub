# 開發脈絡記錄 (FYI - Development)

> 參考：[@fyi.md](./fyi.md)

記錄專案在開發過程中的思路、嘗試、技術選型原因、權衡、取捨、重大決策與其背景。

---

## 2025-01-15: 實施階段 1 - 權限服務模組（core/permissions/）

### 背景
根據 PRD 要求和 Git-like 分支模型架構，需要實現完整的 RBAC 權限控制系統。整合 @delon/acl 和 Supabase 數據庫，實現權限檢查、角色管理、分支權限控制等功能。

### 設計決策

#### 技術選型
- **整合 @delon/acl**：使用 ACLService 作為本地權限緩存
  - **原因**：ng-alain 框架已提供完整的 ACL 功能，無需重複造輪
  - **優勢**：與框架深度整合，支持路由守衛、指令等
  - **權衡**：需要適配 Supabase 數據庫權限系統

#### 架構設計
- **獨立類型定義**：創建 `types.ts` 文件，便於未來平坦開發
  - **原因**：用戶要求以未來平坦開發為主
  - **優勢**：類型定義集中管理，易於維護和擴展

#### 性能優化
- **內存緩存策略**：5 分鐘 TTL，減少數據庫查詢
  - **原因**：權限檢查頻繁，每次查詢數據庫會影響性能
  - **權衡**：緩存時間過短會增加查詢，過長會導致權限更新延遲
  - **選擇**：5 分鐘平衡性能和實時性
  - **詳細說明**：參考 [性能優化策略](./fyi-performance.md#權限系統緩存策略)

#### 錯誤處理
- **權限檢查失敗時拋出異常**
  - **原因**：用戶明確要求
  - **優勢**：明確的錯誤處理，便於調試和日誌記錄

#### 日誌記錄
- **規劃文件中提到需要，後續實現 activity_logs 整合**
  - **原因**：PRD 要求活動記錄功能
  - **狀態**：已規劃，待實施

### 實施細節

#### 權限檢查流程設計
```
權限檢查請求
  ↓
1. 檢查 @delon/acl ACLService 本地緩存
  ↓ (如果沒有)
2. 檢查內存緩存（5 分鐘 TTL）
  ↓ (如果沒有)
3. 查詢 Supabase 數據庫（user_roles + role_permissions + permissions）
  ↓
4. 同步到 ACLService 和內存緩存
  ↓
5. 返回權限檢查結果
```

**設計考量**：
- 三層緩存策略：ACLService → 內存緩存 → 數據庫
- 減少數據庫查詢，提升性能
- 自動同步，保持一致性
- **詳細說明**：參考 [性能優化策略](./fyi-performance.md#權限系統緩存策略)

#### 與 @delon/acl 整合策略
- 使用 `ACLService.set({ role: [...], abilities: [...] })` 同步權限
- 使用 `ACLService.can()` 檢查本地緩存
- 自動同步角色和權限到 ACLService

**設計考量**：
- 保留框架原有功能，無需修改業務代碼
- 雙向同步，確保權限一致性

---

## 2025-11-14: Supabase 與 @delon/auth 整合

### 背景
專案需要整合 Supabase 作為後端服務，同時保留現有的 `@delon/auth` 認證系統，確保零破壞性整合。

### 設計決策

#### 適配器模式
- **創建 `SupabaseAuthAdapterService` 作為 Supabase Auth 與 `@delon/auth` 之間的橋樑**
  - **原因**：需要整合兩個不同的認證系統
  - **優勢**：零破壞性，保留所有現有代碼
  - **權衡**：增加一層抽象，但換來兼容性

#### Session 同步機制
- **自動將 Supabase Session 轉換為 @delon/auth Token 格式並同步到 `TokenService`**
  - **原因**：兩個系統的 Session 格式不同
  - **實現**：格式轉換函數 `convertSessionToTokenFormat()`
  - **優勢**：自動同步，無需手動處理

#### 零破壞性整合
- **保留所有現有的 `@delon/auth` 使用方式，無需修改業務代碼**
  - **原因**：避免大規模重構
  - **優勢**：降低風險，快速整合

### 技術細節

#### Session 格式轉換
- `access_token` → `token`
- `refresh_token` → `refresh_token`
- `expires_in` → `expired` (計算過期時間戳)

#### 自動狀態同步
- 監聽 Supabase Auth 狀態變化
- 自動同步到 TokenService
- 應用啟動時自動恢復 Session

---

## 2025-11-14: 註冊功能改為 Supabase Auth，移除手機號登入

### 背景
將註冊功能改為使用 Supabase Auth，並移除登入頁面的手機號登入功能，統一使用 Email/Password 認證方式。

### 設計決策

#### 統一認證方式
- **僅使用 Email/Password 認證，移除手機號登入**
  - **原因**：簡化認證流程，降低維護成本
  - **權衡**：失去手機號登入便利性，但換來一致性

#### 簡化 UI
- **移除登入頁面的 Tab 切換，簡化表單結構**
  - **原因**：只有一種認證方式，無需切換
  - **優勢**：UI 更簡潔，用戶體驗更好

#### 保持一致性
- **註冊和登入都使用 Supabase Auth**
  - **原因**：統一認證流程
  - **優勢**：代碼更一致，維護更容易

---

## 2025-11-14: 移除社交登入功能（其他登入方式、Auth0）

### 背景
移除登入頁面的社交登入功能，包括"其他登入方式"區塊和 Auth0、GitHub、Weibo 等第三方登入選項，統一使用 Supabase Auth 的 Email/Password 認證。

### 設計決策

#### 簡化認證流程
- **僅保留 Supabase Auth 的 Email/Password 認證**
  - **原因**：減少依賴，降低複雜度
  - **權衡**：失去社交登入便利性，但換來系統簡化

#### 移除社交登入
- **移除所有第三方登入選項（Auth0、GitHub、Weibo）**
  - **原因**：不需要第三方認證
  - **優勢**：減少代碼複雜度，降低安全風險

#### 保留註冊連結
- **保留註冊頁面連結，方便新用戶註冊**
  - **原因**：用戶體驗考慮
  - **實現**：移至表單底部並居中顯示

---

## 2025-01-15: 項目結構重構規劃

### 背景
基於 51 張資料表的 11 個業務模組分類、業務流程圖、帳戶層流程圖和實體關係圖，需要重構項目文件夾結構，使其符合 Angular 20 + ng-alain 最佳實踐，並反映 Git-like 分支模型架構。

### 設計決策

#### 分層架構
- **嚴格遵循 `routes` → `shared` → `core` 的依賴方向**
  - **原因**：清晰的依賴關係，避免循環依賴
  - **優勢**：代碼組織更清晰，維護更容易

#### 業務領域驅動
- **按 11 個業務模組組織文件夾結構**
  - **原因**：符合領域驅動設計（DDD）原則
  - **優勢**：業務邏輯清晰，易於擴展

#### Angular 20 最佳實踐
- **使用 Standalone Components、SHARED_IMPORTS、Signals**
  - **原因**：Angular 20 新特性，提升開發體驗
  - **優勢**：代碼更簡潔，性能更好

#### 資料表映射
- **每個業務模組對應相應的資料表集合和數據模型**
  - **原因**：清晰的數據模型映射
  - **優勢**：易於理解和維護

### 技術細節

#### 使用工具
- Context7 查詢 Angular 20 和 ng-alain 最佳實踐
- Sequential Thinking 分析項目結構和業務需求
- Software Planning Tool 創建重構計劃

#### 設計依據
- 業務流程圖
- 帳戶層流程圖
- 實體關係圖
- 51 張資料表結構定義

---

## 技術選型總結

### 為什麼選擇 @delon/acl？
- ng-alain 框架已提供完整的 ACL 功能
- 與框架深度整合，支持路由守衛、指令等
- 無需重複造輪，降低開發成本

### 為什麼選擇適配器模式？
- 零破壞性整合，保留所有現有代碼
- 清晰的職責分離
- 易於測試和維護

### 為什麼選擇內存緩存？
- 權限檢查頻繁，需要高性能
- 5 分鐘 TTL 平衡性能和實時性
- 減少數據庫查詢，提升響應速度

### 為什麼統一使用 Email/Password？
- 簡化認證流程，降低維護成本
- 與 Supabase Auth 深度整合
- 減少安全風險

---

**最後更新**：2025-01-15  
**維護者**：開發團隊
