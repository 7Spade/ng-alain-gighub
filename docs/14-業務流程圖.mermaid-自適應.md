---
config:
  layout: elk
---
flowchart TB
    Start(["ğŸ‘¤ ç”¨æˆ¶ç™»å…¥ç³»çµ±"]) --> AuthCheck{"Supabase Auth<br>èº«ä»½é©—è­‰"}
    AuthCheck -- é©—è­‰å¤±æ•— --> AuthFail["âŒ è¿”å›ç™»å…¥é "]
    AuthCheck -- é©—è­‰æˆåŠŸ --> LoadUser["è¼‰å…¥ç”¨æˆ¶è³‡æ–™<br>DB: accounts"]
    LoadUser --> CheckRole{"æª¢æŸ¥è§’è‰²æ¬Šé™<br>RLS + branch_roles"}
    CheckRole --> Dashboard["ğŸ“Š é€²å…¥å°ˆæ¡ˆå„€è¡¨æ¿<br>DB: blueprints"]
    Dashboard --> SelectBlueprint{"é¸æ“‡è—åœ– / åˆ†æ”¯"}
    SelectBlueprint -- ä¸»åˆ†æ”¯ --> MainView["ä¸»åˆ†æ”¯æ§åˆ¶å°"]
    SelectBlueprint -- æ‰¿æ”¬åˆ†æ”¯ --> BranchView["æ‰¿æ”¬åˆ†æ”¯é¢æ¿"]
    MainView --> SelectAction{"é¸æ“‡æ“ä½œ"}
    BranchView --> SelectAction
    SelectAction -- Fork ä»»å‹™ --> ForkFlow["ğŸ”€ å»ºç«‹ Fork<br>DB: branch_forks"]
    ForkFlow --> CreateBranch["ğŸŒ¿ å»ºç«‹åˆ†æ”¯<br>DB: blueprint_branches"]
    CreateBranch --> InviteOrg["ğŸ¤ å”ä½œé‚€è«‹<br>DB: organization_collaborations"]
    InviteOrg --> BranchReady(["åˆ†æ”¯å•Ÿç”¨"])
    SelectAction -- æäº¤ PR --> PRSubmit["ğŸ“® æäº¤ Pull Request<br>DB: pull_requests"]
    PRSubmit --> ReviewFlow["ğŸ” å¯©æŸ¥è®Šæ›´<br>DB: pull_request_reviews"]
    ReviewFlow --> MergeDecision{"å¯©æŸ¥é€šé?"}
    MergeDecision -- æ˜¯ --> MergeMain["âœ… åˆä½µä¸»åˆ†æ”¯<br>Edge Function: branch-merge"]
    MergeDecision -- å¦ --> BranchAdjust["â†©ï¸ èª¿æ•´åˆ†æ”¯"]
    SelectAction -- å»ºç«‹ä»»å‹™ --> CreateTask["ğŸ“‹ å»ºç«‹æ–°ä»»å‹™<br>DB: tasks"]
    CreateTask --> AssignTask["æŒ‡æ´¾è² è²¬äºº<br>Realtime é€šçŸ¥"]
    AssignTask --> TaskNotify["âš¡ Realtime æ¨é€é€šçŸ¥<br>DB: notifications"]
    TaskNotify --> WorkStart["ğŸ‘· é–‹å§‹æ–½å·¥"]
    WorkStart --> DailyReport{"æ¯æ—¥å ±è¡¨æµç¨‹"}
    DailyReport --> UploadPhoto["ğŸ“· ä¸Šå‚³æ–½å·¥ç…§ç‰‡<br>Storage: images/"]
    UploadPhoto --> RecordWeather["â˜ï¸ è¨˜éŒ„å¤©æ°£<br>Edge Function: å¤©æ°£API<br>DB: weather_cache"]
    RecordWeather --> SaveReport["ğŸ’¾ å„²å­˜æ—¥å ±<br>DB: daily_reports"]
    SaveReport --> TriggerLog1["ğŸ”” è§¸ç™¼æ´»å‹•è¨˜éŒ„<br>DB Trigger â†’ activity_logs"]
    TriggerLog1 --> CheckComplete{"ä»»å‹™å®Œæˆ?"}
    CheckComplete -- å¦ --> WorkStart
    CheckComplete -- æ˜¯ --> SubmitQC["æäº¤å“è³ªé©—æ”¶<br>DB: quality_checks"]
    SubmitQC --> QCInspect["ğŸ” é©—æ”¶äººå“¡æª¢æŸ¥"]
    QCInspect --> QCPhoto["ğŸ“· æ‹æ”é©—æ”¶ç…§ç‰‡<br>Storage: images/"]
    QCPhoto --> QCResult{"é©—æ”¶çµæœ"}
    QCResult -- ä¸åˆæ ¼ --> OpenIssue["âš ï¸ é–‹ç«‹å•é¡Œ<br>DB: issues"]
    QCResult -- åˆæ ¼ --> UpdateProgress["âœ… æ›´æ–°é€²åº¦<br>DB: progress_tracking<br>Edge Function: è¨ˆç®—é€²åº¦"]
    UpdateProgress --> NotifyComplete["âš¡ Realtime é€šçŸ¥å®Œæˆ"]
    NotifyComplete --> EndTask(["ä»»å‹™å®Œæˆ"])
    TaskTree["ğŸŒ³ ä»»å‹™æ¨¹ç‹€çµæ§‹"] --> TaskAssign["TaskAssign"]
    TaskAssign -- åŠ å…¥å¾…è¾¦ --> TaskList["å¾…è¾¦ä¸­å¿ƒ"]
    TaskList -- é–‹å§‹åŸ·è¡Œ --> TaskSubmit["âœ… æäº¤å®Œæˆ"]
    TaskSubmit -- å…ˆé€²æš«å­˜ --> StagingArea["ğŸ“¦ æš«å­˜å€ (48h)"]
    StagingArea --> RecallDecision{"48h å…§æ’¤å›?"}
    RecallDecision -- æ˜¯ --> TaskList
    RecallDecision -- å¦ --> DailyReport
    StagingArea -- åŒæ­¥å“ç®¡ --> QualityMgmt["ğŸ” å“è³ªç®¡ç†"]
    SelectAction -- å›å ±å•é¡Œ --> OpenIssue
    OpenIssue --> IssueAssign["æŒ‡æ´¾è™•ç†äººå“¡<br>DB: issue_assignments"]
    IssueAssign --> IssueNotify["âš¡ Realtime æ¨é€<br>Edge Function: é€šçŸ¥é‚è¼¯"]
    IssueNotify --> IssueHandle["ğŸ‘· è™•ç†å•é¡Œ"]
    IssueHandle --> UploadIssueFix["ğŸ“· ä¸Šå‚³è™•ç†ç…§ç‰‡<br>Storage: images/"]
    UploadIssueFix --> IssueDiscuss["ğŸ’¬ è¨è«–å€æºé€š<br>DB: comments<br>Realtime è¨‚é–±"]
    IssueDiscuss --> IssueResolve{"å•é¡Œè§£æ±º?"}
    IssueResolve -- å¦ --> IssueHandle
    IssueResolve -- æ˜¯ --> CloseIssue["âœ… é—œé–‰å•é¡Œ<br>Edge Function: çµæ¡ˆé€šçŸ¥"]
    CloseIssue --> TriggerLog2["ğŸ”” è§¸ç™¼æ´»å‹•è¨˜éŒ„<br>DB Trigger"]
    TriggerLog2 --> EndIssue(["å•é¡Œçµæ¡ˆ"])
    SelectAction -- æŸ¥çœ‹å ±è¡¨ --> AnalyzeData["ğŸ“Š æ•¸æ“šåˆ†æ<br>Edge Function: çµ±è¨ˆè¨ˆç®—"]
    AnalyzeData --> QueryData["æŸ¥è©¢è³‡æ–™<br>DB: Materialized Views"]
    QueryData --> GenerateChart["ç”Ÿæˆåœ–è¡¨<br>å‰ç«¯æ¸²æŸ“"]
    GenerateChart --> ExportReport["ğŸ“„ åŒ¯å‡ºå ±è¡¨"]
    ExportReport --> EndReport(["å ±è¡¨å®Œæˆ"])
    SelectAction -- ä¸Šå‚³æ–‡ä»¶ --> UploadDoc["ğŸ“¦ ä¸Šå‚³æ–‡ä»¶<br>Storage: documents/"]
    UploadDoc --> SaveDocMeta["ğŸ’¾ å„²å­˜æ–‡ä»¶å…ƒè³‡æ–™<br>DB: documents"]
    SaveDocMeta --> PermCheck["ğŸ”’ è¨­å®šæ¬Šé™<br>RLS Policy"]
    PermCheck --> EndDoc(["æ–‡ä»¶å·²ä¸Šå‚³"])
    SelectAction -- è¨è«–å”ä½œ --> OpenDiscuss["ğŸ’¬ é–‹å•Ÿè¨è«–å€<br>DB: comments"]
    OpenDiscuss --> PostComment["ç™¼å¸ƒç•™è¨€<br>Realtime å»£æ’­"]
    PostComment --> NotifyTeam["âš¡ é€šçŸ¥åœ˜éšŠæˆå“¡<br>DB: notifications"]
    NotifyTeam --> EndDiscuss(["è¨è«–å®Œæˆ"])
     Start:::startEnd
     AuthCheck:::decision
     AuthFail:::error
     LoadUser:::process
     CheckRole:::decision
     SelectBlueprint:::decision
     SelectAction:::decision
     ForkFlow:::process
     CreateBranch:::process
     InviteOrg:::process
     BranchReady:::startEnd
     PRSubmit:::process
     ReviewFlow:::process
     MergeDecision:::decision
     CreateTask:::process
     AssignTask:::process
     TaskNotify:::realtime
     WorkStart:::process
     DailyReport:::decision
     UploadPhoto:::process
     RecordWeather:::process
     SaveReport:::process
     TriggerLog1:::storage
     CheckComplete:::decision
     SubmitQC:::process
     QCInspect:::process
     QCPhoto:::process
     QCResult:::decision
     OpenIssue:::storage
     UpdateProgress:::process
     NotifyComplete:::realtime
     EndTask:::startEnd
     RecallDecision:::decision
     IssueAssign:::process
     IssueNotify:::realtime
     IssueHandle:::process
     UploadIssueFix:::process
     IssueDiscuss:::realtime
     IssueResolve:::decision
     CloseIssue:::process
     TriggerLog2:::storage
     EndIssue:::startEnd
     AnalyzeData:::process
     QueryData:::process
     GenerateChart:::process
     ExportReport:::process
     EndReport:::startEnd
     UploadDoc:::process
     SaveDocMeta:::process
     PermCheck:::process
     EndDoc:::startEnd
     OpenDiscuss:::process
     PostComment:::process
     PostComment:::realtime
     NotifyTeam:::realtime
     EndDiscuss:::startEnd
    classDef startEnd fill:#4CAF50,stroke:#2E7D32,color:#fff,stroke-width:3px
    classDef process fill:#2196F3,stroke:#1565C0,color:#fff,stroke-width:2px
    classDef decision fill:#FF9800,stroke:#E65100,color:#fff,stroke-width:2px
    classDef storage fill:#9C27B0,stroke:#6A1B9A,color:#fff,stroke-width:2px
    classDef realtime fill:#F44336,stroke:#C62828,color:#fff,stroke-width:2px
    classDef error fill:#f44336,stroke:#c62828,color:#fff,stroke-width:2px
