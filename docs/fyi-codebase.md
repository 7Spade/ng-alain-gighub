This file is a merged representation of a subset of the codebase, containing specifically included files, combined into a single document by Repomix.
The content has been processed where line numbers have been added.

# File Summary

## Purpose
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  a. A header with the file path (## File: path/to/file)
  b. The full contents of the file in a code block

## Usage Guidelines
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: src/**/*.ts
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Line numbers have been added to the beginning of each line
- Files are sorted by Git change count (files with more changes are at the bottom)

# Directory Structure
```
src/app/app.component.ts
src/app/app.config.ts
src/app/core/i18n/i18n.service.spec.ts
src/app/core/i18n/i18n.service.ts
src/app/core/index.ts
src/app/core/infra/errors/error.types.ts
src/app/core/infra/errors/index.ts
src/app/core/infra/errors/supabase-error.transformer.ts
src/app/core/infra/index.ts
src/app/core/infra/repositories/account.repository.ts
src/app/core/infra/repositories/activity-log.repository.ts
src/app/core/infra/repositories/analytics-cache.repository.ts
src/app/core/infra/repositories/base.repository.ts
src/app/core/infra/repositories/blueprint-branch.repository.ts
src/app/core/infra/repositories/blueprint-config.repository.ts
src/app/core/infra/repositories/blueprint.repository.ts
src/app/core/infra/repositories/bot-execution-log.repository.ts
src/app/core/infra/repositories/bot-task.repository.ts
src/app/core/infra/repositories/bot.repository.ts
src/app/core/infra/repositories/branch-fork.repository.ts
src/app/core/infra/repositories/branch-permission.repository.ts
src/app/core/infra/repositories/collaboration-invitation.repository.ts
src/app/core/infra/repositories/collaboration-member.repository.ts
src/app/core/infra/repositories/comment.repository.ts
src/app/core/infra/repositories/daily-report.repository.ts
src/app/core/infra/repositories/document-thumbnail.repository.ts
src/app/core/infra/repositories/document-version.repository.ts
src/app/core/infra/repositories/document.repository.ts
src/app/core/infra/repositories/feature-flag.repository.ts
src/app/core/infra/repositories/index.ts
src/app/core/infra/repositories/inspection-photo.repository.ts
src/app/core/infra/repositories/inspection.repository.ts
src/app/core/infra/repositories/issue-assignment.repository.ts
src/app/core/infra/repositories/issue-photo.repository.ts
src/app/core/infra/repositories/issue-sync-log.repository.ts
src/app/core/infra/repositories/issue.repository.ts
src/app/core/infra/repositories/notification-rule.repository.ts
src/app/core/infra/repositories/notification-subscription.repository.ts
src/app/core/infra/repositories/notification.repository.ts
src/app/core/infra/repositories/organization-collaboration.repository.spec.ts
src/app/core/infra/repositories/organization-collaboration.repository.ts
src/app/core/infra/repositories/organization-member.repository.ts
src/app/core/infra/repositories/organization-schedule.repository.ts
src/app/core/infra/repositories/permission.repository.ts
src/app/core/infra/repositories/personal-todo.repository.ts
src/app/core/infra/repositories/progress-tracking.repository.ts
src/app/core/infra/repositories/pull-request.repository.ts
src/app/core/infra/repositories/qc-photo.repository.ts
src/app/core/infra/repositories/quality-check.repository.ts
src/app/core/infra/repositories/report-photo.repository.ts
src/app/core/infra/repositories/role-permission.repository.ts
src/app/core/infra/repositories/role.repository.ts
src/app/core/infra/repositories/setting.repository.ts
src/app/core/infra/repositories/task-assignment.repository.ts
src/app/core/infra/repositories/task-dependency.repository.ts
src/app/core/infra/repositories/task-list.repository.ts
src/app/core/infra/repositories/task-staging.repository.ts
src/app/core/infra/repositories/task-template.repository.ts
src/app/core/infra/repositories/task.repository.ts
src/app/core/infra/repositories/team-member.repository.ts
src/app/core/infra/repositories/team.repository.ts
src/app/core/infra/repositories/todo-status-tracking.repository.ts
src/app/core/infra/repositories/user-role.repository.ts
src/app/core/infra/repositories/weather-cache.repository.ts
src/app/core/infra/types/account.types.ts
src/app/core/infra/types/blueprint.types.ts
src/app/core/infra/types/collaboration.types.ts
src/app/core/infra/types/database.types.ts
src/app/core/infra/types/index.ts
src/app/core/infra/types/task.types.ts
src/app/core/infra/utils/index.ts
src/app/core/infra/utils/transformers.ts
src/app/core/menu-context/index.ts
src/app/core/menu-context/menu-context.service.ts
src/app/core/net/default.interceptor.ts
src/app/core/net/helper.ts
src/app/core/net/index.ts
src/app/core/net/refresh-token.ts
src/app/core/permissions/index.ts
src/app/core/permissions/permission.service.ts
src/app/core/permissions/role.service.ts
src/app/core/permissions/types.ts
src/app/core/services/branch-context.service.ts
src/app/core/start-page.guard.ts
src/app/core/startup/startup.service.ts
src/app/core/supabase/index.ts
src/app/core/supabase/supabase-session-adapter.service.ts
src/app/core/supabase/supabase.service.ts
src/app/layout/basic/basic.component.ts
src/app/layout/basic/widgets/clear-storage.component.ts
src/app/layout/basic/widgets/context-switcher.component.ts
src/app/layout/basic/widgets/fullscreen.component.ts
src/app/layout/basic/widgets/i18n.component.ts
src/app/layout/basic/widgets/icon.component.ts
src/app/layout/basic/widgets/notify.component.ts
src/app/layout/basic/widgets/rtl.component.ts
src/app/layout/basic/widgets/search.component.ts
src/app/layout/basic/widgets/task.component.ts
src/app/layout/basic/widgets/user.component.ts
src/app/layout/blank/blank.component.ts
src/app/layout/index.ts
src/app/layout/passport/passport.component.ts
src/app/routes/accounts/bots/bot-list.component.ts
src/app/routes/accounts/create/create-bot.component.ts
src/app/routes/accounts/create/create-organization.component.ts
src/app/routes/accounts/detail/account-detail.component.ts
src/app/routes/accounts/form/account-form.component.ts
src/app/routes/accounts/list/account-list.component.ts
src/app/routes/accounts/organizations/organization-list/organization-list.component.ts
src/app/routes/accounts/organizations/organization-member/organization-member-add.component.ts
src/app/routes/accounts/organizations/organization-member/organization-member-delete.component.ts
src/app/routes/accounts/organizations/organization-role-manage/organization-role-manage.component.ts
src/app/routes/accounts/organizations/organization-role/organization-role-edit.component.ts
src/app/routes/accounts/routes.ts
src/app/routes/accounts/schedules/schedule-list.component.ts
src/app/routes/accounts/teams/team-create/team-create.component.ts
src/app/routes/accounts/teams/team-delete/team-delete.component.ts
src/app/routes/accounts/teams/team-detail/team-detail.component.ts
src/app/routes/accounts/teams/team-edit/team-edit.component.ts
src/app/routes/accounts/teams/team-list/team-list.component.ts
src/app/routes/accounts/teams/team-member/team-member-add.component.ts
src/app/routes/accounts/teams/team-member/team-member-delete.component.ts
src/app/routes/accounts/teams/team-role-manage/team-role-manage.component.ts
src/app/routes/accounts/teams/team-role/team-role-edit.component.ts
src/app/routes/accounts/users/user-list.component.ts
src/app/routes/analytics/activity-logs/activity-log.component.ts
src/app/routes/analytics/activity-logs/detail/activity-log-detail.component.spec.ts
src/app/routes/analytics/activity-logs/detail/activity-log-detail.component.ts
src/app/routes/analytics/charts/chart-center.component.ts
src/app/routes/analytics/progress-update/progress-update.component.ts
src/app/routes/analytics/progress/progress-tracking.component.ts
src/app/routes/analytics/reports/branch-report.component.ts
src/app/routes/analytics/reports/cross-branch.component.ts
src/app/routes/analytics/reports/data-report.component.ts
src/app/routes/analytics/reports/main-report.component.ts
src/app/routes/analytics/reports/report-export.component.ts
src/app/routes/analytics/routes.ts
src/app/routes/analytics/statistics/statistics.component.ts
src/app/routes/blueprints/branches/blueprint-branches-overview.component.ts
src/app/routes/blueprints/branches/branch-detail.component.ts
src/app/routes/blueprints/branches/branch-detail/branch-detail.spec.ts
src/app/routes/blueprints/branches/branch-detail/branch-detail.ts
src/app/routes/blueprints/branches/branch-management.component.ts
src/app/routes/blueprints/detail-shell/blueprint-detail-shell.component.ts
src/app/routes/blueprints/detail/blueprint-detail.component.ts
src/app/routes/blueprints/fork/blueprint-fork-landing.component.ts
src/app/routes/blueprints/fork/blueprint-fork.component.ts
src/app/routes/blueprints/form/blueprint-form.component.ts
src/app/routes/blueprints/list/blueprint-list.component.ts
src/app/routes/blueprints/main-branch/blueprint-main-branch.component.ts
src/app/routes/blueprints/pull-requests/detail/pull-request-detail.spec.ts
src/app/routes/blueprints/pull-requests/detail/pull-request-detail.ts
src/app/routes/blueprints/pull-requests/pull-request-center.component.ts
src/app/routes/blueprints/pull-requests/pull-request-detail.component.ts
src/app/routes/blueprints/pull-requests/pull-request-form.component.ts
src/app/routes/blueprints/pull-requests/pull-request-list.component.ts
src/app/routes/blueprints/pull-requests/pull-request-merge.component.ts
src/app/routes/blueprints/pull-requests/pull-request-review.component.ts
src/app/routes/blueprints/review/blueprint-review-workspace.component.ts
src/app/routes/blueprints/review/pr-review.component.ts
src/app/routes/blueprints/routes.ts
src/app/routes/blueprints/settings-shell/blueprint-settings-shell.component.ts
src/app/routes/blueprints/settings/blueprint-settings.component.ts
src/app/routes/bots/config/bot-config.component.ts
src/app/routes/bots/executions/bot-execution.component.ts
src/app/routes/bots/list/bot-list.component.ts
src/app/routes/bots/routes.ts
src/app/routes/bots/tasks/bots-tasks-skeleton.component.spec.ts
src/app/routes/bots/tasks/bots-tasks-skeleton.component.ts
src/app/routes/collaboration/detail/collaboration-detail.component.ts
src/app/routes/collaboration/form/collaboration-form.component.ts
src/app/routes/collaboration/invitations/invitation-list.component.ts
src/app/routes/collaboration/list/collaboration-list.component.spec.ts
src/app/routes/collaboration/list/collaboration-list.component.ts
src/app/routes/collaboration/routes.ts
src/app/routes/communication/comments/comment-create.component.ts
src/app/routes/communication/comments/comment-list.component.ts
src/app/routes/communication/discussions/discussion-list.component.ts
src/app/routes/communication/notifications/detail/notification-detail.spec.ts
src/app/routes/communication/notifications/detail/notification-detail.ts
src/app/routes/communication/notifications/notification-center.component.ts
src/app/routes/communication/notifications/rules/notification-rules.component.spec.ts
src/app/routes/communication/notifications/rules/notification-rules.component.ts
src/app/routes/communication/realtime/realtime-notify.component.ts
src/app/routes/communication/routes.ts
src/app/routes/communication/team-notify/team-notify.component.ts
src/app/routes/communication/todos/todo-center.component.ts
src/app/routes/dashboard/analysis/analysis.component.ts
src/app/routes/dashboard/monitor/monitor.component.ts
src/app/routes/dashboard/routes.ts
src/app/routes/dashboard/v1/v1.component.ts
src/app/routes/dashboard/workplace/workplace.component.ts
src/app/routes/data-v/relation/relation.component.ts
src/app/routes/data-v/routes.ts
src/app/routes/delon/acl/acl.component.ts
src/app/routes/delon/cache/cache.component.ts
src/app/routes/delon/downfile/downfile.component.ts
src/app/routes/delon/form/form.component.ts
src/app/routes/delon/guard/admin.component.ts
src/app/routes/delon/guard/auth.component.ts
src/app/routes/delon/guard/can-leave.ts
src/app/routes/delon/guard/guard.component.ts
src/app/routes/delon/guard/leave.component.ts
src/app/routes/delon/print/print.component.ts
src/app/routes/delon/qr/qr.component.ts
src/app/routes/delon/routes.ts
src/app/routes/delon/st/st.component.ts
src/app/routes/delon/util/util.component.ts
src/app/routes/delon/xlsx/xlsx.component.ts
src/app/routes/delon/zip/zip.component.ts
src/app/routes/documents/browser/document-browser.component.ts
src/app/routes/documents/drawings/drawing-viewer.component.ts
src/app/routes/documents/list/document-list.component.ts
src/app/routes/documents/metadata/document-metadata.component.ts
src/app/routes/documents/permissions/document-permission.component.ts
src/app/routes/documents/preview/document-preview.component.ts
src/app/routes/documents/routes.ts
src/app/routes/documents/upload/document-upload.component.ts
src/app/routes/documents/versions/document-version.component.ts
src/app/routes/exception/exception.component.ts
src/app/routes/exception/routes.ts
src/app/routes/exception/trigger.component.ts
src/app/routes/extras/helpcenter/helpcenter.component.ts
src/app/routes/extras/poi/edit/edit.component.ts
src/app/routes/extras/poi/poi.component.ts
src/app/routes/extras/routes.ts
src/app/routes/extras/settings/settings.component.ts
src/app/routes/issues/assignments/issue-assignments.component.ts
src/app/routes/issues/close-summary/issue-close-summary.component.ts
src/app/routes/issues/close/issue-close.component.ts
src/app/routes/issues/detail-static/issue-detail-static.component.ts
src/app/routes/issues/detail/issue-detail.component.ts
src/app/routes/issues/form/issue-form.component.ts
src/app/routes/issues/handle-center/issue-handle-center.component.ts
src/app/routes/issues/handle/issue-handle.component.ts
src/app/routes/issues/list/issue-list.component.ts
src/app/routes/issues/photos-wall/issue-photos-wall.component.ts
src/app/routes/issues/photos/issue-photos.component.ts
src/app/routes/issues/routes.ts
src/app/routes/issues/sync-logs/sync-logs.spec.ts
src/app/routes/issues/sync-logs/sync-logs.ts
src/app/routes/passport/callback.component.ts
src/app/routes/passport/lock/lock.component.ts
src/app/routes/passport/login/login.component.ts
src/app/routes/passport/register-result/register-result.component.ts
src/app/routes/passport/register/register.component.ts
src/app/routes/passport/routes.ts
src/app/routes/pro/account/center/applications/applications.component.ts
src/app/routes/pro/account/center/articles/articles.component.ts
src/app/routes/pro/account/center/center.component.ts
src/app/routes/pro/account/center/projects/projects.component.ts
src/app/routes/pro/account/settings/base/base.component.ts
src/app/routes/pro/account/settings/binding/binding.component.ts
src/app/routes/pro/account/settings/notification/notification.component.ts
src/app/routes/pro/account/settings/security/security.component.ts
src/app/routes/pro/account/settings/settings.component.ts
src/app/routes/pro/form/advanced-form/advanced-form.component.ts
src/app/routes/pro/form/basic-form/basic-form.component.ts
src/app/routes/pro/form/step-form/step-form.component.ts
src/app/routes/pro/form/step-form/step1.component.ts
src/app/routes/pro/form/step-form/step2.component.ts
src/app/routes/pro/form/step-form/step3.component.ts
src/app/routes/pro/form/step-form/transfer.service.ts
src/app/routes/pro/list/applications/applications.component.ts
src/app/routes/pro/list/articles/articles.component.ts
src/app/routes/pro/list/basic-list/basic-list.component.ts
src/app/routes/pro/list/basic-list/edit/edit.component.ts
src/app/routes/pro/list/card-list/card-list.component.ts
src/app/routes/pro/list/list/list.component.ts
src/app/routes/pro/list/projects/projects.component.ts
src/app/routes/pro/list/table-list/table-list.component.ts
src/app/routes/pro/profile/advanced/advanced.component.ts
src/app/routes/pro/profile/basic/basic.component.ts
src/app/routes/pro/result/fail/fail.component.ts
src/app/routes/pro/result/success/success.component.ts
src/app/routes/pro/routes.ts
src/app/routes/quality/checks/detail/quality-check-detail.component.spec.ts
src/app/routes/quality/checks/detail/quality-check-detail.component.ts
src/app/routes/quality/checks/quality-check-detail.component.ts
src/app/routes/quality/checks/quality-check-form.component.ts
src/app/routes/quality/checks/quality-checks.component.ts
src/app/routes/quality/inspections/detail/quality-inspection-detail.spec.ts
src/app/routes/quality/inspections/detail/quality-inspection-detail.ts
src/app/routes/quality/inspections/quality-inspections.component.ts
src/app/routes/quality/photos/quality-photo-upload.component.ts
src/app/routes/quality/photos/quality-photo-viewer.component.ts
src/app/routes/quality/photos/quality-photos.component.ts
src/app/routes/quality/results/inspection-detail.component.ts
src/app/routes/quality/results/quality-results.component.ts
src/app/routes/quality/routes.ts
src/app/routes/quality/submit/quality-submit.component.ts
src/app/routes/routes.ts
src/app/routes/style/color.service.ts
src/app/routes/style/colors/colors.component.ts
src/app/routes/style/gridmasonry/gridmasonry.component.ts
src/app/routes/style/routes.ts
src/app/routes/style/typography/typography.component.ts
src/app/routes/system/activity-logs/system-activity-log.component.ts
src/app/routes/system/backup/backup.spec.ts
src/app/routes/system/backup/backup.ts
src/app/routes/system/branch-permissions/branch-permission.component.ts
src/app/routes/system/feature-flags/feature-flag.component.ts
src/app/routes/system/permission-matrix/permission-matrix.component.ts
src/app/routes/system/permissions/permission-assignment.component.ts
src/app/routes/system/roles/role-management.component.ts
src/app/routes/system/routes.ts
src/app/routes/system/settings/global/global-settings.component.spec.ts
src/app/routes/system/settings/global/global-settings.component.ts
src/app/routes/system/settings/personal/personal-settings.component.spec.ts
src/app/routes/system/settings/personal/personal-settings.component.ts
src/app/routes/system/settings/project/project-settings.component.spec.ts
src/app/routes/system/settings/project/project-settings.component.ts
src/app/routes/system/settings/system-settings.component.ts
src/app/routes/system/weather-api/weather-api.component.ts
src/app/routes/tasks/assignments/task-assignments.component.ts
src/app/routes/tasks/board/task-board.component.ts
src/app/routes/tasks/calendar/task-calendar.component.ts
src/app/routes/tasks/daily-reports/daily-report-detail.component.ts
src/app/routes/tasks/daily-reports/daily-report-form.component.ts
src/app/routes/tasks/daily-reports/daily-reports.component.ts
src/app/routes/tasks/detail-shell/task-detail-shell.component.ts
src/app/routes/tasks/detail/task-detail.component.ts
src/app/routes/tasks/form-hub/task-form-hub.component.ts
src/app/routes/tasks/form/task-form.component.ts
src/app/routes/tasks/list/task-list.component.spec.ts
src/app/routes/tasks/list/task-list.component.ts
src/app/routes/tasks/photos/photo-upload.component.ts
src/app/routes/tasks/photos/photo-viewer.component.ts
src/app/routes/tasks/photos/task-photos.component.ts
src/app/routes/tasks/progress/task-progress.spec.ts
src/app/routes/tasks/progress/task-progress.ts
src/app/routes/tasks/routes.ts
src/app/routes/tasks/staging/task-staging.component.ts
src/app/routes/tasks/todo/task-todo.component.ts
src/app/routes/tasks/weather/task-weather.component.ts
src/app/routes/widgets/routes.ts
src/app/routes/widgets/widgets/widgets.component.ts
src/app/shared/cell-widget/index.ts
src/app/shared/components/account-selector/account-selector.component.ts
src/app/shared/components/account-selector/index.ts
src/app/shared/components/chart-wrapper/chart-wrapper.component.ts
src/app/shared/components/chart-wrapper/index.ts
src/app/shared/components/comment-thread/comment-thread.component.ts
src/app/shared/components/comment-thread/index.ts
src/app/shared/components/confirmation-dialog/confirmation-dialog.service.spec.ts
src/app/shared/components/confirmation-dialog/confirmation-dialog.service.ts
src/app/shared/components/confirmation-dialog/index.ts
src/app/shared/components/empty-state/empty-state.component.spec.ts
src/app/shared/components/empty-state/empty-state.component.ts
src/app/shared/components/empty-state/index.ts
src/app/shared/components/form-error/form-error.component.spec.ts
src/app/shared/components/form-error/form-error.component.ts
src/app/shared/components/form-error/index.ts
src/app/shared/components/loading-indicator/index.ts
src/app/shared/components/loading-indicator/loading-indicator.component.spec.ts
src/app/shared/components/loading-indicator/loading-indicator.component.ts
src/app/shared/components/photo-gallery/index.ts
src/app/shared/components/photo-gallery/photo-gallery.component.ts
src/app/shared/components/qc-camera/index.ts
src/app/shared/components/qc-camera/qc-camera.component.ts
src/app/shared/components/todo-widget/index.ts
src/app/shared/components/todo-widget/todo-widget.component.ts
src/app/shared/index.ts
src/app/shared/json-schema/index.ts
src/app/shared/json-schema/test/test.widget.ts
src/app/shared/models/account.models.ts
src/app/shared/models/blueprint.models.ts
src/app/shared/models/bot.models.ts
src/app/shared/models/collaboration.models.ts
src/app/shared/models/communication.models.ts
src/app/shared/models/data.models.ts
src/app/shared/models/index.ts
src/app/shared/models/issue.models.ts
src/app/shared/models/permission.models.ts
src/app/shared/models/quality.models.ts
src/app/shared/models/system.models.ts
src/app/shared/models/task.models.ts
src/app/shared/services/account/account.service.spec.ts
src/app/shared/services/account/account.service.ts
src/app/shared/services/account/index.ts
src/app/shared/services/account/organization-member.service.ts
src/app/shared/services/account/organization-schedule.service.ts
src/app/shared/services/account/team.service.spec.ts
src/app/shared/services/account/team.service.ts
src/app/shared/services/analytics.service.ts
src/app/shared/services/auth/auth.service.ts
src/app/shared/services/auth/auth.state.ts
src/app/shared/services/auth/auth.types.ts
src/app/shared/services/auth/index.ts
src/app/shared/services/blueprint/blueprint.service.ts
src/app/shared/services/blueprint/branch-data-isolation.service.ts
src/app/shared/services/blueprint/branch.service.ts
src/app/shared/services/blueprint/index.ts
src/app/shared/services/blueprint/pull-request.service.ts
src/app/shared/services/collaboration/collaboration.service.spec.ts
src/app/shared/services/collaboration/collaboration.service.ts
src/app/shared/services/collaboration/index.ts
src/app/shared/services/collaboration/invitation.service.spec.ts
src/app/shared/services/collaboration/invitation.service.ts
src/app/shared/services/index.ts
src/app/shared/services/permission/branch-permission.service.ts
src/app/shared/services/permission/index.ts
src/app/shared/services/quality-check.service.ts
src/app/shared/services/supabase-adapter.service.ts
src/app/shared/services/task/index.ts
src/app/shared/services/task/task-staging.service.ts
src/app/shared/services/task/task-state-machine.ts
src/app/shared/services/task/task.service.ts
src/app/shared/services/todo/index.ts
src/app/shared/services/todo/personal-todo.service.ts
src/app/shared/shared-delon.module.ts
src/app/shared/shared-imports.ts
src/app/shared/shared-tinymce.module.ts
src/app/shared/shared-zorro.module.ts
src/app/shared/st-widget/index.ts
src/app/shared/utils/yuan.ts
src/environments/environment.prod.ts
src/environments/environment.ts
src/main.ts
src/style-icons-auto.ts
src/style-icons.ts
src/typings.d.ts
```

# Files

## File: src/app/app.component.ts
````typescript
 1: import { Component, OnInit, inject } from '@angular/core';
 2: import { NavigationEnd, NavigationError, RouteConfigLoadStart, Router, RouterOutlet } from '@angular/router';
 3: import { TitleService, VERSION as VERSION_ALAIN, stepPreloader } from '@delon/theme';
 4: import { environment } from '@env/environment';
 5: import { NzModalService } from 'ng-zorro-antd/modal';
 6: import { VERSION as VERSION_ZORRO } from 'ng-zorro-antd/version';
 7: 
 8: @Component({
 9:   selector: 'app-root',
10:   template: `<router-outlet />`,
11:   imports: [RouterOutlet],
12:   host: {
13:     '[attr.ng-alain-version]': 'ngAlainVersion',
14:     '[attr.ng-zorro-version]': 'ngZorroVersion'
15:   }
16: })
17: export class AppComponent implements OnInit {
18:   private readonly router = inject(Router);
19:   private readonly titleSrv = inject(TitleService);
20:   private readonly modalSrv = inject(NzModalService);
21:   ngAlainVersion = VERSION_ALAIN.full;
22:   ngZorroVersion = VERSION_ZORRO.full;
23: 
24:   private donePreloader = stepPreloader();
25: 
26:   ngOnInit(): void {
27:     let configLoad = false;
28:     this.router.events.subscribe(ev => {
29:       if (ev instanceof RouteConfigLoadStart) {
30:         configLoad = true;
31:       }
32:       if (configLoad && ev instanceof NavigationError) {
33:         this.modalSrv.confirm({
34:           nzTitle: `æé†’`,
35:           nzContent: environment.production ? `åº”ç”¨å¯èƒ½å·²å‘å¸ƒæ–°ç‰ˆæœ¬ï¼Œè¯·ç‚¹å‡»åˆ·æ–°æ‰èƒ½ç”Ÿæ•ˆã€‚` : `æ— æ³•åŠ è½½è·¯ç”±ï¼š${ev.url}`,
36:           nzCancelDisabled: false,
37:           nzOkText: 'åˆ·æ–°',
38:           nzCancelText: 'å¿½ç•¥',
39:           nzOnOk: () => location.reload()
40:         });
41:       }
42:       if (ev instanceof NavigationEnd) {
43:         this.donePreloader();
44:         this.titleSrv.setTitle();
45:         this.modalSrv.closeAll();
46:       }
47:     });
48:   }
49: }
````

## File: src/app/app.config.ts
````typescript
 1: import { provideHttpClient, withInterceptors } from '@angular/common/http';
 2: import { default as ngLang } from '@angular/common/locales/zh';
 3: import { ApplicationConfig, EnvironmentProviders, Provider } from '@angular/core';
 4: import { provideAnimations } from '@angular/platform-browser/animations';
 5: import {
 6:   provideRouter,
 7:   withComponentInputBinding,
 8:   withInMemoryScrolling,
 9:   withHashLocation,
10:   RouterFeatures,
11:   withViewTransitions
12: } from '@angular/router';
13: import { I18NService, defaultInterceptor, provideBindAuthRefresh, provideStartup } from '@core';
14: import { provideCellWidgets } from '@delon/abc/cell';
15: import { provideSTWidgets } from '@delon/abc/st';
16: import { authSimpleInterceptor, provideAuth } from '@delon/auth';
17: import { provideSFConfig } from '@delon/form';
18: import { AlainProvideLang, provideAlain, zh_CN as delonLang } from '@delon/theme';
19: import { AlainConfig } from '@delon/util/config';
20: import { environment } from '@env/environment';
21: import { CELL_WIDGETS, SF_WIDGETS, ST_WIDGETS } from '@shared';
22: import { zhCN as dateLang } from 'date-fns/locale';
23: import { NzConfig, provideNzConfig } from 'ng-zorro-antd/core/config';
24: import { zh_CN as zorroLang } from 'ng-zorro-antd/i18n';
25: 
26: import { ICONS } from '../style-icons';
27: import { ICONS_AUTO } from '../style-icons-auto';
28: import { routes } from './routes/routes';
29: 
30: const defaultLang: AlainProvideLang = {
31:   abbr: 'zh-CN',
32:   ng: ngLang,
33:   zorro: zorroLang,
34:   date: dateLang,
35:   delon: delonLang
36: };
37: 
38: const alainConfig: AlainConfig = {
39:   st: { modal: { size: 'lg' } },
40:   pageHeader: { homeI18n: 'home' },
41:   lodop: {
42:     license: `A59B099A586B3851E0F0D7FDBF37B603`,
43:     licenseA: `C94CEE276DB2187AE6B65D56B3FC2848`
44:   },
45:   auth: { login_url: '/passport/login' }
46: };
47: 
48: const ngZorroConfig: NzConfig = {};
49: 
50: const routerFeatures: RouterFeatures[] = [
51:   withComponentInputBinding(),
52:   withViewTransitions(),
53:   withInMemoryScrolling({ scrollPositionRestoration: 'top' })
54: ];
55: if (environment.useHash) routerFeatures.push(withHashLocation());
56: 
57: const providers: Array<Provider | EnvironmentProviders> = [
58:   provideHttpClient(withInterceptors([...(environment.interceptorFns ?? []), authSimpleInterceptor, defaultInterceptor])),
59:   provideAnimations(),
60:   provideRouter(routes, ...routerFeatures),
61:   provideAlain({ config: alainConfig, defaultLang, i18nClass: I18NService, icons: [...ICONS_AUTO, ...ICONS] }),
62:   provideNzConfig(ngZorroConfig),
63:   provideAuth(),
64:   provideCellWidgets(...CELL_WIDGETS),
65:   provideSTWidgets(...ST_WIDGETS),
66:   provideSFConfig({ widgets: SF_WIDGETS }),
67:   provideStartup(),
68:   ...(environment.providers || [])
69: ];
70: 
71: // If you use `@delon/auth` to refresh the token, additional registration `provideBindAuthRefresh` is required
72: if (environment.api?.refreshTokenEnabled && environment.api.refreshTokenType === 'auth-refresh') {
73:   providers.push(provideBindAuthRefresh());
74: }
75: 
76: export const appConfig: ApplicationConfig = {
77:   providers: providers
78: };
````

## File: src/app/core/i18n/i18n.service.spec.ts
````typescript
 1: import { provideHttpClient, withInterceptorsFromDi } from '@angular/common/http';
 2: import { provideHttpClientTesting } from '@angular/common/http/testing';
 3: import { TestBed } from '@angular/core/testing';
 4: import { DelonLocaleService, SettingsService } from '@delon/theme';
 5: import { NzSafeAny } from 'ng-zorro-antd/core/types';
 6: import { NzI18nService } from 'ng-zorro-antd/i18n';
 7: 
 8: import { I18NService } from './i18n.service';
 9: 
10: describe('Service: I18n', () => {
11:   let srv: I18NService;
12:   const MockSettingsService: NzSafeAny = {
13:     layout: {
14:       lang: null
15:     }
16:   };
17:   const MockNzI18nService = {
18:     setLocale: () => {},
19:     setDateLocale: () => {}
20:   };
21:   const MockDelonLocaleService = {
22:     setLocale: () => {}
23:   };
24: 
25:   function genModule(): void {
26:     TestBed.configureTestingModule({
27:       imports: [],
28:       providers: [
29:         I18NService,
30:         { provide: SettingsService, useValue: MockSettingsService },
31:         { provide: NzI18nService, useValue: MockNzI18nService },
32:         { provide: DelonLocaleService, useValue: MockDelonLocaleService },
33:         provideHttpClient(withInterceptorsFromDi()),
34:         provideHttpClientTesting()
35:       ]
36:     });
37:     srv = TestBed.inject(I18NService);
38:   }
39: 
40:   it('should working', () => {
41:     spyOnProperty(navigator, 'languages').and.returnValue(['zh-CN']);
42:     genModule();
43:     expect(srv).toBeTruthy();
44:     expect(srv.defaultLang).toBe('zh-CN');
45:     srv.fanyi('a');
46:     srv.fanyi('a', {});
47:   });
48: 
49:   it('should be used layout as default language', () => {
50:     MockSettingsService.layout.lang = 'en-US';
51:     const navSpy = spyOnProperty(navigator, 'languages');
52:     genModule();
53:     expect(navSpy).not.toHaveBeenCalled();
54:     expect(srv.defaultLang).toBe('en-US');
55:     MockSettingsService.layout.lang = null;
56:   });
57: 
58:   it('should be used browser as default language', () => {
59:     spyOnProperty(navigator, 'languages').and.returnValue(['zh-TW']);
60:     genModule();
61:     expect(srv.defaultLang).toBe('zh-TW');
62:   });
63: 
64:   it('should be use default language when the browser language is not in the list', () => {
65:     spyOnProperty(navigator, 'languages').and.returnValue(['es-419']);
66:     genModule();
67:     expect(srv.defaultLang).toBe('zh-CN');
68:   });
69: 
70:   it('should be trigger notify when changed language', () => {
71:     genModule();
72:     srv.use('en-US', {});
73:     srv.change.subscribe(lang => {
74:       expect(lang).toBe('en-US');
75:     });
76:   });
77: });
````

## File: src/app/core/i18n/i18n.service.ts
````typescript
  1: // è¯·å‚è€ƒï¼šhttps://ng-alain.com/docs/i18n
  2: import { Platform } from '@angular/cdk/platform';
  3: import { registerLocaleData } from '@angular/common';
  4: import ngEn from '@angular/common/locales/en';
  5: import ngZh from '@angular/common/locales/zh';
  6: import ngZhTw from '@angular/common/locales/zh-Hant';
  7: import { Injectable, inject } from '@angular/core';
  8: import {
  9:   DelonLocaleService,
 10:   en_US as delonEnUS,
 11:   SettingsService,
 12:   zh_CN as delonZhCn,
 13:   zh_TW as delonZhTw,
 14:   _HttpClient,
 15:   AlainI18nBaseService
 16: } from '@delon/theme';
 17: import { enUS as dfEn, zhCN as dfZhCn, zhTW as dfZhTw } from 'date-fns/locale';
 18: import { NzSafeAny } from 'ng-zorro-antd/core/types';
 19: import { en_US as zorroEnUS, NzI18nService, zh_CN as zorroZhCN, zh_TW as zorroZhTW } from 'ng-zorro-antd/i18n';
 20: import { Observable } from 'rxjs';
 21: 
 22: interface LangConfigData {
 23:   abbr: string;
 24:   text: string;
 25:   ng: NzSafeAny;
 26:   zorro: NzSafeAny;
 27:   date: NzSafeAny;
 28:   delon: NzSafeAny;
 29: }
 30: 
 31: const DEFAULT = 'zh-CN';
 32: const LANGS: Record<string, LangConfigData> = {
 33:   'zh-CN': {
 34:     text: 'ç®€ä½“ä¸­æ–‡',
 35:     ng: ngZh,
 36:     zorro: zorroZhCN,
 37:     date: dfZhCn,
 38:     delon: delonZhCn,
 39:     abbr: 'ğŸ‡¨ğŸ‡³'
 40:   },
 41:   'zh-TW': {
 42:     text: 'ç¹ä½“ä¸­æ–‡',
 43:     ng: ngZhTw,
 44:     zorro: zorroZhTW,
 45:     date: dfZhTw,
 46:     delon: delonZhTw,
 47:     abbr: 'ğŸ‡­ğŸ‡°'
 48:   },
 49:   'en-US': {
 50:     text: 'English',
 51:     ng: ngEn,
 52:     zorro: zorroEnUS,
 53:     date: dfEn,
 54:     delon: delonEnUS,
 55:     abbr: 'ğŸ‡¬ğŸ‡§'
 56:   }
 57: };
 58: 
 59: @Injectable({ providedIn: 'root' })
 60: export class I18NService extends AlainI18nBaseService {
 61:   private readonly http = inject(_HttpClient);
 62:   private readonly settings = inject(SettingsService);
 63:   private readonly nzI18nService = inject(NzI18nService);
 64:   private readonly delonLocaleService = inject(DelonLocaleService);
 65:   private readonly platform = inject(Platform);
 66: 
 67:   protected override _defaultLang = DEFAULT;
 68:   private _langs = Object.keys(LANGS).map(code => {
 69:     const item = LANGS[code];
 70:     return { code, text: item.text, abbr: item.abbr };
 71:   });
 72: 
 73:   constructor() {
 74:     super();
 75: 
 76:     const defaultLang = this.getDefaultLang();
 77:     this._defaultLang = this._langs.findIndex(w => w.code === defaultLang) === -1 ? DEFAULT : defaultLang;
 78:   }
 79: 
 80:   private getDefaultLang(): string {
 81:     if (!this.platform.isBrowser) {
 82:       return DEFAULT;
 83:     }
 84:     if (this.settings.layout.lang) {
 85:       return this.settings.layout.lang;
 86:     }
 87:     let res = (navigator.languages ? navigator.languages[0] : null) || navigator.language;
 88:     const arr = res.split('-');
 89:     return arr.length <= 1 ? res : `${arr[0]}-${arr[1].toUpperCase()}`;
 90:   }
 91: 
 92:   loadLangData(lang: string): Observable<NzSafeAny> {
 93:     return this.http.get(`./assets/tmp/i18n/${lang}.json`);
 94:   }
 95: 
 96:   use(lang: string, data: Record<string, unknown>): void {
 97:     if (this._currentLang === lang) return;
 98: 
 99:     this._data = this.flatData(data, []);
100: 
101:     const item = LANGS[lang];
102:     registerLocaleData(item.ng);
103:     this.nzI18nService.setLocale(item.zorro);
104:     this.nzI18nService.setDateLocale(item.date);
105:     this.delonLocaleService.setLocale(item.delon);
106:     this._currentLang = lang;
107: 
108:     this._change$.next(lang);
109:   }
110: 
111:   getLangs(): Array<{ code: string; text: string; abbr: string }> {
112:     return this._langs;
113:   }
114: }
````

## File: src/app/core/infra/errors/error.types.ts
````typescript
 1: /**
 2:  * é”™è¯¯ç±»å‹å®šä¹‰
 3:  *
 4:  * æä¾›ç»Ÿä¸€çš„é”™è¯¯ç±»å‹ï¼Œä¸ç°æœ‰é”™è¯¯å¤„ç†æ¨¡å¼å…¼å®¹
 5:  */
 6: 
 7: /**
 8:  * é”™è¯¯ç±»å‹æšä¸¾
 9:  */
10: export type ErrorType = 'http' | 'network' | 'validation' | 'business' | 'permission' | 'unknown';
11: 
12: /**
13:  * é”™è¯¯ä¸¥é‡ç¨‹åº¦
14:  */
15: export type ErrorSeverity = 'critical' | 'error' | 'warning' | 'info';
16: 
17: /**
18:  * åº”ç”¨é”™è¯¯æ¥å£
19:  * æ‰©å±•æ ‡å‡† Errorï¼Œæ·»åŠ é¢å¤–ä¿¡æ¯
20:  */
21: export interface AppError extends Error {
22:   /** é”™è¯¯ç±»å‹ */
23:   type: ErrorType;
24:   /** é”™è¯¯ä¸¥é‡ç¨‹åº¦ */
25:   severity: ErrorSeverity;
26:   /** é”™è¯¯ä»£ç ï¼ˆå¯é€‰ï¼‰ */
27:   code?: string;
28:   /** é”™è¯¯è¯¦æƒ…ï¼ˆå¯é€‰ï¼‰ */
29:   details?: string;
30:   /** é”™è¯¯æ¥æºï¼ˆå¯é€‰ï¼‰ */
31:   source?: string;
32:   /** å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰ */
33:   metadata?: Record<string, unknown>;
34:   /** æ˜¯å¦å¯é‡è¯• */
35:   retryable?: boolean;
36: }
37: 
38: /**
39:  * åˆ›å»ºåº”ç”¨é”™è¯¯
40:  */
41: export function createAppError(
42:   message: string,
43:   type: ErrorType = 'unknown',
44:   severity: ErrorSeverity = 'error',
45:   options?: {
46:     code?: string;
47:     details?: string;
48:     source?: string;
49:     metadata?: Record<string, unknown>;
50:     retryable?: boolean;
51:   }
52: ): AppError {
53:   const error = new Error(message) as AppError;
54:   error.type = type;
55:   error.severity = severity;
56:   error.code = options?.code;
57:   error.details = options?.details;
58:   error.source = options?.source;
59:   error.metadata = options?.metadata;
60:   error.retryable = options?.retryable ?? false;
61:   return error;
62: }
````

## File: src/app/core/infra/errors/index.ts
````typescript
1: /**
2:  * é”™è¯¯å¤„ç†æ¨¡å—å¯¼å‡º
3:  */
4: export * from './error.types';
5: export * from './supabase-error.transformer';
````

## File: src/app/core/infra/errors/supabase-error.transformer.ts
````typescript
 1: import { PostgrestError } from '@supabase/supabase-js';
 2: 
 3: import { AppError, createAppError, ErrorType, ErrorSeverity } from './error.types';
 4: 
 5: /**
 6:  * Supabase é”™è¯¯ä»£ç æ˜ å°„
 7:  */
 8: const SUPABASE_ERROR_CODES: Record<string, { type: ErrorType; severity: ErrorSeverity; message: string }> = {
 9:   // è®¤è¯é”™è¯¯
10:   PGRST301: { type: 'permission', severity: 'error', message: 'æœªæˆæƒè®¿é—®' },
11:   PGRST116: { type: 'business', severity: 'warning', message: 'èµ„æºä¸å­˜åœ¨' },
12: 
13:   // æ•°æ®éªŒè¯é”™è¯¯
14:   '23505': { type: 'validation', severity: 'error', message: 'æ•°æ®å·²å­˜åœ¨ï¼Œè¿åå”¯ä¸€æ€§çº¦æŸ' },
15:   '23503': { type: 'validation', severity: 'error', message: 'å¤–é”®çº¦æŸè¿å' },
16:   '23502': { type: 'validation', severity: 'error', message: 'å¿…å¡«å­—æ®µä¸ºç©º' },
17:   '23514': { type: 'validation', severity: 'error', message: 'æ£€æŸ¥çº¦æŸè¿å' },
18: 
19:   // æƒé™é”™è¯¯
20:   '42501': { type: 'permission', severity: 'error', message: 'æƒé™ä¸è¶³' },
21: 
22:   // ç½‘ç»œé”™è¯¯
23:   PGRST204: { type: 'network', severity: 'error', message: 'è¯·æ±‚è¶…æ—¶' }
24: };
25: 
26: /**
27:  * å°† Supabase PostgrestError è½¬æ¢ä¸º AppError
28:  *
29:  * @param error Supabase é”™è¯¯
30:  * @param source é”™è¯¯æ¥æºï¼ˆå¯é€‰ï¼‰
31:  * @returns AppError
32:  */
33: export function transformSupabaseError(error: PostgrestError, source?: string): AppError {
34:   const errorCode = error.code || '';
35:   const errorInfo = SUPABASE_ERROR_CODES[errorCode];
36: 
37:   if (errorInfo) {
38:     return createAppError(errorInfo.message, errorInfo.type, errorInfo.severity, {
39:       code: errorCode,
40:       details: error.message || error.details || '',
41:       source,
42:       metadata: {
43:         hint: error.hint,
44:         details: error.details
45:       },
46:       retryable: errorInfo.type === 'network'
47:     });
48:   }
49: 
50:   // é»˜è®¤é”™è¯¯å¤„ç†
51:   return createAppError(error.message || 'æ•°æ®åº“æ“ä½œå¤±è´¥', 'unknown', 'error', {
52:     code: errorCode,
53:     details: error.details || '',
54:     source,
55:     metadata: {
56:       hint: error.hint,
57:       details: error.details
58:     },
59:     retryable: false
60:   });
61: }
62: 
63: /**
64:  * æ£€æŸ¥ Supabase å“åº”å¹¶å¤„ç†é”™è¯¯
65:  *
66:  * @param response Supabase å“åº” { data, error }
67:  * @param source é”™è¯¯æ¥æºï¼ˆå¯é€‰ï¼‰
68:  * @throws AppError å¦‚æœæœ‰é”™è¯¯
69:  */
70: export function handleSupabaseResponse<T>(response: { data: T | null; error: PostgrestError | null }, source?: string): T {
71:   if (response.error) {
72:     throw transformSupabaseError(response.error, source);
73:   }
74: 
75:   if (response.data === null) {
76:     throw createAppError('æ•°æ®ä¸å­˜åœ¨', 'business', 'warning', { source });
77:   }
78: 
79:   return response.data;
80: }
````

## File: src/app/core/infra/index.ts
````typescript
1: /**
2:  * åŸºç¡€è®¾æ–½æ¨¡å—ç»Ÿä¸€å¯¼å‡º
3:  */
4: export * from './repositories';
5: export * from './types';
6: export * from './errors';
7: export * from './utils';
````

## File: src/app/core/infra/repositories/account.repository.ts
````typescript
  1: import { Injectable, inject } from '@angular/core';
  2: import { Observable, from, of } from 'rxjs';
  3: import { map, switchMap } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { SupabaseService } from '../../supabase/supabase.service';
  7: import { AccountStatus, AccountType } from '../types/account.types';
  8: import { Database } from '../types/database.types';
  9: import { toCamelCaseData } from '../utils/transformers';
 10: 
 11: /**
 12:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 13:  */
 14: type AccountRow = Database['public']['Tables']['accounts']['Row'];
 15: type AccountInsert = Database['public']['Tables']['accounts']['Insert'];
 16: type AccountUpdate = Database['public']['Tables']['accounts']['Update'];
 17: 
 18: /**
 19:  * Account å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 20:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 21:  */
 22: export type Account = AccountRow;
 23: export type { AccountInsert, AccountUpdate };
 24: 
 25: /**
 26:  * Account Repository
 27:  *
 28:  * æä¾›è´¦æˆ·ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 29:  *
 30:  * @example
 31:  * ```typescript
 32:  * const accountRepo = inject(AccountRepository);
 33:  * accountRepo.findByType(AccountType.USER).subscribe(accounts => {
 34:  *   console.log('User accounts:', accounts);
 35:  * });
 36:  * ```
 37:  */
 38: @Injectable({
 39:   providedIn: 'root'
 40: })
 41: export class AccountRepository extends BaseRepository<Account, AccountInsert, AccountUpdate> {
 42:   protected tableName = 'accounts';
 43:   private readonly supabaseService = inject(SupabaseService);
 44: 
 45:   /**
 46:    * æ ¹æ®è´¦æˆ·ç±»å‹æŸ¥è¯¢è´¦æˆ·
 47:    *
 48:    * @param type è´¦æˆ·ç±»å‹
 49:    * @param options æŸ¥è¯¢é€‰é¡¹
 50:    * @returns Observable<Account[]>
 51:    */
 52:   findByType(type: AccountType, options?: QueryOptions): Observable<Account[]> {
 53:     return this.findAll({
 54:       ...options,
 55:       filters: {
 56:         ...options?.filters,
 57:         type
 58:       }
 59:     });
 60:   }
 61: 
 62:   /**
 63:    * æ ¹æ®çŠ¶æ€æŸ¥è¯¢è´¦æˆ·
 64:    *
 65:    * @param status è´¦æˆ·çŠ¶æ€
 66:    * @param options æŸ¥è¯¢é€‰é¡¹
 67:    * @returns Observable<Account[]>
 68:    */
 69:   findByStatus(status: AccountStatus, options?: QueryOptions): Observable<Account[]> {
 70:     return this.findAll({
 71:       ...options,
 72:       filters: {
 73:         ...options?.filters,
 74:         status
 75:       }
 76:     });
 77:   }
 78: 
 79:   /**
 80:    * æ ¹æ® auth_user_id æŸ¥è¯¢è´¦æˆ·
 81:    *
 82:    * @param authUserId è®¤è¯ç”¨æˆ· ID
 83:    * @returns Observable<Account | null>
 84:    */
 85:   findByAuthUserId(authUserId: string): Observable<Account | null> {
 86:     return this.findAll({
 87:       filters: {
 88:         authUserId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º auth_user_id
 89:       }
 90:     }).pipe(map(accounts => (accounts.length > 0 ? accounts[0] : null)));
 91:   }
 92: 
 93:   /**
 94:    * æ ¹æ® auth_organization_id æŸ¥è¯¢è´¦æˆ·ï¼ˆç”¨äºæŸ¥è¯¢ç”¨æˆ·åˆ›å»ºçš„ç»„ç»‡è´¦æˆ·ï¼‰
 95:    * æ³¨æ„ï¼šä¸€ä¸ªç”¨æˆ·å¯èƒ½åˆ›å»ºå¤šä¸ªç»„ç»‡è´¦æˆ·ï¼Œæ‰€ä»¥è¿”å›æ•°ç»„
 96:    *
 97:    * @param authOrganizationId åˆ›å»ºè€…ç”¨æˆ· ID
 98:    * @returns Observable<Account[]>
 99:    */
100:   findByAuthOrganizationId(authOrganizationId: string): Observable<Account[]> {
101:     return this.findAll({
102:       filters: {
103:         authOrganizationId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º auth_organization_id
104:       }
105:     });
106:   }
107: 
108:   /**
109:    * æ ¹æ®å¤šä¸ª ID æ‰¹é‡æŸ¥è¯¢è´¦æˆ·
110:    *
111:    * @param ids è´¦æˆ· ID æ•°ç»„
112:    * @returns Observable<Account[]>
113:    */
114:   findByIds(ids: string[]): Observable<Account[]> {
115:     if (ids.length === 0) {
116:       return of([]);
117:     }
118:     // ä½¿ç”¨ Supabase çš„ in æŸ¥è¯¢
119:     return from(this.supabaseService.client.from(this.tableName).select('*').in('id', ids)).pipe(
120:       map((response: { data: any[] | null; error: any }) => {
121:         if (response.error) {
122:           throw new Error(response.error.message || 'æ‰¹é‡æŸ¥è¯¢è´¦æˆ·å¤±è´¥');
123:         }
124:         // ä½¿ç”¨è½¬æ¢å·¥å…·å‡½æ•°
125:         return (response.data || []).map(item => toCamelCaseData<Account>(item));
126:       })
127:     );
128:   }
129: 
130:   /**
131:    * æ ¹æ®é‚®ç®±æŸ¥è¯¢è´¦æˆ·
132:    *
133:    * @param email é‚®ç®±åœ°å€
134:    * @returns Observable<Account | null>
135:    */
136:   findByEmail(email: string): Observable<Account | null> {
137:     return this.findAll({
138:       filters: {
139:         email
140:       }
141:     }).pipe(map(accounts => (accounts.length > 0 ? accounts[0] : null)));
142:   }
143: 
144:   /**
145:    * æ ¹æ®åç§°æŸ¥è¯¢è´¦æˆ·
146:    * ç”¨äºé€šè¿‡ç”¨æˆ·å/ç»„ç»‡åæŸ¥æ‰¾è´¦æˆ·ï¼ˆç±»ä¼¼ GitHub çš„ /:username è·¯ç”±ï¼‰
147:    *
148:    * @param name è´¦æˆ·åç§°
149:    * @returns Observable<Account | null>
150:    */
151:   findByName(name: string): Observable<Account | null> {
152:     return this.findAll({
153:       filters: {
154:         name
155:       }
156:     }).pipe(map(accounts => (accounts.length > 0 ? accounts[0] : null)));
157:   }
158: 
159:   /**
160:    * æŸ¥è¯¢æ´»è·ƒçš„è´¦æˆ·ï¼ˆçŠ¶æ€ä¸º activeï¼‰
161:    *
162:    * @param options æŸ¥è¯¢é€‰é¡¹
163:    * @returns Observable<Account[]>
164:    */
165:   findActive(options?: QueryOptions): Observable<Account[]> {
166:     return this.findByStatus(AccountStatus.ACTIVE, options);
167:   }
168: 
169:   /**
170:    * åˆ›å»º Organization è´¦æˆ·ï¼ˆä½¿ç”¨ SECURITY DEFINER å‡½æ•°ç»•è¿‡ RLSï¼‰
171:    *
172:    * @param name ç»„ç»‡åç§°
173:    * @param email é‚®ç®±ï¼ˆå¯é€‰ï¼‰
174:    * @param status è´¦æˆ·çŠ¶æ€ï¼ˆé»˜è®¤ 'active'ï¼‰
175:    * @returns Observable<Account>
176:    */
177:   createOrganizationAccount(name: string, email?: string | null, status: AccountStatus = AccountStatus.ACTIVE): Observable<Account> {
178:     // è°ƒç”¨ RPC å‡½æ•°åˆ›å»ºç»„ç»‡è´¦æˆ·
179:     return from(
180:       this.supabaseService.client.rpc('create_organization_account', {
181:         p_name: name,
182:         p_email: email || null,
183:         p_status: status
184:       })
185:     ).pipe(
186:       map((response: { data: string | null; error: any }) => {
187:         if (response.error) {
188:           throw new Error(response.error.message || 'åˆ›å»ºç»„ç»‡è´¦æˆ·å¤±è´¥');
189:         }
190:         if (!response.data) {
191:           throw new Error('åˆ›å»ºç»„ç»‡è´¦æˆ·å¤±è´¥ï¼šæœªè¿”å›è´¦æˆ· ID');
192:         }
193:         return response.data;
194:       }),
195:       // ä½¿ç”¨è¿”å›çš„è´¦æˆ· ID æŸ¥è¯¢å®Œæ•´çš„è´¦æˆ·ä¿¡æ¯
196:       // RLS ç­–ç•¥å·²æ›´æ–°ï¼Œå…è®¸ç”¨æˆ·æŸ¥çœ‹è‡ªå·±åˆ›å»ºçš„ç»„ç»‡è´¦æˆ·ï¼ˆauth_organization_id = auth.uid()ï¼‰
197:       switchMap((accountId: string) =>
198:         this.findById(accountId).pipe(
199:           map((account: Account | null) => {
200:             if (!account) {
201:               throw new Error('åˆ›å»ºç»„ç»‡è´¦æˆ·å¤±è´¥ï¼šæ— æ³•æŸ¥è¯¢åˆ°åˆ›å»ºçš„è´¦æˆ·ã€‚è¯·æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦å…è®¸æŸ¥çœ‹è‡ªå·±åˆ›å»ºçš„ç»„ç»‡è´¦æˆ·ã€‚');
202:             }
203:             return account;
204:           })
205:         )
206:       )
207:     );
208:   }
209: 
210:   /**
211:    * åˆ›å»º Bot è´¦æˆ·ï¼ˆä½¿ç”¨ SECURITY DEFINER å‡½æ•°ç»•è¿‡ RLSï¼‰
212:    *
213:    * @param name æœºå™¨äººåç§°
214:    * @param email é‚®ç®±ï¼ˆå¯é€‰ï¼‰
215:    * @param status è´¦æˆ·çŠ¶æ€ï¼ˆé»˜è®¤ 'active'ï¼‰
216:    * @param organizationId ç»„ç»‡è´¦æˆ· IDï¼ˆå¯é€‰ï¼ŒNULL = ä¸ªäºº Botï¼Œæœ‰å€¼ = ç»„ç»‡ Botï¼‰
217:    * @returns Observable<Account>
218:    */
219:   createBotAccount(
220:     name: string,
221:     email?: string | null,
222:     status: AccountStatus = AccountStatus.ACTIVE,
223:     organizationId?: string | null
224:   ): Observable<Account> {
225:     // è°ƒç”¨ RPC å‡½æ•°åˆ›å»º Bot è´¦æˆ·
226:     return from(
227:       this.supabaseService.client.rpc('create_bot_account', {
228:         p_name: name,
229:         p_email: email || null,
230:         p_status: status,
231:         p_organization_id: organizationId || null
232:       })
233:     ).pipe(
234:       map((response: { data: string | null; error: any }) => {
235:         if (response.error) {
236:           throw new Error(response.error.message || 'åˆ›å»ºæœºå™¨äººè´¦æˆ·å¤±è´¥');
237:         }
238:         if (!response.data) {
239:           throw new Error('åˆ›å»ºæœºå™¨äººè´¦æˆ·å¤±è´¥ï¼šæœªè¿”å›è´¦æˆ· ID');
240:         }
241:         return response.data;
242:       }),
243:       // ä½¿ç”¨è¿”å›çš„è´¦æˆ· ID æŸ¥è¯¢å®Œæ•´çš„è´¦æˆ·ä¿¡æ¯
244:       // RLS ç­–ç•¥å·²æ›´æ–°ï¼Œå…è®¸ç”¨æˆ·æŸ¥çœ‹è‡ªå·±åˆ›å»ºçš„ Bot è´¦æˆ·ï¼ˆauth_bot_id = auth.uid()ï¼‰
245:       // ä»¥åŠç»„ç»‡æˆå‘˜æŸ¥çœ‹ç»„ç»‡ Botï¼ˆauth_organization_id å¯¹åº”çš„ç»„ç»‡æˆå‘˜ï¼‰
246:       switchMap((accountId: string) =>
247:         this.findById(accountId).pipe(
248:           map((account: Account | null) => {
249:             if (!account) {
250:               throw new Error('åˆ›å»ºæœºå™¨äººè´¦æˆ·å¤±è´¥ï¼šæ— æ³•æŸ¥è¯¢åˆ°åˆ›å»ºçš„è´¦æˆ·ã€‚è¯·æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦å…è®¸æŸ¥çœ‹ã€‚');
251:             }
252:             return account;
253:           })
254:         )
255:       )
256:     );
257:   }
258: }
````

## File: src/app/core/infra/repositories/base.repository.ts
````typescript
  1: import { Injectable, inject } from '@angular/core';
  2: import { SupabaseClient, PostgrestResponse, PostgrestSingleResponse, PostgrestMaybeSingleResponse } from '@supabase/supabase-js';
  3: import { Observable, from } from 'rxjs';
  4: import { map } from 'rxjs/operators';
  5: 
  6: import { SupabaseService } from '../../supabase/supabase.service';
  7: import { handleSupabaseResponse } from '../errors/supabase-error.transformer';
  8: import { Database } from '../types/database.types';
  9: import { toCamelCaseData, toSnakeCaseData } from '../utils/transformers';
 10: 
 11: /**
 12:  * æŸ¥è¯¢é€‰é¡¹
 13:  */
 14: export interface QueryOptions {
 15:   /** åˆ†é¡µï¼šé¡µç ï¼ˆä» 1 å¼€å§‹ï¼‰ */
 16:   page?: number;
 17:   /** åˆ†é¡µï¼šæ¯é¡µæ•°é‡ */
 18:   pageSize?: number;
 19:   /** æ’åºå­—æ®µ */
 20:   orderBy?: string;
 21:   /** æ’åºæ–¹å‘ */
 22:   orderDirection?: 'asc' | 'desc';
 23:   /** ç­›é€‰æ¡ä»¶ */
 24:   filters?: Record<string, any>;
 25:   /** é€‰æ‹©å­—æ®µï¼ˆé»˜è®¤ '*'ï¼‰ */
 26:   select?: string;
 27: }
 28: 
 29: /**
 30:  * åˆ†é¡µç»“æœ
 31:  */
 32: export interface PaginatedResult<T> {
 33:   data: T[];
 34:   total: number;
 35:   page: number;
 36:   pageSize: number;
 37:   totalPages: number;
 38: }
 39: 
 40: /**
 41:  * åŸºç¡€ Repository ç±»
 42:  *
 43:  * æä¾›é€šç”¨çš„ CRUD æ“ä½œæ–¹æ³•ï¼Œå°è£… Supabase å®¢æˆ·ç«¯è°ƒç”¨
 44:  *
 45:  * @template T å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 46:  * @template TInsert æ’å…¥ç±»å‹ï¼ˆcamelCaseï¼‰
 47:  * @template TUpdate æ›´æ–°ç±»å‹ï¼ˆcamelCaseï¼‰
 48:  *
 49:  * @example
 50:  * ```typescript
 51:  * @Injectable({ providedIn: 'root' })
 52:  * export class BlueprintRepository extends BaseRepository<Blueprint, BlueprintInsert, BlueprintUpdate> {
 53:  *   protected tableName = 'blueprints';
 54:  * }
 55:  * ```
 56:  */
 57: @Injectable()
 58: export abstract class BaseRepository<T, TInsert = Partial<T>, TUpdate = Partial<T>> {
 59:   protected readonly supabase: SupabaseClient<Database> = inject(SupabaseService).client;
 60: 
 61:   /**
 62:    * è¡¨åï¼ˆsnake_caseï¼‰
 63:    * å­ç±»å¿…é¡»å®ç°
 64:    */
 65:   protected abstract tableName: string;
 66: 
 67:   /**
 68:    * è·å–æ‰€æœ‰è®°å½•
 69:    *
 70:    * @param options æŸ¥è¯¢é€‰é¡¹
 71:    * @returns Observable<T[]>
 72:    */
 73:   findAll(options?: QueryOptions): Observable<T[]> {
 74:     // ä½¿ç”¨ç±»å‹æ–­è¨€ï¼Œå› ä¸º tableName æ˜¯è¿è¡Œæ—¶å€¼ï¼Œä½† Supabase éœ€è¦å­—é¢é‡ç±»å‹
 75:     let query = this.supabase.from(this.tableName as any).select(options?.select || '*') as any;
 76: 
 77:     // åº”ç”¨ç­›é€‰æ¡ä»¶
 78:     if (options?.filters) {
 79:       for (const [key, value] of Object.entries(options.filters)) {
 80:         const snakeKey = key.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);
 81:         query = query.eq(snakeKey, value);
 82:       }
 83:     }
 84: 
 85:     // åº”ç”¨æ’åº
 86:     if (options?.orderBy) {
 87:       const snakeOrderBy = options.orderBy.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);
 88:       query = query.order(snakeOrderBy, { ascending: options.orderDirection !== 'desc' });
 89:     }
 90: 
 91:     // åº”ç”¨åˆ†é¡µ
 92:     if (options?.page && options?.pageSize) {
 93:       const fromIndex = (options.page - 1) * options.pageSize;
 94:       const toIndex = fromIndex + options.pageSize - 1;
 95:       query = query.range(fromIndex, toIndex);
 96:     }
 97: 
 98:     // Convert PromiseLike query builder to actual Promise for RxJS from()
 99:     return from(Promise.resolve(query) as Promise<PostgrestResponse<any>>).pipe(
100:       map((response: PostgrestResponse<any>) => {
101:         const data = handleSupabaseResponse(response, `${this.constructor.name}.findAll`);
102:         return Array.isArray(data) ? data.map(item => toCamelCaseData<T>(item)) : [toCamelCaseData<T>(data)];
103:       })
104:     );
105:   }
106: 
107:   /**
108:    * æ ¹æ® ID è·å–å•æ¡è®°å½•
109:    *
110:    * @param id è®°å½• ID
111:    * @returns Observable<T | null>
112:    */
113:   findById(id: string): Observable<T | null> {
114:     return from(
115:       this.supabase
116:         .from(this.tableName as any)
117:         .select('*')
118:         .eq('id', id)
119:         .maybeSingle() as unknown as Promise<PostgrestMaybeSingleResponse<any>>
120:     ).pipe(
121:       map((response: PostgrestMaybeSingleResponse<any>) => {
122:         if (response.error && response.error.code !== 'PGRST116') {
123:           throw handleSupabaseResponse(response, `${this.constructor.name}.findById`);
124:         }
125:         if (!response.data) {
126:           return null;
127:         }
128:         return toCamelCaseData<T>(response.data);
129:       })
130:     );
131:   }
132: 
133:   /**
134:    * åˆ›å»ºæ–°è®°å½•
135:    *
136:    * @param data æ’å…¥æ•°æ®ï¼ˆcamelCaseï¼‰
137:    * @returns Observable<T>
138:    */
139:   create(data: TInsert): Observable<T> {
140:     const snakeData = toSnakeCaseData(data as Record<string, any>);
141: 
142:     return from(
143:       this.supabase
144:         .from(this.tableName as any)
145:         .insert(snakeData as any)
146:         .select()
147:         .single() as unknown as Promise<PostgrestSingleResponse<any>>
148:     ).pipe(
149:       map((response: PostgrestSingleResponse<any>) => {
150:         const result = handleSupabaseResponse(response, `${this.constructor.name}.create`);
151:         return toCamelCaseData<T>(result);
152:       })
153:     );
154:   }
155: 
156:   /**
157:    * æ›´æ–°è®°å½•
158:    *
159:    * @param id è®°å½• ID
160:    * @param data æ›´æ–°æ•°æ®ï¼ˆcamelCaseï¼‰
161:    * @returns Observable<T>
162:    */
163:   update(id: string, data: TUpdate): Observable<T> {
164:     const snakeData = toSnakeCaseData(data as Record<string, any>);
165: 
166:     return from(
167:       this.supabase
168:         .from(this.tableName as any)
169:         .update(snakeData as any)
170:         .eq('id', id)
171:         .select()
172:         .single() as unknown as Promise<PostgrestSingleResponse<any>>
173:     ).pipe(
174:       map((response: PostgrestSingleResponse<any>) => {
175:         const result = handleSupabaseResponse(response, `${this.constructor.name}.update`);
176:         return toCamelCaseData<T>(result);
177:       })
178:     );
179:   }
180: 
181:   /**
182:    * åˆ é™¤è®°å½•
183:    *
184:    * @param id è®°å½• ID
185:    * @returns Observable<void>
186:    */
187:   delete(id: string): Observable<void> {
188:     return from(
189:       this.supabase
190:         .from(this.tableName as any)
191:         .delete()
192:         .eq('id', id) as unknown as Promise<PostgrestResponse<any>>
193:     ).pipe(
194:       map((response: PostgrestResponse<any>) => {
195:         if (response.error) {
196:           throw handleSupabaseResponse(response, `${this.constructor.name}.delete`);
197:         }
198:       })
199:     );
200:   }
201: 
202:   /**
203:    * åˆ†é¡µæŸ¥è¯¢
204:    *
205:    * @param options æŸ¥è¯¢é€‰é¡¹ï¼ˆå¿…é¡»åŒ…å« page å’Œ pageSizeï¼‰
206:    * @returns Observable<PaginatedResult<T>>
207:    */
208:   findPaginated(options: QueryOptions & { page: number; pageSize: number }): Observable<PaginatedResult<T>> {
209:     // å…ˆè·å–æ€»æ•°
210:     const countQuery = this.supabase.from(this.tableName as any).select('*', { count: 'exact', head: true }) as any;
211: 
212:     // åº”ç”¨ç­›é€‰æ¡ä»¶
213:     let dataQuery = this.supabase.from(this.tableName as any).select(options.select || '*') as any;
214: 
215:     if (options.filters) {
216:       for (const [key, value] of Object.entries(options.filters)) {
217:         const snakeKey = key.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);
218:         countQuery.eq(snakeKey, value);
219:         dataQuery = dataQuery.eq(snakeKey, value);
220:       }
221:     }
222: 
223:     // åº”ç”¨æ’åº
224:     if (options.orderBy) {
225:       const snakeOrderBy = options.orderBy.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);
226:       dataQuery = dataQuery.order(snakeOrderBy, { ascending: options.orderDirection !== 'desc' });
227:     }
228: 
229:     // åº”ç”¨åˆ†é¡µ
230:     const fromIndex = (options.page - 1) * options.pageSize;
231:     const toIndex = fromIndex + options.pageSize - 1;
232:     dataQuery = dataQuery.range(fromIndex, toIndex);
233: 
234:     // å¹¶è¡ŒæŸ¥è¯¢æ€»æ•°å’Œæ•°æ®
235:     return from(Promise.all([countQuery, dataQuery]) as Promise<[PostgrestResponse<any>, PostgrestResponse<any>]>).pipe(
236:       map(([countResponse, dataResponse]: [PostgrestResponse<any>, PostgrestResponse<any>]) => {
237:         const total = countResponse.count || 0;
238:         const data = handleSupabaseResponse(dataResponse, `${this.constructor.name}.findPaginated`);
239:         const items = Array.isArray(data) ? data.map(item => toCamelCaseData<T>(item)) : [toCamelCaseData<T>(data)];
240: 
241:         return {
242:           data: items,
243:           total,
244:           page: options.page,
245:           pageSize: options.pageSize,
246:           totalPages: Math.ceil(total / options.pageSize)
247:         };
248:       })
249:     );
250:   }
251: }
````

## File: src/app/core/infra/repositories/blueprint-config.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: import { map } from 'rxjs/operators';
 4: 
 5: import { BaseRepository, QueryOptions } from './base.repository';
 6: import { Database } from '../types/database.types';
 7: 
 8: /**
 9:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
10:  */
11: type BlueprintConfigRow = Database['public']['Tables']['blueprint_configs']['Row'];
12: type BlueprintConfigInsert = Database['public']['Tables']['blueprint_configs']['Insert'];
13: type BlueprintConfigUpdate = Database['public']['Tables']['blueprint_configs']['Update'];
14: 
15: /**
16:  * BlueprintConfig å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
17:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
18:  */
19: export type BlueprintConfig = BlueprintConfigRow;
20: export type { BlueprintConfigInsert, BlueprintConfigUpdate };
21: 
22: /**
23:  * BlueprintConfig Repository
24:  *
25:  * æä¾›è“å›¾é…ç½®ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
26:  *
27:  * @example
28:  * ```typescript
29:  * const configRepo = inject(BlueprintConfigRepository);
30:  * configRepo.findByBlueprintId('blueprint-id').subscribe(configs => {
31:  *   console.log('Configs:', configs);
32:  * });
33:  * ```
34:  */
35: @Injectable({
36:   providedIn: 'root'
37: })
38: export class BlueprintConfigRepository extends BaseRepository<BlueprintConfig, BlueprintConfigInsert, BlueprintConfigUpdate> {
39:   protected tableName = 'blueprint_configs';
40: 
41:   /**
42:    * æ ¹æ®è“å›¾ ID æŸ¥è¯¢é…ç½®åˆ—è¡¨
43:    *
44:    * @param blueprintId è“å›¾ ID
45:    * @param options æŸ¥è¯¢é€‰é¡¹
46:    * @returns Observable<BlueprintConfig[]>
47:    */
48:   findByBlueprintId(blueprintId: string, options?: QueryOptions): Observable<BlueprintConfig[]> {
49:     return this.findAll({
50:       ...options,
51:       filters: {
52:         ...options?.filters,
53:         blueprintId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º blueprint_id
54:       }
55:     });
56:   }
57: 
58:   /**
59:    * æ ¹æ®é…ç½®é”®æŸ¥è¯¢é…ç½®
60:    *
61:    * @param blueprintId è“å›¾ ID
62:    * @param configKey é…ç½®é”®
63:    * @returns Observable<BlueprintConfig | null>
64:    */
65:   findByConfigKey(blueprintId: string, configKey: string): Observable<BlueprintConfig | null> {
66:     return this.findAll({
67:       filters: {
68:         blueprintId, // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º blueprint_id
69:         configKey // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º config_key
70:       }
71:     }).pipe(map(configs => (configs.length > 0 ? configs[0] : null)));
72:   }
73: 
74:   /**
75:    * æ›´æ–°æˆ–åˆ›å»ºé…ç½®ï¼ˆupsertï¼‰
76:    *
77:    * @param blueprintId è“å›¾ ID
78:    * @param configKey é…ç½®é”®
79:    * @param configValue é…ç½®å€¼
80:    * @param updatedBy æ›´æ–°è€… ID
81:    * @returns Observable<BlueprintConfig>
82:    */
83:   upsertConfig(blueprintId: string, configKey: string, configValue: any, updatedBy?: string): Observable<BlueprintConfig> {
84:     // ä½¿ç”¨ç±»å‹æ–­è¨€ï¼Œå› ä¸º BaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ camelCase â†’ snake_case è½¬æ¢
85:     const data = {
86:       blueprintId,
87:       configKey,
88:       configValue,
89:       updatedBy
90:     } as any as BlueprintConfigInsert;
91:     return this.create(data);
92:   }
93: }
````

## File: src/app/core/infra/repositories/blueprint.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { BlueprintStatus } from '../types/blueprint.types';
  7: import { Database } from '../types/database.types';
  8: 
  9: /**
 10:  * Blueprint å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 11:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–ï¼Œåç»­ä¼šé€šè¿‡è½¬æ¢å·¥å…·è½¬æ¢ä¸º camelCase
 12:  */
 13: type BlueprintRow = Database['public']['Tables']['blueprints']['Row'];
 14: type BlueprintInsert = Database['public']['Tables']['blueprints']['Insert'];
 15: type BlueprintUpdate = Database['public']['Tables']['blueprints']['Update'];
 16: 
 17: /**
 18:  * Blueprint å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 19:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 20:  */
 21: export type Blueprint = BlueprintRow;
 22: export type { BlueprintInsert, BlueprintUpdate };
 23: 
 24: /**
 25:  * Blueprint Repository
 26:  *
 27:  * æä¾›è“å›¾ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 28:  *
 29:  * @example
 30:  * ```typescript
 31:  * const blueprintRepo = inject(BlueprintRepository);
 32:  * blueprintRepo.findByOwnerId('user-id').subscribe(blueprints => {
 33:  *   console.log('User blueprints:', blueprints);
 34:  * });
 35:  * ```
 36:  */
 37: @Injectable({
 38:   providedIn: 'root'
 39: })
 40: export class BlueprintRepository extends BaseRepository<Blueprint, BlueprintInsert, BlueprintUpdate> {
 41:   protected tableName = 'blueprints';
 42: 
 43:   /**
 44:    * æ ¹æ®æ‹¥æœ‰è€… ID æŸ¥è¯¢è“å›¾
 45:    *
 46:    * @param ownerId æ‹¥æœ‰è€… ID
 47:    * @param options æŸ¥è¯¢é€‰é¡¹
 48:    * @returns Observable<Blueprint[]>
 49:    */
 50:   findByOwnerId(ownerId: string, options?: QueryOptions): Observable<Blueprint[]> {
 51:     return this.findAll({
 52:       ...options,
 53:       filters: {
 54:         ...options?.filters,
 55:         ownerId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º owner_id
 56:       }
 57:     });
 58:   }
 59: 
 60:   /**
 61:    * æ ¹æ®çŠ¶æ€æŸ¥è¯¢è“å›¾
 62:    *
 63:    * @param status è“å›¾çŠ¶æ€
 64:    * @param options æŸ¥è¯¢é€‰é¡¹
 65:    * @returns Observable<Blueprint[]>
 66:    */
 67:   findByStatus(status: BlueprintStatus, options?: QueryOptions): Observable<Blueprint[]> {
 68:     return this.findAll({
 69:       ...options,
 70:       filters: {
 71:         ...options?.filters,
 72:         status
 73:       }
 74:     });
 75:   }
 76: 
 77:   /**
 78:    * æ ¹æ®é¡¹ç›®ä»£ç æŸ¥è¯¢è“å›¾
 79:    *
 80:    * @param projectCode é¡¹ç›®ä»£ç 
 81:    * @returns Observable<Blueprint | null>
 82:    */
 83:   findByProjectCode(projectCode: string): Observable<Blueprint | null> {
 84:     return this.findAll({
 85:       filters: {
 86:         projectCode // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º project_code
 87:       }
 88:     }).pipe(map(blueprints => (blueprints.length > 0 ? blueprints[0] : null)));
 89:   }
 90: 
 91:   /**
 92:    * æŸ¥è¯¢æ´»è·ƒçš„è“å›¾ï¼ˆçŠ¶æ€ä¸º activeï¼‰
 93:    *
 94:    * @param options æŸ¥è¯¢é€‰é¡¹
 95:    * @returns Observable<Blueprint[]>
 96:    */
 97:   findActive(options?: QueryOptions): Observable<Blueprint[]> {
 98:     return this.findByStatus(BlueprintStatus.ACTIVE, options);
 99:   }
100: }
````

## File: src/app/core/infra/repositories/branch-fork.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: 
  4: import { BaseRepository, QueryOptions } from './base.repository';
  5: import { Database } from '../types/database.types';
  6: 
  7: /**
  8:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
  9:  */
 10: type BranchForkRow = Database['public']['Tables']['branch_forks']['Row'];
 11: type BranchForkInsert = Database['public']['Tables']['branch_forks']['Insert'];
 12: type BranchForkUpdate = Database['public']['Tables']['branch_forks']['Update'];
 13: 
 14: /**
 15:  * BranchFork å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 16:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 17:  */
 18: export type BranchFork = BranchForkRow;
 19: export type { BranchForkInsert, BranchForkUpdate };
 20: 
 21: /**
 22:  * BranchFork Repository
 23:  *
 24:  * æä¾›åˆ†æ”¯ Fork è®°å½•ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 25:  *
 26:  * @example
 27:  * ```typescript
 28:  * const forkRepo = inject(BranchForkRepository);
 29:  * forkRepo.findByBlueprintId('blueprint-id').subscribe(forks => {
 30:  *   console.log('Forks:', forks);
 31:  * });
 32:  * ```
 33:  */
 34: @Injectable({
 35:   providedIn: 'root'
 36: })
 37: export class BranchForkRepository extends BaseRepository<BranchFork, BranchForkInsert, BranchForkUpdate> {
 38:   protected tableName = 'branch_forks';
 39: 
 40:   /**
 41:    * æ ¹æ®è“å›¾ ID æŸ¥è¯¢ Fork è®°å½•åˆ—è¡¨
 42:    *
 43:    * @param blueprintId è“å›¾ ID
 44:    * @param options æŸ¥è¯¢é€‰é¡¹
 45:    * @returns Observable<BranchFork[]>
 46:    */
 47:   findByBlueprintId(blueprintId: string, options?: QueryOptions): Observable<BranchFork[]> {
 48:     return this.findAll({
 49:       ...options,
 50:       filters: {
 51:         ...options?.filters,
 52:         blueprintId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º blueprint_id
 53:       }
 54:     });
 55:   }
 56: 
 57:   /**
 58:    * æ ¹æ®åˆ†æ”¯ ID æŸ¥è¯¢ Fork è®°å½•åˆ—è¡¨
 59:    *
 60:    * @param branchId åˆ†æ”¯ ID
 61:    * @param options æŸ¥è¯¢é€‰é¡¹
 62:    * @returns Observable<BranchFork[]>
 63:    */
 64:   findByBranchId(branchId: string, options?: QueryOptions): Observable<BranchFork[]> {
 65:     return this.findAll({
 66:       ...options,
 67:       filters: {
 68:         ...options?.filters,
 69:         branchId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º branch_id
 70:       }
 71:     });
 72:   }
 73: 
 74:   /**
 75:    * æ ¹æ®æºä»»åŠ¡ ID æŸ¥è¯¢ Fork è®°å½•åˆ—è¡¨
 76:    *
 77:    * @param forkedFromTaskId æºä»»åŠ¡ ID
 78:    * @param options æŸ¥è¯¢é€‰é¡¹
 79:    * @returns Observable<BranchFork[]>
 80:    */
 81:   findByForkedFromTaskId(forkedFromTaskId: string, options?: QueryOptions): Observable<BranchFork[]> {
 82:     return this.findAll({
 83:       ...options,
 84:       filters: {
 85:         ...options?.filters,
 86:         forkedFromTaskId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º forked_from_task_id
 87:       }
 88:     });
 89:   }
 90: 
 91:   /**
 92:    * æ ¹æ® Fork è€… ID æŸ¥è¯¢ Fork è®°å½•åˆ—è¡¨
 93:    *
 94:    * @param forkedBy Fork è€… ID
 95:    * @param options æŸ¥è¯¢é€‰é¡¹
 96:    * @returns Observable<BranchFork[]>
 97:    */
 98:   findByForkedBy(forkedBy: string, options?: QueryOptions): Observable<BranchFork[]> {
 99:     return this.findAll({
100:       ...options,
101:       filters: {
102:         ...options?.filters,
103:         forkedBy // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º forked_by
104:       }
105:     });
106:   }
107: }
````

## File: src/app/core/infra/repositories/collaboration-invitation.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: 
  4: import { BaseRepository, QueryOptions } from './base.repository';
  5: import { InvitationStatus } from '../types/collaboration.types';
  6: import { Database } from '../types/database.types';
  7: 
  8: /**
  9:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 10:  */
 11: type CollaborationInvitationRow = Database['public']['Tables']['collaboration_invitations']['Row'];
 12: type CollaborationInvitationInsert = Database['public']['Tables']['collaboration_invitations']['Insert'];
 13: type CollaborationInvitationUpdate = Database['public']['Tables']['collaboration_invitations']['Update'];
 14: 
 15: /**
 16:  * CollaborationInvitation å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 17:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 18:  */
 19: export type CollaborationInvitation = CollaborationInvitationRow;
 20: export type { CollaborationInvitationInsert, CollaborationInvitationUpdate };
 21: 
 22: /**
 23:  * CollaborationInvitation Repository
 24:  *
 25:  * æä¾›åä½œé‚€è¯·ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 26:  *
 27:  * @example
 28:  * ```typescript
 29:  * const invRepo = inject(CollaborationInvitationRepository);
 30:  * invRepo.findByToOrgId('org-id').subscribe(invitations => {
 31:  *   console.log('Invitations:', invitations);
 32:  * });
 33:  * ```
 34:  */
 35: @Injectable({
 36:   providedIn: 'root'
 37: })
 38: export class CollaborationInvitationRepository extends BaseRepository<
 39:   CollaborationInvitation,
 40:   CollaborationInvitationInsert,
 41:   CollaborationInvitationUpdate
 42: > {
 43:   protected tableName = 'collaboration_invitations';
 44: 
 45:   /**
 46:    * æ ¹æ®è“å›¾ ID æŸ¥è¯¢é‚€è¯·åˆ—è¡¨
 47:    *
 48:    * @param blueprintId è“å›¾ ID
 49:    * @param options æŸ¥è¯¢é€‰é¡¹
 50:    * @returns Observable<CollaborationInvitation[]>
 51:    */
 52:   findByBlueprintId(blueprintId: string, options?: QueryOptions): Observable<CollaborationInvitation[]> {
 53:     return this.findAll({
 54:       ...options,
 55:       filters: {
 56:         ...options?.filters,
 57:         blueprintId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º blueprint_id
 58:       }
 59:     });
 60:   }
 61: 
 62:   /**
 63:    * æ ¹æ®å‘é€ç»„ç»‡ ID æŸ¥è¯¢é‚€è¯·åˆ—è¡¨
 64:    *
 65:    * @param fromOrgId å‘é€ç»„ç»‡ ID
 66:    * @param options æŸ¥è¯¢é€‰é¡¹
 67:    * @returns Observable<CollaborationInvitation[]>
 68:    */
 69:   findByFromOrgId(fromOrgId: string, options?: QueryOptions): Observable<CollaborationInvitation[]> {
 70:     return this.findAll({
 71:       ...options,
 72:       filters: {
 73:         ...options?.filters,
 74:         fromOrgId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º from_org_id
 75:       }
 76:     });
 77:   }
 78: 
 79:   /**
 80:    * æ ¹æ®æ¥æ”¶ç»„ç»‡ ID æŸ¥è¯¢é‚€è¯·åˆ—è¡¨
 81:    *
 82:    * @param toOrgId æ¥æ”¶ç»„ç»‡ ID
 83:    * @param options æŸ¥è¯¢é€‰é¡¹
 84:    * @returns Observable<CollaborationInvitation[]>
 85:    */
 86:   findByToOrgId(toOrgId: string, options?: QueryOptions): Observable<CollaborationInvitation[]> {
 87:     return this.findAll({
 88:       ...options,
 89:       filters: {
 90:         ...options?.filters,
 91:         toOrgId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º to_org_id
 92:       }
 93:     });
 94:   }
 95: 
 96:   /**
 97:    * æ ¹æ®çŠ¶æ€æŸ¥è¯¢é‚€è¯·åˆ—è¡¨
 98:    *
 99:    * @param status é‚€è¯·çŠ¶æ€
100:    * @param options æŸ¥è¯¢é€‰é¡¹
101:    * @returns Observable<CollaborationInvitation[]>
102:    */
103:   findByStatus(status: InvitationStatus, options?: QueryOptions): Observable<CollaborationInvitation[]> {
104:     return this.findAll({
105:       ...options,
106:       filters: {
107:         ...options?.filters,
108:         status
109:       }
110:     });
111:   }
112: 
113:   /**
114:    * æŸ¥è¯¢è¿‡æœŸçš„é‚€è¯·åˆ—è¡¨
115:    *
116:    * @param options æŸ¥è¯¢é€‰é¡¹
117:    * @returns Observable<CollaborationInvitation[]>
118:    */
119:   findExpired(options?: QueryOptions): Observable<CollaborationInvitation[]> {
120:     return this.findAll({
121:       ...options,
122:       filters: {
123:         ...options?.filters,
124:         expiresAt: { $lt: new Date().toISOString() } // è¿‡æœŸæ—¶é—´å°äºå½“å‰æ—¶é—´
125:       }
126:     });
127:   }
128: 
129:   /**
130:    * æŸ¥è¯¢å¾…å¤„ç†çš„é‚€è¯·åˆ—è¡¨
131:    *
132:    * @param options æŸ¥è¯¢é€‰é¡¹
133:    * @returns Observable<CollaborationInvitation[]>
134:    */
135:   findPending(options?: QueryOptions): Observable<CollaborationInvitation[]> {
136:     return this.findByStatus(InvitationStatus.PENDING, options);
137:   }
138: }
````

## File: src/app/core/infra/repositories/collaboration-member.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: 
 4: import { BaseRepository, QueryOptions } from './base.repository';
 5: import { Database } from '../types/database.types';
 6: 
 7: /**
 8:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 9:  */
10: type CollaborationMemberRow = Database['public']['Tables']['collaboration_members']['Row'];
11: type CollaborationMemberInsert = Database['public']['Tables']['collaboration_members']['Insert'];
12: type CollaborationMemberUpdate = Database['public']['Tables']['collaboration_members']['Update'];
13: 
14: /**
15:  * CollaborationMember å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
16:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
17:  */
18: export type CollaborationMember = CollaborationMemberRow;
19: export type { CollaborationMemberInsert, CollaborationMemberUpdate };
20: 
21: /**
22:  * CollaborationMember Repository
23:  *
24:  * æä¾›åä½œæˆå‘˜ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
25:  *
26:  * @example
27:  * ```typescript
28:  * const memberRepo = inject(CollaborationMemberRepository);
29:  * memberRepo.findByCollaborationId('collab-id').subscribe(members => {
30:  *   console.log('Members:', members);
31:  * });
32:  * ```
33:  */
34: @Injectable({
35:   providedIn: 'root'
36: })
37: export class CollaborationMemberRepository extends BaseRepository<
38:   CollaborationMember,
39:   CollaborationMemberInsert,
40:   CollaborationMemberUpdate
41: > {
42:   protected tableName = 'collaboration_members';
43: 
44:   /**
45:    * æ ¹æ®åä½œå…³ç³» ID æŸ¥è¯¢æˆå‘˜åˆ—è¡¨
46:    *
47:    * @param collaborationId åä½œå…³ç³» ID
48:    * @param options æŸ¥è¯¢é€‰é¡¹
49:    * @returns Observable<CollaborationMember[]>
50:    */
51:   findByCollaborationId(collaborationId: string, options?: QueryOptions): Observable<CollaborationMember[]> {
52:     return this.findAll({
53:       ...options,
54:       filters: {
55:         ...options?.filters,
56:         collaborationId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º collaboration_id
57:       }
58:     });
59:   }
60: 
61:   /**
62:    * æ ¹æ®è´¦æˆ· ID æŸ¥è¯¢æˆå‘˜åˆ—è¡¨
63:    *
64:    * @param accountId è´¦æˆ· ID
65:    * @param options æŸ¥è¯¢é€‰é¡¹
66:    * @returns Observable<CollaborationMember[]>
67:    */
68:   findByAccountId(accountId: string, options?: QueryOptions): Observable<CollaborationMember[]> {
69:     return this.findAll({
70:       ...options,
71:       filters: {
72:         ...options?.filters,
73:         accountId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º account_id
74:       }
75:     });
76:   }
77: 
78:   /**
79:    * æ ¹æ®è§’è‰²æŸ¥è¯¢æˆå‘˜åˆ—è¡¨
80:    *
81:    * @param role æˆå‘˜è§’è‰²
82:    * @param options æŸ¥è¯¢é€‰é¡¹
83:    * @returns Observable<CollaborationMember[]>
84:    */
85:   findByRole(role: string, options?: QueryOptions): Observable<CollaborationMember[]> {
86:     return this.findAll({
87:       ...options,
88:       filters: {
89:         ...options?.filters,
90:         role
91:       }
92:     });
93:   }
94: }
````

## File: src/app/core/infra/repositories/daily-report.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: 
  4: import { BaseRepository, QueryOptions } from './base.repository';
  5: import { Database } from '../types/database.types';
  6: 
  7: /**
  8:  * DailyReport å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
  9:  */
 10: type DailyReportRow = Database['public']['Tables']['daily_reports']['Row'];
 11: type DailyReportInsert = Database['public']['Tables']['daily_reports']['Insert'];
 12: type DailyReportUpdate = Database['public']['Tables']['daily_reports']['Update'];
 13: 
 14: export type DailyReport = DailyReportRow;
 15: export type { DailyReportInsert, DailyReportUpdate };
 16: 
 17: /**
 18:  * DailyReport Repository
 19:  *
 20:  * æä¾›æ–½å·¥æ—¥å¿—ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 21:  */
 22: @Injectable({
 23:   providedIn: 'root'
 24: })
 25: export class DailyReportRepository extends BaseRepository<DailyReport, DailyReportInsert, DailyReportUpdate> {
 26:   protected tableName = 'daily_reports';
 27: 
 28:   /**
 29:    * æ ¹æ®ä»»åŠ¡ ID æŸ¥è¯¢æ–½å·¥æ—¥å¿—
 30:    *
 31:    * @param taskId ä»»åŠ¡ ID
 32:    * @param options æŸ¥è¯¢é€‰é¡¹
 33:    * @returns Observable<DailyReport[]>
 34:    */
 35:   findByTaskId(taskId: string, options?: QueryOptions): Observable<DailyReport[]> {
 36:     return this.findAll({
 37:       ...options,
 38:       filters: {
 39:         ...options?.filters,
 40:         taskId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º task_id
 41:       },
 42:       orderBy: 'report_date',
 43:       orderDirection: 'desc'
 44:     });
 45:   }
 46: 
 47:   /**
 48:    * æ ¹æ®è“å›¾ ID æŸ¥è¯¢æ–½å·¥æ—¥å¿—
 49:    *
 50:    * @param blueprintId è“å›¾ ID
 51:    * @param options æŸ¥è¯¢é€‰é¡¹
 52:    * @returns Observable<DailyReport[]>
 53:    */
 54:   findByBlueprintId(blueprintId: string, options?: QueryOptions): Observable<DailyReport[]> {
 55:     return this.findAll({
 56:       ...options,
 57:       filters: {
 58:         ...options?.filters,
 59:         blueprintId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º blueprint_id
 60:       },
 61:       orderBy: 'report_date',
 62:       orderDirection: 'desc'
 63:     });
 64:   }
 65: 
 66:   /**
 67:    * æ ¹æ®åˆ†æ”¯ ID æŸ¥è¯¢æ–½å·¥æ—¥å¿—
 68:    *
 69:    * @param branchId åˆ†æ”¯ ID
 70:    * @param options æŸ¥è¯¢é€‰é¡¹
 71:    * @returns Observable<DailyReport[]>
 72:    */
 73:   findByBranchId(branchId: string, options?: QueryOptions): Observable<DailyReport[]> {
 74:     return this.findAll({
 75:       ...options,
 76:       filters: {
 77:         ...options?.filters,
 78:         branchId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º branch_id
 79:       },
 80:       orderBy: 'report_date',
 81:       orderDirection: 'desc'
 82:     });
 83:   }
 84: 
 85:   /**
 86:    * æ ¹æ®æŠ¥å‘Šæ—¥æœŸæŸ¥è¯¢æ–½å·¥æ—¥å¿—
 87:    *
 88:    * @param reportDate æŠ¥å‘Šæ—¥æœŸ
 89:    * @param options æŸ¥è¯¢é€‰é¡¹
 90:    * @returns Observable<DailyReport[]>
 91:    */
 92:   findByReportDate(reportDate: string, options?: QueryOptions): Observable<DailyReport[]> {
 93:     return this.findAll({
 94:       ...options,
 95:       filters: {
 96:         ...options?.filters,
 97:         reportDate // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º report_date
 98:       }
 99:     });
100:   }
101: 
102:   /**
103:    * æ ¹æ®æŠ¥å‘Šè€… ID æŸ¥è¯¢æ–½å·¥æ—¥å¿—
104:    *
105:    * @param reportedBy æŠ¥å‘Šè€… ID
106:    * @param options æŸ¥è¯¢é€‰é¡¹
107:    * @returns Observable<DailyReport[]>
108:    */
109:   findByReportedBy(reportedBy: string, options?: QueryOptions): Observable<DailyReport[]> {
110:     return this.findAll({
111:       ...options,
112:       filters: {
113:         ...options?.filters,
114:         reportedBy // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º reported_by
115:       },
116:       orderBy: 'report_date',
117:       orderDirection: 'desc'
118:     });
119:   }
120: }
````

## File: src/app/core/infra/repositories/organization-collaboration.repository.spec.ts
````typescript
  1: import { TestBed } from '@angular/core/testing';
  2: import { OrganizationCollaboration } from '@shared';
  3: import { of } from 'rxjs';
  4: 
  5: import { OrganizationCollaborationRepository } from './organization-collaboration.repository';
  6: import { SupabaseService } from '../../supabase/supabase.service';
  7: import { CollaborationType, CollaborationStatus } from '../types/collaboration.types';
  8: 
  9: describe('OrganizationCollaborationRepository', () => {
 10:   let repository: OrganizationCollaborationRepository;
 11:   let supabaseService: jasmine.SpyObj<SupabaseService>;
 12:   let mockSupabaseClient: any;
 13: 
 14:   const mockCollaboration: OrganizationCollaboration = {
 15:     id: 'collab-1',
 16:     blueprint_id: 'blueprint-1',
 17:     owner_org_id: 'org-1',
 18:     collaborator_org_id: 'org-2',
 19:     collaboration_type: CollaborationType.CONTRACTOR,
 20:     status: CollaborationStatus.ACTIVE,
 21:     contract_start_date: '2025-01-01',
 22:     contract_end_date: '2025-12-31',
 23:     notes: 'Test collaboration',
 24:     created_at: '2025-01-01T00:00:00Z',
 25:     updated_at: '2025-01-01T00:00:00Z'
 26:   } as OrganizationCollaboration;
 27: 
 28:   beforeEach(() => {
 29:     // åˆ›å»º Mock Supabase Client
 30:     mockSupabaseClient = {
 31:       from: jasmine.createSpy('from').and.returnValue({
 32:         select: jasmine.createSpy('select').and.returnValue({
 33:           eq: jasmine.createSpy('eq').and.returnValue({
 34:             order: jasmine.createSpy('order').and.returnValue({
 35:               range: jasmine.createSpy('range').and.returnValue(Promise.resolve({ data: [mockCollaboration], error: null }))
 36:             })
 37:           })
 38:         })
 39:       })
 40:     };
 41: 
 42:     const supabaseServiceSpy = jasmine.createSpyObj('SupabaseService', [], {
 43:       client: mockSupabaseClient
 44:     });
 45: 
 46:     TestBed.configureTestingModule({
 47:       providers: [OrganizationCollaborationRepository, { provide: SupabaseService, useValue: supabaseServiceSpy }]
 48:     });
 49: 
 50:     repository = TestBed.inject(OrganizationCollaborationRepository);
 51:     supabaseService = TestBed.inject(SupabaseService) as jasmine.SpyObj<SupabaseService>;
 52:   });
 53: 
 54:   it('should be created', () => {
 55:     expect(repository).toBeTruthy();
 56:   });
 57: 
 58:   describe('findByBlueprintId', () => {
 59:     it('should find collaborations by blueprint id', done => {
 60:       repository.findByBlueprintId('blueprint-1').subscribe({
 61:         next: collaborations => {
 62:           expect(collaborations.length).toBeGreaterThan(0);
 63:           expect(mockSupabaseClient.from).toHaveBeenCalledWith('organization_collaborations');
 64:           done();
 65:         },
 66:         error: done.fail
 67:       });
 68:     });
 69:   });
 70: 
 71:   describe('findByOwnerOrgId', () => {
 72:     it('should find collaborations by owner org id', done => {
 73:       repository.findByOwnerOrgId('org-1').subscribe({
 74:         next: collaborations => {
 75:           expect(mockSupabaseClient.from).toHaveBeenCalledWith('organization_collaborations');
 76:           done();
 77:         },
 78:         error: done.fail
 79:       });
 80:     });
 81:   });
 82: 
 83:   describe('findByCollaboratorOrgId', () => {
 84:     it('should find collaborations by collaborator org id', done => {
 85:       repository.findByCollaboratorOrgId('org-2').subscribe({
 86:         next: collaborations => {
 87:           expect(mockSupabaseClient.from).toHaveBeenCalledWith('organization_collaborations');
 88:           done();
 89:         },
 90:         error: done.fail
 91:       });
 92:     });
 93:   });
 94: 
 95:   describe('findByCollaborationType', () => {
 96:     it('should find collaborations by type', done => {
 97:       repository.findByCollaborationType(CollaborationType.CONTRACTOR).subscribe({
 98:         next: collaborations => {
 99:           expect(mockSupabaseClient.from).toHaveBeenCalledWith('organization_collaborations');
100:           done();
101:         },
102:         error: done.fail
103:       });
104:     });
105:   });
106: 
107:   describe('findByStatus', () => {
108:     it('should find collaborations by status', done => {
109:       repository.findByStatus(CollaborationStatus.ACTIVE).subscribe({
110:         next: collaborations => {
111:           expect(mockSupabaseClient.from).toHaveBeenCalledWith('organization_collaborations');
112:           done();
113:         },
114:         error: done.fail
115:       });
116:     });
117:   });
118: });
````

## File: src/app/core/infra/repositories/organization-collaboration.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: 
  4: import { BaseRepository, QueryOptions } from './base.repository';
  5: import { CollaborationType, CollaborationStatus } from '../types/collaboration.types';
  6: import { Database } from '../types/database.types';
  7: 
  8: /**
  9:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 10:  */
 11: type OrganizationCollaborationRow = Database['public']['Tables']['organization_collaborations']['Row'];
 12: type OrganizationCollaborationInsert = Database['public']['Tables']['organization_collaborations']['Insert'];
 13: type OrganizationCollaborationUpdate = Database['public']['Tables']['organization_collaborations']['Update'];
 14: 
 15: /**
 16:  * OrganizationCollaboration å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 17:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 18:  */
 19: export type OrganizationCollaboration = OrganizationCollaborationRow;
 20: export type { OrganizationCollaborationInsert, OrganizationCollaborationUpdate };
 21: 
 22: /**
 23:  * OrganizationCollaboration Repository
 24:  *
 25:  * æä¾›ç»„ç»‡åä½œå…³ç³»ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 26:  *
 27:  * @example
 28:  * ```typescript
 29:  * const collabRepo = inject(OrganizationCollaborationRepository);
 30:  * collabRepo.findByBlueprintId('blueprint-id').subscribe(collabs => {
 31:  *   console.log('Collaborations:', collabs);
 32:  * });
 33:  * ```
 34:  */
 35: @Injectable({
 36:   providedIn: 'root'
 37: })
 38: export class OrganizationCollaborationRepository extends BaseRepository<
 39:   OrganizationCollaboration,
 40:   OrganizationCollaborationInsert,
 41:   OrganizationCollaborationUpdate
 42: > {
 43:   protected tableName = 'organization_collaborations';
 44: 
 45:   /**
 46:    * æ ¹æ®è“å›¾ ID æŸ¥è¯¢åä½œå…³ç³»åˆ—è¡¨
 47:    *
 48:    * @param blueprintId è“å›¾ ID
 49:    * @param options æŸ¥è¯¢é€‰é¡¹
 50:    * @returns Observable<OrganizationCollaboration[]>
 51:    */
 52:   findByBlueprintId(blueprintId: string, options?: QueryOptions): Observable<OrganizationCollaboration[]> {
 53:     return this.findAll({
 54:       ...options,
 55:       filters: {
 56:         ...options?.filters,
 57:         blueprintId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º blueprint_id
 58:       }
 59:     });
 60:   }
 61: 
 62:   /**
 63:    * æ ¹æ®æ‹¥æœ‰è€…ç»„ç»‡ ID æŸ¥è¯¢åä½œå…³ç³»åˆ—è¡¨
 64:    *
 65:    * @param ownerOrgId æ‹¥æœ‰è€…ç»„ç»‡ ID
 66:    * @param options æŸ¥è¯¢é€‰é¡¹
 67:    * @returns Observable<OrganizationCollaboration[]>
 68:    */
 69:   findByOwnerOrgId(ownerOrgId: string, options?: QueryOptions): Observable<OrganizationCollaboration[]> {
 70:     return this.findAll({
 71:       ...options,
 72:       filters: {
 73:         ...options?.filters,
 74:         ownerOrgId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º owner_org_id
 75:       }
 76:     });
 77:   }
 78: 
 79:   /**
 80:    * æ ¹æ®åä½œç»„ç»‡ ID æŸ¥è¯¢åä½œå…³ç³»åˆ—è¡¨
 81:    *
 82:    * @param collaboratorOrgId åä½œç»„ç»‡ ID
 83:    * @param options æŸ¥è¯¢é€‰é¡¹
 84:    * @returns Observable<OrganizationCollaboration[]>
 85:    */
 86:   findByCollaboratorOrgId(collaboratorOrgId: string, options?: QueryOptions): Observable<OrganizationCollaboration[]> {
 87:     return this.findAll({
 88:       ...options,
 89:       filters: {
 90:         ...options?.filters,
 91:         collaboratorOrgId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º collaborator_org_id
 92:       }
 93:     });
 94:   }
 95: 
 96:   /**
 97:    * æ ¹æ®åä½œç±»å‹æŸ¥è¯¢åä½œå…³ç³»åˆ—è¡¨
 98:    *
 99:    * @param collaborationType åä½œç±»å‹
100:    * @param options æŸ¥è¯¢é€‰é¡¹
101:    * @returns Observable<OrganizationCollaboration[]>
102:    */
103:   findByCollaborationType(collaborationType: CollaborationType, options?: QueryOptions): Observable<OrganizationCollaboration[]> {
104:     return this.findAll({
105:       ...options,
106:       filters: {
107:         ...options?.filters,
108:         collaborationType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º collaboration_type
109:       }
110:     });
111:   }
112: 
113:   /**
114:    * æ ¹æ®çŠ¶æ€æŸ¥è¯¢åä½œå…³ç³»åˆ—è¡¨
115:    *
116:    * @param status åä½œçŠ¶æ€
117:    * @param options æŸ¥è¯¢é€‰é¡¹
118:    * @returns Observable<OrganizationCollaboration[]>
119:    */
120:   findByStatus(status: CollaborationStatus, options?: QueryOptions): Observable<OrganizationCollaboration[]> {
121:     return this.findAll({
122:       ...options,
123:       filters: {
124:         ...options?.filters,
125:         status
126:       }
127:     });
128:   }
129: }
````

## File: src/app/core/infra/repositories/organization-schedule.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: 
  4: import { BaseRepository, QueryOptions } from './base.repository';
  5: import { Database } from '../types/database.types';
  6: 
  7: /**
  8:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
  9:  */
 10: type OrganizationScheduleRow = Database['public']['Tables']['organization_schedules']['Row'];
 11: type OrganizationScheduleInsert = Database['public']['Tables']['organization_schedules']['Insert'];
 12: type OrganizationScheduleUpdate = Database['public']['Tables']['organization_schedules']['Update'];
 13: 
 14: /**
 15:  * OrganizationSchedule å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 16:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 17:  */
 18: export type OrganizationSchedule = OrganizationScheduleRow;
 19: export type { OrganizationScheduleInsert, OrganizationScheduleUpdate };
 20: 
 21: /**
 22:  * OrganizationSchedule Repository
 23:  *
 24:  * æä¾›ç»„ç»‡æ’ç­ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 25:  *
 26:  * @example
 27:  * ```typescript
 28:  * const scheduleRepo = inject(OrganizationScheduleRepository);
 29:  * scheduleRepo.findByOrganizationId('org-id').subscribe(schedules => {
 30:  *   console.log('Organization schedules:', schedules);
 31:  * });
 32:  * ```
 33:  */
 34: @Injectable({
 35:   providedIn: 'root'
 36: })
 37: export class OrganizationScheduleRepository extends BaseRepository<
 38:   OrganizationSchedule,
 39:   OrganizationScheduleInsert,
 40:   OrganizationScheduleUpdate
 41: > {
 42:   protected tableName = 'organization_schedules';
 43: 
 44:   /**
 45:    * æ ¹æ®ç»„ç»‡ ID æŸ¥è¯¢æ’ç­åˆ—è¡¨
 46:    *
 47:    * @param organizationId ç»„ç»‡ ID
 48:    * @param options æŸ¥è¯¢é€‰é¡¹
 49:    * @returns Observable<OrganizationSchedule[]>
 50:    */
 51:   findByOrganizationId(organizationId: string, options?: QueryOptions): Observable<OrganizationSchedule[]> {
 52:     return this.findAll({
 53:       ...options,
 54:       filters: {
 55:         ...options?.filters,
 56:         organizationId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º organization_id
 57:       }
 58:     });
 59:   }
 60: 
 61:   /**
 62:    * æ ¹æ®è“å›¾ ID æŸ¥è¯¢æ’ç­åˆ—è¡¨
 63:    *
 64:    * @param blueprintId è“å›¾ ID
 65:    * @param options æŸ¥è¯¢é€‰é¡¹
 66:    * @returns Observable<OrganizationSchedule[]>
 67:    */
 68:   findByBlueprintId(blueprintId: string, options?: QueryOptions): Observable<OrganizationSchedule[]> {
 69:     return this.findAll({
 70:       ...options,
 71:       filters: {
 72:         ...options?.filters,
 73:         blueprintId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º blueprint_id
 74:       }
 75:     });
 76:   }
 77: 
 78:   /**
 79:    * æ ¹æ®åˆ†æ”¯ ID æŸ¥è¯¢æ’ç­åˆ—è¡¨
 80:    *
 81:    * @param branchId åˆ†æ”¯ ID
 82:    * @param options æŸ¥è¯¢é€‰é¡¹
 83:    * @returns Observable<OrganizationSchedule[]>
 84:    */
 85:   findByBranchId(branchId: string, options?: QueryOptions): Observable<OrganizationSchedule[]> {
 86:     return this.findAll({
 87:       ...options,
 88:       filters: {
 89:         ...options?.filters,
 90:         branchId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º branch_id
 91:       }
 92:     });
 93:   }
 94: 
 95:   /**
 96:    * æ ¹æ®è´¦æˆ· ID æŸ¥è¯¢æ’ç­åˆ—è¡¨
 97:    *
 98:    * @param accountId è´¦æˆ· ID
 99:    * @param options æŸ¥è¯¢é€‰é¡¹
100:    * @returns Observable<OrganizationSchedule[]>
101:    */
102:   findByAccountId(accountId: string, options?: QueryOptions): Observable<OrganizationSchedule[]> {
103:     return this.findAll({
104:       ...options,
105:       filters: {
106:         ...options?.filters,
107:         accountId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º account_id
108:       }
109:     });
110:   }
111: 
112:   /**
113:    * æ ¹æ®å›¢é˜Ÿ ID æŸ¥è¯¢æ’ç­åˆ—è¡¨
114:    *
115:    * @param teamId å›¢é˜Ÿ ID
116:    * @param options æŸ¥è¯¢é€‰é¡¹
117:    * @returns Observable<OrganizationSchedule[]>
118:    */
119:   findByTeamId(teamId: string, options?: QueryOptions): Observable<OrganizationSchedule[]> {
120:     return this.findAll({
121:       ...options,
122:       filters: {
123:         ...options?.filters,
124:         teamId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º team_id
125:       }
126:     });
127:   }
128: 
129:   /**
130:    * æ ¹æ®æ—¥æœŸèŒƒå›´æŸ¥è¯¢æ’ç­åˆ—è¡¨
131:    *
132:    * @param startDate å¼€å§‹æ—¥æœŸ
133:    * @param endDate ç»“æŸæ—¥æœŸ
134:    * @param options æŸ¥è¯¢é€‰é¡¹
135:    * @returns Observable<OrganizationSchedule[]>
136:    */
137:   findByDateRange(startDate: string, endDate: string, options?: QueryOptions): Observable<OrganizationSchedule[]> {
138:     // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„ BaseRepository å®ç°æ¥è°ƒæ•´
139:     // å¦‚æœ BaseRepository æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼Œå¯ä»¥ä½¿ç”¨ filters
140:     // å¦åˆ™å¯èƒ½éœ€è¦ä½¿ç”¨è‡ªå®šä¹‰æŸ¥è¯¢
141:     return this.findAll({
142:       ...options,
143:       filters: {
144:         ...options?.filters
145:         // æ—¥æœŸèŒƒå›´æŸ¥è¯¢å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†
146:         // è¿™é‡Œå‡è®¾ BaseRepository æ”¯æŒ gte/lte æ“ä½œç¬¦
147:       }
148:     });
149:   }
150: }
````

## File: src/app/core/infra/repositories/pull-request.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: 
  4: import { BaseRepository, QueryOptions } from './base.repository';
  5: import { PRStatus } from '../types/blueprint.types';
  6: import { Database } from '../types/database.types';
  7: 
  8: /**
  9:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 10:  */
 11: type PullRequestRow = Database['public']['Tables']['pull_requests']['Row'];
 12: type PullRequestInsert = Database['public']['Tables']['pull_requests']['Insert'];
 13: type PullRequestUpdate = Database['public']['Tables']['pull_requests']['Update'];
 14: 
 15: /**
 16:  * PullRequest å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 17:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 18:  */
 19: export type PullRequest = PullRequestRow;
 20: export type { PullRequestInsert, PullRequestUpdate };
 21: 
 22: /**
 23:  * PullRequest Repository
 24:  *
 25:  * æä¾› Pull Request ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 26:  *
 27:  * @example
 28:  * ```typescript
 29:  * const prRepo = inject(PullRequestRepository);
 30:  * prRepo.findByBlueprintId('blueprint-id').subscribe(prs => {
 31:  *   console.log('Pull Requests:', prs);
 32:  * });
 33:  * ```
 34:  */
 35: @Injectable({
 36:   providedIn: 'root'
 37: })
 38: export class PullRequestRepository extends BaseRepository<PullRequest, PullRequestInsert, PullRequestUpdate> {
 39:   protected tableName = 'pull_requests';
 40: 
 41:   /**
 42:    * æ ¹æ®è“å›¾ ID æŸ¥è¯¢ Pull Request åˆ—è¡¨
 43:    *
 44:    * @param blueprintId è“å›¾ ID
 45:    * @param options æŸ¥è¯¢é€‰é¡¹
 46:    * @returns Observable<PullRequest[]>
 47:    */
 48:   findByBlueprintId(blueprintId: string, options?: QueryOptions): Observable<PullRequest[]> {
 49:     return this.findAll({
 50:       ...options,
 51:       filters: {
 52:         ...options?.filters,
 53:         blueprintId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º blueprint_id
 54:       }
 55:     });
 56:   }
 57: 
 58:   /**
 59:    * æ ¹æ®åˆ†æ”¯ ID æŸ¥è¯¢ Pull Request åˆ—è¡¨
 60:    *
 61:    * @param branchId åˆ†æ”¯ ID
 62:    * @param options æŸ¥è¯¢é€‰é¡¹
 63:    * @returns Observable<PullRequest[]>
 64:    */
 65:   findByBranchId(branchId: string, options?: QueryOptions): Observable<PullRequest[]> {
 66:     return this.findAll({
 67:       ...options,
 68:       filters: {
 69:         ...options?.filters,
 70:         branchId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º branch_id
 71:       }
 72:     });
 73:   }
 74: 
 75:   /**
 76:    * æ ¹æ®çŠ¶æ€æŸ¥è¯¢ Pull Request åˆ—è¡¨
 77:    *
 78:    * @param status PR çŠ¶æ€
 79:    * @param options æŸ¥è¯¢é€‰é¡¹
 80:    * @returns Observable<PullRequest[]>
 81:    */
 82:   findByStatus(status: PRStatus, options?: QueryOptions): Observable<PullRequest[]> {
 83:     return this.findAll({
 84:       ...options,
 85:       filters: {
 86:         ...options?.filters,
 87:         status
 88:       }
 89:     });
 90:   }
 91: 
 92:   /**
 93:    * æŸ¥è¯¢æ‰“å¼€çš„ Pull Request åˆ—è¡¨
 94:    *
 95:    * @param options æŸ¥è¯¢é€‰é¡¹
 96:    * @returns Observable<PullRequest[]>
 97:    */
 98:   findOpen(options?: QueryOptions): Observable<PullRequest[]> {
 99:     return this.findByStatus(PRStatus.OPEN, options);
100:   }
101: 
102:   /**
103:    * æŸ¥è¯¢å®¡æ ¸ä¸­çš„ Pull Request åˆ—è¡¨
104:    *
105:    * @param options æŸ¥è¯¢é€‰é¡¹
106:    * @returns Observable<PullRequest[]>
107:    */
108:   findReviewing(options?: QueryOptions): Observable<PullRequest[]> {
109:     return this.findByStatus(PRStatus.REVIEWING, options);
110:   }
111: 
112:   /**
113:    * æŸ¥è¯¢å·²åˆå¹¶çš„ Pull Request åˆ—è¡¨
114:    *
115:    * @param options æŸ¥è¯¢é€‰é¡¹
116:    * @returns Observable<PullRequest[]>
117:    */
118:   findMerged(options?: QueryOptions): Observable<PullRequest[]> {
119:     return this.findByStatus(PRStatus.MERGED, options);
120:   }
121: 
122:   /**
123:    * æ ¹æ®æäº¤è€… ID æŸ¥è¯¢ Pull Request åˆ—è¡¨
124:    *
125:    * @param submittedBy æäº¤è€… ID
126:    * @param options æŸ¥è¯¢é€‰é¡¹
127:    * @returns Observable<PullRequest[]>
128:    */
129:   findBySubmittedBy(submittedBy: string, options?: QueryOptions): Observable<PullRequest[]> {
130:     return this.findAll({
131:       ...options,
132:       filters: {
133:         ...options?.filters,
134:         submittedBy // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º submitted_by
135:       }
136:     });
137:   }
138: 
139:   /**
140:    * æ ¹æ®å®¡æ ¸è€… ID æŸ¥è¯¢ Pull Request åˆ—è¡¨
141:    *
142:    * @param reviewedBy å®¡æ ¸è€… ID
143:    * @param options æŸ¥è¯¢é€‰é¡¹
144:    * @returns Observable<PullRequest[]>
145:    */
146:   findByReviewedBy(reviewedBy: string, options?: QueryOptions): Observable<PullRequest[]> {
147:     return this.findAll({
148:       ...options,
149:       filters: {
150:         ...options?.filters,
151:         reviewedBy // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º reviewed_by
152:       }
153:     });
154:   }
155: }
````

## File: src/app/core/infra/repositories/report-photo.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: 
 4: import { BaseRepository, QueryOptions } from './base.repository';
 5: import { Database } from '../types/database.types';
 6: 
 7: /**
 8:  * ReportPhoto å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 9:  */
10: type ReportPhotoRow = Database['public']['Tables']['report_photos']['Row'];
11: type ReportPhotoInsert = Database['public']['Tables']['report_photos']['Insert'];
12: type ReportPhotoUpdate = Database['public']['Tables']['report_photos']['Update'];
13: 
14: export type ReportPhoto = ReportPhotoRow;
15: export type { ReportPhotoInsert, ReportPhotoUpdate };
16: 
17: /**
18:  * ReportPhoto Repository
19:  *
20:  * æä¾›æŠ¥å‘Šç…§ç‰‡ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
21:  */
22: @Injectable({
23:   providedIn: 'root'
24: })
25: export class ReportPhotoRepository extends BaseRepository<ReportPhoto, ReportPhotoInsert, ReportPhotoUpdate> {
26:   protected tableName = 'report_photos';
27: 
28:   /**
29:    * æ ¹æ®æŠ¥å‘Š ID æŸ¥è¯¢ç…§ç‰‡
30:    *
31:    * @param reportId æŠ¥å‘Š ID
32:    * @param options æŸ¥è¯¢é€‰é¡¹
33:    * @returns Observable<ReportPhoto[]>
34:    */
35:   findByReportId(reportId: string, options?: QueryOptions): Observable<ReportPhoto[]> {
36:     return this.findAll({
37:       ...options,
38:       filters: {
39:         ...options?.filters,
40:         reportId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º report_id
41:       },
42:       orderBy: 'sequence_order',
43:       orderDirection: 'asc'
44:     });
45:   }
46: 
47:   /**
48:    * æ ¹æ®æ–‡æ¡£ ID æŸ¥è¯¢ç…§ç‰‡
49:    *
50:    * @param documentId æ–‡æ¡£ ID
51:    * @param options æŸ¥è¯¢é€‰é¡¹
52:    * @returns Observable<ReportPhoto[]>
53:    */
54:   findByDocumentId(documentId: string, options?: QueryOptions): Observable<ReportPhoto[]> {
55:     return this.findAll({
56:       ...options,
57:       filters: {
58:         ...options?.filters,
59:         documentId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º document_id
60:       }
61:     });
62:   }
63: 
64:   /**
65:    * æ ¹æ®ä¸Šä¼ è€… ID æŸ¥è¯¢ç…§ç‰‡
66:    *
67:    * @param uploadedBy ä¸Šä¼ è€… ID
68:    * @param options æŸ¥è¯¢é€‰é¡¹
69:    * @returns Observable<ReportPhoto[]>
70:    */
71:   findByUploadedBy(uploadedBy: string, options?: QueryOptions): Observable<ReportPhoto[]> {
72:     return this.findAll({
73:       ...options,
74:       filters: {
75:         ...options?.filters,
76:         uploadedBy // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º uploaded_by
77:       }
78:     });
79:   }
80: }
````

## File: src/app/core/infra/repositories/task-assignment.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: 
 4: import { BaseRepository, QueryOptions } from './base.repository';
 5: import { Database } from '../types/database.types';
 6: import { TaskAssigneeType } from '../types/task.types';
 7: 
 8: /**
 9:  * TaskAssignment å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
10:  */
11: type TaskAssignmentRow = Database['public']['Tables']['task_assignments']['Row'];
12: type TaskAssignmentInsert = Database['public']['Tables']['task_assignments']['Insert'];
13: type TaskAssignmentUpdate = Database['public']['Tables']['task_assignments']['Update'];
14: 
15: export type TaskAssignment = TaskAssignmentRow;
16: export type { TaskAssignmentInsert, TaskAssignmentUpdate };
17: 
18: /**
19:  * TaskAssignment Repository
20:  *
21:  * æä¾›ä»»åŠ¡æŒ‡æ´¾ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
22:  */
23: @Injectable({
24:   providedIn: 'root'
25: })
26: export class TaskAssignmentRepository extends BaseRepository<TaskAssignment, TaskAssignmentInsert, TaskAssignmentUpdate> {
27:   protected tableName = 'task_assignments';
28: 
29:   /**
30:    * æ ¹æ®ä»»åŠ¡ ID æŸ¥è¯¢æŒ‡æ´¾
31:    *
32:    * @param taskId ä»»åŠ¡ ID
33:    * @param options æŸ¥è¯¢é€‰é¡¹
34:    * @returns Observable<TaskAssignment[]>
35:    */
36:   findByTaskId(taskId: string, options?: QueryOptions): Observable<TaskAssignment[]> {
37:     return this.findAll({
38:       ...options,
39:       filters: {
40:         ...options?.filters,
41:         taskId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º task_id
42:       }
43:     });
44:   }
45: 
46:   /**
47:    * æ ¹æ®æŒ‡æ´¾å¯¹è±¡ ID æŸ¥è¯¢æŒ‡æ´¾
48:    *
49:    * @param assigneeId æŒ‡æ´¾å¯¹è±¡ ID
50:    * @param options æŸ¥è¯¢é€‰é¡¹
51:    * @returns Observable<TaskAssignment[]>
52:    */
53:   findByAssigneeId(assigneeId: string, options?: QueryOptions): Observable<TaskAssignment[]> {
54:     return this.findAll({
55:       ...options,
56:       filters: {
57:         ...options?.filters,
58:         assigneeId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º assignee_id
59:       }
60:     });
61:   }
62: 
63:   /**
64:    * æ ¹æ®æŒ‡æ´¾ç±»å‹æŸ¥è¯¢æŒ‡æ´¾
65:    *
66:    * @param assigneeType æŒ‡æ´¾ç±»å‹
67:    * @param options æŸ¥è¯¢é€‰é¡¹
68:    * @returns Observable<TaskAssignment[]>
69:    */
70:   findByAssigneeType(assigneeType: TaskAssigneeType, options?: QueryOptions): Observable<TaskAssignment[]> {
71:     return this.findAll({
72:       ...options,
73:       filters: {
74:         ...options?.filters,
75:         assigneeType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º assignee_type
76:       }
77:     });
78:   }
79: 
80:   /**
81:    * æ ¹æ®æŒ‡æ´¾è€… ID æŸ¥è¯¢æŒ‡æ´¾
82:    *
83:    * @param assignedBy æŒ‡æ´¾è€… ID
84:    * @param options æŸ¥è¯¢é€‰é¡¹
85:    * @returns Observable<TaskAssignment[]>
86:    */
87:   findByAssignedBy(assignedBy: string, options?: QueryOptions): Observable<TaskAssignment[]> {
88:     return this.findAll({
89:       ...options,
90:       filters: {
91:         ...options?.filters,
92:         assignedBy // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º assigned_by
93:       }
94:     });
95:   }
96: }
````

## File: src/app/core/infra/repositories/task-dependency.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: 
 4: import { BaseRepository, QueryOptions } from './base.repository';
 5: import { Database } from '../types/database.types';
 6: import { TaskDependencyType } from '../types/task.types';
 7: 
 8: /**
 9:  * TaskDependency å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
10:  */
11: type TaskDependencyRow = Database['public']['Tables']['task_dependencies']['Row'];
12: type TaskDependencyInsert = Database['public']['Tables']['task_dependencies']['Insert'];
13: type TaskDependencyUpdate = Database['public']['Tables']['task_dependencies']['Update'];
14: 
15: export type TaskDependency = TaskDependencyRow;
16: export type { TaskDependencyInsert, TaskDependencyUpdate };
17: 
18: /**
19:  * TaskDependency Repository
20:  *
21:  * æä¾›ä»»åŠ¡ä¾èµ–å…³ç³»ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
22:  */
23: @Injectable({
24:   providedIn: 'root'
25: })
26: export class TaskDependencyRepository extends BaseRepository<TaskDependency, TaskDependencyInsert, TaskDependencyUpdate> {
27:   protected tableName = 'task_dependencies';
28: 
29:   /**
30:    * æ ¹æ®ä»»åŠ¡ ID æŸ¥è¯¢ä¾èµ–å…³ç³»
31:    *
32:    * @param taskId ä»»åŠ¡ ID
33:    * @param options æŸ¥è¯¢é€‰é¡¹
34:    * @returns Observable<TaskDependency[]>
35:    */
36:   findByTaskId(taskId: string, options?: QueryOptions): Observable<TaskDependency[]> {
37:     return this.findAll({
38:       ...options,
39:       filters: {
40:         ...options?.filters,
41:         taskId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º task_id
42:       }
43:     });
44:   }
45: 
46:   /**
47:    * æ ¹æ®ä¾èµ–ä»»åŠ¡ ID æŸ¥è¯¢ä¾èµ–å…³ç³»
48:    *
49:    * @param dependsOnTaskId ä¾èµ–çš„ä»»åŠ¡ ID
50:    * @param options æŸ¥è¯¢é€‰é¡¹
51:    * @returns Observable<TaskDependency[]>
52:    */
53:   findByDependsOnTaskId(dependsOnTaskId: string, options?: QueryOptions): Observable<TaskDependency[]> {
54:     return this.findAll({
55:       ...options,
56:       filters: {
57:         ...options?.filters,
58:         dependsOnTaskId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º depends_on_task_id
59:       }
60:     });
61:   }
62: 
63:   /**
64:    * æ ¹æ®ä¾èµ–ç±»å‹æŸ¥è¯¢ä¾èµ–å…³ç³»
65:    *
66:    * @param dependencyType ä¾èµ–ç±»å‹
67:    * @param options æŸ¥è¯¢é€‰é¡¹
68:    * @returns Observable<TaskDependency[]>
69:    */
70:   findByDependencyType(dependencyType: TaskDependencyType, options?: QueryOptions): Observable<TaskDependency[]> {
71:     return this.findAll({
72:       ...options,
73:       filters: {
74:         ...options?.filters,
75:         dependencyType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º dependency_type
76:       }
77:     });
78:   }
79: }
````

## File: src/app/core/infra/repositories/task-list.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: 
 4: import { BaseRepository, QueryOptions } from './base.repository';
 5: import { Database } from '../types/database.types';
 6: import { TaskListType } from '../types/task.types';
 7: 
 8: /**
 9:  * TaskList å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
10:  */
11: type TaskListRow = Database['public']['Tables']['task_lists']['Row'];
12: type TaskListInsert = Database['public']['Tables']['task_lists']['Insert'];
13: type TaskListUpdate = Database['public']['Tables']['task_lists']['Update'];
14: 
15: export type TaskList = TaskListRow;
16: export type { TaskListInsert, TaskListUpdate };
17: 
18: /**
19:  * TaskList Repository
20:  *
21:  * æä¾›ä»»åŠ¡åˆ—è¡¨ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
22:  */
23: @Injectable({
24:   providedIn: 'root'
25: })
26: export class TaskListRepository extends BaseRepository<TaskList, TaskListInsert, TaskListUpdate> {
27:   protected tableName = 'task_lists';
28: 
29:   /**
30:    * æ ¹æ®è´¦æˆ· ID æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨
31:    *
32:    * @param accountId è´¦æˆ· ID
33:    * @param options æŸ¥è¯¢é€‰é¡¹
34:    * @returns Observable<TaskList[]>
35:    */
36:   findByAccountId(accountId: string, options?: QueryOptions): Observable<TaskList[]> {
37:     return this.findAll({
38:       ...options,
39:       filters: {
40:         ...options?.filters,
41:         accountId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º account_id
42:       }
43:     });
44:   }
45: 
46:   /**
47:    * æ ¹æ®ä»»åŠ¡ ID æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨
48:    *
49:    * @param taskId ä»»åŠ¡ ID
50:    * @param options æŸ¥è¯¢é€‰é¡¹
51:    * @returns Observable<TaskList[]>
52:    */
53:   findByTaskId(taskId: string, options?: QueryOptions): Observable<TaskList[]> {
54:     return this.findAll({
55:       ...options,
56:       filters: {
57:         ...options?.filters,
58:         taskId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º task_id
59:       }
60:     });
61:   }
62: 
63:   /**
64:    * æ ¹æ®åˆ—è¡¨ç±»å‹æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨
65:    *
66:    * @param listType åˆ—è¡¨ç±»å‹
67:    * @param options æŸ¥è¯¢é€‰é¡¹
68:    * @returns Observable<TaskList[]>
69:    */
70:   findByListType(listType: TaskListType, options?: QueryOptions): Observable<TaskList[]> {
71:     return this.findAll({
72:       ...options,
73:       filters: {
74:         ...options?.filters,
75:         listType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º list_type
76:       }
77:     });
78:   }
79: 
80:   /**
81:    * æŸ¥è¯¢å·²æŒ‡æ´¾çš„ä»»åŠ¡åˆ—è¡¨
82:    *
83:    * @param accountId è´¦æˆ· ID
84:    * @param options æŸ¥è¯¢é€‰é¡¹
85:    * @returns Observable<TaskList[]>
86:    */
87:   findAssigned(accountId: string, options?: QueryOptions): Observable<TaskList[]> {
88:     return this.findAll({
89:       ...options,
90:       filters: {
91:         ...options?.filters,
92:         accountId,
93:         listType: TaskListType.ASSIGNED
94:       }
95:     });
96:   }
97: }
````

## File: src/app/core/infra/repositories/task-staging.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: 
 4: import { BaseRepository, QueryOptions } from './base.repository';
 5: import { Database } from '../types/database.types';
 6: 
 7: /**
 8:  * TaskStaging å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 9:  */
10: type TaskStagingRow = Database['public']['Tables']['task_staging']['Row'];
11: type TaskStagingInsert = Database['public']['Tables']['task_staging']['Insert'];
12: type TaskStagingUpdate = Database['public']['Tables']['task_staging']['Update'];
13: 
14: export type TaskStaging = TaskStagingRow;
15: export type { TaskStagingInsert, TaskStagingUpdate };
16: 
17: /**
18:  * TaskStaging Repository
19:  *
20:  * æä¾›ä»»åŠ¡æš‚å­˜åŒºç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
21:  */
22: @Injectable({
23:   providedIn: 'root'
24: })
25: export class TaskStagingRepository extends BaseRepository<TaskStaging, TaskStagingInsert, TaskStagingUpdate> {
26:   protected tableName = 'task_staging';
27: 
28:   /**
29:    * æ ¹æ®ä»»åŠ¡ ID æŸ¥è¯¢æš‚å­˜è®°å½•
30:    *
31:    * @param taskId ä»»åŠ¡ ID
32:    * @param options æŸ¥è¯¢é€‰é¡¹
33:    * @returns Observable<TaskStaging[]>
34:    */
35:   findByTaskId(taskId: string, options?: QueryOptions): Observable<TaskStaging[]> {
36:     return this.findAll({
37:       ...options,
38:       filters: {
39:         ...options?.filters,
40:         taskId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º task_id
41:       }
42:     });
43:   }
44: 
45:   /**
46:    * æ ¹æ®æäº¤è€… ID æŸ¥è¯¢æš‚å­˜è®°å½•
47:    *
48:    * @param submittedBy æäº¤è€… ID
49:    * @param options æŸ¥è¯¢é€‰é¡¹
50:    * @returns Observable<TaskStaging[]>
51:    */
52:   findBySubmittedBy(submittedBy: string, options?: QueryOptions): Observable<TaskStaging[]> {
53:     return this.findAll({
54:       ...options,
55:       filters: {
56:         ...options?.filters,
57:         submittedBy // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º submitted_by
58:       }
59:     });
60:   }
61: 
62:   /**
63:    * æŸ¥è¯¢å¯æ’¤å›çš„æš‚å­˜è®°å½•ï¼ˆ48å°æ—¶å†…ä¸” can_withdraw = trueï¼‰
64:    *
65:    * @param options æŸ¥è¯¢é€‰é¡¹
66:    * @returns Observable<TaskStaging[]>
67:    */
68:   findWithdrawable(options?: QueryOptions): Observable<TaskStaging[]> {
69:     return this.findAll({
70:       ...options,
71:       filters: {
72:         ...options?.filters,
73:         canWithdraw: true // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º can_withdraw
74:         // TODO: æ·»åŠ  expires_at > NOW() çš„æ¡ä»¶
75:       }
76:     });
77:   }
78: 
79:   /**
80:    * æŸ¥è¯¢å·²è¿‡æœŸçš„æš‚å­˜è®°å½•ï¼ˆexpires_at < NOW()ï¼‰
81:    *
82:    * @param options æŸ¥è¯¢é€‰é¡¹
83:    * @returns Observable<TaskStaging[]>
84:    */
85:   findExpired(options?: QueryOptions): Observable<TaskStaging[]> {
86:     // TODO: å®ç°è¿‡æœŸæŸ¥è¯¢
87:     // éœ€è¦ä½¿ç”¨æ•°æ®åº“å‡½æ•°æˆ– RPC æ¥æ¯”è¾ƒæ—¶é—´
88:     return this.findAll({
89:       ...options,
90:       filters: {
91:         ...options?.filters
92:         // expires_at æ¯”è¾ƒéœ€è¦ç‰¹æ®Šå¤„ç†
93:       }
94:     });
95:   }
96: }
````

## File: src/app/core/infra/repositories/task-template.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: 
 4: import { BaseRepository, QueryOptions } from './base.repository';
 5: import { Database } from '../types/database.types';
 6: 
 7: /**
 8:  * TaskTemplate å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 9:  */
10: type TaskTemplateRow = Database['public']['Tables']['task_templates']['Row'];
11: type TaskTemplateInsert = Database['public']['Tables']['task_templates']['Insert'];
12: type TaskTemplateUpdate = Database['public']['Tables']['task_templates']['Update'];
13: 
14: export type TaskTemplate = TaskTemplateRow;
15: export type { TaskTemplateInsert, TaskTemplateUpdate };
16: 
17: /**
18:  * TaskTemplate Repository
19:  *
20:  * æä¾›ä»»åŠ¡æ¨¡æ¿ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
21:  */
22: @Injectable({
23:   providedIn: 'root'
24: })
25: export class TaskTemplateRepository extends BaseRepository<TaskTemplate, TaskTemplateInsert, TaskTemplateUpdate> {
26:   protected tableName = 'task_templates';
27: 
28:   /**
29:    * æ ¹æ®ç»„ç»‡ ID æŸ¥è¯¢ä»»åŠ¡æ¨¡æ¿
30:    *
31:    * @param organizationId ç»„ç»‡ ID
32:    * @param options æŸ¥è¯¢é€‰é¡¹
33:    * @returns Observable<TaskTemplate[]>
34:    */
35:   findByOrganizationId(organizationId: string, options?: QueryOptions): Observable<TaskTemplate[]> {
36:     return this.findAll({
37:       ...options,
38:       filters: {
39:         ...options?.filters,
40:         organizationId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º organization_id
41:       }
42:     });
43:   }
44: 
45:   /**
46:    * æŸ¥è¯¢å…¬å…±æ¨¡æ¿ï¼ˆis_public = trueï¼‰
47:    *
48:    * @param options æŸ¥è¯¢é€‰é¡¹
49:    * @returns Observable<TaskTemplate[]>
50:    */
51:   findPublic(options?: QueryOptions): Observable<TaskTemplate[]> {
52:     return this.findAll({
53:       ...options,
54:       filters: {
55:         ...options?.filters,
56:         isPublic: true // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º is_public
57:       }
58:     });
59:   }
60: }
````

## File: src/app/core/infra/repositories/task.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: import { TaskStatus, TaskType, TaskPriority } from '../types/task.types';
  8: 
  9: /**
 10:  * Task å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 11:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–ï¼Œåç»­ä¼šé€šè¿‡è½¬æ¢å·¥å…·è½¬æ¢ä¸º camelCase
 12:  */
 13: type TaskRow = Database['public']['Tables']['tasks']['Row'];
 14: type TaskInsert = Database['public']['Tables']['tasks']['Insert'];
 15: type TaskUpdate = Database['public']['Tables']['tasks']['Update'];
 16: 
 17: /**
 18:  * Task å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 19:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 20:  */
 21: export type Task = TaskRow;
 22: export type { TaskInsert, TaskUpdate };
 23: 
 24: /**
 25:  * Task Repository
 26:  *
 27:  * æä¾›ä»»åŠ¡ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•ï¼ŒåŒ…æ‹¬æ ‘çŠ¶ç»“æ„æŸ¥è¯¢
 28:  *
 29:  * @example
 30:  * ```typescript
 31:  * const taskRepo = inject(TaskRepository);
 32:  * taskRepo.findByBlueprintId('blueprint-id').subscribe(tasks => {
 33:  *   console.log('Blueprint tasks:', tasks);
 34:  * });
 35:  * ```
 36:  */
 37: @Injectable({
 38:   providedIn: 'root'
 39: })
 40: export class TaskRepository extends BaseRepository<Task, TaskInsert, TaskUpdate> {
 41:   protected tableName = 'tasks';
 42: 
 43:   /**
 44:    * æ ¹æ®è“å›¾ ID æŸ¥è¯¢ä»»åŠ¡
 45:    *
 46:    * @param blueprintId è“å›¾ ID
 47:    * @param options æŸ¥è¯¢é€‰é¡¹
 48:    * @returns Observable<Task[]>
 49:    */
 50:   findByBlueprintId(blueprintId: string, options?: QueryOptions): Observable<Task[]> {
 51:     return this.findAll({
 52:       ...options,
 53:       filters: {
 54:         ...options?.filters,
 55:         blueprintId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º blueprint_id
 56:       }
 57:     });
 58:   }
 59: 
 60:   /**
 61:    * æ ¹æ®åˆ†æ”¯ ID æŸ¥è¯¢ä»»åŠ¡
 62:    *
 63:    * @param branchId åˆ†æ”¯ ID
 64:    * @param options æŸ¥è¯¢é€‰é¡¹
 65:    * @returns Observable<Task[]>
 66:    */
 67:   findByBranchId(branchId: string, options?: QueryOptions): Observable<Task[]> {
 68:     return this.findAll({
 69:       ...options,
 70:       filters: {
 71:         ...options?.filters,
 72:         branchId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º branch_id
 73:       }
 74:     });
 75:   }
 76: 
 77:   /**
 78:    * æ ¹æ®çˆ¶ä»»åŠ¡ ID æŸ¥è¯¢å­ä»»åŠ¡
 79:    *
 80:    * @param parentTaskId çˆ¶ä»»åŠ¡ ID
 81:    * @param options æŸ¥è¯¢é€‰é¡¹
 82:    * @returns Observable<Task[]>
 83:    */
 84:   findChildren(parentTaskId: string, options?: QueryOptions): Observable<Task[]> {
 85:     return this.findAll({
 86:       ...options,
 87:       filters: {
 88:         ...options?.filters,
 89:         parentTaskId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º parent_task_id
 90:       },
 91:       orderBy: 'sequence_order',
 92:       orderDirection: 'asc'
 93:     });
 94:   }
 95: 
 96:   /**
 97:    * æŸ¥è¯¢æ ¹ä»»åŠ¡ï¼ˆæ²¡æœ‰çˆ¶ä»»åŠ¡çš„ä»»åŠ¡ï¼‰
 98:    *
 99:    * @param blueprintId è“å›¾ ID
100:    * @param options æŸ¥è¯¢é€‰é¡¹
101:    * @returns Observable<Task[]>
102:    */
103:   findRootTasks(blueprintId: string, options?: QueryOptions): Observable<Task[]> {
104:     return this.findAll({
105:       ...options,
106:       filters: {
107:         ...options?.filters,
108:         blueprintId,
109:         parentTaskId: null // æ ¹ä»»åŠ¡æ²¡æœ‰çˆ¶ä»»åŠ¡
110:       },
111:       orderBy: 'sequence_order',
112:       orderDirection: 'asc'
113:     });
114:   }
115: 
116:   /**
117:    * æ ¹æ®çŠ¶æ€æŸ¥è¯¢ä»»åŠ¡
118:    *
119:    * @param status ä»»åŠ¡çŠ¶æ€
120:    * @param options æŸ¥è¯¢é€‰é¡¹
121:    * @returns Observable<Task[]>
122:    */
123:   findByStatus(status: TaskStatus, options?: QueryOptions): Observable<Task[]> {
124:     return this.findAll({
125:       ...options,
126:       filters: {
127:         ...options?.filters,
128:         status
129:       }
130:     });
131:   }
132: 
133:   /**
134:    * æ ¹æ®ç±»å‹æŸ¥è¯¢ä»»åŠ¡
135:    *
136:    * @param taskType ä»»åŠ¡ç±»å‹
137:    * @param options æŸ¥è¯¢é€‰é¡¹
138:    * @returns Observable<Task[]>
139:    */
140:   findByType(taskType: TaskType, options?: QueryOptions): Observable<Task[]> {
141:     return this.findAll({
142:       ...options,
143:       filters: {
144:         ...options?.filters,
145:         taskType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º task_type
146:       }
147:     });
148:   }
149: 
150:   /**
151:    * æ ¹æ®ä¼˜å…ˆçº§æŸ¥è¯¢ä»»åŠ¡
152:    *
153:    * @param priority ä»»åŠ¡ä¼˜å…ˆçº§
154:    * @param options æŸ¥è¯¢é€‰é¡¹
155:    * @returns Observable<Task[]>
156:    */
157:   findByPriority(priority: TaskPriority, options?: QueryOptions): Observable<Task[]> {
158:     return this.findAll({
159:       ...options,
160:       filters: {
161:         ...options?.filters,
162:         priority
163:       }
164:     });
165:   }
166: 
167:   /**
168:    * æŸ¥è¯¢å¾…å¤„ç†çš„ä»»åŠ¡ï¼ˆçŠ¶æ€ä¸º pendingï¼‰
169:    *
170:    * @param options æŸ¥è¯¢é€‰é¡¹
171:    * @returns Observable<Task[]>
172:    */
173:   findPending(options?: QueryOptions): Observable<Task[]> {
174:     return this.findByStatus(TaskStatus.PENDING, options);
175:   }
176: 
177:   /**
178:    * æŸ¥è¯¢è¿›è¡Œä¸­çš„ä»»åŠ¡ï¼ˆçŠ¶æ€ä¸º in_progressï¼‰
179:    *
180:    * @param options æŸ¥è¯¢é€‰é¡¹
181:    * @returns Observable<Task[]>
182:    */
183:   findInProgress(options?: QueryOptions): Observable<Task[]> {
184:     return this.findByStatus(TaskStatus.IN_PROGRESS, options);
185:   }
186: 
187:   /**
188:    * æŸ¥è¯¢å·²å®Œæˆçš„ä»»åŠ¡ï¼ˆçŠ¶æ€ä¸º completedï¼‰
189:    *
190:    * @param options æŸ¥è¯¢é€‰é¡¹
191:    * @returns Observable<Task[]>
192:    */
193:   findCompleted(options?: QueryOptions): Observable<Task[]> {
194:     return this.findByStatus(TaskStatus.COMPLETED, options);
195:   }
196: 
197:   /**
198:    * ä½¿ç”¨ ltree æŸ¥è¯¢å­æ ‘
199:    *
200:    * æ³¨æ„ï¼šæ­¤æ–¹æ³•éœ€è¦ä½¿ç”¨ PostgreSQL ltree æ“ä½œç¬¦
201:    * å¦‚æœ BaseRepository ä¸æ”¯æŒï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ RPC å‡½æ•°æˆ–åŸç”Ÿ SQL
202:    *
203:    * @param treePath ltree è·¯å¾„
204:    * @param options æŸ¥è¯¢é€‰é¡¹
205:    * @returns Observable<Task[]>
206:    */
207:   findSubtree(treePath: string, options?: QueryOptions): Observable<Task[]> {
208:     // TODO: å®ç° ltree æŸ¥è¯¢
209:     // éœ€è¦ä½¿ç”¨ PostgreSQL çš„ <@ æ“ä½œç¬¦æˆ– RPC å‡½æ•°
210:     // ç¤ºä¾‹ï¼šWHERE tree_path <@ 'path.to.parent'
211:     // å½“å‰å…ˆä½¿ç”¨ç®€å•çš„ parent_task_id æŸ¥è¯¢ä½œä¸ºä¸´æ—¶æ–¹æ¡ˆ
212:     return this.findAll({
213:       ...options,
214:       filters: {
215:         ...options?.filters
216:         // treePath æŸ¥è¯¢éœ€è¦ç‰¹æ®Šå¤„ç†
217:       }
218:     });
219:   }
220: 
221:   /**
222:    * æŸ¥è¯¢ä»»åŠ¡çš„å®Œæ•´è·¯å¾„ï¼ˆä»æ ¹åˆ°å½“å‰ä»»åŠ¡ï¼‰
223:    *
224:    * @param taskId ä»»åŠ¡ ID
225:    * @returns Observable<Task[]>
226:    */
227:   findTaskPath(taskId: string): Observable<Task[]> {
228:     // TODO: å®ç°è·¯å¾„æŸ¥è¯¢
229:     // éœ€è¦ä½¿ç”¨é€’å½’æŸ¥è¯¢æˆ– ltree æ“ä½œç¬¦
230:     // å½“å‰å…ˆè¿”å›å•ä¸ªä»»åŠ¡ä½œä¸ºä¸´æ—¶æ–¹æ¡ˆ
231:     return this.findById(taskId).pipe(map(task => (task ? [task] : [])));
232:   }
233: }
````

## File: src/app/core/infra/repositories/team-member.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: 
  4: import { BaseRepository, QueryOptions } from './base.repository';
  5: import { TeamMemberRole } from '../types/account.types';
  6: import { Database } from '../types/database.types';
  7: 
  8: /**
  9:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 10:  */
 11: type TeamMemberRow = Database['public']['Tables']['team_members']['Row'];
 12: type TeamMemberInsert = Database['public']['Tables']['team_members']['Insert'];
 13: type TeamMemberUpdate = Database['public']['Tables']['team_members']['Update'];
 14: 
 15: /**
 16:  * TeamMember å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 17:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 18:  */
 19: export type TeamMember = TeamMemberRow;
 20: export type { TeamMemberInsert, TeamMemberUpdate };
 21: 
 22: /**
 23:  * TeamMember Repository
 24:  *
 25:  * æä¾›å›¢é˜Ÿæˆå‘˜ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 26:  *
 27:  * @example
 28:  * ```typescript
 29:  * const teamMemberRepo = inject(TeamMemberRepository);
 30:  * teamMemberRepo.findByTeamId('team-id').subscribe(members => {
 31:  *   console.log('Team members:', members);
 32:  * });
 33:  * ```
 34:  */
 35: @Injectable({
 36:   providedIn: 'root'
 37: })
 38: export class TeamMemberRepository extends BaseRepository<TeamMember, TeamMemberInsert, TeamMemberUpdate> {
 39:   protected tableName = 'team_members';
 40: 
 41:   /**
 42:    * æ ¹æ®å›¢é˜Ÿ ID æŸ¥è¯¢å›¢é˜Ÿæˆå‘˜åˆ—è¡¨
 43:    *
 44:    * @param teamId å›¢é˜Ÿ ID
 45:    * @param options æŸ¥è¯¢é€‰é¡¹
 46:    * @returns Observable<TeamMember[]>
 47:    */
 48:   findByTeamId(teamId: string, options?: QueryOptions): Observable<TeamMember[]> {
 49:     return this.findAll({
 50:       ...options,
 51:       filters: {
 52:         ...options?.filters,
 53:         teamId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º team_id
 54:       }
 55:     });
 56:   }
 57: 
 58:   /**
 59:    * æ ¹æ®è´¦æˆ· ID æŸ¥è¯¢å›¢é˜Ÿæˆå‘˜å…³ç³»
 60:    *
 61:    * @param accountId è´¦æˆ· ID
 62:    * @param options æŸ¥è¯¢é€‰é¡¹
 63:    * @returns Observable<TeamMember[]>
 64:    */
 65:   findByAccountId(accountId: string, options?: QueryOptions): Observable<TeamMember[]> {
 66:     return this.findAll({
 67:       ...options,
 68:       filters: {
 69:         ...options?.filters,
 70:         accountId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º account_id
 71:       }
 72:     });
 73:   }
 74: 
 75:   /**
 76:    * æ ¹æ®è§’è‰²æŸ¥è¯¢å›¢é˜Ÿæˆå‘˜
 77:    *
 78:    * @param role æˆå‘˜è§’è‰²
 79:    * @param options æŸ¥è¯¢é€‰é¡¹
 80:    * @returns Observable<TeamMember[]>
 81:    */
 82:   findByRole(role: TeamMemberRole, options?: QueryOptions): Observable<TeamMember[]> {
 83:     return this.findAll({
 84:       ...options,
 85:       filters: {
 86:         ...options?.filters,
 87:         role
 88:       }
 89:     });
 90:   }
 91: 
 92:   /**
 93:    * æŸ¥è¯¢å›¢é˜Ÿä¸­çš„è´Ÿè´£äººï¼ˆleaderï¼‰
 94:    *
 95:    * @param teamId å›¢é˜Ÿ ID
 96:    * @returns Observable<TeamMember[]>
 97:    */
 98:   findLeadersByTeamId(teamId: string): Observable<TeamMember[]> {
 99:     return this.findAll({
100:       filters: {
101:         teamId, // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º team_id
102:         role: TeamMemberRole.LEADER
103:       }
104:     });
105:   }
106: }
````

## File: src/app/core/infra/repositories/weather-cache.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: import { map } from 'rxjs/operators';
 4: 
 5: import { BaseRepository, QueryOptions } from './base.repository';
 6: import { Database } from '../types/database.types';
 7: 
 8: /**
 9:  * WeatherCache å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
10:  */
11: type WeatherCacheRow = Database['public']['Tables']['weather_cache']['Row'];
12: type WeatherCacheInsert = Database['public']['Tables']['weather_cache']['Insert'];
13: type WeatherCacheUpdate = Database['public']['Tables']['weather_cache']['Update'];
14: 
15: export type WeatherCache = WeatherCacheRow;
16: export type { WeatherCacheInsert, WeatherCacheUpdate };
17: 
18: /**
19:  * WeatherCache Repository
20:  *
21:  * æä¾›å¤©æ°”ç¼“å­˜ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
22:  */
23: @Injectable({
24:   providedIn: 'root'
25: })
26: export class WeatherCacheRepository extends BaseRepository<WeatherCache, WeatherCacheInsert, WeatherCacheUpdate> {
27:   protected tableName = 'weather_cache';
28: 
29:   /**
30:    * æ ¹æ®ä½ç½®æŸ¥è¯¢å¤©æ°”ç¼“å­˜
31:    *
32:    * @param location ä½ç½®
33:    * @param options æŸ¥è¯¢é€‰é¡¹
34:    * @returns Observable<WeatherCache[]>
35:    */
36:   findByLocation(location: string, options?: QueryOptions): Observable<WeatherCache[]> {
37:     return this.findAll({
38:       ...options,
39:       filters: {
40:         ...options?.filters,
41:         location
42:       },
43:       orderBy: 'forecast_date',
44:       orderDirection: 'desc'
45:     });
46:   }
47: 
48:   /**
49:    * æ ¹æ®ä½ç½®å’Œæ—¥æœŸæŸ¥è¯¢å¤©æ°”ç¼“å­˜
50:    *
51:    * @param location ä½ç½®
52:    * @param forecastDate é¢„æŠ¥æ—¥æœŸ
53:    * @returns Observable<WeatherCache | null>
54:    */
55:   findByLocationAndDate(location: string, forecastDate: string): Observable<WeatherCache | null> {
56:     return this.findAll({
57:       filters: {
58:         location,
59:         forecastDate // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º forecast_date
60:       }
61:     }).pipe(map(caches => (caches.length > 0 ? caches[0] : null)));
62:   }
63: 
64:   /**
65:    * æŸ¥è¯¢æœ‰æ•ˆçš„å¤©æ°”ç¼“å­˜ï¼ˆæœªè¿‡æœŸï¼‰
66:    *
67:    * @param location ä½ç½®
68:    * @param options æŸ¥è¯¢é€‰é¡¹
69:    * @returns Observable<WeatherCache[]>
70:    */
71:   findValid(location: string, options?: QueryOptions): Observable<WeatherCache[]> {
72:     // TODO: å®ç°è¿‡æœŸæ£€æŸ¥
73:     // éœ€è¦ä½¿ç”¨æ•°æ®åº“å‡½æ•°æˆ– RPC æ¥æ¯”è¾ƒ expires_at > NOW()
74:     return this.findByLocation(location, options);
75:   }
76: }
````

## File: src/app/core/infra/types/blueprint.types.ts
````typescript
 1: /**
 2:  * è“å›¾ç³»ç»Ÿç›¸å…³ç±»å‹å®šä¹‰ï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰
 3:  *
 4:  * è¿™äº›ç±»å‹è¢« Repository å±‚ä½¿ç”¨ï¼Œå› æ­¤æ”¾åœ¨ core å±‚
 5:  * ç¬¦åˆåˆ†å±‚æ¶æ„ï¼šcore ä¸ä¾èµ– shared
 6:  *
 7:  * @module core/infra/types
 8:  */
 9: 
10: /**
11:  * è“å›¾çŠ¶æ€æšä¸¾
12:  * å¯¹åº”æ•°æ®åº“ blueprints.status å­—æ®µ
13:  */
14: export enum BlueprintStatus {
15:   /** è§„åˆ’ä¸­ */
16:   PLANNING = 'planning',
17:   /** è¿›è¡Œä¸­ */
18:   ACTIVE = 'active',
19:   /** æš‚åœ */
20:   ON_HOLD = 'on_hold',
21:   /** å·²å®Œæˆ */
22:   COMPLETED = 'completed',
23:   /** å·²å½’æ¡£ */
24:   ARCHIVED = 'archived'
25: }
26: 
27: /**
28:  * åˆ†æ”¯ç±»å‹æšä¸¾
29:  * å¯¹åº”æ•°æ®åº“ blueprint_branches.branch_type å­—æ®µ
30:  */
31: export enum BranchType {
32:   /** æ‰¿æ½å•† */
33:   CONTRACTOR = 'contractor',
34:   /** åˆ†åŒ…å•† */
35:   SUBCONTRACTOR = 'subcontractor',
36:   /** é¡¾é—® */
37:   CONSULTANT = 'consultant'
38: }
39: 
40: /**
41:  * åˆ†æ”¯çŠ¶æ€æšä¸¾
42:  * å¯¹åº”æ•°æ®åº“ blueprint_branches.status å­—æ®µ
43:  */
44: export enum BranchStatus {
45:   /** æ´»è·ƒ */
46:   ACTIVE = 'active',
47:   /** å·²åˆå¹¶ */
48:   MERGED = 'merged',
49:   /** å·²å…³é—­ */
50:   CLOSED = 'closed'
51: }
52: 
53: /**
54:  * Pull Request çŠ¶æ€æšä¸¾
55:  * å¯¹åº”æ•°æ®åº“ pull_requests.status å­—æ®µ
56:  */
57: export enum PRStatus {
58:   /** æ‰“å¼€ */
59:   OPEN = 'open',
60:   /** å®¡æ ¸ä¸­ */
61:   REVIEWING = 'reviewing',
62:   /** å·²æ‰¹å‡† */
63:   APPROVED = 'approved',
64:   /** å·²æ‹’ç» */
65:   REJECTED = 'rejected',
66:   /** å·²åˆå¹¶ */
67:   MERGED = 'merged',
68:   /** å·²å…³é—­ */
69:   CLOSED = 'closed'
70: }
````

## File: src/app/core/infra/types/collaboration.types.ts
````typescript
 1: /**
 2:  * ç»„ç»‡åä½œç›¸å…³ç±»å‹å®šä¹‰ï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰
 3:  *
 4:  * è¿™äº›ç±»å‹è¢« Repository å±‚ä½¿ç”¨ï¼Œå› æ­¤æ”¾åœ¨ core å±‚
 5:  * ç¬¦åˆåˆ†å±‚æ¶æ„ï¼šcore ä¸ä¾èµ– shared
 6:  *
 7:  * @module core/infra/types
 8:  */
 9: 
10: /**
11:  * åä½œç±»å‹æšä¸¾
12:  * å¯¹åº”æ•°æ®åº“ organization_collaborations.collaboration_type å­—æ®µ
13:  */
14: export enum CollaborationType {
15:   /** æ‰¿æ½å•† */
16:   CONTRACTOR = 'contractor',
17:   /** æ¬¡æ‰¿æ½å•† */
18:   SUBCONTRACTOR = 'subcontractor',
19:   /** é¡¾é—® */
20:   CONSULTANT = 'consultant',
21:   /** åˆä½œä¼™ä¼´ */
22:   PARTNER = 'partner'
23: }
24: 
25: /**
26:  * åä½œçŠ¶æ€æšä¸¾
27:  * å¯¹åº”æ•°æ®åº“ organization_collaborations.status å­—æ®µ
28:  */
29: export enum CollaborationStatus {
30:   /** å¾…å¤„ç† */
31:   PENDING = 'pending',
32:   /** æ´»è·ƒ */
33:   ACTIVE = 'active',
34:   /** å·²æš‚åœ */
35:   SUSPENDED = 'suspended',
36:   /** å·²ç»“æŸ */
37:   ENDED = 'ended'
38: }
39: 
40: /**
41:  * é‚€è¯·çŠ¶æ€æšä¸¾
42:  * å¯¹åº”æ•°æ®åº“ collaboration_invitations.status å­—æ®µ
43:  */
44: export enum InvitationStatus {
45:   /** å¾…å¤„ç† */
46:   PENDING = 'pending',
47:   /** å·²æ¥å— */
48:   ACCEPTED = 'accepted',
49:   /** å·²æ‹’ç» */
50:   REJECTED = 'rejected',
51:   /** å·²è¿‡æœŸ */
52:   EXPIRED = 'expired'
53: }
````

## File: src/app/core/infra/types/index.ts
````typescript
1: /**
2:  * ç±»å‹å®šä¹‰æ¨¡å—å¯¼å‡º
3:  */
4: export * from './database.types';
5: export * from './account.types';
6: export * from './collaboration.types';
7: export * from './blueprint.types';
8: export * from './task.types';
````

## File: src/app/core/infra/types/task.types.ts
````typescript
  1: /**
  2:  * ä»»åŠ¡ç³»ç»Ÿç›¸å…³ç±»å‹å®šä¹‰ï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰
  3:  *
  4:  * è¿™äº›ç±»å‹è¢« Repository å±‚ä½¿ç”¨ï¼Œå› æ­¤æ”¾åœ¨ core å±‚
  5:  * ç¬¦åˆåˆ†å±‚æ¶æ„ï¼šcore ä¸ä¾èµ– shared
  6:  *
  7:  * @module core/infra/types
  8:  */
  9: 
 10: /**
 11:  * ä»»åŠ¡ç±»å‹æšä¸¾
 12:  * å¯¹åº”æ•°æ®åº“ tasks.task_type å­—æ®µ
 13:  */
 14: export enum TaskType {
 15:   /** é‡Œç¨‹ç¢‘ */
 16:   MILESTONE = 'milestone',
 17:   /** é˜¶æ®µ */
 18:   PHASE = 'phase',
 19:   /** ä»»åŠ¡ */
 20:   TASK = 'task',
 21:   /** å­ä»»åŠ¡ */
 22:   SUBTASK = 'subtask'
 23: }
 24: 
 25: /**
 26:  * ä»»åŠ¡çŠ¶æ€æšä¸¾
 27:  * å¯¹åº”æ•°æ®åº“ tasks.status å­—æ®µ
 28:  */
 29: export enum TaskStatus {
 30:   /** å¾…å¤„ç† */
 31:   PENDING = 'pending',
 32:   /** å·²æŒ‡æ´¾ */
 33:   ASSIGNED = 'assigned',
 34:   /** è¿›è¡Œä¸­ */
 35:   IN_PROGRESS = 'in_progress',
 36:   /** æš‚å­˜ä¸­ï¼ˆ48å°æ—¶å¯æ’¤å›ï¼‰ */
 37:   STAGING = 'staging',
 38:   /** å“ç®¡ä¸­ */
 39:   IN_QA = 'in_qa',
 40:   /** éªŒæ”¶ä¸­ */
 41:   IN_INSPECTION = 'in_inspection',
 42:   /** å·²å®Œæˆ */
 43:   COMPLETED = 'completed',
 44:   /** å·²å–æ¶ˆ */
 45:   CANCELLED = 'cancelled'
 46: }
 47: 
 48: /**
 49:  * ä»»åŠ¡ä¼˜å…ˆçº§æšä¸¾
 50:  * å¯¹åº”æ•°æ®åº“ tasks.priority å­—æ®µ
 51:  */
 52: export enum TaskPriority {
 53:   /** ä½ */
 54:   LOW = 'low',
 55:   /** ä¸­ */
 56:   MEDIUM = 'medium',
 57:   /** é«˜ */
 58:   HIGH = 'high',
 59:   /** ç´§æ€¥ */
 60:   URGENT = 'urgent'
 61: }
 62: 
 63: /**
 64:  * ä»»åŠ¡æŒ‡æ´¾ç±»å‹æšä¸¾
 65:  * å¯¹åº”æ•°æ®åº“ task_assignments.assignee_type å­—æ®µ
 66:  */
 67: export enum TaskAssigneeType {
 68:   /** ä¸ªäºº */
 69:   INDIVIDUAL = 'individual',
 70:   /** å›¢é˜Ÿ */
 71:   TEAM = 'team',
 72:   /** ç»„ç»‡ */
 73:   ORGANIZATION = 'organization',
 74:   /** æ‰¿æ½å•† */
 75:   CONTRACTOR = 'contractor'
 76: }
 77: 
 78: /**
 79:  * ä»»åŠ¡åˆ—è¡¨ç±»å‹æšä¸¾
 80:  * å¯¹åº”æ•°æ®åº“ task_lists.list_type å­—æ®µ
 81:  */
 82: export enum TaskListType {
 83:   /** å·²æŒ‡æ´¾ */
 84:   ASSIGNED = 'assigned',
 85:   /** å…³æ³¨ä¸­ */
 86:   WATCHING = 'watching',
 87:   /** å·²å½’æ¡£ */
 88:   ARCHIVED = 'archived'
 89: }
 90: 
 91: /**
 92:  * ä»»åŠ¡ä¾èµ–ç±»å‹æšä¸¾
 93:  * å¯¹åº”æ•°æ®åº“ task_dependencies.dependency_type å­—æ®µ
 94:  */
 95: export enum TaskDependencyType {
 96:   /** å®Œæˆåˆ°å¼€å§‹ */
 97:   FINISH_TO_START = 'finish_to_start',
 98:   /** å¼€å§‹åˆ°å¼€å§‹ */
 99:   START_TO_START = 'start_to_start',
100:   /** å®Œæˆåˆ°å®Œæˆ */
101:   FINISH_TO_FINISH = 'finish_to_finish',
102:   /** å¼€å§‹åˆ°å®Œæˆ */
103:   START_TO_FINISH = 'start_to_finish'
104: }
````

## File: src/app/core/infra/utils/index.ts
````typescript
 1: /**
 2:  * å·¥å…·å‡½æ•°æ¨¡å—å¯¼å‡º
 3:  */
 4: export * from './transformers';
 5: 
 6: /**
 7:  * UUID éªŒè¯å·¥å…·
 8:  */
 9: 
10: /**
11:  * UUID v4 æ ¼å¼æ­£åˆ™è¡¨è¾¾å¼
12:  * æ ¼å¼ï¼šxxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx
13:  * å…¶ä¸­ y æ˜¯ 8ã€9ã€a æˆ– b ä¹‹ä¸€
14:  */
15: const UUID_V4_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
16: 
17: /**
18:  * éªŒè¯å­—ç¬¦ä¸²æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ UUID v4 æ ¼å¼
19:  *
20:  * @param value è¦éªŒè¯çš„å­—ç¬¦ä¸²
21:  * @returns å¦‚æœæ˜¯æœ‰æ•ˆçš„ UUIDï¼Œè¿”å› trueï¼›å¦åˆ™è¿”å› false
22:  *
23:  * @example
24:  * ```typescript
25:  * isValidUUID('550e8400-e29b-41d4-a716-446655440000'); // true
26:  * isValidUUID('users'); // false
27:  * isValidUUID('invalid-uuid'); // false
28:  * ```
29:  */
30: export function isValidUUID(value: string | null | undefined): boolean {
31:   if (!value || typeof value !== 'string') {
32:     return false;
33:   }
34:   return UUID_V4_REGEX.test(value);
35: }
````

## File: src/app/core/infra/utils/transformers.ts
````typescript
  1: /**
  2:  * æ•°æ®è½¬æ¢å·¥å…·
  3:  *
  4:  * æä¾› snake_case â†” camelCase è½¬æ¢åŠŸèƒ½
  5:  * ç”¨äºæ•°æ®åº“å­—æ®µåï¼ˆsnake_caseï¼‰ä¸ TypeScript å±æ€§åï¼ˆcamelCaseï¼‰ä¹‹é—´çš„æ˜ å°„
  6:  */
  7: 
  8: /**
  9:  * å°† snake_case è½¬æ¢ä¸º camelCase
 10:  */
 11: function toCamelCase(str: string): string {
 12:   return str.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());
 13: }
 14: 
 15: /**
 16:  * å°† camelCase è½¬æ¢ä¸º snake_case
 17:  */
 18: function toSnakeCase(str: string): string {
 19:   return str.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);
 20: }
 21: 
 22: /**
 23:  * é€’å½’è½¬æ¢å¯¹è±¡çš„é”®åä» snake_case åˆ° camelCase
 24:  */
 25: function convertKeysToCamelCase<T>(obj: any): T {
 26:   if (obj === null || obj === undefined) {
 27:     return obj;
 28:   }
 29: 
 30:   if (Array.isArray(obj)) {
 31:     return obj.map(item => convertKeysToCamelCase(item)) as T;
 32:   }
 33: 
 34:   if (typeof obj === 'object' && obj.constructor === Object) {
 35:     const converted: any = {};
 36:     for (const key in obj) {
 37:       if (Object.prototype.hasOwnProperty.call(obj, key)) {
 38:         const camelKey = toCamelCase(key);
 39:         converted[camelKey] = convertKeysToCamelCase(obj[key]);
 40:       }
 41:     }
 42:     return converted as T;
 43:   }
 44: 
 45:   return obj;
 46: }
 47: 
 48: /**
 49:  * é€’å½’è½¬æ¢å¯¹è±¡çš„é”®åä» camelCase åˆ° snake_case
 50:  *
 51:  * æ³¨æ„: undefined å€¼ä¼šè¢«è¿‡æ»¤æ‰,ä¸ä¼šè¢«åŒ…å«åœ¨è½¬æ¢åçš„å¯¹è±¡ä¸­
 52:  * è¿™æ · Supabase å°±ä¸ä¼šå‘é€ undefined å­—æ®µ,é¿å… RLS ç­–ç•¥è¯„ä¼°é—®é¢˜
 53:  */
 54: function convertKeysToSnakeCase<T extends Record<string, any>>(obj: T): Record<string, any> {
 55:   if (obj === null || obj === undefined) {
 56:     return obj;
 57:   }
 58: 
 59:   if (Array.isArray(obj)) {
 60:     return obj.map(item => convertKeysToSnakeCase(item));
 61:   }
 62: 
 63:   if (typeof obj === 'object' && obj.constructor === Object) {
 64:     const converted: Record<string, any> = {};
 65:     for (const key in obj) {
 66:       if (Object.prototype.hasOwnProperty.call(obj, key)) {
 67:         const value = obj[key];
 68:         // è¿‡æ»¤æ‰ undefined å€¼,é¿å… Supabase æ¥æ”¶åˆ° undefined å­—æ®µ
 69:         // undefined å€¼ä¼šè¢« JSON.stringify å¿½ç•¥,ä½†ä¸ºäº†æ˜ç¡®æ€§,æˆ‘ä»¬åœ¨è¿™é‡Œä¹Ÿè¿‡æ»¤
 70:         if (value !== undefined) {
 71:           const snakeKey = toSnakeCase(key);
 72:           const convertedValue = convertKeysToSnakeCase(value);
 73:           // å¦‚æœè½¬æ¢åçš„å€¼ä¸æ˜¯ undefined,æ‰æ·»åŠ åˆ°ç»“æœå¯¹è±¡ä¸­
 74:           if (convertedValue !== undefined) {
 75:             converted[snakeKey] = convertedValue;
 76:           }
 77:         }
 78:       }
 79:     }
 80:     return converted;
 81:   }
 82: 
 83:   return obj;
 84: }
 85: 
 86: /**
 87:  * å°†æ•°æ®åº“æ•°æ®ï¼ˆsnake_caseï¼‰è½¬æ¢ä¸ºåº”ç”¨æ•°æ®ï¼ˆcamelCaseï¼‰
 88:  *
 89:  * @param data æ•°æ®åº“æ•°æ®
 90:  * @returns è½¬æ¢åçš„æ•°æ®
 91:  *
 92:  * @example
 93:  * ```typescript
 94:  * const dbData = { user_id: '123', created_at: '2025-01-01' };
 95:  * const appData = toCamelCase(dbData);
 96:  * // { userId: '123', createdAt: '2025-01-01' }
 97:  * ```
 98:  */
 99: export function toCamelCaseData<T>(data: any): T {
100:   return convertKeysToCamelCase<T>(data);
101: }
102: 
103: /**
104:  * å°†åº”ç”¨æ•°æ®ï¼ˆcamelCaseï¼‰è½¬æ¢ä¸ºæ•°æ®åº“æ•°æ®ï¼ˆsnake_caseï¼‰
105:  *
106:  * @param data åº”ç”¨æ•°æ®
107:  * @returns è½¬æ¢åçš„æ•°æ®
108:  *
109:  * @example
110:  * ```typescript
111:  * const appData = { userId: '123', createdAt: '2025-01-01' };
112:  * const dbData = toSnakeCaseData(appData);
113:  * // { user_id: '123', created_at: '2025-01-01' }
114:  * ```
115:  */
116: export function toSnakeCaseData<T extends Record<string, any>>(data: T): Record<string, any> {
117:   return convertKeysToSnakeCase(data);
118: }
````

## File: src/app/core/menu-context/index.ts
````typescript
1: export * from './menu-context.service';
````

## File: src/app/core/menu-context/menu-context.service.ts
````typescript
  1: import { Injectable, effect, inject, signal } from '@angular/core';
  2: import { MenuService } from '@delon/theme';
  3: import { AccountService, AccountType } from '@shared';
  4: import { NzSafeAny } from 'ng-zorro-antd/core/types';
  5: 
  6: /**
  7:  * èœå•ä¸Šä¸‹æ–‡æœåŠ¡
  8:  *
  9:  * ç®¡ç†ä¸åŒè´¦æˆ·ç±»å‹ï¼ˆä¸ªäºº/ç»„ç»‡/å›¢é˜Ÿï¼‰çš„èœå•åˆ‡æ¢
 10:  * ç›‘å¬è´¦æˆ·åˆ‡æ¢äº‹ä»¶ï¼Œè‡ªåŠ¨æ›´æ–°èœå•
 11:  *
 12:  * @example
 13:  * ```typescript
 14:  * const menuContextService = inject(MenuContextService);
 15:  *
 16:  * // åˆ‡æ¢èœå•ä¸Šä¸‹æ–‡
 17:  * await menuContextService.switchToUser();
 18:  * await menuContextService.switchToOrganization(orgId);
 19:  * await menuContextService.switchToTeam(teamId);
 20:  * ```
 21:  */
 22: @Injectable({
 23:   providedIn: 'root'
 24: })
 25: export class MenuContextService {
 26:   private readonly menuService = inject(MenuService);
 27:   private readonly accountService = inject(AccountService);
 28: 
 29:   // èœå•æ•°æ®ç¼“å­˜
 30:   private userMenuData: NzSafeAny[] = [];
 31:   private organizationMenuData: NzSafeAny[] = [];
 32:   private teamMenuData: NzSafeAny[] = [];
 33:   private appMenuData: NzSafeAny[] = [];
 34: 
 35:   // å½“å‰èœå•ä¸Šä¸‹æ–‡ç±»å‹
 36:   private currentContextType = signal<'user' | 'organization' | 'team' | 'app'>('app');
 37:   private currentContextId = signal<string | null>(null);
 38: 
 39:   // æš´éœ²åªè¯»ä¿¡å·
 40:   readonly contextType = this.currentContextType.asReadonly();
 41:   readonly contextId = this.currentContextId.asReadonly();
 42: 
 43:   constructor() {
 44:     // ç›‘å¬è´¦æˆ·åˆ‡æ¢ï¼Œè‡ªåŠ¨æ›´æ–°èœå•
 45:     effect(() => {
 46:       const selectedAccount = this.accountService.selectedAccount();
 47:       if (selectedAccount) {
 48:         this.updateMenuByAccount(selectedAccount);
 49:       }
 50:     });
 51:   }
 52: 
 53:   /**
 54:    * åˆå§‹åŒ–èœå•æ•°æ®
 55:    * åœ¨ StartupService ä¸­è°ƒç”¨ï¼Œä¿å­˜ä¸åŒè´¦æˆ·ç±»å‹çš„èœå•æ•°æ®
 56:    */
 57:   initializeMenuData(data: {
 58:     appMenu?: NzSafeAny[];
 59:     userMenu?: NzSafeAny[];
 60:     organizationMenu?: NzSafeAny[];
 61:     teamMenu?: NzSafeAny[];
 62:   }): void {
 63:     if (data.appMenu) {
 64:       this.appMenuData = data.appMenu;
 65:     }
 66:     if (data.userMenu) {
 67:       this.userMenuData = data.userMenu;
 68:     }
 69:     if (data.organizationMenu) {
 70:       this.organizationMenuData = data.organizationMenu;
 71:     }
 72:     if (data.teamMenu) {
 73:       this.teamMenuData = data.teamMenu;
 74:     }
 75: 
 76:     // é»˜è®¤ä½¿ç”¨åº”ç”¨èœå•
 77:     this.switchToApp();
 78:   }
 79: 
 80:   /**
 81:    * åˆ‡æ¢åˆ°åº”ç”¨èœå•ï¼ˆé»˜è®¤èœå•ï¼‰
 82:    */
 83:   switchToApp(): void {
 84:     this.currentContextType.set('app');
 85:     this.currentContextId.set(null);
 86:     this.menuService.clear();
 87:     this.menuService.add(this.appMenuData);
 88:     this.menuService.resume();
 89:   }
 90: 
 91:   /**
 92:    * åˆ‡æ¢åˆ°ä¸ªäººç”¨æˆ·èœå•
 93:    */
 94:   switchToUser(userId?: string): void {
 95:     this.currentContextType.set('user');
 96:     this.currentContextId.set(userId || null);
 97:     this.menuService.clear();
 98:     this.menuService.add(this.userMenuData);
 99:     this.menuService.resume();
100:   }
101: 
102:   /**
103:    * åˆ‡æ¢åˆ°ç»„ç»‡èœå•
104:    */
105:   switchToOrganization(organizationId: string): void {
106:     this.currentContextType.set('organization');
107:     this.currentContextId.set(organizationId);
108:     this.menuService.clear();
109:     this.menuService.add(this.organizationMenuData);
110:     this.menuService.resume();
111:   }
112: 
113:   /**
114:    * åˆ‡æ¢åˆ°å›¢é˜Ÿèœå•
115:    */
116:   switchToTeam(teamId: string): void {
117:     this.currentContextType.set('team');
118:     this.currentContextId.set(teamId);
119:     this.menuService.clear();
120:     this.menuService.add(this.teamMenuData);
121:     this.menuService.resume();
122:   }
123: 
124:   /**
125:    * æ ¹æ®è´¦æˆ·ç±»å‹è‡ªåŠ¨æ›´æ–°èœå•
126:    */
127:   private updateMenuByAccount(account: { type: AccountType | string; id: string }): void {
128:     const accountType = account.type as AccountType;
129:     switch (accountType) {
130:       case AccountType.USER:
131:         this.switchToUser(account.id);
132:         break;
133:       case AccountType.ORGANIZATION:
134:         this.switchToOrganization(account.id);
135:         break;
136:       default:
137:         // Bot æˆ–å…¶ä»–ç±»å‹ï¼Œä½¿ç”¨åº”ç”¨èœå•
138:         this.switchToApp();
139:         break;
140:     }
141:   }
142: 
143:   /**
144:    * è·å–å½“å‰èœå•æ•°æ®
145:    */
146:   getCurrentMenuData(): NzSafeAny[] {
147:     switch (this.currentContextType()) {
148:       case 'user':
149:         return this.userMenuData;
150:       case 'organization':
151:         return this.organizationMenuData;
152:       case 'team':
153:         return this.teamMenuData;
154:       default:
155:         return this.appMenuData;
156:     }
157:   }
158: 
159:   /**
160:    * åˆå¹¶èœå•æ•°æ®ï¼ˆç”¨äºç»„åˆå¤šä¸ªèœå•ï¼‰
161:    */
162:   mergeMenuData(...menuArrays: NzSafeAny[][]): NzSafeAny[] {
163:     const merged: NzSafeAny[] = [];
164:     const seen = new Set<string>();
165: 
166:     for (const menuArray of menuArrays) {
167:       for (const item of menuArray) {
168:         // æ ¹æ® link æˆ– text å»é‡
169:         const key = item.link || item.text || item.i18n;
170:         if (key && !seen.has(key)) {
171:           seen.add(key);
172:           merged.push(item);
173:         } else if (!key) {
174:           // æ²¡æœ‰å”¯ä¸€æ ‡è¯†çš„é¡¹ç›´æ¥æ·»åŠ 
175:           merged.push(item);
176:         }
177:       }
178:     }
179: 
180:     return merged;
181:   }
182: }
````

## File: src/app/core/net/default.interceptor.ts
````typescript
 1: import { HttpErrorResponse, HttpHandlerFn, HttpInterceptorFn, HttpRequest, HttpResponseBase } from '@angular/common/http';
 2: import { Injector, inject } from '@angular/core';
 3: import { IGNORE_BASE_URL } from '@delon/theme';
 4: import { environment } from '@env/environment';
 5: import { Observable, of, throwError, mergeMap } from 'rxjs';
 6: 
 7: import { ReThrowHttpError, checkStatus, getAdditionalHeaders, toLogin } from './helper';
 8: import { tryRefreshToken } from './refresh-token';
 9: 
10: function handleData(injector: Injector, ev: HttpResponseBase, req: HttpRequest<any>, next: HttpHandlerFn): Observable<any> {
11:   checkStatus(injector, ev);
12:   // ä¸šåŠ¡å¤„ç†ï¼šä¸€äº›é€šç”¨æ“ä½œ
13:   switch (ev.status) {
14:     case 200:
15:       // ä¸šåŠ¡å±‚çº§é”™è¯¯å¤„ç†ï¼Œä»¥ä¸‹æ˜¯å‡å®šrestfulæœ‰ä¸€å¥—ç»Ÿä¸€è¾“å‡ºæ ¼å¼ï¼ˆæŒ‡ä¸ç®¡æˆåŠŸä¸å¦éƒ½æœ‰ç›¸åº”çš„æ•°æ®æ ¼å¼ï¼‰æƒ…å†µä¸‹è¿›è¡Œå¤„ç†
16:       // ä¾‹å¦‚å“åº”å†…å®¹ï¼š
17:       //  é”™è¯¯å†…å®¹ï¼š{ status: 1, msg: 'éæ³•å‚æ•°' }
18:       //  æ­£ç¡®å†…å®¹ï¼š{ status: 0, response: {  } }
19:       // åˆ™ä»¥ä¸‹ä»£ç ç‰‡æ–­å¯ç›´æ¥é€‚ç”¨
20:       // if (ev instanceof HttpResponse) {
21:       //   const body = ev.body;
22:       //   if (body && body.status !== 0) {
23:       //     const customError = req.context.get(CUSTOM_ERROR);
24:       //     if (customError) injector.get(NzMessageService).error(body.msg);
25:       //     return customError ? throwError(() => ({ body, _throw: true }) as ReThrowHttpError) : of({});
26:       //   } else {
27:       //     // è¿”å›åŸå§‹è¿”å›ä½“
28:       //     if (req.context.get(RAW_BODY) || ev.body instanceof Blob) {
29:       //       return of(ev);
30:       //     }
31:       //     // é‡æ–°ä¿®æ”¹ `body` å†…å®¹ä¸º `response` å†…å®¹ï¼Œå¯¹äºç»å¤§å¤šæ•°åœºæ™¯å·²ç»æ— é¡»å†å…³å¿ƒä¸šåŠ¡çŠ¶æ€ç 
32:       //     return of(new HttpResponse({ ...ev, body: body.response } as any));
33:       //     // æˆ–è€…ä¾ç„¶ä¿æŒå®Œæ•´çš„æ ¼å¼
34:       //     return of(ev);
35:       //   }
36:       // }
37:       break;
38:     case 401:
39:       if (environment.api.refreshTokenEnabled && environment.api.refreshTokenType === 're-request') {
40:         return tryRefreshToken(injector, ev, req, next);
41:       }
42:       toLogin(injector);
43:       break;
44:     case 403:
45:     case 404:
46:     case 500:
47:       // goTo(injector, `/exception/${ev.status}?url=${req.urlWithParams}`);
48:       break;
49:     default:
50:       if (ev instanceof HttpErrorResponse) {
51:         console.warn('æœªå¯çŸ¥é”™è¯¯ï¼Œå¤§éƒ¨åˆ†æ˜¯ç”±äºåç«¯ä¸æ”¯æŒè·¨åŸŸCORSæˆ–æ— æ•ˆé…ç½®å¼•èµ·ï¼Œè¯·å‚è€ƒ https://ng-alain.com/docs/server è§£å†³è·¨åŸŸé—®é¢˜', ev);
52:       }
53:       break;
54:   }
55:   if (ev instanceof HttpErrorResponse) {
56:     return throwError(() => ev);
57:   } else if ((ev as unknown as ReThrowHttpError)._throw === true) {
58:     return throwError(() => (ev as unknown as ReThrowHttpError).body);
59:   } else {
60:     return of(ev);
61:   }
62: }
63: 
64: export const defaultInterceptor: HttpInterceptorFn = (req, next) => {
65:   // ç»Ÿä¸€åŠ ä¸ŠæœåŠ¡ç«¯å‰ç¼€
66:   let url = req.url;
67:   if (!req.context.get(IGNORE_BASE_URL) && !url.startsWith('https://') && !url.startsWith('http://')) {
68:     const { baseUrl } = environment.api;
69:     url = baseUrl + (baseUrl.endsWith('/') && url.startsWith('/') ? url.substring(1) : url);
70:   }
71:   const newReq = req.clone({ url, setHeaders: getAdditionalHeaders(req.headers) });
72:   const injector = inject(Injector);
73: 
74:   return next(newReq).pipe(
75:     mergeMap(ev => {
76:       // å…è®¸ç»Ÿä¸€å¯¹è¯·æ±‚é”™è¯¯å¤„ç†
77:       if (ev instanceof HttpResponseBase) {
78:         return handleData(injector, ev, newReq, next);
79:       }
80:       // è‹¥ä¸€åˆ‡éƒ½æ­£å¸¸ï¼Œåˆ™åç»­æ“ä½œ
81:       return of(ev);
82:     })
83:     // catchError((err: HttpErrorResponse) => handleData(injector, err, newReq, next))
84:   );
85: };
````

## File: src/app/core/net/helper.ts
````typescript
 1: import { HttpHeaders, HttpResponseBase } from '@angular/common/http';
 2: import { Injector, inject } from '@angular/core';
 3: import { Router } from '@angular/router';
 4: import { DA_SERVICE_TOKEN } from '@delon/auth';
 5: import { ALAIN_I18N_TOKEN } from '@delon/theme';
 6: import { NzNotificationService } from 'ng-zorro-antd/notification';
 7: 
 8: export interface ReThrowHttpError {
 9:   body: any;
10:   _throw: true;
11: }
12: 
13: export const CODEMESSAGE: Record<number, string> = {
14:   200: 'æœåŠ¡å™¨æˆåŠŸè¿”å›è¯·æ±‚çš„æ•°æ®ã€‚',
15:   201: 'æ–°å»ºæˆ–ä¿®æ”¹æ•°æ®æˆåŠŸã€‚',
16:   202: 'ä¸€ä¸ªè¯·æ±‚å·²ç»è¿›å…¥åå°æ’é˜Ÿï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰ã€‚',
17:   204: 'åˆ é™¤æ•°æ®æˆåŠŸã€‚',
18:   400: 'å‘å‡ºçš„è¯·æ±‚æœ‰é”™è¯¯ï¼ŒæœåŠ¡å™¨æ²¡æœ‰è¿›è¡Œæ–°å»ºæˆ–ä¿®æ”¹æ•°æ®çš„æ“ä½œã€‚',
19:   401: 'ç”¨æˆ·æ²¡æœ‰æƒé™ï¼ˆä»¤ç‰Œã€ç”¨æˆ·åã€å¯†ç é”™è¯¯ï¼‰ã€‚',
20:   403: 'ç”¨æˆ·å¾—åˆ°æˆæƒï¼Œä½†æ˜¯è®¿é—®æ˜¯è¢«ç¦æ­¢çš„ã€‚',
21:   404: 'å‘å‡ºçš„è¯·æ±‚é’ˆå¯¹çš„æ˜¯ä¸å­˜åœ¨çš„è®°å½•ï¼ŒæœåŠ¡å™¨æ²¡æœ‰è¿›è¡Œæ“ä½œã€‚',
22:   406: 'è¯·æ±‚çš„æ ¼å¼ä¸å¯å¾—ã€‚',
23:   410: 'è¯·æ±‚çš„èµ„æºè¢«æ°¸ä¹…åˆ é™¤ï¼Œä¸”ä¸ä¼šå†å¾—åˆ°çš„ã€‚',
24:   422: 'å½“åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå‘ç”Ÿä¸€ä¸ªéªŒè¯é”™è¯¯ã€‚',
25:   500: 'æœåŠ¡å™¨å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨ã€‚',
26:   502: 'ç½‘å…³é”™è¯¯ã€‚',
27:   503: 'æœåŠ¡ä¸å¯ç”¨ï¼ŒæœåŠ¡å™¨æš‚æ—¶è¿‡è½½æˆ–ç»´æŠ¤ã€‚',
28:   504: 'ç½‘å…³è¶…æ—¶ã€‚'
29: };
30: 
31: export function goTo(injector: Injector, url: string): void {
32:   setTimeout(() => injector.get(Router).navigateByUrl(url));
33: }
34: 
35: export function toLogin(injector: Injector): void {
36:   injector.get(NzNotificationService).error(`æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ã€‚`, ``);
37:   goTo(injector, injector.get(DA_SERVICE_TOKEN).login_url!);
38: }
39: 
40: export function getAdditionalHeaders(headers?: HttpHeaders): Record<string, string> {
41:   const res: Record<string, string> = {};
42:   const lang = inject(ALAIN_I18N_TOKEN).currentLang;
43:   if (!headers?.has('Accept-Language') && lang) {
44:     res['Accept-Language'] = lang;
45:   }
46: 
47:   return res;
48: }
49: 
50: export function checkStatus(injector: Injector, ev: HttpResponseBase): void {
51:   if ((ev.status >= 200 && ev.status < 300) || ev.status === 401) {
52:     return;
53:   }
54: 
55:   const errortext = CODEMESSAGE[ev.status] || ev.statusText;
56:   injector.get(NzNotificationService).error(`è¯·æ±‚é”™è¯¯ ${ev.status}: ${ev.url}`, errortext);
57: }
````

## File: src/app/core/net/index.ts
````typescript
1: export { provideBindAuthRefresh } from './refresh-token';
2: export * from './default.interceptor';
````

## File: src/app/core/net/refresh-token.ts
````typescript
  1: import { HttpHandlerFn, HttpRequest, HttpResponseBase } from '@angular/common/http';
  2: import { EnvironmentProviders, Injector, inject, provideAppInitializer } from '@angular/core';
  3: import { DA_SERVICE_TOKEN } from '@delon/auth';
  4: import { BehaviorSubject, Observable, catchError, filter, map, switchMap, take, throwError } from 'rxjs';
  5: 
  6: import { SupabaseSessionAdapterService } from '../supabase';
  7: import { toLogin } from './helper';
  8: 
  9: let refreshToking = false;
 10: let refreshToken$: BehaviorSubject<any> = new BehaviorSubject<any>(null);
 11: 
 12: /**
 13:  * é‡æ–°é™„åŠ æ–° Token ä¿¡æ¯
 14:  *
 15:  * > ç”±äºå·²ç»å‘èµ·çš„è¯·æ±‚ï¼Œä¸ä¼šå†èµ°ä¸€é `@delon/auth` å› æ­¤éœ€è¦ç»“åˆä¸šåŠ¡æƒ…å†µé‡æ–°é™„åŠ æ–°çš„ Token
 16:  */
 17: function reAttachToken(injector: Injector, req: HttpRequest<any>): HttpRequest<any> {
 18:   const token = injector.get(DA_SERVICE_TOKEN).get()?.token;
 19:   return req.clone({
 20:     setHeaders: {
 21:       token: `Bearer ${token}`
 22:     }
 23:   });
 24: }
 25: 
 26: function refreshTokenRequest(injector: Injector): Observable<any> {
 27:   const adapter = injector.get(SupabaseSessionAdapterService);
 28:   return adapter.refreshSession().pipe(map(session => adapter.convertSessionToTokenFormat(session)));
 29: }
 30: 
 31: /**
 32:  * åˆ·æ–°Tokenæ–¹å¼ä¸€ï¼šä½¿ç”¨ 401 é‡æ–°åˆ·æ–° Token
 33:  */
 34: export function tryRefreshToken(injector: Injector, ev: HttpResponseBase, req: HttpRequest<any>, next: HttpHandlerFn): Observable<any> {
 35:   // 1ã€è‹¥è¯·æ±‚ä¸ºåˆ·æ–°Tokenè¯·æ±‚ï¼Œè¡¨ç¤ºæ¥è‡ªåˆ·æ–°Tokenå¯ä»¥ç›´æ¥è·³è½¬ç™»å½•é¡µ
 36:   if ([`/api/auth/refresh`].some(url => req.url.includes(url))) {
 37:     toLogin(injector);
 38:     return throwError(() => ev);
 39:   }
 40:   // 2ã€å¦‚æœ `refreshToking` ä¸º `true` è¡¨ç¤ºå·²ç»åœ¨è¯·æ±‚åˆ·æ–° Token ä¸­ï¼Œåç»­æ‰€æœ‰è¯·æ±‚è½¬å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´è‡³ç»“æœè¿”å›åå†é‡æ–°å‘èµ·è¯·æ±‚
 41:   if (refreshToking) {
 42:     return refreshToken$.pipe(
 43:       filter(v => !!v),
 44:       take(1),
 45:       switchMap(() => next(reAttachToken(injector, req)))
 46:     );
 47:   }
 48:   // 3ã€å°è¯•è°ƒç”¨åˆ·æ–° Token
 49:   refreshToking = true;
 50:   refreshToken$.next(null);
 51: 
 52:   return refreshTokenRequest(injector).pipe(
 53:     switchMap(res => {
 54:       // é€šçŸ¥åç»­è¯·æ±‚ç»§ç»­æ‰§è¡Œ
 55:       refreshToking = false;
 56:       refreshToken$.next(res);
 57:       // é‡æ–°ä¿å­˜æ–° token
 58:       injector.get(DA_SERVICE_TOKEN).set(res);
 59:       // é‡æ–°å‘èµ·è¯·æ±‚
 60:       return next(reAttachToken(injector, req));
 61:     }),
 62:     catchError(err => {
 63:       refreshToking = false;
 64:       toLogin(injector);
 65:       return throwError(() => err);
 66:     })
 67:   );
 68: }
 69: 
 70: function buildAuthRefresh(injector: Injector): void {
 71:   const tokenSrv = injector.get(DA_SERVICE_TOKEN);
 72:   tokenSrv.refresh
 73:     .pipe(
 74:       filter(() => !refreshToking),
 75:       switchMap(res => {
 76:         console.log(res);
 77:         refreshToking = true;
 78:         return refreshTokenRequest(injector);
 79:       })
 80:     )
 81:     .subscribe({
 82:       next: res => {
 83:         // TODO: Mock expired value
 84:         res.expired = +new Date() + 1000 * 60 * 5;
 85:         refreshToking = false;
 86:         tokenSrv.set(res);
 87:       },
 88:       error: () => toLogin(injector)
 89:     });
 90: }
 91: 
 92: /**
 93:  * åˆ·æ–°Tokenæ–¹å¼äºŒï¼šä½¿ç”¨ `@delon/auth` çš„ `refresh` æ¥å£ï¼Œéœ€è¦åœ¨ `app.config.ts` ä¸­æ³¨å†Œ `provideBindAuthRefresh`
 94:  */
 95: export function provideBindAuthRefresh(): EnvironmentProviders[] {
 96:   return [
 97:     provideAppInitializer(() => {
 98:       const initializerFn = (
 99:         (injector: Injector) => () =>
100:           buildAuthRefresh(injector)
101:       )(inject(Injector));
102:       return initializerFn();
103:     })
104:   ];
105: }
````

## File: src/app/core/permissions/index.ts
````typescript
1: export * from './types';
2: export * from './permission.service';
3: export * from './role.service';
````

## File: src/app/core/permissions/permission.service.ts
````typescript
  1: import { Injectable, inject } from '@angular/core';
  2: import { ACLService } from '@delon/acl';
  3: import { DA_SERVICE_TOKEN } from '@delon/auth';
  4: import { Observable, from, of, throwError, forkJoin } from 'rxjs';
  5: import { map, switchMap, catchError, tap, shareReplay } from 'rxjs/operators';
  6: 
  7: import { Permission, PermissionCacheItem } from './types';
  8: import { SupabaseService } from '../supabase/supabase.service';
  9: 
 10: /**
 11:  * æƒé™æ£€æŸ¥æœåŠ¡
 12:  *
 13:  * æ•´åˆ @delon/acl å’Œ Supabase æ•°æ®åº“ï¼Œå®ç° RBAC æƒé™æ§åˆ¶
 14:  *
 15:  * åŠŸèƒ½ï¼š
 16:  * 1. æƒé™æ£€æŸ¥ï¼ˆcan, canAny, canAllï¼‰
 17:  * 2. Git-like åˆ†æ”¯æƒé™æ£€æŸ¥
 18:  * 3. æƒé™ç¼“å­˜ï¼ˆå†…å­˜ç¼“å­˜ï¼‰
 19:  * 4. æƒé™åŒæ­¥åˆ° @delon/acl
 20:  * 5. æƒé™æ£€æŸ¥æ—¥å¿—è®°å½•ï¼ˆåç»­å®ç°ï¼‰
 21:  *
 22:  * @example
 23:  * ```typescript
 24:  * const permissionService = inject(PermissionService);
 25:  * permissionService.can('blueprint.read').subscribe(hasPermission => {
 26:  *   if (!hasPermission) {
 27:  *     throw new Error('Permission denied');
 28:  *   }
 29:  * });
 30:  * ```
 31:  */
 32: @Injectable({
 33:   providedIn: 'root'
 34: })
 35: export class PermissionService {
 36:   private readonly aclService = inject(ACLService);
 37:   private readonly supabaseService = inject(SupabaseService);
 38:   private readonly tokenService = inject(DA_SERVICE_TOKEN);
 39: 
 40:   /**
 41:    * æƒé™ç¼“å­˜ï¼ˆå†…å­˜ç¼“å­˜ï¼‰
 42:    * key: permission string, value: PermissionCacheItem
 43:    */
 44:   private readonly permissionCache = new Map<string, PermissionCacheItem>();
 45: 
 46:   /**
 47:    * ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤ 5 åˆ†é’Ÿ
 48:    */
 49:   private readonly CACHE_TTL = 5 * 60 * 1000;
 50: 
 51:   /**
 52:    * å½“å‰ç”¨æˆ·æƒé™ç¼“å­˜ï¼ˆObservableï¼‰
 53:    */
 54:   private userPermissions$?: Observable<Permission[]>;
 55: 
 56:   /**
 57:    * è·å–å½“å‰ç”¨æˆ· ID
 58:    */
 59:   private getCurrentUserId(): string | null {
 60:     const token = this.tokenService.get();
 61:     return token?.['user']?.id || null;
 62:   }
 63: 
 64:   /**
 65:    * æ£€æŸ¥å•ä¸ªæƒé™
 66:    *
 67:    * @param permission æƒé™åç§°ï¼ˆå¦‚ 'blueprint.read'ï¼‰
 68:    * @returns Observable<boolean> æ˜¯å¦æœ‰æƒé™
 69:    * @throws Error å¦‚æœæƒé™æ£€æŸ¥å¤±è´¥ï¼ˆæ ¹æ®é…ç½®ï¼‰
 70:    */
 71:   can(permission: string): Observable<boolean> {
 72:     // 1. æ£€æŸ¥æœ¬åœ° ACLService ç¼“å­˜
 73:     if (this.aclService.can(permission)) {
 74:       return of(true);
 75:     }
 76: 
 77:     // 2. æ£€æŸ¥å†…å­˜ç¼“å­˜
 78:     const cached = this.permissionCache.get(permission);
 79:     if (cached && cached.expiresAt > Date.now()) {
 80:       return of(cached.hasPermission);
 81:     }
 82: 
 83:     // 3. æŸ¥è¯¢æ•°æ®åº“
 84:     return this.checkDatabasePermission(permission).pipe(
 85:       tap(hasPermission => {
 86:         // æ›´æ–°å†…å­˜ç¼“å­˜
 87:         this.permissionCache.set(permission, {
 88:           permission,
 89:           hasPermission,
 90:           expiresAt: Date.now() + this.CACHE_TTL
 91:         });
 92:       }),
 93:       catchError(error => {
 94:         // æƒé™æ£€æŸ¥å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸
 95:         return throwError(() => new Error(`Permission check failed: ${permission} - ${error.message}`));
 96:       })
 97:     );
 98:   }
 99: 
100:   /**
101:    * æ£€æŸ¥ä»»ä¸€æƒé™ï¼ˆOR é€»è¾‘ï¼‰
102:    *
103:    * @param permissions æƒé™æ•°ç»„
104:    * @returns Observable<boolean> æ˜¯å¦æœ‰ä»»ä¸€æƒé™
105:    */
106:   canAny(permissions: string[]): Observable<boolean> {
107:     if (permissions.length === 0) {
108:       return of(false);
109:     }
110: 
111:     // å¹¶è¡Œæ£€æŸ¥æ‰€æœ‰æƒé™ï¼Œä»»ä¸€ä¸º true å³è¿”å› true
112:     const checks = permissions.map(p => this.can(p).pipe(catchError(() => of(false))));
113: 
114:     return forkJoin(checks).pipe(map(results => results.some(r => r === true)));
115:   }
116: 
117:   /**
118:    * æ£€æŸ¥æ‰€æœ‰æƒé™ï¼ˆAND é€»è¾‘ï¼‰
119:    *
120:    * @param permissions æƒé™æ•°ç»„
121:    * @returns Observable<boolean> æ˜¯å¦æœ‰æ‰€æœ‰æƒé™
122:    */
123:   canAll(permissions: string[]): Observable<boolean> {
124:     if (permissions.length === 0) {
125:       return of(true);
126:     }
127: 
128:     // å¹¶è¡Œæ£€æŸ¥æ‰€æœ‰æƒé™ï¼Œå…¨éƒ¨ä¸º true æ‰è¿”å› true
129:     const checks = permissions.map(p => this.can(p).pipe(catchError(() => of(false))));
130: 
131:     return forkJoin(checks).pipe(map(results => results.every(r => r === true)));
132:   }
133: 
134:   /**
135:    * ä»æ•°æ®åº“æŸ¥è¯¢æƒé™
136:    *
137:    * @param permission æƒé™åç§°
138:    * @returns Observable<boolean>
139:    */
140:   private checkDatabasePermission(permission: string): Observable<boolean> {
141:     const userId = this.getCurrentUserId();
142:     if (!userId) {
143:       return of(false);
144:     }
145: 
146:     // æŸ¥è¯¢ç”¨æˆ·è§’è‰² -> è§’è‰²æƒé™ -> æƒé™è¯¦æƒ…
147:     return from(
148:       this.supabaseService.client
149:         .from('user_roles')
150:         .select(
151:           `
152:           roles!inner(
153:             role_permissions!inner(
154:               permissions!inner(
155:                 name,
156:                 resource,
157:                 action
158:               )
159:             )
160:           )
161:         `
162:         )
163:         .eq('account_id', userId)
164:     ).pipe(
165:       map(({ data, error }) => {
166:         if (error) {
167:           throw new Error(`Database query failed: ${error.message}`);
168:         }
169: 
170:         if (!data || data.length === 0) {
171:           return false;
172:         }
173: 
174:         // æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…çš„æƒé™
175:         for (const userRole of data) {
176:           const role = userRole.roles as any;
177:           if (role?.role_permissions) {
178:             for (const rolePerm of role.role_permissions) {
179:               const perm = rolePerm.permissions as Permission;
180:               if (perm.name === permission || `${perm.resource}.${perm.action}` === permission) {
181:                 return true;
182:               }
183:             }
184:           }
185:         }
186: 
187:         return false;
188:       }),
189:       tap(hasPermission => {
190:         // å¦‚æœæƒé™å­˜åœ¨ï¼ŒåŒæ­¥åˆ° ACLService
191:         if (hasPermission) {
192:           this.syncPermissionToACL(permission);
193:         }
194:       })
195:     );
196:   }
197: 
198:   /**
199:    * åŒæ­¥æƒé™åˆ° @delon/acl ACLService
200:    *
201:    * @param permission æƒé™åç§°
202:    */
203:   private syncPermissionToACL(permission: string): void {
204:     // è§£ææƒé™æ ¼å¼ï¼šresource.action
205:     const parts = permission.split('.');
206:     if (parts.length === 2) {
207:       const currentData = this.aclService.data;
208:       const abilities = currentData.abilities || [];
209:       if (!abilities.includes(permission)) {
210:         // ä½¿ç”¨ ACLService.set() è®¾ç½®æƒé™
211:         this.aclService.set({
212:           ...currentData,
213:           abilities: [...abilities, permission]
214:         });
215:       }
216:     }
217:   }
218: 
219:   /**
220:    * æ£€æŸ¥è“å›¾è®¿é—®æƒé™
221:    *
222:    * @param blueprintId è“å›¾ ID
223:    * @param action æ“ä½œç±»å‹
224:    * @returns Observable<boolean>
225:    */
226:   canAccessBlueprint(blueprintId: string, action: 'read' | 'write' | 'admin'): Observable<boolean> {
227:     const userId = this.getCurrentUserId();
228:     if (!userId) {
229:       return of(false);
230:     }
231: 
232:     // æŸ¥è¯¢è“å›¾æ‹¥æœ‰è€…æˆ–ç”¨æˆ·è§’è‰²
233:     return from(this.supabaseService.client.from('blueprints').select('owner_id').eq('id', blueprintId).single()).pipe(
234:       switchMap(({ data: blueprint, error: blueprintError }) => {
235:         if (blueprintError || !blueprint) {
236:           return of(false);
237:         }
238: 
239:         // å¦‚æœæ˜¯æ‹¥æœ‰è€…ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™
240:         if (blueprint.owner_id === userId) {
241:           return of(true);
242:         }
243: 
244:         // æ£€æŸ¥ç”¨æˆ·è§’è‰²æƒé™
245:         return from(
246:           this.supabaseService.client.from('user_roles').select('roles(code)').eq('account_id', userId).eq('blueprint_id', blueprintId)
247:         ).pipe(
248:           map(({ data: userRoles }) => {
249:             if (!userRoles || userRoles.length === 0) {
250:               return false;
251:             }
252: 
253:             // æ ¹æ®è§’è‰²ä»£ç åˆ¤æ–­æƒé™
254:             const roleCodes = userRoles.map(ur => (ur.roles as any).code);
255: 
256:             switch (action) {
257:               case 'read':
258:                 return roleCodes.some(code => ['blueprint_owner', 'blueprint_admin', 'project_manager', 'viewer'].includes(code));
259:               case 'write':
260:                 return roleCodes.some(code => ['blueprint_owner', 'blueprint_admin', 'project_manager'].includes(code));
261:               case 'admin':
262:                 return roleCodes.some(code => ['blueprint_owner', 'blueprint_admin'].includes(code));
263:               default:
264:                 return false;
265:             }
266:           })
267:         );
268:       })
269:     );
270:   }
271: 
272:   /**
273:    * æ£€æŸ¥åˆ†æ”¯è®¿é—®æƒé™
274:    *
275:    * @param branchId åˆ†æ”¯ ID
276:    * @param action æ“ä½œç±»å‹
277:    * @returns Observable<boolean>
278:    */
279:   canAccessBranch(branchId: string, action: 'read' | 'write' | 'admin'): Observable<boolean> {
280:     const userId = this.getCurrentUserId();
281:     if (!userId) {
282:       return of(false);
283:     }
284: 
285:     // æŸ¥è¯¢åˆ†æ”¯æƒé™
286:     return from(
287:       this.supabaseService.client
288:         .from('branch_permissions')
289:         .select('permission_level, blueprint_branches(blueprint_id, blueprints(owner_id))')
290:         .eq('branch_id', branchId)
291:         .eq('account_id', userId)
292:         .single()
293:     ).pipe(
294:       switchMap(({ data: branchPerm, error }) => {
295:         // å¦‚æœæ²¡æœ‰åˆ†æ”¯æƒé™ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯è“å›¾æ‹¥æœ‰è€…
296:         if (error || !branchPerm) {
297:           return from(
298:             this.supabaseService.client.from('blueprint_branches').select('blueprint_id, blueprints(owner_id)').eq('id', branchId).single()
299:           ).pipe(
300:             map(({ data: branch }) => {
301:               const blueprint = (branch as any)?.blueprints;
302:               return blueprint?.owner_id === userId;
303:             })
304:           );
305:         }
306: 
307:         const level = branchPerm.permission_level as 'owner' | 'admin' | 'write' | 'read';
308: 
309:         switch (action) {
310:           case 'read':
311:             return of(true); // æ‰€æœ‰çº§åˆ«éƒ½å¯ä»¥è¯»å–
312:           case 'write':
313:             return of(['owner', 'admin', 'write'].includes(level));
314:           case 'admin':
315:             return of(['owner', 'admin'].includes(level));
316:           default:
317:             return of(false);
318:         }
319:       })
320:     );
321:   }
322: 
323:   /**
324:    * æ£€æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹ä»»åŠ¡ç»“æ„ï¼ˆåªæœ‰æ‹¥æœ‰è€…å¯ä»¥ï¼‰
325:    *
326:    * @param blueprintId è“å›¾ ID
327:    * @returns Observable<boolean>
328:    */
329:   canModifyTaskStructure(blueprintId: string): Observable<boolean> {
330:     const userId = this.getCurrentUserId();
331:     if (!userId) {
332:       return of(false);
333:     }
334: 
335:     return from(this.supabaseService.client.from('blueprints').select('owner_id').eq('id', blueprintId).single()).pipe(
336:       map(({ data, error }) => {
337:         if (error || !data) {
338:           return false;
339:         }
340:         return data.owner_id === userId;
341:       })
342:     );
343:   }
344: 
345:   /**
346:    * æ£€æŸ¥æ˜¯å¦å¯ä»¥å¡«å†™æ‰¿æ”¬æ¬„ä½ï¼ˆåä½œç»„ç»‡å¯ä»¥ï¼‰
347:    *
348:    * @param branchId åˆ†æ”¯ ID
349:    * @returns Observable<boolean>
350:    */
351:   canFillContractorFields(branchId: string): Observable<boolean> {
352:     const userId = this.getCurrentUserId();
353:     if (!userId) {
354:       return of(false);
355:     }
356: 
357:     // æ£€æŸ¥æ˜¯å¦æ˜¯åˆ†æ”¯æ‰€å±ç»„ç»‡
358:     return from(this.supabaseService.client.from('blueprint_branches').select('organization_id').eq('id', branchId).single()).pipe(
359:       map(({ data, error }) => {
360:         if (error || !data) {
361:           return false;
362:         }
363:         return data.organization_id === userId;
364:       })
365:     );
366:   }
367: 
368:   /**
369:    * æ£€æŸ¥æ˜¯å¦å¯ä»¥å®¡æ ¸ PRï¼ˆåªæœ‰æ‹¥æœ‰è€…å¯ä»¥ï¼‰
370:    *
371:    * @param blueprintId è“å›¾ ID
372:    * @returns Observable<boolean>
373:    */
374:   canReviewPR(blueprintId: string): Observable<boolean> {
375:     return this.canModifyTaskStructure(blueprintId);
376:   }
377: 
378:   /**
379:    * æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆ›å»º PRï¼ˆåˆ†æ”¯æ‰€å±ç»„ç»‡å¯ä»¥ï¼‰
380:    *
381:    * @param branchId åˆ†æ”¯ ID
382:    * @returns Observable<boolean>
383:    */
384:   canCreatePR(branchId: string): Observable<boolean> {
385:     return this.canFillContractorFields(branchId);
386:   }
387: 
388:   /**
389:    * ä»æ•°æ®åº“åŒæ­¥ç”¨æˆ·è§’è‰²åˆ° ACLService
390:    *
391:    * @param userId ç”¨æˆ· ID
392:    * @returns Promise<void>
393:    */
394:   async syncRolesFromDatabase(userId: string): Promise<void> {
395:     const { data: userRoles, error } = await this.supabaseService.client
396:       .from('user_roles')
397:       .select('roles(code, name)')
398:       .eq('account_id', userId);
399: 
400:     if (error) {
401:       throw new Error(`Failed to sync roles: ${error.message}`);
402:     }
403: 
404:     if (userRoles && userRoles.length > 0) {
405:       const roles = userRoles.map(ur => (ur.roles as any).code);
406:       this.aclService.set({ role: roles });
407:     }
408:   }
409: 
410:   /**
411:    * åŠ è½½ç”¨æˆ·æ‰€æœ‰æƒé™
412:    *
413:    * @param userId ç”¨æˆ· ID
414:    * @returns Observable<Permission[]>
415:    */
416:   loadUserPermissions(userId: string): Observable<Permission[]> {
417:     if (this.userPermissions$) {
418:       return this.userPermissions$;
419:     }
420: 
421:     this.userPermissions$ = from(
422:       this.supabaseService.client
423:         .from('user_roles')
424:         .select(
425:           `
426:           roles!inner(
427:             role_permissions!inner(
428:               permissions!inner(*)
429:             )
430:           )
431:         `
432:         )
433:         .eq('account_id', userId)
434:     ).pipe(
435:       map(({ data, error }) => {
436:         if (error) {
437:           throw new Error(`Failed to load permissions: ${error.message}`);
438:         }
439: 
440:         const permissions: Permission[] = [];
441:         if (data) {
442:           for (const userRole of data) {
443:             const role = userRole.roles as any;
444:             if (role?.role_permissions) {
445:               for (const rolePerm of role.role_permissions) {
446:                 const perm = rolePerm.permissions as Permission;
447:                 if (!permissions.find(p => p.id === perm.id)) {
448:                   permissions.push(perm);
449:                 }
450:               }
451:             }
452:           }
453:         }
454: 
455:         return permissions;
456:       }),
457:       tap(permissions => {
458:         // åŒæ­¥æƒé™åˆ° ACLService
459:         const currentData = this.aclService.data;
460:         const abilities = permissions.map(p => `${p.resource}.${p.action}`);
461:         this.aclService.set({
462:           ...currentData,
463:           abilities: abilities
464:         });
465:       }),
466:       shareReplay(1)
467:     );
468: 
469:     return this.userPermissions$;
470:   }
471: 
472:   /**
473:    * åˆ·æ–°å½“å‰ç”¨æˆ·æƒé™
474:    *
475:    * @returns Observable<void>
476:    */
477:   refreshPermissions(): Observable<void> {
478:     const userId = this.getCurrentUserId();
479:     if (!userId) {
480:       return of(undefined);
481:     }
482: 
483:     // æ¸…é™¤ç¼“å­˜
484:     this.permissionCache.clear();
485:     this.userPermissions$ = undefined;
486: 
487:     // é‡æ–°åŠ è½½æƒé™
488:     return this.loadUserPermissions(userId).pipe(
489:       switchMap(() => this.syncRolesFromDatabase(userId)),
490:       map(() => undefined),
491:       catchError(error => {
492:         return throwError(() => new Error(`Failed to refresh permissions: ${error.message}`));
493:       })
494:     );
495:   }
496: 
497:   /**
498:    * æ¸…é™¤æƒé™ç¼“å­˜
499:    */
500:   clearCache(): void {
501:     this.permissionCache.clear();
502:     this.userPermissions$ = undefined;
503:   }
504: }
````

## File: src/app/core/permissions/role.service.ts
````typescript
  1: import { Injectable, inject } from '@angular/core';
  2: import { DA_SERVICE_TOKEN } from '@delon/auth';
  3: import { Observable, from, throwError } from 'rxjs';
  4: import { map, switchMap, catchError } from 'rxjs/operators';
  5: 
  6: import { PermissionService } from './permission.service';
  7: import { Role, Permission, UserRole } from './types';
  8: import { SupabaseService } from '../supabase/supabase.service';
  9: 
 10: /**
 11:  * è§’è‰²ç®¡ç†æœåŠ¡
 12:  *
 13:  * æä¾›è§’è‰²æŸ¥è¯¢å’Œç®¡ç†åŠŸèƒ½
 14:  *
 15:  * @example
 16:  * ```typescript
 17:  * const roleService = inject(RoleService);
 18:  * roleService.getRoles().subscribe(roles => {
 19:  *   console.log('All roles:', roles);
 20:  * });
 21:  * ```
 22:  */
 23: @Injectable({
 24:   providedIn: 'root'
 25: })
 26: export class RoleService {
 27:   private readonly supabaseService = inject(SupabaseService);
 28:   private readonly permissionService = inject(PermissionService);
 29:   private readonly tokenService = inject(DA_SERVICE_TOKEN);
 30: 
 31:   /**
 32:    * è·å–å½“å‰ç”¨æˆ· ID
 33:    */
 34:   private getCurrentUserId(): string | null {
 35:     const token = this.tokenService.get();
 36:     return token?.['user']?.id || null;
 37:   }
 38: 
 39:   /**
 40:    * è·å–æ‰€æœ‰è§’è‰²
 41:    *
 42:    * @returns Observable<Role[]>
 43:    */
 44:   getRoles(): Observable<Role[]> {
 45:     return from(this.supabaseService.client.from('roles').select('*').order('priority', { ascending: false })).pipe(
 46:       map(({ data, error }) => {
 47:         if (error) {
 48:           throw new Error(`Failed to get roles: ${error.message}`);
 49:         }
 50:         return (data || []) as Role[];
 51:       })
 52:     );
 53:   }
 54: 
 55:   /**
 56:    * è·å–ç”¨æˆ·è§’è‰²
 57:    *
 58:    * @param userId ç”¨æˆ· ID
 59:    * @returns Observable<Role[]>
 60:    */
 61:   getUserRoles(userId: string): Observable<Role[]> {
 62:     return from(this.supabaseService.client.from('user_roles').select('roles(*)').eq('account_id', userId)).pipe(
 63:       map(({ data, error }) => {
 64:         if (error) {
 65:           throw new Error(`Failed to get user roles: ${error.message}`);
 66:         }
 67:         return (data || []).map((ur: any) => ur.roles as Role);
 68:       })
 69:     );
 70:   }
 71: 
 72:   /**
 73:    * è·å–è§’è‰²æƒé™
 74:    *
 75:    * @param roleId è§’è‰² ID
 76:    * @returns Observable<Permission[]>
 77:    */
 78:   getRolePermissions(roleId: string): Observable<Permission[]> {
 79:     return from(this.supabaseService.client.from('role_permissions').select('permissions(*)').eq('role_id', roleId)).pipe(
 80:       map(({ data, error }) => {
 81:         if (error) {
 82:           throw new Error(`Failed to get role permissions: ${error.message}`);
 83:         }
 84:         return (data || []).map((rp: any) => rp.permissions as Permission);
 85:       })
 86:     );
 87:   }
 88: 
 89:   /**
 90:    * æ ¹æ® ID è·å–è§’è‰²
 91:    *
 92:    * @param roleId è§’è‰² ID
 93:    * @returns Observable<Role | null>
 94:    */
 95:   getRoleById(roleId: string): Observable<Role | null> {
 96:     return from(this.supabaseService.client.from('roles').select('*').eq('id', roleId).single()).pipe(
 97:       map(({ data, error }) => {
 98:         if (error) {
 99:           if (error.code === 'PGRST116') {
100:             return null; // æœªæ‰¾åˆ°
101:           }
102:           throw new Error(`Failed to get role: ${error.message}`);
103:         }
104:         return data as Role;
105:       })
106:     );
107:   }
108: 
109:   /**
110:    * åˆ†é…è§’è‰²ç»™ç”¨æˆ·
111:    *
112:    * éœ€è¦æƒé™ï¼šrole.assign
113:    *
114:    * @param userId ç”¨æˆ· ID
115:    * @param roleId è§’è‰² ID
116:    * @param scope ä½œç”¨åŸŸï¼ˆå¯é€‰ï¼‰
117:    * @returns Observable<void>
118:    * @throws Error å¦‚æœæƒé™ä¸è¶³
119:    */
120:   assignRole(userId: string, roleId: string, scope?: { blueprintId?: string; branchId?: string }): Observable<void> {
121:     const currentUserId = this.getCurrentUserId();
122:     if (!currentUserId) {
123:       return throwError(() => new Error('User not authenticated'));
124:     }
125: 
126:     // å…ˆéªŒè¯æƒé™
127:     return this.permissionService.can('role.assign').pipe(
128:       switchMap(hasPermission => {
129:         if (!hasPermission) {
130:           return throwError(() => new Error('Permission denied: role.assign'));
131:         }
132: 
133:         return from(
134:           this.supabaseService.client.from('user_roles').insert({
135:             account_id: userId,
136:             role_id: roleId,
137:             blueprint_id: scope?.blueprintId || null,
138:             branch_id: scope?.branchId || null,
139:             granted_by: currentUserId
140:           })
141:         ).pipe(
142:           map(({ error }) => {
143:             if (error) {
144:               throw new Error(`Failed to assign role: ${error.message}`);
145:             }
146:           })
147:         );
148:       })
149:     );
150:   }
151: 
152:   /**
153:    * ç§»é™¤ç”¨æˆ·è§’è‰²
154:    *
155:    * éœ€è¦æƒé™ï¼šrole.remove
156:    *
157:    * @param userId ç”¨æˆ· ID
158:    * @param roleId è§’è‰² ID
159:    * @param scope ä½œç”¨åŸŸï¼ˆå¯é€‰ï¼‰
160:    * @returns Observable<void>
161:    * @throws Error å¦‚æœæƒé™ä¸è¶³
162:    */
163:   removeRole(userId: string, roleId: string, scope?: { blueprintId?: string; branchId?: string }): Observable<void> {
164:     const currentUserId = this.getCurrentUserId();
165:     if (!currentUserId) {
166:       return throwError(() => new Error('User not authenticated'));
167:     }
168: 
169:     // å…ˆéªŒè¯æƒé™
170:     return this.permissionService.can('role.remove').pipe(
171:       switchMap(hasPermission => {
172:         if (!hasPermission) {
173:           return throwError(() => new Error('Permission denied: role.remove'));
174:         }
175: 
176:         let query = this.supabaseService.client.from('user_roles').delete().eq('account_id', userId).eq('role_id', roleId);
177: 
178:         if (scope?.blueprintId) {
179:           query = query.eq('blueprint_id', scope.blueprintId);
180:         }
181:         if (scope?.branchId) {
182:           query = query.eq('branch_id', scope.branchId);
183:         }
184: 
185:         return from(query).pipe(
186:           map(({ error }) => {
187:             if (error) {
188:               throw new Error(`Failed to remove role: ${error.message}`);
189:             }
190:           })
191:         );
192:       })
193:     );
194:   }
195: 
196:   /**
197:    * æ›´æ–°è§’è‰²
198:    *
199:    * éœ€è¦æƒé™ï¼šrole.update
200:    *
201:    * @param roleId è§’è‰² ID
202:    * @param data æ›´æ–°æ•°æ®
203:    * @returns Observable<void>
204:    * @throws Error å¦‚æœæƒé™ä¸è¶³
205:    */
206:   updateRole(roleId: string, data: Partial<Role>): Observable<void> {
207:     const currentUserId = this.getCurrentUserId();
208:     if (!currentUserId) {
209:       return throwError(() => new Error('User not authenticated'));
210:     }
211: 
212:     // å…ˆéªŒè¯æƒé™
213:     return this.permissionService.can('role.update').pipe(
214:       switchMap(hasPermission => {
215:         if (!hasPermission) {
216:           return throwError(() => new Error('Permission denied: role.update'));
217:         }
218: 
219:         return from(this.supabaseService.client.from('roles').update(data).eq('id', roleId)).pipe(
220:           map(({ error }) => {
221:             if (error) {
222:               throw new Error(`Failed to update role: ${error.message}`);
223:             }
224:           })
225:         );
226:       })
227:     );
228:   }
229: 
230:   /**
231:    * åˆ†é…æƒé™ç»™è§’è‰²
232:    *
233:    * éœ€è¦æƒé™ï¼šrole.permission.assign
234:    *
235:    * @param roleId è§’è‰² ID
236:    * @param permissionId æƒé™ ID
237:    * @returns Observable<void>
238:    * @throws Error å¦‚æœæƒé™ä¸è¶³
239:    */
240:   assignPermissionToRole(roleId: string, permissionId: string): Observable<void> {
241:     const currentUserId = this.getCurrentUserId();
242:     if (!currentUserId) {
243:       return throwError(() => new Error('User not authenticated'));
244:     }
245: 
246:     // å…ˆéªŒè¯æƒé™
247:     return this.permissionService.can('role.permission.assign').pipe(
248:       switchMap(hasPermission => {
249:         if (!hasPermission) {
250:           return throwError(() => new Error('Permission denied: role.permission.assign'));
251:         }
252: 
253:         return from(
254:           this.supabaseService.client.from('role_permissions').insert({
255:             role_id: roleId,
256:             permission_id: permissionId
257:           })
258:         ).pipe(
259:           map(({ error }) => {
260:             if (error) {
261:               throw new Error(`Failed to assign permission: ${error.message}`);
262:             }
263:           })
264:         );
265:       })
266:     );
267:   }
268: 
269:   /**
270:    * ç§»é™¤è§’è‰²æƒé™
271:    *
272:    * éœ€è¦æƒé™ï¼šrole.permission.remove
273:    *
274:    * @param roleId è§’è‰² ID
275:    * @param permissionId æƒé™ ID
276:    * @returns Observable<void>
277:    * @throws Error å¦‚æœæƒé™ä¸è¶³
278:    */
279:   removePermissionFromRole(roleId: string, permissionId: string): Observable<void> {
280:     const currentUserId = this.getCurrentUserId();
281:     if (!currentUserId) {
282:       return throwError(() => new Error('User not authenticated'));
283:     }
284: 
285:     // å…ˆéªŒè¯æƒé™
286:     return this.permissionService.can('role.permission.remove').pipe(
287:       switchMap(hasPermission => {
288:         if (!hasPermission) {
289:           return throwError(() => new Error('Permission denied: role.permission.remove'));
290:         }
291: 
292:         return from(
293:           this.supabaseService.client.from('role_permissions').delete().eq('role_id', roleId).eq('permission_id', permissionId)
294:         ).pipe(
295:           map(({ error }) => {
296:             if (error) {
297:               throw new Error(`Failed to remove permission: ${error.message}`);
298:             }
299:           })
300:         );
301:       })
302:     );
303:   }
304: }
````

## File: src/app/core/start-page.guard.ts
````typescript
 1: import { CanActivateFn } from '@angular/router';
 2: import { Observable } from 'rxjs';
 3: 
 4: /**
 5:  * Dynamically load the start page
 6:  *
 7:  * åŠ¨æ€åŠ è½½å¯åŠ¨é¡µ
 8:  */
 9: export const startPageGuard: CanActivateFn = (): boolean | Observable<boolean> => {
10:   // Re-jump according to the first item of the menu, you can re-customize the logic
11:   // ä»¥ä¸‹ä»£ç æ˜¯æ ¹æ®èœå•çš„ç¬¬ä¸€é¡¹è¿›è¡Œé‡æ–°è·³è½¬ï¼Œä½ å¯ä»¥é‡æ–°å®šåˆ¶é€»è¾‘
12:   // const menuSrv = inject(MenuService);
13:   // if (menuSrv.find({ url: state.url }) == null) {
14:   //   inject(Router).navigateByUrl(menuSrv.menus[0].link!);
15:   //   return false;
16:   // }
17:   return true;
18: };
````

## File: src/app/core/startup/startup.service.ts
````typescript
  1: import { HttpClient } from '@angular/common/http';
  2: import { EnvironmentProviders, Injectable, Provider, inject, provideAppInitializer } from '@angular/core';
  3: import { Router } from '@angular/router';
  4: import { ACLService } from '@delon/acl';
  5: import { DA_SERVICE_TOKEN } from '@delon/auth';
  6: import { ALAIN_I18N_TOKEN, MenuService, SettingsService, TitleService } from '@delon/theme';
  7: import { NzSafeAny } from 'ng-zorro-antd/core/types';
  8: import { Observable, catchError, from, map, of, switchMap, zip } from 'rxjs';
  9: 
 10: import { I18NService } from '../i18n/i18n.service';
 11: import { AccountRepository } from '../infra/repositories/account.repository';
 12: import { MenuContextService } from '../menu-context/menu-context.service';
 13: import { PermissionService } from '../permissions/permission.service';
 14: import { SupabaseSessionAdapterService } from '../supabase';
 15: 
 16: /**
 17:  * Used for application startup
 18:  * Generally used to get the basic data of the application, like: Menu Data, User Data, etc.
 19:  */
 20: export function provideStartup(): Array<Provider | EnvironmentProviders> {
 21:   return [
 22:     StartupService,
 23:     provideAppInitializer(() => {
 24:       const initializerFn = (
 25:         (startupService: StartupService) => () =>
 26:           startupService.load()
 27:       )(inject(StartupService));
 28:       return initializerFn();
 29:     })
 30:   ];
 31: }
 32: 
 33: @Injectable()
 34: export class StartupService {
 35:   private menuService = inject(MenuService);
 36:   private menuContextService = inject(MenuContextService);
 37:   private settingService = inject(SettingsService);
 38:   private aclService = inject(ACLService);
 39:   private titleService = inject(TitleService);
 40:   private httpClient = inject(HttpClient);
 41:   private router = inject(Router);
 42:   private i18n = inject<I18NService>(ALAIN_I18N_TOKEN);
 43:   private sessionAdapter = inject(SupabaseSessionAdapterService);
 44:   private permissionService = inject(PermissionService);
 45:   private tokenService = inject(DA_SERVICE_TOKEN);
 46:   private accountRepository = inject(AccountRepository);
 47: 
 48:   load(): Observable<void> {
 49:     const defaultLang = this.i18n.defaultLang;
 50: 
 51:     // å…ˆæ¢å¾© Supabase Sessionï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œç„¶å¾ŒåŸ·è¡ŒåŸæœ‰çš„å•Ÿå‹•é‚è¼¯
 52:     return this.sessionAdapter.restoreSession().pipe(
 53:       switchMap(() => {
 54:         // åŒæ­¥ç”¨æˆ·æƒé™ï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
 55:         const currentUser = this.tokenService.get()?.['user'];
 56:         const syncPermissions$ = currentUser?.id
 57:           ? from(this.permissionService.syncRolesFromDatabase(currentUser.id)).pipe(
 58:               catchError(error => {
 59:                 console.warn('Failed to sync permissions:', error);
 60:                 return of(undefined);
 61:               })
 62:             )
 63:           : of(undefined);
 64: 
 65:         return syncPermissions$.pipe(
 66:           switchMap(() => {
 67:             // åŠ è½½å½“å‰ç”¨æˆ·çš„è´¦æˆ·ä¿¡æ¯ï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
 68:             const loadUserAccount$ = currentUser?.id
 69:               ? from(this.accountRepository.findByAuthUserId(currentUser.id)).pipe(
 70:                   catchError(error => {
 71:                     console.warn('Failed to load user account:', error);
 72:                     return of(null);
 73:                   })
 74:                 )
 75:               : of(null);
 76: 
 77:             // åŒæ—¶åŠ è½½æ‰€æœ‰èµ„æºæ–‡ä»¶
 78:             // If http request allows anonymous access, you need to add `ALLOW_ANONYMOUS`:
 79:             // this.httpClient.get('/app', { context: new HttpContext().set(ALLOW_ANONYMOUS, this.tokenService.get()?.token ? false : true) })
 80:             return zip(
 81:               this.i18n.loadLangData(defaultLang),
 82:               this.httpClient.get<NzSafeAny>('./assets/tmp/app-data.json'),
 83:               this.httpClient.get<NzSafeAny>('./assets/tmp/user-data.json').pipe(catchError(() => of({ menu: [] }))),
 84:               this.httpClient.get<NzSafeAny>('./assets/tmp/organization-data.json').pipe(catchError(() => of({ menu: [] }))),
 85:               this.httpClient.get<NzSafeAny>('./assets/tmp/team-data.json').pipe(catchError(() => of({ menu: [] }))),
 86:               loadUserAccount$
 87:             ).pipe(
 88:               // æ¥æ”¶å…¶ä»–æ‹¦æˆªå™¨åäº§ç”Ÿçš„å¼‚å¸¸æ¶ˆæ¯
 89:               catchError(res => {
 90:                 console.warn(`StartupService.load: Network request failed`, res);
 91:                 setTimeout(() => this.router.navigateByUrl(`/exception/500`));
 92:                 return [];
 93:               }),
 94:               map(
 95:                 ([langData, appData, userData, organizationData, teamData, userAccount]: [
 96:                   Record<string, string>,
 97:                   NzSafeAny,
 98:                   NzSafeAny,
 99:                   NzSafeAny,
100:                   NzSafeAny,
101:                   NzSafeAny | null
102:                 ]) => {
103:                   // setting language data
104:                   this.i18n.use(defaultLang, langData);
105: 
106:                   // åº”ç”¨ä¿¡æ¯ï¼šåŒ…æ‹¬ç«™ç‚¹åã€æè¿°ã€å¹´ä»½ï¼ˆä» app-data.json åŠ è½½ï¼‰
107:                   this.settingService.setApp(appData.app);
108: 
109:                   // ç”¨æˆ·ä¿¡æ¯ï¼šä¼˜å…ˆä» Supabase åŠ è½½ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨ JSON æ–‡ä»¶ä¸­çš„é»˜è®¤å€¼
110:                   if (userAccount) {
111:                     // ä» Supabase è´¦æˆ·è¡¨åŠ è½½ç”¨æˆ·ä¿¡æ¯
112:                     // æ³¨æ„ï¼šBaseRepository ä¼šè‡ªåŠ¨å°† snake_case è½¬æ¢ä¸º camelCase
113:                     const account = userAccount as any;
114:                     this.settingService.setUser({
115:                       name: account.name || appData.user.name,
116:                       avatar: account.avatarUrl || account.avatar_url || appData.user.avatar,
117:                       email: account.email || appData.user.email
118:                     });
119:                   } else {
120:                     // å¦‚æœæœªç™»å½•æˆ–è´¦æˆ·ä¸å­˜åœ¨ï¼Œä½¿ç”¨ JSON æ–‡ä»¶ä¸­çš„é»˜è®¤å€¼
121:                     this.settingService.setUser(appData.user);
122:                   }
123: 
124:                   // ACLï¼šå¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œæƒé™å·²é€šè¿‡ PermissionService åŒæ­¥
125:                   // å¦‚æœæœªç™»å½•ï¼Œè®¾ç½®ä¸ºå…¨é‡ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
126:                   if (!currentUser?.id) {
127:                     this.aclService.setFull(true);
128:                   }
129: 
130:                   // åˆå§‹åŒ–èœå•ä¸Šä¸‹æ–‡æœåŠ¡ï¼Œä¿å­˜ä¸åŒè´¦æˆ·ç±»å‹çš„èœå•æ•°æ®
131:                   this.menuContextService.initializeMenuData({
132:                     appMenu: appData.menu || [],
133:                     userMenu: userData.menu || [],
134:                     organizationMenu: organizationData.menu || [],
135:                     teamMenu: teamData.menu || []
136:                   });
137: 
138:                   // è®¾ç½®é¡µé¢æ ‡é¢˜çš„åç¼€
139:                   this.titleService.default = '';
140:                   this.titleService.suffix = appData.app.name;
141:                 }
142:               )
143:             );
144:           })
145:         );
146:       })
147:     );
148:   }
149: }
````

## File: src/app/core/supabase/index.ts
````typescript
1: export * from './supabase.service';
2: export * from './supabase-session-adapter.service';
````

## File: src/app/core/supabase/supabase-session-adapter.service.ts
````typescript
  1: import { isPlatformBrowser } from '@angular/common';
  2: import { Injectable, PLATFORM_ID, inject } from '@angular/core';
  3: import { DA_SERVICE_TOKEN } from '@delon/auth';
  4: import { AuthChangeEvent, Session } from '@supabase/supabase-js';
  5: import { Observable, from, of, throwError } from 'rxjs';
  6: import { catchError, map, switchMap, tap } from 'rxjs/operators';
  7: 
  8: import { SupabaseService } from './supabase.service';
  9: 
 10: /**
 11:  * Supabase Session é€‚é…å™¨æœåŠ¡ï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰
 12:  *
 13:  * èŒè´£ï¼š
 14:  * 1. Session æ ¼å¼è½¬æ¢ï¼ˆSupabase Session â†’ @delon/auth Token æ ¼å¼ï¼‰
 15:  * 2. Token åŒæ­¥åˆ° TokenService
 16:  * 3. Auth çŠ¶æ€ç›‘å¬å’ŒåŒæ­¥
 17:  * 4. Session æ¢å¤å’Œåˆ·æ–°
 18:  *
 19:  * ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚ signIn, signUp, signOutï¼‰ï¼Œè¿™äº›åº”è¯¥åœ¨ shared/services/auth ä¸­å®ç°
 20:  *
 21:  * @example
 22:  * ```typescript
 23:  * const adapter = inject(SupabaseSessionAdapterService);
 24:  * adapter.restoreSession().subscribe();
 25:  * ```
 26:  */
 27: @Injectable({
 28:   providedIn: 'root'
 29: })
 30: export class SupabaseSessionAdapterService {
 31:   private readonly supabaseService = inject(SupabaseService);
 32:   private readonly tokenService = inject(DA_SERVICE_TOKEN);
 33:   private readonly platformId = inject(PLATFORM_ID);
 34:   private authListenerInitialized = false;
 35: 
 36:   constructor() {
 37:     // åœ¨ç€è¦½å™¨ç’°å¢ƒä¸­åˆå§‹åŒ– Auth ç›£è½å™¨
 38:     if (isPlatformBrowser(this.platformId)) {
 39:       this.initializeAuthListener();
 40:     }
 41:   }
 42: 
 43:   /**
 44:    * åˆ·æ–° Session
 45:    *
 46:    * @returns Observable<Session>
 47:    */
 48:   refreshSession(): Observable<Session> {
 49:     return from(this.supabaseService.client.auth.refreshSession()).pipe(
 50:       switchMap(({ data, error }) => {
 51:         if (error) {
 52:           return throwError(() => error);
 53:         }
 54:         if (!data.session) {
 55:           return throwError(() => new Error('No session available'));
 56:         }
 57:         this.syncSessionToTokenService(data.session);
 58:         return of(data.session);
 59:       })
 60:     );
 61:   }
 62: 
 63:   /**
 64:    * æ¢å¾© Sessionï¼ˆæ‡‰ç”¨å•Ÿå‹•æ™‚èª¿ç”¨ï¼‰
 65:    *
 66:    * @returns Observable<void>
 67:    */
 68:   restoreSession(): Observable<void> {
 69:     if (!isPlatformBrowser(this.platformId)) {
 70:       return of(undefined);
 71:     }
 72: 
 73:     return from(this.supabaseService.client.auth.getSession()).pipe(
 74:       tap(({ data }) => {
 75:         if (data.session) {
 76:           this.syncSessionToTokenService(data.session);
 77:         }
 78:       }),
 79:       map(() => undefined),
 80:       catchError(() => of(undefined))
 81:     );
 82:   }
 83: 
 84:   /**
 85:    * åˆå§‹åŒ– Auth ç‹€æ…‹ç›£è½å™¨
 86:    * ç›£è½ Supabase Auth ç‹€æ…‹è®ŠåŒ–ï¼Œè‡ªå‹•åŒæ­¥åˆ° TokenService
 87:    */
 88:   initializeAuthListener(): void {
 89:     if (this.authListenerInitialized || !isPlatformBrowser(this.platformId)) {
 90:       return;
 91:     }
 92: 
 93:     this.supabaseService.client.auth.onAuthStateChange((event: AuthChangeEvent, session: Session | null) => {
 94:       if (session) {
 95:         this.syncSessionToTokenService(session);
 96:       } else if (event === 'SIGNED_OUT') {
 97:         this.tokenService.clear();
 98:       }
 99:     });
100: 
101:     this.authListenerInitialized = true;
102:   }
103: 
104:   /**
105:    * å°‡ Supabase Session è½‰æ›ç‚º @delon/auth Token æ ¼å¼
106:    *
107:    * @param session Supabase Session
108:    * @returns @delon/auth Token æ ¼å¼å°è±¡
109:    */
110:   convertSessionToTokenFormat(session: Session): {
111:     token: string;
112:     refresh_token: string;
113:     expired: number;
114:     user: {
115:       id: string;
116:       email?: string;
117:       [key: string]: any;
118:     };
119:   } {
120:     const expiresIn = session.expires_in || 3600; // é è¨­ 1 å°æ™‚
121:     const expired = Date.now() + expiresIn * 1000;
122: 
123:     return {
124:       token: session.access_token,
125:       refresh_token: session.refresh_token,
126:       expired,
127:       user: {
128:         id: session.user.id,
129:         email: session.user.email,
130:         ...session.user.user_metadata,
131:         ...session.user.app_metadata
132:       }
133:     };
134:   }
135: 
136:   /**
137:    * åŒæ­¥ Supabase Session åˆ° @delon/auth TokenService
138:    *
139:    * @param session Supabase Session
140:    */
141:   syncSessionToTokenService(session: Session): void {
142:     const tokenData = this.convertSessionToTokenFormat(session);
143:     this.tokenService.set(tokenData);
144:   }
145: 
146:   /**
147:    * æ¸…é™¤ TokenServiceï¼ˆç™»å‡ºæ—¶è°ƒç”¨ï¼‰
148:    */
149:   clearTokenService(): void {
150:     this.tokenService.clear();
151:   }
152: 
153:   /**
154:    * ç²å–ç•¶å‰ Session
155:    *
156:    * @returns Observable<Session | null>
157:    */
158:   getCurrentSession(): Observable<Session | null> {
159:     return from(this.supabaseService.client.auth.getSession()).pipe(map(({ data }) => data.session));
160:   }
161: }
````

## File: src/app/core/supabase/supabase.service.ts
````typescript
 1: import { Injectable, inject } from '@angular/core';
 2: import { environment } from '@env/environment';
 3: import { createClient, SupabaseClient } from '@supabase/supabase-js';
 4: 
 5: /**
 6:  * Supabase å®¢æˆ¶ç«¯æœå‹™
 7:  *
 8:  * æä¾› Supabase å®¢æˆ¶ç«¯å–®ä¾‹ï¼Œç”¨æ–¼è¨ªå• Supabase çš„æ‰€æœ‰åŠŸèƒ½ï¼š
 9:  * - Database (PostgreSQL)
10:  * - Authentication
11:  * - Storage
12:  * - Realtime
13:  *
14:  * @example
15:  * ```typescript
16:  * const supabase = inject(SupabaseService);
17:  * const client = supabase.client;
18:  * ```
19:  */
20: @Injectable({
21:   providedIn: 'root'
22: })
23: export class SupabaseService {
24:   private readonly supabase: SupabaseClient;
25: 
26:   constructor() {
27:     const supabaseConfig = (environment as any)['supabase'];
28:     if (!supabaseConfig?.url || !supabaseConfig?.anonKey) {
29:       throw new Error('Supabase configuration is missing. Please check environment variables.');
30:     }
31: 
32:     this.supabase = createClient(supabaseConfig.url, supabaseConfig.anonKey, {
33:       auth: {
34:         persistSession: true,
35:         autoRefreshToken: true,
36:         detectSessionInUrl: true
37:       }
38:     });
39:   }
40: 
41:   /**
42:    * ç²å– Supabase å®¢æˆ¶ç«¯å¯¦ä¾‹
43:    */
44:   get client(): SupabaseClient {
45:     return this.supabase;
46:   }
47: }
````

## File: src/app/layout/basic/widgets/clear-storage.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component, HostListener, inject } from '@angular/core';
 2: import { I18nPipe } from '@delon/theme';
 3: import { NzIconModule } from 'ng-zorro-antd/icon';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: import { NzModalService } from 'ng-zorro-antd/modal';
 6: 
 7: @Component({
 8:   selector: 'header-clear-storage',
 9:   template: `
10:     <i nz-icon nzType="tool"></i>
11:     {{ 'menu.clear.local.storage' | i18n }}
12:   `,
13:   host: {
14:     '[class.flex-1]': 'true'
15:   },
16:   changeDetection: ChangeDetectionStrategy.OnPush,
17:   imports: [NzIconModule, I18nPipe]
18: })
19: export class HeaderClearStorageComponent {
20:   private readonly modalSrv = inject(NzModalService);
21:   private readonly messageSrv = inject(NzMessageService);
22: 
23:   @HostListener('click')
24:   _click(): void {
25:     this.modalSrv.confirm({
26:       nzTitle: 'Make sure clear all local storage?',
27:       nzOnOk: () => {
28:         localStorage.clear();
29:         this.messageSrv.success('Clear Finished!');
30:       }
31:     });
32:   }
33: }
````

## File: src/app/layout/basic/widgets/context-switcher.component.ts
````typescript
  1: import { ChangeDetectionStrategy, Component, computed, inject } from '@angular/core';
  2: import { MenuContextService } from '@core';
  3: import { SettingsService } from '@delon/theme';
  4: import { AccountService, SHARED_IMPORTS } from '@shared';
  5: import { NzDropDownModule } from 'ng-zorro-antd/dropdown';
  6: import { NzIconModule } from 'ng-zorro-antd/icon';
  7: import { NzMenuModule } from 'ng-zorro-antd/menu';
  8: 
  9: /**
 10:  * è´¦æˆ·ä¸Šä¸‹æ–‡åˆ‡æ¢å™¨ç»„ä»¶
 11:  *
 12:  * å…è®¸ç”¨æˆ·åœ¨ä¸ªäººã€ç»„ç»‡ã€å›¢é˜Ÿä¹‹é—´åˆ‡æ¢ï¼Œè‡ªåŠ¨æ›´æ–°èœå•
 13:  */
 14: @Component({
 15:   selector: 'header-context-switcher',
 16:   standalone: true,
 17:   imports: [SHARED_IMPORTS, NzDropDownModule, NzMenuModule, NzIconModule],
 18:   template: `
 19:     <div
 20:       class="alain-default__nav-item d-flex align-items-center px-sm"
 21:       nz-dropdown
 22:       nzPlacement="bottomRight"
 23:       [nzDropdownMenu]="contextMenu"
 24:     >
 25:       <i nz-icon [nzType]="contextIcon()" class="mr-sm"></i>
 26:       <span>{{ contextLabel() }}</span>
 27:     </div>
 28:     <nz-dropdown-menu #contextMenu="nzDropdownMenu">
 29:       <div nz-menu class="width-sm">
 30:         <!-- åº”ç”¨èœå• -->
 31:         <div nz-menu-item (click)="switchToApp()" [class.ant-menu-item-selected]="menuContextService.contextType() === 'app'">
 32:           <i nz-icon nzType="appstore" class="mr-sm"></i>
 33:           <span>åº”ç”¨èœå•</span>
 34:         </div>
 35:         <li nz-menu-divider></li>
 36: 
 37:         <!-- ä¸ªäººè´¦æˆ·èœå• -->
 38:         @if (userAccounts().length > 0) {
 39:           <div nz-submenu nzTitle="ä¸ªäººè´¦æˆ·" nzIcon="user">
 40:             <ul nz-menu>
 41:               @for (account of userAccounts(); track account.id) {
 42:                 <li
 43:                   nz-menu-item
 44:                   (click)="switchToUser(account.id)"
 45:                   [class.ant-menu-item-selected]="
 46:                     menuContextService.contextType() === 'user' && menuContextService.contextId() === account.id
 47:                   "
 48:                 >
 49:                   <i nz-icon nzType="user" class="mr-sm"></i>
 50:                   <span>{{ account.name }}</span>
 51:                 </li>
 52:               }
 53:             </ul>
 54:           </div>
 55:         }
 56: 
 57:         <!-- ç»„ç»‡è´¦æˆ·èœå• -->
 58:         @if (organizationAccounts().length > 0) {
 59:           <div nz-submenu nzTitle="ç»„ç»‡è´¦æˆ·" nzIcon="team">
 60:             <ul nz-menu>
 61:               @for (account of organizationAccounts(); track account.id) {
 62:                 <li
 63:                   nz-menu-item
 64:                   (click)="switchToOrganization(account.id)"
 65:                   [class.ant-menu-item-selected]="
 66:                     menuContextService.contextType() === 'organization' && menuContextService.contextId() === account.id
 67:                   "
 68:                 >
 69:                   <i nz-icon nzType="team" class="mr-sm"></i>
 70:                   <span>{{ account.name }}</span>
 71:                 </li>
 72:               }
 73:             </ul>
 74:           </div>
 75:         }
 76: 
 77:         <!-- å¦‚æœæ²¡æœ‰è´¦æˆ·ï¼Œæ˜¾ç¤ºæç¤º -->
 78:         @if (userAccounts().length === 0 && organizationAccounts().length === 0) {
 79:           <li nz-menu-item nzDisabled>
 80:             <i nz-icon nzType="info-circle" class="mr-sm"></i>
 81:             <span>æš‚æ— å¯ç”¨è´¦æˆ·</span>
 82:           </li>
 83:         }
 84:       </div>
 85:     </nz-dropdown-menu>
 86:   `,
 87:   changeDetection: ChangeDetectionStrategy.OnPush
 88: })
 89: export class HeaderContextSwitcherComponent {
 90:   readonly menuContextService = inject(MenuContextService);
 91:   readonly accountService = inject(AccountService);
 92:   readonly settings = inject(SettingsService);
 93: 
 94:   // Computed signals
 95:   readonly userAccounts = computed(() => this.accountService.userAccounts());
 96:   readonly organizationAccounts = computed(() => this.accountService.organizationAccounts());
 97: 
 98:   // å½“å‰ä¸Šä¸‹æ–‡æ ‡ç­¾å’Œå›¾æ ‡
 99:   readonly contextLabel = computed(() => {
100:     const type = this.menuContextService.contextType();
101:     const id = this.menuContextService.contextId();
102: 
103:     switch (type) {
104:       case 'user':
105:         if (id) {
106:           const account = this.userAccounts().find(a => a.id === id);
107:           return account?.name || 'ä¸ªäººè´¦æˆ·';
108:         }
109:         return 'ä¸ªäººè´¦æˆ·';
110:       case 'organization':
111:         if (id) {
112:           const account = this.organizationAccounts().find(a => a.id === id);
113:           return account?.name || 'ç»„ç»‡è´¦æˆ·';
114:         }
115:         return 'ç»„ç»‡è´¦æˆ·';
116:       case 'team':
117:         return 'å›¢é˜Ÿ';
118:       default:
119:         return 'åº”ç”¨èœå•';
120:     }
121:   });
122: 
123:   readonly contextIcon = computed(() => {
124:     const type = this.menuContextService.contextType();
125:     switch (type) {
126:       case 'user':
127:         return 'user';
128:       case 'organization':
129:         return 'team';
130:       case 'team':
131:         return 'usergroup-add';
132:       default:
133:         return 'appstore';
134:     }
135:   });
136: 
137:   /**
138:    * åˆ‡æ¢åˆ°åº”ç”¨èœå•
139:    */
140:   switchToApp(): void {
141:     this.menuContextService.switchToApp();
142:   }
143: 
144:   /**
145:    * åˆ‡æ¢åˆ°ä¸ªäººç”¨æˆ·èœå•
146:    */
147:   switchToUser(userId: string): void {
148:     this.menuContextService.switchToUser(userId);
149:     // åŒæ—¶æ›´æ–° AccountService çš„é€‰ä¸­è´¦æˆ·
150:     const account = this.userAccounts().find(a => a.id === userId);
151:     if (account) {
152:       this.accountService.selectAccount(account);
153:     }
154:   }
155: 
156:   /**
157:    * åˆ‡æ¢åˆ°ç»„ç»‡èœå•
158:    */
159:   switchToOrganization(organizationId: string): void {
160:     this.menuContextService.switchToOrganization(organizationId);
161:     // åŒæ—¶æ›´æ–° AccountService çš„é€‰ä¸­è´¦æˆ·
162:     const account = this.organizationAccounts().find(a => a.id === organizationId);
163:     if (account) {
164:       this.accountService.selectAccount(account);
165:     }
166:   }
167: }
````

## File: src/app/layout/basic/widgets/fullscreen.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component, HostListener } from '@angular/core';
 2: import { I18nPipe } from '@delon/theme';
 3: import { NzIconModule } from 'ng-zorro-antd/icon';
 4: import screenfull from 'screenfull';
 5: 
 6: @Component({
 7:   selector: 'header-fullscreen',
 8:   template: `
 9:     <i nz-icon [nzType]="status ? 'fullscreen-exit' : 'fullscreen'"></i>
10:     {{ (status ? 'menu.fullscreen.exit' : 'menu.fullscreen') | i18n }}
11:   `,
12:   host: {
13:     '[class.flex-1]': 'true'
14:   },
15:   changeDetection: ChangeDetectionStrategy.OnPush,
16:   imports: [NzIconModule, I18nPipe]
17: })
18: export class HeaderFullScreenComponent {
19:   status = false;
20: 
21:   @HostListener('window:resize')
22:   _resize(): void {
23:     this.status = screenfull.isFullscreen;
24:   }
25: 
26:   @HostListener('click')
27:   _click(): void {
28:     if (screenfull.isEnabled) {
29:       screenfull.toggle();
30:     }
31:   }
32: }
````

## File: src/app/layout/basic/widgets/i18n.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component, Input, booleanAttribute, inject, DOCUMENT } from '@angular/core';
 2: import { I18NService } from '@core';
 3: import { ALAIN_I18N_TOKEN, I18nPipe, SettingsService } from '@delon/theme';
 4: import { NzDropDownModule } from 'ng-zorro-antd/dropdown';
 5: import { NzIconModule } from 'ng-zorro-antd/icon';
 6: import { NzMenuModule } from 'ng-zorro-antd/menu';
 7: 
 8: @Component({
 9:   selector: 'header-i18n',
10:   template: `
11:     @if (showLangText) {
12:       <div nz-dropdown [nzDropdownMenu]="langMenu" nzPlacement="bottomRight">
13:         <i nz-icon nzType="global"></i>
14:         {{ 'menu.lang' | i18n }}
15:         <i nz-icon nzType="down"></i>
16:       </div>
17:     } @else {
18:       <i nz-dropdown [nzDropdownMenu]="langMenu" nzPlacement="bottomRight" nz-icon nzType="global"></i>
19:     }
20:     <nz-dropdown-menu #langMenu="nzDropdownMenu">
21:       <ul nz-menu>
22:         @for (item of langs; track $index) {
23:           <li nz-menu-item [nzSelected]="item.code === curLangCode" (click)="change(item.code)">
24:             <span role="img" [attr.aria-label]="item.text" class="pr-xs">{{ item.abbr }}</span>
25:             {{ item.text }}
26:           </li>
27:         }
28:       </ul>
29:     </nz-dropdown-menu>
30:   `,
31:   host: {
32:     '[class.flex-1]': 'true'
33:   },
34:   changeDetection: ChangeDetectionStrategy.OnPush,
35:   imports: [I18nPipe, NzDropDownModule, NzIconModule, NzMenuModule]
36: })
37: export class HeaderI18nComponent {
38:   private readonly settings = inject(SettingsService);
39:   private readonly i18n = inject<I18NService>(ALAIN_I18N_TOKEN);
40:   private readonly doc = inject(DOCUMENT);
41:   /** Whether to display language text */
42:   @Input({ transform: booleanAttribute }) showLangText = true;
43: 
44:   get langs(): Array<{ code: string; text: string; abbr: string }> {
45:     return this.i18n.getLangs();
46:   }
47: 
48:   get curLangCode(): string {
49:     return this.settings.layout.lang;
50:   }
51: 
52:   change(lang: string): void {
53:     const spinEl = this.doc.createElement('div');
54:     spinEl.setAttribute('class', `page-loading ant-spin ant-spin-lg ant-spin-spinning`);
55:     spinEl.innerHTML = `<span class="ant-spin-dot ant-spin-dot-spin"><i></i><i></i><i></i><i></i></span>`;
56:     this.doc.body.appendChild(spinEl);
57: 
58:     this.i18n.loadLangData(lang).subscribe(res => {
59:       this.i18n.use(lang, res);
60:       this.settings.setLayout('lang', lang);
61:       setTimeout(() => this.doc.location.reload());
62:     });
63:   }
64: }
````

## File: src/app/layout/basic/widgets/icon.component.ts
````typescript
 1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, inject } from '@angular/core';
 2: import { NzDropDownModule } from 'ng-zorro-antd/dropdown';
 3: import { NzGridModule } from 'ng-zorro-antd/grid';
 4: import { NzIconModule } from 'ng-zorro-antd/icon';
 5: import { NzMenuModule } from 'ng-zorro-antd/menu';
 6: import { NzSpinModule } from 'ng-zorro-antd/spin';
 7: 
 8: @Component({
 9:   selector: 'header-icon',
10:   template: `
11:     <div
12:       class="alain-default__nav-item"
13:       nz-dropdown
14:       [nzDropdownMenu]="iconMenu"
15:       nzTrigger="click"
16:       nzPlacement="bottomRight"
17:       (nzVisibleChange)="change()"
18:     >
19:       <i nz-icon nzType="appstore"></i>
20:     </div>
21:     <nz-dropdown-menu #iconMenu="nzDropdownMenu">
22:       <div nz-menu class="wd-xl animated jello">
23:         <nz-spin [nzSpinning]="loading" [nzTip]="'æ­£åœ¨è¯»å–æ•°æ®...'">
24:           <div nz-row [nzJustify]="'center'" [nzAlign]="'middle'" class="app-icons">
25:             <div nz-col [nzSpan]="6">
26:               <i nz-icon nzType="calendar" class="bg-error text-white"></i>
27:               <small>Calendar</small>
28:             </div>
29:             <div nz-col [nzSpan]="6">
30:               <i nz-icon nzType="file" class="bg-geekblue text-white"></i>
31:               <small>Files</small>
32:             </div>
33:             <div nz-col [nzSpan]="6">
34:               <i nz-icon nzType="cloud" class="bg-success text-white"></i>
35:               <small>Cloud</small>
36:             </div>
37:             <div nz-col [nzSpan]="6">
38:               <i nz-icon nzType="star" class="bg-magenta text-white"></i>
39:               <small>Star</small>
40:             </div>
41:             <div nz-col [nzSpan]="6">
42:               <i nz-icon nzType="team" class="bg-purple text-white"></i>
43:               <small>Team</small>
44:             </div>
45:             <div nz-col [nzSpan]="6">
46:               <i nz-icon nzType="scan" class="bg-warning text-white"></i>
47:               <small>QR</small>
48:             </div>
49:             <div nz-col [nzSpan]="6">
50:               <i nz-icon nzType="pay-circle" class="bg-cyan text-white"></i>
51:               <small>Pay</small>
52:             </div>
53:             <div nz-col [nzSpan]="6">
54:               <i nz-icon nzType="printer" class="bg-grey text-white"></i>
55:               <small>Print</small>
56:             </div>
57:           </div>
58:         </nz-spin>
59:       </div>
60:     </nz-dropdown-menu>
61:   `,
62:   changeDetection: ChangeDetectionStrategy.OnPush,
63:   imports: [NzDropDownModule, NzIconModule, NzMenuModule, NzGridModule, NzSpinModule]
64: })
65: export class HeaderIconComponent {
66:   private readonly cdr = inject(ChangeDetectorRef);
67:   loading = true;
68: 
69:   change(): void {
70:     setTimeout(() => {
71:       this.loading = false;
72:       this.cdr.detectChanges();
73:     }, 500);
74:   }
75: }
````

## File: src/app/layout/basic/widgets/notify.component.ts
````typescript
  1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, inject } from '@angular/core';
  2: import { NoticeIconList, NoticeIconModule, NoticeIconSelect, NoticeItem } from '@delon/abc/notice-icon';
  3: import { add, formatDistanceToNow, parse } from 'date-fns';
  4: import { NzI18nService } from 'ng-zorro-antd/i18n';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: 
  7: @Component({
  8:   selector: 'header-notify',
  9:   template: `
 10:     <notice-icon
 11:       [data]="data"
 12:       [count]="count"
 13:       [loading]="loading"
 14:       btnClass="alain-default__nav-item"
 15:       btnIconClass="alain-default__nav-item-icon"
 16:       (select)="select($event)"
 17:       (clear)="clear($event)"
 18:       (popoverVisibleChange)="loadData()"
 19:     />
 20:   `,
 21:   changeDetection: ChangeDetectionStrategy.OnPush,
 22:   imports: [NoticeIconModule]
 23: })
 24: export class HeaderNotifyComponent {
 25:   private readonly msg = inject(NzMessageService);
 26:   private readonly nzI18n = inject(NzI18nService);
 27:   private readonly cdr = inject(ChangeDetectorRef);
 28:   data: NoticeItem[] = [
 29:     {
 30:       title: 'é€šçŸ¥',
 31:       list: [],
 32:       emptyText: 'ä½ å·²æŸ¥çœ‹æ‰€æœ‰é€šçŸ¥',
 33:       emptyImage: 'https://gw.alipayobjects.com/zos/rmsportal/wAhyIChODzsoKIOBHcBk.svg',
 34:       clearText: 'æ¸…ç©ºé€šçŸ¥'
 35:     },
 36:     {
 37:       title: 'æ¶ˆæ¯',
 38:       list: [],
 39:       emptyText: 'æ‚¨å·²è¯»å®Œæ‰€æœ‰æ¶ˆæ¯',
 40:       emptyImage: 'https://gw.alipayobjects.com/zos/rmsportal/sAuJeJzSKbUmHfBQRzmZ.svg',
 41:       clearText: 'æ¸…ç©ºæ¶ˆæ¯'
 42:     },
 43:     {
 44:       title: 'å¾…åŠ',
 45:       list: [],
 46:       emptyText: 'ä½ å·²å®Œæˆæ‰€æœ‰å¾…åŠ',
 47:       emptyImage: 'https://gw.alipayobjects.com/zos/rmsportal/HsIsxMZiWKrNUavQUXqx.svg',
 48:       clearText: 'æ¸…ç©ºå¾…åŠ'
 49:     }
 50:   ];
 51:   count = 5;
 52:   loading = false;
 53: 
 54:   private updateNoticeData(notices: NoticeIconList[]): NoticeItem[] {
 55:     const data = this.data.slice();
 56:     data.forEach(i => (i.list = []));
 57: 
 58:     notices.forEach(item => {
 59:       const newItem = { ...item } as NoticeIconList;
 60:       if (typeof newItem.datetime === 'string') {
 61:         newItem.datetime = parse(newItem.datetime, 'yyyy-MM-dd', new Date());
 62:       }
 63:       if (newItem.datetime) {
 64:         newItem.datetime = formatDistanceToNow(newItem.datetime as Date, { locale: this.nzI18n.getDateLocale() });
 65:       }
 66:       if (newItem.extra && newItem['status']) {
 67:         newItem['color'] = (
 68:           {
 69:             todo: undefined,
 70:             processing: 'blue',
 71:             urgent: 'red',
 72:             doing: 'gold'
 73:           } as Record<string, string | undefined>
 74:         )[newItem['status']];
 75:       }
 76:       data.find(w => w.title === newItem['type'])!.list.push(newItem);
 77:     });
 78:     return data;
 79:   }
 80: 
 81:   loadData(): void {
 82:     if (this.loading) {
 83:       return;
 84:     }
 85:     this.loading = true;
 86:     setTimeout(() => {
 87:       const now = new Date();
 88:       this.data = this.updateNoticeData([
 89:         {
 90:           id: '000000001',
 91:           avatar: 'https://gw.alipayobjects.com/zos/rmsportal/ThXAXghbEsBCCSDihZxY.png',
 92:           title: 'ä½ æ”¶åˆ°äº† 14 ä»½æ–°å‘¨æŠ¥',
 93:           datetime: add(now, { days: 10 }),
 94:           type: 'é€šçŸ¥'
 95:         },
 96:         {
 97:           id: '000000002',
 98:           avatar: 'https://gw.alipayobjects.com/zos/rmsportal/OKJXDXrmkNshAMvwtvhu.png',
 99:           title: 'ä½ æ¨èçš„ æ›²å¦®å¦® å·²é€šè¿‡ç¬¬ä¸‰è½®é¢è¯•',
100:           datetime: add(now, { days: -3 }),
101:           type: 'é€šçŸ¥'
102:         },
103:         {
104:           id: '000000003',
105:           avatar: 'https://gw.alipayobjects.com/zos/rmsportal/kISTdvpyTAhtGxpovNWd.png',
106:           title: 'è¿™ç§æ¨¡æ¿å¯ä»¥åŒºåˆ†å¤šç§é€šçŸ¥ç±»å‹',
107:           datetime: add(now, { months: -3 }),
108:           read: true,
109:           type: 'é€šçŸ¥'
110:         },
111:         {
112:           id: '000000004',
113:           avatar: 'https://gw.alipayobjects.com/zos/rmsportal/GvqBnKhFgObvnSGkDsje.png',
114:           title: 'å·¦ä¾§å›¾æ ‡ç”¨äºåŒºåˆ†ä¸åŒçš„ç±»å‹',
115:           datetime: add(now, { years: -1 }),
116:           type: 'é€šçŸ¥'
117:         },
118:         {
119:           id: '000000005',
120:           avatar: 'https://gw.alipayobjects.com/zos/rmsportal/ThXAXghbEsBCCSDihZxY.png',
121:           title: 'å†…å®¹ä¸è¦è¶…è¿‡ä¸¤è¡Œå­—ï¼Œè¶…å‡ºæ—¶è‡ªåŠ¨æˆªæ–­',
122:           datetime: '2017-08-07',
123:           type: 'é€šçŸ¥'
124:         },
125:         {
126:           id: '000000006',
127:           avatar: 'https://gw.alipayobjects.com/zos/rmsportal/fcHMVNCjPOsbUGdEduuv.jpeg',
128:           title: 'æ›²ä¸½ä¸½ è¯„è®ºäº†ä½ ',
129:           description: 'æè¿°ä¿¡æ¯æè¿°ä¿¡æ¯æè¿°ä¿¡æ¯',
130:           datetime: '2017-08-07',
131:           type: 'æ¶ˆæ¯'
132:         },
133:         {
134:           id: '000000007',
135:           avatar: 'https://gw.alipayobjects.com/zos/rmsportal/fcHMVNCjPOsbUGdEduuv.jpeg',
136:           title: 'æœ±åå³ å›å¤äº†ä½ ',
137:           description: 'è¿™ç§æ¨¡æ¿ç”¨äºæé†’è°ä¸ä½ å‘ç”Ÿäº†äº’åŠ¨ï¼Œå·¦ä¾§æ”¾ã€è°ã€çš„å¤´åƒ',
138:           datetime: '2017-08-07',
139:           type: 'æ¶ˆæ¯'
140:         },
141:         {
142:           id: '000000008',
143:           avatar: 'https://gw.alipayobjects.com/zos/rmsportal/fcHMVNCjPOsbUGdEduuv.jpeg',
144:           title: 'æ ‡é¢˜',
145:           description: 'è¿™ç§æ¨¡æ¿ç”¨äºæé†’è°ä¸ä½ å‘ç”Ÿäº†äº’åŠ¨ï¼Œå·¦ä¾§æ”¾ã€è°ã€çš„å¤´åƒ',
146:           datetime: '2017-08-07',
147:           type: 'æ¶ˆæ¯'
148:         },
149:         {
150:           id: '000000009',
151:           title: 'ä»»åŠ¡åç§°',
152:           description: 'ä»»åŠ¡éœ€è¦åœ¨ 2017-01-12 20:00 å‰å¯åŠ¨',
153:           extra: 'æœªå¼€å§‹',
154:           status: 'todo',
155:           type: 'å¾…åŠ'
156:         },
157:         {
158:           id: '000000010',
159:           title: 'ç¬¬ä¸‰æ–¹ç´§æ€¥ä»£ç å˜æ›´',
160:           description: 'å† éœ–æäº¤äº 2017-01-06ï¼Œéœ€åœ¨ 2017-01-07 å‰å®Œæˆä»£ç å˜æ›´ä»»åŠ¡',
161:           extra: 'é©¬ä¸Šåˆ°æœŸ',
162:           status: 'urgent',
163:           type: 'å¾…åŠ'
164:         },
165:         {
166:           id: '000000011',
167:           title: 'ä¿¡æ¯å®‰å…¨è€ƒè¯•',
168:           description: 'æŒ‡æ´¾ç«¹å°”äº 2017-01-09 å‰å®Œæˆæ›´æ–°å¹¶å‘å¸ƒ',
169:           extra: 'å·²è€—æ—¶ 8 å¤©',
170:           status: 'doing',
171:           type: 'å¾…åŠ'
172:         },
173:         {
174:           id: '000000012',
175:           title: 'ABCD ç‰ˆæœ¬å‘å¸ƒ',
176:           description: 'å† éœ–æäº¤äº 2017-01-06ï¼Œéœ€åœ¨ 2017-01-07 å‰å®Œæˆä»£ç å˜æ›´ä»»åŠ¡',
177:           extra: 'è¿›è¡Œä¸­',
178:           status: 'processing',
179:           type: 'å¾…åŠ'
180:         }
181:       ]);
182: 
183:       this.loading = false;
184:       this.cdr.detectChanges();
185:     }, 500);
186:   }
187: 
188:   clear(type: string): void {
189:     this.msg.success(`æ¸…ç©ºäº† ${type}`);
190:   }
191: 
192:   select(res: NoticeIconSelect): void {
193:     this.msg.success(`ç‚¹å‡»äº† ${res.title} çš„ ${res.item.title}`);
194:   }
195: }
````

## File: src/app/layout/basic/widgets/rtl.component.ts
````typescript
 1: import { UpperCasePipe } from '@angular/common';
 2: import { ChangeDetectionStrategy, Component, HostListener, inject } from '@angular/core';
 3: import { RTLService } from '@delon/theme';
 4: import { NzIconModule } from 'ng-zorro-antd/icon';
 5: 
 6: @Component({
 7:   selector: 'header-rtl',
 8:   template: `
 9:     <i nz-icon [nzType]="rtl.nextDir === 'rtl' ? 'border-left' : 'border-right'"></i>
10:     {{ rtl.nextDir | uppercase }}
11:   `,
12:   host: {
13:     '[class.flex-1]': 'true'
14:   },
15:   changeDetection: ChangeDetectionStrategy.OnPush,
16:   imports: [NzIconModule, UpperCasePipe]
17: })
18: export class HeaderRTLComponent {
19:   readonly rtl = inject(RTLService);
20: 
21:   @HostListener('click')
22:   toggleDirection(): void {
23:     this.rtl.toggle();
24:   }
25: }
````

## File: src/app/layout/basic/widgets/search.component.ts
````typescript
  1: import {
  2:   AfterViewInit,
  3:   ChangeDetectionStrategy,
  4:   ChangeDetectorRef,
  5:   Component,
  6:   ElementRef,
  7:   EventEmitter,
  8:   HostBinding,
  9:   Input,
 10:   OnDestroy,
 11:   Output,
 12:   inject
 13: } from '@angular/core';
 14: import { FormsModule } from '@angular/forms';
 15: import { I18nPipe } from '@delon/theme';
 16: import { NzAutocompleteModule } from 'ng-zorro-antd/auto-complete';
 17: import { NzIconModule } from 'ng-zorro-antd/icon';
 18: import { NzInputModule } from 'ng-zorro-antd/input';
 19: import { BehaviorSubject, debounceTime, distinctUntilChanged, tap } from 'rxjs';
 20: 
 21: @Component({
 22:   selector: 'header-search',
 23:   template: `
 24:     <nz-input-group [nzPrefix]="iconTpl" [nzSuffix]="loadingTpl">
 25:       <ng-template #iconTpl>
 26:         <i nz-icon [nzType]="focus ? 'arrow-down' : 'search'"></i>
 27:       </ng-template>
 28:       <ng-template #loadingTpl>
 29:         @if (loading) {
 30:           <i nz-icon nzType="loading"></i>
 31:         }
 32:       </ng-template>
 33:       <input
 34:         type="text"
 35:         nz-input
 36:         [(ngModel)]="q"
 37:         [nzAutocomplete]="auto"
 38:         (input)="search($event)"
 39:         (focus)="qFocus()"
 40:         (blur)="qBlur()"
 41:         hotkey="F1"
 42:         [attr.placeholder]="'menu.search.placeholder' | i18n"
 43:       />
 44:     </nz-input-group>
 45:     <nz-autocomplete nzBackfill #auto>
 46:       @for (i of options; track $index) {
 47:         <nz-auto-option [nzValue]="i">{{ i }}</nz-auto-option>
 48:       }
 49:     </nz-autocomplete>
 50:   `,
 51:   changeDetection: ChangeDetectionStrategy.OnPush,
 52:   imports: [FormsModule, I18nPipe, NzInputModule, NzIconModule, NzAutocompleteModule]
 53: })
 54: export class HeaderSearchComponent implements AfterViewInit, OnDestroy {
 55:   private readonly el = inject<ElementRef<HTMLElement>>(ElementRef).nativeElement;
 56:   private readonly cdr = inject(ChangeDetectorRef);
 57:   q = '';
 58:   qIpt: HTMLInputElement | null = null;
 59:   options: string[] = [];
 60:   search$ = new BehaviorSubject('');
 61:   loading = false;
 62: 
 63:   @HostBinding('class.alain-default__search-focus')
 64:   focus = false;
 65:   @HostBinding('class.alain-default__search-toggled')
 66:   searchToggled = false;
 67: 
 68:   @Input()
 69:   set toggleChange(value: boolean) {
 70:     if (typeof value === 'undefined') {
 71:       return;
 72:     }
 73:     this.searchToggled = value;
 74:     this.focus = value;
 75:     if (value) {
 76:       setTimeout(() => this.qIpt!.focus());
 77:     }
 78:   }
 79:   @Output() readonly toggleChangeChange = new EventEmitter<boolean>();
 80: 
 81:   ngAfterViewInit(): void {
 82:     this.qIpt = this.el.querySelector('.ant-input') as HTMLInputElement;
 83:     this.search$
 84:       .pipe(
 85:         debounceTime(500),
 86:         distinctUntilChanged(),
 87:         tap({
 88:           complete: () => {
 89:             this.loading = true;
 90:           }
 91:         })
 92:       )
 93:       .subscribe(value => {
 94:         this.options = value ? [value, value + value, value + value + value] : [];
 95:         this.loading = false;
 96:         this.cdr.detectChanges();
 97:       });
 98:   }
 99: 
100:   qFocus(): void {
101:     this.focus = true;
102:   }
103: 
104:   qBlur(): void {
105:     this.focus = false;
106:     this.searchToggled = false;
107:     this.options.length = 0;
108:     this.toggleChangeChange.emit(false);
109:   }
110: 
111:   search(ev: Event): void {
112:     this.search$.next((ev.target as HTMLInputElement).value);
113:   }
114: 
115:   ngOnDestroy(): void {
116:     this.search$.complete();
117:     this.search$.unsubscribe();
118:   }
119: }
````

## File: src/app/layout/basic/widgets/task.component.ts
````typescript
 1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, inject } from '@angular/core';
 2: import { NzAvatarModule } from 'ng-zorro-antd/avatar';
 3: import { NzBadgeModule } from 'ng-zorro-antd/badge';
 4: import { NzCardModule } from 'ng-zorro-antd/card';
 5: import { NzDropDownModule } from 'ng-zorro-antd/dropdown';
 6: import { NzGridModule } from 'ng-zorro-antd/grid';
 7: import { NzIconModule } from 'ng-zorro-antd/icon';
 8: import { NzSpinModule } from 'ng-zorro-antd/spin';
 9: 
10: @Component({
11:   selector: 'header-task',
12:   template: `
13:     <div
14:       class="alain-default__nav-item"
15:       nz-dropdown
16:       [nzDropdownMenu]="taskMenu"
17:       nzTrigger="click"
18:       nzPlacement="bottomRight"
19:       (nzVisibleChange)="change()"
20:     >
21:       <nz-badge [nzDot]="true">
22:         <i nz-icon nzType="bell" class="alain-default__nav-item-icon"></i>
23:       </nz-badge>
24:     </div>
25:     <nz-dropdown-menu #taskMenu="nzDropdownMenu">
26:       <div nz-menu class="wd-lg">
27:         @if (loading) {
28:           <div class="mx-lg p-lg"><nz-spin /></div>
29:         } @else {
30:           <nz-card nzTitle="Notifications" nzBordered="false" class="ant-card__body-nopadding">
31:             <ng-template #extra><i nz-icon nzType="plus"></i></ng-template>
32:             <div nz-row [nzJustify]="'center'" [nzAlign]="'middle'" class="py-sm pr-md point bg-grey-lighter-h">
33:               <div nz-col [nzSpan]="4" class="text-center">
34:                 <nz-avatar [nzSrc]="'./assets/tmp/img/1.png'" />
35:               </div>
36:               <div nz-col [nzSpan]="20">
37:                 <strong>cipchk</strong>
38:                 <p class="mb0">Please tell me what happened in a few words, don't go into details.</p>
39:               </div>
40:             </div>
41:             <div nz-row [nzJustify]="'center'" [nzAlign]="'middle'" class="py-sm pr-md point bg-grey-lighter-h">
42:               <div nz-col [nzSpan]="4" class="text-center">
43:                 <nz-avatar [nzSrc]="'./assets/tmp/img/2.png'" />
44:               </div>
45:               <div nz-col [nzSpan]="20">
46:                 <strong>ã¯ãªã•ã</strong>
47:                 <p class="mb0">ãƒãƒ«ã‚«ã‚½ãƒ©ãƒˆã‚­ãƒ˜ãƒ€ãƒ„ãƒ’ã‚«ãƒª</p>
48:               </div>
49:             </div>
50:             <div nz-row [nzJustify]="'center'" [nzAlign]="'middle'" class="py-sm pr-md point bg-grey-lighter-h">
51:               <div nz-col [nzSpan]="4" class="text-center">
52:                 <nz-avatar [nzSrc]="'./assets/tmp/img/3.png'" />
53:               </div>
54:               <div nz-col [nzSpan]="20">
55:                 <strong>è‹å…ˆç”Ÿ</strong>
56:                 <p class="mb0">è¯·å‘Šè¯‰æˆ‘ï¼Œæˆ‘åº”è¯¥è¯´ç‚¹ä»€ä¹ˆå¥½ï¼Ÿ</p>
57:               </div>
58:             </div>
59:             <div nz-row [nzJustify]="'center'" [nzAlign]="'middle'" class="py-sm pr-md point bg-grey-lighter-h">
60:               <div nz-col [nzSpan]="4" class="text-center">
61:                 <nz-avatar [nzSrc]="'./assets/tmp/img/4.png'" />
62:               </div>
63:               <div nz-col [nzSpan]="20">
64:                 <strong>Kent</strong>
65:                 <p class="mb0">Please tell me what happened in a few words, don't go into details.</p>
66:               </div>
67:             </div>
68:             <div nz-row [nzJustify]="'center'" [nzAlign]="'middle'" class="py-sm pr-md point bg-grey-lighter-h">
69:               <div nz-col [nzSpan]="4" class="text-center">
70:                 <nz-avatar [nzSrc]="'./assets/tmp/img/5.png'" />
71:               </div>
72:               <div nz-col [nzSpan]="20">
73:                 <strong>Jefferson</strong>
74:                 <p class="mb0">Please tell me what happened in a few words, don't go into details.</p>
75:               </div>
76:             </div>
77:             <div nz-row>
78:               <div nz-col [nzSpan]="24" class="pt-md border-top-1 text-center text-grey point">See All</div>
79:             </div>
80:           </nz-card>
81:         }
82:       </div>
83:     </nz-dropdown-menu>
84:   `,
85:   changeDetection: ChangeDetectionStrategy.OnPush,
86:   imports: [NzDropDownModule, NzBadgeModule, NzIconModule, NzSpinModule, NzGridModule, NzAvatarModule, NzCardModule]
87: })
88: export class HeaderTaskComponent {
89:   private readonly cdr = inject(ChangeDetectorRef);
90:   loading = true;
91: 
92:   change(): void {
93:     setTimeout(() => {
94:       this.loading = false;
95:       this.cdr.detectChanges();
96:     }, 500);
97:   }
98: }
````

## File: src/app/layout/basic/widgets/user.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component, inject } from '@angular/core';
 2: import { Router, RouterLink } from '@angular/router';
 3: import { DA_SERVICE_TOKEN } from '@delon/auth';
 4: import { I18nPipe, SettingsService, User } from '@delon/theme';
 5: import { NzAvatarModule } from 'ng-zorro-antd/avatar';
 6: import { NzDropDownModule } from 'ng-zorro-antd/dropdown';
 7: import { NzIconModule } from 'ng-zorro-antd/icon';
 8: import { NzMenuModule } from 'ng-zorro-antd/menu';
 9: 
10: @Component({
11:   selector: 'header-user',
12:   template: `
13:     <div class="alain-default__nav-item d-flex align-items-center px-sm" nz-dropdown nzPlacement="bottomRight" [nzDropdownMenu]="userMenu">
14:       <nz-avatar [nzSrc]="user.avatar" nzSize="small" class="mr-sm" />
15:       {{ user.name }}
16:     </div>
17:     <nz-dropdown-menu #userMenu="nzDropdownMenu">
18:       <div nz-menu class="width-sm">
19:         <div nz-menu-item routerLink="/pro/account/center">
20:           <i nz-icon nzType="user" class="mr-sm"></i>
21:           {{ 'menu.account.center' | i18n }}
22:         </div>
23:         <div nz-menu-item routerLink="/pro/account/settings">
24:           <i nz-icon nzType="setting" class="mr-sm"></i>
25:           {{ 'menu.account.settings' | i18n }}
26:         </div>
27:         <div nz-menu-item routerLink="/exception/trigger">
28:           <i nz-icon nzType="close-circle" class="mr-sm"></i>
29:           {{ 'menu.account.trigger' | i18n }}
30:         </div>
31:         <li nz-menu-divider></li>
32:         <div nz-menu-item (click)="logout()">
33:           <i nz-icon nzType="logout" class="mr-sm"></i>
34:           {{ 'menu.account.logout' | i18n }}
35:         </div>
36:       </div>
37:     </nz-dropdown-menu>
38:   `,
39:   changeDetection: ChangeDetectionStrategy.OnPush,
40:   imports: [RouterLink, NzDropDownModule, NzMenuModule, NzIconModule, I18nPipe, NzAvatarModule]
41: })
42: export class HeaderUserComponent {
43:   private readonly settings = inject(SettingsService);
44:   private readonly router = inject(Router);
45:   private readonly tokenService = inject(DA_SERVICE_TOKEN);
46:   get user(): User {
47:     return this.settings.user;
48:   }
49: 
50:   logout(): void {
51:     this.tokenService.clear();
52:     this.router.navigateByUrl(this.tokenService.login_url!);
53:   }
54: }
````

## File: src/app/layout/blank/blank.component.ts
````typescript
 1: import { Component } from '@angular/core';
 2: import { RouterOutlet } from '@angular/router';
 3: 
 4: @Component({
 5:   selector: 'layout-blank',
 6:   template: `<router-outlet />`,
 7:   host: {
 8:     '[class.alain-blank]': 'true'
 9:   },
10:   imports: [RouterOutlet]
11: })
12: export class LayoutBlankComponent {}
````

## File: src/app/layout/index.ts
````typescript
1: export * from './basic/basic.component';
2: export * from './blank/blank.component';
3: export * from './passport/passport.component';
````

## File: src/app/layout/passport/passport.component.ts
````typescript
 1: import { Component, OnInit, inject } from '@angular/core';
 2: import { RouterOutlet } from '@angular/router';
 3: import { GlobalFooterModule } from '@delon/abc/global-footer';
 4: import { DA_SERVICE_TOKEN } from '@delon/auth';
 5: import { ThemeBtnComponent } from '@delon/theme/theme-btn';
 6: import { NzIconModule } from 'ng-zorro-antd/icon';
 7: 
 8: import { HeaderI18nComponent } from '../basic/widgets/i18n.component';
 9: 
10: @Component({
11:   selector: 'layout-passport',
12:   template: `
13:     <div class="container">
14:       <header-i18n showLangText="false" class="langs" />
15:       <div class="wrap">
16:         <div class="top">
17:           <div class="head">
18:             <img class="logo" src="./assets/logo-color.svg" />
19:             <span class="title">NG-ALAIN</span>
20:           </div>
21:           <div class="desc">æ­¦æ—ä¸­æœ€æœ‰å½±å“åŠ›çš„ã€Šè‘µèŠ±å®å…¸ã€‹ï¼›æ¬²ç»ƒç¥åŠŸï¼ŒæŒ¥åˆ€è‡ªå®«</div>
22:         </div>
23:         <router-outlet />
24:         <global-footer [links]="links">
25:           Copyright
26:           <i nz-icon nzType="copyright"></i> 2023 <a href="//github.com/cipchk" target="_blank">å¡è‰²</a>å‡ºå“
27:         </global-footer>
28:       </div>
29:     </div>
30:     <theme-btn />
31:   `,
32:   styleUrls: ['./passport.component.less'],
33:   imports: [RouterOutlet, HeaderI18nComponent, GlobalFooterModule, NzIconModule, ThemeBtnComponent]
34: })
35: export class LayoutPassportComponent implements OnInit {
36:   private tokenService = inject(DA_SERVICE_TOKEN);
37: 
38:   links = [
39:     {
40:       title: 'å¸®åŠ©',
41:       href: ''
42:     },
43:     {
44:       title: 'éšç§',
45:       href: ''
46:     },
47:     {
48:       title: 'æ¡æ¬¾',
49:       href: ''
50:     }
51:   ];
52: 
53:   ngOnInit(): void {
54:     this.tokenService.clear();
55:   }
56: }
````

## File: src/app/routes/accounts/bots/bot-list.component.ts
````typescript
  1: import { Component, OnInit, inject } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { AppError } from '@core';
  4: import { STColumn } from '@delon/abc/st';
  5: import { Account, AccountService, SHARED_IMPORTS } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: 
  8: @Component({
  9:   selector: 'app-bot-list',
 10:   standalone: true,
 11:   imports: [SHARED_IMPORTS],
 12:   template: `
 13:     <page-header [title]="'æœºå™¨äººç®¡ç†'">
 14:       <ng-template #extra>
 15:         <button nz-button nzType="primary" (click)="createBot()">
 16:           <span nz-icon nzType="plus"></span>
 17:           æ–°å»ºæœºå™¨äºº
 18:         </button>
 19:       </ng-template>
 20:     </page-header>
 21: 
 22:     <nz-card nzTitle="ç®¡ç†ç³»ç»Ÿä¸­çš„æ‰€æœ‰æœºå™¨äººè´¦æˆ·" style="margin-top: 16px;">
 23:       <st
 24:         #st
 25:         [data]="bots()"
 26:         [columns]="columns"
 27:         [loading]="loading()"
 28:         [page]="{ front: false, show: true, showSize: true }"
 29:         (change)="onTableChange($event)"
 30:       >
 31:         <ng-template #status let-record>
 32:           @switch (record.status) {
 33:             @case ('active') {
 34:               <nz-tag nzColor="success">æ´»è·ƒ</nz-tag>
 35:             }
 36:             @case ('inactive') {
 37:               <nz-tag nzColor="default">éæ´»è·ƒ</nz-tag>
 38:             }
 39:             @case ('suspended') {
 40:               <nz-tag nzColor="error">å·²æš‚åœ</nz-tag>
 41:             }
 42:           }
 43:         </ng-template>
 44:       </st>
 45:     </nz-card>
 46:   `
 47: })
 48: export class BotListComponent implements OnInit {
 49:   accountService = inject(AccountService);
 50:   router = inject(Router);
 51:   message = inject(NzMessageService);
 52: 
 53:   bots = this.accountService.botAccounts;
 54:   loading = this.accountService.loading;
 55: 
 56:   columns: STColumn[] = [
 57:     { title: 'ID', index: 'id', width: 100 },
 58:     { title: 'æœºå™¨äººåç§°', index: 'name', width: 200 },
 59:     { title: 'é‚®ç®±', index: 'email', width: 200 },
 60:     { title: 'çŠ¶æ€', index: 'status', width: 100, render: 'status' },
 61:     { title: 'åˆ›å»ºæ—¶é—´', index: 'created_at', type: 'date', width: 180 },
 62:     {
 63:       title: 'æ“ä½œ',
 64:       width: 250,
 65:       buttons: [
 66:         {
 67:           text: 'æŸ¥çœ‹',
 68:           click: (record: Account) => this.viewDetail(record.id)
 69:         },
 70:         {
 71:           text: 'ç¼–è¾‘',
 72:           click: (record: Account) => this.edit(record.id)
 73:         },
 74:         {
 75:           text: 'é…ç½®',
 76:           click: (record: Account) => this.configure(record.id)
 77:         },
 78:         {
 79:           text: 'åˆ é™¤',
 80:           type: 'del',
 81:           pop: true,
 82:           click: (record: Account) => this.delete(record.id)
 83:         }
 84:       ]
 85:     }
 86:   ];
 87: 
 88:   ngOnInit(): void {
 89:     this.loadBots();
 90:   }
 91: 
 92:   async loadBots(): Promise<void> {
 93:     try {
 94:       await this.accountService.loadAccounts();
 95:       // botAccounts computed signal ä¼šè‡ªåŠ¨è¿‡æ»¤å‡ºæœºå™¨äººç±»å‹çš„è´¦æˆ·
 96:     } catch (error) {
 97:       // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
 98:       let errorMessage = 'åŠ è½½æœºå™¨äººåˆ—è¡¨å¤±è´¥';
 99: 
100:       if (error instanceof Error) {
101:         const appError = error as AppError;
102:         if (appError.type && appError.severity) {
103:           errorMessage = appError.message || errorMessage;
104:           if (appError.details) {
105:             errorMessage += `: ${appError.details}`;
106:           }
107:         } else {
108:           errorMessage = error.message || errorMessage;
109:         }
110:       }
111: 
112:       console.error('åŠ è½½æœºå™¨äººåˆ—è¡¨å¤±è´¥:', error);
113:       this.message.error(errorMessage, { nzDuration: 5000 });
114:     }
115:   }
116: 
117:   onTableChange(event: any): void {
118:     // å¤„ç†è¡¨æ ¼å˜åŒ–äº‹ä»¶ï¼ˆåˆ†é¡µã€æ’åºç­‰ï¼‰
119:   }
120: 
121:   createBot(): void {
122:     this.router.navigate(['/accounts/create/bot']);
123:   }
124: 
125:   viewDetail(id: string): void {
126:     this.router.navigate(['/accounts', id]);
127:   }
128: 
129:   edit(id: string): void {
130:     this.router.navigate(['/accounts', id, 'edit']);
131:   }
132: 
133:   configure(id: string): void {
134:     // å¯¼èˆªåˆ°æœºå™¨äººè¯¦æƒ…é¡µé¢ï¼ˆå¯ä»¥åœ¨è¯¦æƒ…é¡µé¢ä¸­é…ç½®ï¼‰
135:     this.router.navigate(['/accounts', id]);
136:   }
137: 
138:   async delete(id: string): Promise<void> {
139:     try {
140:       await this.accountService.deleteAccount(id);
141:       this.message.success('åˆ é™¤æˆåŠŸ');
142:       await this.loadBots();
143:     } catch (error) {
144:       // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
145:       let errorMessage = 'åˆ é™¤å¤±è´¥';
146: 
147:       if (error instanceof Error) {
148:         const appError = error as AppError;
149:         if (appError.type && appError.severity) {
150:           errorMessage = appError.message || errorMessage;
151:           if (appError.details) {
152:             errorMessage += `: ${appError.details}`;
153:           }
154:         } else {
155:           errorMessage = error.message || errorMessage;
156:         }
157:       }
158: 
159:       console.error('åˆ é™¤å¤±è´¥:', error);
160:       this.message.error(errorMessage, { nzDuration: 5000 });
161:     }
162:   }
163: }
````

## File: src/app/routes/accounts/create/create-bot.component.ts
````typescript
  1: import { Component, inject, OnInit } from '@angular/core';
  2: import { FormControl, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
  3: import { Router } from '@angular/router';
  4: import { AppError } from '@core';
  5: import { AccountService, AccountStatus, SHARED_IMPORTS } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: 
  8: /**
  9:  * Bot è´¦æˆ·åˆ›å»ºè¡¨å•ç±»å‹å®šä¹‰
 10:  */
 11: interface BotFormValue {
 12:   name: string;
 13: }
 14: 
 15: @Component({
 16:   selector: 'app-create-bot',
 17:   standalone: true,
 18:   imports: [SHARED_IMPORTS, ReactiveFormsModule],
 19:   template: `
 20:     <page-header [title]="'åˆ›å»ºæœºå™¨äººè´¦æˆ·'">
 21:       <ng-template #extra>
 22:         <button nz-button nzType="default" (click)="goBack()" style="margin-right: 8px;">
 23:           <span nz-icon nzType="arrow-left"></span>
 24:           è¿”å›
 25:         </button>
 26:       </ng-template>
 27:     </page-header>
 28: 
 29:     <div style="padding: 16px;">
 30:       @if (accountService.loading()) {
 31:         <nz-spin nzSimple [nzSize]="'large'" style="display: block; padding: 50px; text-align: center;">
 32:           <ng-template #indicator>
 33:             <span nz-icon nzType="loading" style="font-size: 24px;"></span>
 34:           </ng-template>
 35:         </nz-spin>
 36:       } @else {
 37:         <nz-card nzTitle="åˆ›å»ºæ–°æœºå™¨äººè´¦æˆ·">
 38:           <form nz-form [formGroup]="form" (ngSubmit)="onSubmit()">
 39:             <nz-form-item>
 40:               <nz-form-label [nzSpan]="4" nzRequired>æœºå™¨äººåç§°</nz-form-label>
 41:               <nz-form-control [nzSpan]="20" [nzErrorTip]="'è¯·è¾“å…¥æœºå™¨äººåç§°'">
 42:                 <input nz-input formControlName="name" placeholder="è¯·è¾“å…¥æœºå™¨äººåç§°" />
 43:               </nz-form-control>
 44:             </nz-form-item>
 45: 
 46:             <nz-form-item>
 47:               <nz-form-control [nzSpan]="24" [nzOffset]="4">
 48:                 <button nz-button nzType="primary" [nzLoading]="accountService.loading()" [disabled]="form.invalid">
 49:                   <span nz-icon nzType="save"></span>
 50:                   åˆ›å»ºæœºå™¨äºº
 51:                 </button>
 52:                 <button nz-button nzType="default" type="button" (click)="goBack()" style="margin-left: 8px;"> å–æ¶ˆ </button>
 53:               </nz-form-control>
 54:             </nz-form-item>
 55:           </form>
 56:         </nz-card>
 57:       }
 58:     </div>
 59:   `
 60: })
 61: export class CreateBotComponent implements OnInit {
 62:   accountService = inject(AccountService);
 63:   router = inject(Router);
 64:   message = inject(NzMessageService);
 65: 
 66:   // è¡¨å•å®šä¹‰
 67:   form = new FormGroup<{
 68:     name: FormControl<string>;
 69:   }>({
 70:     name: new FormControl('', { nonNullable: true, validators: [Validators.required] })
 71:   });
 72: 
 73:   ngOnInit(): void {
 74:     // åˆ›å»º Bot è´¦æˆ·æ—¶çš„åˆå§‹åŒ–é€»è¾‘
 75:   }
 76: 
 77:   async onSubmit(): Promise<void> {
 78:     if (this.form.invalid) {
 79:       // æ ‡è®°æ‰€æœ‰å­—æ®µä¸º touchedï¼Œæ˜¾ç¤ºéªŒè¯é”™è¯¯
 80:       Object.values(this.form.controls).forEach(control => {
 81:         if (control.invalid) {
 82:           control.markAsTouched();
 83:           control.updateValueAndValidity({ onlySelf: true });
 84:         }
 85:       });
 86:       return;
 87:     }
 88: 
 89:     const formValue = this.form.value as BotFormValue;
 90: 
 91:     try {
 92:       // ä½¿ç”¨ SECURITY DEFINER å‡½æ•°åˆ›å»º Bot è´¦æˆ·ï¼Œç»•è¿‡ RLS é™åˆ¶
 93:       const account = await this.accountService.createBotAccount(formValue.name, null, AccountStatus.ACTIVE);
 94:       this.message.success('åˆ›å»ºæœºå™¨äººè´¦æˆ·æˆåŠŸ');
 95:       this.router.navigate(['/accounts', account.id]);
 96:     } catch (error) {
 97:       // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
 98:       let errorMessage = 'åˆ›å»ºæœºå™¨äººè´¦æˆ·å¤±è´¥';
 99: 
100:       if (error instanceof Error) {
101:         const appError = error as AppError;
102:         if (appError.type && appError.severity) {
103:           errorMessage = appError.message || errorMessage;
104: 
105:           if (appError.code) {
106:             errorMessage += ` (é”™è¯¯ä»£ç : ${appError.code})`;
107:           }
108: 
109:           if (appError.details) {
110:             errorMessage += `: ${appError.details}`;
111:           }
112: 
113:           if (appError.metadata && appError.metadata['hint']) {
114:             errorMessage += `\næç¤º: ${appError.metadata['hint']}`;
115:           }
116:         } else {
117:           errorMessage = error.message || errorMessage;
118:         }
119:       }
120: 
121:       console.error('åˆ›å»ºæœºå™¨äººè´¦æˆ·å¤±è´¥:', error);
122:       this.message.error(errorMessage, { nzDuration: 5000 });
123:     }
124:   }
125: 
126:   goBack(): void {
127:     this.router.navigate(['/accounts/bots']);
128:   }
129: }
````

## File: src/app/routes/accounts/create/create-organization.component.ts
````typescript
  1: import { Component, inject, OnInit } from '@angular/core';
  2: import { FormControl, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
  3: import { Router } from '@angular/router';
  4: import { AppError } from '@core';
  5: import { AccountService, AccountStatus, SHARED_IMPORTS } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: 
  8: /**
  9:  * Organization è´¦æˆ·åˆ›å»ºè¡¨å•ç±»å‹å®šä¹‰
 10:  */
 11: interface OrganizationFormValue {
 12:   name: string;
 13: }
 14: 
 15: @Component({
 16:   selector: 'app-create-organization',
 17:   standalone: true,
 18:   imports: [SHARED_IMPORTS, ReactiveFormsModule],
 19:   template: `
 20:     <page-header [title]="'åˆ›å»ºç»„ç»‡è´¦æˆ·'">
 21:       <ng-template #extra>
 22:         <button nz-button nzType="default" (click)="goBack()" style="margin-right: 8px;">
 23:           <span nz-icon nzType="arrow-left"></span>
 24:           è¿”å›
 25:         </button>
 26:       </ng-template>
 27:     </page-header>
 28: 
 29:     <div style="padding: 16px;">
 30:       @if (accountService.loading()) {
 31:         <nz-spin nzSimple [nzSize]="'large'" style="display: block; padding: 50px; text-align: center;">
 32:           <ng-template #indicator>
 33:             <span nz-icon nzType="loading" style="font-size: 24px;"></span>
 34:           </ng-template>
 35:         </nz-spin>
 36:       } @else {
 37:         <nz-card nzTitle="åˆ›å»ºæ–°ç»„ç»‡è´¦æˆ·">
 38:           <form nz-form [formGroup]="form" (ngSubmit)="onSubmit()">
 39:             <nz-form-item>
 40:               <nz-form-label [nzSpan]="4" nzRequired>ç»„ç»‡åç§°</nz-form-label>
 41:               <nz-form-control [nzSpan]="20" [nzErrorTip]="'è¯·è¾“å…¥ç»„ç»‡åç§°'">
 42:                 <input nz-input formControlName="name" placeholder="è¯·è¾“å…¥ç»„ç»‡åç§°" />
 43:               </nz-form-control>
 44:             </nz-form-item>
 45: 
 46:             <nz-form-item>
 47:               <nz-form-control [nzSpan]="24" [nzOffset]="4">
 48:                 <button nz-button nzType="primary" [nzLoading]="accountService.loading()" [disabled]="form.invalid">
 49:                   <span nz-icon nzType="save"></span>
 50:                   åˆ›å»ºç»„ç»‡
 51:                 </button>
 52:                 <button nz-button nzType="default" type="button" (click)="goBack()" style="margin-left: 8px;"> å–æ¶ˆ </button>
 53:               </nz-form-control>
 54:             </nz-form-item>
 55:           </form>
 56:         </nz-card>
 57:       }
 58:     </div>
 59:   `
 60: })
 61: export class CreateOrganizationComponent implements OnInit {
 62:   accountService = inject(AccountService);
 63:   router = inject(Router);
 64:   message = inject(NzMessageService);
 65: 
 66:   // è¡¨å•å®šä¹‰
 67:   form = new FormGroup<{
 68:     name: FormControl<string>;
 69:   }>({
 70:     name: new FormControl('', { nonNullable: true, validators: [Validators.required] })
 71:   });
 72: 
 73:   ngOnInit(): void {
 74:     // åˆ›å»ºç»„ç»‡è´¦æˆ·æ—¶çš„åˆå§‹åŒ–é€»è¾‘
 75:   }
 76: 
 77:   async onSubmit(): Promise<void> {
 78:     if (this.form.invalid) {
 79:       // æ ‡è®°æ‰€æœ‰å­—æ®µä¸º touchedï¼Œæ˜¾ç¤ºéªŒè¯é”™è¯¯
 80:       Object.values(this.form.controls).forEach(control => {
 81:         if (control.invalid) {
 82:           control.markAsTouched();
 83:           control.updateValueAndValidity({ onlySelf: true });
 84:         }
 85:       });
 86:       return;
 87:     }
 88: 
 89:     const formValue = this.form.value as OrganizationFormValue;
 90: 
 91:     try {
 92:       // ä½¿ç”¨ SECURITY DEFINER å‡½æ•°åˆ›å»º Organization è´¦æˆ·ï¼Œç»•è¿‡ RLS é™åˆ¶
 93:       // è¿™æ ·å¯ä»¥ç¡®ä¿å³ä½¿ä¸ä½¿ç”¨è§¦å‘å™¨ï¼Œä¹Ÿèƒ½æˆåŠŸåˆ›å»ºç»„ç»‡è´¦æˆ·
 94:       const account = await this.accountService.createOrganizationAccount(formValue.name, null, AccountStatus.ACTIVE);
 95:       this.message.success('åˆ›å»ºç»„ç»‡è´¦æˆ·æˆåŠŸ');
 96:       this.router.navigate(['/accounts', account.id]);
 97:     } catch (error) {
 98:       // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
 99:       let errorMessage = 'åˆ›å»ºç»„ç»‡è´¦æˆ·å¤±è´¥';
100: 
101:       if (error instanceof Error) {
102:         const appError = error as AppError;
103:         if (appError.type && appError.severity) {
104:           errorMessage = appError.message || errorMessage;
105: 
106:           if (appError.code) {
107:             errorMessage += ` (é”™è¯¯ä»£ç : ${appError.code})`;
108:           }
109: 
110:           if (appError.details) {
111:             errorMessage += `: ${appError.details}`;
112:           }
113: 
114:           if (appError.metadata && appError.metadata['hint']) {
115:             errorMessage += `\næç¤º: ${appError.metadata['hint']}`;
116:           }
117:         } else {
118:           errorMessage = error.message || errorMessage;
119:         }
120:       }
121: 
122:       console.error('åˆ›å»ºç»„ç»‡è´¦æˆ·å¤±è´¥:', error);
123:       this.message.error(errorMessage, { nzDuration: 5000 });
124:     }
125:   }
126: 
127:   goBack(): void {
128:     this.router.navigate(['/accounts/organizations']);
129:   }
130: }
````

## File: src/app/routes/accounts/form/account-form.component.ts
````typescript
  1: import { Component, computed, inject, OnInit } from '@angular/core';
  2: import { FormControl, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
  3: import { ActivatedRoute, Router } from '@angular/router';
  4: import { AppError, isValidUUID } from '@core';
  5: import { AccountService, AccountStatus, AccountType, AccountUpdate, SHARED_IMPORTS } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: 
  8: /**
  9:  * è´¦æˆ·è¡¨å•ç±»å‹å®šä¹‰
 10:  */
 11: interface AccountFormValue {
 12:   name: string;
 13:   email: string | null;
 14:   type: AccountType;
 15:   status?: AccountStatus;
 16: }
 17: 
 18: @Component({
 19:   selector: 'app-account-form',
 20:   standalone: true,
 21:   imports: [SHARED_IMPORTS, ReactiveFormsModule],
 22:   template: `
 23:     <page-header [title]="'ç¼–è¾‘è´¦æˆ·'">
 24:       <ng-template #extra>
 25:         <button nz-button nzType="default" (click)="goBack()" style="margin-right: 8px;">
 26:           <span nz-icon nzType="arrow-left"></span>
 27:           è¿”å›
 28:         </button>
 29:       </ng-template>
 30:     </page-header>
 31: 
 32:     <div style="padding: 16px;">
 33:       @if (accountService.loading()) {
 34:         <nz-spin nzSimple [nzSize]="'large'" style="display: block; padding: 50px; text-align: center;">
 35:           <ng-template #indicator>
 36:             <span nz-icon nzType="loading" style="font-size: 24px;"></span>
 37:           </ng-template>
 38:         </nz-spin>
 39:       } @else {
 40:         <nz-card nzTitle="ç¼–è¾‘è´¦æˆ·ä¿¡æ¯">
 41:           <form nz-form [formGroup]="form" (ngSubmit)="onSubmit()">
 42:             <nz-form-item>
 43:               <nz-form-label [nzSpan]="4" nzRequired>è´¦æˆ·åç§°</nz-form-label>
 44:               <nz-form-control [nzSpan]="20" [nzErrorTip]="'è¯·è¾“å…¥è´¦æˆ·åç§°'">
 45:                 <input nz-input formControlName="name" placeholder="è¯·è¾“å…¥è´¦æˆ·åç§°" />
 46:               </nz-form-control>
 47:             </nz-form-item>
 48: 
 49:             <nz-form-item>
 50:               <nz-form-label [nzSpan]="4" [nzRequired]="form.get('type')?.value === AccountType.USER">é‚®ç®±</nz-form-label>
 51:               <nz-form-control [nzSpan]="20" [nzErrorTip]="getEmailErrorTip()">
 52:                 <input
 53:                   nz-input
 54:                   formControlName="email"
 55:                   type="email"
 56:                   [placeholder]="form.get('type')?.value === AccountType.USER ? 'è¯·è¾“å…¥é‚®ç®±åœ°å€' : 'è¯·è¾“å…¥é‚®ç®±åœ°å€ï¼ˆå¯é€‰ï¼‰'"
 57:                 />
 58:               </nz-form-control>
 59:             </nz-form-item>
 60: 
 61:             <nz-form-item>
 62:               <nz-form-label [nzSpan]="4" nzRequired>è´¦æˆ·ç±»å‹</nz-form-label>
 63:               <nz-form-control [nzSpan]="20" [nzErrorTip]="'è¯·é€‰æ‹©è´¦æˆ·ç±»å‹'">
 64:                 <nz-select formControlName="type" nzPlaceHolder="è¯·é€‰æ‹©è´¦æˆ·ç±»å‹" [nzDisabled]="true">
 65:                   <nz-option [nzValue]="AccountType.USER" nzLabel="ç”¨æˆ·"></nz-option>
 66:                   <nz-option [nzValue]="AccountType.BOT" nzLabel="æœºå™¨äºº"></nz-option>
 67:                   <nz-option [nzValue]="AccountType.ORGANIZATION" nzLabel="ç»„ç»‡"></nz-option>
 68:                 </nz-select>
 69:               </nz-form-control>
 70:             </nz-form-item>
 71: 
 72:             <nz-form-item>
 73:               <nz-form-label [nzSpan]="4">çŠ¶æ€</nz-form-label>
 74:               <nz-form-control [nzSpan]="20">
 75:                 <nz-select formControlName="status" nzPlaceHolder="è¯·é€‰æ‹©çŠ¶æ€">
 76:                   <nz-option [nzValue]="AccountStatus.ACTIVE" nzLabel="æ´»è·ƒ"></nz-option>
 77:                   <nz-option [nzValue]="AccountStatus.INACTIVE" nzLabel="éæ´»è·ƒ"></nz-option>
 78:                   <nz-option [nzValue]="AccountStatus.SUSPENDED" nzLabel="å·²æš‚åœ"></nz-option>
 79:                 </nz-select>
 80:               </nz-form-control>
 81:             </nz-form-item>
 82: 
 83:             <nz-form-item>
 84:               <nz-form-control [nzSpan]="24" [nzOffset]="4">
 85:                 <button nz-button nzType="primary" [nzLoading]="accountService.loading()" [disabled]="form.invalid">
 86:                   <span nz-icon nzType="save"></span>
 87:                   ä¿å­˜
 88:                 </button>
 89:                 <button nz-button nzType="default" type="button" (click)="goBack()" style="margin-left: 8px;"> å–æ¶ˆ </button>
 90:               </nz-form-control>
 91:             </nz-form-item>
 92:           </form>
 93:         </nz-card>
 94:       }
 95:     </div>
 96:   `
 97: })
 98: export class AccountFormComponent implements OnInit {
 99:   accountService = inject(AccountService);
100:   route = inject(ActivatedRoute);
101:   router = inject(Router);
102:   message = inject(NzMessageService);
103: 
104:   // å¯¼å‡ºæšä¸¾ä¾›æ¨¡æ¿ä½¿ç”¨
105:   AccountType = AccountType;
106:   AccountStatus = AccountStatus;
107: 
108:   // åˆ¤æ–­æ˜¯å¦ä¸ºç¼–è¾‘æ¨¡å¼
109:   // æ³¨æ„ï¼šåˆ›å»ºåŠŸèƒ½å·²è¿ç§»åˆ° create/ æ–‡ä»¶å¤¹ï¼Œæ­¤ç»„ä»¶ä»…ç”¨äºç¼–è¾‘
110:   // å¦‚æœè·¯ç”±ä¸­æ²¡æœ‰ id å‚æ•°ï¼Œè¯´æ˜è·¯ç”±é…ç½®é”™è¯¯
111:   isEditMode = computed(() => {
112:     const id = this.route.snapshot.paramMap.get('id');
113:     return !!id;
114:   });
115: 
116:   // è¡¨å•å®šä¹‰
117:   form = new FormGroup<{
118:     name: FormControl<string>;
119:     email: FormControl<string | null>;
120:     type: FormControl<AccountType>;
121:     status?: FormControl<AccountStatus>;
122:   }>({
123:     name: new FormControl('', { nonNullable: true, validators: [Validators.required] }),
124:     email: new FormControl(null, { validators: [Validators.required, Validators.email] }),
125:     type: new FormControl(AccountType.USER, { nonNullable: true, validators: [Validators.required] }),
126:     status: new FormControl(AccountStatus.ACTIVE, { nonNullable: true })
127:   });
128: 
129:   ngOnInit(): void {
130:     // æ­¤ç»„ä»¶ä»…ç”¨äºç¼–è¾‘ï¼Œå¿…é¡»è¦æœ‰ id å‚æ•°
131:     const accountId = this.route.snapshot.paramMap.get('id');
132:     if (!accountId) {
133:       console.warn('AccountFormComponent: Missing account ID. Redirecting to account list.');
134:       this.goBack();
135:       return;
136:     }
137: 
138:     // éªŒè¯ id æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ UUID æ ¼å¼ï¼Œé¿å…å°†é UUID å­—ç¬¦ä¸²ä¼ é€’ç»™æ•°æ®åº“æŸ¥è¯¢
139:     if (!isValidUUID(accountId)) {
140:       console.warn(`Invalid account ID format: ${accountId}. Redirecting to account list.`);
141:       this.goBack();
142:       return;
143:     }
144: 
145:     this.loadAccount(accountId);
146:   }
147: 
148:   async loadAccount(id: string): Promise<void> {
149:     try {
150:       const account = await this.accountService.loadAccountById(id);
151:       if (account) {
152:         const accountType = account.type as AccountType;
153:         this.form.patchValue({
154:           name: account.name,
155:           email: account.email,
156:           type: accountType,
157:           status: account.status as AccountStatus
158:         });
159: 
160:         // æ ¹æ®è´¦æˆ·ç±»å‹åŠ¨æ€è®¾ç½®é‚®ç®±éªŒè¯è§„åˆ™
161:         this.updateEmailValidation(accountType);
162:       } else {
163:         this.message.warning('è´¦æˆ·ä¸å­˜åœ¨');
164:         this.goBack();
165:       }
166:     } catch (error) {
167:       // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
168:       let errorMessage = 'åŠ è½½è´¦æˆ·ä¿¡æ¯å¤±è´¥';
169: 
170:       if (error instanceof Error) {
171:         // æ£€æŸ¥æ˜¯å¦æ˜¯ AppError ç±»å‹
172:         const appError = error as AppError;
173:         if (appError.type && appError.severity) {
174:           errorMessage = appError.message || errorMessage;
175:           if (appError.details) {
176:             errorMessage += `: ${appError.details}`;
177:           }
178:         } else {
179:           errorMessage = error.message || errorMessage;
180:         }
181:       }
182: 
183:       console.error('åŠ è½½è´¦æˆ·ä¿¡æ¯å¤±è´¥:', error);
184:       this.message.error(errorMessage, { nzDuration: 5000 });
185:     }
186:   }
187: 
188:   async onSubmit(): Promise<void> {
189:     if (this.form.invalid) {
190:       // æ ‡è®°æ‰€æœ‰å­—æ®µä¸º touchedï¼Œæ˜¾ç¤ºéªŒè¯é”™è¯¯
191:       Object.values(this.form.controls).forEach(control => {
192:         if (control.invalid) {
193:           control.markAsTouched();
194:           control.updateValueAndValidity({ onlySelf: true });
195:         }
196:       });
197:       return;
198:     }
199: 
200:     const formValue = this.form.value as AccountFormValue;
201: 
202:     try {
203:       // æ­¤ç»„ä»¶ä»…ç”¨äºç¼–è¾‘ï¼Œå¿…é¡»è¦æœ‰ id å‚æ•°
204:       const accountId = this.route.snapshot.paramMap.get('id');
205:       if (!accountId) {
206:         this.message.error('ç¼ºå°‘è´¦æˆ· IDï¼Œæ— æ³•æ›´æ–°');
207:         this.goBack();
208:         return;
209:       }
210: 
211:       const updateData: AccountUpdate = {
212:         name: formValue.name,
213:         email: formValue.email || undefined,
214:         type: formValue.type,
215:         status: formValue.status
216:       };
217: 
218:       await this.accountService.updateAccount(accountId, updateData);
219:       this.message.success('æ›´æ–°æˆåŠŸ');
220:       this.router.navigate(['/accounts', accountId]);
221:     } catch (error) {
222:       // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
223:       let errorMessage = 'æ›´æ–°å¤±è´¥';
224: 
225:       if (error instanceof Error) {
226:         // æ£€æŸ¥æ˜¯å¦æ˜¯ AppError ç±»å‹
227:         const appError = error as AppError;
228:         if (appError.type && appError.severity) {
229:           // ä½¿ç”¨ AppError çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
230:           errorMessage = appError.message || errorMessage;
231: 
232:           // å¦‚æœæœ‰é”™è¯¯ä»£ç ï¼Œæ·»åŠ åˆ°æ¶ˆæ¯ä¸­
233:           if (appError.code) {
234:             errorMessage += ` (é”™è¯¯ä»£ç : ${appError.code})`;
235:           }
236: 
237:           // å¦‚æœæœ‰è¯¦ç»†ä¿¡æ¯ï¼Œæ·»åŠ åˆ°æ¶ˆæ¯ä¸­
238:           if (appError.details) {
239:             errorMessage += `: ${appError.details}`;
240:           }
241: 
242:           // å¦‚æœæœ‰æç¤ºä¿¡æ¯ï¼Œæ·»åŠ åˆ°æ¶ˆæ¯ä¸­
243:           if (appError.metadata && appError.metadata['hint']) {
244:             errorMessage += `\næç¤º: ${appError.metadata['hint']}`;
245:           }
246:         } else {
247:           // æ™®é€š Errorï¼Œä½¿ç”¨é”™è¯¯æ¶ˆæ¯
248:           errorMessage = error.message || errorMessage;
249:         }
250:       }
251: 
252:       // åœ¨æ§åˆ¶å°è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•
253:       console.error('è´¦æˆ·æ“ä½œå¤±è´¥:', error);
254: 
255:       // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼ˆä½¿ç”¨ NzMessageService çš„ duration å‚æ•°ç¡®ä¿æ¶ˆæ¯æ˜¾ç¤ºè¶³å¤Ÿé•¿æ—¶é—´ï¼‰
256:       this.message.error(errorMessage, { nzDuration: 5000 });
257:     }
258:   }
259: 
260:   /**
261:    * æ ¹æ®è´¦æˆ·ç±»å‹æ›´æ–°é‚®ç®±éªŒè¯è§„åˆ™
262:    * - User è´¦æˆ·ï¼šé‚®ç®±å¿…å¡«
263:    * - Organization å’Œ Bot è´¦æˆ·ï¼šé‚®ç®±å¯é€‰
264:    */
265:   private updateEmailValidation(accountType: AccountType): void {
266:     const emailControl = this.form.get('email');
267:     if (!emailControl) return;
268: 
269:     if (accountType === AccountType.USER) {
270:       // User è´¦æˆ·ï¼šé‚®ç®±å¿…å¡«
271:       emailControl.setValidators([Validators.required, Validators.email]);
272:     } else {
273:       // Organization å’Œ Bot è´¦æˆ·ï¼šé‚®ç®±å¯é€‰
274:       emailControl.setValidators([Validators.email]);
275:     }
276:     emailControl.updateValueAndValidity();
277:   }
278: 
279:   /**
280:    * è·å–é‚®ç®±é”™è¯¯æç¤ºä¿¡æ¯
281:    */
282:   getEmailErrorTip(): string | undefined {
283:     const emailControl = this.form.get('email');
284:     const accountType = this.form.get('type')?.value;
285:     if (!emailControl || !emailControl.errors) return undefined;
286: 
287:     if (accountType === AccountType.USER) {
288:       // User è´¦æˆ·ï¼šæ˜¾ç¤ºå¿…å¡«æˆ–æ ¼å¼é”™è¯¯
289:       if (emailControl.hasError('required')) {
290:         return 'è¯·è¾“å…¥é‚®ç®±';
291:       }
292:       if (emailControl.hasError('email')) {
293:         return 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€';
294:       }
295:     } else {
296:       // Organization å’Œ Bot è´¦æˆ·ï¼šåªæ˜¾ç¤ºæ ¼å¼é”™è¯¯
297:       if (emailControl.hasError('email')) {
298:         return 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€';
299:       }
300:     }
301:     return undefined;
302:   }
303: 
304:   goBack(): void {
305:     // æ­¤ç»„ä»¶ä»…ç”¨äºç¼–è¾‘ï¼Œè¿”å›è´¦æˆ·è¯¦æƒ…é¡µé¢
306:     const accountId = this.route.snapshot.paramMap.get('id');
307:     if (accountId) {
308:       this.router.navigate(['/accounts', accountId]);
309:     } else {
310:       this.router.navigate(['/accounts']);
311:     }
312:   }
313: }
````

## File: src/app/routes/accounts/list/account-list.component.ts
````typescript
  1: import { Component, OnInit, inject, signal } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { STColumn, STData } from '@delon/abc/st';
  4: import { SHARED_IMPORTS, AccountService, Account, AccountType, AccountStatus } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: 
  7: @Component({
  8:   selector: 'app-account-list',
  9:   standalone: true,
 10:   imports: [SHARED_IMPORTS],
 11:   template: `
 12:     <page-header [title]="'è´¦æˆ·ç®¡ç†'">
 13:       <ng-template #extra>
 14:         <button nz-button nzType="primary" (click)="createAccount()">
 15:           <span nz-icon nzType="plus"></span>
 16:           æ–°å»ºè´¦æˆ·
 17:         </button>
 18:       </ng-template>
 19:     </page-header>
 20: 
 21:     <nz-card nzTitle="ç®¡ç†ç³»ç»Ÿä¸­çš„æ‰€æœ‰è´¦æˆ·" style="margin-top: 16px;">
 22:       <st
 23:         #st
 24:         [data]="accountService.accounts()"
 25:         [columns]="columns"
 26:         [loading]="accountService.loading()"
 27:         [page]="{ front: false, show: true, showSize: true }"
 28:         (change)="onTableChange($event)"
 29:       >
 30:         <ng-template #type let-record>
 31:           @switch (record.type) {
 32:             @case ('User') {
 33:               <nz-tag nzColor="blue">ç”¨æˆ·</nz-tag>
 34:             }
 35:             @case ('Bot') {
 36:               <nz-tag nzColor="purple">æœºå™¨äºº</nz-tag>
 37:             }
 38:             @case ('Organization') {
 39:               <nz-tag nzColor="green">ç»„ç»‡</nz-tag>
 40:             }
 41:           }
 42:         </ng-template>
 43: 
 44:         <ng-template #status let-record>
 45:           @switch (record.status) {
 46:             @case ('active') {
 47:               <nz-tag nzColor="success">æ´»è·ƒ</nz-tag>
 48:             }
 49:             @case ('inactive') {
 50:               <nz-tag nzColor="default">éæ´»è·ƒ</nz-tag>
 51:             }
 52:             @case ('suspended') {
 53:               <nz-tag nzColor="error">å·²æš‚åœ</nz-tag>
 54:             }
 55:           }
 56:         </ng-template>
 57:       </st>
 58:     </nz-card>
 59:   `
 60: })
 61: export class AccountListComponent implements OnInit {
 62:   accountService = inject(AccountService);
 63:   router = inject(Router);
 64:   message = inject(NzMessageService);
 65: 
 66:   columns: STColumn[] = [
 67:     { title: 'ID', index: 'id', width: 100 },
 68:     { title: 'åç§°', index: 'name', width: 200 },
 69:     { title: 'ç±»å‹', index: 'type', width: 100, render: 'type' },
 70:     { title: 'é‚®ç®±', index: 'email', width: 200 },
 71:     { title: 'çŠ¶æ€', index: 'status', width: 100, render: 'status' },
 72:     { title: 'åˆ›å»ºæ—¶é—´', index: 'created_at', type: 'date', width: 180 },
 73:     {
 74:       title: 'æ“ä½œ',
 75:       width: 200,
 76:       buttons: [
 77:         {
 78:           text: 'æŸ¥çœ‹',
 79:           click: (record: Account) => this.viewDetail(record.id)
 80:         },
 81:         {
 82:           text: 'ç¼–è¾‘',
 83:           click: (record: Account) => this.edit(record.id)
 84:         },
 85:         {
 86:           text: 'åˆ é™¤',
 87:           type: 'del',
 88:           pop: true,
 89:           click: (record: Account) => this.delete(record.id)
 90:         }
 91:       ]
 92:     }
 93:   ];
 94: 
 95:   ngOnInit(): void {
 96:     this.loadAccounts();
 97:   }
 98: 
 99:   async loadAccounts(): Promise<void> {
100:     try {
101:       await this.accountService.loadAccounts();
102:     } catch (error) {
103:       this.message.error('åŠ è½½è´¦æˆ·åˆ—è¡¨å¤±è´¥');
104:     }
105:   }
106: 
107:   onTableChange(event: any): void {
108:     // å¤„ç†è¡¨æ ¼å˜åŒ–äº‹ä»¶ï¼ˆåˆ†é¡µã€æ’åºç­‰ï¼‰
109:   }
110: 
111:   createAccount(): void {
112:     // é»˜è®¤åˆ›å»ºç”¨æˆ·è´¦æˆ·ï¼Œä¹Ÿå¯ä»¥å¯¼èˆªåˆ°ä¸€ä¸ªé€‰æ‹©é¡µé¢
113:     this.router.navigate(['/accounts/create/user']);
114:   }
115: 
116:   viewDetail(id: string): void {
117:     this.router.navigate(['/accounts', id]);
118:   }
119: 
120:   edit(id: string): void {
121:     this.router.navigate(['/accounts', id, 'edit']);
122:   }
123: 
124:   async delete(id: string): Promise<void> {
125:     try {
126:       await this.accountService.deleteAccount(id);
127:       this.message.success('åˆ é™¤æˆåŠŸ');
128:     } catch (error) {
129:       this.message.error('åˆ é™¤å¤±è´¥');
130:     }
131:   }
132: }
````

## File: src/app/routes/accounts/schedules/schedule-list.component.ts
````typescript
  1: import { Component, OnInit, inject, computed, signal } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { AppError } from '@core';
  4: import { STColumn } from '@delon/abc/st';
  5: import { SHARED_IMPORTS, OrganizationScheduleService, OrganizationSchedule, AccountService } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: 
  8: @Component({
  9:   selector: 'app-schedule-list',
 10:   standalone: true,
 11:   imports: [SHARED_IMPORTS],
 12:   template: `
 13:     <page-header [title]="'æ’ç­ç®¡ç†'">
 14:       <ng-template #extra>
 15:         @if (selectedOrganizationId()) {
 16:           <button nz-button nzType="primary" (click)="createSchedule()">
 17:             <span nz-icon nzType="plus"></span>
 18:             æ–°å»ºæ’ç­
 19:           </button>
 20:         }
 21:       </ng-template>
 22:     </page-header>
 23: 
 24:     <div style="padding: 16px;">
 25:       <!-- ç»„ç»‡é€‰æ‹©å™¨ -->
 26:       <nz-card nzTitle="é€‰æ‹©ç»„ç»‡" style="margin-bottom: 16px;">
 27:         <nz-form-item>
 28:           <nz-form-label>ç»„ç»‡</nz-form-label>
 29:           <nz-form-control>
 30:             <nz-select
 31:               [ngModel]="selectedOrganizationId()"
 32:               (ngModelChange)="onOrganizationChange($event)"
 33:               nzPlaceHolder="è¯·é€‰æ‹©ç»„ç»‡"
 34:               [nzLoading]="accountService.loading()"
 35:               style="width: 300px;"
 36:             >
 37:               @for (org of accountService.organizationAccounts(); track org.id) {
 38:                 <nz-option [nzValue]="org.id" [nzLabel]="org.name"></nz-option>
 39:               }
 40:             </nz-select>
 41:           </nz-form-control>
 42:         </nz-form-item>
 43:         @if (!selectedOrganizationId()) {
 44:           <nz-alert
 45:             nzType="info"
 46:             nzMessage="è¯·å…ˆé€‰æ‹©ç»„ç»‡"
 47:             nzDescription="æ’ç­æ˜¯ç»„ç»‡ä¸“æœ‰åŠŸèƒ½ï¼Œè¯·å…ˆé€‰æ‹©ä¸€ä¸ªç»„ç»‡ä»¥æŸ¥çœ‹è¯¥ç»„ç»‡çš„æ’ç­ã€‚"
 48:             nzShowIcon
 49:             style="margin-top: 16px;"
 50:           ></nz-alert>
 51:         }
 52:       </nz-card>
 53: 
 54:       <!-- æ’ç­åˆ—è¡¨ -->
 55:       @if (selectedOrganizationId()) {
 56:         <nz-card [nzTitle]="'ç»„ç»‡æ’ç­åˆ—è¡¨ï¼š' + selectedOrganizationName()">
 57:           <st
 58:             #st
 59:             [data]="scheduleService.schedules()"
 60:             [columns]="columns"
 61:             [loading]="scheduleService.loading()"
 62:             [page]="{ front: false, show: true, showSize: true }"
 63:             (change)="onTableChange($event)"
 64:           >
 65:             <ng-template #date let-record>
 66:               {{ record.scheduleDate | date: 'yyyy-MM-dd' }}
 67:             </ng-template>
 68:           </st>
 69:         </nz-card>
 70:       }
 71:     </div>
 72:   `
 73: })
 74: export class ScheduleListComponent implements OnInit {
 75:   scheduleService = inject(OrganizationScheduleService);
 76:   accountService = inject(AccountService);
 77:   router = inject(Router);
 78:   message = inject(NzMessageService);
 79: 
 80:   selectedOrganizationId = signal<string | null>(null);
 81: 
 82:   columns: STColumn[] = [
 83:     { title: 'ID', index: 'id', width: 100 },
 84:     { title: 'æ—¥æœŸ', index: 'scheduleDate', width: 120, render: 'date' },
 85:     { title: 'ç»„ç»‡ID', index: 'organization_id', width: 200 },
 86:     { title: 'è“å›¾ID', index: 'blueprint_id', width: 200 },
 87:     { title: 'åˆ†æ”¯ID', index: 'branch_id', width: 200 },
 88:     { title: 'è´¦æˆ·ID', index: 'account_id', width: 200 },
 89:     { title: 'å›¢é˜ŸID', index: 'team_id', width: 200 },
 90:     { title: 'å¤‡æ³¨', index: 'notes', width: 200 },
 91:     { title: 'åˆ›å»ºæ—¶é—´', index: 'created_at', type: 'date', width: 180 },
 92:     {
 93:       title: 'æ“ä½œ',
 94:       width: 200,
 95:       buttons: [
 96:         {
 97:           text: 'ç¼–è¾‘',
 98:           click: (record: OrganizationSchedule) => this.edit(record.id)
 99:         },
100:         {
101:           text: 'åˆ é™¤',
102:           type: 'del',
103:           pop: true,
104:           click: (record: OrganizationSchedule) => this.delete(record.id)
105:         }
106:       ]
107:     }
108:   ];
109: 
110:   selectedOrganizationName = computed(() => {
111:     const orgId = this.selectedOrganizationId();
112:     if (!orgId) return '';
113:     const org = this.accountService.organizationAccounts().find(o => o.id === orgId);
114:     return org?.name || '';
115:   });
116: 
117:   ngOnInit(): void {
118:     // å…ˆåŠ è½½ç»„ç»‡åˆ—è¡¨
119:     this.loadOrganizations();
120:   }
121: 
122:   async loadOrganizations(): Promise<void> {
123:     try {
124:       await this.accountService.loadAccounts();
125:       // å¦‚æœåªæœ‰ä¸€ä¸ªç»„ç»‡ï¼Œè‡ªåŠ¨é€‰æ‹©
126:       const orgs = this.accountService.organizationAccounts();
127:       if (orgs.length === 1) {
128:         this.selectedOrganizationId.set(orgs[0].id);
129:         await this.loadSchedules(orgs[0].id);
130:       }
131:     } catch (error) {
132:       console.error('åŠ è½½ç»„ç»‡åˆ—è¡¨å¤±è´¥:', error);
133:       this.message.error('åŠ è½½ç»„ç»‡åˆ—è¡¨å¤±è´¥');
134:     }
135:   }
136: 
137:   async onOrganizationChange(organizationId: string | null): Promise<void> {
138:     this.selectedOrganizationId.set(organizationId);
139:     if (organizationId) {
140:       await this.loadSchedules(organizationId);
141:     }
142:     // å¦‚æœæ²¡æœ‰é€‰æ‹©ç»„ç»‡ï¼Œåˆ—è¡¨ä¼šé€šè¿‡ RLS ç­–ç•¥è‡ªåŠ¨è¿‡æ»¤ä¸ºç©º
143:   }
144: 
145:   async loadSchedules(organizationId: string): Promise<void> {
146:     try {
147:       await this.scheduleService.loadSchedulesByOrganizationId(organizationId);
148:     } catch (error) {
149:       // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
150:       let errorMessage = 'åŠ è½½æ’ç­åˆ—è¡¨å¤±è´¥';
151: 
152:       if (error instanceof Error) {
153:         const appError = error as AppError;
154:         if (appError.type && appError.severity) {
155:           errorMessage = appError.message || errorMessage;
156:           if (appError.details) {
157:             errorMessage += `: ${appError.details}`;
158:           }
159:         } else {
160:           errorMessage = error.message || errorMessage;
161:         }
162:       }
163: 
164:       console.error('åŠ è½½æ’ç­åˆ—è¡¨å¤±è´¥:', error);
165:       this.message.error(errorMessage, { nzDuration: 5000 });
166:     }
167:   }
168: 
169:   onTableChange(event: any): void {
170:     // å¤„ç†è¡¨æ ¼å˜åŒ–äº‹ä»¶ï¼ˆåˆ†é¡µã€æ’åºç­‰ï¼‰
171:   }
172: 
173:   createSchedule(): void {
174:     const orgId = this.selectedOrganizationId();
175:     if (orgId) {
176:       // å¯¼èˆªåˆ°ç»„ç»‡è¯¦æƒ…é¡µé¢ï¼Œåœ¨è¯¦æƒ…é¡µé¢ä¸­åˆ›å»ºæ’ç­
177:       this.router.navigate(['/accounts', orgId], { queryParams: { tab: 'schedules' } });
178:     } else {
179:       this.message.warning('è¯·å…ˆé€‰æ‹©ç»„ç»‡');
180:     }
181:   }
182: 
183:   edit(id: string): void {
184:     const orgId = this.selectedOrganizationId();
185:     if (orgId) {
186:       // å¯¼èˆªåˆ°ç»„ç»‡è¯¦æƒ…é¡µé¢ï¼Œåœ¨è¯¦æƒ…é¡µé¢ä¸­ç¼–è¾‘æ’ç­
187:       this.router.navigate(['/accounts', orgId], { queryParams: { tab: 'schedules', scheduleId: id } });
188:     } else {
189:       this.message.warning('è¯·å…ˆé€‰æ‹©ç»„ç»‡');
190:     }
191:   }
192: 
193:   async delete(id: string): Promise<void> {
194:     try {
195:       await this.scheduleService.deleteSchedule(id);
196:       this.message.success('åˆ é™¤æˆåŠŸ');
197:       const orgId = this.selectedOrganizationId();
198:       if (orgId) {
199:         await this.loadSchedules(orgId);
200:       }
201:     } catch (error) {
202:       // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
203:       let errorMessage = 'åˆ é™¤å¤±è´¥';
204: 
205:       if (error instanceof Error) {
206:         const appError = error as AppError;
207:         if (appError.type && appError.severity) {
208:           errorMessage = appError.message || errorMessage;
209:           if (appError.details) {
210:             errorMessage += `: ${appError.details}`;
211:           }
212:         } else {
213:           errorMessage = error.message || errorMessage;
214:         }
215:       }
216: 
217:       console.error('åˆ é™¤å¤±è´¥:', error);
218:       this.message.error(errorMessage, { nzDuration: 5000 });
219:     }
220:   }
221: }
````

## File: src/app/routes/accounts/users/user-list.component.ts
````typescript
  1: import { Component, OnInit, inject } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { AppError } from '@core';
  4: import { STColumn } from '@delon/abc/st';
  5: import { SHARED_IMPORTS, AccountService, Account } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: 
  8: @Component({
  9:   selector: 'app-user-list',
 10:   standalone: true,
 11:   imports: [SHARED_IMPORTS],
 12:   template: `
 13:     <page-header [title]="'ç”¨æˆ·ç®¡ç†'">
 14:       <ng-template #extra>
 15:         <button nz-button nzType="primary" (click)="createUser()">
 16:           <span nz-icon nzType="plus"></span>
 17:           æ–°å»ºç”¨æˆ·
 18:         </button>
 19:       </ng-template>
 20:     </page-header>
 21: 
 22:     <nz-card nzTitle="ç®¡ç†ç³»ç»Ÿä¸­çš„æ‰€æœ‰ç”¨æˆ·è´¦æˆ·" style="margin-top: 16px;">
 23:       <st
 24:         #st
 25:         [data]="users()"
 26:         [columns]="columns"
 27:         [loading]="loading()"
 28:         [page]="{ front: false, show: true, showSize: true }"
 29:         (change)="onTableChange($event)"
 30:       >
 31:         <ng-template #status let-record>
 32:           @switch (record.status) {
 33:             @case ('active') {
 34:               <nz-tag nzColor="success">æ´»è·ƒ</nz-tag>
 35:             }
 36:             @case ('inactive') {
 37:               <nz-tag nzColor="default">éæ´»è·ƒ</nz-tag>
 38:             }
 39:             @case ('suspended') {
 40:               <nz-tag nzColor="error">å·²æš‚åœ</nz-tag>
 41:             }
 42:           }
 43:         </ng-template>
 44:       </st>
 45:     </nz-card>
 46:   `
 47: })
 48: export class UserListComponent implements OnInit {
 49:   accountService = inject(AccountService);
 50:   router = inject(Router);
 51:   message = inject(NzMessageService);
 52: 
 53:   users = this.accountService.userAccounts;
 54:   loading = this.accountService.loading;
 55: 
 56:   columns: STColumn[] = [
 57:     { title: 'ID', index: 'id', width: 100 },
 58:     { title: 'ç”¨æˆ·å', index: 'name', width: 200 },
 59:     { title: 'é‚®ç®±', index: 'email', width: 200 },
 60:     { title: 'çŠ¶æ€', index: 'status', width: 100, render: 'status' },
 61:     { title: 'åˆ›å»ºæ—¶é—´', index: 'created_at', type: 'date', width: 180 },
 62:     {
 63:       title: 'æ“ä½œ',
 64:       width: 200,
 65:       buttons: [
 66:         {
 67:           text: 'æŸ¥çœ‹',
 68:           click: (record: Account) => this.viewDetail(record.id)
 69:         },
 70:         {
 71:           text: 'ç¼–è¾‘',
 72:           click: (record: Account) => this.edit(record.id)
 73:         },
 74:         {
 75:           text: 'åˆ é™¤',
 76:           type: 'del',
 77:           pop: true,
 78:           click: (record: Account) => this.delete(record.id)
 79:         }
 80:       ]
 81:     }
 82:   ];
 83: 
 84:   ngOnInit(): void {
 85:     this.loadUsers();
 86:   }
 87: 
 88:   async loadUsers(): Promise<void> {
 89:     try {
 90:       await this.accountService.loadAccounts();
 91:       // userAccounts computed signal ä¼šè‡ªåŠ¨è¿‡æ»¤å‡ºç”¨æˆ·ç±»å‹çš„è´¦æˆ·
 92:     } catch (error) {
 93:       // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
 94:       let errorMessage = 'åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥';
 95: 
 96:       if (error instanceof Error) {
 97:         // æ£€æŸ¥æ˜¯å¦æ˜¯ AppError ç±»å‹
 98:         const appError = error as AppError;
 99:         if (appError.type && appError.severity) {
100:           errorMessage = appError.message || errorMessage;
101:           if (appError.details) {
102:             errorMessage += `: ${appError.details}`;
103:           }
104:         } else {
105:           errorMessage = error.message || errorMessage;
106:         }
107:       }
108: 
109:       console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
110:       this.message.error(errorMessage, { nzDuration: 5000 });
111:     }
112:   }
113: 
114:   onTableChange(event: any): void {
115:     // å¤„ç†è¡¨æ ¼å˜åŒ–äº‹ä»¶ï¼ˆåˆ†é¡µã€æ’åºç­‰ï¼‰
116:   }
117: 
118:   createUser(): void {
119:     this.router.navigate(['/accounts/create/user']);
120:   }
121: 
122:   viewDetail(id: string): void {
123:     this.router.navigate(['/accounts', id]);
124:   }
125: 
126:   edit(id: string): void {
127:     this.router.navigate(['/accounts', id, 'edit']);
128:   }
129: 
130:   async delete(id: string): Promise<void> {
131:     try {
132:       await this.accountService.deleteAccount(id);
133:       this.message.success('åˆ é™¤æˆåŠŸ');
134:       await this.loadUsers();
135:     } catch (error) {
136:       // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
137:       let errorMessage = 'åˆ é™¤å¤±è´¥';
138: 
139:       if (error instanceof Error) {
140:         const appError = error as AppError;
141:         if (appError.type && appError.severity) {
142:           errorMessage = appError.message || errorMessage;
143:           if (appError.details) {
144:             errorMessage += `: ${appError.details}`;
145:           }
146:         } else {
147:           errorMessage = error.message || errorMessage;
148:         }
149:       }
150: 
151:       console.error('åˆ é™¤å¤±è´¥:', error);
152:       this.message.error(errorMessage, { nzDuration: 5000 });
153:     }
154:   }
155: }
````

## File: src/app/routes/analytics/activity-logs/activity-log.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-activity-log',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'æ´»åŠ¨æ—¥å¿—'"></page-header>
11: 
12:     <nz-card nzTitle="æ´»åŠ¨æ—¥å¿—" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="æ´»åŠ¨æ—¥å¿—åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†æ•´åˆç³»ç»Ÿå…³é”®è¡Œä¸ºçš„å®¡è®¡è®°å½•ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class ActivityLogComponent {}
````

## File: src/app/routes/analytics/charts/chart-center.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-chart-center',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'å›¾è¡¨ä¸­å¿ƒ'"></page-header>
11: 
12:     <nz-card nzTitle="å›¾è¡¨ä¸­å¿ƒ" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="å›¾è¡¨ä¸­å¿ƒåŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†æä¾›å¯é…ç½®çš„å›¾è¡¨å¤§å±ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class ChartCenterComponent {}
````

## File: src/app/routes/analytics/progress-update/progress-update.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-progress-update',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'è¿›åº¦æ›´æ–°'"></page-header>
11: 
12:     <nz-card nzTitle="è¿›åº¦æ›´æ–°è®°å½•" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="è¿›åº¦æ›´æ–°åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†ç”¨äºç»´æŠ¤è¿›åº¦æ’­æŠ¥ä¸å…³é”®é‡Œç¨‹ç¢‘ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class ProgressUpdateComponent {}
````

## File: src/app/routes/analytics/progress/progress-tracking.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-progress-tracking',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'è¿›åº¦è¿½è¸ª'"></page-header>
11: 
12:     <nz-card nzTitle="è¿›åº¦è¿½è¸ª" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="è¿›åº¦è¿½è¸ªåŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†å±•ç¤ºè“å›¾ä¸ä»»åŠ¡çš„æ•´ä½“è¿›åº¦è¶‹åŠ¿ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class ProgressTrackingComponent {}
````

## File: src/app/routes/analytics/reports/branch-report.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-branch-report',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'åˆ†æ”¯æŠ¥å‘Š'"></page-header>
11: 
12:     <nz-card nzTitle="åˆ†æ”¯æŠ¥å‘Š" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="åˆ†æ”¯æŠ¥å‘ŠåŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†æä¾›åˆ†æ”¯çº§åˆ«çš„æ‰§è¡ŒæŠ¥å‘Šä¸å¯¹æ¯”ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class BranchReportComponent {}
````

## File: src/app/routes/analytics/reports/cross-branch.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-cross-branch',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'è·¨åˆ†æ”¯æ€»è§ˆ'"></page-header>
11: 
12:     <nz-card nzTitle="è·¨åˆ†æ”¯æ€»è§ˆ" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="è·¨åˆ†æ”¯æ€»è§ˆåŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†å¯¹æ¯”å¤šä¸ªåˆ†æ”¯çš„æ‰§è¡ŒæŒ‡æ ‡ä¸é£é™©ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class CrossBranchComponent {}
````

## File: src/app/routes/analytics/reports/data-report.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-data-report',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'æ•°æ®æŠ¥å‘Š'"></page-header>
11: 
12:     <nz-card nzTitle="æ•°æ®æŠ¥å‘Š" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="æ•°æ®æŠ¥å‘ŠåŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†æ”¯æŒè‡ªå®šä¹‰æŠ¥è¡¨é…ç½®ä¸å¯¼å‡ºã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class DataReportComponent {}
````

## File: src/app/routes/analytics/reports/main-report.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-main-report',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'ä¸»åˆ†æ”¯æŠ¥å‘Š'"></page-header>
11: 
12:     <nz-card nzTitle="ä¸»åˆ†æ”¯æŠ¥å‘Š" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="ä¸»åˆ†æ”¯æŠ¥å‘ŠåŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†è¾“å‡ºä¸»åˆ†æ”¯çš„æ•´ä½“æ‰§è¡ŒæŠ¥å‘Šä¸ KPIã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class MainReportComponent {}
````

## File: src/app/routes/analytics/reports/report-export.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-report-export',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'æŠ¥è¡¨å¯¼å‡º'"></page-header>
11: 
12:     <nz-card nzTitle="æŠ¥è¡¨å¯¼å‡º" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="æŠ¥è¡¨å¯¼å‡ºåŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†æ”¯æŒå¤šæ ¼å¼å¯¼å‡ºä¸æ’ç¨‹ä»»åŠ¡ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class ReportExportComponent {}
````

## File: src/app/routes/analytics/statistics/statistics.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-analytics-statistics',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'ç»Ÿè®¡æ€»è§ˆ'"></page-header>
11: 
12:     <nz-card nzTitle="ç»Ÿè®¡æ€»è§ˆ" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="ç»Ÿè®¡æ¨¡å—å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†æ±‡æ€»å„ä¸šåŠ¡æ¨¡å—çš„ KPI ä¸è¿è¡ŒæŒ‡æ ‡ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class StatisticsComponent {}
````

## File: src/app/routes/blueprints/branches/blueprint-branches-overview.component.ts
````typescript
  1: import { ChangeDetectionStrategy, Component } from '@angular/core';
  2: import { SHARED_IMPORTS } from '@shared';
  3: 
  4: interface BranchNode {
  5:   readonly title: string;
  6:   readonly key: string;
  7:   readonly children?: BranchNode[];
  8: }
  9: 
 10: interface BranchRow {
 11:   readonly name: string;
 12:   readonly owner: string;
 13:   readonly changes: number;
 14:   readonly updatedAt: string;
 15: }
 16: 
 17: @Component({
 18:   selector: 'app-blueprint-branches-overview',
 19:   standalone: true,
 20:   imports: [SHARED_IMPORTS],
 21:   template: `
 22:     <nz-page-header [nzTitle]="'åˆ†æ”¯ç®¡ç†éª¨æ¶'" [nzSubtitle]="'ç¤ºæ„åˆ—è¡¨ï¼‹æ¨¹ç‹€çµæ§‹'">
 23:       <nz-page-header-extra>
 24:         <button nz-button nzType="default">
 25:           <span nz-icon nzType="fork"></span>
 26:           å»ºç«‹åˆ†æ”¯
 27:         </button>
 28:         <button nz-button nzType="primary">
 29:           <span nz-icon nzType="api"></span>
 30:           å¥—ç”¨ç­–ç•¥
 31:         </button>
 32:       </nz-page-header-extra>
 33:     </nz-page-header>
 34: 
 35:     <div class="page-section">
 36:       <nz-row [nzGutter]="16">
 37:         <nz-col nzXs="24" nzXl="8">
 38:           <nz-card nzTitle="åˆ†æ”¯æ¨¹">
 39:             <nz-tree nzBlockNode [nzData]="branchTree"></nz-tree>
 40:           </nz-card>
 41:         </nz-col>
 42:         <nz-col nzXs="24" nzXl="16">
 43:           <nz-card nzTitle="åˆ†æ”¯åˆ—è¡¨">
 44:             <nz-table [nzData]="branchTable" nzSize="middle">
 45:               <thead>
 46:                 <tr>
 47:                   <th>åç¨±</th>
 48:                   <th>è² è²¬äºº</th>
 49:                   <th>è®Šæ›´æ•¸</th>
 50:                   <th>æœ€è¿‘æ›´æ–°</th>
 51:                   <th>æ“ä½œ</th>
 52:                 </tr>
 53:               </thead>
 54:               <tbody>
 55:                 @for (row of branchTable; track row.name) {
 56:                   <tr>
 57:                     <td>{{ row.name }}</td>
 58:                     <td>{{ row.owner }}</td>
 59:                     <td>
 60:                       <nz-badge nzStatus="processing" [nzText]="row.changes + ' commits'"></nz-badge>
 61:                     </td>
 62:                     <td>{{ row.updatedAt }}</td>
 63:                     <td>
 64:                       <button nz-button nzType="link">æª¢è¦–</button>
 65:                       <button nz-button nzType="link">æ¯”è¼ƒ</button>
 66:                     </td>
 67:                   </tr>
 68:                 }
 69:               </tbody>
 70:             </nz-table>
 71:           </nz-card>
 72:         </nz-col>
 73:       </nz-row>
 74:     </div>
 75:   `,
 76:   styles: [
 77:     `
 78:       :host {
 79:         display: block;
 80:       }
 81: 
 82:       .page-section {
 83:         padding: 16px;
 84:       }
 85:     `
 86:   ],
 87:   changeDetection: ChangeDetectionStrategy.OnPush
 88: })
 89: export class BlueprintBranchesOverviewComponent {
 90:   protected readonly branchTree: BranchNode[] = [
 91:     {
 92:       title: 'main',
 93:       key: 'main',
 94:       children: [
 95:         {
 96:           title: 'release/2402',
 97:           key: 'release/2402',
 98:           children: [
 99:             { title: 'hotfix/api', key: 'release/2402/hotfix' },
100:             { title: 'docs/review', key: 'release/2402/docs' }
101:           ]
102:         },
103:         {
104:           title: 'feature/blueprint-hub',
105:           key: 'feature/blueprint-hub',
106:           children: [{ title: 'experiment/tabs', key: 'experiment/tabs' }]
107:         }
108:       ]
109:     }
110:   ];
111: 
112:   protected readonly branchTable: BranchRow[] = [
113:     { name: 'main', owner: 'System', changes: 1, updatedAt: '11:20' },
114:     { name: 'release/2402', owner: 'Release Guild', changes: 7, updatedAt: '10:50' },
115:     { name: 'feature/blueprint-hub', owner: 'Blueprint Squad', changes: 3, updatedAt: '10:12' }
116:   ];
117: }
````

## File: src/app/routes/blueprints/branches/branch-detail/branch-detail.spec.ts
````typescript
 1: import { ComponentFixture, TestBed } from '@angular/core/testing';
 2: 
 3: import { BranchDetail } from './branch-detail';
 4: 
 5: describe('BranchDetail', () => {
 6:   let component: BranchDetail;
 7:   let fixture: ComponentFixture<BranchDetail>;
 8: 
 9:   beforeEach(async () => {
10:     await TestBed.configureTestingModule({
11:       imports: [BranchDetail]
12:     }).compileComponents();
13: 
14:     fixture = TestBed.createComponent(BranchDetail);
15:     component = fixture.componentInstance;
16:     fixture.detectChanges();
17:   });
18: 
19:   it('should create', () => {
20:     expect(component).toBeTruthy();
21:   });
22: });
````

## File: src/app/routes/blueprints/detail-shell/blueprint-detail-shell.component.ts
````typescript
  1: import { ChangeDetectionStrategy, Component } from '@angular/core';
  2: import { SHARED_IMPORTS } from '@shared';
  3: 
  4: interface Metric {
  5:   readonly label: string;
  6:   readonly value: string;
  7:   readonly trend: string;
  8:   readonly color: string;
  9: }
 10: 
 11: interface DeliveryStage {
 12:   readonly name: string;
 13:   readonly owner: string;
 14:   readonly status: 'wait' | 'process' | 'finish' | 'error';
 15:   readonly updatedAt: string;
 16: }
 17: 
 18: interface RiskItem {
 19:   readonly title: string;
 20:   readonly detail: string;
 21:   readonly owner: string;
 22:   readonly level: 'low' | 'medium' | 'high';
 23: }
 24: 
 25: @Component({
 26:   selector: 'app-blueprint-detail-shell',
 27:   standalone: true,
 28:   imports: [SHARED_IMPORTS],
 29:   template: `
 30:     <nz-page-header [nzTitle]="'è—åœ–è©³æƒ…éª¨æ¶'" [nzSubtitle]="'éœæ…‹é é¢å ä½ï¼Œæ–¹ä¾¿é–‹ç™¼æ’æŸ¥'">
 31:       <nz-page-header-extra>
 32:         <button nz-button nzType="default">
 33:           <span nz-icon nzType="sync"></span>
 34:           åŒæ­¥é…ç½®
 35:         </button>
 36:         <button nz-button nzType="primary" nzShape="round">
 37:           <span nz-icon nzType="edit"></span>
 38:           é€²å…¥è¡¨å–®
 39:         </button>
 40:       </nz-page-header-extra>
 41:     </nz-page-header>
 42: 
 43:     <div class="page-section">
 44:       <nz-row [nzGutter]="16">
 45:         @for (metric of overviewMetrics; track metric.label) {
 46:           <nz-col nzXs="24" nzSm="12" nzXl="6">
 47:             <nz-card nzSize="small" class="metric-card" [nzBodyStyle]="{ padding: '12px 16px' }">
 48:               <div class="metric-label">{{ metric.label }}</div>
 49:               <div class="metric-value" [style.color]="metric.color">{{ metric.value }}</div>
 50:               <div class="metric-trend">{{ metric.trend }}</div>
 51:             </nz-card>
 52:           </nz-col>
 53:         }
 54:       </nz-row>
 55: 
 56:       <nz-card nzTitle="äº¤ä»˜éšæ®µè¦–åœ–" class="section-card">
 57:         <nz-steps nzDirection="vertical">
 58:           @for (stage of deliveryStages; track stage.name) {
 59:             <nz-step [nzTitle]="stage.name" [nzStatus]="stage.status">
 60:               <ng-template #nzDescription>
 61:                 <div class="stage-owner">
 62:                   Ownerï¼š{{ stage.owner }}
 63:                   <nz-tag nzColor="purple">{{ stage.updatedAt }}</nz-tag>
 64:                 </div>
 65:               </ng-template>
 66:             </nz-step>
 67:           }
 68:         </nz-steps>
 69:       </nz-card>
 70: 
 71:       <nz-card nzTitle="é¢¨éšªèˆ‡ä¾è³´" class="section-card">
 72:         <nz-list [nzDataSource]="riskList" nzItemLayout="horizontal">
 73:           <ng-template #renderItem let-item>
 74:             <nz-list-item>
 75:               <nz-list-item-meta [nzTitle]="item.title" [nzDescription]="item.detail + ' Â· è² è²¬äººï¼š' + item.owner"></nz-list-item-meta>
 76:               <nz-tag [nzColor]="item.level === 'high' ? 'red' : item.level === 'medium' ? 'orange' : 'green'">
 77:                 {{ item.level | uppercase }}
 78:               </nz-tag>
 79:             </nz-list-item>
 80:           </ng-template>
 81:         </nz-list>
 82:       </nz-card>
 83:     </div>
 84:   `,
 85:   styles: [
 86:     `
 87:       :host {
 88:         display: block;
 89:       }
 90: 
 91:       .page-section {
 92:         padding: 16px;
 93:         display: flex;
 94:         flex-direction: column;
 95:         gap: 16px;
 96:       }
 97: 
 98:       .metric-card {
 99:         min-height: 110px;
100:       }
101: 
102:       .metric-label {
103:         font-size: 13px;
104:         color: rgba(0, 0, 0, 0.65);
105:       }
106: 
107:       .metric-value {
108:         font-size: 26px;
109:         font-weight: 600;
110:         margin: 6px 0;
111:       }
112: 
113:       .metric-trend {
114:         font-size: 12px;
115:         color: rgba(0, 0, 0, 0.45);
116:       }
117: 
118:       .stage-owner {
119:         display: flex;
120:         align-items: center;
121:         gap: 8px;
122:       }
123:     `
124:   ],
125:   changeDetection: ChangeDetectionStrategy.OnPush
126: })
127: export class BlueprintDetailShellComponent {
128:   protected readonly overviewMetrics: Metric[] = [
129:     { label: 'æ¨¡çµ„æ•¸', value: '18', trend: 'æ–°å¢ 2 å€‹å­æ¨¡çµ„', color: '#1890ff' },
130:     { label: 'æ´»èºä»»å‹™', value: '42', trend: 'é€²è¡Œä¸­ 16 Â· å¾…å¯©æ ¸ 8', color: '#52c41a' },
131:     { label: 'é˜»å¡é …', value: '5', trend: 'éœ€è·¨çµ„å”ä½œè™•ç†', color: '#fa8c16' },
132:     { label: 'ç†±åº¦æŒ‡æ•¸', value: '87%', trend: 'æœ€è¿‘ 24h äº’å‹•', color: '#722ed1' }
133:   ];
134: 
135:   protected readonly deliveryStages: DeliveryStage[] = [
136:     { name: 'è—åœ–è‰ç¨¿', owner: 'Alice', status: 'finish', updatedAt: '09:12' },
137:     { name: 'ä¸»åˆ†æ”¯åŒæ­¥', owner: 'Branch Bot', status: 'process', updatedAt: '10:45' },
138:     { name: 'å¯©æ ¸èˆ‡é©—è­‰', owner: 'Reviewer Team', status: 'wait', updatedAt: 'å¾…æ’ç¨‹' },
139:     { name: 'éƒ¨ç½²èˆ‡é©—è­‰', owner: 'Infra', status: 'wait', updatedAt: 'ç­‰å¾…è§¸ç™¼' }
140:   ];
141: 
142:   protected readonly riskList: RiskItem[] = [
143:     {
144:       title: 'è³‡æ–™æ¨¡å‹é‡æ§‹',
145:       detail: 'éœ€æ ¸å° 51 å¼µè¡¨å·®ç•°èˆ‡ RLS è¦å‰‡',
146:       owner: 'DB Guild',
147:       level: 'high'
148:     },
149:     {
150:       title: 'å·¥ä½œæµåˆ†æ”¯åˆ‡æ›',
151:       detail: 'æ–°èˆŠæµç¨‹å…±å­˜ï¼Œéœ€é˜²æ­¢æ¬Šé™éŒ¯ç½®',
152:       owner: 'Workflow Squad',
153:       level: 'medium'
154:     },
155:     {
156:       title: 'æ–‡ä»¶æœå‹™',
157:       detail: 'ç¸®åœ–èˆ‡å¤§æª”åˆ†æµéœ€æ¸¬è©¦',
158:       owner: 'Document Team',
159:       level: 'low'
160:     }
161:   ];
162: }
````

## File: src/app/routes/blueprints/detail/blueprint-detail.component.ts
````typescript
  1: import { Component, OnInit, inject, computed } from '@angular/core';
  2: import { ActivatedRoute, Router } from '@angular/router';
  3: import { BlueprintStatus } from '@core';
  4: import { SHARED_IMPORTS, BlueprintService, Blueprint, AccountService, Account, AccountType } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: 
  7: @Component({
  8:   selector: 'app-blueprint-detail',
  9:   standalone: true,
 10:   imports: [SHARED_IMPORTS],
 11:   template: `
 12:     <page-header [title]="'è“å›¾è¯¦æƒ…'">
 13:       <ng-template #extra>
 14:         <button nz-button nzType="default" (click)="goBack()" style="margin-right: 8px;">
 15:           <span nz-icon nzType="arrow-left"></span>
 16:           è¿”å›
 17:         </button>
 18:         @if (blueprint()) {
 19:           <button nz-button nzType="primary" (click)="edit()" style="margin-right: 8px;">
 20:             <span nz-icon nzType="edit"></span>
 21:             ç¼–è¾‘
 22:           </button>
 23:           <button nz-button (click)="manageBranches()" style="margin-right: 8px;">
 24:             <span nz-icon nzType="git-branch"></span>
 25:             åˆ†æ”¯ç®¡ç†
 26:           </button>
 27:           <button nz-button nzDanger (click)="delete()">
 28:             <span nz-icon nzType="delete"></span>
 29:             åˆ é™¤
 30:           </button>
 31:         }
 32:       </ng-template>
 33:     </page-header>
 34: 
 35:     @if (blueprintService.loading()) {
 36:       <nz-spin nzSimple [nzSize]="'large'" style="display: block; padding: 50px; text-align: center;">
 37:         <ng-template #indicator>
 38:           <span nz-icon nzType="loading" style="font-size: 24px;"></span>
 39:         </ng-template>
 40:       </nz-spin>
 41:     } @else if (blueprintService.error()) {
 42:       <nz-alert
 43:         nzType="error"
 44:         [nzMessage]="'åŠ è½½å¤±è´¥'"
 45:         [nzDescription]="blueprintService.error()"
 46:         nzShowIcon
 47:         style="margin: 16px;"
 48:       ></nz-alert>
 49:     } @else if (blueprint()) {
 50:       <div style="padding: 16px;">
 51:         <!-- è“å›¾åŸºæœ¬ä¿¡æ¯ -->
 52:         <nz-card nzTitle="åŸºæœ¬ä¿¡æ¯" style="margin-bottom: 16px;">
 53:           <nz-descriptions nzBordered [nzColumn]="{ xxl: 3, xl: 2, lg: 2, md: 1, sm: 1, xs: 1 }">
 54:             <nz-descriptions-item nzTitle="ID">{{ blueprint()!.id }}</nz-descriptions-item>
 55:             <nz-descriptions-item nzTitle="é¡¹ç›®åç§°">{{ blueprint()!.name }}</nz-descriptions-item>
 56:             <nz-descriptions-item nzTitle="é¡¹ç›®ä»£ç ">{{ blueprint()!.project_code || '-' }}</nz-descriptions-item>
 57:             <nz-descriptions-item nzTitle="æ‹¥æœ‰è€…">
 58:               @if (ownerAccount()) {
 59:                 <span>
 60:                   @switch (ownerAccount()!.type) {
 61:                     @case (AccountType.USER) {
 62:                       <span nz-icon nzType="user" style="margin-right: 4px;"></span>
 63:                       {{ ownerAccount()!.name }}
 64:                       <nz-tag nzColor="blue" style="margin-left: 8px;">ä¸ªäºº</nz-tag>
 65:                     }
 66:                     @case (AccountType.ORGANIZATION) {
 67:                       <span nz-icon nzType="team" style="margin-right: 4px;"></span>
 68:                       {{ ownerAccount()!.name }}
 69:                       <nz-tag nzColor="green" style="margin-left: 8px;">ç»„ç»‡</nz-tag>
 70:                     }
 71:                     @default {
 72:                       {{ ownerAccount()!.name }}
 73:                     }
 74:                   }
 75:                   <button nz-button nzType="link" nzSize="small" style="margin-left: 8px;" (click)="viewOwnerAccount()"> æŸ¥çœ‹è¯¦æƒ… </button>
 76:                 </span>
 77:               } @else {
 78:                 <span style="color: #999;">{{ blueprint()!.owner_id }}</span>
 79:               }
 80:             </nz-descriptions-item>
 81:             <nz-descriptions-item nzTitle="çŠ¶æ€">
 82:               @switch (blueprint()!.status) {
 83:                 @case ('planning') {
 84:                   <nz-tag nzColor="default">è§„åˆ’ä¸­</nz-tag>
 85:                 }
 86:                 @case ('active') {
 87:                   <nz-tag nzColor="success">è¿›è¡Œä¸­</nz-tag>
 88:                 }
 89:                 @case ('on_hold') {
 90:                   <nz-tag nzColor="warning">æš‚åœ</nz-tag>
 91:                 }
 92:                 @case ('completed') {
 93:                   <nz-tag nzColor="blue">å·²å®Œæˆ</nz-tag>
 94:                 }
 95:                 @case ('archived') {
 96:                   <nz-tag nzColor="default">å·²å½’æ¡£</nz-tag>
 97:                 }
 98:                 @default {
 99:                   <nz-tag>æœªçŸ¥</nz-tag>
100:                 }
101:               }
102:             </nz-descriptions-item>
103:             <nz-descriptions-item nzTitle="å¼€å§‹æ—¥æœŸ">
104:               {{ blueprint()!.start_date ? (blueprint()!.start_date | date: 'yyyy-MM-dd') : '-' }}
105:             </nz-descriptions-item>
106:             <nz-descriptions-item nzTitle="ç»“æŸæ—¥æœŸ">
107:               {{ blueprint()!.end_date ? (blueprint()!.end_date | date: 'yyyy-MM-dd') : '-' }}
108:             </nz-descriptions-item>
109:             <nz-descriptions-item nzTitle="åˆ›å»ºæ—¶é—´">
110:               {{ blueprint()!.created_at | date: 'yyyy-MM-dd HH:mm:ss' }}
111:             </nz-descriptions-item>
112:             <nz-descriptions-item nzTitle="æ›´æ–°æ—¶é—´">
113:               {{ blueprint()!.updated_at | date: 'yyyy-MM-dd HH:mm:ss' }}
114:             </nz-descriptions-item>
115:           </nz-descriptions>
116:         </nz-card>
117: 
118:         <!-- è“å›¾é…ç½® -->
119:         @if (blueprintService.configs().length > 0) {
120:           <nz-card nzTitle="é…ç½®ä¿¡æ¯" style="margin-bottom: 16px;">
121:             <nz-descriptions nzBordered [nzColumn]="{ xxl: 2, xl: 2, lg: 1, md: 1, sm: 1, xs: 1 }">
122:               @for (config of blueprintService.configs(); track config.id) {
123:                 <nz-descriptions-item [nzTitle]="config.config_key">
124:                   {{ config.config_value | json }}
125:                 </nz-descriptions-item>
126:               }
127:             </nz-descriptions>
128:           </nz-card>
129:         }
130:       </div>
131:     } @else {
132:       <nz-empty nzNotFoundContent="è“å›¾ä¸å­˜åœ¨"></nz-empty>
133:     }
134:   `
135: })
136: export class BlueprintDetailComponent implements OnInit {
137:   blueprintService = inject(BlueprintService);
138:   accountService = inject(AccountService);
139:   route = inject(ActivatedRoute);
140:   router = inject(Router);
141:   message = inject(NzMessageService);
142: 
143:   // ä½¿ç”¨ computed ä» Service è·å–è“å›¾ä¿¡æ¯
144:   blueprint = computed(() => this.blueprintService.selectedBlueprint());
145: 
146:   // æ‹¥æœ‰è€…è´¦æˆ·ä¿¡æ¯
147:   ownerAccount = computed(() => {
148:     const blueprint = this.blueprint();
149:     if (!blueprint) return null;
150:     return this.accountService.accounts().find(a => a.id === blueprint.owner_id);
151:   });
152: 
153:   // å¯¼å‡ºæšä¸¾ä¾›æ¨¡æ¿ä½¿ç”¨
154:   BlueprintStatus = BlueprintStatus;
155:   AccountType = AccountType;
156: 
157:   ngOnInit(): void {
158:     const blueprintId = this.route.snapshot.paramMap.get('id');
159:     if (blueprintId) {
160:       this.loadBlueprint(blueprintId);
161:     }
162:   }
163: 
164:   async loadBlueprint(id: string): Promise<void> {
165:     try {
166:       const blueprint = await this.blueprintService.loadBlueprintById(id);
167:       if (!blueprint) {
168:         this.message.warning('è“å›¾ä¸å­˜åœ¨');
169:         this.goBack();
170:         return;
171:       }
172:       // åŠ è½½æ‹¥æœ‰è€…è´¦æˆ·ä¿¡æ¯
173:       await this.loadOwnerAccount(blueprint.owner_id);
174:     } catch (error) {
175:       this.message.error('åŠ è½½è“å›¾è¯¦æƒ…å¤±è´¥');
176:     }
177:   }
178: 
179:   async loadOwnerAccount(ownerId: string): Promise<void> {
180:     try {
181:       await this.accountService.loadAccountById(ownerId);
182:     } catch (error) {
183:       // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ä¸»æµç¨‹
184:       console.error('åŠ è½½æ‹¥æœ‰è€…è´¦æˆ·ä¿¡æ¯å¤±è´¥:', error);
185:     }
186:   }
187: 
188:   viewOwnerAccount(): void {
189:     const account = this.ownerAccount();
190:     if (account) {
191:       this.router.navigate(['/accounts', account.id]);
192:     }
193:   }
194: 
195:   goBack(): void {
196:     this.router.navigate(['/blueprints/list']);
197:   }
198: 
199:   edit(): void {
200:     if (this.blueprint()) {
201:       this.router.navigate(['/blueprints', this.blueprint()!.id, 'edit']);
202:     }
203:   }
204: 
205:   manageBranches(): void {
206:     if (this.blueprint()) {
207:       this.router.navigate(['/blueprints', this.blueprint()!.id, 'branches']);
208:     }
209:   }
210: 
211:   async delete(): Promise<void> {
212:     if (!this.blueprint()) {
213:       return;
214:     }
215: 
216:     if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤è“å›¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
217:       try {
218:         await this.blueprintService.deleteBlueprint(this.blueprint()!.id);
219:         this.message.success('åˆ é™¤æˆåŠŸ');
220:         this.goBack();
221:       } catch (error) {
222:         this.message.error('åˆ é™¤å¤±è´¥');
223:       }
224:     }
225:   }
226: }
````

## File: src/app/routes/blueprints/fork/blueprint-fork-landing.component.ts
````typescript
  1: import { ChangeDetectionStrategy, Component } from '@angular/core';
  2: import { SHARED_IMPORTS } from '@shared';
  3: 
  4: interface ForkStep {
  5:   readonly title: string;
  6:   readonly description: string;
  7: }
  8: 
  9: @Component({
 10:   selector: 'app-blueprint-fork-landing',
 11:   standalone: true,
 12:   imports: [SHARED_IMPORTS],
 13:   template: `
 14:     <nz-page-header [nzTitle]="'Fork ä»»å‹™éª¨æ¶'" [nzSubtitle]="'ä»¥ Step Form å‘ˆç¾æµç¨‹'">
 15:       <nz-page-header-extra>
 16:         <button nz-button nzType="default">
 17:           <span nz-icon nzType="download"></span>
 18:           åŒ¯å‡ºè¨­å®š
 19:         </button>
 20:         <button nz-button nzType="primary">
 21:           <span nz-icon nzType="apartment"></span>
 22:           å»ºç«‹ Fork
 23:         </button>
 24:       </nz-page-header-extra>
 25:     </nz-page-header>
 26: 
 27:     <div class="page-section">
 28:       <nz-card>
 29:         <nz-steps [nzCurrent]="1">
 30:           @for (step of forkSteps; track step.title) {
 31:             <nz-step [nzTitle]="step.title" [nzDescription]="step.description"></nz-step>
 32:           }
 33:         </nz-steps>
 34: 
 35:         <div class="fork-form">
 36:           <form nz-form nzLayout="vertical">
 37:             <nz-form-item>
 38:               <nz-form-label>ä¾†æºè—åœ–</nz-form-label>
 39:               <nz-form-control>
 40:                 <nz-select nzPlaceHolder="é¸æ“‡è—åœ–">
 41:                   <nz-option nzValue="blueprint-main" nzLabel="ä¸»å¹¹ Blueprint"></nz-option>
 42:                   <nz-option nzValue="blueprint-release" nzLabel="Release Blueprint"></nz-option>
 43:                 </nz-select>
 44:               </nz-form-control>
 45:             </nz-form-item>
 46: 
 47:             <nz-form-item>
 48:               <nz-form-label>Fork åç¨±</nz-form-label>
 49:               <nz-form-control>
 50:                 <input nz-input placeholder="ex: feature/org-collab" />
 51:               </nz-form-control>
 52:             </nz-form-item>
 53: 
 54:             <nz-form-item>
 55:               <nz-form-label>å¼•ç”¨æ¨¡çµ„</nz-form-label>
 56:               <nz-form-control>
 57:                 <nz-transfer [nzDataSource]="transferData" [nzTitles]="['å¯é¸æ¨¡çµ„', 'å·²åŠ å…¥']" nzShowSearch></nz-transfer>
 58:               </nz-form-control>
 59:             </nz-form-item>
 60: 
 61:             <div class="actions">
 62:               <button nz-button nzType="default">ä¸Šä¸€æ­¥</button>
 63:               <button nz-button nzType="primary">é è¦½çµæœ</button>
 64:             </div>
 65:           </form>
 66:         </div>
 67:       </nz-card>
 68:     </div>
 69:   `,
 70:   styles: [
 71:     `
 72:       :host {
 73:         display: block;
 74:       }
 75: 
 76:       .page-section {
 77:         padding: 16px;
 78:       }
 79: 
 80:       .fork-form {
 81:         margin-top: 32px;
 82:       }
 83: 
 84:       .actions {
 85:         margin-top: 16px;
 86:         display: flex;
 87:         justify-content: flex-end;
 88:         gap: 8px;
 89:       }
 90:     `
 91:   ],
 92:   changeDetection: ChangeDetectionStrategy.OnPush
 93: })
 94: export class BlueprintForkLandingComponent {
 95:   protected readonly forkSteps: ForkStep[] = [
 96:     { title: 'é¸æ“‡ä¾†æº', description: 'ä¸»å¹¹ / release / ä»»å‹™åˆ†æ”¯' },
 97:     { title: 'å®šç¾© Fork', description: 'å‘½åèˆ‡æ¨¡çµ„é¸å–' },
 98:     { title: 'å¯©æ ¸èˆ‡åŒæ­¥', description: 'è¨­å®šå®ˆè­·è…³æœ¬' }
 99:   ];
100: 
101:   protected readonly transferData = [
102:     { key: 'account', title: 'Account æ¨¡çµ„', direction: 'left' as const },
103:     { key: 'task', title: 'Task æ¨¡çµ„', direction: 'left' as const },
104:     { key: 'document', title: 'Document æ¨¡çµ„', direction: 'left' as const },
105:     { key: 'quality', title: 'Quality æ¨¡çµ„', direction: 'right' as const }
106:   ];
107: }
````

## File: src/app/routes/blueprints/form/blueprint-form.component.ts
````typescript
  1: import { Component, OnInit, inject, computed, signal, ViewChild } from '@angular/core';
  2: import { FormControl, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
  3: import { ActivatedRoute, Router } from '@angular/router';
  4: import { BlueprintStatus } from '@core';
  5: import { SHARED_IMPORTS, BlueprintService, Blueprint, BlueprintInsert, BlueprintUpdate, AccountSelectorComponent } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: 
  8: /**
  9:  * è“å›¾è¡¨å•ç±»å‹å®šä¹‰
 10:  */
 11: interface BlueprintFormValue {
 12:   name: string;
 13:   projectCode?: string | null;
 14:   ownerId: string;
 15:   status: BlueprintStatus;
 16:   startDate?: string | null;
 17:   endDate?: string | null;
 18:   description?: string | null;
 19: }
 20: 
 21: @Component({
 22:   selector: 'app-blueprint-form',
 23:   standalone: true,
 24:   imports: [SHARED_IMPORTS, ReactiveFormsModule, AccountSelectorComponent],
 25:   template: `
 26:     <page-header [title]="isEditMode() ? 'ç¼–è¾‘è“å›¾' : 'åˆ›å»ºè“å›¾'">
 27:       <ng-template #extra>
 28:         <button nz-button nzType="default" (click)="goBack()" style="margin-right: 8px;">
 29:           <span nz-icon nzType="arrow-left"></span>
 30:           è¿”å›
 31:         </button>
 32:       </ng-template>
 33:     </page-header>
 34: 
 35:     <div style="padding: 16px;">
 36:       @if (blueprintService.loading()) {
 37:         <nz-spin nzSimple [nzSize]="'large'" style="display: block; padding: 50px; text-align: center;">
 38:           <ng-template #indicator>
 39:             <span nz-icon nzType="loading" style="font-size: 24px;"></span>
 40:           </ng-template>
 41:         </nz-spin>
 42:       } @else {
 43:         <nz-card [nzTitle]="isEditMode() ? 'ç¼–è¾‘è“å›¾ä¿¡æ¯' : 'åˆ›å»ºæ–°è“å›¾'">
 44:           <form nz-form [formGroup]="form" (ngSubmit)="onSubmit()">
 45:             <nz-form-item>
 46:               <nz-form-label [nzSpan]="4" nzRequired>é¡¹ç›®åç§°</nz-form-label>
 47:               <nz-form-control [nzSpan]="20" [nzErrorTip]="'è¯·è¾“å…¥é¡¹ç›®åç§°'">
 48:                 <input nz-input formControlName="name" placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°" />
 49:               </nz-form-control>
 50:             </nz-form-item>
 51: 
 52:             <nz-form-item>
 53:               <nz-form-label [nzSpan]="4">é¡¹ç›®ä»£ç </nz-form-label>
 54:               <nz-form-control [nzSpan]="20">
 55:                 <input nz-input formControlName="projectCode" placeholder="è¯·è¾“å…¥é¡¹ç›®ä»£ç " />
 56:               </nz-form-control>
 57:             </nz-form-item>
 58: 
 59:             <!-- è´¦æˆ·é€‰æ‹©å™¨ -->
 60:             <app-account-selector
 61:               (accountChange)="onOwnerAccountChange($event)"
 62:               [helpText]="'é€‰æ‹©è“å›¾æ‹¥æœ‰è€…ã€‚ä¸ªäººè´¦æˆ·ç”¨äºä¸ªäººé¡¹ç›®ï¼Œç»„ç»‡è´¦æˆ·ç”¨äºå›¢é˜Ÿé¡¹ç›®ã€‚'"
 63:             ></app-account-selector>
 64: 
 65:             <nz-form-item>
 66:               <nz-form-label [nzSpan]="4" nzRequired>çŠ¶æ€</nz-form-label>
 67:               <nz-form-control [nzSpan]="20" [nzErrorTip]="'è¯·é€‰æ‹©çŠ¶æ€'">
 68:                 <nz-select formControlName="status" nzPlaceHolder="è¯·é€‰æ‹©çŠ¶æ€">
 69:                   <nz-option [nzValue]="BlueprintStatus.PLANNING" nzLabel="è§„åˆ’ä¸­"></nz-option>
 70:                   <nz-option [nzValue]="BlueprintStatus.ACTIVE" nzLabel="è¿›è¡Œä¸­"></nz-option>
 71:                   <nz-option [nzValue]="BlueprintStatus.ON_HOLD" nzLabel="æš‚åœ"></nz-option>
 72:                   <nz-option [nzValue]="BlueprintStatus.COMPLETED" nzLabel="å·²å®Œæˆ"></nz-option>
 73:                   <nz-option [nzValue]="BlueprintStatus.ARCHIVED" nzLabel="å·²å½’æ¡£"></nz-option>
 74:                 </nz-select>
 75:               </nz-form-control>
 76:             </nz-form-item>
 77: 
 78:             <nz-form-item>
 79:               <nz-form-label [nzSpan]="4">å¼€å§‹æ—¥æœŸ</nz-form-label>
 80:               <nz-form-control [nzSpan]="20">
 81:                 <nz-date-picker formControlName="startDate" nzPlaceHolder="è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸ" style="width: 100%;"></nz-date-picker>
 82:               </nz-form-control>
 83:             </nz-form-item>
 84: 
 85:             <nz-form-item>
 86:               <nz-form-label [nzSpan]="4">ç»“æŸæ—¥æœŸ</nz-form-label>
 87:               <nz-form-control [nzSpan]="20">
 88:                 <nz-date-picker formControlName="endDate" nzPlaceHolder="è¯·é€‰æ‹©ç»“æŸæ—¥æœŸ" style="width: 100%;"></nz-date-picker>
 89:               </nz-form-control>
 90:             </nz-form-item>
 91: 
 92:             <nz-form-item>
 93:               <nz-form-label [nzSpan]="4">æè¿°</nz-form-label>
 94:               <nz-form-control [nzSpan]="20">
 95:                 <textarea
 96:                   nz-input
 97:                   formControlName="description"
 98:                   [nzAutosize]="{ minRows: 3, maxRows: 6 }"
 99:                   placeholder="è¯·è¾“å…¥æè¿°"
100:                 ></textarea>
101:               </nz-form-control>
102:             </nz-form-item>
103: 
104:             <nz-form-item>
105:               <nz-form-control [nzOffset]="4" [nzSpan]="20">
106:                 <button nz-button nzType="primary" [disabled]="!form.valid" [nzLoading]="submitting()"> æäº¤ </button>
107:                 <button nz-button nzType="default" (click)="goBack()" style="margin-left: 8px;"> å–æ¶ˆ </button>
108:               </nz-form-control>
109:             </nz-form-item>
110:           </form>
111:         </nz-card>
112:       }
113:     </div>
114:   `
115: })
116: export class BlueprintFormComponent implements OnInit {
117:   blueprintService = inject(BlueprintService);
118:   route = inject(ActivatedRoute);
119:   router = inject(Router);
120:   message = inject(NzMessageService);
121: 
122:   // ä½¿ç”¨ signal ç®¡ç†æäº¤çŠ¶æ€
123:   submitting = signal(false);
124: 
125:   // ä½¿ç”¨ computed åˆ¤æ–­æ˜¯å¦ä¸ºç¼–è¾‘æ¨¡å¼
126:   isEditMode = computed(() => {
127:     const id = this.route.snapshot.paramMap.get('id');
128:     return !!id && id !== 'create';
129:   });
130: 
131:   // å¯¼å‡ºæšä¸¾ä¾›æ¨¡æ¿ä½¿ç”¨
132:   BlueprintStatus = BlueprintStatus;
133: 
134:   @ViewChild(AccountSelectorComponent) accountSelector?: AccountSelectorComponent;
135: 
136:   form = new FormGroup({
137:     name: new FormControl('', [Validators.required]),
138:     projectCode: new FormControl(''),
139:     ownerId: new FormControl('', [Validators.required]),
140:     status: new FormControl(BlueprintStatus.PLANNING, [Validators.required]),
141:     startDate: new FormControl(''),
142:     endDate: new FormControl(''),
143:     description: new FormControl('')
144:   });
145: 
146:   ngOnInit(): void {
147:     if (this.isEditMode()) {
148:       const blueprintId = this.route.snapshot.paramMap.get('id');
149:       if (blueprintId) {
150:         this.loadBlueprint(blueprintId);
151:       }
152:     }
153:   }
154: 
155:   onOwnerAccountChange(accountId: string): void {
156:     // å¤„ç†ç©ºå­—ç¬¦ä¸²å’Œnull/undefined
157:     if (accountId && accountId.trim() !== '') {
158:       this.form.patchValue({ ownerId: accountId });
159:       // æ‰‹åŠ¨è§¦å‘éªŒè¯
160:       this.form.get('ownerId')?.updateValueAndValidity();
161:       // æ‰‹åŠ¨è§¦å‘è¡¨å•éªŒè¯çŠ¶æ€æ›´æ–°
162:       this.form.updateValueAndValidity();
163:     } else {
164:       // æ¸…ç©ºownerIdï¼Œä½†ä¿æŒè¡¨å•éªŒè¯çŠ¶æ€
165:       this.form.patchValue({ ownerId: '' });
166:       this.form.get('ownerId')?.updateValueAndValidity();
167:       this.form.updateValueAndValidity();
168:     }
169:   }
170: 
171:   async loadBlueprint(id: string): Promise<void> {
172:     try {
173:       const blueprint = await this.blueprintService.loadBlueprintById(id);
174:       if (blueprint) {
175:         this.form.patchValue({
176:           name: blueprint.name,
177:           projectCode: blueprint.project_code || '',
178:           ownerId: blueprint.owner_id,
179:           status: blueprint.status as BlueprintStatus,
180:           startDate: blueprint.start_date || '',
181:           endDate: blueprint.end_date || '',
182:           description: blueprint.description || ''
183:         });
184:       }
185:     } catch (error) {
186:       this.message.error('åŠ è½½è“å›¾ä¿¡æ¯å¤±è´¥');
187:     }
188:   }
189: 
190:   async onSubmit(): Promise<void> {
191:     if (!this.form.valid) {
192:       Object.values(this.form.controls).forEach(control => {
193:         if (control.invalid) {
194:           control.markAsDirty();
195:           control.updateValueAndValidity({ onlySelf: true });
196:         }
197:       });
198:       return;
199:     }
200: 
201:     this.submitting.set(true);
202: 
203:     try {
204:       const formValue = this.form.value as BlueprintFormValue;
205: 
206:       if (this.isEditMode()) {
207:         const blueprintId = this.route.snapshot.paramMap.get('id')!;
208:         const updateData = {
209:           name: formValue.name,
210:           project_code: formValue.projectCode || null,
211:           status: formValue.status,
212:           start_date: formValue.startDate || null,
213:           end_date: formValue.endDate || null,
214:           description: formValue.description || null
215:         } as any as BlueprintUpdate;
216:         await this.blueprintService.updateBlueprint(blueprintId, updateData);
217:         this.message.success('æ›´æ–°æˆåŠŸ');
218:       } else {
219:         const insertData = {
220:           name: formValue.name,
221:           project_code: formValue.projectCode || null,
222:           owner_id: formValue.ownerId,
223:           status: formValue.status,
224:           start_date: formValue.startDate || null,
225:           end_date: formValue.endDate || null,
226:           description: formValue.description || null
227:         } as any as BlueprintInsert;
228:         const blueprint = await this.blueprintService.createBlueprint(insertData);
229:         this.message.success('åˆ›å»ºæˆåŠŸ');
230:         this.router.navigate(['/blueprints', blueprint.id]);
231:       }
232:     } catch (error) {
233:       this.message.error(this.isEditMode() ? 'æ›´æ–°å¤±è´¥' : 'åˆ›å»ºå¤±è´¥');
234:     } finally {
235:       this.submitting.set(false);
236:     }
237:   }
238: 
239:   goBack(): void {
240:     this.router.navigate(['/blueprints/list']);
241:   }
242: }
````

## File: src/app/routes/blueprints/list/blueprint-list.component.ts
````typescript
  1: import { Component, OnInit, inject, computed, signal } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { BlueprintStatus } from '@core';
  4: import { STColumn } from '@delon/abc/st';
  5: import { SHARED_IMPORTS, BlueprintService, Blueprint, AccountService, Account, AccountType } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: 
  8: @Component({
  9:   selector: 'app-blueprint-list',
 10:   standalone: true,
 11:   imports: [SHARED_IMPORTS],
 12:   template: `
 13:     <page-header [title]="'è“å›¾ç®¡ç†'">
 14:       <ng-template #extra>
 15:         <button nz-button nzType="primary" (click)="createBlueprint()">
 16:           <span nz-icon nzType="plus"></span>
 17:           æ–°å»ºè“å›¾
 18:         </button>
 19:       </ng-template>
 20:     </page-header>
 21: 
 22:     <nz-card nzTitle="ç®¡ç†ç³»ç»Ÿä¸­çš„æ‰€æœ‰è“å›¾" style="margin-top: 16px;">
 23:       <st
 24:         #st
 25:         [data]="blueprintService.blueprints()"
 26:         [columns]="columns"
 27:         [loading]="blueprintService.loading()"
 28:         [page]="{ front: false, show: true, showSize: true }"
 29:         (change)="onTableChange()"
 30:       >
 31:         <ng-template #status let-record>
 32:           @switch (record.status) {
 33:             @case ('planning') {
 34:               <nz-tag nzColor="default">è§„åˆ’ä¸­</nz-tag>
 35:             }
 36:             @case ('active') {
 37:               <nz-tag nzColor="success">è¿›è¡Œä¸­</nz-tag>
 38:             }
 39:             @case ('on_hold') {
 40:               <nz-tag nzColor="warning">æš‚åœ</nz-tag>
 41:             }
 42:             @case ('completed') {
 43:               <nz-tag nzColor="blue">å·²å®Œæˆ</nz-tag>
 44:             }
 45:             @case ('archived') {
 46:               <nz-tag nzColor="default">å·²å½’æ¡£</nz-tag>
 47:             }
 48:             @default {
 49:               <nz-tag>æœªçŸ¥</nz-tag>
 50:             }
 51:           }
 52:         </ng-template>
 53:         <ng-template #owner let-record>
 54:           @if (getOwnerAccount(record.owner_id)) {
 55:             @switch (getOwnerAccount(record.owner_id)!.type) {
 56:               @case (AccountType.USER) {
 57:                 <span>
 58:                   <span nz-icon nzType="user" style="margin-right: 4px;"></span>
 59:                   {{ getOwnerAccount(record.owner_id)!.name }}
 60:                   <nz-tag nzColor="blue" style="margin-left: 8px;">ä¸ªäºº</nz-tag>
 61:                 </span>
 62:               }
 63:               @case (AccountType.ORGANIZATION) {
 64:                 <span>
 65:                   <span nz-icon nzType="team" style="margin-right: 4px;"></span>
 66:                   {{ getOwnerAccount(record.owner_id)!.name }}
 67:                   <nz-tag nzColor="green" style="margin-left: 8px;">ç»„ç»‡</nz-tag>
 68:                 </span>
 69:               }
 70:               @default {
 71:                 {{ getOwnerAccount(record.owner_id)!.name }}
 72:               }
 73:             }
 74:           } @else {
 75:             <span style="color: #999;">{{ record.owner_id }}</span>
 76:           }
 77:         </ng-template>
 78:       </st>
 79:     </nz-card>
 80:   `
 81: })
 82: export class BlueprintListComponent implements OnInit {
 83:   blueprintService = inject(BlueprintService);
 84:   accountService = inject(AccountService);
 85:   router = inject(Router);
 86:   message = inject(NzMessageService);
 87: 
 88:   // å¯¼å‡ºæšä¸¾ä¾›æ¨¡æ¿ä½¿ç”¨
 89:   AccountType = AccountType;
 90: 
 91:   columns: STColumn[] = [
 92:     { title: 'ID', index: 'id', width: 100 },
 93:     { title: 'é¡¹ç›®åç§°', index: 'name', width: 200 },
 94:     { title: 'é¡¹ç›®ä»£ç ', index: 'project_code', width: 150 },
 95:     { title: 'æ‹¥æœ‰è€…', index: 'owner_id', width: 200, render: 'owner' },
 96:     { title: 'çŠ¶æ€', index: 'status', width: 100, render: 'status' },
 97:     { title: 'å¼€å§‹æ—¥æœŸ', index: 'start_date', type: 'date', width: 120 },
 98:     { title: 'ç»“æŸæ—¥æœŸ', index: 'end_date', type: 'date', width: 120 },
 99:     { title: 'åˆ›å»ºæ—¶é—´', index: 'created_at', type: 'date', width: 180 },
100:     {
101:       title: 'æ“ä½œ',
102:       width: 250,
103:       buttons: [
104:         {
105:           text: 'æŸ¥çœ‹',
106:           click: (record: Blueprint) => this.viewDetail(record.id)
107:         },
108:         {
109:           text: 'ç¼–è¾‘',
110:           click: (record: Blueprint) => this.edit(record.id)
111:         },
112:         {
113:           text: 'åˆ†æ”¯ç®¡ç†',
114:           click: (record: Blueprint) => this.manageBranches(record.id)
115:         },
116:         {
117:           text: 'åˆ é™¤',
118:           type: 'del',
119:           pop: {
120:             title: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè“å›¾å—ï¼Ÿ',
121:             okType: 'danger'
122:           },
123:           click: (record: Blueprint) => this.delete(record.id)
124:         }
125:       ]
126:     }
127:   ];
128: 
129:   ngOnInit(): void {
130:     this.loadData();
131:   }
132: 
133:   async loadData(): Promise<void> {
134:     try {
135:       await this.blueprintService.loadBlueprints();
136:       // åŠ è½½æ‹¥æœ‰è€…è´¦æˆ·ä¿¡æ¯
137:       await this.loadOwnerAccounts();
138:     } catch (error) {
139:       this.message.error('åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
140:     }
141:   }
142: 
143:   async loadOwnerAccounts(): Promise<void> {
144:     const blueprints = this.blueprintService.blueprints();
145:     const ownerIds = [...new Set(blueprints.map(b => b.owner_id))];
146:     if (ownerIds.length > 0) {
147:       try {
148:         await this.accountService.loadAccountsByIds(ownerIds);
149:       } catch (error) {
150:         // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ä¸»æµç¨‹
151:         console.error('åŠ è½½æ‹¥æœ‰è€…è´¦æˆ·ä¿¡æ¯å¤±è´¥:', error);
152:       }
153:     }
154:   }
155: 
156:   getOwnerAccount(ownerId: string): Account | undefined {
157:     return this.accountService.accounts().find(a => a.id === ownerId);
158:   }
159: 
160:   onTableChange(): void {
161:     // è¡¨æ ¼å˜åŒ–å¤„ç†
162:   }
163: 
164:   createBlueprint(): void {
165:     this.router.navigate(['/blueprints/create']);
166:   }
167: 
168:   viewDetail(id: string): void {
169:     this.router.navigate(['/blueprints', id]);
170:   }
171: 
172:   edit(id: string): void {
173:     this.router.navigate(['/blueprints', id, 'edit']);
174:   }
175: 
176:   manageBranches(id: string): void {
177:     this.router.navigate(['/blueprints', id, 'branches']);
178:   }
179: 
180:   async delete(id: string): Promise<void> {
181:     try {
182:       await this.blueprintService.deleteBlueprint(id);
183:       this.message.success('åˆ é™¤æˆåŠŸ');
184:       await this.loadData();
185:     } catch (error) {
186:       this.message.error('åˆ é™¤å¤±è´¥');
187:     }
188:   }
189: }
````

## File: src/app/routes/blueprints/main-branch/blueprint-main-branch.component.ts
````typescript
  1: import { ChangeDetectionStrategy, Component } from '@angular/core';
  2: import { SHARED_IMPORTS } from '@shared';
  3: 
  4: interface BranchSnapshot {
  5:   readonly name: string;
  6:   readonly commits: number;
  7:   readonly reviewer: string;
  8:   readonly status: string;
  9: }
 10: 
 11: interface TimelineItem {
 12:   readonly title: string;
 13:   readonly detail: string;
 14:   readonly color: string;
 15: }
 16: 
 17: @Component({
 18:   selector: 'app-blueprint-main-branch',
 19:   standalone: true,
 20:   imports: [SHARED_IMPORTS],
 21:   template: `
 22:     <nz-page-header [nzTitle]="'ä¸»åˆ†æ”¯ç®¡æ§éª¨æ¶'" [nzSubtitle]="'Git-like æµç¨‹ç¤ºæ„'">
 23:       <nz-page-header-extra>
 24:         <button nz-button nzType="default">
 25:           <span nz-icon nzType="sync"></span>
 26:           ç«‹å³åŒæ­¥
 27:         </button>
 28:         <button nz-button nzType="primary">
 29:           <span nz-icon nzType="safety"></span>
 30:           å»ºç«‹ä¿è­·è¦å‰‡
 31:         </button>
 32:       </nz-page-header-extra>
 33:     </nz-page-header>
 34: 
 35:     <div class="page-section">
 36:       <nz-row [nzGutter]="16">
 37:         <nz-col nzSpan="24">
 38:           <nz-card nzTitle="åˆ†æ”¯å¥åº·åº¦" class="section-card">
 39:             <nz-table [nzData]="branchSnapshots" nzSize="middle" [nzFrontPagination]="false">
 40:               <thead>
 41:                 <tr>
 42:                   <th>åˆ†æ”¯åç¨±</th>
 43:                   <th>æœªåˆä½µæäº¤</th>
 44:                   <th>ä¸»è¦å¯©æ ¸äºº</th>
 45:                   <th>ç‹€æ…‹</th>
 46:                 </tr>
 47:               </thead>
 48:               <tbody>
 49:                 @for (snapshot of branchSnapshots; track snapshot.name) {
 50:                   <tr>
 51:                     <td>{{ snapshot.name }}</td>
 52:                     <td>{{ snapshot.commits }}</td>
 53:                     <td>{{ snapshot.reviewer }}</td>
 54:                     <td>
 55:                       <nz-tag [nzColor]="snapshot.status === 'éœ€è¦è¡Œå‹•' ? 'red' : 'green'">{{ snapshot.status }}</nz-tag>
 56:                     </td>
 57:                   </tr>
 58:                 }
 59:               </tbody>
 60:             </nz-table>
 61:           </nz-card>
 62:         </nz-col>
 63: 
 64:         <nz-col nzXs="24" nzXl="12">
 65:           <nz-card nzTitle="æœ€è¿‘æ´»å‹•" class="section-card">
 66:             <nz-timeline>
 67:               @for (item of activityTimeline; track item.title) {
 68:                 <nz-timeline-item [nzColor]="item.color">
 69:                   <div class="timeline-title">{{ item.title }}</div>
 70:                   <div class="timeline-detail">{{ item.detail }}</div>
 71:                 </nz-timeline-item>
 72:               }
 73:             </nz-timeline>
 74:           </nz-card>
 75:         </nz-col>
 76: 
 77:         <nz-col nzXs="24" nzXl="12">
 78:           <nz-card nzTitle="éƒ¨ç½²çª—å£" class="section-card">
 79:             <nz-calendar [nzFullscreen]="false"></nz-calendar>
 80:             <div class="calendar-helper">
 81:               <nz-badge nzStatus="processing" nzText="ç¶ ç‡ˆå¯éƒ¨ç½²"></nz-badge>
 82:               <nz-badge nzStatus="warning" nzText="éœ€æª¢æŸ¥ä¾è³´"></nz-badge>
 83:             </div>
 84:           </nz-card>
 85:         </nz-col>
 86:       </nz-row>
 87:     </div>
 88:   `,
 89:   styles: [
 90:     `
 91:       :host {
 92:         display: block;
 93:       }
 94: 
 95:       .page-section {
 96:         padding: 16px;
 97:       }
 98: 
 99:       .section-card {
100:         height: 100%;
101:       }
102: 
103:       .timeline-title {
104:         font-weight: 600;
105:       }
106: 
107:       .timeline-detail {
108:         color: rgba(0, 0, 0, 0.55);
109:       }
110: 
111:       .calendar-helper {
112:         margin-top: 12px;
113:         display: flex;
114:         gap: 16px;
115:       }
116:     `
117:   ],
118:   changeDetection: ChangeDetectionStrategy.OnPush
119: })
120: export class BlueprintMainBranchComponent {
121:   protected readonly branchSnapshots: BranchSnapshot[] = [
122:     { name: 'main', commits: 3, reviewer: 'System', status: 'å¥åº·' },
123:     { name: 'release/2402', commits: 7, reviewer: 'Release Guild', status: 'éœ€è¦è¡Œå‹•' },
124:     { name: 'feature/blueprint', commits: 2, reviewer: 'Blueprint Squad', status: 'å¥åº·' }
125:   ];
126: 
127:   protected readonly activityTimeline: TimelineItem[] = [
128:     { title: 'åˆä½µ #123 åˆ° main', detail: 'å¯©æ ¸äººï¼šHoward Â· 10:20', color: 'green' },
129:     { title: 'release/2402 è§¸ç™¼ç•°å¸¸', detail: 'Lint å¤±æ•— Â· 09:05', color: 'red' },
130:     { title: 'Branch Bot è‡ªå‹•åŒæ­¥', detail: 'å®Œæˆ staging å°é½Š Â· 08:12', color: 'blue' }
131:   ];
132: }
````

## File: src/app/routes/blueprints/pull-requests/pull-request-center.component.ts
````typescript
  1: import { ChangeDetectionStrategy, Component } from '@angular/core';
  2: import { SHARED_IMPORTS } from '@shared';
  3: 
  4: interface PullRequest {
  5:   readonly title: string;
  6:   readonly author: string;
  7:   readonly reviewers: string[];
  8:   readonly status: 'open' | 'review' | 'merged';
  9: }
 10: 
 11: @Component({
 12:   selector: 'app-blueprint-pull-request-center',
 13:   standalone: true,
 14:   imports: [SHARED_IMPORTS],
 15:   template: `
 16:     <nz-page-header [nzTitle]="'Pull Request ä¸­å¿ƒéª¨æ¶'" [nzSubtitle]="'åˆ—å‡ºå¾…å¯©æ ¸é …ç›®'">
 17:       <nz-page-header-extra>
 18:         <button nz-button nzType="default">
 19:           <span nz-icon nzType="filter"></span>
 20:           ç¯©é¸
 21:         </button>
 22:         <button nz-button nzType="primary">
 23:           <span nz-icon nzType="plus"></span>
 24:           å»ºç«‹ PR
 25:         </button>
 26:       </nz-page-header-extra>
 27:     </nz-page-header>
 28: 
 29:     <div class="page-section">
 30:       <nz-card nzTitle="PR æ¸…å–®">
 31:         <nz-list [nzDataSource]="pullRequests" nzItemLayout="vertical">
 32:           <ng-template #renderItem let-item>
 33:             <nz-list-item>
 34:               <nz-list-item-meta [nzTitle]="item.title" [nzDescription]="'ä½œè€…ï¼š' + item.author"></nz-list-item-meta>
 35:               <div class="pr-meta">
 36:                 <nz-tag nzColor="blue" *nzStringTemplateOutlet="statusText(item.status)">
 37:                   {{ statusText(item.status) }}
 38:                 </nz-tag>
 39:                 <div class="reviewers">
 40:                   @for (reviewer of item.reviewers; track reviewer) {
 41:                     <nz-avatar nzSize="small" [nzText]="reviewer[0]"></nz-avatar>
 42:                   }
 43:                   <span class="reviewer-label">å¯©æ ¸äºº</span>
 44:                 </div>
 45:               </div>
 46:               <div class="pr-actions">
 47:                 <button nz-button nzType="default" nzSize="small">æŸ¥çœ‹å·®ç•°</button>
 48:                 <button nz-button nzType="primary" nzSize="small">é€²å…¥å¯©æ ¸</button>
 49:               </div>
 50:             </nz-list-item>
 51:           </ng-template>
 52:         </nz-list>
 53:       </nz-card>
 54:     </div>
 55:   `,
 56:   styles: [
 57:     `
 58:       :host {
 59:         display: block;
 60:       }
 61: 
 62:       .page-section {
 63:         padding: 16px;
 64:       }
 65: 
 66:       .pr-meta {
 67:         display: flex;
 68:         align-items: center;
 69:         gap: 16px;
 70:       }
 71: 
 72:       .reviewers {
 73:         display: flex;
 74:         align-items: center;
 75:         gap: 8px;
 76:       }
 77: 
 78:       .reviewer-label {
 79:         font-size: 12px;
 80:         color: rgba(0, 0, 0, 0.45);
 81:       }
 82: 
 83:       .pr-actions {
 84:         margin-top: 12px;
 85:         display: flex;
 86:         gap: 8px;
 87:       }
 88:     `
 89:   ],
 90:   changeDetection: ChangeDetectionStrategy.OnPush
 91: })
 92: export class PullRequestCenterComponent {
 93:   protected readonly pullRequests: PullRequest[] = [
 94:     { title: 'èª¿æ•´ä¸»åˆ†æ”¯åŒæ­¥ç­–ç•¥', author: 'Alice', reviewers: ['Howard', 'Leo'], status: 'review' },
 95:     { title: 'Account æ¨¡çµ„æ–°å¢æ¬Šé™', author: 'Kevin', reviewers: ['Nina'], status: 'open' },
 96:     { title: 'æ–‡ä»¶ç®¡ç†ä¸Šç·šç‰ˆæœ¬', author: 'Mia', reviewers: ['Olivia', 'Paul'], status: 'merged' }
 97:   ];
 98: 
 99:   protected statusText(status: PullRequest['status']): string {
100:     switch (status) {
101:       case 'open':
102:         return 'å¾…è™•ç†';
103:       case 'review':
104:         return 'å¯©æ ¸ä¸­';
105:       case 'merged':
106:         return 'å·²åˆä½µ';
107:       default:
108:         return 'æœªçŸ¥';
109:     }
110:   }
111: }
````

## File: src/app/routes/blueprints/review/blueprint-review-workspace.component.ts
````typescript
  1: import { ChangeDetectionStrategy, Component } from '@angular/core';
  2: import { SHARED_IMPORTS } from '@shared';
  3: 
  4: interface ReviewNote {
  5:   readonly author: string;
  6:   readonly content: string;
  7:   readonly datetime: string;
  8: }
  9: 
 10: @Component({
 11:   selector: 'app-blueprint-review-workspace',
 12:   standalone: true,
 13:   imports: [SHARED_IMPORTS],
 14:   template: `
 15:     <nz-page-header [nzTitle]="'PR å¯©æ ¸å·¥ä½œå€éª¨æ¶'" [nzSubtitle]="'æ”¯æ´è©•è«–èˆ‡ä»»å‹™åˆ†æ´¾'">
 16:       <nz-page-header-extra>
 17:         <button nz-button nzType="default">
 18:           <span nz-icon nzType="highlight"></span>
 19:           åŠ å…¥æ‰¹è¨»
 20:         </button>
 21:         <button nz-button nzType="primary">
 22:           <span nz-icon nzType="check-circle"></span>
 23:           é€šéå¯©æ ¸
 24:         </button>
 25:       </nz-page-header-extra>
 26:     </nz-page-header>
 27: 
 28:     <div class="page-section">
 29:       <nz-row [nzGutter]="16">
 30:         <nz-col nzXs="24" nzXl="14">
 31:           <nz-card nzTitle="Diff å€å¡Šï¼ˆç¤ºæ„ï¼‰">
 32:             <pre class="code-preview">{{ diffPreview }}</pre>
 33:           </nz-card>
 34: 
 35:           <nz-card nzTitle="å¯©æ ¸è©•è«–" class="section-card">
 36:             @for (note of reviewNotes; track note.datetime) {
 37:               <nz-comment [nzAuthor]="note.author" [nzDatetime]="note.datetime">
 38:                 <nz-comment-content>{{ note.content }}</nz-comment-content>
 39:               </nz-comment>
 40:             }
 41:           </nz-card>
 42:         </nz-col>
 43: 
 44:         <nz-col nzXs="24" nzXl="10">
 45:           <nz-card nzTitle="å¾…è¾¦äº‹é …" class="section-card">
 46:             <nz-list nzBordered>
 47:               <nz-list-item>
 48:                 <label nz-checkbox [ngModel]="false">è£œå…… Branch ç­–ç•¥æ–‡ä»¶</label>
 49:               </nz-list-item>
 50:               <nz-list-item>
 51:                 <label nz-checkbox [ngModel]="true">é©—è­‰è‡ªå‹•åŒ–è…³æœ¬è¼¸å‡º</label>
 52:               </nz-list-item>
 53:               <nz-list-item>
 54:                 <label nz-checkbox [ngModel]="false">æ›´æ–°ç‰ˆæœ¬ log</label>
 55:               </nz-list-item>
 56:             </nz-list>
 57:           </nz-card>
 58: 
 59:           <nz-card nzTitle="å¯©æ ¸è¨­å®š" class="section-card">
 60:             <form nz-form nzLayout="vertical">
 61:               <nz-form-item>
 62:                 <nz-form-label>å„ªå…ˆåº¦</nz-form-label>
 63:                 <nz-form-control>
 64:                   <nz-segmented [nzOptions]="priorityOptions"></nz-segmented>
 65:                 </nz-form-control>
 66:               </nz-form-item>
 67: 
 68:               <nz-form-item>
 69:                 <nz-form-label>é€šçŸ¥é »ç‡</nz-form-label>
 70:                 <nz-form-control>
 71:                   <nz-radio-group nzName="notify" nzDirection="vertical">
 72:                     <label nz-radio nzValue="instant">å³æ™‚</label>
 73:                     <label nz-radio nzValue="hourly">æ¯å°æ™‚</label>
 74:                     <label nz-radio nzValue="daily">æ¯æ—¥æ‘˜è¦</label>
 75:                   </nz-radio-group>
 76:                 </nz-form-control>
 77:               </nz-form-item>
 78:             </form>
 79:           </nz-card>
 80:         </nz-col>
 81:       </nz-row>
 82:     </div>
 83:   `,
 84:   styles: [
 85:     `
 86:       :host {
 87:         display: block;
 88:       }
 89: 
 90:       .page-section {
 91:         padding: 16px;
 92:       }
 93: 
 94:       .code-preview {
 95:         background: #0f172a;
 96:         color: #f8fafc;
 97:         padding: 16px;
 98:         border-radius: 6px;
 99:         font-family: 'Fira Code', Consolas, monospace;
100:         font-size: 13px;
101:         min-height: 260px;
102:         white-space: pre-wrap;
103:       }
104: 
105:       nz-comment {
106:         border-bottom: 1px solid rgba(0, 0, 0, 0.06);
107:         padding-bottom: 12px;
108:         margin-bottom: 12px;
109:       }
110:     `
111:   ],
112:   changeDetection: ChangeDetectionStrategy.OnPush
113: })
114: export class BlueprintReviewWorkspaceComponent {
115:   protected diffPreview = `diff --git a/src/app/example.ts b/src/app/example.ts
116: @@ -1,3 +1,6 @@
117:  export class ExampleComponent {
118: -  status = 'draft';
119: +  status = 'ready';
120: +  syncBranches(): void {
121: +    // TODO: call blueprint API
122: +  }
123:  }`;
124: 
125:   protected readonly reviewNotes: ReviewNote[] = [
126:     { author: 'Reviewer A', content: 'è«‹åœ¨åŒæ­¥å‰åŠ å…¥æ¬Šé™æª¢æŸ¥ã€‚', datetime: 'ä»Šå¤© 10:20' },
127:     { author: 'Reviewer B', content: 'å»ºè­°æ‹†åˆ†ç‚ºå…©å€‹æäº¤ï¼Œæ–¹ä¾¿å›æº¯ã€‚', datetime: 'ä»Šå¤© 09:48' }
128:   ];
129: 
130:   protected readonly priorityOptions = [
131:     { label: 'ä½', value: 'low' },
132:     { label: 'ä¸­', value: 'medium' },
133:     { label: 'é«˜', value: 'high' }
134:   ];
135: }
````

## File: src/app/routes/blueprints/review/pr-review.component.ts
````typescript
 1: import { Component, OnInit, inject } from '@angular/core';
 2: import { ActivatedRoute, Router } from '@angular/router';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: 
 6: @Component({
 7:   selector: 'app-pr-review',
 8:   standalone: true,
 9:   imports: [SHARED_IMPORTS],
10:   template: `
11:     <page-header [title]="'PR å®¡æŸ¥'">
12:       <ng-template #breadcrumb>
13:         <nz-breadcrumb>
14:           <nz-breadcrumb-item>
15:             <a routerLink="/blueprints">è“å›¾åˆ—è¡¨</a>
16:           </nz-breadcrumb-item>
17:           <nz-breadcrumb-item>
18:             <a [routerLink]="['/blueprints', blueprintId, 'pull-requests']">Pull Requests</a>
19:           </nz-breadcrumb-item>
20:           <nz-breadcrumb-item>å®¡æŸ¥</nz-breadcrumb-item>
21:         </nz-breadcrumb>
22:       </ng-template>
23:     </page-header>
24: 
25:     <nz-card nzTitle="Pull Request å®¡æŸ¥" style="margin-top: 16px;">
26:       <nz-alert
27:         nzType="info"
28:         nzMessage="PR å®¡æŸ¥åŠŸèƒ½å¼€å‘ä¸­"
29:         nzDescription="æ­¤é¡µé¢å°†ç”¨äºå®¡æŸ¥å’Œæ‰¹å‡† Pull Requestã€‚"
30:         [nzShowIcon]="true"
31:         style="margin-bottom: 16px;"
32:       ></nz-alert>
33: 
34:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
35:     </nz-card>
36:   `
37: })
38: export class PrReviewComponent implements OnInit {
39:   route = inject(ActivatedRoute);
40:   router = inject(Router);
41:   message = inject(NzMessageService);
42: 
43:   blueprintId = '';
44:   prId = '';
45: 
46:   ngOnInit(): void {
47:     this.blueprintId = this.route.snapshot.paramMap.get('id') || '';
48:     this.prId = this.route.snapshot.paramMap.get('prId') || '';
49:     if (!this.blueprintId || !this.prId) {
50:       this.message.error('è“å›¾IDæˆ–PR IDä¸å­˜åœ¨');
51:       this.router.navigate(['/blueprints']);
52:     }
53:   }
54: }
````

## File: src/app/routes/blueprints/settings-shell/blueprint-settings-shell.component.ts
````typescript
  1: import { ChangeDetectionStrategy, Component } from '@angular/core';
  2: import { SHARED_IMPORTS } from '@shared';
  3: 
  4: interface SettingTab {
  5:   readonly key: string;
  6:   readonly title: string;
  7:   readonly description: string;
  8: }
  9: 
 10: interface Reviewer {
 11:   readonly name: string;
 12:   readonly role: string;
 13:   readonly availability: string;
 14: }
 15: 
 16: @Component({
 17:   selector: 'app-blueprint-settings-shell',
 18:   standalone: true,
 19:   imports: [SHARED_IMPORTS],
 20:   template: `
 21:     <nz-page-header [nzTitle]="'è—åœ–è¨­å®šéª¨æ¶'" [nzSubtitle]="'ä½¿ç”¨ ng-zorro form æ¨£æ¿å‘ˆç¾é…ç½®å€'">
 22:       <nz-page-header-extra>
 23:         <button nz-button nzType="default">
 24:           <span nz-icon nzType="history"></span>
 25:           æŸ¥çœ‹ç‰ˆæœ¬
 26:         </button>
 27:         <button nz-button nzType="primary">
 28:           <span nz-icon nzType="save"></span>
 29:           å¿«é€Ÿå„²å­˜
 30:         </button>
 31:       </nz-page-header-extra>
 32:     </nz-page-header>
 33: 
 34:     <div class="page-section">
 35:       <nz-card nzTitle="è¨­å®šé¢æ¿" class="section-card">
 36:         <nz-tabset nzTabPosition="top" nzType="line">
 37:           @for (tab of settingTabs; track tab.key) {
 38:             <nz-tab [nzTitle]="tab.title">
 39:               <p class="tab-description">{{ tab.description }}</p>
 40: 
 41:               <form nz-form nzLayout="vertical" class="settings-form">
 42:                 <nz-form-item>
 43:                   <nz-form-label>åç¨±</nz-form-label>
 44:                   <nz-form-control>
 45:                     <input nz-input [placeholder]="'è¼¸å…¥ ' + tab.title + ' åç¨±'" />
 46:                   </nz-form-control>
 47:                 </nz-form-item>
 48: 
 49:                 <nz-form-item>
 50:                   <nz-form-label>æè¿°</nz-form-label>
 51:                   <nz-form-control>
 52:                     <textarea nz-input rows="3" placeholder="è£œå……èªªæ˜ï¼é©ç”¨ç¯„åœ"></textarea>
 53:                   </nz-form-control>
 54:                 </nz-form-item>
 55: 
 56:                 <nz-form-item>
 57:                   <nz-form-label>è²¬ä»»ç¾¤çµ„</nz-form-label>
 58:                   <nz-form-control>
 59:                     <nz-select nzMode="multiple" nzPlaceHolder="é¸æ“‡ç¾¤çµ„">
 60:                       <nz-option nzValue="owner" nzLabel="Owner Guild"></nz-option>
 61:                       <nz-option nzValue="reviewer" nzLabel="Reviewer Squad"></nz-option>
 62:                       <nz-option nzValue="ops" nzLabel="Ops Support"></nz-option>
 63:                     </nz-select>
 64:                   </nz-form-control>
 65:                 </nz-form-item>
 66: 
 67:                 <div class="actions">
 68:                   <button nz-button nzType="default">è‰ç¨¿</button>
 69:                   <button nz-button nzType="primary">å„²å­˜ {{ tab.title }}</button>
 70:                 </div>
 71:               </form>
 72:             </nz-tab>
 73:           }
 74:         </nz-tabset>
 75:       </nz-card>
 76: 
 77:       <nz-card nzTitle="é è¨­å¯©æ ¸äºº" class="section-card">
 78:         <nz-list [nzDataSource]="reviewers" nzItemLayout="horizontal">
 79:           <ng-template #renderItem let-item>
 80:             <nz-list-item>
 81:               <nz-list-item-meta
 82:                 nzAvatar="https://gw.alipayobjects.com/zos/rmsportal/ODTLcjxAfvqbxHnVXCYX.png"
 83:                 [nzTitle]="item.name"
 84:                 [nzDescription]="item.role"
 85:               ></nz-list-item-meta>
 86:               <div class="availability">
 87:                 <span nz-typography>{{ item.availability }}</span>
 88:                 <button nz-button nzType="link">èª¿æ•´</button>
 89:               </div>
 90:             </nz-list-item>
 91:           </ng-template>
 92:         </nz-list>
 93:       </nz-card>
 94:     </div>
 95:   `,
 96:   styles: [
 97:     `
 98:       :host {
 99:         display: block;
100:       }
101: 
102:       .page-section {
103:         padding: 16px;
104:         display: flex;
105:         flex-direction: column;
106:         gap: 16px;
107:       }
108: 
109:       .tab-description {
110:         color: rgba(0, 0, 0, 0.55);
111:         margin-bottom: 16px;
112:       }
113: 
114:       .settings-form {
115:         max-width: 520px;
116:       }
117: 
118:       .actions {
119:         display: flex;
120:         gap: 8px;
121:         justify-content: flex-end;
122:       }
123: 
124:       .availability {
125:         display: flex;
126:         align-items: center;
127:         gap: 12px;
128:       }
129:     `
130:   ],
131:   changeDetection: ChangeDetectionStrategy.OnPush
132: })
133: export class BlueprintSettingsShellComponent {
134:   protected readonly settingTabs: SettingTab[] = [
135:     { key: 'metadata', title: 'åŸºæœ¬è³‡è¨Š', description: 'ç¶­è­·è—åœ–åç¨±ã€èªªæ˜èˆ‡ä¸»è¦è² è²¬äººã€‚' },
136:     { key: 'permissions', title: 'æ¬Šé™ç­–ç•¥', description: 'è¨­å®šå¯è¨ªå•èˆ‡æäº¤è®Šæ›´çš„æˆå“¡ç¾¤çµ„ã€‚' },
137:     { key: 'automation', title: 'è‡ªå‹•åŒ–ä»»å‹™', description: 'å®šç¾©åˆ†æ”¯åŒæ­¥ã€å¯©æ ¸æé†’èˆ‡åˆä½µç­–ç•¥ã€‚' }
138:   ];
139: 
140:   protected readonly reviewers: Reviewer[] = [
141:     { name: 'Evelyn', role: 'æµç¨‹å¯©æ ¸', availability: 'æ¯æ—¥ 10:00 - 18:00' },
142:     { name: 'Howard', role: 'ä¸»åˆ†æ”¯ç¶­é‹', availability: 'å°ˆæ¡ˆæœŸé–“å…¨æ™‚æ®µ' },
143:     { name: 'Lucas', role: 'DevOps', availability: 'éœ€æå‰é ç´„' }
144:   ];
145: }
````

## File: src/app/routes/blueprints/settings/blueprint-settings.component.ts
````typescript
 1: import { Component, OnInit, inject } from '@angular/core';
 2: import { ActivatedRoute, Router } from '@angular/router';
 3: import { SHARED_IMPORTS, BlueprintService } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: 
 6: @Component({
 7:   selector: 'app-blueprint-settings',
 8:   standalone: true,
 9:   imports: [SHARED_IMPORTS],
10:   template: `
11:     <page-header [title]="'è“å›¾è®¾ç½®'">
12:       <ng-template #breadcrumb>
13:         <nz-breadcrumb>
14:           <nz-breadcrumb-item>
15:             <a routerLink="/blueprints">è“å›¾åˆ—è¡¨</a>
16:           </nz-breadcrumb-item>
17:           <nz-breadcrumb-item>è®¾ç½®</nz-breadcrumb-item>
18:         </nz-breadcrumb>
19:       </ng-template>
20:     </page-header>
21: 
22:     <nz-card nzTitle="è“å›¾é…ç½®" style="margin-top: 16px;">
23:       <nz-alert
24:         nzType="info"
25:         nzMessage="è“å›¾è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­"
26:         nzDescription="æ­¤é¡µé¢å°†ç”¨äºé…ç½®è“å›¾çš„å„ç§è®¾ç½®é€‰é¡¹ã€‚"
27:         [nzShowIcon]="true"
28:         style="margin-bottom: 16px;"
29:       ></nz-alert>
30: 
31:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
32:     </nz-card>
33:   `
34: })
35: export class BlueprintSettingsComponent implements OnInit {
36:   blueprintService = inject(BlueprintService);
37:   route = inject(ActivatedRoute);
38:   router = inject(Router);
39:   message = inject(NzMessageService);
40: 
41:   blueprintId = '';
42: 
43:   ngOnInit(): void {
44:     this.blueprintId = this.route.snapshot.paramMap.get('id') || '';
45:     if (!this.blueprintId) {
46:       this.message.error('è“å›¾IDä¸å­˜åœ¨');
47:       this.router.navigate(['/blueprints']);
48:     }
49:   }
50: }
````

## File: src/app/routes/bots/config/bot-config.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-bot-config',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'æœºå™¨äººé…ç½®'"></page-header>
11: 
12:     <nz-card nzTitle="æœºå™¨äººé…ç½®" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="æœºå™¨äººé…ç½®åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†é…ç½®æœºå™¨äººè„šæœ¬ã€è§¦å‘æ¡ä»¶ä¸å®‰å…¨ç­–ç•¥ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class BotConfigComponent {}
````

## File: src/app/routes/bots/executions/bot-execution.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-bot-execution',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'æ‰§è¡Œæ—¥å¿—'"></page-header>
11: 
12:     <nz-card nzTitle="æœºå™¨äººæ‰§è¡Œæ—¥å¿—" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="æ‰§è¡Œæ—¥å¿—åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†å±•ç¤ºæœºå™¨äººä»»åŠ¡æ‰§è¡Œç»“æœä¸å¼‚å¸¸è¯¦æƒ…ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class BotExecutionComponent {}
````

## File: src/app/routes/bots/list/bot-list.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-bot-list',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'æœºå™¨äººåˆ—è¡¨'">
11:       <ng-template #extra>
12:         <button nz-button nzType="primary" routerLink="/bots/config">
13:           <span nz-icon nzType="plus"></span>
14:           åˆ›å»ºæœºå™¨äºº
15:         </button>
16:       </ng-template>
17:     </page-header>
18: 
19:     <nz-card nzTitle="æœºå™¨äººåˆ—è¡¨" style="margin-top: 16px;">
20:       <nz-alert
21:         nzType="info"
22:         nzMessage="æœºå™¨äººåˆ—è¡¨åŠŸèƒ½å»ºè®¾ä¸­"
23:         nzDescription="æ­¤é¡µé¢å°†å±•ç¤ºæ‰€æœ‰è‡ªåŠ¨åŒ–ä»»åŠ¡æœºå™¨äººåŠå…¶çŠ¶æ€ã€‚"
24:         [nzShowIcon]="true"
25:         style="margin-bottom: 16px;"
26:       ></nz-alert>
27:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
28:     </nz-card>
29:   `
30: })
31: export class BotListComponent {}
````

## File: src/app/routes/collaboration/detail/collaboration-detail.component.ts
````typescript
  1: import { Component, OnInit, inject, computed } from '@angular/core';
  2: import { ActivatedRoute, Router } from '@angular/router';
  3: import { CollaborationType, CollaborationStatus } from '@core';
  4: import { SHARED_IMPORTS, CollaborationService, OrganizationCollaboration } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: 
  7: @Component({
  8:   selector: 'app-collaboration-detail',
  9:   standalone: true,
 10:   imports: [SHARED_IMPORTS],
 11:   template: `
 12:     <page-header [title]="'åä½œå…³ç³»è¯¦æƒ…'">
 13:       <ng-template #extra>
 14:         <button nz-button nzType="default" (click)="goBack()" style="margin-right: 8px;">
 15:           <span nz-icon nzType="arrow-left"></span>
 16:           è¿”å›
 17:         </button>
 18:         @if (collaboration()) {
 19:           <button nz-button nzType="primary" (click)="edit()" style="margin-right: 8px;">
 20:             <span nz-icon nzType="edit"></span>
 21:             ç¼–è¾‘
 22:           </button>
 23:           <button nz-button nzDanger (click)="delete()">
 24:             <span nz-icon nzType="delete"></span>
 25:             åˆ é™¤
 26:           </button>
 27:         }
 28:       </ng-template>
 29:     </page-header>
 30: 
 31:     @if (collaborationService.loading()) {
 32:       <nz-spin nzSimple [nzSize]="'large'" style="display: block; padding: 50px; text-align: center;">
 33:         <ng-template #indicator>
 34:           <span nz-icon nzType="loading" style="font-size: 24px;"></span>
 35:         </ng-template>
 36:       </nz-spin>
 37:     } @else if (collaborationService.error()) {
 38:       <nz-alert
 39:         nzType="error"
 40:         [nzMessage]="'åŠ è½½å¤±è´¥'"
 41:         [nzDescription]="collaborationService.error()"
 42:         nzShowIcon
 43:         style="margin: 16px;"
 44:       ></nz-alert>
 45:     } @else if (collaboration()) {
 46:       <div style="padding: 16px;">
 47:         <!-- åä½œå…³ç³»åŸºæœ¬ä¿¡æ¯ -->
 48:         <nz-card nzTitle="åŸºæœ¬ä¿¡æ¯" style="margin-bottom: 16px;">
 49:           <nz-descriptions nzBordered [nzColumn]="{ xxl: 3, xl: 2, lg: 2, md: 1, sm: 1, xs: 1 }">
 50:             <nz-descriptions-item nzTitle="ID">{{ collaboration()!.id }}</nz-descriptions-item>
 51:             <nz-descriptions-item nzTitle="è“å›¾ID">{{ collaboration()!.blueprint_id }}</nz-descriptions-item>
 52:             <nz-descriptions-item nzTitle="æ‹¥æœ‰è€…ç»„ç»‡">{{ collaboration()!.owner_org_id }}</nz-descriptions-item>
 53:             <nz-descriptions-item nzTitle="åä½œç»„ç»‡">{{ collaboration()!.collaborator_org_id }}</nz-descriptions-item>
 54:             <nz-descriptions-item nzTitle="åä½œç±»å‹">
 55:               @switch (collaboration()!.collaboration_type) {
 56:                 @case ('contractor') {
 57:                   <nz-tag nzColor="blue">æ‰¿æ½å•†</nz-tag>
 58:                 }
 59:                 @case ('subcontractor') {
 60:                   <nz-tag nzColor="cyan">æ¬¡æ‰¿æ½å•†</nz-tag>
 61:                 }
 62:                 @case ('consultant') {
 63:                   <nz-tag nzColor="purple">é¡¾é—®</nz-tag>
 64:                 }
 65:                 @case ('partner') {
 66:                   <nz-tag nzColor="green">åˆä½œä¼™ä¼´</nz-tag>
 67:                 }
 68:                 @default {
 69:                   <nz-tag>æœªçŸ¥</nz-tag>
 70:                 }
 71:               }
 72:             </nz-descriptions-item>
 73:             <nz-descriptions-item nzTitle="çŠ¶æ€">
 74:               @switch (collaboration()!.status) {
 75:                 @case ('pending') {
 76:                   <nz-tag nzColor="orange">å¾…å¤„ç†</nz-tag>
 77:                 }
 78:                 @case ('active') {
 79:                   <nz-tag nzColor="success">æ´»è·ƒ</nz-tag>
 80:                 }
 81:                 @case ('suspended') {
 82:                   <nz-tag nzColor="warning">å·²æš‚åœ</nz-tag>
 83:                 }
 84:                 @case ('ended') {
 85:                   <nz-tag nzColor="default">å·²ç»“æŸ</nz-tag>
 86:                 }
 87:                 @default {
 88:                   <nz-tag>æœªçŸ¥</nz-tag>
 89:                 }
 90:               }
 91:             </nz-descriptions-item>
 92:             <nz-descriptions-item nzTitle="åˆåŒå¼€å§‹æ—¥æœŸ">
 93:               {{ collaboration()!.contract_start_date ? (collaboration()!.contract_start_date | date: 'yyyy-MM-dd') : '-' }}
 94:             </nz-descriptions-item>
 95:             <nz-descriptions-item nzTitle="åˆåŒç»“æŸæ—¥æœŸ">
 96:               {{ collaboration()!.contract_end_date ? (collaboration()!.contract_end_date | date: 'yyyy-MM-dd') : '-' }}
 97:             </nz-descriptions-item>
 98:             <nz-descriptions-item nzTitle="åˆ›å»ºæ—¶é—´">
 99:               {{ collaboration()!.created_at | date: 'yyyy-MM-dd HH:mm:ss' }}
100:             </nz-descriptions-item>
101:             <nz-descriptions-item nzTitle="æ›´æ–°æ—¶é—´">
102:               {{ collaboration()!.updated_at | date: 'yyyy-MM-dd HH:mm:ss' }}
103:             </nz-descriptions-item>
104:           </nz-descriptions>
105:         </nz-card>
106:       </div>
107:     } @else {
108:       <nz-empty nzNotFoundContent="åä½œå…³ç³»ä¸å­˜åœ¨"></nz-empty>
109:     }
110:   `
111: })
112: export class CollaborationDetailComponent implements OnInit {
113:   collaborationService = inject(CollaborationService);
114:   route = inject(ActivatedRoute);
115:   router = inject(Router);
116:   message = inject(NzMessageService);
117: 
118:   // ä½¿ç”¨ computed ä» Service è·å–åä½œå…³ç³»ä¿¡æ¯
119:   collaboration = computed(() => this.collaborationService.selectedCollaboration());
120: 
121:   // å¯¼å‡ºæšä¸¾ä¾›æ¨¡æ¿ä½¿ç”¨
122:   CollaborationType = CollaborationType;
123:   CollaborationStatus = CollaborationStatus;
124: 
125:   ngOnInit(): void {
126:     const collaborationId = this.route.snapshot.paramMap.get('id');
127:     if (collaborationId) {
128:       this.loadCollaboration(collaborationId);
129:     }
130:   }
131: 
132:   async loadCollaboration(id: string): Promise<void> {
133:     try {
134:       const collaboration = await this.collaborationService.loadCollaborationById(id);
135:       if (!collaboration) {
136:         this.message.warning('åä½œå…³ç³»ä¸å­˜åœ¨');
137:         this.goBack();
138:       }
139:     } catch (error) {
140:       this.message.error('åŠ è½½åä½œå…³ç³»è¯¦æƒ…å¤±è´¥');
141:     }
142:   }
143: 
144:   goBack(): void {
145:     this.router.navigate(['/collaboration/list']);
146:   }
147: 
148:   edit(): void {
149:     if (this.collaboration()) {
150:       this.router.navigate(['/collaboration', this.collaboration()!.id, 'edit']);
151:     }
152:   }
153: 
154:   async delete(): Promise<void> {
155:     if (!this.collaboration()) {
156:       return;
157:     }
158: 
159:     if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤åä½œå…³ç³»å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
160:       try {
161:         await this.collaborationService.deleteCollaboration(this.collaboration()!.id);
162:         this.message.success('åˆ é™¤æˆåŠŸ');
163:         this.goBack();
164:       } catch (error) {
165:         this.message.error('åˆ é™¤å¤±è´¥');
166:       }
167:     }
168:   }
169: }
````

## File: src/app/routes/collaboration/form/collaboration-form.component.ts
````typescript
  1: import { Component, OnInit, inject, computed } from '@angular/core';
  2: import { FormControl, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
  3: import { ActivatedRoute, Router } from '@angular/router';
  4: import { CollaborationType, CollaborationStatus } from '@core';
  5: import {
  6:   SHARED_IMPORTS,
  7:   CollaborationService,
  8:   OrganizationCollaboration,
  9:   OrganizationCollaborationInsert,
 10:   OrganizationCollaborationUpdate
 11: } from '@shared';
 12: import { NzMessageService } from 'ng-zorro-antd/message';
 13: 
 14: /**
 15:  * åä½œå…³ç³»è¡¨å•ç±»å‹å®šä¹‰
 16:  */
 17: interface CollaborationFormValue {
 18:   blueprint_id: string;
 19:   owner_org_id: string;
 20:   collaborator_org_id: string;
 21:   collaboration_type: CollaborationType;
 22:   status?: CollaborationStatus;
 23:   contract_start_date?: string | null;
 24:   contract_end_date?: string | null;
 25:   notes?: string | null;
 26: }
 27: 
 28: @Component({
 29:   selector: 'app-collaboration-form',
 30:   standalone: true,
 31:   imports: [SHARED_IMPORTS, ReactiveFormsModule],
 32:   template: `
 33:     <page-header [title]="isEditMode() ? 'ç¼–è¾‘åä½œå…³ç³»' : 'åˆ›å»ºåä½œå…³ç³»'">
 34:       <ng-template #extra>
 35:         <button nz-button nzType="default" (click)="goBack()" style="margin-right: 8px;">
 36:           <span nz-icon nzType="arrow-left"></span>
 37:           è¿”å›
 38:         </button>
 39:       </ng-template>
 40:     </page-header>
 41: 
 42:     <div style="padding: 16px;">
 43:       @if (collaborationService.loading()) {
 44:         <nz-spin nzSimple [nzSize]="'large'" style="display: block; padding: 50px; text-align: center;">
 45:           <ng-template #indicator>
 46:             <span nz-icon nzType="loading" style="font-size: 24px;"></span>
 47:           </ng-template>
 48:         </nz-spin>
 49:       } @else {
 50:         <nz-card [nzTitle]="isEditMode() ? 'ç¼–è¾‘åä½œå…³ç³»ä¿¡æ¯' : 'åˆ›å»ºæ–°åä½œå…³ç³»'">
 51:           <form nz-form [formGroup]="form" (ngSubmit)="onSubmit()">
 52:             <nz-form-item>
 53:               <nz-form-label [nzSpan]="4" nzRequired>è“å›¾ID</nz-form-label>
 54:               <nz-form-control [nzSpan]="20" [nzErrorTip]="'è¯·è¾“å…¥è“å›¾ID'">
 55:                 <input nz-input formControlName="blueprint_id" placeholder="è¯·è¾“å…¥è“å›¾ID" />
 56:               </nz-form-control>
 57:             </nz-form-item>
 58: 
 59:             <nz-form-item>
 60:               <nz-form-label [nzSpan]="4" nzRequired>æ‹¥æœ‰è€…ç»„ç»‡ID</nz-form-label>
 61:               <nz-form-control [nzSpan]="20" [nzErrorTip]="'è¯·è¾“å…¥æ‹¥æœ‰è€…ç»„ç»‡ID'">
 62:                 <input nz-input formControlName="owner_org_id" placeholder="è¯·è¾“å…¥æ‹¥æœ‰è€…ç»„ç»‡ID" />
 63:               </nz-form-control>
 64:             </nz-form-item>
 65: 
 66:             <nz-form-item>
 67:               <nz-form-label [nzSpan]="4" nzRequired>åä½œç»„ç»‡ID</nz-form-label>
 68:               <nz-form-control [nzSpan]="20" [nzErrorTip]="'è¯·è¾“å…¥åä½œç»„ç»‡ID'">
 69:                 <input nz-input formControlName="collaborator_org_id" placeholder="è¯·è¾“å…¥åä½œç»„ç»‡ID" />
 70:               </nz-form-control>
 71:             </nz-form-item>
 72: 
 73:             <nz-form-item>
 74:               <nz-form-label [nzSpan]="4" nzRequired>åä½œç±»å‹</nz-form-label>
 75:               <nz-form-control [nzSpan]="20" [nzErrorTip]="'è¯·é€‰æ‹©åä½œç±»å‹'">
 76:                 <nz-select formControlName="collaboration_type" nzPlaceHolder="è¯·é€‰æ‹©åä½œç±»å‹">
 77:                   <nz-option [nzValue]="CollaborationType.CONTRACTOR" nzLabel="æ‰¿æ½å•†"></nz-option>
 78:                   <nz-option [nzValue]="CollaborationType.SUBCONTRACTOR" nzLabel="æ¬¡æ‰¿æ½å•†"></nz-option>
 79:                   <nz-option [nzValue]="CollaborationType.CONSULTANT" nzLabel="é¡¾é—®"></nz-option>
 80:                   <nz-option [nzValue]="CollaborationType.PARTNER" nzLabel="åˆä½œä¼™ä¼´"></nz-option>
 81:                 </nz-select>
 82:               </nz-form-control>
 83:             </nz-form-item>
 84: 
 85:             @if (isEditMode()) {
 86:               <nz-form-item>
 87:                 <nz-form-label [nzSpan]="4">çŠ¶æ€</nz-form-label>
 88:                 <nz-form-control [nzSpan]="20">
 89:                   <nz-select formControlName="status" nzPlaceHolder="è¯·é€‰æ‹©çŠ¶æ€">
 90:                     <nz-option [nzValue]="CollaborationStatus.PENDING" nzLabel="å¾…å¤„ç†"></nz-option>
 91:                     <nz-option [nzValue]="CollaborationStatus.ACTIVE" nzLabel="æ´»è·ƒ"></nz-option>
 92:                     <nz-option [nzValue]="CollaborationStatus.SUSPENDED" nzLabel="å·²æš‚åœ"></nz-option>
 93:                     <nz-option [nzValue]="CollaborationStatus.ENDED" nzLabel="å·²ç»“æŸ"></nz-option>
 94:                   </nz-select>
 95:                 </nz-form-control>
 96:               </nz-form-item>
 97:             }
 98: 
 99:             <nz-form-item>
100:               <nz-form-label [nzSpan]="4">åˆåŒå¼€å§‹æ—¥æœŸ</nz-form-label>
101:               <nz-form-control [nzSpan]="20">
102:                 <input nz-input formControlName="contract_start_date" type="date" />
103:               </nz-form-control>
104:             </nz-form-item>
105: 
106:             <nz-form-item>
107:               <nz-form-label [nzSpan]="4">åˆåŒç»“æŸæ—¥æœŸ</nz-form-label>
108:               <nz-form-control [nzSpan]="20">
109:                 <input nz-input formControlName="contract_end_date" type="date" />
110:               </nz-form-control>
111:             </nz-form-item>
112: 
113:             <nz-form-item>
114:               <nz-form-label [nzSpan]="4">å¤‡æ³¨</nz-form-label>
115:               <nz-form-control [nzSpan]="20">
116:                 <textarea nz-input formControlName="notes" rows="4" placeholder="è¯·è¾“å…¥å¤‡æ³¨"></textarea>
117:               </nz-form-control>
118:             </nz-form-item>
119: 
120:             <nz-form-item>
121:               <nz-form-control [nzSpan]="24" [nzOffset]="4">
122:                 <button nz-button nzType="primary" [nzLoading]="collaborationService.loading()" [disabled]="form.invalid">
123:                   <span nz-icon nzType="save"></span>
124:                   {{ isEditMode() ? 'ä¿å­˜' : 'åˆ›å»º' }}
125:                 </button>
126:                 <button nz-button nzType="default" type="button" (click)="goBack()" style="margin-left: 8px;"> å–æ¶ˆ </button>
127:               </nz-form-control>
128:             </nz-form-item>
129:           </form>
130:         </nz-card>
131:       }
132:     </div>
133:   `
134: })
135: export class CollaborationFormComponent implements OnInit {
136:   collaborationService = inject(CollaborationService);
137:   route = inject(ActivatedRoute);
138:   router = inject(Router);
139:   message = inject(NzMessageService);
140: 
141:   // å¯¼å‡ºæšä¸¾ä¾›æ¨¡æ¿ä½¿ç”¨
142:   CollaborationType = CollaborationType;
143:   CollaborationStatus = CollaborationStatus;
144: 
145:   // åˆ¤æ–­æ˜¯å¦ä¸ºç¼–è¾‘æ¨¡å¼
146:   isEditMode = computed(() => {
147:     const id = this.route.snapshot.paramMap.get('id');
148:     return !!id;
149:   });
150: 
151:   // è¡¨å•å®šä¹‰
152:   form = new FormGroup<{
153:     blueprint_id: FormControl<string>;
154:     owner_org_id: FormControl<string>;
155:     collaborator_org_id: FormControl<string>;
156:     collaboration_type: FormControl<CollaborationType>;
157:     status?: FormControl<CollaborationStatus>;
158:     contract_start_date?: FormControl<string | null>;
159:     contract_end_date?: FormControl<string | null>;
160:     notes?: FormControl<string | null>;
161:   }>({
162:     blueprint_id: new FormControl('', { nonNullable: true, validators: [Validators.required] }),
163:     owner_org_id: new FormControl('', { nonNullable: true, validators: [Validators.required] }),
164:     collaborator_org_id: new FormControl('', { nonNullable: true, validators: [Validators.required] }),
165:     collaboration_type: new FormControl(CollaborationType.CONTRACTOR, {
166:       nonNullable: true,
167:       validators: [Validators.required]
168:     }),
169:     status: new FormControl(CollaborationStatus.ACTIVE, { nonNullable: true }),
170:     contract_start_date: new FormControl(null),
171:     contract_end_date: new FormControl(null),
172:     notes: new FormControl(null)
173:   });
174: 
175:   ngOnInit(): void {
176:     if (this.isEditMode()) {
177:       const collaborationId = this.route.snapshot.paramMap.get('id');
178:       if (collaborationId) {
179:         this.loadCollaboration(collaborationId);
180:       }
181:     }
182:   }
183: 
184:   async loadCollaboration(id: string): Promise<void> {
185:     try {
186:       const collaboration = await this.collaborationService.loadCollaborationById(id);
187:       if (collaboration) {
188:         this.form.patchValue({
189:           blueprint_id: collaboration.blueprint_id,
190:           owner_org_id: collaboration.owner_org_id,
191:           collaborator_org_id: collaboration.collaborator_org_id,
192:           collaboration_type: collaboration.collaboration_type as CollaborationType,
193:           status: collaboration.status as CollaborationStatus,
194:           contract_start_date: collaboration.contract_start_date || null,
195:           contract_end_date: collaboration.contract_end_date || null,
196:           notes: collaboration.notes || null
197:         });
198:       } else {
199:         this.message.warning('åä½œå…³ç³»ä¸å­˜åœ¨');
200:         this.goBack();
201:       }
202:     } catch (error) {
203:       this.message.error('åŠ è½½åä½œå…³ç³»ä¿¡æ¯å¤±è´¥');
204:     }
205:   }
206: 
207:   async onSubmit(): Promise<void> {
208:     if (this.form.invalid) {
209:       // æ ‡è®°æ‰€æœ‰å­—æ®µä¸º touchedï¼Œæ˜¾ç¤ºéªŒè¯é”™è¯¯
210:       Object.values(this.form.controls).forEach(control => {
211:         if (control && control.invalid) {
212:           control.markAsTouched();
213:           control.updateValueAndValidity({ onlySelf: true });
214:         }
215:       });
216:       return;
217:     }
218: 
219:     const formValue = this.form.value as CollaborationFormValue;
220: 
221:     try {
222:       if (this.isEditMode()) {
223:         const collaborationId = this.route.snapshot.paramMap.get('id')!;
224:         const updateData: OrganizationCollaborationUpdate = {
225:           blueprint_id: formValue.blueprint_id,
226:           owner_org_id: formValue.owner_org_id,
227:           collaborator_org_id: formValue.collaborator_org_id,
228:           collaboration_type: formValue.collaboration_type,
229:           status: formValue.status,
230:           contract_start_date: formValue.contract_start_date || undefined,
231:           contract_end_date: formValue.contract_end_date || undefined,
232:           notes: formValue.notes || undefined
233:         };
234:         await this.collaborationService.updateCollaboration(collaborationId, updateData);
235:         this.message.success('æ›´æ–°æˆåŠŸ');
236:         this.router.navigate(['/collaboration', collaborationId]);
237:       } else {
238:         const insertData: OrganizationCollaborationInsert = {
239:           blueprint_id: formValue.blueprint_id,
240:           owner_org_id: formValue.owner_org_id,
241:           collaborator_org_id: formValue.collaborator_org_id,
242:           collaboration_type: formValue.collaboration_type,
243:           status: formValue.status || CollaborationStatus.ACTIVE,
244:           contract_start_date: formValue.contract_start_date || undefined,
245:           contract_end_date: formValue.contract_end_date || undefined,
246:           notes: formValue.notes || undefined
247:         };
248:         const collaboration = await this.collaborationService.createCollaboration(insertData);
249:         this.message.success('åˆ›å»ºæˆåŠŸ');
250:         this.router.navigate(['/collaboration', collaboration.id]);
251:       }
252:     } catch (error) {
253:       this.message.error(this.isEditMode() ? 'æ›´æ–°å¤±è´¥' : 'åˆ›å»ºå¤±è´¥');
254:     }
255:   }
256: 
257:   goBack(): void {
258:     if (this.isEditMode()) {
259:       const collaborationId = this.route.snapshot.paramMap.get('id');
260:       if (collaborationId) {
261:         this.router.navigate(['/collaboration', collaborationId]);
262:       } else {
263:         this.router.navigate(['/collaboration/list']);
264:       }
265:     } else {
266:       this.router.navigate(['/collaboration/list']);
267:     }
268:   }
269: }
````

## File: src/app/routes/collaboration/invitations/invitation-list.component.ts
````typescript
  1: import { Component, OnInit, inject } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { InvitationStatus } from '@core';
  4: import { STColumn } from '@delon/abc/st';
  5: import { SHARED_IMPORTS, InvitationService, CollaborationInvitation } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: 
  8: @Component({
  9:   selector: 'app-invitation-list',
 10:   standalone: true,
 11:   imports: [SHARED_IMPORTS],
 12:   template: `
 13:     <page-header [title]="'åä½œé‚€è¯·ç®¡ç†'">
 14:       <ng-template #extra>
 15:         <button nz-button nzType="primary" (click)="createInvitation()">
 16:           <span nz-icon nzType="plus"></span>
 17:           å‘é€é‚€è¯·
 18:         </button>
 19:       </ng-template>
 20:     </page-header>
 21: 
 22:     <nz-card nzTitle="ç®¡ç†ç³»ç»Ÿä¸­çš„æ‰€æœ‰åä½œé‚€è¯·" style="margin-top: 16px;">
 23:       <st
 24:         #st
 25:         [data]="invitationService.invitations()"
 26:         [columns]="columns"
 27:         [loading]="invitationService.loading()"
 28:         [page]="{ front: false, show: true, showSize: true }"
 29:         (change)="onTableChange()"
 30:       >
 31:         <ng-template #status let-record>
 32:           @switch (record.status) {
 33:             @case ('pending') {
 34:               <nz-tag nzColor="orange">å¾…å¤„ç†</nz-tag>
 35:             }
 36:             @case ('accepted') {
 37:               <nz-tag nzColor="success">å·²æ¥å—</nz-tag>
 38:             }
 39:             @case ('rejected') {
 40:               <nz-tag nzColor="error">å·²æ‹’ç»</nz-tag>
 41:             }
 42:             @case ('expired') {
 43:               <nz-tag nzColor="default">å·²è¿‡æœŸ</nz-tag>
 44:             }
 45:             @default {
 46:               <nz-tag>æœªçŸ¥</nz-tag>
 47:             }
 48:           }
 49:         </ng-template>
 50:       </st>
 51:     </nz-card>
 52:   `
 53: })
 54: export class InvitationListComponent implements OnInit {
 55:   invitationService = inject(InvitationService);
 56:   router = inject(Router);
 57:   message = inject(NzMessageService);
 58: 
 59:   columns: STColumn[] = [
 60:     { title: 'ID', index: 'id', width: 100 },
 61:     { title: 'è“å›¾ID', index: 'blueprint_id', width: 150 },
 62:     { title: 'å‘é€ç»„ç»‡', index: 'from_org_id', width: 150 },
 63:     { title: 'æ¥æ”¶ç»„ç»‡', index: 'to_org_id', width: 150 },
 64:     { title: 'çŠ¶æ€', index: 'status', width: 100, render: 'status' },
 65:     { title: 'é‚€è¯·æ¶ˆæ¯', index: 'message', width: 200 },
 66:     { title: 'è¿‡æœŸæ—¶é—´', index: 'expires_at', type: 'date', width: 180 },
 67:     { title: 'å“åº”æ—¶é—´', index: 'responded_at', type: 'date', width: 180 },
 68:     { title: 'åˆ›å»ºæ—¶é—´', index: 'created_at', type: 'date', width: 180 },
 69:     {
 70:       title: 'æ“ä½œ',
 71:       width: 250,
 72:       buttons: [
 73:         {
 74:           text: 'æŸ¥çœ‹',
 75:           click: (record: CollaborationInvitation) => this.viewDetail(record.id)
 76:         },
 77:         {
 78:           text: 'æ¥å—',
 79:           type: 'link',
 80:           click: (record: CollaborationInvitation) => this.accept(record.id),
 81:           iif: (record: CollaborationInvitation) => record.status === InvitationStatus.PENDING
 82:         },
 83:         {
 84:           text: 'æ‹’ç»',
 85:           type: 'link',
 86:           click: (record: CollaborationInvitation) => this.reject(record.id),
 87:           iif: (record: CollaborationInvitation) => record.status === InvitationStatus.PENDING
 88:         },
 89:         {
 90:           text: 'åˆ é™¤',
 91:           type: 'del',
 92:           pop: {
 93:             title: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé‚€è¯·å—ï¼Ÿ',
 94:             okType: 'danger'
 95:           },
 96:           click: (record: CollaborationInvitation) => this.delete(record.id)
 97:         }
 98:       ]
 99:     }
100:   ];
101: 
102:   ngOnInit(): void {
103:     this.loadData();
104:   }
105: 
106:   async loadData(): Promise<void> {
107:     try {
108:       await this.invitationService.loadInvitations();
109:     } catch (error) {
110:       this.message.error('åŠ è½½é‚€è¯·åˆ—è¡¨å¤±è´¥');
111:     }
112:   }
113: 
114:   onTableChange(): void {
115:     // è¡¨æ ¼å˜åŒ–å¤„ç†
116:   }
117: 
118:   createInvitation(): void {
119:     this.router.navigate(['/collaboration/invitations/create']);
120:   }
121: 
122:   viewDetail(id: string): void {
123:     this.router.navigate(['/collaboration/invitations', id]);
124:   }
125: 
126:   async accept(id: string): Promise<void> {
127:     try {
128:       await this.invitationService.acceptInvitation(id);
129:       this.message.success('æ¥å—é‚€è¯·æˆåŠŸ');
130:       await this.loadData();
131:     } catch (error) {
132:       this.message.error('æ¥å—é‚€è¯·å¤±è´¥');
133:     }
134:   }
135: 
136:   async reject(id: string): Promise<void> {
137:     try {
138:       await this.invitationService.rejectInvitation(id);
139:       this.message.success('æ‹’ç»é‚€è¯·æˆåŠŸ');
140:       await this.loadData();
141:     } catch (error) {
142:       this.message.error('æ‹’ç»é‚€è¯·å¤±è´¥');
143:     }
144:   }
145: 
146:   async delete(id: string): Promise<void> {
147:     try {
148:       await this.invitationService.deleteInvitation(id);
149:       this.message.success('åˆ é™¤æˆåŠŸ');
150:       await this.loadData();
151:     } catch (error) {
152:       this.message.error('åˆ é™¤å¤±è´¥');
153:     }
154:   }
155: }
````

## File: src/app/routes/collaboration/list/collaboration-list.component.spec.ts
````typescript
 1: import { ComponentFixture, TestBed } from '@angular/core/testing';
 2: import { NoopAnimationsModule } from '@angular/platform-browser/animations';
 3: import { Router } from '@angular/router';
 4: import { CollaborationType, CollaborationStatus } from '@core';
 5: import { SettingsService } from '@delon/theme';
 6: import { SHARED_IMPORTS, CollaborationService, OrganizationCollaboration } from '@shared';
 7: import { NzSafeAny } from 'ng-zorro-antd/core/types';
 8: import { NzMessageService } from 'ng-zorro-antd/message';
 9: 
10: import { CollaborationListComponent } from './collaboration-list.component';
11: 
12: describe('CollaborationListComponent', () => {
13:   let component: CollaborationListComponent;
14:   let fixture: ComponentFixture<CollaborationListComponent>;
15:   let collaborationService: jasmine.SpyObj<CollaborationService>;
16:   let router: jasmine.SpyObj<Router>;
17:   let messageService: jasmine.SpyObj<NzMessageService>;
18: 
19:   const mockCollaborations: OrganizationCollaboration[] = [
20:     {
21:       id: 'collab-1',
22:       blueprint_id: 'blueprint-1',
23:       owner_org_id: 'org-1',
24:       collaborator_org_id: 'org-2',
25:       collaboration_type: CollaborationType.CONTRACTOR,
26:       status: CollaborationStatus.ACTIVE,
27:       contract_start_date: '2025-01-01',
28:       contract_end_date: '2025-12-31',
29:       notes: 'Test collaboration',
30:       created_at: '2025-01-01T00:00:00Z',
31:       updated_at: '2025-01-01T00:00:00Z'
32:     } as OrganizationCollaboration
33:   ];
34: 
35:   beforeEach(async () => {
36:     const collaborationServiceSpy = jasmine.createSpyObj(
37:       'CollaborationService',
38:       ['loadCollaborations', 'createCollaboration', 'deleteCollaboration'],
39:       {
40:         collaborations: jasmine.createSpy('collaborations').and.returnValue(mockCollaborations),
41:         loading: jasmine.createSpy('loading').and.returnValue(false),
42:         error: jasmine.createSpy('error').and.returnValue(null)
43:       }
44:     );
45: 
46:     const routerSpy = jasmine.createSpyObj('Router', ['navigate']);
47:     const messageServiceSpy = jasmine.createSpyObj('NzMessageService', ['success', 'error']);
48:     const mockSettingsService: NzSafeAny = {
49:       layout: {
50:         lang: null
51:       }
52:     };
53: 
54:     await TestBed.configureTestingModule({
55:       imports: [NoopAnimationsModule, CollaborationListComponent, SHARED_IMPORTS],
56:       providers: [
57:         { provide: CollaborationService, useValue: collaborationServiceSpy },
58:         { provide: Router, useValue: routerSpy },
59:         { provide: NzMessageService, useValue: messageServiceSpy },
60:         { provide: SettingsService, useValue: mockSettingsService }
61:       ]
62:     }).compileComponents();
63: 
64:     fixture = TestBed.createComponent(CollaborationListComponent);
65:     component = fixture.componentInstance;
66:     collaborationService = TestBed.inject(CollaborationService) as jasmine.SpyObj<CollaborationService>;
67:     router = TestBed.inject(Router) as jasmine.SpyObj<Router>;
68:     messageService = TestBed.inject(NzMessageService) as jasmine.SpyObj<NzMessageService>;
69:   });
70: 
71:   it('should create', () => {
72:     expect(component).toBeTruthy();
73:   });
74: 
75:   it('should load collaborations on init', async () => {
76:     collaborationService.loadCollaborations.and.returnValue(Promise.resolve());
77: 
78:     component.ngOnInit();
79:     await fixture.whenStable();
80:     fixture.detectChanges();
81: 
82:     expect(collaborationService.loadCollaborations).toHaveBeenCalled();
83:   });
84: 
85:   it('should navigate to create page when create button clicked', () => {
86:     component.createCollaboration();
87: 
88:     expect(router.navigate).toHaveBeenCalledWith(['/collaboration/form']);
89:   });
90: 
91:   it('should display collaborations in table', () => {
92:     fixture.detectChanges();
93: 
94:     const compiled = fixture.nativeElement;
95:     expect(compiled.querySelector('st')).toBeTruthy();
96:   });
97: });
````

## File: src/app/routes/collaboration/list/collaboration-list.component.ts
````typescript
  1: import { Component, OnInit, inject } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { CollaborationType, CollaborationStatus } from '@core';
  4: import { STColumn } from '@delon/abc/st';
  5: import { SHARED_IMPORTS, CollaborationService, OrganizationCollaboration } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: 
  8: @Component({
  9:   selector: 'app-collaboration-list',
 10:   standalone: true,
 11:   imports: [SHARED_IMPORTS],
 12:   template: `
 13:     <page-header [title]="'åä½œå…³ç³»ç®¡ç†'">
 14:       <ng-template #extra>
 15:         <button nz-button nzType="primary" (click)="createCollaboration()">
 16:           <span nz-icon nzType="plus"></span>
 17:           æ–°å»ºåä½œå…³ç³»
 18:         </button>
 19:       </ng-template>
 20:     </page-header>
 21: 
 22:     <nz-card nzTitle="ç®¡ç†ç³»ç»Ÿä¸­çš„æ‰€æœ‰åä½œå…³ç³»" style="margin-top: 16px;">
 23:       <st
 24:         #st
 25:         [data]="collaborationService.collaborations()"
 26:         [columns]="columns"
 27:         [loading]="collaborationService.loading()"
 28:         [page]="{ front: false, show: true, showSize: true }"
 29:         (change)="onTableChange()"
 30:       >
 31:         <ng-template #type let-record>
 32:           @switch (record.collaboration_type) {
 33:             @case ('contractor') {
 34:               <nz-tag nzColor="blue">æ‰¿æ½å•†</nz-tag>
 35:             }
 36:             @case ('subcontractor') {
 37:               <nz-tag nzColor="cyan">æ¬¡æ‰¿æ½å•†</nz-tag>
 38:             }
 39:             @case ('consultant') {
 40:               <nz-tag nzColor="purple">é¡¾é—®</nz-tag>
 41:             }
 42:             @case ('partner') {
 43:               <nz-tag nzColor="green">åˆä½œä¼™ä¼´</nz-tag>
 44:             }
 45:             @default {
 46:               <nz-tag>æœªçŸ¥</nz-tag>
 47:             }
 48:           }
 49:         </ng-template>
 50: 
 51:         <ng-template #status let-record>
 52:           @switch (record.status) {
 53:             @case ('pending') {
 54:               <nz-tag nzColor="orange">å¾…å¤„ç†</nz-tag>
 55:             }
 56:             @case ('active') {
 57:               <nz-tag nzColor="success">æ´»è·ƒ</nz-tag>
 58:             }
 59:             @case ('suspended') {
 60:               <nz-tag nzColor="warning">å·²æš‚åœ</nz-tag>
 61:             }
 62:             @case ('ended') {
 63:               <nz-tag nzColor="default">å·²ç»“æŸ</nz-tag>
 64:             }
 65:             @default {
 66:               <nz-tag>æœªçŸ¥</nz-tag>
 67:             }
 68:           }
 69:         </ng-template>
 70:       </st>
 71:     </nz-card>
 72:   `
 73: })
 74: export class CollaborationListComponent implements OnInit {
 75:   collaborationService = inject(CollaborationService);
 76:   router = inject(Router);
 77:   message = inject(NzMessageService);
 78: 
 79:   columns: STColumn[] = [
 80:     { title: 'ID', index: 'id', width: 100 },
 81:     { title: 'è“å›¾ID', index: 'blueprint_id', width: 150 },
 82:     { title: 'æ‹¥æœ‰è€…ç»„ç»‡', index: 'owner_org_id', width: 150 },
 83:     { title: 'åä½œç»„ç»‡', index: 'collaborator_org_id', width: 150 },
 84:     { title: 'åä½œç±»å‹', index: 'collaboration_type', width: 120, render: 'type' },
 85:     { title: 'çŠ¶æ€', index: 'status', width: 100, render: 'status' },
 86:     { title: 'åˆåŒå¼€å§‹æ—¥æœŸ', index: 'contract_start_date', type: 'date', width: 120 },
 87:     { title: 'åˆåŒç»“æŸæ—¥æœŸ', index: 'contract_end_date', type: 'date', width: 120 },
 88:     { title: 'åˆ›å»ºæ—¶é—´', index: 'created_at', type: 'date', width: 180 },
 89:     {
 90:       title: 'æ“ä½œ',
 91:       width: 200,
 92:       buttons: [
 93:         {
 94:           text: 'æŸ¥çœ‹',
 95:           click: (record: OrganizationCollaboration) => this.viewDetail(record.id)
 96:         },
 97:         {
 98:           text: 'ç¼–è¾‘',
 99:           click: (record: OrganizationCollaboration) => this.edit(record.id)
100:         },
101:         {
102:           text: 'åˆ é™¤',
103:           type: 'del',
104:           pop: {
105:             title: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåä½œå…³ç³»å—ï¼Ÿ',
106:             okType: 'danger'
107:           },
108:           click: (record: OrganizationCollaboration) => this.delete(record.id)
109:         }
110:       ]
111:     }
112:   ];
113: 
114:   ngOnInit(): void {
115:     this.loadData();
116:   }
117: 
118:   async loadData(): Promise<void> {
119:     try {
120:       await this.collaborationService.loadCollaborations();
121:     } catch (error) {
122:       this.message.error('åŠ è½½åä½œå…³ç³»åˆ—è¡¨å¤±è´¥');
123:     }
124:   }
125: 
126:   onTableChange(): void {
127:     // è¡¨æ ¼å˜åŒ–å¤„ç†
128:   }
129: 
130:   createCollaboration(): void {
131:     this.router.navigate(['/collaboration/create']);
132:   }
133: 
134:   viewDetail(id: string): void {
135:     this.router.navigate(['/collaboration', id]);
136:   }
137: 
138:   edit(id: string): void {
139:     this.router.navigate(['/collaboration', id, 'edit']);
140:   }
141: 
142:   async delete(id: string): Promise<void> {
143:     try {
144:       await this.collaborationService.deleteCollaboration(id);
145:       this.message.success('åˆ é™¤æˆåŠŸ');
146:       await this.loadData();
147:     } catch (error) {
148:       this.message.error('åˆ é™¤å¤±è´¥');
149:     }
150:   }
151: }
````

## File: src/app/routes/collaboration/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: 
 3: export const COLLABORATION_ROUTES: Routes = [
 4:   {
 5:     path: '',
 6:     redirectTo: 'list',
 7:     pathMatch: 'full'
 8:   },
 9:   {
10:     path: 'list',
11:     loadComponent: () => import('./list/collaboration-list.component').then(m => m.CollaborationListComponent)
12:   },
13:   {
14:     path: 'create',
15:     loadComponent: () => import('./form/collaboration-form.component').then(m => m.CollaborationFormComponent)
16:   },
17:   {
18:     path: 'invitations',
19:     loadComponent: () => import('./invitations/invitation-list.component').then(m => m.InvitationListComponent)
20:   },
21:   {
22:     path: ':id/edit',
23:     loadComponent: () => import('./form/collaboration-form.component').then(m => m.CollaborationFormComponent)
24:   },
25:   {
26:     path: ':id',
27:     loadComponent: () => import('./detail/collaboration-detail.component').then(m => m.CollaborationDetailComponent)
28:   }
29: ];
````

## File: src/app/routes/communication/comments/comment-create.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-comment-create',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'å‘è¡¨è¯„è®º'"></page-header>
11: 
12:     <nz-card nzTitle="å‘å¸ƒè¯„è®º" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="è¯„è®ºæäº¤æµç¨‹å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†æä¾›å¯Œæ–‡æœ¬ç¼–è¾‘ã€é™„ä»¶ä¸ @ æåŠåŠŸèƒ½ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class CommentCreateComponent {}
````

## File: src/app/routes/communication/comments/comment-list.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-comment-list',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'è¯„è®ºç®¡ç†'">
11:       <ng-template #extra>
12:         <button nz-button nzType="primary" routerLink="/communication/comments/create">
13:           <span nz-icon nzType="plus"></span>
14:           æ–°å»ºè¯„è®º
15:         </button>
16:       </ng-template>
17:     </page-header>
18: 
19:     <nz-card nzTitle="è¯„è®ºåˆ—è¡¨" style="margin-top: 16px;">
20:       <nz-alert
21:         nzType="info"
22:         nzMessage="è¯„è®ºç®¡ç†åŠŸèƒ½å»ºè®¾ä¸­"
23:         nzDescription="æ­¤é¡µé¢å°†æä¾›è¯„è®ºç­›é€‰ã€æœç´¢ä»¥åŠçŠ¶æ€ç®¡ç†èƒ½åŠ›ã€‚"
24:         [nzShowIcon]="true"
25:         style="margin-bottom: 16px;"
26:       ></nz-alert>
27:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
28:     </nz-card>
29:   `
30: })
31: export class CommentListComponent {}
````

## File: src/app/routes/communication/discussions/discussion-list.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-discussion-list',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'è®¨è®ºåŒº'"></page-header>
11: 
12:     <nz-card nzTitle="è®¨è®ºåŒº" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="è®¨è®ºåŒºåŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†å±•ç¤ºåä½œè®¨è®ºä¸²åŠå…¶æœ€æ–°åŠ¨æ€ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class DiscussionListComponent {}
````

## File: src/app/routes/communication/notifications/detail/notification-detail.spec.ts
````typescript
 1: import { ComponentFixture, TestBed } from '@angular/core/testing';
 2: 
 3: import { NotificationDetail } from './notification-detail';
 4: 
 5: describe('NotificationDetail', () => {
 6:   let component: NotificationDetail;
 7:   let fixture: ComponentFixture<NotificationDetail>;
 8: 
 9:   beforeEach(async () => {
10:     await TestBed.configureTestingModule({
11:       imports: [NotificationDetail]
12:     }).compileComponents();
13: 
14:     fixture = TestBed.createComponent(NotificationDetail);
15:     component = fixture.componentInstance;
16:     fixture.detectChanges();
17:   });
18: 
19:   it('should create', () => {
20:     expect(component).toBeTruthy();
21:   });
22: });
````

## File: src/app/routes/communication/notifications/detail/notification-detail.ts
````typescript
1: import { Component } from '@angular/core';
2: 
3: @Component({
4:   selector: 'app-notification-detail',
5:   imports: [],
6:   templateUrl: './notification-detail.html',
7:   styleUrl: './notification-detail.less'
8: })
9: export class NotificationDetail {}
````

## File: src/app/routes/communication/notifications/notification-center.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-notification-center',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'é€šçŸ¥ä¸­å¿ƒ'"></page-header>
11: 
12:     <nz-card nzTitle="é€šçŸ¥ä¸­å¿ƒ" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="é€šçŸ¥ä¸­å¿ƒåŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†é›†ä¸­å±•ç¤ºç³»ç»Ÿé€šçŸ¥ï¼Œå¹¶æ”¯æŒå·²è¯»/æœªè¯»ä¸ç­›é€‰ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class NotificationCenterComponent {}
````

## File: src/app/routes/communication/notifications/rules/notification-rules.component.spec.ts
````typescript
 1: import { fakeAsync, ComponentFixture, TestBed } from '@angular/core/testing';
 2: 
 3: import { NotificationRulesComponent } from './notification-rules.component';
 4: 
 5: describe('NotificationRulesComponent', () => {
 6:   let component: NotificationRulesComponent;
 7:   let fixture: ComponentFixture<NotificationRulesComponent>;
 8: 
 9:   beforeEach(fakeAsync(() => {
10:     TestBed.configureTestingModule({
11:       imports: [NotificationRulesComponent]
12:     }).compileComponents();
13:     fixture = TestBed.createComponent(NotificationRulesComponent);
14:     component = fixture.componentInstance;
15:     fixture.detectChanges();
16:   }));
17: 
18:   it('should compile', () => {
19:     expect(component).toBeTruthy();
20:   });
21: });
````

## File: src/app/routes/communication/notifications/rules/notification-rules.component.ts
````typescript
 1: import { Component, inject, OnDestroy, OnInit } from '@angular/core';
 2: import { AbstractControl, NonNullableFormBuilder, ReactiveFormsModule, ValidationErrors, Validators } from '@angular/forms';
 3: import { NzButtonModule } from 'ng-zorro-antd/button';
 4: import { NzFormModule } from 'ng-zorro-antd/form';
 5: import { NzInputModule } from 'ng-zorro-antd/input';
 6: import { Observable, Observer, Subject } from 'rxjs';
 7: import { takeUntil } from 'rxjs/operators';
 8: 
 9: @Component({
10:   selector: 'app-notification-rules',
11:   imports: [ReactiveFormsModule, NzButtonModule, NzFormModule, NzInputModule],
12:   templateUrl: './notification-rules.component.html',
13:   styleUrls: ['./notification-rules.component.less']
14: })
15: export class NotificationRulesComponent implements OnInit, OnDestroy {
16:   private fb = inject(NonNullableFormBuilder);
17:   private destroy$ = new Subject<void>();
18:   validateForm = this.fb.group({
19:     userName: this.fb.control('', [Validators.required], [this.userNameAsyncValidator]),
20:     email: this.fb.control('', [Validators.email, Validators.required]),
21:     password: this.fb.control('', [Validators.required]),
22:     confirm: this.fb.control('', [this.confirmValidator]),
23:     comment: this.fb.control('', [Validators.required])
24:   });
25: 
26:   ngOnInit(): void {
27:     this.validateForm.controls.password.valueChanges.pipe(takeUntil(this.destroy$)).subscribe(() => {
28:       this.validateForm.controls.confirm.updateValueAndValidity();
29:     });
30:   }
31: 
32:   ngOnDestroy(): void {
33:     this.destroy$.next();
34:     this.destroy$.complete();
35:   }
36: 
37:   submitForm(): void {
38:     console.log('submit', this.validateForm.value);
39:   }
40: 
41:   resetForm(e: MouseEvent): void {
42:     e.preventDefault();
43:     this.validateForm.reset();
44:   }
45: 
46:   userNameAsyncValidator(control: AbstractControl): Observable<ValidationErrors | null> {
47:     return new Observable((observer: Observer<ValidationErrors | null>) => {
48:       setTimeout(() => {
49:         if (control.value === 'JasonWood') {
50:           // you have to return `{error: true}` to mark it as an error event
51:           observer.next({ error: true, duplicated: true });
52:         } else {
53:           observer.next(null);
54:         }
55:         observer.complete();
56:       }, 1000);
57:     });
58:   }
59: 
60:   confirmValidator(control: AbstractControl): ValidationErrors | null {
61:     if (!control.value) {
62:       return { error: true, required: true };
63:     } else if (control.value !== control.parent!.value.password) {
64:       return { confirm: true, error: true };
65:     }
66:     return {};
67:   }
68: }
````

## File: src/app/routes/communication/realtime/realtime-notify.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-realtime-notify',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'å³æ—¶é€šçŸ¥'"></page-header>
11: 
12:     <nz-card nzTitle="å®æ—¶é€šçŸ¥" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="å®æ—¶é€šçŸ¥åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†å±•ç¤º WebSocket æ¨é€ä¸è®¢é˜…é…ç½®ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class RealtimeNotifyComponent {}
````

## File: src/app/routes/communication/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: 
 3: export const COMMUNICATION_ROUTES: Routes = [
 4:   {
 5:     path: '',
 6:     redirectTo: 'discussions',
 7:     pathMatch: 'full'
 8:   },
 9:   {
10:     path: 'discussions',
11:     loadComponent: () => import('./discussions/discussion-list.component').then(m => m.DiscussionListComponent)
12:   },
13:   {
14:     path: 'comments',
15:     loadComponent: () => import('./comments/comment-list.component').then(m => m.CommentListComponent)
16:   },
17:   {
18:     path: 'comments/create',
19:     loadComponent: () => import('./comments/comment-create.component').then(m => m.CommentCreateComponent)
20:   },
21:   {
22:     path: 'notifications',
23:     loadComponent: () => import('./notifications/notification-center.component').then(m => m.NotificationCenterComponent)
24:   },
25:   {
26:     path: 'notifications/detail',
27:     loadComponent: () => import('./notifications/detail/notification-detail').then(m => m.NotificationDetail)
28:   },
29:   {
30:     path: 'notifications/rules',
31:     loadComponent: () => import('./notifications/rules/notification-rules.component').then(m => m.NotificationRulesComponent)
32:   },
33:   {
34:     path: 'realtime',
35:     loadComponent: () => import('./realtime/realtime-notify.component').then(m => m.RealtimeNotifyComponent)
36:   },
37:   {
38:     path: 'todos',
39:     loadComponent: () => import('./todos/todo-center.component').then(m => m.TodoCenterComponent)
40:   },
41:   {
42:     path: 'team-notify',
43:     loadComponent: () => import('./team-notify/team-notify.component').then(m => m.TeamNotifyComponent)
44:   }
45: ];
````

## File: src/app/routes/communication/team-notify/team-notify.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-team-notify',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'å›¢é˜Ÿé€šçŸ¥'"></page-header>
11: 
12:     <nz-card nzTitle="å›¢é˜Ÿé€šçŸ¥" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="å›¢é˜Ÿé€šçŸ¥åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†ç®¡ç†è·¨å›¢é˜Ÿå…¬å‘Šä¸ç«™å†…å¹¿æ’­ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class TeamNotifyComponent {}
````

## File: src/app/routes/communication/todos/todo-center.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-todo-center',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'å¾…åŠä¸­å¿ƒ'"></page-header>
11: 
12:     <nz-card nzTitle="å¾…åŠä¸­å¿ƒ" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="å¾…åŠä¸­å¿ƒåŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†è”åŠ¨ä»»åŠ¡ä¸è¯„è®ºç”Ÿæˆçš„å¾…åŠåˆ—è¡¨ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class TodoCenterComponent {}
````

## File: src/app/routes/dashboard/analysis/analysis.component.ts
````typescript
  1: import { DecimalPipe } from '@angular/common';
  2: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, OnInit, inject } from '@angular/core';
  3: import { STColumn } from '@delon/abc/st';
  4: import { G2BarModule } from '@delon/chart/bar';
  5: import { G2CardModule } from '@delon/chart/card';
  6: import { G2MiniAreaModule } from '@delon/chart/mini-area';
  7: import { G2MiniBarModule } from '@delon/chart/mini-bar';
  8: import { G2MiniProgressModule } from '@delon/chart/mini-progress';
  9: import { NumberInfoModule } from '@delon/chart/number-info';
 10: import { G2PieModule } from '@delon/chart/pie';
 11: import { G2TimelineModule } from '@delon/chart/timeline';
 12: import { TrendModule } from '@delon/chart/trend';
 13: import { ALAIN_I18N_TOKEN, _HttpClient } from '@delon/theme';
 14: import { getTimeDistance } from '@delon/util/date-time';
 15: import { deepCopy } from '@delon/util/other';
 16: import { SHARED_IMPORTS, yuan } from '@shared';
 17: import type { NzSafeAny } from 'ng-zorro-antd/core/types';
 18: import { NzMessageService } from 'ng-zorro-antd/message';
 19: 
 20: @Component({
 21:   selector: 'app-dashboard-analysis',
 22:   templateUrl: './analysis.component.html',
 23:   styleUrls: ['./analysis.component.less'],
 24:   changeDetection: ChangeDetectionStrategy.OnPush,
 25:   imports: [
 26:     ...SHARED_IMPORTS,
 27:     G2TimelineModule,
 28:     G2PieModule,
 29:     NumberInfoModule,
 30:     TrendModule,
 31:     G2MiniAreaModule,
 32:     DecimalPipe,
 33:     G2BarModule,
 34:     G2MiniProgressModule,
 35:     G2CardModule,
 36:     G2MiniBarModule
 37:   ]
 38: })
 39: export class DashboardAnalysisComponent implements OnInit {
 40:   private readonly http = inject(_HttpClient);
 41:   readonly msg = inject(NzMessageService);
 42:   private readonly i18n = inject(ALAIN_I18N_TOKEN);
 43:   private readonly cdr = inject(ChangeDetectorRef);
 44: 
 45:   data: any = {};
 46:   loading = true;
 47:   dateRange: Date[] = [];
 48:   dateRangeTypes = ['today', 'week', 'month', 'year'];
 49:   dateRangeType = this.dateRangeTypes[0];
 50:   rankingListData: Array<{ title: string; total: number }> = Array(7)
 51:     .fill({})
 52:     .map((_, i) => {
 53:       return {
 54:         title: this.i18n.fanyi('app.analysis.test', { no: i }),
 55:         total: 323234
 56:       };
 57:     });
 58:   titleMap = {
 59:     y1: this.i18n.fanyi('app.analysis.traffic'),
 60:     y2: this.i18n.fanyi('app.analysis.payments')
 61:   };
 62:   searchColumn: STColumn[] = [
 63:     { title: { text: 'æ’å', i18n: 'app.analysis.table.rank' }, index: 'index' },
 64:     {
 65:       title: { text: 'æœç´¢å…³é”®è¯', i18n: 'app.analysis.table.search-keyword' },
 66:       index: 'keyword',
 67:       click: item => this.msg.success(item.keyword)
 68:     },
 69:     {
 70:       type: 'number',
 71:       title: { text: 'ç”¨æˆ·æ•°', i18n: 'app.analysis.table.users' },
 72:       index: 'count',
 73:       sort: {
 74:         compare: (a, b) => a.count - b.count
 75:       }
 76:     },
 77:     {
 78:       type: 'number',
 79:       title: { text: 'å‘¨æ¶¨å¹…', i18n: 'app.analysis.table.weekly-range' },
 80:       index: 'range',
 81:       render: 'range',
 82:       sort: {
 83:         compare: (a, b) => a.range - b.range
 84:       }
 85:     }
 86:   ];
 87: 
 88:   salesType = 'all';
 89:   salesPieData: any;
 90:   salesTotal = 0;
 91: 
 92:   saleTabs: string[] = ['sales', 'visits'];
 93: 
 94:   offlineIdx = 0;
 95: 
 96:   ngOnInit(): void {
 97:     this.http.get('/chart').subscribe(res => {
 98:       res.offlineData.forEach((item: any) => {
 99:         item.chart = deepCopy(res.offlineChartData);
100:       });
101:       this.data = res;
102:       this.loading = false;
103:       this.changeSaleType();
104:     });
105:   }
106: 
107:   setDate(type: string): void {
108:     this.dateRange = getTimeDistance(type as NzSafeAny);
109:     this.dateRangeType = type;
110:     setTimeout(() => this.cdr.detectChanges());
111:   }
112:   changeSaleType(): void {
113:     this.salesPieData =
114:       this.salesType === 'all'
115:         ? this.data.salesTypeData
116:         : this.salesType === 'online'
117:           ? this.data.salesTypeDataOnline
118:           : this.data.salesTypeDataOffline;
119:     if (this.salesPieData) {
120:       this.salesTotal = this.salesPieData.reduce((pre: number, now: { y: number }) => now.y + pre, 0);
121:     }
122:     this.cdr.detectChanges();
123:   }
124: 
125:   handlePieValueFormat(value: string | number): string {
126:     return yuan(value);
127:   }
128:   offlineChange(idx: number): void {
129:     if (this.data.offlineData[idx].show !== true) {
130:       this.data.offlineData[idx].show = true;
131:       this.cdr.detectChanges();
132:     }
133:   }
134: }
````

## File: src/app/routes/dashboard/monitor/monitor.component.ts
````typescript
  1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, OnDestroy, OnInit, inject } from '@angular/core';
  2: import { CountDownModule } from '@delon/abc/count-down';
  3: import { G2GaugeModule } from '@delon/chart/gauge';
  4: import { G2MiniAreaModule } from '@delon/chart/mini-area';
  5: import { NumberInfoModule } from '@delon/chart/number-info';
  6: import { G2PieModule } from '@delon/chart/pie';
  7: import { G2TagCloudModule } from '@delon/chart/tag-cloud';
  8: import { G2WaterWaveModule } from '@delon/chart/water-wave';
  9: import { _HttpClient } from '@delon/theme';
 10: import { SHARED_IMPORTS } from '@shared';
 11: import type { CountdownConfig } from 'ngx-countdown';
 12: import { zip } from 'rxjs';
 13: 
 14: @Component({
 15:   selector: 'app-dashboard-monitor',
 16:   templateUrl: './monitor.component.html',
 17:   styleUrls: ['./monitor.component.less'],
 18:   changeDetection: ChangeDetectionStrategy.OnPush,
 19:   imports: [
 20:     ...SHARED_IMPORTS,
 21:     G2WaterWaveModule,
 22:     G2TagCloudModule,
 23:     G2PieModule,
 24:     G2GaugeModule,
 25:     G2MiniAreaModule,
 26:     NumberInfoModule,
 27:     CountDownModule
 28:   ]
 29: })
 30: export class DashboardMonitorComponent implements OnInit, OnDestroy {
 31:   private readonly http = inject(_HttpClient);
 32:   private readonly cdr = inject(ChangeDetectorRef);
 33: 
 34:   data: any = {};
 35:   tags = [];
 36:   loading = true;
 37:   q = {
 38:     start: null,
 39:     end: null
 40:   };
 41:   percent: number | null = null;
 42:   cd: CountdownConfig = {
 43:     format: `HH:mm:ss.S`,
 44:     leftTime: 10000
 45:   };
 46: 
 47:   // region: active chart
 48: 
 49:   activeTime$: any;
 50: 
 51:   activeData!: any[];
 52: 
 53:   activeStat = {
 54:     max: 0,
 55:     min: 0,
 56:     t1: '',
 57:     t2: ''
 58:   };
 59: 
 60:   ngOnInit(): void {
 61:     zip(this.http.get('/chart'), this.http.get('/chart/tags')).subscribe(([res, tags]: [any, any]) => {
 62:       this.data = res;
 63:       tags.list[Math.floor(Math.random() * tags.list.length) + 1].value = 1000;
 64:       this.tags = tags.list;
 65:       this.loading = false;
 66:       this.cdr.detectChanges();
 67:     });
 68: 
 69:     // active chart
 70:     this.refData();
 71:     this.activeTime$ = setInterval(() => this.refData(), 1000 * 2);
 72:   }
 73: 
 74:   refData(): void {
 75:     const activeData: any[] = [];
 76:     for (let i = 0; i < 24; i += 1) {
 77:       activeData.push({
 78:         x: `${i.toString().padStart(2, '0')}:00`,
 79:         y: i * 50 + Math.floor(Math.random() * 200)
 80:       });
 81:     }
 82:     this.activeData = activeData;
 83:     // stat
 84:     this.activeStat.max = [...activeData].sort()[activeData.length - 1].y + 200;
 85:     this.activeStat.min = [...activeData].sort()[Math.floor(activeData.length / 2)].y;
 86:     this.activeStat.t1 = activeData[Math.floor(activeData.length / 2)].x;
 87:     this.activeStat.t2 = activeData[activeData.length - 1].x;
 88:     // percent
 89:     this.percent = Math.floor(Math.random() * 100);
 90:     this.cdr.detectChanges();
 91:   }
 92: 
 93:   // endregion
 94: 
 95:   couponFormat(val: any): string {
 96:     switch (parseInt(val, 10)) {
 97:       case 20:
 98:         return 'å·®';
 99:       case 40:
100:         return 'ä¸­';
101:       case 60:
102:         return 'è‰¯';
103:       case 80:
104:         return 'ä¼˜';
105:       default:
106:         return '';
107:     }
108:   }
109: 
110:   ngOnDestroy(): void {
111:     if (this.activeTime$) {
112:       clearInterval(this.activeTime$);
113:     }
114:   }
115: }
````

## File: src/app/routes/dashboard/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: 
 3: import { DashboardAnalysisComponent } from './analysis/analysis.component';
 4: import { DashboardMonitorComponent } from './monitor/monitor.component';
 5: import { DashboardV1Component } from './v1/v1.component';
 6: import { DashboardWorkplaceComponent } from './workplace/workplace.component';
 7: 
 8: export const routes: Routes = [
 9:   { path: '', redirectTo: 'v1', pathMatch: 'full' },
10:   { path: 'v1', component: DashboardV1Component },
11:   { path: 'analysis', component: DashboardAnalysisComponent },
12:   { path: 'monitor', component: DashboardMonitorComponent },
13:   { path: 'workplace', component: DashboardWorkplaceComponent }
14: ];
````

## File: src/app/routes/dashboard/v1/v1.component.ts
````typescript
  1: import { Platform } from '@angular/cdk/platform';
  2: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, OnInit, inject, DOCUMENT } from '@angular/core';
  3: import { takeUntilDestroyed } from '@angular/core/rxjs-interop';
  4: import type { Chart } from '@antv/g2';
  5: import { OnboardingModule, OnboardingService } from '@delon/abc/onboarding';
  6: import { QuickMenuModule } from '@delon/abc/quick-menu';
  7: import { G2BarModule } from '@delon/chart/bar';
  8: import { G2MiniBarModule } from '@delon/chart/mini-bar';
  9: import { G2TimelineModule } from '@delon/chart/timeline';
 10: import { _HttpClient } from '@delon/theme';
 11: import { SHARED_IMPORTS } from '@shared';
 12: import { timer } from 'rxjs';
 13: 
 14: @Component({
 15:   selector: 'app-dashboard-v1',
 16:   templateUrl: './v1.component.html',
 17:   changeDetection: ChangeDetectionStrategy.OnPush,
 18:   imports: [...SHARED_IMPORTS, G2TimelineModule, G2BarModule, G2MiniBarModule, QuickMenuModule, OnboardingModule]
 19: })
 20: export class DashboardV1Component implements OnInit {
 21:   private readonly http = inject(_HttpClient);
 22:   private readonly cdr = inject(ChangeDetectorRef);
 23:   private readonly obSrv = inject(OnboardingService);
 24:   private readonly platform = inject(Platform);
 25:   private readonly doc = inject(DOCUMENT);
 26:   todoData = [
 27:     {
 28:       completed: true,
 29:       avatar: '1',
 30:       name: 'è‹å…ˆç”Ÿ',
 31:       content: `è¯·å‘Šè¯‰æˆ‘ï¼Œæˆ‘åº”è¯¥è¯´ç‚¹ä»€ä¹ˆå¥½ï¼Ÿ`
 32:     },
 33:     {
 34:       completed: false,
 35:       avatar: '2',
 36:       name: 'ã¯ãªã•ã',
 37:       content: `ãƒãƒ«ã‚«ã‚½ãƒ©ãƒˆã‚­ãƒ˜ãƒ€ãƒ„ãƒ’ã‚«ãƒª`
 38:     },
 39:     {
 40:       completed: false,
 41:       avatar: '3',
 42:       name: 'cipchk',
 43:       content: `this world was never meant for one as beautiful as you.`
 44:     },
 45:     {
 46:       completed: false,
 47:       avatar: '4',
 48:       name: 'Kent',
 49:       content: `my heart is beating with hers`
 50:     },
 51:     {
 52:       completed: false,
 53:       avatar: '5',
 54:       name: 'Are you',
 55:       content: `They always said that I love beautiful girl than my friends`
 56:     },
 57:     {
 58:       completed: false,
 59:       avatar: '6',
 60:       name: 'Forever',
 61:       content: `Walking through green fields ï¼Œsunshine in my eyes.`
 62:     }
 63:   ];
 64: 
 65:   webSite!: any[];
 66:   salesData!: any[];
 67:   offlineChartData!: any[];
 68: 
 69:   constructor() {
 70:     timer(1000)
 71:       .pipe(takeUntilDestroyed())
 72:       .subscribe(() => this.genOnboarding());
 73:   }
 74: 
 75:   fixDark(chart: Chart): void {
 76:     if (!this.platform.isBrowser || (this.doc.body as HTMLBodyElement).getAttribute('data-theme') !== 'dark') return;
 77: 
 78:     chart.theme({
 79:       styleSheet: {
 80:         backgroundColor: 'transparent'
 81:       }
 82:     });
 83:   }
 84: 
 85:   ngOnInit(): void {
 86:     this.http.get('/chart').subscribe(res => {
 87:       this.webSite = res.visitData.slice(0, 10);
 88:       this.salesData = res.salesData;
 89:       this.offlineChartData = res.offlineChartData;
 90:       this.cdr.detectChanges();
 91:     });
 92:   }
 93: 
 94:   private genOnboarding(): void {
 95:     const KEY = 'on-boarding';
 96:     if (!this.platform.isBrowser || localStorage.getItem(KEY) === '1') {
 97:       return;
 98:     }
 99:     this.http.get(`./assets/tmp/on-boarding.json`).subscribe(res => {
100:       this.obSrv.start(res);
101:       localStorage.setItem(KEY, '1');
102:     });
103:   }
104: }
````

## File: src/app/routes/dashboard/workplace/workplace.component.ts
````typescript
  1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, OnInit, inject } from '@angular/core';
  2: import { G2RadarModule } from '@delon/chart/radar';
  3: import { _HttpClient } from '@delon/theme';
  4: import { SHARED_IMPORTS } from '@shared';
  5: import { NzAvatarModule } from 'ng-zorro-antd/avatar';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: import { zip } from 'rxjs';
  8: 
  9: @Component({
 10:   selector: 'app-dashboard-workplace',
 11:   templateUrl: './workplace.component.html',
 12:   styleUrls: ['./workplace.component.less'],
 13:   changeDetection: ChangeDetectionStrategy.OnPush,
 14:   imports: [...SHARED_IMPORTS, NzAvatarModule, G2RadarModule]
 15: })
 16: export class DashboardWorkplaceComponent implements OnInit {
 17:   private readonly http = inject(_HttpClient);
 18:   readonly msg = inject(NzMessageService);
 19:   private readonly cdr = inject(ChangeDetectorRef);
 20: 
 21:   notice: any[] = [];
 22:   activities: any[] = [];
 23:   radarData!: any[];
 24:   loading = true;
 25: 
 26:   links = [
 27:     {
 28:       title: 'æ“ä½œä¸€',
 29:       href: ''
 30:     },
 31:     {
 32:       title: 'æ“ä½œäºŒ',
 33:       href: ''
 34:     },
 35:     {
 36:       title: 'æ“ä½œä¸‰',
 37:       href: ''
 38:     },
 39:     {
 40:       title: 'æ“ä½œå››',
 41:       href: ''
 42:     },
 43:     {
 44:       title: 'æ“ä½œäº”',
 45:       href: ''
 46:     },
 47:     {
 48:       title: 'æ“ä½œå…­',
 49:       href: ''
 50:     }
 51:   ];
 52:   members = [
 53:     {
 54:       id: 'members-1',
 55:       title: 'ç§‘å­¦æ¬ç –ç»„',
 56:       logo: 'https://gw.alipayobjects.com/zos/rmsportal/WdGqmHpayyMjiEhcKoVE.png',
 57:       link: ''
 58:     },
 59:     {
 60:       id: 'members-2',
 61:       title: 'ç¨‹åºå‘˜æ—¥å¸¸',
 62:       logo: 'https://gw.alipayobjects.com/zos/rmsportal/zOsKZmFRdUtvpqCImOVY.png',
 63:       link: ''
 64:     },
 65:     {
 66:       id: 'members-3',
 67:       title: 'è®¾è®¡å¤©å›¢',
 68:       logo: 'https://gw.alipayobjects.com/zos/rmsportal/dURIMkkrRFpPgTuzkwnB.png',
 69:       link: ''
 70:     },
 71:     {
 72:       id: 'members-4',
 73:       title: 'ä¸­äºŒå°‘å¥³å›¢',
 74:       logo: 'https://gw.alipayobjects.com/zos/rmsportal/sfjbOqnsXXJgNCjCzDBL.png',
 75:       link: ''
 76:     },
 77:     {
 78:       id: 'members-5',
 79:       title: 'éª—ä½ å­¦è®¡ç®—æœº',
 80:       logo: 'https://gw.alipayobjects.com/zos/rmsportal/siCrBXXhmvTQGWPNLBow.png',
 81:       link: ''
 82:     }
 83:   ];
 84: 
 85:   ngOnInit(): void {
 86:     zip(this.http.get('/chart'), this.http.get('/api/notice'), this.http.get('/api/activities')).subscribe(
 87:       ([chart, notice, activities]: [any, any, any]) => {
 88:         this.radarData = chart.radarData;
 89:         this.notice = notice;
 90:         this.activities = activities.map((item: any) => {
 91:           item.template = item.template.split(/@\{([^{}]*)\}/gi).map((key: string) => {
 92:             if (item[key]) {
 93:               return `<a>${item[key].name}</a>`;
 94:             }
 95:             return key;
 96:           });
 97:           return item;
 98:         });
 99:         this.loading = false;
100:         this.cdr.detectChanges();
101:       }
102:     );
103:   }
104: }
````

## File: src/app/routes/data-v/relation/relation.component.ts
````typescript
1: import { Component } from '@angular/core';
2: import { SHARED_IMPORTS } from '@shared';
3: 
4: @Component({
5:   selector: 'app-data-v-relation',
6:   templateUrl: './relation.component.html',
7:   imports: SHARED_IMPORTS
8: })
9: export class RelationComponent {}
````

## File: src/app/routes/data-v/routes.ts
````typescript
1: import { Routes } from '@angular/router';
2: 
3: import { RelationComponent } from './relation/relation.component';
4: 
5: export const routes: Routes = [{ path: 'relation', component: RelationComponent }];
````

## File: src/app/routes/delon/acl/acl.component.ts
````typescript
 1: import { Component, inject } from '@angular/core';
 2: import { ACLService } from '@delon/acl';
 3: import { MenuService } from '@delon/theme';
 4: import { SHARED_IMPORTS } from '@shared';
 5: 
 6: @Component({
 7:   selector: 'app-acl',
 8:   templateUrl: './acl.component.html',
 9:   imports: SHARED_IMPORTS
10: })
11: export class ACLComponent {
12:   private readonly aclSrv = inject(ACLService);
13:   private readonly menuSrv = inject(MenuService);
14: 
15:   full = true;
16:   roleA = '';
17:   roleB = '';
18: 
19:   get data(): {
20:     full: boolean;
21:     roles: string[];
22:     abilities: Array<string | number>;
23:   } {
24:     return this.aclSrv.data;
25:   }
26: 
27:   private reMenu(): void {
28:     this.menuSrv.resume();
29:   }
30: 
31:   toggleFull(): void {
32:     this.full = !this.full;
33:     this.aclSrv.setFull(this.full);
34:     this.reMenu();
35:   }
36: 
37:   toggleRoleA(): void {
38:     this.full = false;
39:     this.roleA = this.roleA === 'role-a' ? '' : 'role-a';
40:     this.aclSrv.setFull(this.full);
41:     this.aclSrv.setRole([this.roleA]);
42:     this.reMenu();
43:   }
44: 
45:   toggleRoleB(): void {
46:     this.full = false;
47:     this.roleB = this.roleB === 'role-b' ? '' : 'role-b';
48:     this.aclSrv.setFull(this.full);
49:     this.aclSrv.setRole([this.roleB]);
50:     this.reMenu();
51:   }
52: }
````

## File: src/app/routes/delon/cache/cache.component.ts
````typescript
 1: import { Component, inject } from '@angular/core';
 2: import { CacheService } from '@delon/cache';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: 
 6: @Component({
 7:   selector: 'app-cache',
 8:   templateUrl: './cache.component.html',
 9:   imports: SHARED_IMPORTS
10: })
11: export class CacheComponent {
12:   private readonly cache = inject(CacheService);
13:   private readonly msg = inject(NzMessageService);
14: 
15:   KEY = 'user';
16: 
17:   set(): void {
18:     this.cache.set(this.KEY, +new Date());
19:   }
20: 
21:   get(): void {
22:     this.msg.success(this.cache.getNone(this.KEY));
23:   }
24: }
````

## File: src/app/routes/delon/downfile/downfile.component.ts
````typescript
 1: import { Component } from '@angular/core';
 2: import { DownFileDirective } from '@delon/abc/down-file';
 3: import { SHARED_IMPORTS } from '@shared';
 4: 
 5: @Component({
 6:   selector: 'app-down-file',
 7:   templateUrl: './downfile.component.html',
 8:   imports: [...SHARED_IMPORTS, DownFileDirective]
 9: })
10: export class DownFileComponent {
11:   fileTypes = ['.xlsx', '.docx', '.pptx', '.pdf'];
12: 
13:   data = {
14:     otherdata: 1,
15:     time: new Date()
16:   };
17: }
````

## File: src/app/routes/delon/form/form.component.ts
````typescript
 1: import { Component } from '@angular/core';
 2: import { STColumn } from '@delon/abc/st';
 3: import { SFSchema } from '@delon/form';
 4: import { SHARED_IMPORTS } from '@shared';
 5: 
 6: @Component({
 7:   selector: 'app-delon-form',
 8:   templateUrl: './form.component.html',
 9:   imports: SHARED_IMPORTS
10: })
11: export class DelonFormComponent {
12:   params: any = {};
13:   url = `/user`;
14:   searchSchema: SFSchema = {
15:     properties: {
16:       no: {
17:         type: 'string',
18:         title: 'ç¼–å·'
19:       }
20:     }
21:   };
22:   columns: STColumn[] = [
23:     { title: 'ç¼–å·', index: 'no' },
24:     { title: 'è°ƒç”¨æ¬¡æ•°', type: 'number', index: 'callNo' },
25:     { title: 'å¤´åƒ', type: 'img', width: '50px', index: 'avatar' },
26:     { title: 'æ—¶é—´', type: 'date', index: 'updatedAt' }
27:   ];
28: }
````

## File: src/app/routes/delon/guard/admin.component.ts
````typescript
1: import { Component } from '@angular/core';
2: 
3: @Component({
4:   selector: 'app-guard-admin',
5:   template: ` <p>è¿™æ˜¯ä¸€ä¸ªadminé¡µé¢</p> `
6: })
7: export class GuardAdminComponent {}
````

## File: src/app/routes/delon/guard/auth.component.ts
````typescript
1: import { Component } from '@angular/core';
2: 
3: @Component({
4:   selector: 'app-guard-auth',
5:   template: ` <p>è¿™æ˜¯ä¸€ä¸ªuser1é¡µé¢</p> `
6: })
7: export class GuardAuthComponent {}
````

## File: src/app/routes/delon/guard/can-leave.ts
````typescript
 1: import { inject } from '@angular/core';
 2: import { CanDeactivateFn } from '@angular/router';
 3: import { NzModalService } from 'ng-zorro-antd/modal';
 4: import { Observable } from 'rxjs';
 5: 
 6: import { GuardComponent } from './guard.component';
 7: 
 8: export const canLeave: CanDeactivateFn<GuardComponent> = (): Observable<boolean> => {
 9:   const srv = inject(NzModalService);
10:   return new Observable(observer => {
11:     srv.confirm({
12:       nzTitle: 'ç¡®è®¤è¦ç¦»å¼€å—ï¼Ÿ',
13:       nzContent: 'ä½ å·²ç»å¡«å†™äº†éƒ¨åˆ†è¡¨å•ç¦»å¼€ä¼šæ”¾å¼ƒå·²ç»å¡«å†™çš„å†…å®¹ã€‚',
14:       nzOkText: 'ç¦»å¼€',
15:       nzCancelText: 'å–æ¶ˆ',
16:       nzOnOk: () => {
17:         observer.next(true);
18:         observer.complete();
19:       },
20:       nzOnCancel: () => {
21:         observer.next(false);
22:         observer.complete();
23:       }
24:     });
25:   });
26: };
````

## File: src/app/routes/delon/guard/guard.component.ts
````typescript
 1: import { Component, inject } from '@angular/core';
 2: import { Router } from '@angular/router';
 3: import { ACLService } from '@delon/acl';
 4: import { MenuService } from '@delon/theme';
 5: import { SHARED_IMPORTS } from '@shared';
 6: 
 7: @Component({
 8:   selector: 'app-guard',
 9:   templateUrl: './guard.component.html',
10:   imports: SHARED_IMPORTS
11: })
12: export class GuardComponent {
13:   private readonly aclSrv = inject(ACLService);
14:   private readonly menuSrv = inject(MenuService);
15:   private readonly router = inject(Router);
16: 
17:   get data(): any {
18:     return this.aclSrv.data;
19:   }
20: 
21:   setRole(value: string | boolean): void {
22:     this.aclSrv.setFull(false);
23:     if (typeof value === 'boolean') {
24:       this.aclSrv.setFull(value);
25:     } else {
26:       this.aclSrv.set({ role: [value as string] });
27:     }
28:     this.menuSrv.resume();
29:     this.router.navigate(['/delon/guard']);
30:   }
31: }
````

## File: src/app/routes/delon/guard/leave.component.ts
````typescript
 1: import { Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-guard-leave',
 6:   template: `
 7:     <p>ç¦»å¼€æ—¶éœ€è¦ç¡®è®¤</p>
 8:     <button nz-button [nzType]="'primary'" [routerLink]="['/delon/guard']">
 9:       <span>æˆ‘è¦ç¦»å¼€</span>
10:     </button>
11:   `,
12:   imports: SHARED_IMPORTS
13: })
14: export class GuardLeaveComponent {}
````

## File: src/app/routes/delon/print/print.component.ts
````typescript
 1: import { Component, inject } from '@angular/core';
 2: import { Lodop, LodopService } from '@delon/abc/lodop';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: 
 6: @Component({
 7:   selector: 'app-print',
 8:   templateUrl: './print.component.html',
 9:   imports: SHARED_IMPORTS
10: })
11: export class PrintComponent {
12:   private readonly lodopSrv = inject(LodopService);
13:   private readonly msg = inject(NzMessageService);
14: 
15:   constructor() {
16:     this.lodopSrv.lodop.subscribe(({ lodop, ok }) => {
17:       if (!ok) {
18:         this.error = true;
19:         return;
20:       }
21:       this.error = false;
22:       this.msg.success(`æ‰“å°æœºåŠ è½½æˆåŠŸ`);
23:       this.lodop = lodop as Lodop;
24:       this.pinters = this.lodopSrv.printer;
25:     });
26:   }
27: 
28:   cog: any = {
29:     url: 'https://localhost:8443/CLodopfuncs.js',
30:     printer: '',
31:     paper: '',
32:     html: `
33:       <h1>Title</h1>
34:       <p>è¿™~ï¼@#ï¿¥%â€¦â€¦&*ï¼ˆï¼‰â€”â€”sdilfjnvn</p>
35:       <p>è¿™~ï¼@#ï¿¥%â€¦â€¦&*ï¼ˆï¼‰â€”â€”sdilfjnvn</p>
36:       <p>è¿™~ï¼@#ï¿¥%â€¦â€¦&*ï¼ˆï¼‰â€”â€”sdilfjnvn</p>
37:       <p>è¿™~ï¼@#ï¿¥%â€¦â€¦&*ï¼ˆï¼‰â€”â€”sdilfjnvn</p>
38:       <p>è¿™~ï¼@#ï¿¥%â€¦â€¦&*ï¼ˆï¼‰â€”â€”sdilfjnvn</p>
39:     `
40:   };
41:   error = false;
42:   lodop: Lodop | null = null;
43:   pinters: any[] = [];
44:   papers: string[] = [];
45: 
46:   printing = false;
47: 
48:   reload(options: { url: string } | null = { url: 'https://localhost:8443/CLodopfuncs.js' }): void {
49:     this.pinters = [];
50:     this.papers = [];
51:     this.cog.printer = '';
52:     this.cog.paper = '';
53: 
54:     this.lodopSrv.cog = { ...this.cog, ...options };
55:     this.error = false;
56:     if (options === null) {
57:       this.lodopSrv.reset();
58:     }
59:   }
60: 
61:   changePinter(name: string): void {
62:     if (this.lodop == null) {
63:       return;
64:     }
65:     this.papers = this.lodop.GET_PAGESIZES_LIST(name, '\n').split('\n');
66:   }
67:   print(isPrivew = false): void {
68:     const LODOP = this.lodop as Lodop;
69:     LODOP.PRINT_INITA(10, 20, 810, 610, 'æµ‹è¯•C-Lodopè¿œç¨‹æ‰“å°å››æ­¥éª¤');
70:     LODOP.SET_PRINTER_INDEXA(this.cog.printer);
71:     LODOP.SET_PRINT_PAGESIZE(0, 0, 0, this.cog.paper);
72:     LODOP.ADD_PRINT_TEXT(1, 1, 300, 200, 'ä¸‹é¢è¾“å‡ºçš„æ˜¯æœ¬é¡µæºä»£ç åŠå…¶å±•ç°æ•ˆæœï¼š');
73:     LODOP.ADD_PRINT_TEXT(20, 10, '90%', '95%', this.cog.html);
74:     LODOP.SET_PRINT_STYLEA(0, 'ItemType', 4);
75:     LODOP.NEWPAGEA();
76:     LODOP.ADD_PRINT_HTM(20, 10, '90%', '95%', this.cog.html);
77:     if (isPrivew) {
78:       LODOP.PREVIEW();
79:     } else {
80:       LODOP.PRINT();
81:     }
82:   }
83: }
````

## File: src/app/routes/delon/qr/qr.component.ts
````typescript
 1: import { Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: import { NzQRCodeComponent } from 'ng-zorro-antd/qr-code';
 4: 
 5: @Component({
 6:   selector: 'app-qr',
 7:   templateUrl: './qr.component.html',
 8:   imports: [...SHARED_IMPORTS, NzQRCodeComponent]
 9: })
10: export class QRComponent {
11:   value = 'https://ng-alain.com/';
12:   background = '#ffffff';
13:   foreground = '#000000';
14:   level: 'L' | 'M' | 'Q' | 'H' = 'L';
15:   mime = 'image/png';
16:   padding = 10;
17:   size = 220;
18: }
````

## File: src/app/routes/delon/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: import { aclCanActivate } from '@delon/acl';
 3: 
 4: import { ACLComponent } from './acl/acl.component';
 5: import { CacheComponent } from './cache/cache.component';
 6: import { DownFileComponent } from './downfile/downfile.component';
 7: import { DelonFormComponent } from './form/form.component';
 8: import { GuardAdminComponent } from './guard/admin.component';
 9: import { GuardAuthComponent } from './guard/auth.component';
10: import { canLeave } from './guard/can-leave';
11: import { GuardComponent } from './guard/guard.component';
12: import { GuardLeaveComponent } from './guard/leave.component';
13: import { PrintComponent } from './print/print.component';
14: import { QRComponent } from './qr/qr.component';
15: import { STDemoComponent } from './st/st.component';
16: import { UtilComponent } from './util/util.component';
17: import { XlsxComponent } from './xlsx/xlsx.component';
18: import { ZipComponent } from './zip/zip.component';
19: 
20: export const routes: Routes = [
21:   { path: 'st', component: STDemoComponent },
22:   { path: 'util', component: UtilComponent },
23:   { path: 'print', component: PrintComponent },
24:   { path: 'acl', component: ACLComponent },
25:   {
26:     path: 'guard',
27:     component: GuardComponent,
28:     children: [
29:       {
30:         path: 'leave',
31:         component: GuardLeaveComponent,
32:         canDeactivate: [canLeave]
33:       },
34:       {
35:         path: 'auth',
36:         component: GuardAuthComponent,
37:         canActivate: [aclCanActivate],
38:         data: { guard: 'user1' }
39:       },
40:       {
41:         path: 'admin',
42:         component: GuardAdminComponent,
43:         canActivate: [aclCanActivate],
44:         data: { guard: 'admin' }
45:       }
46:     ]
47:   },
48:   { path: 'cache', component: CacheComponent },
49:   { path: 'qr', component: QRComponent },
50:   { path: 'downfile', component: DownFileComponent },
51:   { path: 'xlsx', component: XlsxComponent },
52:   { path: 'zip', component: ZipComponent },
53:   { path: 'form', component: DelonFormComponent }
54: ];
````

## File: src/app/routes/delon/st/st.component.ts
````typescript
 1: import { Component, OnInit, inject } from '@angular/core';
 2: import { FullContentModule } from '@delon/abc/full-content';
 3: import { STColumn } from '@delon/abc/st';
 4: import { G2MiniBarComponent, G2MiniBarData } from '@delon/chart/mini-bar';
 5: import { _HttpClient } from '@delon/theme';
 6: import { SHARED_IMPORTS } from '@shared';
 7: import { NzMessageService } from 'ng-zorro-antd/message';
 8: 
 9: @Component({
10:   selector: 'app-st',
11:   templateUrl: './st.component.html',
12:   imports: [...SHARED_IMPORTS, FullContentModule, G2MiniBarComponent]
13: })
14: export class STDemoComponent implements OnInit {
15:   readonly http = inject(_HttpClient);
16:   private readonly message = inject(NzMessageService);
17: 
18:   ps = 20;
19:   total = 200; // mock total
20:   args = { _allow_anonymous: true, userid: null };
21:   url = `https://api.randomuser.me/?results=20`;
22:   events: G2MiniBarData[] = [];
23:   scroll = { y: '230px' };
24:   columns: STColumn[] = [
25:     { title: 'id', index: 'id.value', type: 'checkbox' },
26:     { title: 'Avatar', index: 'picture.thumbnail', type: 'img', width: 80 },
27:     {
28:       title: 'Name',
29:       index: 'name.first',
30:       width: 150,
31:       format: item => `${item.name.first} ${item.name.last}`,
32:       type: 'link',
33:       click: item => this.message.info(`${item.name.first}`)
34:     },
35:     { title: 'Email', index: 'email' },
36:     {
37:       title: 'Gender',
38:       index: 'gender',
39:       type: 'yn',
40:       yn: {
41:         truth: 'female',
42:         yes: 'ç”·',
43:         no: 'å¥³',
44:         mode: 'text'
45:       },
46:       width: 120
47:     },
48:     { title: 'Events', render: 'events', width: 90 },
49:     { title: 'Registered', index: 'registered.date', type: 'date', width: 170 },
50:     {
51:       title: 'Actions',
52:       width: 120,
53:       buttons: [
54:         {
55:           text: 'Edit',
56:           click: item => this.message.info(`edit [${item.id.value}]`),
57:           iif: item => item.gender === 'female'
58:         },
59:         {
60:           text: 'Delete',
61:           type: 'del',
62:           click: item => this.message.info(`deleted [${item.id.value}]`)
63:         }
64:       ]
65:     }
66:   ];
67: 
68:   ngOnInit(): void {
69:     this.http.get('/chart/visit').subscribe((res: G2MiniBarData[]) => (this.events = res.slice(0, 8)));
70:   }
71: 
72:   fullChange(val?: boolean): void {
73:     this.scroll = val ? { y: '350px' } : { y: '230px' };
74:   }
75: }
````

## File: src/app/routes/delon/util/util.component.ts
````typescript
 1: import { Component, inject } from '@angular/core';
 2: import { copy } from '@delon/util/browser';
 3: import { format } from '@delon/util/format';
 4: import { SHARED_IMPORTS, yuan } from '@shared';
 5: import { NzMessageService } from 'ng-zorro-antd/message';
 6: 
 7: @Component({
 8:   selector: 'app-util',
 9:   templateUrl: './util.component.html',
10:   imports: SHARED_IMPORTS
11: })
12: export class UtilComponent {
13:   readonly messageSrv = inject(NzMessageService);
14: 
15:   format_str = 'this is ${name}';
16:   format_res = '';
17:   format_obj = JSON.stringify({ name: 'asdf' });
18: 
19:   // yuan
20:   yuan_str: any;
21:   yuan_res!: string;
22: 
23:   content = `time ${+new Date()}
24: 
25:     ä¸­æ–‡ï¼@#ï¿¥%â€¦â€¦&*`;
26:   onFormat(): void {
27:     let obj = null;
28:     try {
29:       obj = JSON.parse(this.format_obj);
30:     } catch {
31:       this.messageSrv.error(`æ— æ³•ä½¿ç”¨ JSON.parse è½¬æ¢`);
32:       return;
33:     }
34:     this.format_res = format(this.format_str, obj, true);
35:   }
36:   onYuan(value: string): void {
37:     this.yuan_res = yuan(value);
38:   }
39:   onCopy(): void {
40:     copy(`time ${+new Date()}`).then(() => this.messageSrv.success(`success`));
41:   }
42: }
````

## File: src/app/routes/delon/xlsx/xlsx.component.ts
````typescript
 1: import { Component, inject } from '@angular/core';
 2: import { STColumn } from '@delon/abc/st';
 3: import { XlsxService } from '@delon/abc/xlsx';
 4: import { SHARED_IMPORTS } from '@shared';
 5: import { NzSafeAny } from 'ng-zorro-antd/core/types';
 6: 
 7: @Component({
 8:   selector: 'app-xlsx',
 9:   templateUrl: './xlsx.component.html',
10:   imports: SHARED_IMPORTS
11: })
12: export class XlsxComponent {
13:   private readonly xlsx = inject(XlsxService);
14: 
15:   data: any;
16:   users: Array<{ id: number; name: string; age: number }> = Array(100)
17:     .fill(0)
18:     .map((_item: number, idx: number) => {
19:       return {
20:         id: idx + 1,
21:         name: `name ${idx + 1}`,
22:         age: Math.ceil(Math.random() * 10) + 20
23:       };
24:     });
25: 
26:   columns: STColumn[] = [
27:     { title: 'ç¼–å·', index: 'id', type: 'checkbox' },
28:     { title: 'å§“å', index: 'name' },
29:     { title: 'å¹´é¾„', index: 'age' }
30:   ];
31: 
32:   url(): void {
33:     this.xlsx.import(`./assets/tmp/demo.xlsx`).then(res => (this.data = res));
34:   }
35: 
36:   change(e: Event): void {
37:     const file = (e.target as HTMLInputElement).files![0];
38:     this.xlsx.import(file).then(res => (this.data = res));
39:   }
40: 
41:   download(): void {
42:     const data = [this.columns.map(i => i.title)];
43:     this.users.forEach((i: Record<string, NzSafeAny>) => data.push(this.columns.map(c => i[c.index as string])));
44:     this.xlsx.export({
45:       sheets: [
46:         {
47:           data,
48:           name: 'sheet name'
49:         }
50:       ]
51:     });
52:   }
53: }
````

## File: src/app/routes/delon/zip/zip.component.ts
````typescript
 1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, OnInit, inject } from '@angular/core';
 2: import { ZipService } from '@delon/abc/zip';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import type jsZipType from 'jszip';
 5: import { NzMessageService } from 'ng-zorro-antd/message';
 6: 
 7: @Component({
 8:   selector: 'app-zip',
 9:   templateUrl: './zip.component.html',
10:   changeDetection: ChangeDetectionStrategy.OnPush,
11:   imports: SHARED_IMPORTS
12: })
13: export class ZipComponent implements OnInit {
14:   private readonly zip = inject(ZipService);
15:   private readonly msg = inject(NzMessageService);
16:   private readonly cdr = inject(ChangeDetectorRef);
17: 
18:   list: any;
19:   instance: jsZipType | null = null;
20:   data: Array<{ path?: string; url?: string }> = [
21:     { path: 'demo.docx', url: 'https://ng-alain.com/assets/demo.docx' },
22:     {
23:       path: 'å°ç¨‹åºæ ‡å¿—.zip',
24:       url: 'https://wximg.gtimg.com/shake_tv/mina/standard_logo.zip'
25:     }
26:   ];
27: 
28:   ngOnInit(): void {
29:     this.zip.create().then(ret => {
30:       this.instance = ret;
31:       this.cdr.detectChanges();
32:     });
33:   }
34: 
35:   private format(data: any): void {
36:     const files = data.files;
37:     this.list = Object.keys(files).map(key => {
38:       return {
39:         name: key,
40:         dir: files[key].dir,
41:         date: files[key].date
42:       };
43:     });
44:     this.cdr.detectChanges();
45:   }
46: 
47:   url(): void {
48:     this.zip.read(`./assets/tmp/demo.zip`).then(res => this.format(res));
49:   }
50: 
51:   change(e: Event): void {
52:     const file = (e.target as HTMLInputElement).files![0];
53:     this.zip.read(file).then(res => this.format(res));
54:   }
55: 
56:   download(): void {
57:     const promises: Array<Promise<void>> = [];
58:     this.data.forEach(item => {
59:       promises.push(this.zip.pushUrl(this.instance, item.path!, item.url!));
60:     });
61:     Promise.all(promises).then(
62:       () => {
63:         this.zip.save(this.instance).then(() => {
64:           this.msg.success('download success');
65:           this.data = [];
66:         });
67:       },
68:       (error: unknown) => {
69:         console.warn(error);
70:         this.msg.error(JSON.stringify(error));
71:       }
72:     );
73:   }
74: }
````

## File: src/app/routes/documents/browser/document-browser.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-document-browser',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'æ–‡æ¡£æµè§ˆå™¨'"></page-header>
11: 
12:     <nz-card nzTitle="æ–‡æ¡£æµè§ˆå™¨" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="æ–‡æ¡£æµè§ˆå™¨åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†æä¾›ç±»ä¼¼æ–‡ä»¶å¤¹çš„å±‚çº§æµè§ˆä½“éªŒã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class DocumentBrowserComponent {}
````

## File: src/app/routes/documents/drawings/drawing-viewer.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-drawing-viewer',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'å›¾çº¸æŸ¥çœ‹å™¨'"></page-header>
11: 
12:     <nz-card nzTitle="å›¾çº¸æŸ¥çœ‹å™¨" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="å›¾çº¸æŸ¥çœ‹å™¨åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†æ”¯æŒå¤§å‹å›¾çº¸æµè§ˆã€ç¼©ç•¥å›¾ä»¥åŠæ‰¹æ³¨ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class DrawingViewerComponent {}
````

## File: src/app/routes/documents/list/document-list.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-document-list',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'æ–‡æ¡£åˆ—è¡¨'">
11:       <ng-template #extra>
12:         <button nz-button nzType="primary" routerLink="/documents/upload">
13:           <span nz-icon nzType="upload"></span>
14:           ä¸Šä¼ æ–‡æ¡£
15:         </button>
16:       </ng-template>
17:     </page-header>
18: 
19:     <nz-card nzTitle="æ–‡æ¡£åˆ—è¡¨" style="margin-top: 16px;">
20:       <nz-alert
21:         nzType="info"
22:         nzMessage="æ–‡æ¡£ç®¡ç†åŠŸèƒ½å»ºè®¾ä¸­"
23:         nzDescription="æ­¤é¡µé¢å°†å±•ç¤ºæ–‡æ¡£åº“ä¸è¿‡æ»¤æ¡ä»¶ã€‚"
24:         [nzShowIcon]="true"
25:         style="margin-bottom: 16px;"
26:       ></nz-alert>
27:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
28:     </nz-card>
29:   `
30: })
31: export class DocumentListComponent {}
````

## File: src/app/routes/documents/metadata/document-metadata.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-document-metadata',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'æ–‡æ¡£å…ƒæ•°æ®'"></page-header>
11: 
12:     <nz-card nzTitle="æ–‡æ¡£å…ƒæ•°æ®" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="æ–‡æ¡£å…ƒæ•°æ®åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†æ˜¾ç¤ºæ–‡ä»¶å±æ€§ã€æ ‡ç­¾ä»¥åŠç‰ˆæœ¬å¯¹ç…§ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class DocumentMetadataComponent {}
````

## File: src/app/routes/documents/permissions/document-permission.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-document-permission',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'æƒé™è®¾ç½®'"></page-header>
11: 
12:     <nz-card nzTitle="æ–‡æ¡£æƒé™è®¾ç½®" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="æ–‡æ¡£æƒé™åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†ç®¡ç†æ–‡æ¡£ ACLã€åˆ†äº«é“¾æ¥ä¸å®¡è®¡ä¿¡æ¯ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class DocumentPermissionComponent {}
````

## File: src/app/routes/documents/preview/document-preview.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-document-preview',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'æ–‡æ¡£é¢„è§ˆ'"></page-header>
11: 
12:     <nz-card nzTitle="æ–‡æ¡£é¢„è§ˆ" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="æ–‡æ¡£é¢„è§ˆåŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†æ”¯æŒ Officeã€PDF ä»¥åŠ CAD å›¾çº¸ç­‰æ ¼å¼ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class DocumentPreviewComponent {}
````

## File: src/app/routes/documents/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: 
 3: export const DOCUMENT_ROUTES: Routes = [
 4:   {
 5:     path: '',
 6:     redirectTo: 'list',
 7:     pathMatch: 'full'
 8:   },
 9:   {
10:     path: 'list',
11:     loadComponent: () => import('./list/document-list.component').then(m => m.DocumentListComponent)
12:   },
13:   {
14:     path: 'upload',
15:     loadComponent: () => import('./upload/document-upload.component').then(m => m.DocumentUploadComponent)
16:   },
17:   {
18:     path: 'browser',
19:     loadComponent: () => import('./browser/document-browser.component').then(m => m.DocumentBrowserComponent)
20:   },
21:   {
22:     path: 'preview',
23:     loadComponent: () => import('./preview/document-preview.component').then(m => m.DocumentPreviewComponent)
24:   },
25:   {
26:     path: 'drawings',
27:     loadComponent: () => import('./drawings/drawing-viewer.component').then(m => m.DrawingViewerComponent)
28:   },
29:   {
30:     path: 'metadata',
31:     loadComponent: () => import('./metadata/document-metadata.component').then(m => m.DocumentMetadataComponent)
32:   },
33:   {
34:     path: 'versions',
35:     loadComponent: () => import('./versions/document-version.component').then(m => m.DocumentVersionComponent)
36:   },
37:   {
38:     path: 'permissions',
39:     loadComponent: () => import('./permissions/document-permission.component').then(m => m.DocumentPermissionComponent)
40:   }
41: ];
````

## File: src/app/routes/documents/upload/document-upload.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-document-upload',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'ä¸Šä¼ æ–‡æ¡£'"></page-header>
11: 
12:     <nz-card nzTitle="ä¸Šä¼ æ–‡æ¡£" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="ä¸Šä¼ æµç¨‹å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†æä¾›æ‰¹é‡ä¸Šä¼ ã€ç‰ˆæœ¬æ³¨é‡Šä¸æƒé™é…ç½®ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class DocumentUploadComponent {}
````

## File: src/app/routes/documents/versions/document-version.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-document-version',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'ç‰ˆæœ¬ç®¡ç†'"></page-header>
11: 
12:     <nz-card nzTitle="ç‰ˆæœ¬ç®¡ç†" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†æä¾›ç‰ˆæœ¬æ¯”å¯¹ã€å›æ»šä¸å®¡æ‰¹æµç¨‹ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class DocumentVersionComponent {}
````

## File: src/app/routes/exception/exception.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component, inject } from '@angular/core';
 2: import { ActivatedRoute } from '@angular/router';
 3: import { ExceptionModule, ExceptionType } from '@delon/abc/exception';
 4: 
 5: @Component({
 6:   selector: 'app-exception',
 7:   template: ` <exception [type]="type" style="min-height: 500px; height: 80%;" />`,
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   imports: [ExceptionModule]
10: })
11: export class ExceptionComponent {
12:   private readonly route = inject(ActivatedRoute);
13:   get type(): ExceptionType {
14:     return this.route.snapshot.data['type'];
15:   }
16: }
````

## File: src/app/routes/exception/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: 
 3: import { ExceptionComponent } from './exception.component';
 4: import { ExceptionTriggerComponent } from './trigger.component';
 5: 
 6: export const routes: Routes = [
 7:   { path: '403', component: ExceptionComponent, data: { type: 403 } },
 8:   { path: '404', component: ExceptionComponent, data: { type: 404 } },
 9:   { path: '500', component: ExceptionComponent, data: { type: 500 } },
10:   { path: 'trigger', component: ExceptionTriggerComponent }
11: ];
````

## File: src/app/routes/exception/trigger.component.ts
````typescript
 1: import { Component, inject } from '@angular/core';
 2: import { DA_SERVICE_TOKEN } from '@delon/auth';
 3: import { _HttpClient } from '@delon/theme';
 4: import { NzButtonModule } from 'ng-zorro-antd/button';
 5: import { NzCardModule } from 'ng-zorro-antd/card';
 6: 
 7: @Component({
 8:   selector: 'exception-trigger',
 9:   template: `
10:     <div class="pt-lg">
11:       <nz-card>
12:         @for (t of types; track $index) {
13:           <button (click)="go(t)" nz-button nzDanger>è§¦å‘{{ t }}</button>
14:         }
15:         <button nz-button nzType="link" (click)="refresh()">è§¦å‘åˆ·æ–°Token</button>
16:       </nz-card>
17:     </div>
18:   `,
19:   imports: [NzCardModule, NzButtonModule]
20: })
21: export class ExceptionTriggerComponent {
22:   private readonly http = inject(_HttpClient);
23:   private readonly tokenService = inject(DA_SERVICE_TOKEN);
24: 
25:   types = [401, 403, 404, 500];
26: 
27:   go(type: number): void {
28:     this.http.get(`/api/${type}`).subscribe();
29:   }
30: 
31:   refresh(): void {
32:     this.tokenService.set({ token: 'invalid-token' });
33:     // å¿…é¡»æä¾›ä¸€ä¸ªåç«¯åœ°å€ï¼Œæ— æ³•é€šè¿‡ Mock æ¥æ¨¡æ‹Ÿ
34:     this.http.post(`https://localhost:5001/auth`).subscribe({
35:       next: res => console.warn('æˆåŠŸ', res),
36:       error: err => {
37:         console.log('æœ€åç»“æœå¤±è´¥', err);
38:       }
39:     });
40:   }
41: }
````

## File: src/app/routes/extras/helpcenter/helpcenter.component.ts
````typescript
 1: import { Component, inject } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: import { NzMessageService } from 'ng-zorro-antd/message';
 4: 
 5: @Component({
 6:   selector: 'app-helpcenter',
 7:   templateUrl: './helpcenter.component.html',
 8:   imports: SHARED_IMPORTS
 9: })
10: export class HelpCenterComponent {
11:   readonly msg = inject(NzMessageService);
12:   type = '';
13:   q = '';
14: 
15:   quick(key: string): void {
16:     this.q = key;
17:     this.search();
18:   }
19: 
20:   search(): void {
21:     this.msg.success(`æœç´¢ï¼š${this.q}`);
22:   }
23: }
````

## File: src/app/routes/extras/poi/edit/edit.component.ts
````typescript
 1: import { Component, OnInit, inject } from '@angular/core';
 2: import { _HttpClient } from '@delon/theme';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: import { NzModalRef } from 'ng-zorro-antd/modal';
 6: 
 7: @Component({
 8:   selector: 'app-extras-poi-edit',
 9:   templateUrl: './edit.component.html',
10:   imports: SHARED_IMPORTS
11: })
12: export class ExtrasPoiEditComponent implements OnInit {
13:   readonly msgSrv = inject(NzMessageService);
14:   private readonly modal = inject(NzModalRef);
15:   readonly http = inject(_HttpClient);
16: 
17:   i: any;
18:   cat: string[] = ['ç¾é£Ÿ', 'ç¾é£Ÿ,ç²¤èœ', 'ç¾é£Ÿ,ç²¤èœ,æ¹›æ±Ÿèœ'];
19: 
20:   ngOnInit(): void {
21:     if (this.i.id > 0) {
22:       this.http.get('/pois').subscribe(res => (this.i = res.list[0]));
23:     }
24:   }
25: 
26:   save(): void {
27:     this.http.get('/pois').subscribe(() => {
28:       this.msgSrv.success('ä¿å­˜æˆåŠŸï¼Œåªæ˜¯æ¨¡æ‹Ÿï¼Œå®é™…æœªå˜æ›´');
29:       this.modal.destroy(true);
30:     });
31:   }
32: 
33:   close(): void {
34:     this.modal.destroy();
35:   }
36: }
````

## File: src/app/routes/extras/poi/poi.component.ts
````typescript
 1: import { Component, ViewChild, inject } from '@angular/core';
 2: import { STColumn, STComponent } from '@delon/abc/st';
 3: import { ModalHelper } from '@delon/theme';
 4: import { SHARED_IMPORTS } from '@shared';
 5: import { NzMessageService } from 'ng-zorro-antd/message';
 6: 
 7: import { ExtrasPoiEditComponent } from './edit/edit.component';
 8: 
 9: @Component({
10:   selector: 'app-extras-poi',
11:   templateUrl: './poi.component.html',
12:   imports: SHARED_IMPORTS
13: })
14: export class ExtrasPoiComponent {
15:   private readonly msg = inject(NzMessageService);
16:   private readonly modal = inject(ModalHelper);
17: 
18:   @ViewChild('st', { static: true })
19:   st!: STComponent;
20:   s = {
21:     pi: 1,
22:     ps: 10,
23:     user_id: '',
24:     s: '',
25:     q: ''
26:   };
27:   url = '/pois';
28:   columns: STColumn[] = [
29:     { title: 'ç¼–å·', index: 'id', width: '100px' },
30:     { title: 'é—¨åº—åç§°', index: 'name' },
31:     { title: 'åˆ†åº—å', index: 'branch_name' },
32:     { title: 'çŠ¶æ€', index: 'status_str', width: '100px' },
33:     {
34:       title: 'æ“ä½œ',
35:       width: '180px',
36:       buttons: [
37:         {
38:           text: 'ç¼–è¾‘',
39:           type: 'modal',
40:           modal: {
41:             component: ExtrasPoiEditComponent,
42:             paramsName: 'i'
43:           },
44:           click: () => this.msg.info('å›è°ƒï¼Œé‡æ–°å‘èµ·åˆ—è¡¨åˆ·æ–°')
45:         },
46:         { text: 'å›¾ç‰‡', click: () => this.msg.info('click photo') },
47:         { text: 'ç»è¥SKU', click: () => this.msg.info('click sku') }
48:       ]
49:     }
50:   ];
51: 
52:   add(): void {
53:     this.modal.createStatic(ExtrasPoiEditComponent, { i: { id: 0 } }).subscribe(() => {
54:       this.st.load();
55:       this.msg.info('å›è°ƒï¼Œé‡æ–°å‘èµ·åˆ—è¡¨åˆ·æ–°');
56:     });
57:   }
58: }
````

## File: src/app/routes/extras/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: 
 3: import { HelpCenterComponent } from './helpcenter/helpcenter.component';
 4: import { ExtrasPoiComponent } from './poi/poi.component';
 5: import { ExtrasSettingsComponent } from './settings/settings.component';
 6: 
 7: export const routes: Routes = [
 8:   { path: '', redirectTo: 'helpcenter', pathMatch: 'full' },
 9:   { path: 'helpcenter', component: HelpCenterComponent },
10:   { path: 'settings', component: ExtrasSettingsComponent },
11:   { path: 'poi', component: ExtrasPoiComponent }
12: ];
````

## File: src/app/routes/extras/settings/settings.component.ts
````typescript
 1: import { Component, OnInit, inject } from '@angular/core';
 2: import { FormBuilder, Validators } from '@angular/forms';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: import { NzUploadComponent } from 'ng-zorro-antd/upload';
 6: 
 7: @Component({
 8:   selector: 'app-extras-settings',
 9:   templateUrl: './settings.component.html',
10:   imports: [...SHARED_IMPORTS, NzUploadComponent]
11: })
12: export class ExtrasSettingsComponent implements OnInit {
13:   readonly msg = inject(NzMessageService);
14: 
15:   active = 1;
16:   profileForm = inject(FormBuilder).nonNullable.group({
17:     name: ['', Validators.compose([Validators.required, Validators.pattern(`^[-_a-zA-Z0-9]{4,20}$`)])],
18:     email: '',
19:     bio: ['', Validators.maxLength(160)],
20:     url: '',
21:     company: '',
22:     location: ''
23:   });
24:   pwd = {
25:     old_password: '',
26:     new_password: '',
27:     confirm_new_password: ''
28:   };
29:   // Email
30:   primary_email = 'cipchk@qq.com';
31: 
32:   profileSave(value: any): void {
33:     console.log('profile value', value);
34:   }
35: 
36:   pwdSave(): void {
37:     if (!this.pwd.old_password) {
38:       this.msg.error('invalid old password');
39:       return;
40:     }
41:     if (!this.pwd.new_password) {
42:       this.msg.error('invalid new password');
43:       return;
44:     }
45:     if (!this.pwd.confirm_new_password) {
46:       this.msg.error('invalid confirm new password');
47:       return;
48:     }
49:     console.log('pwd value', this.pwd);
50:   }
51: 
52:   ngOnInit(): void {
53:     this.profileForm.patchValue({
54:       name: 'cipchk',
55:       email: 'cipchk@qq.com'
56:     });
57:   }
58: }
````

## File: src/app/routes/issues/assignments/issue-assignments.component.ts
````typescript
 1: import { Component, OnInit, inject } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-issue-assignments',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   template: `
 9:     <page-header [title]="'é—®é¢˜åˆ†é…'"></page-header>
10: 
11:     <nz-card nzTitle="é—®é¢˜åˆ†é…ç®¡ç†" style="margin-top: 16px;">
12:       <nz-alert
13:         nzType="info"
14:         nzMessage="é—®é¢˜åˆ†é…åŠŸèƒ½å¼€å‘ä¸­"
15:         nzDescription="æ­¤é¡µé¢å°†ç”¨äºç®¡ç†é—®é¢˜çš„åˆ†é…ã€‚"
16:         [nzShowIcon]="true"
17:         style="margin-bottom: 16px;"
18:       ></nz-alert>
19: 
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class IssueAssignmentsComponent implements OnInit {
25:   ngOnInit(): void {
26:     // TODO: åŠ è½½é—®é¢˜åˆ†é…æ•°æ®
27:   }
28: }
````

## File: src/app/routes/issues/close-summary/issue-close-summary.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: interface SummaryCard {
 5:   readonly title: string;
 6:   readonly value: string;
 7:   readonly note: string;
 8: }
 9: 
10: @Component({
11:   selector: 'app-issue-close-summary',
12:   standalone: true,
13:   imports: [SHARED_IMPORTS],
14:   template: `
15:     <nz-page-header [nzTitle]="'çµæ¡ˆæ‘˜è¦éª¨æ¶'" [nzSubtitle]="'ç¤ºæ„ç¸½çµè³‡è¨Š'">
16:       <nz-page-header-extra>
17:         <button nz-button nzType="default">
18:           <span nz-icon nzType="file-text"></span>
19:           åŒ¯å‡ºå ±å‘Š
20:         </button>
21:         <button nz-button nzType="primary">
22:           <span nz-icon nzType="check"></span>
23:           å®Œæˆçµæ¡ˆ
24:         </button>
25:       </nz-page-header-extra>
26:     </nz-page-header>
27: 
28:     <div class="page-section">
29:       <nz-row [nzGutter]="16">
30:         @for (card of summaryCards; track card.title) {
31:           <nz-col nzXs="24" nzSm="12" nzXl="6">
32:             <nz-card nzSize="small">
33:               <div class="card-value">{{ card.value }}</div>
34:               <div class="card-title">{{ card.title }}</div>
35:               <div class="card-note">{{ card.note }}</div>
36:             </nz-card>
37:           </nz-col>
38:         }
39:       </nz-row>
40: 
41:       <nz-card nzTitle="çµæ¡ˆèªªæ˜">
42:         <nz-typography>
43:           <p> é€™è£¡æä¾›éœæ…‹èªªæ˜æ–‡æœ¬ï¼Œç”¨æ–¼é–‹ç™¼æ™‚å¿«é€Ÿç¢ºèªä½ˆå±€ã€‚å¯åŠ å…¥ Markdownã€å¯Œæ–‡å­—æˆ–è¡¨æ ¼ç­‰è‡ªè¨‚å…§å®¹ã€‚ </p>
44:         </nz-typography>
45:       </nz-card>
46:     </div>
47:   `,
48:   styles: [
49:     `
50:       :host {
51:         display: block;
52:       }
53: 
54:       .page-section {
55:         padding: 16px;
56:         display: flex;
57:         flex-direction: column;
58:         gap: 16px;
59:       }
60: 
61:       .card-value {
62:         font-size: 26px;
63:         font-weight: 600;
64:       }
65: 
66:       .card-title {
67:         font-size: 14px;
68:         color: rgba(0, 0, 0, 0.65);
69:       }
70: 
71:       .card-note {
72:         font-size: 12px;
73:         color: rgba(0, 0, 0, 0.45);
74:       }
75:     `
76:   ],
77:   changeDetection: ChangeDetectionStrategy.OnPush
78: })
79: export class IssueCloseSummaryComponent {
80:   protected readonly summaryCards: SummaryCard[] = [
81:     { title: 'å¹³å‡è™•ç†æ™‚é–“', value: '2.4h', note: 'å«è‡ªå‹•åŒ–æµç¨‹' },
82:     { title: 'åƒèˆ‡äººæ•¸', value: '5', note: 'è·¨æ¨¡çµ„å”ä½œ' },
83:     { title: 'å‰©é¤˜è¿½è¹¤', value: '1', note: 'å¾…è£œé©—è­‰' },
84:     { title: 'é‡ç¾æ¬¡æ•¸', value: '0', note: 'å·²ç¢ºèªä¿®å¾©' }
85:   ];
86: }
````

## File: src/app/routes/issues/close/issue-close.component.ts
````typescript
 1: import { Component, OnInit, inject } from '@angular/core';
 2: import { ActivatedRoute, Router } from '@angular/router';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: 
 6: @Component({
 7:   selector: 'app-issue-close',
 8:   standalone: true,
 9:   imports: [SHARED_IMPORTS],
10:   template: `
11:     <page-header [title]="'å…³é—­é—®é¢˜'"></page-header>
12: 
13:     <nz-card nzTitle="å…³é—­é—®é¢˜" style="margin-top: 16px;">
14:       <nz-alert
15:         nzType="info"
16:         nzMessage="å…³é—­é—®é¢˜åŠŸèƒ½å¼€å‘ä¸­"
17:         nzDescription="æ­¤é¡µé¢å°†ç”¨äºå…³é—­é—®é¢˜ã€‚"
18:         [nzShowIcon]="true"
19:         style="margin-bottom: 16px;"
20:       ></nz-alert>
21: 
22:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
23:     </nz-card>
24:   `
25: })
26: export class IssueCloseComponent implements OnInit {
27:   route = inject(ActivatedRoute);
28:   router = inject(Router);
29:   message = inject(NzMessageService);
30: 
31:   issueId = '';
32: 
33:   ngOnInit(): void {
34:     this.issueId = this.route.snapshot.paramMap.get('id') || '';
35:     if (!this.issueId) {
36:       this.message.error('é—®é¢˜IDä¸å­˜åœ¨');
37:       this.router.navigate(['/issues']);
38:     }
39:   }
40: }
````

## File: src/app/routes/issues/detail-static/issue-detail-static.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: interface Timeline {
 5:   readonly title: string;
 6:   readonly description: string;
 7:   readonly color: string;
 8: }
 9: 
10: @Component({
11:   selector: 'app-issue-detail-static',
12:   standalone: true,
13:   imports: [SHARED_IMPORTS],
14:   template: `
15:     <nz-page-header [nzTitle]="'å•é¡Œè©³æƒ…éª¨æ¶'" [nzSubtitle]="'æä¾›éœæ…‹æ’æŸ¥ä½ˆå±€'">
16:       <nz-page-header-extra>
17:         <button nz-button nzType="default">
18:           <span nz-icon nzType="edit"></span>
19:           ç·¨è¼¯å ä½
20:         </button>
21:         <button nz-button nzType="primary">
22:           <span nz-icon nzType="share-alt"></span>
23:           æ´¾é€
24:         </button>
25:       </nz-page-header-extra>
26:     </nz-page-header>
27: 
28:     <div class="page-section">
29:       <nz-card nzTitle="åŸºæœ¬è³‡è¨Š">
30:         <nz-descriptions nzBordered [nzColumn]="{ xxl: 3, xl: 2, lg: 2, md: 2, sm: 1, xs: 1 }">
31:           <nz-descriptions-item nzTitle="å•é¡Œæ¨™é¡Œ">ç¤ºæ„é é¢ï¼šè¨­å‚™é…å¯˜éŒ¯èª¤</nz-descriptions-item>
32:           <nz-descriptions-item nzTitle="ç‹€æ…‹">
33:             <nz-tag nzColor="orange">é€²è¡Œä¸­</nz-tag>
34:           </nz-descriptions-item>
35:           <nz-descriptions-item nzTitle="å„ªå…ˆåº¦">
36:             <nz-rate [ngModel]="3" nzDisabled></nz-rate>
37:           </nz-descriptions-item>
38:           <nz-descriptions-item nzTitle="å»ºç«‹æ™‚é–“">2025-11-14 09:32</nz-descriptions-item>
39:           <nz-descriptions-item nzTitle="æŒ‡æ´¾çµ¦">Issue Team</nz-descriptions-item>
40:         </nz-descriptions>
41:       </nz-card>
42: 
43:       <nz-card nzTitle="æ™‚é–“ç·š">
44:         <nz-timeline>
45:           @for (item of timeline; track item.title) {
46:             <nz-timeline-item [nzColor]="item.color">
47:               <div class="timeline-title">{{ item.title }}</div>
48:               <div class="timeline-desc">{{ item.description }}</div>
49:             </nz-timeline-item>
50:           }
51:         </nz-timeline>
52:       </nz-card>
53:     </div>
54:   `,
55:   styles: [
56:     `
57:       :host {
58:         display: block;
59:       }
60: 
61:       .page-section {
62:         padding: 16px;
63:         display: flex;
64:         flex-direction: column;
65:         gap: 16px;
66:       }
67: 
68:       .timeline-title {
69:         font-weight: 600;
70:       }
71: 
72:       .timeline-desc {
73:         color: rgba(0, 0, 0, 0.55);
74:       }
75:     `
76:   ],
77:   changeDetection: ChangeDetectionStrategy.OnPush
78: })
79: export class IssueDetailStaticComponent {
80:   protected readonly timeline: Timeline[] = [
81:     { title: 'å»ºç«‹å•é¡Œ', description: 'ç”± QA Bot å»ºç«‹', color: 'blue' },
82:     { title: 'æ´¾é€çµ¦ Issue Team', description: 'å¾…äººå·¥ç¢ºèª', color: 'green' },
83:     { title: 'ç­‰å¾…è³‡æ–™å›å¡«', description: 'éœ€ç³»çµ±ç´€éŒ„', color: 'orange' }
84:   ];
85: }
````

## File: src/app/routes/issues/detail/issue-detail.component.ts
````typescript
 1: import { Component, OnInit, inject } from '@angular/core';
 2: import { ActivatedRoute, Router } from '@angular/router';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: 
 6: @Component({
 7:   selector: 'app-issue-detail',
 8:   standalone: true,
 9:   imports: [SHARED_IMPORTS],
10:   template: `
11:     <page-header [title]="'é—®é¢˜è¯¦æƒ…'">
12:       <ng-template #extra>
13:         <button nz-button (click)="handle()">å¤„ç†</button>
14:         <button nz-button nzType="primary" (click)="close()" style="margin-left: 8px;">å…³é—­</button>
15:       </ng-template>
16:     </page-header>
17: 
18:     <nz-card nzTitle="é—®é¢˜è¯¦ç»†ä¿¡æ¯" style="margin-top: 16px;">
19:       <nz-alert
20:         nzType="info"
21:         nzMessage="é—®é¢˜è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­"
22:         nzDescription="æ­¤é¡µé¢å°†ç”¨äºæ˜¾ç¤ºé—®é¢˜çš„è¯¦ç»†ä¿¡æ¯ã€‚"
23:         [nzShowIcon]="true"
24:         style="margin-bottom: 16px;"
25:       ></nz-alert>
26: 
27:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
28:     </nz-card>
29:   `
30: })
31: export class IssueDetailComponent implements OnInit {
32:   route = inject(ActivatedRoute);
33:   router = inject(Router);
34:   message = inject(NzMessageService);
35: 
36:   issueId = '';
37: 
38:   ngOnInit(): void {
39:     this.issueId = this.route.snapshot.paramMap.get('id') || '';
40:     if (!this.issueId) {
41:       this.message.error('é—®é¢˜IDä¸å­˜åœ¨');
42:       this.router.navigate(['/issues']);
43:     }
44:   }
45: 
46:   handle(): void {
47:     this.router.navigate(['/issues', this.issueId, 'handle']);
48:   }
49: 
50:   close(): void {
51:     this.router.navigate(['/issues', this.issueId, 'close']);
52:   }
53: }
````

## File: src/app/routes/issues/form/issue-form.component.ts
````typescript
 1: import { Component, OnInit, inject } from '@angular/core';
 2: import { ActivatedRoute, Router } from '@angular/router';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: 
 6: @Component({
 7:   selector: 'app-issue-form',
 8:   standalone: true,
 9:   imports: [SHARED_IMPORTS],
10:   template: `
11:     <page-header [title]="isEdit ? 'ç¼–è¾‘é—®é¢˜' : 'æ–°å»ºé—®é¢˜'"></page-header>
12: 
13:     <nz-card nzTitle="é—®é¢˜è¡¨å•" style="margin-top: 16px;">
14:       <nz-alert
15:         nzType="info"
16:         nzMessage="é—®é¢˜è¡¨å•åŠŸèƒ½å¼€å‘ä¸­"
17:         nzDescription="æ­¤é¡µé¢å°†ç”¨äºåˆ›å»ºæˆ–ç¼–è¾‘é—®é¢˜ã€‚"
18:         [nzShowIcon]="true"
19:         style="margin-bottom: 16px;"
20:       ></nz-alert>
21: 
22:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
23:     </nz-card>
24:   `
25: })
26: export class IssueFormComponent implements OnInit {
27:   route = inject(ActivatedRoute);
28:   router = inject(Router);
29:   message = inject(NzMessageService);
30: 
31:   isEdit = false;
32:   issueId = '';
33: 
34:   ngOnInit(): void {
35:     this.issueId = this.route.snapshot.paramMap.get('id') || '';
36:     this.isEdit = !!this.issueId;
37:   }
38: }
````

## File: src/app/routes/issues/handle-center/issue-handle-center.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: interface ChecklistItem {
 5:   readonly label: string;
 6:   readonly done: boolean;
 7: }
 8: 
 9: @Component({
10:   selector: 'app-issue-handle-center',
11:   standalone: true,
12:   imports: [SHARED_IMPORTS],
13:   template: `
14:     <nz-page-header [nzTitle]="'è™•ç†ä¸­å¿ƒéª¨æ¶'" [nzSubtitle]="'ç¤ºæ„æµç¨‹èˆ‡è¡¨å–®'">
15:       <nz-page-header-extra>
16:         <button nz-button nzType="default">
17:           <span nz-icon nzType="tool"></span>
18:           å‘¼å« Bot
19:         </button>
20:         <button nz-button nzType="primary">
21:           <span nz-icon nzType="play-circle"></span>
22:           åŸ·è¡Œè…³æœ¬
23:         </button>
24:       </nz-page-header-extra>
25:     </nz-page-header>
26: 
27:     <div class="page-section">
28:       <nz-row [nzGutter]="16">
29:         <nz-col nzXs="24" nzXl="12">
30:           <nz-card nzTitle="è™•ç†è…³æœ¬">
31:             <form nz-form nzLayout="vertical">
32:               <nz-form-item>
33:                 <nz-form-label>è…³æœ¬æ¨¡æ¿</nz-form-label>
34:                 <nz-form-control>
35:                   <nz-select nzPlaceHolder="é¸æ“‡æ¨¡æ¿">
36:                     <nz-option nzValue="rollback" nzLabel="Rollback è¨­å‚™è¨­å®š"></nz-option>
37:                     <nz-option nzValue="sync" nzLabel="åŒæ­¥åƒæ•¸"></nz-option>
38:                   </nz-select>
39:                 </nz-form-control>
40:               </nz-form-item>
41: 
42:               <nz-form-item>
43:                 <nz-form-label>å‚™è¨»</nz-form-label>
44:                 <nz-form-control>
45:                   <textarea nz-input rows="3"></textarea>
46:                 </nz-form-control>
47:               </nz-form-item>
48:             </form>
49:           </nz-card>
50:         </nz-col>
51: 
52:         <nz-col nzXs="24" nzXl="12">
53:           <nz-card nzTitle="è™•ç†æ¸…å–®">
54:             <nz-list>
55:               @for (item of checklist; track item.label) {
56:                 <nz-list-item>
57:                   <label nz-checkbox [ngModel]="item.done">{{ item.label }}</label>
58:                 </nz-list-item>
59:               }
60:             </nz-list>
61:           </nz-card>
62:         </nz-col>
63:       </nz-row>
64:     </div>
65:   `,
66:   styles: [
67:     `
68:       :host {
69:         display: block;
70:       }
71: 
72:       .page-section {
73:         padding: 16px;
74:       }
75:     `
76:   ],
77:   changeDetection: ChangeDetectionStrategy.OnPush
78: })
79: export class IssueHandleCenterComponent {
80:   protected readonly checklist: ChecklistItem[] = [
81:     { label: 'ç¢ºèªå•é¡Œæè¿°', done: true },
82:     { label: 'åŒæ­¥è¨­å‚™ç´€éŒ„', done: false },
83:     { label: 'æ’ç¨‹äºŒæ¬¡é©—è­‰', done: false }
84:   ];
85: }
````

## File: src/app/routes/issues/handle/issue-handle.component.ts
````typescript
 1: import { Component, OnInit, inject } from '@angular/core';
 2: import { ActivatedRoute, Router } from '@angular/router';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: 
 6: @Component({
 7:   selector: 'app-issue-handle',
 8:   standalone: true,
 9:   imports: [SHARED_IMPORTS],
10:   template: `
11:     <page-header [title]="'å¤„ç†é—®é¢˜'"></page-header>
12: 
13:     <nz-card nzTitle="é—®é¢˜å¤„ç†" style="margin-top: 16px;">
14:       <nz-alert
15:         nzType="info"
16:         nzMessage="é—®é¢˜å¤„ç†åŠŸèƒ½å¼€å‘ä¸­"
17:         nzDescription="æ­¤é¡µé¢å°†ç”¨äºå¤„ç†é—®é¢˜ã€‚"
18:         [nzShowIcon]="true"
19:         style="margin-bottom: 16px;"
20:       ></nz-alert>
21: 
22:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
23:     </nz-card>
24:   `
25: })
26: export class IssueHandleComponent implements OnInit {
27:   route = inject(ActivatedRoute);
28:   router = inject(Router);
29:   message = inject(NzMessageService);
30: 
31:   issueId = '';
32: 
33:   ngOnInit(): void {
34:     this.issueId = this.route.snapshot.paramMap.get('id') || '';
35:     if (!this.issueId) {
36:       this.message.error('é—®é¢˜IDä¸å­˜åœ¨');
37:       this.router.navigate(['/issues']);
38:     }
39:   }
40: }
````

## File: src/app/routes/issues/list/issue-list.component.ts
````typescript
 1: import { Component, OnInit, inject } from '@angular/core';
 2: import { Router } from '@angular/router';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: 
 6: @Component({
 7:   selector: 'app-issue-list',
 8:   standalone: true,
 9:   imports: [SHARED_IMPORTS],
10:   template: `
11:     <page-header [title]="'é—®é¢˜åˆ—è¡¨'">
12:       <ng-template #extra>
13:         <button nz-button nzType="primary" (click)="createIssue()">
14:           <span nz-icon nzType="plus"></span>
15:           æ–°å»ºé—®é¢˜
16:         </button>
17:       </ng-template>
18:     </page-header>
19: 
20:     <nz-card nzTitle="é—®é¢˜è·Ÿè¸ªç®¡ç†" style="margin-top: 16px;">
21:       <nz-alert
22:         nzType="info"
23:         nzMessage="é—®é¢˜è·Ÿè¸ªåŠŸèƒ½å¼€å‘ä¸­"
24:         nzDescription="æ­¤é¡µé¢å°†ç”¨äºæ˜¾ç¤ºå’Œç®¡ç†æ‰€æœ‰é—®é¢˜ã€‚"
25:         [nzShowIcon]="true"
26:         style="margin-bottom: 16px;"
27:       ></nz-alert>
28: 
29:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
30:     </nz-card>
31:   `
32: })
33: export class IssueListComponent implements OnInit {
34:   router = inject(Router);
35:   message = inject(NzMessageService);
36: 
37:   ngOnInit(): void {
38:     // TODO: åŠ è½½é—®é¢˜åˆ—è¡¨
39:   }
40: 
41:   createIssue(): void {
42:     this.router.navigate(['/issues/create']);
43:   }
44: }
````

## File: src/app/routes/issues/photos-wall/issue-photos-wall.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: import type { NzUploadFile } from 'ng-zorro-antd/upload';
 4: 
 5: interface PhotoItem {
 6:   readonly name: string;
 7:   readonly thumbUrl: string;
 8:   readonly datetime: string;
 9: }
10: 
11: @Component({
12:   selector: 'app-issue-photos-wall',
13:   standalone: true,
14:   imports: [SHARED_IMPORTS],
15:   template: `
16:     <nz-page-header [nzTitle]="'ç…§ç‰‡ç‰†éª¨æ¶'" [nzSubtitle]="'ç¤ºæ„åœ–ç‰‡ä½”ä½'">
17:       <nz-page-header-extra>
18:         <button nz-button nzType="default">
19:           <span nz-icon nzType="cloud-upload"></span>
20:           ä¸Šå‚³
21:         </button>
22:         <button nz-button nzType="primary">
23:           <span nz-icon nzType="picture"></span>
24:           é–‹å•Ÿæª¢è¦–å™¨
25:         </button>
26:       </nz-page-header-extra>
27:     </nz-page-header>
28: 
29:     <div class="page-section">
30:       <nz-upload nzListType="picture-card" [nzFileList]="photoFileList">
31:         <button nz-button>
32:           <span nz-icon nzType="plus"></span>
33:           æ–°å¢
34:         </button>
35:       </nz-upload>
36: 
37:       <nz-card nzTitle="æ‹æ”ç´€éŒ„">
38:         <nz-table [nzData]="photoFileList" nzSize="small">
39:           <thead>
40:             <tr>
41:               <th>æª”å</th>
42:               <th>æ™‚é–“</th>
43:             </tr>
44:           </thead>
45:           <tbody>
46:             @for (item of photoFileList; track item.uid) {
47:               <tr>
48:                 <td>{{ item.name }}</td>
49:                 <td>{{ item.datetime }}</td>
50:               </tr>
51:             }
52:           </tbody>
53:         </nz-table>
54:       </nz-card>
55:     </div>
56:   `,
57:   styles: [
58:     `
59:       :host {
60:         display: block;
61:       }
62: 
63:       .page-section {
64:         padding: 16px;
65:         display: flex;
66:         flex-direction: column;
67:         gap: 16px;
68:       }
69:     `
70:   ],
71:   changeDetection: ChangeDetectionStrategy.OnPush
72: })
73: export class IssuePhotosWallComponent {
74:   protected readonly photoFileList: Array<PhotoItem & NzUploadFile> = [
75:     {
76:       uid: '1',
77:       name: 'evidence-1.png',
78:       thumbUrl: 'https://via.placeholder.com/200x120.png?text=Evidence+1',
79:       datetime: '2025-11-14 09:20'
80:     },
81:     {
82:       uid: '2',
83:       name: 'evidence-2.png',
84:       thumbUrl: 'https://via.placeholder.com/200x120.png?text=Evidence+2',
85:       datetime: '2025-11-14 09:40'
86:     }
87:   ];
88: }
````

## File: src/app/routes/issues/photos/issue-photos.component.ts
````typescript
 1: import { Component, OnInit, inject } from '@angular/core';
 2: import { ActivatedRoute, Router } from '@angular/router';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: 
 6: @Component({
 7:   selector: 'app-issue-photos',
 8:   standalone: true,
 9:   imports: [SHARED_IMPORTS],
10:   template: `
11:     <page-header [title]="'å¤„ç†ç…§ç‰‡'"></page-header>
12: 
13:     <nz-card nzTitle="é—®é¢˜å¤„ç†ç…§ç‰‡ç®¡ç†" style="margin-top: 16px;">
14:       <nz-alert
15:         nzType="info"
16:         nzMessage="å¤„ç†ç…§ç‰‡åŠŸèƒ½å¼€å‘ä¸­"
17:         nzDescription="æ­¤é¡µé¢å°†ç”¨äºç®¡ç†é—®é¢˜å¤„ç†ç…§ç‰‡ã€‚"
18:         [nzShowIcon]="true"
19:         style="margin-bottom: 16px;"
20:       ></nz-alert>
21: 
22:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
23:     </nz-card>
24:   `
25: })
26: export class IssuePhotosComponent implements OnInit {
27:   route = inject(ActivatedRoute);
28:   router = inject(Router);
29:   message = inject(NzMessageService);
30: 
31:   issueId = '';
32: 
33:   ngOnInit(): void {
34:     this.issueId = this.route.snapshot.paramMap.get('id') || '';
35:     if (!this.issueId) {
36:       this.message.error('é—®é¢˜IDä¸å­˜åœ¨');
37:       this.router.navigate(['/issues']);
38:     }
39:   }
40: }
````

## File: src/app/routes/issues/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: 
 3: export const ISSUE_ROUTES: Routes = [
 4:   {
 5:     path: '',
 6:     redirectTo: 'list',
 7:     pathMatch: 'full'
 8:   },
 9:   {
10:     path: 'list',
11:     loadComponent: () => import('./list/issue-list.component').then(m => m.IssueListComponent)
12:   },
13:   {
14:     path: 'create',
15:     loadComponent: () => import('./form/issue-form.component').then(m => m.IssueFormComponent)
16:   },
17:   {
18:     path: 'detail',
19:     loadComponent: () => import('./detail-static/issue-detail-static.component').then(m => m.IssueDetailStaticComponent)
20:   },
21:   {
22:     path: 'handle',
23:     loadComponent: () => import('./handle-center/issue-handle-center.component').then(m => m.IssueHandleCenterComponent)
24:   },
25:   {
26:     path: 'photos',
27:     loadComponent: () => import('./photos-wall/issue-photos-wall.component').then(m => m.IssuePhotosWallComponent)
28:   },
29:   {
30:     path: 'close',
31:     loadComponent: () => import('./close-summary/issue-close-summary.component').then(m => m.IssueCloseSummaryComponent)
32:   },
33:   {
34:     path: 'assignments',
35:     loadComponent: () => import('./assignments/issue-assignments.component').then(m => m.IssueAssignmentsComponent)
36:   },
37:   {
38:     path: ':id',
39:     loadComponent: () => import('./detail/issue-detail.component').then(m => m.IssueDetailComponent)
40:   },
41:   {
42:     path: ':id/handle',
43:     loadComponent: () => import('./handle/issue-handle.component').then(m => m.IssueHandleComponent)
44:   },
45:   {
46:     path: ':id/photos',
47:     loadComponent: () => import('./photos/issue-photos.component').then(m => m.IssuePhotosComponent)
48:   },
49:   {
50:     path: ':id/close',
51:     loadComponent: () => import('./close/issue-close.component').then(m => m.IssueCloseComponent)
52:   },
53:   {
54:     path: 'sync-logs',
55:     loadComponent: () => import('./sync-logs/sync-logs').then(m => m.SyncLogs)
56:   }
57: ];
````

## File: src/app/routes/issues/sync-logs/sync-logs.spec.ts
````typescript
 1: import { ComponentFixture, TestBed } from '@angular/core/testing';
 2: 
 3: import { SyncLogs } from './sync-logs';
 4: 
 5: describe('SyncLogs', () => {
 6:   let component: SyncLogs;
 7:   let fixture: ComponentFixture<SyncLogs>;
 8: 
 9:   beforeEach(async () => {
10:     await TestBed.configureTestingModule({
11:       imports: [SyncLogs]
12:     }).compileComponents();
13: 
14:     fixture = TestBed.createComponent(SyncLogs);
15:     component = fixture.componentInstance;
16:     fixture.detectChanges();
17:   });
18: 
19:   it('should create', () => {
20:     expect(component).toBeTruthy();
21:   });
22: });
````

## File: src/app/routes/issues/sync-logs/sync-logs.ts
````typescript
1: import { Component } from '@angular/core';
2: 
3: @Component({
4:   selector: 'app-sync-logs',
5:   imports: [],
6:   templateUrl: './sync-logs.html',
7:   styleUrl: './sync-logs.less'
8: })
9: export class SyncLogs {}
````

## File: src/app/routes/passport/callback.component.ts
````typescript
 1: import { Component, Input, OnInit, inject } from '@angular/core';
 2: import { SocialService } from '@delon/auth';
 3: import { SettingsService } from '@delon/theme';
 4: 
 5: @Component({
 6:   selector: 'app-callback',
 7:   template: ``,
 8:   providers: [SocialService],
 9:   standalone: true
10: })
11: export class CallbackComponent implements OnInit {
12:   private readonly socialService = inject(SocialService);
13:   private readonly settingsSrv = inject(SettingsService);
14:   @Input() type = '';
15: 
16:   ngOnInit(): void {
17:     this.mockModel();
18:   }
19: 
20:   private mockModel(): void {
21:     const info = {
22:       token: '123456789',
23:       name: 'cipchk',
24:       email: `${this.type}@${this.type}.com`,
25:       id: 10000,
26:       time: +new Date()
27:     };
28:     this.settingsSrv.setUser({
29:       ...this.settingsSrv.user,
30:       ...info
31:     });
32:     this.socialService.callback(info);
33:   }
34: }
````

## File: src/app/routes/passport/lock/lock.component.ts
````typescript
 1: import { Component, inject } from '@angular/core';
 2: import { FormControl, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
 3: import { Router } from '@angular/router';
 4: import { DA_SERVICE_TOKEN } from '@delon/auth';
 5: import { I18nPipe, SettingsService, User } from '@delon/theme';
 6: import { NzAvatarModule } from 'ng-zorro-antd/avatar';
 7: import { NzButtonModule } from 'ng-zorro-antd/button';
 8: import { NzFormModule } from 'ng-zorro-antd/form';
 9: import { NzGridModule } from 'ng-zorro-antd/grid';
10: import { NzInputModule } from 'ng-zorro-antd/input';
11: 
12: @Component({
13:   selector: 'passport-lock',
14:   templateUrl: './lock.component.html',
15:   styleUrls: ['./lock.component.less'],
16:   imports: [ReactiveFormsModule, I18nPipe, NzAvatarModule, NzFormModule, NzGridModule, NzButtonModule, NzInputModule]
17: })
18: export class UserLockComponent {
19:   private readonly tokenService = inject(DA_SERVICE_TOKEN);
20:   private readonly settings = inject(SettingsService);
21:   private readonly router = inject(Router);
22: 
23:   f = new FormGroup({
24:     password: new FormControl('', { nonNullable: true, validators: [Validators.required] })
25:   });
26: 
27:   get user(): User {
28:     return this.settings.user;
29:   }
30: 
31:   submit(): void {
32:     this.f.controls.password.markAsDirty();
33:     this.f.controls.password.updateValueAndValidity();
34:     if (this.f.valid) {
35:       console.log('Valid!');
36:       console.log(this.f.value);
37:       this.tokenService.set({
38:         token: '123'
39:       });
40:       this.router.navigate(['dashboard']);
41:     }
42:   }
43: }
````

## File: src/app/routes/passport/login/login.component.ts
````typescript
  1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, OnDestroy, inject } from '@angular/core';
  2: import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';
  3: import { Router, RouterLink } from '@angular/router';
  4: import { StartupService } from '@core';
  5: import { ReuseTabService } from '@delon/abc/reuse-tab';
  6: import { DA_SERVICE_TOKEN } from '@delon/auth';
  7: import { I18nPipe } from '@delon/theme';
  8: import { AuthService } from '@shared';
  9: import { NzAlertModule } from 'ng-zorro-antd/alert';
 10: import { NzButtonModule } from 'ng-zorro-antd/button';
 11: import { NzCheckboxModule } from 'ng-zorro-antd/checkbox';
 12: import { NzFormModule } from 'ng-zorro-antd/form';
 13: import { NzInputModule } from 'ng-zorro-antd/input';
 14: import { finalize } from 'rxjs';
 15: 
 16: @Component({
 17:   selector: 'passport-login',
 18:   templateUrl: './login.component.html',
 19:   styleUrls: ['./login.component.less'],
 20:   changeDetection: ChangeDetectionStrategy.OnPush,
 21:   imports: [RouterLink, ReactiveFormsModule, I18nPipe, NzCheckboxModule, NzAlertModule, NzFormModule, NzInputModule, NzButtonModule]
 22: })
 23: export class UserLoginComponent implements OnDestroy {
 24:   private readonly router = inject(Router);
 25:   private readonly reuseTabService = inject(ReuseTabService, { optional: true });
 26:   private readonly tokenService = inject(DA_SERVICE_TOKEN);
 27:   private readonly startupSrv = inject(StartupService);
 28:   private readonly cdr = inject(ChangeDetectorRef);
 29:   private readonly authService = inject(AuthService);
 30: 
 31:   form = inject(FormBuilder).nonNullable.group({
 32:     userName: ['', [Validators.required, Validators.email]],
 33:     password: ['', [Validators.required, Validators.minLength(6)]],
 34:     remember: [true]
 35:   });
 36:   error = '';
 37:   loading = false;
 38: 
 39:   submit(): void {
 40:     this.error = '';
 41:     const { userName, password } = this.form.controls;
 42:     userName.markAsDirty();
 43:     userName.updateValueAndValidity();
 44:     password.markAsDirty();
 45:     password.updateValueAndValidity();
 46:     if (userName.invalid || password.invalid) {
 47:       return;
 48:     }
 49: 
 50:     // ä½¿ç”¨ AuthService é€²è¡Œç™»å…¥
 51:     const email = String(this.form.value.userName || '');
 52:     const pwd = String(this.form.value.password || '');
 53: 
 54:     if (!email || !pwd) {
 55:       this.error = 'è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼';
 56:       this.cdr.detectChanges();
 57:       return;
 58:     }
 59: 
 60:     this.loading = true;
 61:     this.cdr.detectChanges();
 62: 
 63:     this.authService
 64:       .signIn({ email, password: pwd })
 65:       .pipe(
 66:         finalize(() => {
 67:           this.loading = false;
 68:           this.cdr.detectChanges();
 69:         })
 70:       )
 71:       .subscribe({
 72:         next: result => {
 73:           if (!result.success || result.error) {
 74:             this.error = result.error?.message || 'ç™»å…¥å¤±æ•—';
 75:             this.cdr.detectChanges();
 76:             return;
 77:           }
 78:           // æ¸…ç©ºè·¯ç”±å¤ç”¨ä¿¡æ¯
 79:           this.reuseTabService?.clear();
 80:           // AuthService å·²è‡ªå‹•åŒæ­¥ Session åˆ° TokenService
 81:           // é‡æ–°è·å– StartupService å†…å®¹ï¼Œæˆ‘ä»¬å§‹ç»ˆè®¤ä¸ºåº”ç”¨ä¿¡æ¯ä¸€èˆ¬éƒ½ä¼šå—å½“å‰ç”¨æˆ·æˆæƒèŒƒå›´è€Œå½±å“
 82:           this.startupSrv.load().subscribe(() => {
 83:             let url = this.tokenService.referrer!.url || '/';
 84:             if (url.includes('/passport')) {
 85:               url = '/';
 86:             }
 87:             this.router.navigateByUrl(url);
 88:           });
 89:         },
 90:         error: err => {
 91:           this.error = err.message || 'ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
 92:           this.cdr.detectChanges();
 93:         }
 94:       });
 95:   }
 96: 
 97:   ngOnDestroy(): void {
 98:     // ä¸å†éœ€è¦æ¸…ç† interval
 99:   }
100: }
````

## File: src/app/routes/passport/register-result/register-result.component.ts
````typescript
 1: import { Component, Input, inject } from '@angular/core';
 2: import { RouterLink } from '@angular/router';
 3: import { I18nPipe } from '@delon/theme';
 4: import { NzButtonModule } from 'ng-zorro-antd/button';
 5: import { NzMessageService } from 'ng-zorro-antd/message';
 6: import { NzResultModule } from 'ng-zorro-antd/result';
 7: 
 8: @Component({
 9:   selector: 'passport-register-result',
10:   templateUrl: './register-result.component.html',
11:   imports: [RouterLink, I18nPipe, NzButtonModule, NzResultModule]
12: })
13: export class UserRegisterResultComponent {
14:   readonly msg = inject(NzMessageService);
15:   @Input() email = '';
16: }
````

## File: src/app/routes/passport/register/register.component.ts
````typescript
  1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, OnDestroy, inject } from '@angular/core';
  2: import { AbstractControl, FormBuilder, FormControl, ReactiveFormsModule, Validators } from '@angular/forms';
  3: import { Router, RouterLink } from '@angular/router';
  4: import { I18nPipe } from '@delon/theme';
  5: import { MatchControl } from '@delon/util/form';
  6: import { AuthService } from '@shared';
  7: import { NzAlertModule } from 'ng-zorro-antd/alert';
  8: import { NzButtonModule } from 'ng-zorro-antd/button';
  9: import { NzSafeAny } from 'ng-zorro-antd/core/types';
 10: import { NzFormModule } from 'ng-zorro-antd/form';
 11: import { NzInputModule } from 'ng-zorro-antd/input';
 12: import { NzPopoverModule } from 'ng-zorro-antd/popover';
 13: import { NzProgressModule } from 'ng-zorro-antd/progress';
 14: import { finalize } from 'rxjs';
 15: 
 16: @Component({
 17:   selector: 'passport-register',
 18:   templateUrl: './register.component.html',
 19:   styleUrls: ['./register.component.less'],
 20:   changeDetection: ChangeDetectionStrategy.OnPush,
 21:   imports: [
 22:     ReactiveFormsModule,
 23:     I18nPipe,
 24:     RouterLink,
 25:     NzAlertModule,
 26:     NzFormModule,
 27:     NzInputModule,
 28:     NzPopoverModule,
 29:     NzProgressModule,
 30:     NzButtonModule
 31:   ]
 32: })
 33: export class UserRegisterComponent implements OnDestroy {
 34:   private readonly router = inject(Router);
 35:   private readonly cdr = inject(ChangeDetectorRef);
 36:   private readonly authService = inject(AuthService);
 37: 
 38:   // #region fields
 39: 
 40:   form = inject(FormBuilder).nonNullable.group(
 41:     {
 42:       mail: ['', [Validators.required, Validators.email]],
 43:       password: ['', [Validators.required, Validators.minLength(6), UserRegisterComponent.checkPassword.bind(this)]],
 44:       confirm: ['', [Validators.required, Validators.minLength(6)]]
 45:     },
 46:     {
 47:       validators: MatchControl('password', 'confirm')
 48:     }
 49:   );
 50:   error = '';
 51:   loading = false;
 52:   visible = false;
 53:   status = 'pool';
 54:   progress = 0;
 55:   passwordProgressMap: Record<string, 'success' | 'normal' | 'exception'> = {
 56:     ok: 'success',
 57:     pass: 'normal',
 58:     pool: 'exception'
 59:   };
 60: 
 61:   static checkPassword(control: FormControl): NzSafeAny {
 62:     if (!control) {
 63:       return null;
 64:     }
 65:     // eslint-disable-next-line @typescript-eslint/no-this-alias
 66:     const self: NzSafeAny = this;
 67:     self.visible = !!control.value;
 68:     if (control.value && control.value.length > 9) {
 69:       self.status = 'ok';
 70:     } else if (control.value && control.value.length > 5) {
 71:       self.status = 'pass';
 72:     } else {
 73:       self.status = 'pool';
 74:     }
 75: 
 76:     if (self.visible) {
 77:       self.progress = control.value.length * 10 > 100 ? 100 : control.value.length * 10;
 78:     }
 79:   }
 80: 
 81:   submit(): void {
 82:     this.error = '';
 83:     Object.keys(this.form.controls).forEach(key => {
 84:       const control = (this.form.controls as NzSafeAny)[key] as AbstractControl;
 85:       control.markAsDirty();
 86:       control.updateValueAndValidity();
 87:     });
 88:     if (this.form.invalid) {
 89:       return;
 90:     }
 91: 
 92:     const email = String(this.form.value.mail || '');
 93:     const password = String(this.form.value.password || '');
 94: 
 95:     if (!email || !password) {
 96:       this.error = 'è«‹å¡«å¯«å®Œæ•´çš„è¨»å†Šè³‡è¨Š';
 97:       this.cdr.detectChanges();
 98:       return;
 99:     }
100: 
101:     this.loading = true;
102:     this.cdr.detectChanges();
103: 
104:     this.authService
105:       .signUp({ email, password })
106:       .pipe(
107:         finalize(() => {
108:           this.loading = false;
109:           this.cdr.detectChanges();
110:         })
111:       )
112:       .subscribe({
113:         next: result => {
114:           if (!result.success || result.error) {
115:             this.error = result.error?.message || 'è¨»å†Šå¤±æ•—';
116:             this.cdr.detectChanges();
117:             return;
118:           }
119:           // è¨»å†ŠæˆåŠŸï¼Œå°èˆªåˆ°è¨»å†Šçµæœé é¢
120:           // Supabase è¨»å†Šå¯èƒ½è¿”å› sessionï¼ˆemail é©—è­‰é—œé–‰ï¼‰æˆ– nullï¼ˆemail é©—è­‰é–‹å•Ÿï¼‰
121:           this.router.navigate(['passport', 'register-result'], { queryParams: { email } });
122:         },
123:         error: err => {
124:           this.error = err.message || 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
125:           this.cdr.detectChanges();
126:         }
127:       });
128:   }
129: 
130:   ngOnDestroy(): void {
131:     // ä¸å†éœ€è¦æ¸…ç† interval
132:   }
133: }
````

## File: src/app/routes/passport/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: 
 3: import { CallbackComponent } from './callback.component';
 4: import { UserLockComponent } from './lock/lock.component';
 5: import { UserLoginComponent } from './login/login.component';
 6: import { UserRegisterComponent } from './register/register.component';
 7: import { UserRegisterResultComponent } from './register-result/register-result.component';
 8: import { LayoutPassportComponent } from '../../layout';
 9: 
10: export const routes: Routes = [
11:   // passport
12:   {
13:     path: 'passport',
14:     component: LayoutPassportComponent,
15:     children: [
16:       {
17:         path: 'login',
18:         component: UserLoginComponent,
19:         data: { title: 'ç™»å½•', titleI18n: 'app.login.login' }
20:       },
21:       {
22:         path: 'register',
23:         component: UserRegisterComponent,
24:         data: { title: 'æ³¨å†Œ', titleI18n: 'app.register.register' }
25:       },
26:       {
27:         path: 'register-result',
28:         component: UserRegisterResultComponent,
29:         data: { title: 'æ³¨å†Œç»“æœ', titleI18n: 'app.register.register' }
30:       },
31:       {
32:         path: 'lock',
33:         component: UserLockComponent,
34:         data: { title: 'é”å±', titleI18n: 'app.lock' }
35:       }
36:     ]
37:   },
38:   // å•é¡µä¸åŒ…è£¹Layout
39:   { path: 'passport/callback/:type', component: CallbackComponent }
40: ];
````

## File: src/app/routes/pro/account/center/applications/applications.component.ts
````typescript
 1: import { DecimalPipe } from '@angular/common';
 2: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, inject } from '@angular/core';
 3: import { _HttpClient } from '@delon/theme';
 4: import { SHARED_IMPORTS } from '@shared';
 5: import { NzSafeAny } from 'ng-zorro-antd/core/types';
 6: 
 7: @Component({
 8:   selector: 'app-account-center-applications',
 9:   templateUrl: './applications.component.html',
10:   styleUrls: ['./applications.component.less'],
11:   changeDetection: ChangeDetectionStrategy.OnPush,
12:   imports: [...SHARED_IMPORTS, DecimalPipe]
13: })
14: export class ProAccountCenterApplicationsComponent {
15:   private readonly http = inject(_HttpClient);
16:   private readonly cdr = inject(ChangeDetectorRef);
17: 
18:   listLoading = true;
19:   list: any[] = [];
20:   constructor() {
21:     this.http.get('/api/list', { count: 8 }).subscribe((res: NzSafeAny[]) => {
22:       this.list = res.map(item => {
23:         item.activeUser = this.formatWan(item.activeUser);
24:         return item;
25:       });
26:       this.listLoading = false;
27:       this.cdr.detectChanges();
28:     });
29:   }
30: 
31:   private formatWan(val: number): string {
32:     const v = val * 1;
33:     if (!v || isNaN(v)) {
34:       return '';
35:     }
36: 
37:     let result: string | number = val;
38:     if (val > 10000) {
39:       result = Math.floor(val / 10000);
40:       result = `${result}`;
41:     }
42:     return result.toString();
43:   }
44: }
````

## File: src/app/routes/pro/account/center/articles/articles.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component, inject } from '@angular/core';
 2: import { _HttpClient } from '@delon/theme';
 3: import { SHARED_IMPORTS } from '@shared';
 4: 
 5: @Component({
 6:   selector: 'app-account-center-articles',
 7:   templateUrl: './articles.component.html',
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   imports: SHARED_IMPORTS
10: })
11: export class ProAccountCenterArticlesComponent {
12:   list$ = inject(_HttpClient).get('/api/list', { count: 8 });
13: }
````

## File: src/app/routes/pro/account/center/center.component.ts
````typescript
 1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, ElementRef, OnDestroy, OnInit, ViewChild, inject } from '@angular/core';
 2: import { ActivationEnd, Router } from '@angular/router';
 3: import { _HttpClient } from '@delon/theme';
 4: import { SHARED_IMPORTS } from '@shared';
 5: import { Subscription, zip, filter } from 'rxjs';
 6: 
 7: @Component({
 8:   selector: 'app-account-center',
 9:   templateUrl: './center.component.html',
10:   styleUrls: ['./center.component.less'],
11:   changeDetection: ChangeDetectionStrategy.OnPush,
12:   imports: SHARED_IMPORTS
13: })
14: export class ProAccountCenterComponent implements OnInit, OnDestroy {
15:   private readonly router = inject(Router);
16:   private readonly http = inject(_HttpClient);
17:   private readonly cdr = inject(ChangeDetectorRef);
18: 
19:   private router$!: Subscription;
20:   @ViewChild('tagInput', { static: false }) private tagInput!: ElementRef<HTMLInputElement>;
21:   user: any;
22:   notice: any;
23:   tabs = [
24:     {
25:       key: 'articles',
26:       tab: 'æ–‡ç«  (8)'
27:     },
28:     {
29:       key: 'applications',
30:       tab: 'åº”ç”¨ (8)'
31:     },
32:     {
33:       key: 'projects',
34:       tab: 'é¡¹ç›® (8)'
35:     }
36:   ];
37:   pos = 0;
38:   taging = false;
39:   tagValue = '';
40: 
41:   private setActive(): void {
42:     const key = this.router.url.substring(this.router.url.lastIndexOf('/') + 1);
43:     const idx = this.tabs.findIndex(w => w.key === key);
44:     if (idx !== -1) {
45:       this.pos = idx;
46:     }
47:   }
48: 
49:   ngOnInit(): void {
50:     zip(this.http.get('/user/current'), this.http.get('/api/notice')).subscribe(([user, notice]) => {
51:       this.user = user;
52:       this.notice = notice;
53:       this.cdr.detectChanges();
54:     });
55:     this.router$ = this.router.events.pipe(filter(e => e instanceof ActivationEnd)).subscribe(() => this.setActive());
56:     this.setActive();
57:   }
58: 
59:   to(item: { key: string }): void {
60:     this.router.navigateByUrl(`/pro/account/center/${item.key}`);
61:   }
62:   tagShowIpt(): void {
63:     this.taging = true;
64:     this.cdr.detectChanges();
65:     this.tagInput.nativeElement.focus();
66:   }
67: 
68:   tagBlur(): void {
69:     const { user, cdr, tagValue } = this;
70:     if (tagValue && user.tags.filter((tag: { label: string }) => tag.label === tagValue).length === 0) {
71:       user.tags.push({ label: tagValue });
72:     }
73:     this.tagValue = '';
74:     this.taging = false;
75:     cdr.detectChanges();
76:   }
77: 
78:   tagEnter(e: KeyboardEvent): void {
79:     if (e.key === 'Enter') {
80:       this.tagBlur();
81:     }
82:   }
83: 
84:   ngOnDestroy(): void {
85:     this.router$.unsubscribe();
86:   }
87: }
````

## File: src/app/routes/pro/account/center/projects/projects.component.ts
````typescript
 1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, inject } from '@angular/core';
 2: import { _HttpClient } from '@delon/theme';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzAvatarModule } from 'ng-zorro-antd/avatar';
 5: import { NzMessageService } from 'ng-zorro-antd/message';
 6: 
 7: @Component({
 8:   selector: 'app-account-center-projects',
 9:   templateUrl: './projects.component.html',
10:   styleUrls: ['./projects.component.less'],
11:   changeDetection: ChangeDetectionStrategy.OnPush,
12:   imports: [...SHARED_IMPORTS, NzAvatarModule]
13: })
14: export class ProAccountCenterProjectsComponent {
15:   private readonly http = inject(_HttpClient);
16:   private readonly msg = inject(NzMessageService);
17:   private readonly cdr = inject(ChangeDetectorRef);
18: 
19:   listLoading = true;
20:   list: any[] = [];
21: 
22:   constructor() {
23:     this.http.get('/api/list', { count: 8 }).subscribe(res => {
24:       this.list = res;
25:       this.listLoading = false;
26:       this.cdr.detectChanges();
27:     });
28:   }
29: 
30:   suc(id: number): void {
31:     this.msg.success(`æ ‡é¢˜ï¼š${id}`);
32:   }
33: }
````

## File: src/app/routes/pro/account/settings/base/base.component.ts
````typescript
 1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, OnInit, inject } from '@angular/core';
 2: import { _HttpClient } from '@delon/theme';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: import { NzUploadComponent } from 'ng-zorro-antd/upload';
 6: import { zip } from 'rxjs';
 7: 
 8: interface ProAccountSettingsUser {
 9:   email: string;
10:   name: string;
11:   profile: string;
12:   country: string;
13:   address: string;
14:   phone: string;
15:   avatar: string;
16:   geographic: {
17:     province: {
18:       key: string;
19:     };
20:     city: {
21:       key: string;
22:     };
23:   };
24: }
25: 
26: interface ProAccountSettingsCity {
27:   name: string;
28:   id: string;
29: }
30: 
31: @Component({
32:   selector: 'app-account-settings-base',
33:   templateUrl: './base.component.html',
34:   styleUrls: ['./base.component.less'],
35:   changeDetection: ChangeDetectionStrategy.OnPush,
36:   imports: [...SHARED_IMPORTS, NzUploadComponent]
37: })
38: export class ProAccountSettingsBaseComponent implements OnInit {
39:   private readonly http = inject(_HttpClient);
40:   private readonly cdr = inject(ChangeDetectorRef);
41:   private readonly msg = inject(NzMessageService);
42: 
43:   avatar = '';
44:   userLoading = true;
45:   user!: ProAccountSettingsUser;
46: 
47:   // #region geo
48: 
49:   provinces: ProAccountSettingsCity[] = [];
50:   cities: ProAccountSettingsCity[] = [];
51: 
52:   ngOnInit(): void {
53:     zip(this.http.get('/user/current'), this.http.get('/geo/province')).subscribe(
54:       ([user, province]: [ProAccountSettingsUser, ProAccountSettingsCity[]]) => {
55:         this.userLoading = false;
56:         this.user = user;
57:         this.provinces = province;
58:         this.choProvince(user.geographic.province.key, false);
59:         this.cdr.detectChanges();
60:       }
61:     );
62:   }
63: 
64:   choProvince(pid: string, cleanCity = true): void {
65:     this.http.get(`/geo/${pid}`).subscribe(res => {
66:       this.cities = res;
67:       if (cleanCity) {
68:         this.user.geographic.city.key = '';
69:       }
70:       this.cdr.detectChanges();
71:     });
72:   }
73: 
74:   // #endregion
75: 
76:   save(): boolean {
77:     this.msg.success(JSON.stringify(this.user));
78:     return false;
79:   }
80: }
````

## File: src/app/routes/pro/account/settings/binding/binding.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component, inject } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: import { NzMessageService } from 'ng-zorro-antd/message';
 4: 
 5: @Component({
 6:   selector: 'app-account-settings-binding',
 7:   templateUrl: './binding.component.html',
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   imports: SHARED_IMPORTS
10: })
11: export class ProAccountSettingsBindingComponent {
12:   readonly msg = inject(NzMessageService);
13: }
````

## File: src/app/routes/pro/account/settings/notification/notification.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-account-settings-notification',
 6:   templateUrl: './notification.component.html',
 7:   changeDetection: ChangeDetectionStrategy.OnPush,
 8:   imports: SHARED_IMPORTS
 9: })
10: export class ProAccountSettingsNotificationComponent {
11:   i: {
12:     password: boolean;
13:     messages: boolean;
14:     todo: boolean;
15:   } = {
16:     password: true,
17:     messages: true,
18:     todo: true
19:   };
20: }
````

## File: src/app/routes/pro/account/settings/security/security.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component, inject } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: import { NzMessageService } from 'ng-zorro-antd/message';
 4: 
 5: @Component({
 6:   selector: 'app-account-settings-security',
 7:   templateUrl: './security.component.html',
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   imports: SHARED_IMPORTS
10: })
11: export class ProAccountSettingsSecurityComponent {
12:   readonly msg = inject(NzMessageService);
13: }
````

## File: src/app/routes/pro/account/settings/settings.component.ts
````typescript
 1: import { AfterViewInit, ChangeDetectionStrategy, ChangeDetectorRef, Component, DestroyRef, ElementRef, inject } from '@angular/core';
 2: import { takeUntilDestroyed } from '@angular/core/rxjs-interop';
 3: import { ActivationEnd, Router } from '@angular/router';
 4: import { SHARED_IMPORTS } from '@shared';
 5: import { NzMenuModeType } from 'ng-zorro-antd/menu';
 6: import { fromEvent, debounceTime, filter } from 'rxjs';
 7: 
 8: @Component({
 9:   selector: 'app-account-settings',
10:   templateUrl: './settings.component.html',
11:   styleUrls: ['./settings.component.less'],
12:   changeDetection: ChangeDetectionStrategy.OnPush,
13:   imports: SHARED_IMPORTS
14: })
15: export class ProAccountSettingsComponent implements AfterViewInit {
16:   private readonly router = inject(Router);
17:   private readonly cdr = inject(ChangeDetectorRef);
18:   private readonly el: HTMLElement = inject(ElementRef).nativeElement;
19:   private readonly d$ = inject(DestroyRef);
20:   mode: NzMenuModeType = 'inline';
21:   title!: string;
22:   menus: Array<{ key: string; title: string; selected?: boolean }> = [
23:     {
24:       key: 'base',
25:       title: 'åŸºæœ¬è®¾ç½®'
26:     },
27:     {
28:       key: 'security',
29:       title: 'å®‰å…¨è®¾ç½®'
30:     },
31:     {
32:       key: 'binding',
33:       title: 'è´¦å·ç»‘å®š'
34:     },
35:     {
36:       key: 'notification',
37:       title: 'æ–°æ¶ˆæ¯é€šçŸ¥'
38:     }
39:   ];
40: 
41:   private setActive(): void {
42:     const key = this.router.url.substring(this.router.url.lastIndexOf('/') + 1);
43:     this.menus.forEach(i => {
44:       i.selected = i.key === key;
45:     });
46:     this.title = this.menus.find(w => w.selected)!.title;
47:     this.cdr.detectChanges();
48:   }
49: 
50:   to(item: { key: string }): void {
51:     this.router.navigateByUrl(`/pro/account/settings/${item.key}`);
52:   }
53: 
54:   private resize(): void {
55:     const el = this.el;
56:     let mode: NzMenuModeType = 'inline';
57:     const { offsetWidth } = el;
58:     if (offsetWidth < 641 && offsetWidth > 400) {
59:       mode = 'horizontal';
60:     }
61:     if (window.innerWidth < 768 && offsetWidth > 400) {
62:       mode = 'horizontal';
63:     }
64:     this.mode = mode;
65:     this.cdr.detectChanges();
66:   }
67: 
68:   ngAfterViewInit(): void {
69:     this.router.events
70:       .pipe(
71:         takeUntilDestroyed(this.d$),
72:         filter(e => e instanceof ActivationEnd)
73:       )
74:       .subscribe(() => this.setActive());
75: 
76:     fromEvent(window, 'resize')
77:       .pipe(takeUntilDestroyed(this.d$), debounceTime(200))
78:       .subscribe(() => this.resize());
79: 
80:     this.setActive();
81:   }
82: }
````

## File: src/app/routes/pro/form/advanced-form/advanced-form.component.ts
````typescript
  1: import { ChangeDetectionStrategy, Component, OnInit } from '@angular/core';
  2: import { AbstractControl, FormArray, FormControl, FormGroup, Validators } from '@angular/forms';
  3: import { FooterToolbarModule } from '@delon/abc/footer-toolbar';
  4: import { SHARED_IMPORTS } from '@shared';
  5: import { NzSafeAny } from 'ng-zorro-antd/core/types';
  6: 
  7: interface UserForm {
  8:   key: FormControl<string>;
  9:   workId: FormControl<string>;
 10:   name: FormControl<string>;
 11:   department: FormControl<string>;
 12: }
 13: 
 14: @Component({
 15:   selector: 'app-advanced-form',
 16:   templateUrl: './advanced-form.component.html',
 17:   changeDetection: ChangeDetectionStrategy.OnPush,
 18:   imports: [...SHARED_IMPORTS, FooterToolbarModule]
 19: })
 20: export class AdvancedFormComponent implements OnInit {
 21:   editIndex = -1;
 22:   editObj = {};
 23:   form = new FormGroup({
 24:     name: new FormControl('', { nonNullable: true, validators: [Validators.required] }),
 25:     url: new FormControl('', { validators: [Validators.required] }),
 26:     owner: new FormControl(undefined, { validators: [Validators.required] }),
 27:     approver: new FormControl('', { validators: [Validators.required] }),
 28:     date_range: new FormControl('', { validators: [Validators.required] }),
 29:     type: new FormControl('', { validators: [Validators.required] }),
 30:     name2: new FormControl('', { validators: [Validators.required] }),
 31:     summary: new FormControl('', { validators: [Validators.required] }),
 32:     owner2: new FormControl('', { validators: [Validators.required] }),
 33:     approver2: new FormControl('', { validators: [Validators.required] }),
 34:     time: new FormControl('', { validators: [Validators.required] }),
 35:     type2: new FormControl('', { validators: [Validators.required] }),
 36:     items: new FormArray<FormGroup<UserForm>>([])
 37:   });
 38:   users: Array<{ value: string; label: string }> = [
 39:     { value: 'xiao', label: 'ä»˜æ™“æ™“' },
 40:     { value: 'mao', label: 'å‘¨æ¯›æ¯›' }
 41:   ];
 42: 
 43:   ngOnInit(): void {
 44:     const userList = [
 45:       {
 46:         key: '1',
 47:         workId: '00001',
 48:         name: 'John Brown',
 49:         department: 'New York No. 1 Lake Park'
 50:       },
 51:       {
 52:         key: '2',
 53:         workId: '00002',
 54:         name: 'Jim Green',
 55:         department: 'London No. 1 Lake Park'
 56:       },
 57:       {
 58:         key: '3',
 59:         workId: '00003',
 60:         name: 'Joe Black',
 61:         department: 'Sidney No. 1 Lake Park'
 62:       }
 63:     ];
 64:     userList.forEach(i => {
 65:       const field = this.createUser();
 66:       field.patchValue(i);
 67:       this.items.push(field);
 68:     });
 69:   }
 70: 
 71:   createUser(): FormGroup<UserForm> {
 72:     return new FormGroup({
 73:       key: new FormControl('', { nonNullable: true, validators: [Validators.required] }),
 74:       name: new FormControl('', { nonNullable: true, validators: [Validators.required] }),
 75:       workId: new FormControl('', { nonNullable: true, validators: [Validators.required] }),
 76:       department: new FormControl('', { nonNullable: true, validators: [Validators.required] })
 77:     });
 78:   }
 79: 
 80:   get items(): FormArray<FormGroup<UserForm>> {
 81:     return this.form.controls.items;
 82:   }
 83: 
 84:   add(): void {
 85:     this.items.push(this.createUser());
 86:     this.edit(this.items.length - 1);
 87:   }
 88: 
 89:   del(index: number): void {
 90:     this.items.removeAt(index);
 91:   }
 92: 
 93:   edit(index: number): void {
 94:     if (this.editIndex !== -1 && this.editObj) {
 95:       this.items.at(this.editIndex).patchValue(this.editObj);
 96:     }
 97:     this.editObj = { ...this.items.at(index).value };
 98:     this.editIndex = index;
 99:   }
100: 
101:   save(index: number): void {
102:     const item = this.items.at(index);
103:     this.formValidity(item.controls);
104:     if (item.invalid) {
105:       return;
106:     }
107:     this.editIndex = -1;
108:   }
109: 
110:   cancel(index: number): void {
111:     const item = this.items.at(index);
112:     if (!item.value.key) {
113:       this.del(index);
114:     } else {
115:       item.patchValue(this.editObj);
116:     }
117:     this.editIndex = -1;
118:   }
119: 
120:   _submitForm(): void {
121:     this.formValidity(this.form.controls);
122:     if (this.form.invalid) {
123:       return;
124:     }
125:   }
126: 
127:   private formValidity(controls: NzSafeAny): void {
128:     Object.keys(controls).forEach(key => {
129:       const control = (controls as NzSafeAny)[key] as AbstractControl;
130:       control.markAsDirty();
131:       control.updateValueAndValidity();
132:     });
133:   }
134: }
````

## File: src/app/routes/pro/form/basic-form/basic-form.component.ts
````typescript
 1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, inject } from '@angular/core';
 2: import { FormControl, FormGroup, Validators } from '@angular/forms';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: 
 6: @Component({
 7:   selector: 'app-basic-form',
 8:   templateUrl: './basic-form.component.html',
 9:   changeDetection: ChangeDetectionStrategy.OnPush,
10:   imports: SHARED_IMPORTS
11: })
12: export class BasicFormComponent {
13:   private readonly msg = inject(NzMessageService);
14:   private readonly cdr = inject(ChangeDetectorRef);
15: 
16:   form = new FormGroup({
17:     title: new FormControl('', Validators.required),
18:     date: new FormControl('', Validators.required),
19:     goal: new FormControl('', Validators.required),
20:     standard: new FormControl('', Validators.required),
21:     client: new FormControl(''),
22:     invites: new FormControl(''),
23:     weight: new FormControl(''),
24:     public: new FormControl(1, [Validators.min(1), Validators.max(3)]),
25:     publicUsers: new FormControl('')
26:   });
27:   submitting = false;
28: 
29:   submit(): void {
30:     this.submitting = true;
31:     setTimeout(() => {
32:       this.submitting = false;
33:       this.msg.success(`æäº¤æˆåŠŸ`);
34:       this.cdr.detectChanges();
35:     }, 1000);
36:   }
37: }
````

## File: src/app/routes/pro/form/step-form/step-form.component.ts
````typescript
 1: import { AfterViewInit, Component, inject } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: import { NzStepsModule } from 'ng-zorro-antd/steps';
 4: 
 5: import { Step1Component } from './step1.component';
 6: import { Step2Component } from './step2.component';
 7: import { Step3Component } from './step3.component';
 8: import { TransferService } from './transfer.service';
 9: 
10: @Component({
11:   selector: 'app-step-form',
12:   templateUrl: './step-form.component.html',
13:   styleUrls: ['./step-form.component.less'],
14:   providers: [TransferService],
15:   imports: [...SHARED_IMPORTS, NzStepsModule, Step1Component, Step2Component, Step3Component]
16: })
17: export class StepFormComponent implements AfterViewInit {
18:   private readonly srv = inject(TransferService);
19:   get item(): TransferService {
20:     return this.srv;
21:   }
22: 
23:   ngAfterViewInit(): void {
24:     console.log('item', this.item);
25:   }
26: }
````

## File: src/app/routes/pro/form/step-form/step1.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component, OnInit, inject } from '@angular/core';
 2: import { FormControl, FormGroup, Validators } from '@angular/forms';
 3: import { SHARED_IMPORTS } from '@shared';
 4: 
 5: import { TransferService } from './transfer.service';
 6: 
 7: @Component({
 8:   selector: 'app-step1',
 9:   templateUrl: './step1.component.html',
10:   changeDetection: ChangeDetectionStrategy.OnPush,
11:   imports: SHARED_IMPORTS
12: })
13: export class Step1Component implements OnInit {
14:   private readonly srv = inject(TransferService);
15: 
16:   form = new FormGroup({
17:     pay_account: new FormControl('', Validators.compose([Validators.required, Validators.email])),
18:     receiver_type: new FormControl('', Validators.required),
19:     receiver_account: new FormControl('', Validators.required),
20:     receiver_name: new FormControl('', Validators.compose([Validators.required, Validators.minLength(2)])),
21:     amount: new FormControl(
22:       '',
23:       Validators.compose([Validators.required, Validators.pattern(`[0-9]+`), Validators.min(1), Validators.max(10000 * 100)])
24:     )
25:   });
26: 
27:   get item(): TransferService {
28:     return this.srv;
29:   }
30: 
31:   ngOnInit(): void {
32:     this.form.patchValue(this.item as any);
33:   }
34: 
35:   _submitForm(): void {
36:     Object.assign(this.item, this.form.value);
37:     ++this.item.step;
38:   }
39: }
````

## File: src/app/routes/pro/form/step-form/step2.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component, OnInit, inject } from '@angular/core';
 2: import { FormControl, FormGroup, Validators } from '@angular/forms';
 3: import { SHARED_IMPORTS } from '@shared';
 4: 
 5: import { TransferService } from './transfer.service';
 6: 
 7: @Component({
 8:   selector: 'app-step2',
 9:   templateUrl: './step2.component.html',
10:   changeDetection: ChangeDetectionStrategy.OnPush,
11:   imports: SHARED_IMPORTS
12: })
13: export class Step2Component implements OnInit {
14:   private readonly srv = inject(TransferService);
15: 
16:   form = new FormGroup({
17:     password: new FormControl('', Validators.compose([Validators.required, Validators.minLength(6)]))
18:   });
19:   loading = false;
20:   get item(): TransferService {
21:     return this.srv;
22:   }
23: 
24:   ngOnInit(): void {
25:     this.form.patchValue(this.item);
26:   }
27: 
28:   _submitForm(): void {
29:     this.loading = true;
30:     setTimeout(() => {
31:       this.loading = false;
32:       ++this.item.step;
33:     }, 500);
34:   }
35: 
36:   prev(): void {
37:     --this.item.step;
38:   }
39: }
````

## File: src/app/routes/pro/form/step-form/step3.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component, inject } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: import { NzResultModule } from 'ng-zorro-antd/result';
 4: 
 5: import { TransferService } from './transfer.service';
 6: 
 7: @Component({
 8:   selector: 'app-step3',
 9:   templateUrl: './step3.component.html',
10:   changeDetection: ChangeDetectionStrategy.OnPush,
11:   imports: [...SHARED_IMPORTS, NzResultModule]
12: })
13: export class Step3Component {
14:   private readonly srv = inject(TransferService);
15: 
16:   get item(): TransferService {
17:     return this.srv;
18:   }
19: }
````

## File: src/app/routes/pro/form/step-form/transfer.service.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: 
 3: @Injectable()
 4: export class TransferService {
 5:   step = 1;
 6: 
 7:   /**
 8:    * ä»˜æ¬¾è´¦æˆ·
 9:    */
10:   pay_account = '';
11: 
12:   /**
13:    * æ”¶æ¬¾è´¦æˆ·ç±»å‹
14:    */
15:   receiver_type: 'alipay' | 'bank' = 'alipay';
16: 
17:   get receiver_type_str(): string {
18:     return this.receiver_type === 'alipay' ? 'æ”¯ä»˜å®' : 'é“¶è¡Œ';
19:   }
20: 
21:   /**
22:    * æ”¶æ¬¾è´¦æˆ·
23:    */
24:   receiver_account = '';
25: 
26:   /**
27:    * æ”¶æ¬¾å§“å
28:    */
29:   receiver_name = '';
30: 
31:   /**
32:    * é‡‘é¢
33:    */
34:   amount = 500;
35: 
36:   /**
37:    * æ”¯ä»˜å¯†ç 
38:    */
39:   password = '123456';
40: 
41:   again(): void {
42:     this.step = 0;
43:     this.pay_account = 'ant-design@alipay.com';
44:     this.receiver_type = 'alipay';
45:     this.receiver_account = 'test@example.com';
46:     this.receiver_name = 'asdf';
47:     this.amount = 500;
48:   }
49: 
50:   constructor() {
51:     this.again();
52:   }
53: }
````

## File: src/app/routes/pro/list/applications/applications.component.ts
````typescript
 1: import { DecimalPipe } from '@angular/common';
 2: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, OnInit, inject } from '@angular/core';
 3: import { TagSelectComponent } from '@delon/abc/tag-select';
 4: import { _HttpClient } from '@delon/theme';
 5: import { SHARED_IMPORTS } from '@shared';
 6: 
 7: interface ProListApplicationListItem {
 8:   title: string;
 9:   avatar: string;
10:   activeUser: string | number;
11:   newUser: number;
12: }
13: 
14: @Component({
15:   selector: 'app-list-applications',
16:   templateUrl: './applications.component.html',
17:   styleUrls: ['./applications.component.less'],
18:   changeDetection: ChangeDetectionStrategy.OnPush,
19:   imports: [...SHARED_IMPORTS, TagSelectComponent, DecimalPipe]
20: })
21: export class ProListApplicationsComponent implements OnInit {
22:   private readonly http = inject(_HttpClient);
23:   private readonly cdr = inject(ChangeDetectorRef);
24: 
25:   q = {
26:     ps: 8,
27:     user: null,
28:     rate: null,
29:     categories: [],
30:     owners: ['zxx']
31:   };
32: 
33:   list: ProListApplicationListItem[] = [];
34: 
35:   loading = true;
36: 
37:   // region: cateogry
38:   categories = [
39:     { id: 0, text: 'å…¨éƒ¨', value: false },
40:     { id: 1, text: 'ç±»ç›®ä¸€', value: false },
41:     { id: 2, text: 'ç±»ç›®äºŒ', value: false },
42:     { id: 3, text: 'ç±»ç›®ä¸‰', value: false },
43:     { id: 4, text: 'ç±»ç›®å››', value: false },
44:     { id: 5, text: 'ç±»ç›®äº”', value: false },
45:     { id: 6, text: 'ç±»ç›®å…­', value: false },
46:     { id: 7, text: 'ç±»ç›®ä¸ƒ', value: false },
47:     { id: 8, text: 'ç±»ç›®å…«', value: false },
48:     { id: 9, text: 'ç±»ç›®ä¹', value: false },
49:     { id: 10, text: 'ç±»ç›®å', value: false },
50:     { id: 11, text: 'ç±»ç›®åä¸€', value: false },
51:     { id: 12, text: 'ç±»ç›®åäºŒ', value: false }
52:   ];
53: 
54:   changeCategory(status: boolean, idx: number): void {
55:     if (idx === 0) {
56:       this.categories.map(i => (i.value = status));
57:     } else {
58:       this.categories[idx].value = status;
59:     }
60:     this.getData();
61:   }
62:   // endregion
63: 
64:   ngOnInit(): void {
65:     this.getData();
66:   }
67: 
68:   getData(): void {
69:     this.loading = true;
70:     this.http.get('/api/list', { count: this.q.ps }).subscribe(res => {
71:       this.list = res.map((item: ProListApplicationListItem) => {
72:         item.activeUser = this.formatWan(item.activeUser as number);
73:         return item;
74:       });
75:       this.loading = false;
76:       this.cdr.detectChanges();
77:     });
78:   }
79: 
80:   private formatWan(val: number): string | number {
81:     const v = val * 1;
82:     if (!v || isNaN(v)) {
83:       return '';
84:     }
85: 
86:     let result: number | string = val;
87:     if (val > 10000) {
88:       result = Math.floor(val / 10000);
89:       result = `${result}`;
90:     }
91:     return result;
92:   }
93: }
````

## File: src/app/routes/pro/list/articles/articles.component.ts
````typescript
 1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, OnInit, inject } from '@angular/core';
 2: import { TagSelectComponent } from '@delon/abc/tag-select';
 3: import { _HttpClient } from '@delon/theme';
 4: import { SHARED_IMPORTS } from '@shared';
 5: 
 6: @Component({
 7:   selector: 'app-list-articles',
 8:   templateUrl: './articles.component.html',
 9:   changeDetection: ChangeDetectionStrategy.OnPush,
10:   imports: [...SHARED_IMPORTS, TagSelectComponent]
11: })
12: export class ProListArticlesComponent implements OnInit {
13:   private readonly http = inject(_HttpClient);
14:   private readonly cdr = inject(ChangeDetectorRef);
15: 
16:   q = {
17:     ps: 5,
18:     categories: [],
19:     owners: ['zxx'],
20:     user: '',
21:     rate: ''
22:   };
23: 
24:   list: any[] = [];
25:   loading = false;
26: 
27:   categories = [
28:     { id: 0, text: 'å…¨éƒ¨', value: false },
29:     { id: 1, text: 'ç±»ç›®ä¸€', value: false },
30:     { id: 2, text: 'ç±»ç›®äºŒ', value: false },
31:     { id: 3, text: 'ç±»ç›®ä¸‰', value: false },
32:     { id: 4, text: 'ç±»ç›®å››', value: false },
33:     { id: 5, text: 'ç±»ç›®äº”', value: false },
34:     { id: 6, text: 'ç±»ç›®å…­', value: false },
35:     { id: 7, text: 'ç±»ç›®ä¸ƒ', value: false },
36:     { id: 8, text: 'ç±»ç›®å…«', value: false },
37:     { id: 9, text: 'ç±»ç›®ä¹', value: false },
38:     { id: 10, text: 'ç±»ç›®å', value: false },
39:     { id: 11, text: 'ç±»ç›®åä¸€', value: false },
40:     { id: 12, text: 'ç±»ç›®åäºŒ', value: false }
41:   ];
42: 
43:   owners = [
44:     {
45:       id: 'wzj',
46:       name: 'æˆ‘è‡ªå·±'
47:     },
48:     {
49:       id: 'wjh',
50:       name: 'å´å®¶è±ª'
51:     },
52:     {
53:       id: 'zxx',
54:       name: 'å‘¨æ˜Ÿæ˜Ÿ'
55:     },
56:     {
57:       id: 'zly',
58:       name: 'èµµä¸½é¢–'
59:     },
60:     {
61:       id: 'ym',
62:       name: 'å§šæ˜'
63:     }
64:   ];
65: 
66:   changeCategory(status: boolean, idx: number): void {
67:     if (idx === 0) {
68:       this.categories.map(i => (i.value = status));
69:     } else {
70:       this.categories[idx].value = status;
71:     }
72:   }
73: 
74:   setOwner(): void {
75:     this.q.owners = [`wzj`];
76:     // TODO: wait nz-dropdown OnPush mode
77:     setTimeout(() => this.cdr.detectChanges());
78:   }
79: 
80:   ngOnInit(): void {
81:     this.getData();
82:   }
83: 
84:   getData(more = false): void {
85:     this.loading = true;
86:     this.http.get('/api/list', { count: this.q.ps }).subscribe(res => {
87:       this.list = more ? this.list.concat(res) : res;
88:       this.loading = false;
89:       this.cdr.detectChanges();
90:     });
91:   }
92: }
````

## File: src/app/routes/pro/list/basic-list/basic-list.component.ts
````typescript
 1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, OnInit, inject } from '@angular/core';
 2: import { ModalHelper, _HttpClient } from '@delon/theme';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: import { NzPaginationComponent } from 'ng-zorro-antd/pagination';
 6: 
 7: import { ProBasicListEditComponent } from './edit/edit.component';
 8: 
 9: @Component({
10:   selector: 'app-basic-list',
11:   templateUrl: './basic-list.component.html',
12:   styleUrls: ['./basic-list.component.less'],
13:   changeDetection: ChangeDetectionStrategy.OnPush,
14:   imports: [...SHARED_IMPORTS, NzPaginationComponent]
15: })
16: export class ProBasicListComponent implements OnInit {
17:   private readonly http = inject(_HttpClient);
18:   private readonly msg = inject(NzMessageService);
19:   private readonly modal = inject(ModalHelper);
20:   private readonly cdr = inject(ChangeDetectorRef);
21: 
22:   q = {
23:     q: '',
24:     status: 'all'
25:   };
26:   loading = false;
27:   data: Array<{
28:     id: number;
29:     title: string;
30:     subDescription: string;
31:     href: string;
32:     logo: string;
33:     owner: string;
34:     createdAt: Date;
35:     percent: number;
36:     status: string;
37:   }> = [];
38: 
39:   ngOnInit(): void {
40:     this.getData();
41:   }
42: 
43:   getData(): void {
44:     this.loading = true;
45:     this.http.get('/api/list', { count: 5 }).subscribe(res => {
46:       this.data = res;
47:       this.loading = false;
48:       this.cdr.detectChanges();
49:     });
50:   }
51: 
52:   openEdit(record: { id?: number } = {}): void {
53:     this.modal.create(ProBasicListEditComponent, { record }, { size: 'md' }).subscribe(res => {
54:       if (record.id) {
55:         record = { ...record, id: 'mock_id', percent: 0, ...res };
56:       } else {
57:         this.data.splice(0, 0, res);
58:         this.data = [...this.data];
59:       }
60:       this.cdr.detectChanges();
61:     });
62:   }
63: 
64:   remove(title: string): void {
65:     this.msg.success(`åˆ é™¤ï¼š${title}`);
66:   }
67: }
````

## File: src/app/routes/pro/list/basic-list/edit/edit.component.ts
````typescript
 1: import { Component, inject } from '@angular/core';
 2: import { SFSchema } from '@delon/form';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: import { NzModalRef } from 'ng-zorro-antd/modal';
 6: 
 7: @Component({
 8:   selector: 'app-basic-list-edit',
 9:   templateUrl: './edit.component.html',
10:   imports: SHARED_IMPORTS
11: })
12: export class ProBasicListEditComponent {
13:   private readonly modal = inject(NzModalRef);
14:   private readonly msgSrv = inject(NzMessageService);
15: 
16:   record: any = {};
17:   schema: SFSchema = {
18:     properties: {
19:       title: { type: 'string', title: 'ä»»åŠ¡åç§°', maxLength: 50 },
20:       createdAt: { type: 'string', title: 'å¼€å§‹æ—¶é—´', format: 'date' },
21:       owner: {
22:         type: 'string',
23:         title: 'ä»»åŠ¡è´Ÿè´£äºº',
24:         enum: [
25:           { value: 'asdf', label: 'asdf' },
26:           { value: 'å¡è‰²', label: 'å¡è‰²' },
27:           { value: 'cipchk', label: 'cipchk' }
28:         ]
29:       },
30:       subDescription: {
31:         type: 'string',
32:         title: 'äº§å“æè¿°',
33:         ui: {
34:           widget: 'textarea',
35:           autosize: { minRows: 2, maxRows: 6 }
36:         }
37:       }
38:     },
39:     required: ['title', 'createdAt', 'owner'],
40:     ui: {
41:       spanLabelFixed: 150,
42:       grid: { span: 24 }
43:     }
44:   };
45: 
46:   save(value: any): void {
47:     this.msgSrv.success('ä¿å­˜æˆåŠŸ');
48:     this.modal.close(value);
49:   }
50: 
51:   close(): void {
52:     this.modal.destroy();
53:   }
54: }
````

## File: src/app/routes/pro/list/card-list/card-list.component.ts
````typescript
 1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, OnInit, ViewEncapsulation, inject } from '@angular/core';
 2: import { EllipsisComponent } from '@delon/abc/ellipsis';
 3: import { _HttpClient } from '@delon/theme';
 4: import { SHARED_IMPORTS } from '@shared';
 5: import { NzMessageService } from 'ng-zorro-antd/message';
 6: 
 7: @Component({
 8:   selector: 'app-list-card-list',
 9:   templateUrl: './card-list.component.html',
10:   styles: [
11:     `
12:       :host ::ng-deep .ant-card-meta-title {
13:         margin-bottom: 12px;
14:       }
15:     `
16:   ],
17:   encapsulation: ViewEncapsulation.Emulated,
18:   changeDetection: ChangeDetectionStrategy.OnPush,
19:   imports: [...SHARED_IMPORTS, EllipsisComponent]
20: })
21: export class ProCardListComponent implements OnInit {
22:   private readonly http = inject(_HttpClient);
23:   private readonly msg = inject(NzMessageService);
24:   private readonly cdr = inject(ChangeDetectorRef);
25: 
26:   list: Array<{ id: number; title: string; avatar: string; description: string } | null> = [null];
27: 
28:   loading = true;
29: 
30:   ngOnInit(): void {
31:     this.loading = true;
32:     this.http.get('/api/list', { count: 8 }).subscribe(res => {
33:       this.list = this.list.concat(res);
34:       this.loading = false;
35:       this.cdr.detectChanges();
36:     });
37:   }
38: 
39:   show(text: string): void {
40:     this.msg.success(text);
41:   }
42: }
````

## File: src/app/routes/pro/list/list/list.component.ts
````typescript
 1: import { Component, DestroyRef, OnInit, inject } from '@angular/core';
 2: import { takeUntilDestroyed } from '@angular/core/rxjs-interop';
 3: import { ActivationEnd, Router } from '@angular/router';
 4: import { SHARED_IMPORTS } from '@shared';
 5: import { filter } from 'rxjs';
 6: 
 7: @Component({
 8:   selector: 'app-list-layout',
 9:   templateUrl: './list.component.html',
10:   imports: SHARED_IMPORTS
11: })
12: export class ProListLayoutComponent implements OnInit {
13:   private readonly router = inject(Router);
14:   private readonly d$ = inject(DestroyRef);
15: 
16:   tabs = [
17:     {
18:       key: 'articles',
19:       tab: 'æ–‡ç« '
20:     },
21:     {
22:       key: 'applications',
23:       tab: 'åº”ç”¨'
24:     },
25:     {
26:       key: 'projects',
27:       tab: 'é¡¹ç›®'
28:     }
29:   ];
30: 
31:   pos = 0;
32: 
33:   private setActive(): void {
34:     const key = this.router.url.substring(this.router.url.lastIndexOf('/') + 1);
35:     const idx = this.tabs.findIndex(w => w.key === key);
36:     if (idx !== -1) {
37:       this.pos = idx;
38:     }
39:   }
40: 
41:   ngOnInit(): void {
42:     this.router.events
43:       .pipe(
44:         takeUntilDestroyed(this.d$),
45:         filter(e => e instanceof ActivationEnd)
46:       )
47:       .subscribe(() => this.setActive());
48:     this.setActive();
49:   }
50: 
51:   to(item: { key: string }): void {
52:     this.router.navigateByUrl(`/pro/list/${item.key}`);
53:   }
54: }
````

## File: src/app/routes/pro/list/projects/projects.component.ts
````typescript
 1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, OnInit, inject } from '@angular/core';
 2: import { TagSelectComponent } from '@delon/abc/tag-select';
 3: import { _HttpClient } from '@delon/theme';
 4: import { SHARED_IMPORTS } from '@shared';
 5: import { NzMessageService } from 'ng-zorro-antd/message';
 6: 
 7: @Component({
 8:   selector: 'app-list-projects',
 9:   templateUrl: './projects.component.html',
10:   styleUrls: ['./projects.component.less'],
11:   changeDetection: ChangeDetectionStrategy.OnPush,
12:   imports: [...SHARED_IMPORTS, TagSelectComponent]
13: })
14: export class ProListProjectsComponent implements OnInit {
15:   private readonly http = inject(_HttpClient);
16:   readonly msg = inject(NzMessageService);
17:   private readonly cdr = inject(ChangeDetectorRef);
18: 
19:   q = {
20:     ps: 8,
21:     categories: [],
22:     owners: ['zxx'],
23:     user: null,
24:     rate: null
25:   };
26:   list: any[] = [];
27:   loading = true;
28: 
29:   categories = [
30:     { id: 0, text: 'å…¨éƒ¨', value: false },
31:     { id: 1, text: 'ç±»ç›®ä¸€', value: false },
32:     { id: 2, text: 'ç±»ç›®äºŒ', value: false },
33:     { id: 3, text: 'ç±»ç›®ä¸‰', value: false },
34:     { id: 4, text: 'ç±»ç›®å››', value: false },
35:     { id: 5, text: 'ç±»ç›®äº”', value: false },
36:     { id: 6, text: 'ç±»ç›®å…­', value: false },
37:     { id: 7, text: 'ç±»ç›®ä¸ƒ', value: false },
38:     { id: 8, text: 'ç±»ç›®å…«', value: false },
39:     { id: 9, text: 'ç±»ç›®ä¹', value: false },
40:     { id: 10, text: 'ç±»ç›®å', value: false },
41:     { id: 11, text: 'ç±»ç›®åä¸€', value: false },
42:     { id: 12, text: 'ç±»ç›®åäºŒ', value: false }
43:   ];
44: 
45:   changeCategory(status: boolean, idx: number): void {
46:     if (idx === 0) {
47:       this.categories.map(i => (i.value = status));
48:     } else {
49:       this.categories[idx].value = status;
50:     }
51:     this.getData();
52:   }
53: 
54:   ngOnInit(): void {
55:     this.getData();
56:   }
57: 
58:   getData(): void {
59:     this.loading = true;
60:     this.http.get('/api/list', { count: this.q.ps }).subscribe(res => {
61:       this.list = this.list.concat(res);
62:       this.loading = false;
63:       this.cdr.detectChanges();
64:     });
65:   }
66: }
````

## File: src/app/routes/pro/list/table-list/table-list.component.ts
````typescript
  1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, OnInit, TemplateRef, ViewChild, inject } from '@angular/core';
  2: import { STChange, STColumn, STComponent, STData } from '@delon/abc/st';
  3: import { _HttpClient } from '@delon/theme';
  4: import { SHARED_IMPORTS } from '@shared';
  5: import { NzSafeAny } from 'ng-zorro-antd/core/types';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: import { NzModalService } from 'ng-zorro-antd/modal';
  8: import { map, tap } from 'rxjs';
  9: 
 10: @Component({
 11:   selector: 'app-table-list',
 12:   templateUrl: './table-list.component.html',
 13:   changeDetection: ChangeDetectionStrategy.OnPush,
 14:   imports: SHARED_IMPORTS
 15: })
 16: export class ProTableListComponent implements OnInit {
 17:   private readonly http = inject(_HttpClient);
 18:   private readonly msg = inject(NzMessageService);
 19:   private readonly modalSrv = inject(NzModalService);
 20:   private readonly cdr = inject(ChangeDetectorRef);
 21: 
 22:   q: {
 23:     pi: number;
 24:     ps: number;
 25:     no: string;
 26:     sorter: string;
 27:     status: number | null;
 28:     statusList: NzSafeAny[];
 29:   } = {
 30:     pi: 1,
 31:     ps: 10,
 32:     no: '',
 33:     sorter: '',
 34:     status: null,
 35:     statusList: []
 36:   };
 37:   data: any[] = [];
 38:   loading = false;
 39:   status = [
 40:     { index: 0, text: 'å…³é—­', value: false, type: 'default', checked: false },
 41:     {
 42:       index: 1,
 43:       text: 'è¿è¡Œä¸­',
 44:       value: false,
 45:       type: 'processing',
 46:       checked: false
 47:     },
 48:     { index: 2, text: 'å·²ä¸Šçº¿', value: false, type: 'success', checked: false },
 49:     { index: 3, text: 'å¼‚å¸¸', value: false, type: 'error', checked: false }
 50:   ];
 51:   @ViewChild('st', { static: true })
 52:   st!: STComponent;
 53:   columns: STColumn[] = [
 54:     { title: '', index: 'key', type: 'checkbox' },
 55:     { title: 'è§„åˆ™ç¼–å·', index: 'no' },
 56:     { title: 'æè¿°', index: 'description' },
 57:     {
 58:       title: 'æœåŠ¡è°ƒç”¨æ¬¡æ•°',
 59:       index: 'callNo',
 60:       type: 'number',
 61:       format: item => `${item.callNo} ä¸‡`,
 62:       sort: {
 63:         compare: (a, b) => a.callNo - b.callNo
 64:       }
 65:     },
 66:     {
 67:       title: 'çŠ¶æ€',
 68:       index: 'status',
 69:       render: 'status',
 70:       filter: {
 71:         menus: this.status,
 72:         fn: (filter, record) => record.status === filter['index']
 73:       }
 74:     },
 75:     {
 76:       title: 'æ›´æ–°æ—¶é—´',
 77:       index: 'updatedAt',
 78:       type: 'date',
 79:       sort: {
 80:         compare: (a, b) => a.updatedAt - b.updatedAt
 81:       }
 82:     },
 83:     {
 84:       title: 'æ“ä½œ',
 85:       buttons: [
 86:         {
 87:           text: 'é…ç½®',
 88:           click: item => this.msg.success(`é…ç½®${item.no}`)
 89:         },
 90:         {
 91:           text: 'è®¢é˜…è­¦æŠ¥',
 92:           click: item => this.msg.success(`è®¢é˜…è­¦æŠ¥${item.no}`)
 93:         }
 94:       ]
 95:     }
 96:   ];
 97:   selectedRows: STData[] = [];
 98:   description = '';
 99:   totalCallNo = 0;
100:   expandForm = false;
101: 
102:   ngOnInit(): void {
103:     this.getData();
104:   }
105: 
106:   getData(): void {
107:     this.loading = true;
108:     this.q.statusList = this.status.filter(w => w.checked).map(item => item.index);
109:     if (this.q.status !== null && this.q.status > -1) {
110:       this.q.statusList.push(this.q.status);
111:     }
112:     this.http
113:       .get('/rule', this.q)
114:       .pipe(
115:         map((list: Array<{ status: number; statusText: string; statusType: string }>) =>
116:           list.map(i => {
117:             const statusItem = this.status[i.status];
118:             i.statusText = statusItem.text;
119:             i.statusType = statusItem.type;
120:             return i;
121:           })
122:         ),
123:         tap(() => (this.loading = false))
124:       )
125:       .subscribe(res => {
126:         this.data = res;
127:         this.cdr.detectChanges();
128:       });
129:   }
130: 
131:   stChange(e: STChange): void {
132:     switch (e.type) {
133:       case 'checkbox':
134:         this.selectedRows = e.checkbox!;
135:         this.totalCallNo = this.selectedRows.reduce((total, cv) => total + cv['callNo'], 0);
136:         this.cdr.detectChanges();
137:         break;
138:       case 'filter':
139:         this.getData();
140:         break;
141:     }
142:   }
143: 
144:   remove(): void {
145:     this.http.delete('/rule', { nos: this.selectedRows.map(i => i['no']).join(',') }).subscribe(() => {
146:       this.getData();
147:       this.st.clearCheck();
148:     });
149:   }
150: 
151:   approval(): void {
152:     this.msg.success(`å®¡æ‰¹äº† ${this.selectedRows.length} ç¬”`);
153:   }
154: 
155:   add(tpl: TemplateRef<unknown>): void {
156:     this.modalSrv.create({
157:       nzTitle: 'æ–°å»ºè§„åˆ™',
158:       nzContent: tpl,
159:       nzOnOk: () => {
160:         this.loading = true;
161:         this.http.post('/rule', { description: this.description }).subscribe(() => this.getData());
162:       }
163:     });
164:   }
165: 
166:   reset(): void {
167:     // wait form reset updated finished
168:     setTimeout(() => this.getData());
169:   }
170: }
````

## File: src/app/routes/pro/profile/advanced/advanced.component.ts
````typescript
 1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, OnInit, inject } from '@angular/core';
 2: import { STColumn } from '@delon/abc/st';
 3: import { _HttpClient } from '@delon/theme';
 4: import { SHARED_IMPORTS } from '@shared';
 5: import { NzSafeAny } from 'ng-zorro-antd/core/types';
 6: import { NzMessageService } from 'ng-zorro-antd/message';
 7: import { NzStepsModule } from 'ng-zorro-antd/steps';
 8: import { NzTabChangeEvent } from 'ng-zorro-antd/tabs';
 9: 
10: @Component({
11:   selector: 'app-profile-advanced',
12:   templateUrl: './advanced.component.html',
13:   styleUrls: ['./advanced.component.less'],
14:   changeDetection: ChangeDetectionStrategy.OnPush,
15:   imports: [...SHARED_IMPORTS, NzStepsModule]
16: })
17: export class ProProfileAdvancedComponent implements OnInit {
18:   readonly msg = inject(NzMessageService);
19:   private readonly http = inject(_HttpClient);
20:   private readonly cdr = inject(ChangeDetectorRef);
21: 
22:   list: Array<Record<string, NzSafeAny>> = [];
23:   data = {
24:     advancedOperation1: [],
25:     advancedOperation2: [],
26:     advancedOperation3: []
27:   };
28:   opColumns: STColumn[] = [
29:     { title: 'æ“ä½œç±»å‹', index: 'type' },
30:     { title: 'æ“ä½œäºº', index: 'name' },
31:     { title: 'æ‰§è¡Œç»“æœ', index: 'status', render: 'status' },
32:     { title: 'æ“ä½œæ—¶é—´', index: 'updatedAt', type: 'date' },
33:     { title: 'å¤‡æ³¨', index: 'memo', default: '-' }
34:   ];
35: 
36:   ngOnInit(): void {
37:     this.http.get('/profile/advanced').subscribe(res => {
38:       this.data = res;
39:       this.change({ index: 0, tab: null });
40:       this.cdr.detectChanges();
41:     });
42:   }
43: 
44:   change(args: NzTabChangeEvent): void {
45:     this.list = (this.data as NzSafeAny)[`advancedOperation${args.index! + 1}`];
46:   }
47: }
````

## File: src/app/routes/pro/profile/basic/basic.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component, inject } from '@angular/core';
 2: import { STColumn } from '@delon/abc/st';
 3: import { _HttpClient } from '@delon/theme';
 4: import { SHARED_IMPORTS } from '@shared';
 5: import { NzMessageService } from 'ng-zorro-antd/message';
 6: import { tap } from 'rxjs';
 7: 
 8: @Component({
 9:   selector: 'app-profile-basic',
10:   templateUrl: './basic.component.html',
11:   changeDetection: ChangeDetectionStrategy.OnPush,
12:   imports: SHARED_IMPORTS
13: })
14: export class ProProfileBaseComponent {
15:   private readonly http = inject(_HttpClient);
16:   private readonly msg = inject(NzMessageService);
17: 
18:   basicNum = 0;
19:   amountNum = 0;
20:   goods = this.http.get('/profile/goods').pipe(
21:     tap((list: Array<{ num: number; amount: number }>) => {
22:       list.forEach(item => {
23:         this.basicNum += Number(item.num);
24:         this.amountNum += Number(item.amount);
25:       });
26:     })
27:   );
28:   goodsColumns: STColumn[] = [
29:     {
30:       title: 'å•†å“ç¼–å·',
31:       index: 'id',
32:       type: 'link',
33:       click: item => this.msg.success(`show ${item.id}`)
34:     },
35:     { title: 'å•†å“åç§°', index: 'name' },
36:     { title: 'å•†å“æ¡ç ', index: 'barcode' },
37:     { title: 'å•ä»·', index: 'price', type: 'currency' },
38:     { title: 'æ•°é‡ï¼ˆä»¶ï¼‰', index: 'num', className: 'text-right' },
39:     { title: 'é‡‘é¢', index: 'amount', type: 'currency' }
40:   ];
41:   progress = this.http.get('/profile/progress');
42:   progressColumns: STColumn[] = [
43:     { title: 'æ—¶é—´', index: 'time' },
44:     { title: 'å½“å‰è¿›åº¦', index: 'rate' },
45:     {
46:       title: 'çŠ¶æ€',
47:       index: 'status',
48:       type: 'badge',
49:       badge: {
50:         success: { text: 'æˆåŠŸ', color: 'success' },
51:         processing: { text: 'è¿›è¡Œä¸­', color: 'processing' }
52:       }
53:     },
54:     { title: 'æ“ä½œå‘˜ID', index: 'operator' },
55:     { title: 'è€—æ—¶', index: 'cost' }
56:   ];
57: }
````

## File: src/app/routes/pro/result/fail/fail.component.ts
````typescript
 1: import { Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: import { NzResultModule } from 'ng-zorro-antd/result';
 4: 
 5: @Component({
 6:   selector: 'app-result-fail',
 7:   templateUrl: './fail.component.html',
 8:   imports: [...SHARED_IMPORTS, NzResultModule]
 9: })
10: export class ProResultFailComponent {}
````

## File: src/app/routes/pro/result/success/success.component.ts
````typescript
 1: import { Component, inject } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: import { NzMessageService } from 'ng-zorro-antd/message';
 4: import { NzResultModule } from 'ng-zorro-antd/result';
 5: import { NzStepsModule } from 'ng-zorro-antd/steps';
 6: 
 7: @Component({
 8:   selector: 'app-result-success',
 9:   templateUrl: './success.component.html',
10:   imports: [...SHARED_IMPORTS, NzResultModule, NzStepsModule]
11: })
12: export class ProResultSuccessComponent {
13:   readonly msg = inject(NzMessageService);
14: }
````

## File: src/app/routes/pro/routes.ts
````typescript
  1: import { Routes } from '@angular/router';
  2: 
  3: import { ProAccountCenterApplicationsComponent } from './account/center/applications/applications.component';
  4: import { ProAccountCenterArticlesComponent } from './account/center/articles/articles.component';
  5: import { ProAccountCenterComponent } from './account/center/center.component';
  6: import { ProAccountCenterProjectsComponent } from './account/center/projects/projects.component';
  7: import { ProAccountSettingsBaseComponent } from './account/settings/base/base.component';
  8: import { ProAccountSettingsBindingComponent } from './account/settings/binding/binding.component';
  9: import { ProAccountSettingsNotificationComponent } from './account/settings/notification/notification.component';
 10: import { ProAccountSettingsSecurityComponent } from './account/settings/security/security.component';
 11: import { ProAccountSettingsComponent } from './account/settings/settings.component';
 12: import { AdvancedFormComponent } from './form/advanced-form/advanced-form.component';
 13: import { BasicFormComponent } from './form/basic-form/basic-form.component';
 14: import { StepFormComponent } from './form/step-form/step-form.component';
 15: import { ProListApplicationsComponent } from './list/applications/applications.component';
 16: import { ProListArticlesComponent } from './list/articles/articles.component';
 17: import { ProBasicListComponent } from './list/basic-list/basic-list.component';
 18: import { ProCardListComponent } from './list/card-list/card-list.component';
 19: import { ProListLayoutComponent } from './list/list/list.component';
 20: import { ProListProjectsComponent } from './list/projects/projects.component';
 21: import { ProTableListComponent } from './list/table-list/table-list.component';
 22: import { ProProfileAdvancedComponent } from './profile/advanced/advanced.component';
 23: import { ProProfileBaseComponent } from './profile/basic/basic.component';
 24: import { ProResultFailComponent } from './result/fail/fail.component';
 25: import { ProResultSuccessComponent } from './result/success/success.component';
 26: 
 27: export const routes: Routes = [
 28:   {
 29:     path: 'form',
 30:     children: [
 31:       { path: '', redirectTo: 'basic-form', pathMatch: 'full' },
 32:       { path: 'basic-form', component: BasicFormComponent },
 33:       { path: 'step-form', component: StepFormComponent },
 34:       { path: 'advanced-form', component: AdvancedFormComponent }
 35:     ]
 36:   },
 37:   {
 38:     path: 'list',
 39:     children: [
 40:       { path: 'table-list', component: ProTableListComponent },
 41:       { path: 'basic-list', component: ProBasicListComponent },
 42:       { path: 'card-list', component: ProCardListComponent },
 43:       {
 44:         path: '',
 45:         component: ProListLayoutComponent,
 46:         children: [
 47:           { path: 'articles', component: ProListArticlesComponent },
 48:           { path: 'projects', component: ProListProjectsComponent },
 49:           { path: 'applications', component: ProListApplicationsComponent }
 50:         ]
 51:       }
 52:     ]
 53:   },
 54:   {
 55:     path: 'profile',
 56:     children: [
 57:       { path: 'basic', component: ProProfileBaseComponent },
 58:       { path: 'advanced', component: ProProfileAdvancedComponent }
 59:     ]
 60:   },
 61:   {
 62:     path: 'result',
 63:     children: [
 64:       { path: 'success', component: ProResultSuccessComponent },
 65:       { path: 'fail', component: ProResultFailComponent }
 66:     ]
 67:   },
 68:   {
 69:     path: 'account',
 70:     children: [
 71:       {
 72:         path: 'center',
 73:         component: ProAccountCenterComponent,
 74:         children: [
 75:           { path: '', redirectTo: 'articles', pathMatch: 'full' },
 76:           {
 77:             path: 'articles',
 78:             component: ProAccountCenterArticlesComponent,
 79:             data: { titleI18n: 'pro-account-center' }
 80:           },
 81:           {
 82:             path: 'projects',
 83:             component: ProAccountCenterProjectsComponent,
 84:             data: { titleI18n: 'pro-account-center' }
 85:           },
 86:           {
 87:             path: 'applications',
 88:             component: ProAccountCenterApplicationsComponent,
 89:             data: { titleI18n: 'pro-account-center' }
 90:           }
 91:         ]
 92:       },
 93:       {
 94:         path: 'settings',
 95:         component: ProAccountSettingsComponent,
 96:         children: [
 97:           { path: '', redirectTo: 'base', pathMatch: 'full' },
 98:           {
 99:             path: 'base',
100:             component: ProAccountSettingsBaseComponent,
101:             data: { titleI18n: 'pro-account-settings' }
102:           },
103:           {
104:             path: 'security',
105:             component: ProAccountSettingsSecurityComponent,
106:             data: { titleI18n: 'pro-account-settings' }
107:           },
108:           {
109:             path: 'binding',
110:             component: ProAccountSettingsBindingComponent,
111:             data: { titleI18n: 'pro-account-settings' }
112:           },
113:           {
114:             path: 'notification',
115:             component: ProAccountSettingsNotificationComponent,
116:             data: { titleI18n: 'pro-account-settings' }
117:           }
118:         ]
119:       }
120:     ]
121:   }
122: ];
````

## File: src/app/routes/quality/inspections/quality-inspections.component.ts
````typescript
 1: import { Component, OnInit, inject, signal } from '@angular/core';
 2: import { Router } from '@angular/router';
 3: import { STColumn } from '@delon/abc/st';
 4: import { SHARED_IMPORTS, BlueprintService } from '@shared';
 5: import { NzMessageService } from 'ng-zorro-antd/message';
 6: 
 7: @Component({
 8:   selector: 'app-quality-inspections',
 9:   standalone: true,
10:   imports: [SHARED_IMPORTS],
11:   template: `
12:     <page-header [title]="'éªŒæ”¶ç®¡ç†'">
13:       <ng-template #extra>
14:         <nz-select
15:           [ngModel]="selectedBlueprintId()"
16:           (ngModelChange)="selectedBlueprintId.set($event); onBlueprintChange()"
17:           nzPlaceHolder="è¯·é€‰æ‹©è“å›¾"
18:           style="width: 300px; margin-right: 8px;"
19:         >
20:           @for (blueprint of blueprintService.blueprints(); track blueprint.id) {
21:             <nz-option [nzValue]="blueprint.id" [nzLabel]="blueprint.name"></nz-option>
22:           }
23:         </nz-select>
24:       </ng-template>
25:     </page-header>
26: 
27:     <nz-card style="margin-top: 16px;">
28:       @if (!selectedBlueprintId()) {
29:         <nz-empty nzNotFoundContent="è¯·å…ˆé€‰æ‹©è“å›¾"></nz-empty>
30:       } @else if (loading()) {
31:         <div style="text-align: center; padding: 40px;">
32:           <nz-spin nzSize="large"></nz-spin>
33:         </div>
34:       } @else {
35:         <st #st [data]="inspections()" [columns]="columns" [loading]="loading()" [page]="{ front: false, show: true, showSize: true }">
36:         </st>
37:       }
38:     </nz-card>
39:   `
40: })
41: export class QualityInspectionsComponent implements OnInit {
42:   readonly blueprintService = inject(BlueprintService);
43:   private readonly router = inject(Router);
44:   private readonly message = inject(NzMessageService);
45: 
46:   readonly selectedBlueprintId = signal<string | null>(null);
47:   readonly loading = signal<boolean>(false);
48:   readonly inspections = signal<any[]>([]);
49: 
50:   columns: STColumn[] = [
51:     { title: 'ID', index: 'id', width: 100 },
52:     { title: 'éªŒæ”¶åç§°', index: 'name', width: 200 },
53:     { title: 'éªŒæ”¶ç±»å‹', index: 'type', width: 120 },
54:     { title: 'çŠ¶æ€', index: 'status', width: 100 },
55:     { title: 'éªŒæ”¶æ—¥æœŸ', index: 'inspection_date', type: 'date', width: 120 },
56:     { title: 'éªŒæ”¶äºº', index: 'inspector', width: 120 },
57:     { title: 'ç»“æœ', index: 'result', width: 100 },
58:     { title: 'åˆ›å»ºæ—¶é—´', index: 'created_at', type: 'date', width: 180 },
59:     {
60:       title: 'æ“ä½œ',
61:       width: 150,
62:       buttons: [
63:         {
64:           text: 'æŸ¥çœ‹',
65:           click: (record: any) => this.viewDetail(record.id)
66:         }
67:       ]
68:     }
69:   ];
70: 
71:   ngOnInit(): void {
72:     this.loadBlueprints();
73:   }
74: 
75:   async loadBlueprints(): Promise<void> {
76:     try {
77:       await this.blueprintService.loadBlueprints();
78:     } catch (error) {
79:       this.message.error('åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
80:     }
81:   }
82: 
83:   async onBlueprintChange(): Promise<void> {
84:     const blueprintId = this.selectedBlueprintId();
85:     if (blueprintId) {
86:       this.loading.set(true);
87:       // TODO: åŠ è½½éªŒæ”¶ç®¡ç†æ•°æ®
88:       setTimeout(() => {
89:         this.inspections.set([]);
90:         this.loading.set(false);
91:       }, 500);
92:     }
93:   }
94: 
95:   viewDetail(id: string): void {
96:     this.router.navigate(['/quality/inspections/detail', id]);
97:   }
98: }
````

## File: src/app/routes/quality/submit/quality-submit.component.ts
````typescript
  1: import { Component, OnInit, inject, signal } from '@angular/core';
  2: import { FormBuilder, FormGroup, Validators } from '@angular/forms';
  3: import { Router } from '@angular/router';
  4: import { SHARED_IMPORTS, BlueprintService } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: 
  7: @Component({
  8:   selector: 'app-quality-submit',
  9:   standalone: true,
 10:   imports: [SHARED_IMPORTS],
 11:   template: `
 12:     <page-header [title]="'æäº¤éªŒæ”¶'">
 13:       <ng-template #extra>
 14:         <button nz-button nzType="default" (click)="cancel()">
 15:           <span nz-icon nzType="close"></span>
 16:           å–æ¶ˆ
 17:         </button>
 18:         <button nz-button nzType="primary" (click)="submit()" [nzLoading]="loading()" style="margin-left: 8px;">
 19:           <span nz-icon nzType="check"></span>
 20:           æäº¤
 21:         </button>
 22:       </ng-template>
 23:     </page-header>
 24: 
 25:     <nz-card style="margin-top: 16px;">
 26:       <form nz-form [formGroup]="form" (ngSubmit)="submit()">
 27:         <nz-form-item>
 28:           <nz-form-label [nzSpan]="4" nzRequired>è“å›¾</nz-form-label>
 29:           <nz-form-control [nzSpan]="20" nzErrorTip="è¯·é€‰æ‹©è“å›¾">
 30:             <nz-select formControlName="blueprintId" nzPlaceHolder="è¯·é€‰æ‹©è“å›¾">
 31:               @for (blueprint of blueprintService.blueprints(); track blueprint.id) {
 32:                 <nz-option [nzValue]="blueprint.id" [nzLabel]="blueprint.name"></nz-option>
 33:               }
 34:             </nz-select>
 35:           </nz-form-control>
 36:         </nz-form-item>
 37: 
 38:         <nz-form-item>
 39:           <nz-form-label [nzSpan]="4" nzRequired>ä»»åŠ¡</nz-form-label>
 40:           <nz-form-control [nzSpan]="20" nzErrorTip="è¯·é€‰æ‹©ä»»åŠ¡">
 41:             <nz-select formControlName="taskId" nzPlaceHolder="è¯·é€‰æ‹©ä»»åŠ¡">
 42:               <!-- TODO: åŠ è½½ä»»åŠ¡åˆ—è¡¨ -->
 43:             </nz-select>
 44:           </nz-form-control>
 45:         </nz-form-item>
 46: 
 47:         <nz-form-item>
 48:           <nz-form-label [nzSpan]="4" nzRequired>éªŒæ”¶ç±»å‹</nz-form-label>
 49:           <nz-form-control [nzSpan]="20" nzErrorTip="è¯·é€‰æ‹©éªŒæ”¶ç±»å‹">
 50:             <nz-select formControlName="inspectionType" nzPlaceHolder="è¯·é€‰æ‹©éªŒæ”¶ç±»å‹">
 51:               <nz-option [nzValue]="'quality'" nzLabel="è´¨é‡éªŒæ”¶"></nz-option>
 52:               <nz-option [nzValue]="'safety'" nzLabel="å®‰å…¨éªŒæ”¶"></nz-option>
 53:               <nz-option [nzValue]="'completion'" nzLabel="å®Œå·¥éªŒæ”¶"></nz-option>
 54:             </nz-select>
 55:           </nz-form-control>
 56:         </nz-form-item>
 57: 
 58:         <nz-form-item>
 59:           <nz-form-label [nzSpan]="4">å¤‡æ³¨</nz-form-label>
 60:           <nz-form-control [nzSpan]="20">
 61:             <textarea nz-input formControlName="notes" [nzAutosize]="{ minRows: 3, maxRows: 6 }" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯"></textarea>
 62:           </nz-form-control>
 63:         </nz-form-item>
 64:       </form>
 65:     </nz-card>
 66:   `
 67: })
 68: export class QualitySubmitComponent implements OnInit {
 69:   readonly blueprintService = inject(BlueprintService);
 70:   private readonly router = inject(Router);
 71:   private readonly message = inject(NzMessageService);
 72:   private readonly fb = inject(FormBuilder);
 73: 
 74:   readonly loading = signal<boolean>(false);
 75:   form!: FormGroup;
 76: 
 77:   ngOnInit(): void {
 78:     this.initForm();
 79:     this.loadBlueprints();
 80:   }
 81: 
 82:   initForm(): void {
 83:     this.form = this.fb.group({
 84:       blueprintId: [null, [Validators.required]],
 85:       taskId: [null, [Validators.required]],
 86:       inspectionType: ['quality', [Validators.required]],
 87:       notes: ['']
 88:     });
 89:   }
 90: 
 91:   async loadBlueprints(): Promise<void> {
 92:     try {
 93:       await this.blueprintService.loadBlueprints();
 94:     } catch (error) {
 95:       this.message.error('åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
 96:     }
 97:   }
 98: 
 99:   async submit(): Promise<void> {
100:     if (this.form.invalid) {
101:       Object.values(this.form.controls).forEach(control => {
102:         if (control.invalid) {
103:           control.markAsDirty();
104:           control.updateValueAndValidity({ onlySelf: true });
105:         }
106:       });
107:       return;
108:     }
109: 
110:     this.loading.set(true);
111:     try {
112:       // TODO: æäº¤éªŒæ”¶ç”³è¯·
113:       await new Promise(resolve => setTimeout(resolve, 1000));
114:       this.message.success('æäº¤æˆåŠŸ');
115:       this.router.navigate(['/quality/checks']);
116:     } catch (error) {
117:       this.message.error('æäº¤å¤±è´¥');
118:     } finally {
119:       this.loading.set(false);
120:     }
121:   }
122: 
123:   cancel(): void {
124:     this.router.navigate(['/quality/checks']);
125:   }
126: }
````

## File: src/app/routes/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: import { startPageGuard } from '@core';
 3: import { authSimpleCanActivate, authSimpleCanActivateChild } from '@delon/auth';
 4: 
 5: import { LayoutBasicComponent, LayoutBlankComponent } from '../layout';
 6: 
 7: export const routes: Routes = [
 8:   {
 9:     path: '',
10:     component: LayoutBasicComponent,
11:     canActivate: [startPageGuard, authSimpleCanActivate],
12:     canActivateChild: [authSimpleCanActivateChild],
13:     data: {},
14:     children: [
15:       { path: '', redirectTo: 'dashboard', pathMatch: 'full' },
16:       {
17:         path: 'dashboard',
18:         loadChildren: () => import('./dashboard/routes').then(m => m.routes)
19:       },
20:       {
21:         path: 'widgets',
22:         loadChildren: () => import('./widgets/routes').then(m => m.routes)
23:       },
24:       { path: 'style', loadChildren: () => import('./style/routes').then(m => m.routes) },
25:       { path: 'delon', loadChildren: () => import('./delon/routes').then(m => m.routes) },
26:       { path: 'extras', loadChildren: () => import('./extras/routes').then(m => m.routes) },
27:       { path: 'pro', loadChildren: () => import('./pro/routes').then(m => m.routes) },
28:       { path: 'accounts', loadChildren: () => import('./accounts/routes').then(m => m.routes) },
29:       {
30:         path: 'collaboration',
31:         loadChildren: () => import('./collaboration/routes').then(m => m.COLLABORATION_ROUTES)
32:       },
33:       {
34:         path: 'blueprints',
35:         loadChildren: () => import('./blueprints/routes').then(m => m.BLUEPRINT_ROUTES)
36:       },
37:       {
38:         path: 'tasks',
39:         loadChildren: () => import('./tasks/routes').then(m => m.TASK_ROUTES)
40:       },
41:       {
42:         path: 'quality',
43:         loadChildren: () => import('./quality/routes').then(m => m.QUALITY_ROUTES)
44:       },
45:       {
46:         path: 'issues',
47:         loadChildren: () => import('./issues/routes').then(m => m.ISSUE_ROUTES)
48:       },
49:       {
50:         path: 'analytics',
51:         loadChildren: () => import('./analytics/routes').then(m => m.ANALYTICS_ROUTES)
52:       },
53:       {
54:         path: 'documents',
55:         loadChildren: () => import('./documents/routes').then(m => m.DOCUMENT_ROUTES)
56:       },
57:       {
58:         path: 'bots',
59:         loadChildren: () => import('./bots/routes').then(m => m.BOT_ROUTES)
60:       },
61:       {
62:         path: 'system',
63:         loadChildren: () => import('./system/routes').then(m => m.SYSTEM_ROUTES)
64:       },
65:       {
66:         path: 'communication',
67:         loadChildren: () => import('./communication/routes').then(m => m.COMMUNICATION_ROUTES)
68:       }
69:     ]
70:   },
71:   // Blak Layout ç©ºç™½å¸ƒå±€
72:   {
73:     path: 'data-v',
74:     component: LayoutBlankComponent,
75:     children: [{ path: '', loadChildren: () => import('./data-v/routes').then(m => m.routes) }]
76:   },
77:   // passport
78:   { path: '', loadChildren: () => import('./passport/routes').then(m => m.routes) },
79:   { path: 'exception', loadChildren: () => import('./exception/routes').then(m => m.routes) },
80:   { path: '**', redirectTo: 'exception/404' }
81: ];
````

## File: src/app/routes/style/color.service.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: 
 3: @Injectable()
 4: export class ColorService {
 5:   APP_COLORS = {
 6:     primary: '#1890ff',
 7:     success: '#52c41a',
 8:     error: '#f5222d',
 9:     warning: '#fadb14',
10:     red: '#f5222d',
11:     volcano: '#fa541c',
12:     orange: '#fa8c16',
13:     gold: '#faad14',
14:     yellow: '#fadb14',
15:     lime: '#a0d911',
16:     green: '#52c41a',
17:     cyan: '#13c2c2',
18:     blue: '#1890ff',
19:     geekblue: '#2f54eb',
20:     purple: '#722ed1',
21:     magenta: '#eb2f96'
22:   };
23: 
24:   get names(): string[] {
25:     return Object.keys(this.APP_COLORS).filter((_, index) => index > 3);
26:   }
27: 
28:   get brands(): string[] {
29:     return ['primary', 'success', 'error', 'warning'];
30:   }
31: }
````

## File: src/app/routes/style/colors/colors.component.ts
````typescript
 1: import { Component, inject } from '@angular/core';
 2: import { copy } from '@delon/util/browser';
 3: import { SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: 
 6: import { ColorService } from '../color.service';
 7: 
 8: @Component({
 9:   selector: 'app-colors',
10:   templateUrl: './colors.component.html',
11:   styleUrls: ['./colors.component.less'],
12:   imports: SHARED_IMPORTS
13: })
14: export class ColorsComponent {
15:   private readonly colorSrv = inject(ColorService);
16:   private readonly msg = inject(NzMessageService);
17: 
18:   nums = Array(10)
19:     .fill(1)
20:     .map((v, i) => v + i);
21: 
22:   get names(): string[] {
23:     return this.colorSrv.names;
24:   }
25: 
26:   get brands(): string[] {
27:     return this.colorSrv.brands;
28:   }
29: 
30:   onCopy(str: string): void {
31:     copy(str).then(() => this.msg.success(`Copied Success!`));
32:   }
33: }
````

## File: src/app/routes/style/gridmasonry/gridmasonry.component.ts
````typescript
 1: import { Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-gridmasonry',
 6:   templateUrl: './gridmasonry.component.html',
 7:   styleUrls: ['./gridmasonry.component.less'],
 8:   imports: SHARED_IMPORTS
 9: })
10: export class GridMasonryComponent {}
````

## File: src/app/routes/style/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: 
 3: import { ColorService } from './color.service';
 4: import { ColorsComponent } from './colors/colors.component';
 5: import { GridMasonryComponent } from './gridmasonry/gridmasonry.component';
 6: import { TypographyComponent } from './typography/typography.component';
 7: 
 8: export const routes: Routes = [
 9:   {
10:     path: '',
11:     providers: [ColorService],
12:     children: [
13:       { path: 'gridmasonry', component: GridMasonryComponent },
14:       { path: 'typography', component: TypographyComponent },
15:       { path: 'colors', component: ColorsComponent }
16:     ]
17:   }
18: ];
````

## File: src/app/routes/style/typography/typography.component.ts
````typescript
 1: import { Component, inject } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: import { ColorService } from '../color.service';
 5: 
 6: @Component({
 7:   selector: 'app-typography',
 8:   templateUrl: './typography.component.html',
 9:   imports: SHARED_IMPORTS
10: })
11: export class TypographyComponent {
12:   private readonly colorSrv = inject(ColorService);
13:   get names(): string[] {
14:     return this.colorSrv.names;
15:   }
16: }
````

## File: src/app/routes/system/activity-logs/system-activity-log.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-system-activity-log',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'ç³»ç»Ÿæ´»åŠ¨æ—¥å¿—'"></page-header>
11: 
12:     <nz-card nzTitle="ç³»ç»Ÿæ´»åŠ¨æ—¥å¿—" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="ç³»ç»Ÿæ´»åŠ¨æ—¥å¿—åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†å±•ç¤ºå¹³å°çº§æ“ä½œæ—¥å¿—ä¸å®¡è®¡è½¨è¿¹ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class SystemActivityLogComponent {}
````

## File: src/app/routes/system/backup/backup.spec.ts
````typescript
 1: import { ComponentFixture, TestBed } from '@angular/core/testing';
 2: 
 3: import { Backup } from './backup';
 4: 
 5: describe('Backup', () => {
 6:   let component: Backup;
 7:   let fixture: ComponentFixture<Backup>;
 8: 
 9:   beforeEach(async () => {
10:     await TestBed.configureTestingModule({
11:       imports: [Backup]
12:     }).compileComponents();
13: 
14:     fixture = TestBed.createComponent(Backup);
15:     component = fixture.componentInstance;
16:     fixture.detectChanges();
17:   });
18: 
19:   it('should create', () => {
20:     expect(component).toBeTruthy();
21:   });
22: });
````

## File: src/app/routes/system/backup/backup.ts
````typescript
1: import { Component } from '@angular/core';
2: 
3: @Component({
4:   selector: 'app-backup',
5:   imports: [],
6:   templateUrl: './backup.html',
7:   styleUrl: './backup.less'
8: })
9: export class Backup {}
````

## File: src/app/routes/system/branch-permissions/branch-permission.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-branch-permission',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'åˆ†æ”¯æƒé™ç®¡ç†'"></page-header>
11: 
12:     <nz-card nzTitle="åˆ†æ”¯æƒé™ç®¡ç†" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="åˆ†æ”¯æƒé™åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†æ ¡éªŒ Git-like åˆ†æ”¯æ¨¡å‹ä¸‹çš„è®¿é—®æ§åˆ¶ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class BranchPermissionComponent {}
````

## File: src/app/routes/system/feature-flags/feature-flag.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-feature-flag',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'åŠŸèƒ½å¼€å…³'"></page-header>
11: 
12:     <nz-card nzTitle="åŠŸèƒ½å¼€å…³" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="åŠŸèƒ½å¼€å…³æ¨¡å—å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†ç®¡ç†åŠŸèƒ½æ ‡è®°ã€ç°åº¦ç­–ç•¥ä¸å¿«ç…§ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class FeatureFlagComponent {}
````

## File: src/app/routes/system/permission-matrix/permission-matrix.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-permission-matrix',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'æƒé™çŸ©é˜µ'"></page-header>
11: 
12:     <nz-card nzTitle="æƒé™çŸ©é˜µ" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="æƒé™çŸ©é˜µåŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†å±•ç¤ºè§’è‰²ã€æ¨¡å—ä¸æ“ä½œçš„çŸ©é˜µæ˜ å°„ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class PermissionMatrixComponent {}
````

## File: src/app/routes/system/permissions/permission-assignment.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-permission-assignment',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'æƒé™åˆ†é…'"></page-header>
11: 
12:     <nz-card nzTitle="æƒé™åˆ†é…" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="æƒé™åˆ†é…åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†æä¾›æƒé™æˆäºˆã€å®¡æ‰¹æµç¨‹ä¸å†å²è®°å½•ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class PermissionAssignmentComponent {}
````

## File: src/app/routes/system/roles/role-management.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-role-management',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'è§’è‰²ç®¡ç†'"></page-header>
11: 
12:     <nz-card nzTitle="è§’è‰²ç®¡ç†" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="è§’è‰²ç®¡ç†åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†ç»´æŠ¤è§’è‰²å®šä¹‰ã€èŒè´£è¯´æ˜ä»¥åŠæ˜ å°„ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class RoleManagementComponent {}
````

## File: src/app/routes/system/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: 
 3: export const SYSTEM_ROUTES: Routes = [
 4:   {
 5:     path: '',
 6:     redirectTo: 'settings',
 7:     pathMatch: 'full'
 8:   },
 9:   {
10:     path: 'settings',
11:     loadComponent: () => import('./settings/system-settings.component').then(m => m.SystemSettingsComponent)
12:   },
13:   {
14:     path: 'settings/personal',
15:     loadComponent: () => import('./settings/personal/personal-settings.component').then(m => m.PersonalSettingsComponent)
16:   },
17:   {
18:     path: 'settings/project',
19:     loadComponent: () => import('./settings/project/project-settings.component').then(m => m.ProjectSettingsComponent)
20:   },
21:   {
22:     path: 'settings/global',
23:     loadComponent: () => import('./settings/global/global-settings.component').then(m => m.GlobalSettingsComponent)
24:   },
25:   {
26:     path: 'feature-flags',
27:     loadComponent: () => import('./feature-flags/feature-flag.component').then(m => m.FeatureFlagComponent)
28:   },
29:   {
30:     path: 'roles',
31:     loadComponent: () => import('./roles/role-management.component').then(m => m.RoleManagementComponent)
32:   },
33:   {
34:     path: 'permissions',
35:     loadComponent: () => import('./permissions/permission-assignment.component').then(m => m.PermissionAssignmentComponent)
36:   },
37:   {
38:     path: 'permission-matrix',
39:     loadComponent: () => import('./permission-matrix/permission-matrix.component').then(m => m.PermissionMatrixComponent)
40:   },
41:   {
42:     path: 'branch-permissions',
43:     loadComponent: () => import('./branch-permissions/branch-permission.component').then(m => m.BranchPermissionComponent)
44:   },
45:   {
46:     path: 'weather-api',
47:     loadComponent: () => import('./weather-api/weather-api.component').then(m => m.WeatherApiComponent)
48:   },
49:   {
50:     path: 'activity-logs',
51:     loadComponent: () => import('./activity-logs/system-activity-log.component').then(m => m.SystemActivityLogComponent)
52:   },
53:   {
54:     path: 'backup',
55:     loadComponent: () => import('./backup/backup').then(m => m.Backup)
56:   }
57: ];
````

## File: src/app/routes/system/settings/global/global-settings.component.spec.ts
````typescript
 1: import { fakeAsync, ComponentFixture, TestBed } from '@angular/core/testing';
 2: 
 3: import { GlobalSettingsComponent } from './global-settings.component';
 4: 
 5: describe('GlobalSettingsComponent', () => {
 6:   let component: GlobalSettingsComponent;
 7:   let fixture: ComponentFixture<GlobalSettingsComponent>;
 8: 
 9:   beforeEach(fakeAsync(() => {
10:     TestBed.configureTestingModule({
11:       imports: [GlobalSettingsComponent]
12:     }).compileComponents();
13:     fixture = TestBed.createComponent(GlobalSettingsComponent);
14:     component = fixture.componentInstance;
15:     fixture.detectChanges();
16:   }));
17: 
18:   it('should compile', () => {
19:     expect(component).toBeTruthy();
20:   });
21: });
````

## File: src/app/routes/system/settings/global/global-settings.component.ts
````typescript
 1: import { Component, inject, OnDestroy, OnInit } from '@angular/core';
 2: import { AbstractControl, NonNullableFormBuilder, ReactiveFormsModule, ValidationErrors, Validators } from '@angular/forms';
 3: import { NzButtonModule } from 'ng-zorro-antd/button';
 4: import { NzFormModule } from 'ng-zorro-antd/form';
 5: import { NzInputModule } from 'ng-zorro-antd/input';
 6: import { Observable, Observer, Subject } from 'rxjs';
 7: import { takeUntil } from 'rxjs/operators';
 8: 
 9: @Component({
10:   selector: 'app-global-settings',
11:   imports: [ReactiveFormsModule, NzButtonModule, NzFormModule, NzInputModule],
12:   templateUrl: './global-settings.component.html',
13:   styleUrls: ['./global-settings.component.less']
14: })
15: export class GlobalSettingsComponent implements OnInit, OnDestroy {
16:   private fb = inject(NonNullableFormBuilder);
17:   private destroy$ = new Subject<void>();
18:   validateForm = this.fb.group({
19:     userName: this.fb.control('', [Validators.required], [this.userNameAsyncValidator]),
20:     email: this.fb.control('', [Validators.email, Validators.required]),
21:     password: this.fb.control('', [Validators.required]),
22:     confirm: this.fb.control('', [this.confirmValidator]),
23:     comment: this.fb.control('', [Validators.required])
24:   });
25: 
26:   ngOnInit(): void {
27:     this.validateForm.controls.password.valueChanges.pipe(takeUntil(this.destroy$)).subscribe(() => {
28:       this.validateForm.controls.confirm.updateValueAndValidity();
29:     });
30:   }
31: 
32:   ngOnDestroy(): void {
33:     this.destroy$.next();
34:     this.destroy$.complete();
35:   }
36: 
37:   submitForm(): void {
38:     console.log('submit', this.validateForm.value);
39:   }
40: 
41:   resetForm(e: MouseEvent): void {
42:     e.preventDefault();
43:     this.validateForm.reset();
44:   }
45: 
46:   userNameAsyncValidator(control: AbstractControl): Observable<ValidationErrors | null> {
47:     return new Observable((observer: Observer<ValidationErrors | null>) => {
48:       setTimeout(() => {
49:         if (control.value === 'JasonWood') {
50:           // you have to return `{error: true}` to mark it as an error event
51:           observer.next({ error: true, duplicated: true });
52:         } else {
53:           observer.next(null);
54:         }
55:         observer.complete();
56:       }, 1000);
57:     });
58:   }
59: 
60:   confirmValidator(control: AbstractControl): ValidationErrors | null {
61:     if (!control.value) {
62:       return { error: true, required: true };
63:     } else if (control.value !== control.parent!.value.password) {
64:       return { confirm: true, error: true };
65:     }
66:     return {};
67:   }
68: }
````

## File: src/app/routes/system/settings/personal/personal-settings.component.spec.ts
````typescript
 1: import { fakeAsync, ComponentFixture, TestBed } from '@angular/core/testing';
 2: 
 3: import { PersonalSettingsComponent } from './personal-settings.component';
 4: 
 5: describe('PersonalSettingsComponent', () => {
 6:   let component: PersonalSettingsComponent;
 7:   let fixture: ComponentFixture<PersonalSettingsComponent>;
 8: 
 9:   beforeEach(fakeAsync(() => {
10:     TestBed.configureTestingModule({
11:       imports: [PersonalSettingsComponent]
12:     }).compileComponents();
13:     fixture = TestBed.createComponent(PersonalSettingsComponent);
14:     component = fixture.componentInstance;
15:     fixture.detectChanges();
16:   }));
17: 
18:   it('should compile', () => {
19:     expect(component).toBeTruthy();
20:   });
21: });
````

## File: src/app/routes/system/settings/personal/personal-settings.component.ts
````typescript
 1: import { Component, inject, OnDestroy, OnInit } from '@angular/core';
 2: import { AbstractControl, NonNullableFormBuilder, ReactiveFormsModule, ValidationErrors, Validators } from '@angular/forms';
 3: import { NzButtonModule } from 'ng-zorro-antd/button';
 4: import { NzFormModule } from 'ng-zorro-antd/form';
 5: import { NzInputModule } from 'ng-zorro-antd/input';
 6: import { Observable, Observer, Subject } from 'rxjs';
 7: import { takeUntil } from 'rxjs/operators';
 8: 
 9: @Component({
10:   selector: 'app-personal-settings',
11:   imports: [ReactiveFormsModule, NzButtonModule, NzFormModule, NzInputModule],
12:   templateUrl: './personal-settings.component.html',
13:   styleUrls: ['./personal-settings.component.less']
14: })
15: export class PersonalSettingsComponent implements OnInit, OnDestroy {
16:   private fb = inject(NonNullableFormBuilder);
17:   private destroy$ = new Subject<void>();
18:   validateForm = this.fb.group({
19:     userName: this.fb.control('', [Validators.required], [this.userNameAsyncValidator]),
20:     email: this.fb.control('', [Validators.email, Validators.required]),
21:     password: this.fb.control('', [Validators.required]),
22:     confirm: this.fb.control('', [this.confirmValidator]),
23:     comment: this.fb.control('', [Validators.required])
24:   });
25: 
26:   ngOnInit(): void {
27:     this.validateForm.controls.password.valueChanges.pipe(takeUntil(this.destroy$)).subscribe(() => {
28:       this.validateForm.controls.confirm.updateValueAndValidity();
29:     });
30:   }
31: 
32:   ngOnDestroy(): void {
33:     this.destroy$.next();
34:     this.destroy$.complete();
35:   }
36: 
37:   submitForm(): void {
38:     console.log('submit', this.validateForm.value);
39:   }
40: 
41:   resetForm(e: MouseEvent): void {
42:     e.preventDefault();
43:     this.validateForm.reset();
44:   }
45: 
46:   userNameAsyncValidator(control: AbstractControl): Observable<ValidationErrors | null> {
47:     return new Observable((observer: Observer<ValidationErrors | null>) => {
48:       setTimeout(() => {
49:         if (control.value === 'JasonWood') {
50:           // you have to return `{error: true}` to mark it as an error event
51:           observer.next({ error: true, duplicated: true });
52:         } else {
53:           observer.next(null);
54:         }
55:         observer.complete();
56:       }, 1000);
57:     });
58:   }
59: 
60:   confirmValidator(control: AbstractControl): ValidationErrors | null {
61:     if (!control.value) {
62:       return { error: true, required: true };
63:     } else if (control.value !== control.parent!.value.password) {
64:       return { confirm: true, error: true };
65:     }
66:     return {};
67:   }
68: }
````

## File: src/app/routes/system/settings/project/project-settings.component.spec.ts
````typescript
 1: import { fakeAsync, ComponentFixture, TestBed } from '@angular/core/testing';
 2: 
 3: import { ProjectSettingsComponent } from './project-settings.component';
 4: 
 5: describe('ProjectSettingsComponent', () => {
 6:   let component: ProjectSettingsComponent;
 7:   let fixture: ComponentFixture<ProjectSettingsComponent>;
 8: 
 9:   beforeEach(fakeAsync(() => {
10:     TestBed.configureTestingModule({
11:       imports: [ProjectSettingsComponent]
12:     }).compileComponents();
13:     fixture = TestBed.createComponent(ProjectSettingsComponent);
14:     component = fixture.componentInstance;
15:     fixture.detectChanges();
16:   }));
17: 
18:   it('should compile', () => {
19:     expect(component).toBeTruthy();
20:   });
21: });
````

## File: src/app/routes/system/settings/project/project-settings.component.ts
````typescript
 1: import { Component, inject, OnDestroy, OnInit } from '@angular/core';
 2: import { AbstractControl, NonNullableFormBuilder, ReactiveFormsModule, ValidationErrors, Validators } from '@angular/forms';
 3: import { NzButtonModule } from 'ng-zorro-antd/button';
 4: import { NzFormModule } from 'ng-zorro-antd/form';
 5: import { NzInputModule } from 'ng-zorro-antd/input';
 6: import { Observable, Observer, Subject } from 'rxjs';
 7: import { takeUntil } from 'rxjs/operators';
 8: 
 9: @Component({
10:   selector: 'app-project-settings',
11:   imports: [ReactiveFormsModule, NzButtonModule, NzFormModule, NzInputModule],
12:   templateUrl: './project-settings.component.html',
13:   styleUrls: ['./project-settings.component.less']
14: })
15: export class ProjectSettingsComponent implements OnInit, OnDestroy {
16:   private fb = inject(NonNullableFormBuilder);
17:   private destroy$ = new Subject<void>();
18:   validateForm = this.fb.group({
19:     userName: this.fb.control('', [Validators.required], [this.userNameAsyncValidator]),
20:     email: this.fb.control('', [Validators.email, Validators.required]),
21:     password: this.fb.control('', [Validators.required]),
22:     confirm: this.fb.control('', [this.confirmValidator]),
23:     comment: this.fb.control('', [Validators.required])
24:   });
25: 
26:   ngOnInit(): void {
27:     this.validateForm.controls.password.valueChanges.pipe(takeUntil(this.destroy$)).subscribe(() => {
28:       this.validateForm.controls.confirm.updateValueAndValidity();
29:     });
30:   }
31: 
32:   ngOnDestroy(): void {
33:     this.destroy$.next();
34:     this.destroy$.complete();
35:   }
36: 
37:   submitForm(): void {
38:     console.log('submit', this.validateForm.value);
39:   }
40: 
41:   resetForm(e: MouseEvent): void {
42:     e.preventDefault();
43:     this.validateForm.reset();
44:   }
45: 
46:   userNameAsyncValidator(control: AbstractControl): Observable<ValidationErrors | null> {
47:     return new Observable((observer: Observer<ValidationErrors | null>) => {
48:       setTimeout(() => {
49:         if (control.value === 'JasonWood') {
50:           // you have to return `{error: true}` to mark it as an error event
51:           observer.next({ error: true, duplicated: true });
52:         } else {
53:           observer.next(null);
54:         }
55:         observer.complete();
56:       }, 1000);
57:     });
58:   }
59: 
60:   confirmValidator(control: AbstractControl): ValidationErrors | null {
61:     if (!control.value) {
62:       return { error: true, required: true };
63:     } else if (control.value !== control.parent!.value.password) {
64:       return { confirm: true, error: true };
65:     }
66:     return {};
67:   }
68: }
````

## File: src/app/routes/system/settings/system-settings.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-system-settings',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'ç³»ç»Ÿè®¾ç½®'"></page-header>
11: 
12:     <nz-card nzTitle="ç³»ç»Ÿè®¾ç½®" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="ç³»ç»Ÿè®¾ç½®åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†é›†ä¸­ç»´æŠ¤å¹³å°çº§å‚æ•°ä¸ä¸»é¢˜é…ç½®ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class SystemSettingsComponent {}
````

## File: src/app/routes/system/weather-api/weather-api.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-weather-api',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   changeDetection: ChangeDetectionStrategy.OnPush,
 9:   template: `
10:     <page-header [title]="'å¤©æ°” API é…ç½®'"></page-header>
11: 
12:     <nz-card nzTitle="å¤©æ°” API é…ç½®" style="margin-top: 16px;">
13:       <nz-alert
14:         nzType="info"
15:         nzMessage="å¤©æ°” API é…ç½®åŠŸèƒ½å»ºè®¾ä¸­"
16:         nzDescription="æ­¤é¡µé¢å°†é…ç½®ç¬¬ä¸‰æ–¹å¤©æ°”æœåŠ¡ã€é…é¢ä¸ç¼“å­˜ç­–ç•¥ã€‚"
17:         [nzShowIcon]="true"
18:         style="margin-bottom: 16px;"
19:       ></nz-alert>
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class WeatherApiComponent {}
````

## File: src/app/routes/tasks/assignments/task-assignments.component.ts
````typescript
  1: import { Component, OnInit, inject, signal, computed } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { TaskAssignmentRepository } from '@core';
  4: import { STColumn } from '@delon/abc/st';
  5: import { SHARED_IMPORTS, TaskService, Task, TaskAssignment, BlueprintService } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: import { firstValueFrom } from 'rxjs';
  8: 
  9: @Component({
 10:   selector: 'app-task-assignments',
 11:   standalone: true,
 12:   imports: [SHARED_IMPORTS],
 13:   template: `
 14:     <page-header [title]="'ä»»åŠ¡åˆ†é…'">
 15:       <ng-template #extra>
 16:         <nz-select
 17:           [ngModel]="selectedBlueprintId()"
 18:           (ngModelChange)="selectedBlueprintId.set($event); onBlueprintChange()"
 19:           nzPlaceHolder="è¯·é€‰æ‹©è“å›¾"
 20:           style="width: 300px; margin-right: 8px;"
 21:         >
 22:           @for (blueprint of blueprintService.blueprints(); track blueprint.id) {
 23:             <nz-option [nzValue]="blueprint.id" [nzLabel]="blueprint.name"></nz-option>
 24:           }
 25:         </nz-select>
 26:       </ng-template>
 27:     </page-header>
 28: 
 29:     <nz-card style="margin-top: 16px;">
 30:       @if (!selectedBlueprintId()) {
 31:         <nz-empty nzNotFoundContent="è¯·å…ˆé€‰æ‹©è“å›¾"></nz-empty>
 32:       } @else if (loading()) {
 33:         <div style="text-align: center; padding: 40px;">
 34:           <nz-spin nzSize="large"></nz-spin>
 35:         </div>
 36:       } @else {
 37:         <st #st [data]="assignments()" [columns]="columns" [loading]="loading()" [page]="{ front: false, show: true, showSize: true }">
 38:           <ng-template #assigneeType let-record>
 39:             @switch (record.assignee_type) {
 40:               @case ('user') {
 41:                 <nz-tag nzColor="blue">ç”¨æˆ·</nz-tag>
 42:               }
 43:               @case ('team') {
 44:                 <nz-tag nzColor="green">å›¢é˜Ÿ</nz-tag>
 45:               }
 46:               @case ('organization') {
 47:                 <nz-tag nzColor="purple">ç»„ç»‡</nz-tag>
 48:               }
 49:               @case ('contractor') {
 50:                 <nz-tag nzColor="orange">æ‰¿åŒ…å•†</nz-tag>
 51:               }
 52:             }
 53:           </ng-template>
 54:         </st>
 55:       }
 56:     </nz-card>
 57:   `
 58: })
 59: export class TaskAssignmentsComponent implements OnInit {
 60:   readonly taskService = inject(TaskService);
 61:   readonly blueprintService = inject(BlueprintService);
 62:   private readonly taskAssignmentRepository = inject(TaskAssignmentRepository);
 63:   private readonly router = inject(Router);
 64:   private readonly message = inject(NzMessageService);
 65: 
 66:   readonly selectedBlueprintId = signal<string | null>(null);
 67:   readonly loading = signal<boolean>(false);
 68:   readonly assignments = signal<TaskAssignment[]>([]);
 69: 
 70:   columns: STColumn[] = [
 71:     { title: 'ä»»åŠ¡ID', index: 'task_id', width: 120 },
 72:     { title: 'ä»»åŠ¡æ ‡é¢˜', index: 'task_title', width: 200, format: (item: TaskAssignment) => this.getTaskTitle(item.task_id) },
 73:     { title: 'æŒ‡æ´¾å¯¹è±¡ID', index: 'assignee_id', width: 120 },
 74:     { title: 'æŒ‡æ´¾ç±»å‹', index: 'assignee_type', width: 100, render: 'assigneeType' },
 75:     { title: 'æŒ‡æ´¾è€…ID', index: 'assigned_by', width: 120 },
 76:     { title: 'æŒ‡æ´¾æ—¶é—´', index: 'assigned_at', type: 'date', width: 180 },
 77:     {
 78:       title: 'æ“ä½œ',
 79:       width: 150,
 80:       buttons: [
 81:         {
 82:           text: 'æŸ¥çœ‹ä»»åŠ¡',
 83:           click: (record: TaskAssignment) => this.viewTask(record.task_id)
 84:         }
 85:       ]
 86:     }
 87:   ];
 88: 
 89:   ngOnInit(): void {
 90:     this.loadBlueprints();
 91:   }
 92: 
 93:   async loadBlueprints(): Promise<void> {
 94:     try {
 95:       await this.blueprintService.loadBlueprints();
 96:     } catch (error) {
 97:       this.message.error('åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
 98:     }
 99:   }
100: 
101:   async onBlueprintChange(): Promise<void> {
102:     const blueprintId = this.selectedBlueprintId();
103:     if (!blueprintId) return;
104: 
105:     this.loading.set(true);
106:     try {
107:       // å…ˆåŠ è½½ä»»åŠ¡åˆ—è¡¨
108:       await this.taskService.loadTasksByBlueprint(blueprintId);
109: 
110:       // ç„¶ååŠ è½½æ‰€æœ‰ä»»åŠ¡çš„åˆ†é…ä¿¡æ¯
111:       const tasks = this.taskService.tasks();
112:       const assignmentPromises = tasks.map(task => firstValueFrom(this.taskAssignmentRepository.findByTaskId(task.id)));
113:       const assignmentArrays = await Promise.all(assignmentPromises);
114:       const allAssignments = assignmentArrays.flat();
115: 
116:       this.assignments.set(allAssignments);
117:     } catch (error) {
118:       this.message.error('åŠ è½½ä»»åŠ¡åˆ†é…å¤±è´¥');
119:     } finally {
120:       this.loading.set(false);
121:     }
122:   }
123: 
124:   getTaskTitle(taskId: string): string {
125:     const task = this.taskService.tasks().find(t => t.id === taskId);
126:     return task?.title || taskId;
127:   }
128: 
129:   viewTask(taskId: string): void {
130:     this.router.navigate(['/tasks', taskId]);
131:   }
132: }
````

## File: src/app/routes/tasks/board/task-board.component.ts
````typescript
  1: import { Component, OnInit, inject, signal, computed } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { SHARED_IMPORTS, TaskService, Task, TaskStatus, BlueprintService } from '@shared';
  4: import { NzMessageService } from 'ng-zorro-antd/message';
  5: 
  6: @Component({
  7:   selector: 'app-task-board',
  8:   standalone: true,
  9:   imports: [SHARED_IMPORTS],
 10:   template: `
 11:     <page-header [title]="'ä»»åŠ¡çœ‹æ¿'">
 12:       <ng-template #extra>
 13:         <nz-select
 14:           [ngModel]="selectedBlueprintId()"
 15:           (ngModelChange)="selectedBlueprintId.set($event); onBlueprintChange()"
 16:           nzPlaceHolder="è¯·é€‰æ‹©è“å›¾"
 17:           style="width: 300px; margin-right: 8px;"
 18:         >
 19:           @for (blueprint of blueprintService.blueprints(); track blueprint.id) {
 20:             <nz-option [nzValue]="blueprint.id" [nzLabel]="blueprint.name"></nz-option>
 21:           }
 22:         </nz-select>
 23:         <button nz-button nzType="primary" (click)="createTask()">
 24:           <span nz-icon nzType="plus"></span>
 25:           æ–°å»ºä»»åŠ¡
 26:         </button>
 27:       </ng-template>
 28:     </page-header>
 29: 
 30:     <nz-card style="margin-top: 16px;">
 31:       @if (!selectedBlueprintId()) {
 32:         <nz-empty nzNotFoundContent="è¯·å…ˆé€‰æ‹©è“å›¾"></nz-empty>
 33:       } @else if (taskService.loading()) {
 34:         <div style="text-align: center; padding: 40px;">
 35:           <nz-spin nzSize="large"></nz-spin>
 36:         </div>
 37:       } @else {
 38:         <div nz-row [nzGutter]="16">
 39:           @for (column of boardColumns; track column.status) {
 40:             <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6">
 41:               <nz-card [nzTitle]="column.title" [nzBordered]="true" style="margin-bottom: 16px;">
 42:                 @for (task of column.tasks(); track task.id) {
 43:                   <nz-card
 44:                     [nzType]="'inner'"
 45:                     [nzTitle]="task.title"
 46:                     style="margin-bottom: 8px; cursor: pointer;"
 47:                     (click)="viewTask(task.id)"
 48:                   >
 49:                     <p style="margin: 0; color: #666; font-size: 12px;">
 50:                       {{ task.description || 'æ— æè¿°' }}
 51:                     </p>
 52:                     <div style="margin-top: 8px;">
 53:                       @switch (task.priority) {
 54:                         @case ('low') {
 55:                           <nz-tag nzColor="default" nzSize="small">ä½</nz-tag>
 56:                         }
 57:                         @case ('medium') {
 58:                           <nz-tag nzColor="blue" nzSize="small">ä¸­</nz-tag>
 59:                         }
 60:                         @case ('high') {
 61:                           <nz-tag nzColor="orange" nzSize="small">é«˜</nz-tag>
 62:                         }
 63:                         @case ('urgent') {
 64:                           <nz-tag nzColor="red" nzSize="small">ç´§æ€¥</nz-tag>
 65:                         }
 66:                       }
 67:                       <nz-progress
 68:                         [nzPercent]="task.progress_percentage || 0"
 69:                         [nzShowInfo]="false"
 70:                         [nzSize]="'small'"
 71:                         style="margin-top: 4px;"
 72:                       ></nz-progress>
 73:                     </div>
 74:                   </nz-card>
 75:                 } @empty {
 76:                   <nz-empty [nzNotFoundContent]="'æš‚æ— ä»»åŠ¡'"></nz-empty>
 77:                 }
 78:               </nz-card>
 79:             </div>
 80:           }
 81:         </div>
 82:       }
 83:     </nz-card>
 84:   `
 85: })
 86: export class TaskBoardComponent implements OnInit {
 87:   readonly taskService = inject(TaskService);
 88:   readonly blueprintService = inject(BlueprintService);
 89:   private readonly router = inject(Router);
 90:   private readonly message = inject(NzMessageService);
 91: 
 92:   readonly selectedBlueprintId = signal<string | null>(null);
 93: 
 94:   readonly boardColumns = [
 95:     {
 96:       title: 'å¾…å¤„ç†',
 97:       status: TaskStatus.PENDING,
 98:       tasks: computed(() => this.taskService.tasks().filter(t => t.status === TaskStatus.PENDING))
 99:     },
100:     {
101:       title: 'è¿›è¡Œä¸­',
102:       status: TaskStatus.IN_PROGRESS,
103:       tasks: computed(() => this.taskService.tasks().filter(t => t.status === TaskStatus.IN_PROGRESS))
104:     },
105:     {
106:       title: 'æš‚å­˜ä¸­',
107:       status: TaskStatus.STAGING,
108:       tasks: computed(() => this.taskService.tasks().filter(t => t.status === TaskStatus.STAGING))
109:     },
110:     {
111:       title: 'å·²å®Œæˆ',
112:       status: TaskStatus.COMPLETED,
113:       tasks: computed(() => this.taskService.tasks().filter(t => t.status === TaskStatus.COMPLETED))
114:     }
115:   ];
116: 
117:   ngOnInit(): void {
118:     this.loadBlueprints();
119:   }
120: 
121:   async loadBlueprints(): Promise<void> {
122:     try {
123:       await this.blueprintService.loadBlueprints();
124:     } catch (error) {
125:       this.message.error('åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
126:     }
127:   }
128: 
129:   async onBlueprintChange(): Promise<void> {
130:     const blueprintId = this.selectedBlueprintId();
131:     if (blueprintId) {
132:       try {
133:         await this.taskService.loadTasksByBlueprint(blueprintId);
134:       } catch (error) {
135:         this.message.error('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥');
136:       }
137:     }
138:   }
139: 
140:   createTask(): void {
141:     this.router.navigate(['/tasks/create']);
142:   }
143: 
144:   viewTask(id: string): void {
145:     this.router.navigate(['/tasks', id]);
146:   }
147: }
````

## File: src/app/routes/tasks/calendar/task-calendar.component.ts
````typescript
  1: import { Component, OnInit, inject, signal, computed } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { SHARED_IMPORTS, TaskService, Task, BlueprintService } from '@shared';
  4: import { NzMessageService } from 'ng-zorro-antd/message';
  5: 
  6: @Component({
  7:   selector: 'app-task-calendar',
  8:   standalone: true,
  9:   imports: [SHARED_IMPORTS],
 10:   template: `
 11:     <page-header [title]="'ä»»åŠ¡æ—¥å†'">
 12:       <ng-template #extra>
 13:         <nz-select
 14:           [ngModel]="selectedBlueprintId()"
 15:           (ngModelChange)="selectedBlueprintId.set($event); onBlueprintChange()"
 16:           nzPlaceHolder="è¯·é€‰æ‹©è“å›¾"
 17:           style="width: 300px; margin-right: 8px;"
 18:         >
 19:           @for (blueprint of blueprintService.blueprints(); track blueprint.id) {
 20:             <nz-option [nzValue]="blueprint.id" [nzLabel]="blueprint.name"></nz-option>
 21:           }
 22:         </nz-select>
 23:         <button nz-button nzType="primary" (click)="createTask()">
 24:           <span nz-icon nzType="plus"></span>
 25:           æ–°å»ºä»»åŠ¡
 26:         </button>
 27:       </ng-template>
 28:     </page-header>
 29: 
 30:     <nz-card style="margin-top: 16px;">
 31:       @if (!selectedBlueprintId()) {
 32:         <nz-empty nzNotFoundContent="è¯·å…ˆé€‰æ‹©è“å›¾"></nz-empty>
 33:       } @else if (taskService.loading()) {
 34:         <div style="text-align: center; padding: 40px;">
 35:           <nz-spin nzSize="large"></nz-spin>
 36:         </div>
 37:       } @else {
 38:         <nz-calendar [ngModel]="selectedDate()" (nzSelectChange)="onDateSelect($event)" [nzFullscreen]="false">
 39:           <ul *nzDateCell="let date" class="events">
 40:             @for (task of getTasksForDate(date); track task.id) {
 41:               <li
 42:                 [style.background-color]="getTaskColor(task)"
 43:                 [title]="task.title"
 44:                 (click)="viewTask(task.id)"
 45:                 style="cursor: pointer; padding: 2px 4px; margin: 2px 0; border-radius: 2px; color: white; font-size: 12px;"
 46:               >
 47:                 {{ task.title }}
 48:               </li>
 49:             }
 50:           </ul>
 51:         </nz-calendar>
 52: 
 53:         <nz-divider nzText="é€‰ä¸­æ—¥æœŸçš„ä»»åŠ¡"></nz-divider>
 54:         @if (tasksForSelectedDate().length === 0) {
 55:           <nz-empty [nzNotFoundContent]="'è¯¥æ—¥æœŸæš‚æ— ä»»åŠ¡'"></nz-empty>
 56:         } @else {
 57:           <nz-list [nzDataSource]="tasksForSelectedDate()" [nzRenderItem]="item">
 58:             <ng-template #item let-task>
 59:               <nz-list-item>
 60:                 <nz-list-item-meta [nzTitle]="task.title" [nzDescription]="task.description || 'æ— æè¿°'">
 61:                   <ng-template #nzAvatar>
 62:                     <nz-tag [nzColor]="getPriorityColor(task.priority)">{{ task.priority }}</nz-tag>
 63:                   </ng-template>
 64:                 </nz-list-item-meta>
 65:                 <ul nz-list-item-actions>
 66:                   <nz-list-item-action>
 67:                     <button nz-button nzType="link" nzSize="small" (click)="viewTask(task.id)"> æŸ¥çœ‹ </button>
 68:                   </nz-list-item-action>
 69:                 </ul>
 70:               </nz-list-item>
 71:             </ng-template>
 72:           </nz-list>
 73:         }
 74:       }
 75:     </nz-card>
 76:   `
 77: })
 78: export class TaskCalendarComponent implements OnInit {
 79:   readonly taskService = inject(TaskService);
 80:   readonly blueprintService = inject(BlueprintService);
 81:   private readonly router = inject(Router);
 82:   private readonly message = inject(NzMessageService);
 83: 
 84:   readonly selectedBlueprintId = signal<string | null>(null);
 85:   readonly selectedDate = signal<Date>(new Date());
 86: 
 87:   readonly tasksForSelectedDate = computed(() => {
 88:     const date = this.selectedDate();
 89:     return this.getTasksForDate(date);
 90:   });
 91: 
 92:   ngOnInit(): void {
 93:     this.loadBlueprints();
 94:   }
 95: 
 96:   async loadBlueprints(): Promise<void> {
 97:     try {
 98:       await this.blueprintService.loadBlueprints();
 99:     } catch (error) {
100:       this.message.error('åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
101:     }
102:   }
103: 
104:   async onBlueprintChange(): Promise<void> {
105:     const blueprintId = this.selectedBlueprintId();
106:     if (blueprintId) {
107:       try {
108:         await this.taskService.loadTasksByBlueprint(blueprintId);
109:       } catch (error) {
110:         this.message.error('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥');
111:       }
112:     }
113:   }
114: 
115:   onDateSelect(date: Date): void {
116:     this.selectedDate.set(date);
117:   }
118: 
119:   getTasksForDate(date: Date): Task[] {
120:     const dateStr = date.toISOString().split('T')[0];
121:     return this.taskService.tasks().filter(task => {
122:       const startDate = task.planned_start_date ? task.planned_start_date.split('T')[0] : null;
123:       const endDate = task.planned_end_date ? task.planned_end_date.split('T')[0] : null;
124:       return startDate === dateStr || endDate === dateStr || (startDate && endDate && dateStr >= startDate && dateStr <= endDate);
125:     });
126:   }
127: 
128:   getTaskColor(task: Task): string {
129:     switch (task.priority) {
130:       case 'urgent':
131:         return '#ff4d4f';
132:       case 'high':
133:         return '#ff9800';
134:       case 'medium':
135:         return '#1890ff';
136:       case 'low':
137:         return '#52c41a';
138:       default:
139:         return '#d9d9d9';
140:     }
141:   }
142: 
143:   getPriorityColor(priority: string): string {
144:     switch (priority) {
145:       case 'urgent':
146:         return 'red';
147:       case 'high':
148:         return 'orange';
149:       case 'medium':
150:         return 'blue';
151:       case 'low':
152:         return 'green';
153:       default:
154:         return 'default';
155:     }
156:   }
157: 
158:   createTask(): void {
159:     this.router.navigate(['/tasks/create']);
160:   }
161: 
162:   viewTask(id: string): void {
163:     this.router.navigate(['/tasks', id]);
164:   }
165: }
````

## File: src/app/routes/tasks/detail-shell/task-detail-shell.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: interface Checklist {
 5:   readonly content: string;
 6:   readonly done: boolean;
 7: }
 8: 
 9: @Component({
10:   selector: 'app-task-detail-shell',
11:   standalone: true,
12:   imports: [SHARED_IMPORTS],
13:   template: `
14:     <nz-page-header [nzTitle]="'ä»»å‹™è©³æƒ…éª¨æ¶'" [nzSubtitle]="'å¿«é€Ÿå°ç…§ UI'">
15:       <nz-page-header-extra>
16:         <button nz-button nzType="default">
17:           <span nz-icon nzType="schedule"></span>
18:           æ’ç¨‹
19:         </button>
20:         <button nz-button nzType="primary">
21:           <span nz-icon nzType="team"></span>
22:           æŒ‡æ´¾
23:         </button>
24:       </nz-page-header-extra>
25:     </nz-page-header>
26: 
27:     <div class="page-section">
28:       <nz-card nzTitle="ä»»å‹™ Metadata">
29:         <nz-descriptions nzBordered [nzColumn]="{ xxl: 3, xl: 2, lg: 2, md: 2, sm: 1, xs: 1 }">
30:           <nz-descriptions-item nzTitle="åç¨±">ç¤ºæ„ä»»å‹™</nz-descriptions-item>
31:           <nz-descriptions-item nzTitle="ç‹€æ…‹">
32:             <nz-tag nzColor="processing">é€²è¡Œä¸­</nz-tag>
33:           </nz-descriptions-item>
34:           <nz-descriptions-item nzTitle="è² è²¬äºº">Task Bot</nz-descriptions-item>
35:           <nz-descriptions-item nzTitle="é–‹å§‹æ™‚é–“">2025-11-14</nz-descriptions-item>
36:         </nz-descriptions>
37:       </nz-card>
38: 
39:       <nz-card nzTitle="Checklist">
40:         <nz-timeline>
41:           @for (item of checklist; track item.content) {
42:             <nz-timeline-item [nzColor]="item.done ? 'green' : 'gray'">
43:               {{ item.content }}
44:             </nz-timeline-item>
45:           }
46:         </nz-timeline>
47:       </nz-card>
48:     </div>
49:   `,
50:   styles: [
51:     `
52:       :host {
53:         display: block;
54:       }
55: 
56:       .page-section {
57:         padding: 16px;
58:         display: flex;
59:         flex-direction: column;
60:         gap: 16px;
61:       }
62:     `
63:   ],
64:   changeDetection: ChangeDetectionStrategy.OnPush
65: })
66: export class TaskDetailShellComponent {
67:   protected readonly checklist: Checklist[] = [
68:     { content: 'ç¢ºèªéœ€æ±‚', done: true },
69:     { content: 'å®Œæˆè¨­è¨ˆ', done: false },
70:     { content: 'å®‰æ’æ¸¬è©¦', done: false }
71:   ];
72: }
````

## File: src/app/routes/tasks/detail/task-detail.component.ts
````typescript
  1: import { Component, OnInit, inject, signal, computed } from '@angular/core';
  2: import { ActivatedRoute, Router } from '@angular/router';
  3: import { SHARED_IMPORTS, TaskService, TaskDetail, TaskStatus, TaskType, TaskPriority } from '@shared';
  4: import { NzMessageService } from 'ng-zorro-antd/message';
  5: 
  6: @Component({
  7:   selector: 'app-task-detail',
  8:   standalone: true,
  9:   imports: [SHARED_IMPORTS],
 10:   template: `
 11:     <page-header [title]="taskDetail() ? taskDetail()!.title : 'ä»»åŠ¡è¯¦æƒ…'">
 12:       <ng-template #extra>
 13:         <button nz-button (click)="edit()" [disabled]="!taskDetail()">
 14:           <span nz-icon nzType="edit"></span>
 15:           ç¼–è¾‘
 16:         </button>
 17:         <button nz-button nzType="default" (click)="goBack()" style="margin-left: 8px;">
 18:           <span nz-icon nzType="arrow-left"></span>
 19:           è¿”å›
 20:         </button>
 21:       </ng-template>
 22:     </page-header>
 23: 
 24:     <nz-card style="margin-top: 16px;">
 25:       @if (taskService.loading()) {
 26:         <div style="text-align: center; padding: 40px;">
 27:           <nz-spin nzSize="large"></nz-spin>
 28:         </div>
 29:       } @else if (taskService.error()) {
 30:         <nz-alert [nzMessage]="taskService.error()" nzType="error" [nzShowIcon]="true" style="margin-bottom: 16px;"></nz-alert>
 31:         <button nz-button nzType="primary" (click)="loadTask()">é‡æ–°åŠ è½½</button>
 32:       } @else if (!taskDetail()) {
 33:         <nz-empty nzNotFoundContent="ä»»åŠ¡ä¸å­˜åœ¨"></nz-empty>
 34:       } @else {
 35:         <sv-container [col]="2" [gutter]="16">
 36:           <sv label="ä»»åŠ¡ID">{{ taskDetail()!.id }}</sv>
 37:           <sv label="æ ‡é¢˜">{{ taskDetail()!.title }}</sv>
 38:           <sv label="ç±»å‹">
 39:             @switch (taskDetail()!.task_type) {
 40:               @case ('milestone') {
 41:                 <nz-tag nzColor="purple">é‡Œç¨‹ç¢‘</nz-tag>
 42:               }
 43:               @case ('phase') {
 44:                 <nz-tag nzColor="blue">é˜¶æ®µ</nz-tag>
 45:               }
 46:               @case ('task') {
 47:                 <nz-tag nzColor="cyan">ä»»åŠ¡</nz-tag>
 48:               }
 49:               @case ('subtask') {
 50:                 <nz-tag nzColor="default">å­ä»»åŠ¡</nz-tag>
 51:               }
 52:             }
 53:           </sv>
 54:           <sv label="çŠ¶æ€">
 55:             @switch (taskDetail()!.status) {
 56:               @case ('pending') {
 57:                 <nz-tag nzColor="default">å¾…å¤„ç†</nz-tag>
 58:               }
 59:               @case ('assigned') {
 60:                 <nz-tag nzColor="blue">å·²æŒ‡æ´¾</nz-tag>
 61:               }
 62:               @case ('in_progress') {
 63:                 <nz-tag nzColor="processing">è¿›è¡Œä¸­</nz-tag>
 64:               }
 65:               @case ('staging') {
 66:                 <nz-tag nzColor="orange">æš‚å­˜ä¸­</nz-tag>
 67:               }
 68:               @case ('in_qa') {
 69:                 <nz-tag nzColor="gold">å“ç®¡ä¸­</nz-tag>
 70:               }
 71:               @case ('in_inspection') {
 72:                 <nz-tag nzColor="lime">éªŒæ”¶ä¸­</nz-tag>
 73:               }
 74:               @case ('completed') {
 75:                 <nz-tag nzColor="success">å·²å®Œæˆ</nz-tag>
 76:               }
 77:               @case ('cancelled') {
 78:                 <nz-tag nzColor="error">å·²å–æ¶ˆ</nz-tag>
 79:               }
 80:             }
 81:           </sv>
 82:           <sv label="ä¼˜å…ˆçº§">
 83:             @switch (taskDetail()!.priority) {
 84:               @case ('low') {
 85:                 <nz-tag nzColor="default">ä½</nz-tag>
 86:               }
 87:               @case ('medium') {
 88:                 <nz-tag nzColor="blue">ä¸­</nz-tag>
 89:               }
 90:               @case ('high') {
 91:                 <nz-tag nzColor="orange">é«˜</nz-tag>
 92:               }
 93:               @case ('urgent') {
 94:                 <nz-tag nzColor="red">ç´§æ€¥</nz-tag>
 95:               }
 96:             }
 97:           </sv>
 98:           <sv label="è¿›åº¦">
 99:             <nz-progress
100:               [nzPercent]="taskDetail()!.progress_percentage || 0"
101:               [nzStatus]="taskDetail()!.progress_percentage === 100 ? 'success' : 'active'"
102:             ></nz-progress>
103:           </sv>
104:           <sv label="è®¡åˆ’å¼€å§‹æ—¥æœŸ">
105:             {{ taskDetail()!.planned_start_date | date: 'yyyy-MM-dd' }}
106:           </sv>
107:           <sv label="è®¡åˆ’ç»“æŸæ—¥æœŸ">
108:             {{ taskDetail()!.planned_end_date | date: 'yyyy-MM-dd' }}
109:           </sv>
110:           <sv label="å®é™…å¼€å§‹æ—¥æœŸ">
111:             {{ taskDetail()!.actual_start_date ? (taskDetail()!.actual_start_date | date: 'yyyy-MM-dd') : '-' }}
112:           </sv>
113:           <sv label="å®é™…ç»“æŸæ—¥æœŸ">
114:             {{ taskDetail()!.actual_end_date ? (taskDetail()!.actual_end_date | date: 'yyyy-MM-dd') : '-' }}
115:           </sv>
116:           <sv label="æè¿°" [col]="2">
117:             {{ taskDetail()!.description || '-' }}
118:           </sv>
119:           <sv label="åˆ›å»ºæ—¶é—´" [col]="2">
120:             {{ taskDetail()!.created_at | date: 'yyyy-MM-dd HH:mm:ss' }}
121:           </sv>
122:           <sv label="æ›´æ–°æ—¶é—´" [col]="2">
123:             {{ taskDetail()!.updated_at | date: 'yyyy-MM-dd HH:mm:ss' }}
124:           </sv>
125:         </sv-container>
126: 
127:         @if (taskDetail()!.assignments && taskDetail()!.assignments!.length > 0) {
128:           <nz-divider nzText="ä»»åŠ¡åˆ†é…"></nz-divider>
129:           <nz-table [nzData]="taskDetail()!.assignments || []" [nzShowPagination]="false" [nzSize]="'small'">
130:             <thead>
131:               <tr>
132:                 <th>æŒ‡æ´¾å¯¹è±¡</th>
133:                 <th>æŒ‡æ´¾ç±»å‹</th>
134:                 <th>æŒ‡æ´¾æ—¶é—´</th>
135:               </tr>
136:             </thead>
137:             <tbody>
138:               @for (assignment of taskDetail()!.assignments; track assignment.id) {
139:                 <tr>
140:                   <td>{{ assignment.assignee_id }}</td>
141:                   <td>{{ assignment.assignee_type }}</td>
142:                   <td>{{ assignment.assigned_at | date: 'yyyy-MM-dd HH:mm:ss' }}</td>
143:                 </tr>
144:               }
145:             </tbody>
146:           </nz-table>
147:         }
148: 
149:         @if (taskDetail()!.children && taskDetail()!.children!.length > 0) {
150:           <nz-divider nzText="å­ä»»åŠ¡"></nz-divider>
151:           <nz-table [nzData]="taskDetail()!.children || []" [nzShowPagination]="false" [nzSize]="'small'">
152:             <thead>
153:               <tr>
154:                 <th>æ ‡é¢˜</th>
155:                 <th>çŠ¶æ€</th>
156:                 <th>è¿›åº¦</th>
157:                 <th>æ“ä½œ</th>
158:               </tr>
159:             </thead>
160:             <tbody>
161:               @for (child of taskDetail()!.children; track child.id) {
162:                 <tr>
163:                   <td>{{ child.title }}</td>
164:                   <td>
165:                     @switch (child.status) {
166:                       @case ('pending') {
167:                         <nz-tag nzColor="default">å¾…å¤„ç†</nz-tag>
168:                       }
169:                       @case ('in_progress') {
170:                         <nz-tag nzColor="processing">è¿›è¡Œä¸­</nz-tag>
171:                       }
172:                       @case ('completed') {
173:                         <nz-tag nzColor="success">å·²å®Œæˆ</nz-tag>
174:                       }
175:                       @default {
176:                         <nz-tag>{{ child.status }}</nz-tag>
177:                       }
178:                     }
179:                   </td>
180:                   <td>{{ child.progress_percentage || 0 }}%</td>
181:                   <td>
182:                     <button nz-button nzType="link" nzSize="small" (click)="viewChildTask(child.id)"> æŸ¥çœ‹ </button>
183:                   </td>
184:                 </tr>
185:               }
186:             </tbody>
187:           </nz-table>
188:         }
189:       }
190:     </nz-card>
191:   `
192: })
193: export class TaskDetailComponent implements OnInit {
194:   readonly taskService = inject(TaskService);
195:   private readonly route = inject(ActivatedRoute);
196:   private readonly router = inject(Router);
197:   private readonly message = inject(NzMessageService);
198: 
199:   readonly taskDetail = signal<TaskDetail | null>(null);
200:   readonly taskId = signal<string>('');
201: 
202:   ngOnInit(): void {
203:     const id = this.route.snapshot.paramMap.get('id');
204:     if (!id) {
205:       this.message.error('ä»»åŠ¡IDä¸å­˜åœ¨');
206:       this.router.navigate(['/tasks']);
207:       return;
208:     }
209:     this.taskId.set(id);
210:     this.loadTask();
211:   }
212: 
213:   async loadTask(): Promise<void> {
214:     const id = this.taskId();
215:     if (!id) return;
216: 
217:     try {
218:       const detail = await this.taskService.loadTaskById(id);
219:       this.taskDetail.set(detail);
220:     } catch (error) {
221:       this.message.error('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥');
222:     }
223:   }
224: 
225:   edit(): void {
226:     this.router.navigate(['/tasks', this.taskId(), 'edit']);
227:   }
228: 
229:   goBack(): void {
230:     this.router.navigate(['/tasks/list']);
231:   }
232: 
233:   viewChildTask(id: string): void {
234:     this.router.navigate(['/tasks', id]);
235:   }
236: }
````

## File: src/app/routes/tasks/form-hub/task-form-hub.component.ts
````typescript
 1: import { ChangeDetectionStrategy, Component } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-task-form-hub',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   template: `
 9:     <nz-page-header [nzTitle]="'ä»»å‹™å»ºç«‹éª¨æ¶'" [nzSubtitle]="'ä»¥ ng-zorro è¡¨å–®å‘ˆç¾'">
10:       <nz-page-header-extra>
11:         <button nz-button nzType="default">
12:           <span nz-icon nzType="copy"></span>
13:           å¥—ç”¨æ¨¡æ¿
14:         </button>
15:         <button nz-button nzType="primary">
16:           <span nz-icon nzType="send"></span>
17:           é€å‡º
18:         </button>
19:       </nz-page-header-extra>
20:     </nz-page-header>
21: 
22:     <div class="page-section">
23:       <form nz-form nzLayout="vertical" class="form-layout">
24:         <nz-form-item>
25:           <nz-form-label>ä»»å‹™åç¨±</nz-form-label>
26:           <nz-form-control>
27:             <input nz-input placeholder="è¼¸å…¥ä»»å‹™åç¨±" />
28:           </nz-form-control>
29:         </nz-form-item>
30: 
31:         <nz-form-item>
32:           <nz-form-label>è² è²¬äºº</nz-form-label>
33:           <nz-form-control>
34:             <nz-select nzShowSearch nzPlaceHolder="é¸æ“‡æˆå“¡">
35:               <nz-option nzValue="alice" nzLabel="Alice"></nz-option>
36:               <nz-option nzValue="bob" nzLabel="Bob"></nz-option>
37:             </nz-select>
38:           </nz-form-control>
39:         </nz-form-item>
40: 
41:         <nz-form-item>
42:           <nz-form-label>æ™‚é–“ç¯„åœ</nz-form-label>
43:           <nz-form-control>
44:             <nz-range-picker></nz-range-picker>
45:           </nz-form-control>
46:         </nz-form-item>
47: 
48:         <nz-form-item>
49:           <nz-form-label>æè¿°</nz-form-label>
50:           <nz-form-control>
51:             <textarea nz-input rows="4" placeholder="æè¿°å…§å®¹"></textarea>
52:           </nz-form-control>
53:         </nz-form-item>
54:       </form>
55:     </div>
56:   `,
57:   styles: [
58:     `
59:       :host {
60:         display: block;
61:       }
62: 
63:       .page-section {
64:         padding: 16px;
65:       }
66: 
67:       .form-layout {
68:         max-width: 600px;
69:       }
70:     `
71:   ],
72:   changeDetection: ChangeDetectionStrategy.OnPush
73: })
74: export class TaskFormHubComponent {}
````

## File: src/app/routes/tasks/form/task-form.component.ts
````typescript
  1: import { Component, OnInit, inject, signal } from '@angular/core';
  2: import { FormBuilder, FormGroup, Validators } from '@angular/forms';
  3: import { ActivatedRoute, Router } from '@angular/router';
  4: import { SHARED_IMPORTS, TaskService, TaskInsert, TaskUpdate, TaskType, TaskStatus, TaskPriority, BlueprintService } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: 
  7: @Component({
  8:   selector: 'app-task-form',
  9:   standalone: true,
 10:   imports: [SHARED_IMPORTS],
 11:   template: `
 12:     <page-header [title]="isEdit() ? 'ç¼–è¾‘ä»»åŠ¡' : 'æ–°å»ºä»»åŠ¡'">
 13:       <ng-template #extra>
 14:         <button nz-button nzType="default" (click)="cancel()">
 15:           <span nz-icon nzType="close"></span>
 16:           å–æ¶ˆ
 17:         </button>
 18:         <button nz-button nzType="primary" (click)="submit()" [nzLoading]="taskService.loading()" style="margin-left: 8px;">
 19:           <span nz-icon nzType="check"></span>
 20:           {{ isEdit() ? 'ä¿å­˜' : 'åˆ›å»º' }}
 21:         </button>
 22:       </ng-template>
 23:     </page-header>
 24: 
 25:     <nz-card style="margin-top: 16px;">
 26:       @if (taskService.loading() && isEdit()) {
 27:         <div style="text-align: center; padding: 40px;">
 28:           <nz-spin nzSize="large"></nz-spin>
 29:         </div>
 30:       } @else {
 31:         <form nz-form [formGroup]="form" (ngSubmit)="submit()">
 32:           <nz-form-item>
 33:             <nz-form-label [nzSpan]="4" nzRequired>è“å›¾</nz-form-label>
 34:             <nz-form-control [nzSpan]="20" nzErrorTip="è¯·é€‰æ‹©è“å›¾">
 35:               <nz-select formControlName="blueprintId" nzPlaceHolder="è¯·é€‰æ‹©è“å›¾">
 36:                 @for (blueprint of blueprintService.blueprints(); track blueprint.id) {
 37:                   <nz-option [nzValue]="blueprint.id" [nzLabel]="blueprint.name"></nz-option>
 38:                 }
 39:               </nz-select>
 40:             </nz-form-control>
 41:           </nz-form-item>
 42: 
 43:           <nz-form-item>
 44:             <nz-form-label [nzSpan]="4" nzRequired>æ ‡é¢˜</nz-form-label>
 45:             <nz-form-control [nzSpan]="20" nzErrorTip="è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜">
 46:               <input nz-input formControlName="title" placeholder="è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜" />
 47:             </nz-form-control>
 48:           </nz-form-item>
 49: 
 50:           <nz-form-item>
 51:             <nz-form-label [nzSpan]="4">æè¿°</nz-form-label>
 52:             <nz-form-control [nzSpan]="20">
 53:               <textarea
 54:                 nz-input
 55:                 formControlName="description"
 56:                 [nzAutosize]="{ minRows: 3, maxRows: 6 }"
 57:                 placeholder="è¯·è¾“å…¥ä»»åŠ¡æè¿°"
 58:               ></textarea>
 59:             </nz-form-control>
 60:           </nz-form-item>
 61: 
 62:           <nz-form-item>
 63:             <nz-form-label [nzSpan]="4" nzRequired>ä»»åŠ¡ç±»å‹</nz-form-label>
 64:             <nz-form-control [nzSpan]="20" nzErrorTip="è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹">
 65:               <nz-select formControlName="taskType" nzPlaceHolder="è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹">
 66:                 <nz-option [nzValue]="'milestone'" nzLabel="é‡Œç¨‹ç¢‘"></nz-option>
 67:                 <nz-option [nzValue]="'phase'" nzLabel="é˜¶æ®µ"></nz-option>
 68:                 <nz-option [nzValue]="'task'" nzLabel="ä»»åŠ¡"></nz-option>
 69:                 <nz-option [nzValue]="'subtask'" nzLabel="å­ä»»åŠ¡"></nz-option>
 70:               </nz-select>
 71:             </nz-form-control>
 72:           </nz-form-item>
 73: 
 74:           <nz-form-item>
 75:             <nz-form-label [nzSpan]="4" nzRequired>çŠ¶æ€</nz-form-label>
 76:             <nz-form-control [nzSpan]="20" nzErrorTip="è¯·é€‰æ‹©çŠ¶æ€">
 77:               <nz-select formControlName="status" nzPlaceHolder="è¯·é€‰æ‹©çŠ¶æ€">
 78:                 <nz-option [nzValue]="'pending'" nzLabel="å¾…å¤„ç†"></nz-option>
 79:                 <nz-option [nzValue]="'assigned'" nzLabel="å·²æŒ‡æ´¾"></nz-option>
 80:                 <nz-option [nzValue]="'in_progress'" nzLabel="è¿›è¡Œä¸­"></nz-option>
 81:               </nz-select>
 82:             </nz-form-control>
 83:           </nz-form-item>
 84: 
 85:           <nz-form-item>
 86:             <nz-form-label [nzSpan]="4" nzRequired>ä¼˜å…ˆçº§</nz-form-label>
 87:             <nz-form-control [nzSpan]="20" nzErrorTip="è¯·é€‰æ‹©ä¼˜å…ˆçº§">
 88:               <nz-select formControlName="priority" nzPlaceHolder="è¯·é€‰æ‹©ä¼˜å…ˆçº§">
 89:                 <nz-option [nzValue]="'low'" nzLabel="ä½"></nz-option>
 90:                 <nz-option [nzValue]="'medium'" nzLabel="ä¸­"></nz-option>
 91:                 <nz-option [nzValue]="'high'" nzLabel="é«˜"></nz-option>
 92:                 <nz-option [nzValue]="'urgent'" nzLabel="ç´§æ€¥"></nz-option>
 93:               </nz-select>
 94:             </nz-form-control>
 95:           </nz-form-item>
 96: 
 97:           <nz-form-item>
 98:             <nz-form-label [nzSpan]="4">è®¡åˆ’å¼€å§‹æ—¥æœŸ</nz-form-label>
 99:             <nz-form-control [nzSpan]="20">
100:               <nz-date-picker formControlName="plannedStartDate" nzFormat="yyyy-MM-dd" style="width: 100%;"></nz-date-picker>
101:             </nz-form-control>
102:           </nz-form-item>
103: 
104:           <nz-form-item>
105:             <nz-form-label [nzSpan]="4">è®¡åˆ’ç»“æŸæ—¥æœŸ</nz-form-label>
106:             <nz-form-control [nzSpan]="20">
107:               <nz-date-picker formControlName="plannedEndDate" nzFormat="yyyy-MM-dd" style="width: 100%;"></nz-date-picker>
108:             </nz-form-control>
109:           </nz-form-item>
110: 
111:           <nz-form-item>
112:             <nz-form-label [nzSpan]="4">è¿›åº¦ (%)</nz-form-label>
113:             <nz-form-control [nzSpan]="20">
114:               <nz-input-number
115:                 formControlName="progressPercentage"
116:                 [nzMin]="0"
117:                 [nzMax]="100"
118:                 [nzStep]="1"
119:                 style="width: 100%;"
120:               ></nz-input-number>
121:             </nz-form-control>
122:           </nz-form-item>
123:         </form>
124:       }
125:     </nz-card>
126:   `
127: })
128: export class TaskFormComponent implements OnInit {
129:   readonly taskService = inject(TaskService);
130:   readonly blueprintService = inject(BlueprintService);
131:   private readonly route = inject(ActivatedRoute);
132:   private readonly router = inject(Router);
133:   private readonly message = inject(NzMessageService);
134:   private readonly fb = inject(FormBuilder);
135: 
136:   readonly isEdit = signal<boolean>(false);
137:   readonly taskId = signal<string>('');
138:   form!: FormGroup;
139: 
140:   ngOnInit(): void {
141:     const id = this.route.snapshot.paramMap.get('id');
142:     this.isEdit.set(!!id);
143:     if (id) {
144:       this.taskId.set(id);
145:     }
146: 
147:     this.initForm();
148:     this.loadBlueprints();
149: 
150:     if (this.isEdit()) {
151:       this.loadTask();
152:     }
153:   }
154: 
155:   initForm(): void {
156:     this.form = this.fb.group({
157:       blueprintId: [null, [Validators.required]],
158:       title: ['', [Validators.required]],
159:       description: [''],
160:       taskType: ['task', [Validators.required]],
161:       status: ['pending', [Validators.required]],
162:       priority: ['medium', [Validators.required]],
163:       plannedStartDate: [null],
164:       plannedEndDate: [null],
165:       progressPercentage: [0]
166:     });
167:   }
168: 
169:   async loadBlueprints(): Promise<void> {
170:     try {
171:       await this.blueprintService.loadBlueprints();
172:     } catch (error) {
173:       this.message.error('åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
174:     }
175:   }
176: 
177:   async loadTask(): Promise<void> {
178:     const id = this.taskId();
179:     if (!id) return;
180: 
181:     try {
182:       const detail = await this.taskService.loadTaskById(id);
183:       if (detail) {
184:         this.form.patchValue({
185:           blueprintId: detail.blueprint_id,
186:           title: detail.title,
187:           description: detail.description || '',
188:           taskType: detail.task_type,
189:           status: detail.status,
190:           priority: detail.priority,
191:           plannedStartDate: detail.planned_start_date ? new Date(detail.planned_start_date) : null,
192:           plannedEndDate: detail.planned_end_date ? new Date(detail.planned_end_date) : null,
193:           progressPercentage: detail.progress_percentage || 0
194:         });
195:       }
196:     } catch (error) {
197:       this.message.error('åŠ è½½ä»»åŠ¡å¤±è´¥');
198:     }
199:   }
200: 
201:   async submit(): Promise<void> {
202:     if (this.form.invalid) {
203:       Object.values(this.form.controls).forEach(control => {
204:         if (control.invalid) {
205:           control.markAsDirty();
206:           control.updateValueAndValidity({ onlySelf: true });
207:         }
208:       });
209:       return;
210:     }
211: 
212:     const formValue = this.form.value;
213:     const taskData: TaskInsert | TaskUpdate = {
214:       blueprint_id: formValue.blueprintId,
215:       title: formValue.title,
216:       description: formValue.description || null,
217:       task_type: formValue.taskType,
218:       status: formValue.status,
219:       priority: formValue.priority,
220:       planned_start_date: formValue.plannedStartDate ? formValue.plannedStartDate.toISOString() : null,
221:       planned_end_date: formValue.plannedEndDate ? formValue.plannedEndDate.toISOString() : null,
222:       progress_percentage: formValue.progressPercentage || 0
223:     };
224: 
225:     try {
226:       if (this.isEdit()) {
227:         await this.taskService.updateTask(this.taskId(), taskData as TaskUpdate);
228:         this.message.success('ä»»åŠ¡æ›´æ–°æˆåŠŸ');
229:       } else {
230:         await this.taskService.createTask(taskData as TaskInsert);
231:         this.message.success('ä»»åŠ¡åˆ›å»ºæˆåŠŸ');
232:       }
233:       this.router.navigate(['/tasks/list']);
234:     } catch (error) {
235:       this.message.error(this.isEdit() ? 'ä»»åŠ¡æ›´æ–°å¤±è´¥' : 'ä»»åŠ¡åˆ›å»ºå¤±è´¥');
236:     }
237:   }
238: 
239:   cancel(): void {
240:     this.router.navigate(['/tasks/list']);
241:   }
242: }
````

## File: src/app/routes/tasks/todo/task-todo.component.ts
````typescript
  1: import { Component, OnInit, inject, signal, computed } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { TaskAssignmentRepository } from '@core';
  4: import { STColumn } from '@delon/abc/st';
  5: import { SHARED_IMPORTS, TaskService, Task, TaskStatus, BlueprintService } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: import { firstValueFrom } from 'rxjs';
  8: 
  9: @Component({
 10:   selector: 'app-task-todo',
 11:   standalone: true,
 12:   imports: [SHARED_IMPORTS],
 13:   template: `
 14:     <page-header [title]="'å¾…åŠåˆ—è¡¨'">
 15:       <ng-template #extra>
 16:         <nz-select
 17:           [ngModel]="selectedBlueprintId()"
 18:           (ngModelChange)="selectedBlueprintId.set($event); onBlueprintChange()"
 19:           nzPlaceHolder="è¯·é€‰æ‹©è“å›¾"
 20:           style="width: 300px; margin-right: 8px;"
 21:         >
 22:           @for (blueprint of blueprintService.blueprints(); track blueprint.id) {
 23:             <nz-option [nzValue]="blueprint.id" [nzLabel]="blueprint.name"></nz-option>
 24:           }
 25:         </nz-select>
 26:       </ng-template>
 27:     </page-header>
 28: 
 29:     <nz-card style="margin-top: 16px;">
 30:       @if (!selectedBlueprintId()) {
 31:         <nz-empty nzNotFoundContent="è¯·å…ˆé€‰æ‹©è“å›¾"></nz-empty>
 32:       } @else if (taskService.loading()) {
 33:         <div style="text-align: center; padding: 40px;">
 34:           <nz-spin nzSize="large"></nz-spin>
 35:         </div>
 36:       } @else {
 37:         <st
 38:           #st
 39:           [data]="todoTasks()"
 40:           [columns]="columns"
 41:           [loading]="taskService.loading()"
 42:           [page]="{ front: false, show: true, showSize: true }"
 43:         >
 44:           <ng-template #status let-record>
 45:             @switch (record.status) {
 46:               @case ('pending') {
 47:                 <nz-tag nzColor="default">å¾…å¤„ç†</nz-tag>
 48:               }
 49:               @case ('assigned') {
 50:                 <nz-tag nzColor="blue">å·²æŒ‡æ´¾</nz-tag>
 51:               }
 52:               @case ('in_progress') {
 53:                 <nz-tag nzColor="processing">è¿›è¡Œä¸­</nz-tag>
 54:               }
 55:               @case ('staging') {
 56:                 <nz-tag nzColor="orange">æš‚å­˜ä¸­</nz-tag>
 57:               }
 58:               @case ('in_qa') {
 59:                 <nz-tag nzColor="gold">å“ç®¡ä¸­</nz-tag>
 60:               }
 61:               @case ('in_inspection') {
 62:                 <nz-tag nzColor="lime">éªŒæ”¶ä¸­</nz-tag>
 63:               }
 64:               @case ('completed') {
 65:                 <nz-tag nzColor="success">å·²å®Œæˆ</nz-tag>
 66:               }
 67:               @case ('cancelled') {
 68:                 <nz-tag nzColor="error">å·²å–æ¶ˆ</nz-tag>
 69:               }
 70:             }
 71:           </ng-template>
 72: 
 73:           <ng-template #priority let-record>
 74:             @switch (record.priority) {
 75:               @case ('low') {
 76:                 <nz-tag nzColor="default">ä½</nz-tag>
 77:               }
 78:               @case ('medium') {
 79:                 <nz-tag nzColor="blue">ä¸­</nz-tag>
 80:               }
 81:               @case ('high') {
 82:                 <nz-tag nzColor="orange">é«˜</nz-tag>
 83:               }
 84:               @case ('urgent') {
 85:                 <nz-tag nzColor="red">ç´§æ€¥</nz-tag>
 86:               }
 87:             }
 88:           </ng-template>
 89:         </st>
 90:       }
 91:     </nz-card>
 92:   `
 93: })
 94: export class TaskTodoComponent implements OnInit {
 95:   readonly taskService = inject(TaskService);
 96:   readonly blueprintService = inject(BlueprintService);
 97:   private readonly taskAssignmentRepository = inject(TaskAssignmentRepository);
 98:   private readonly router = inject(Router);
 99:   private readonly message = inject(NzMessageService);
100: 
101:   readonly selectedBlueprintId = signal<string | null>(null);
102:   readonly currentUserId = signal<string>('current-user-id'); // TODO: ä»è®¤è¯æœåŠ¡è·å–
103: 
104:   readonly todoTasks = computed(() => {
105:     const tasks = this.taskService.tasks();
106:     // è¿‡æ»¤å‡ºå¾…åŠä»»åŠ¡ï¼ˆå¾…å¤„ç†ã€å·²æŒ‡æ´¾ã€è¿›è¡Œä¸­ï¼‰
107:     return tasks.filter(
108:       task => task.status === TaskStatus.PENDING || task.status === TaskStatus.ASSIGNED || task.status === TaskStatus.IN_PROGRESS
109:     );
110:   });
111: 
112:   columns: STColumn[] = [
113:     { title: 'ID', index: 'id', width: 100 },
114:     { title: 'æ ‡é¢˜', index: 'title', width: 250 },
115:     { title: 'çŠ¶æ€', index: 'status', width: 100, render: 'status' },
116:     { title: 'ä¼˜å…ˆçº§', index: 'priority', width: 100, render: 'priority' },
117:     { title: 'è®¡åˆ’å¼€å§‹', index: 'planned_start_date', type: 'date', width: 120 },
118:     { title: 'è®¡åˆ’ç»“æŸ', index: 'planned_end_date', type: 'date', width: 120 },
119:     { title: 'è¿›åº¦', index: 'progress_percentage', width: 100, format: (item: Task) => `${item.progress_percentage || 0}%` },
120:     {
121:       title: 'æ“ä½œ',
122:       width: 150,
123:       buttons: [
124:         {
125:           text: 'æŸ¥çœ‹',
126:           click: (record: Task) => this.viewTask(record.id)
127:         }
128:       ]
129:     }
130:   ];
131: 
132:   ngOnInit(): void {
133:     this.loadBlueprints();
134:   }
135: 
136:   async loadBlueprints(): Promise<void> {
137:     try {
138:       await this.blueprintService.loadBlueprints();
139:     } catch (error) {
140:       this.message.error('åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
141:     }
142:   }
143: 
144:   async onBlueprintChange(): Promise<void> {
145:     const blueprintId = this.selectedBlueprintId();
146:     if (blueprintId) {
147:       try {
148:         await this.taskService.loadTasksByBlueprint(blueprintId);
149:       } catch (error) {
150:         this.message.error('åŠ è½½å¾…åŠåˆ—è¡¨å¤±è´¥');
151:       }
152:     }
153:   }
154: 
155:   viewTask(id: string): void {
156:     this.router.navigate(['/tasks', id]);
157:   }
158: }
````

## File: src/app/routes/tasks/weather/task-weather.component.ts
````typescript
 1: import { Component, OnInit, inject } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-task-weather',
 6:   standalone: true,
 7:   imports: [SHARED_IMPORTS],
 8:   template: `
 9:     <page-header [title]="'å¤©æ°”è®°å½•'"></page-header>
10: 
11:     <nz-card nzTitle="å¤©æ°”è®°å½•ç®¡ç†" style="margin-top: 16px;">
12:       <nz-alert
13:         nzType="info"
14:         nzMessage="å¤©æ°”è®°å½•åŠŸèƒ½å¼€å‘ä¸­"
15:         nzDescription="æ­¤é¡µé¢å°†ç”¨äºç®¡ç†å¤©æ°”è®°å½•ã€‚"
16:         [nzShowIcon]="true"
17:         style="margin-bottom: 16px;"
18:       ></nz-alert>
19: 
20:       <nz-empty nzNotFoundContent="åŠŸèƒ½å¼€å‘ä¸­"></nz-empty>
21:     </nz-card>
22:   `
23: })
24: export class TaskWeatherComponent implements OnInit {
25:   ngOnInit(): void {
26:     // TODO: åŠ è½½å¤©æ°”è®°å½•æ•°æ®
27:   }
28: }
````

## File: src/app/routes/widgets/routes.ts
````typescript
1: import { Routes } from '@angular/router';
2: 
3: import { WidgetsComponent } from './widgets/widgets.component';
4: 
5: export const routes: Routes = [{ path: '', component: WidgetsComponent }];
````

## File: src/app/routes/widgets/widgets/widgets.component.ts
````typescript
 1: import { ChangeDetectionStrategy, ChangeDetectorRef, Component, OnInit, inject } from '@angular/core';
 2: import { G2MiniAreaModule } from '@delon/chart/mini-area';
 3: import { G2MiniBarData, G2MiniBarModule } from '@delon/chart/mini-bar';
 4: import { _HttpClient } from '@delon/theme';
 5: import { SHARED_IMPORTS } from '@shared';
 6: import { NzCarouselModule } from 'ng-zorro-antd/carousel';
 7: import { NzMessageService } from 'ng-zorro-antd/message';
 8: 
 9: @Component({
10:   selector: 'app-widgets',
11:   templateUrl: './widgets.component.html',
12:   styleUrls: ['./widgets.component.less'],
13:   changeDetection: ChangeDetectionStrategy.OnPush,
14:   imports: [...SHARED_IMPORTS, NzCarouselModule, G2MiniBarModule, G2MiniAreaModule]
15: })
16: export class WidgetsComponent implements OnInit {
17:   readonly msg = inject(NzMessageService);
18:   private readonly http = inject(_HttpClient);
19:   private readonly cdr = inject(ChangeDetectorRef);
20: 
21:   data: G2MiniBarData[] = [];
22:   smallData: G2MiniBarData[] = [];
23:   todoData: Array<{ completed: boolean; avatar: string; name: string; content: string }> = [
24:     {
25:       completed: true,
26:       avatar: '1',
27:       name: 'è‹å…ˆç”Ÿ',
28:       content: `è¯·å‘Šè¯‰æˆ‘ï¼Œæˆ‘åº”è¯¥è¯´ç‚¹ä»€ä¹ˆå¥½ï¼Ÿ`
29:     },
30:     {
31:       completed: false,
32:       avatar: '2',
33:       name: 'ã¯ãªã•ã',
34:       content: `ãƒãƒ«ã‚«ã‚½ãƒ©ãƒˆã‚­ãƒ˜ãƒ€ãƒ„ãƒ’ã‚«ãƒª`
35:     },
36:     {
37:       completed: false,
38:       avatar: '3',
39:       name: 'cipchk',
40:       content: `this world was never meant for one as beautiful as you.`
41:     },
42:     {
43:       completed: false,
44:       avatar: '4',
45:       name: 'Kent',
46:       content: `my heart is beating with hers`
47:     },
48:     {
49:       completed: false,
50:       avatar: '5',
51:       name: 'Are you',
52:       content: `They always said that I love beautiful girl than my friends`
53:     },
54:     {
55:       completed: false,
56:       avatar: '6',
57:       name: 'Forever',
58:       content: `Walking through green fields ï¼Œsunshine in my eyes.`
59:     }
60:   ];
61:   like = false;
62:   dislike = false;
63: 
64:   ngOnInit(): void {
65:     this.http.get('/chart/visit').subscribe((res: G2MiniBarData[]) => {
66:       this.data = res;
67:       this.smallData = res.slice(0, 6);
68:       this.cdr.detectChanges();
69:     });
70:   }
71: }
````

## File: src/app/shared/cell-widget/index.ts
````typescript
1: import type { CellWidgetProvideConfig } from '@delon/abc/cell';
2: 
3: export const CELL_WIDGETS: CellWidgetProvideConfig[] = [];
````

## File: src/app/shared/components/account-selector/account-selector.component.ts
````typescript
  1: import { AfterViewInit, Component, computed, inject, input, OnInit, output, signal } from '@angular/core';
  2: import { ReactiveFormsModule } from '@angular/forms';
  3: import { AccountService, AccountType, SHARED_IMPORTS } from '@shared';
  4: 
  5: /**
  6:  * è´¦æˆ·é€‰æ‹©å™¨ç»„ä»¶
  7:  *
  8:  * ç”¨äºé€‰æ‹©è“å›¾æ‹¥æœ‰è€…ï¼ˆä¸ªäººè´¦æˆ·æˆ–ç»„ç»‡è´¦æˆ·ï¼‰
  9:  */
 10: @Component({
 11:   selector: 'app-account-selector',
 12:   standalone: true,
 13:   imports: [SHARED_IMPORTS, ReactiveFormsModule],
 14:   template: `
 15:     <nz-form-item>
 16:       <nz-form-label [nzSpan]="labelSpan()" [nzRequired]="required()">æ‹¥æœ‰è€…</nz-form-label>
 17:       <nz-form-control [nzSpan]="controlSpan()" [nzErrorTip]="errorTip()">
 18:         <!-- æ‹¥æœ‰è€…ç±»å‹é€‰æ‹© -->
 19:         <nz-radio-group [(ngModel)]="ownerType" (ngModelChange)="onOwnerTypeChange()" style="margin-bottom: 8px;">
 20:           <label nz-radio [nzValue]="'user'">
 21:             <span nz-icon nzType="user"></span>
 22:             ä¸ªäººè´¦æˆ·
 23:           </label>
 24:           <label nz-radio [nzValue]="'organization'">
 25:             <span nz-icon nzType="team"></span>
 26:             ç»„ç»‡è´¦æˆ·
 27:           </label>
 28:         </nz-radio-group>
 29: 
 30:         <!-- è´¦æˆ·é€‰æ‹©å™¨ -->
 31:         @if (ownerType() === 'user') {
 32:           <nz-select
 33:             [ngModel]="selectedAccountId()"
 34:             (ngModelChange)="onAccountChange($event)"
 35:             nzPlaceHolder="é€‰æ‹©ä¸ªäººè´¦æˆ·"
 36:             [nzLoading]="accountService.loading()"
 37:             style="width: 100%;"
 38:             [nzDisabled]="disabled()"
 39:           >
 40:             @for (account of userAccounts(); track account.id) {
 41:               <nz-option [nzValue]="account.id" [nzLabel]="account.name">
 42:                 <span>
 43:                   <span nz-icon nzType="user" style="margin-right: 4px;"></span>
 44:                   {{ account.name }}
 45:                   @if (account.email) {
 46:                     <span style="color: #999; margin-left: 8px;">({{ account.email }})</span>
 47:                   }
 48:                 </span>
 49:               </nz-option>
 50:             }
 51:           </nz-select>
 52:           @if (userAccounts().length === 0 && !accountService.loading()) {
 53:             <nz-alert
 54:               nzType="warning"
 55:               nzMessage="æœªæ‰¾åˆ°ä¸ªäººè´¦æˆ·"
 56:               nzDescription="è¯·å…ˆåˆ›å»ºä¸ªäººè´¦æˆ·æˆ–è”ç³»ç®¡ç†å‘˜"
 57:               nzShowIcon
 58:               style="margin-top: 8px;"
 59:             ></nz-alert>
 60:           }
 61:         } @else {
 62:           <nz-select
 63:             [ngModel]="selectedAccountId()"
 64:             (ngModelChange)="onAccountChange($event)"
 65:             nzPlaceHolder="é€‰æ‹©ç»„ç»‡è´¦æˆ·"
 66:             [nzLoading]="accountService.loading()"
 67:             style="width: 100%;"
 68:             [nzDisabled]="disabled()"
 69:           >
 70:             @for (org of organizationAccounts(); track org.id) {
 71:               <nz-option [nzValue]="org.id" [nzLabel]="org.name">
 72:                 <span>
 73:                   <span nz-icon nzType="team" style="margin-right: 4px;"></span>
 74:                   {{ org.name }}
 75:                 </span>
 76:               </nz-option>
 77:             }
 78:           </nz-select>
 79:           @if (organizationAccounts().length === 0 && !accountService.loading()) {
 80:             <nz-alert
 81:               nzType="info"
 82:               nzMessage="æœªæ‰¾åˆ°ç»„ç»‡è´¦æˆ·"
 83:               nzDescription="æ‚¨å¯ä»¥åˆ›å»ºç»„ç»‡è´¦æˆ·æˆ–é€‰æ‹©ä¸ªäººè´¦æˆ·ä½œä¸ºæ‹¥æœ‰è€…"
 84:               nzShowIcon
 85:               style="margin-top: 8px;"
 86:             ></nz-alert>
 87:           }
 88:         }
 89: 
 90:         <!-- å¸®åŠ©æ–‡æœ¬ -->
 91:         @if (helpText()) {
 92:           <div style="color: #999; font-size: 12px; margin-top: 4px;">
 93:             {{ helpText() }}
 94:           </div>
 95:         }
 96:       </nz-form-control>
 97:     </nz-form-item>
 98:   `
 99: })
100: export class AccountSelectorComponent implements OnInit, AfterViewInit {
101:   accountService = inject(AccountService);
102: 
103:   // Inputs
104:   labelSpan = input<number>(4);
105:   controlSpan = input<number>(20);
106:   required = input<boolean>(true);
107:   errorTip = input<string>('è¯·é€‰æ‹©æ‹¥æœ‰è€…');
108:   helpText = input<string | null>(null);
109:   disabled = input<boolean>(false);
110:   initialValue = input<string | null>(null);
111: 
112:   // Outputs
113:   readonly accountChange = output<string>();
114: 
115:   // Internal state
116:   ownerType = signal<'user' | 'organization'>('user');
117:   selectedAccountId = signal<string>('');
118: 
119:   // Computed
120:   userAccounts = computed(() => this.accountService.userAccounts());
121:   organizationAccounts = computed(() => this.accountService.organizationAccounts());
122: 
123:   async ngOnInit(): Promise<void> {
124:     // åŠ è½½è´¦æˆ·åˆ—è¡¨
125:     await this.accountService.loadAccounts();
126: 
127:     // å¦‚æœæœ‰åˆå§‹å€¼ï¼Œä½¿ç”¨åˆå§‹å€¼
128:     if (this.initialValue()) {
129:       const account = this.accountService.accounts().find(a => a.id === this.initialValue());
130:       if (account) {
131:         if (account.type === AccountType.USER) {
132:           this.ownerType.set('user');
133:         } else if (account.type === AccountType.ORGANIZATION) {
134:           this.ownerType.set('organization');
135:         }
136:         this.selectedAccountId.set(account.id);
137:         return;
138:       }
139:     }
140: 
141:     // è®¾ç½®é»˜è®¤å€¼ï¼ˆå»¶è¿Ÿåˆ°è§†å›¾åˆå§‹åŒ–åï¼‰
142:   }
143: 
144:   ngAfterViewInit(): void {
145:     // åœ¨è§†å›¾åˆå§‹åŒ–åè®¾ç½®é»˜è®¤å€¼ï¼Œç¡®ä¿çˆ¶ç»„ä»¶å·²å‡†å¤‡å¥½æ¥æ”¶äº‹ä»¶
146:     // ä½¿ç”¨æ›´é•¿çš„å»¶è¿Ÿï¼Œç¡®ä¿Angularå˜æ›´æ£€æµ‹å®Œæˆ
147:     setTimeout(() => {
148:       this.setDefaultValue();
149:     }, 100);
150:   }
151: 
152:   private async setDefaultValue(): Promise<void> {
153:     const userAccounts = this.userAccounts();
154:     const orgAccounts = this.organizationAccounts();
155: 
156:     // ä¼˜å…ˆé€‰æ‹©ä¸ªäººè´¦æˆ·
157:     if (userAccounts.length > 0) {
158:       this.ownerType.set('user');
159:       this.selectedAccountId.set(userAccounts[0].id);
160:       // å»¶è¿Ÿè§¦å‘äº‹ä»¶ï¼Œç¡®ä¿çˆ¶ç»„ä»¶å·²å‡†å¤‡å¥½
161:       setTimeout(() => {
162:         this.accountChange.emit(userAccounts[0].id);
163:       }, 0);
164:     }
165:     // å¦‚æœåªæœ‰ä¸€ä¸ªç»„ç»‡ï¼Œè‡ªåŠ¨é€‰æ‹©ç»„ç»‡
166:     else if (orgAccounts.length === 1) {
167:       this.ownerType.set('organization');
168:       this.selectedAccountId.set(orgAccounts[0].id);
169:       // å»¶è¿Ÿè§¦å‘äº‹ä»¶ï¼Œç¡®ä¿çˆ¶ç»„ä»¶å·²å‡†å¤‡å¥½
170:       setTimeout(() => {
171:         this.accountChange.emit(orgAccounts[0].id);
172:       }, 0);
173:     }
174:     // å¦‚æœæœ‰å¤šä¸ªç»„ç»‡ï¼Œé»˜è®¤é€‰æ‹©ç»„ç»‡ç±»å‹ï¼Œä½†ä¸è‡ªåŠ¨é€‰æ‹©
175:     else if (orgAccounts.length > 1) {
176:       this.ownerType.set('organization');
177:     }
178:   }
179: 
180:   onOwnerTypeChange(): void {
181:     // åˆ‡æ¢ç±»å‹æ—¶è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªè´¦æˆ·
182:     if (this.ownerType() === 'user') {
183:       const userAccounts = this.userAccounts();
184:       if (userAccounts.length > 0) {
185:         this.selectedAccountId.set(userAccounts[0].id);
186:         this.accountChange.emit(userAccounts[0].id);
187:       } else {
188:         this.selectedAccountId.set('');
189:         this.accountChange.emit('');
190:       }
191:     } else {
192:       const orgAccounts = this.organizationAccounts();
193:       if (orgAccounts.length > 0) {
194:         this.selectedAccountId.set(orgAccounts[0].id);
195:         this.accountChange.emit(orgAccounts[0].id);
196:       } else {
197:         this.selectedAccountId.set('');
198:         this.accountChange.emit('');
199:       }
200:     }
201:   }
202: 
203:   onAccountChange(accountId: string): void {
204:     this.selectedAccountId.set(accountId);
205:     this.accountChange.emit(accountId);
206:   }
207: 
208:   /**
209:    * è·å–å½“å‰é€‰ä¸­çš„è´¦æˆ·IDï¼ˆä¾›çˆ¶ç»„ä»¶ä½¿ç”¨ï¼‰
210:    */
211:   getSelectedAccountId(): string {
212:     return this.selectedAccountId();
213:   }
214: 
215:   /**
216:    * è®¾ç½®é€‰ä¸­çš„è´¦æˆ·IDï¼ˆä¾›çˆ¶ç»„ä»¶ä½¿ç”¨ï¼‰
217:    */
218:   setSelectedAccountId(accountId: string): void {
219:     const account = this.accountService.accounts().find(a => a.id === accountId);
220:     if (account) {
221:       if (account.type === AccountType.USER) {
222:         this.ownerType.set('user');
223:       } else if (account.type === AccountType.ORGANIZATION) {
224:         this.ownerType.set('organization');
225:       }
226:       this.selectedAccountId.set(accountId);
227:     }
228:   }
229: }
````

## File: src/app/shared/components/account-selector/index.ts
````typescript
1: export * from './account-selector.component';
````

## File: src/app/shared/json-schema/index.ts
````typescript
 1: import type { SFWidgetProvideConfig } from '@delon/form';
 2: // import { withCascaderWidget } from '@delon/form/widgets/cascader';
 3: 
 4: import { TestWidget } from './test/test.widget';
 5: 
 6: export const SF_WIDGETS: SFWidgetProvideConfig[] = [
 7:   { KEY: TestWidget.KEY, type: TestWidget }
 8:   // Non-built-in widget registration method
 9:   // withCascaderWidget()
10: ];
````

## File: src/app/shared/json-schema/test/test.widget.ts
````typescript
 1: import { ChangeDetectionStrategy, Component, OnInit } from '@angular/core';
 2: import { ControlWidget, DelonFormModule } from '@delon/form';
 3: 
 4: @Component({
 5:   selector: 'test',
 6:   template: `
 7:     <sf-item-wrap [id]="id" [schema]="schema" [ui]="ui" [showError]="showError" [error]="error" [showTitle]="schema.title">
 8:       test widget
 9:     </sf-item-wrap>
10:   `,
11:   preserveWhitespaces: false,
12:   changeDetection: ChangeDetectionStrategy.OnPush,
13:   imports: [DelonFormModule]
14: })
15: export class TestWidget extends ControlWidget implements OnInit {
16:   static readonly KEY = 'test';
17: 
18:   ngOnInit(): void {
19:     console.warn('init test widget');
20:   }
21: }
````

## File: src/app/shared/services/account/account.service.spec.ts
````typescript
  1: import { TestBed } from '@angular/core/testing';
  2: import { AccountRepository } from '@core';
  3: import { Account, AccountType, AccountStatus } from '@shared';
  4: import { of, throwError } from 'rxjs';
  5: 
  6: import { AccountService } from './account.service';
  7: 
  8: describe('AccountService', () => {
  9:   let service: AccountService;
 10:   let repository: jasmine.SpyObj<AccountRepository>;
 11: 
 12:   const mockAccount: Account = {
 13:     id: 'account-1',
 14:     auth_user_id: 'auth-user-1',
 15:     type: AccountType.USER,
 16:     name: 'Test User',
 17:     email: 'test@example.com',
 18:     avatar_url: null,
 19:     status: AccountStatus.ACTIVE,
 20:     metadata: {},
 21:     created_at: '2025-01-01T00:00:00Z',
 22:     updated_at: '2025-01-01T00:00:00Z'
 23:   } as Account;
 24: 
 25:   const mockAccounts: Account[] = [
 26:     mockAccount,
 27:     {
 28:       ...mockAccount,
 29:       id: 'account-2',
 30:       type: AccountType.ORGANIZATION,
 31:       name: 'Test Organization',
 32:       status: AccountStatus.INACTIVE
 33:     }
 34:   ];
 35: 
 36:   beforeEach(() => {
 37:     const repositorySpy = jasmine.createSpyObj('AccountRepository', [
 38:       'findAll',
 39:       'findById',
 40:       'findByType',
 41:       'findByStatus',
 42:       'findByAuthUserId',
 43:       'findByEmail',
 44:       'create',
 45:       'update',
 46:       'delete'
 47:     ]);
 48: 
 49:     TestBed.configureTestingModule({
 50:       providers: [AccountService, { provide: AccountRepository, useValue: repositorySpy }]
 51:     });
 52: 
 53:     service = TestBed.inject(AccountService);
 54:     repository = TestBed.inject(AccountRepository) as jasmine.SpyObj<AccountRepository>;
 55:   });
 56: 
 57:   it('should be created', () => {
 58:     expect(service).toBeTruthy();
 59:   });
 60: 
 61:   describe('Initial state', () => {
 62:     it('should have empty accounts', () => {
 63:       expect(service.accounts().length).toBe(0);
 64:     });
 65: 
 66:     it('should have null selected account', () => {
 67:       expect(service.selectedAccount()).toBeNull();
 68:     });
 69: 
 70:     it('should have false loading state', () => {
 71:       expect(service.loading()).toBe(false);
 72:     });
 73: 
 74:     it('should have null error state', () => {
 75:       expect(service.error()).toBeNull();
 76:     });
 77:   });
 78: 
 79:   describe('loadAccounts', () => {
 80:     it('should load accounts successfully', async () => {
 81:       repository.findAll.and.returnValue(of(mockAccounts));
 82: 
 83:       await service.loadAccounts();
 84: 
 85:       expect(service.accounts().length).toBe(2);
 86:       expect(service.accounts()[0].id).toBe('account-1');
 87:       expect(service.loading()).toBe(false);
 88:       expect(service.error()).toBeNull();
 89:     });
 90: 
 91:     it('should set loading state during load', async () => {
 92:       repository.findAll.and.returnValue(of(mockAccounts));
 93: 
 94:       const loadPromise = service.loadAccounts();
 95:       expect(service.loading()).toBe(true);
 96: 
 97:       await loadPromise;
 98:       expect(service.loading()).toBe(false);
 99:     });
100: 
101:     it('should handle error when loading fails', async () => {
102:       const error = new Error('Load failed');
103:       repository.findAll.and.returnValue(throwError(() => error));
104: 
105:       try {
106:         await service.loadAccounts();
107:         fail('should have thrown error');
108:       } catch (e) {
109:         expect(service.error()).toBe('Load failed');
110:         expect(service.loading()).toBe(false);
111:       }
112:     });
113:   });
114: 
115:   describe('loadAccountById', () => {
116:     it('should load account by id successfully', async () => {
117:       repository.findById.and.returnValue(of(mockAccount));
118: 
119:       const result = await service.loadAccountById('account-1');
120: 
121:       expect(result).toEqual(mockAccount);
122:       expect(service.selectedAccount()).toEqual(mockAccount);
123:       expect(service.loading()).toBe(false);
124:     });
125: 
126:     it('should return null when account not found', async () => {
127:       repository.findById.and.returnValue(of(null));
128: 
129:       const result = await service.loadAccountById('non-existent');
130: 
131:       expect(result).toBeNull();
132:       expect(service.selectedAccount()).toBeNull();
133:     });
134: 
135:     it('should handle error when loading by id fails', async () => {
136:       const error = new Error('Not found');
137:       repository.findById.and.returnValue(throwError(() => error));
138: 
139:       try {
140:         await service.loadAccountById('account-1');
141:         fail('should have thrown error');
142:       } catch (e) {
143:         expect(service.error()).toBe('Not found');
144:       }
145:     });
146:   });
147: 
148:   describe('loadAccountsByType', () => {
149:     it('should load accounts by type', async () => {
150:       repository.findByType.and.returnValue(of([mockAccount]));
151: 
152:       const result = await service.loadAccountsByType(AccountType.USER);
153: 
154:       expect(result.length).toBe(1);
155:       expect(repository.findByType).toHaveBeenCalledWith(AccountType.USER);
156:     });
157:   });
158: 
159:   describe('loadAccountsByStatus', () => {
160:     it('should load accounts by status', async () => {
161:       repository.findByStatus.and.returnValue(of([mockAccount]));
162: 
163:       const result = await service.loadAccountsByStatus(AccountStatus.ACTIVE);
164: 
165:       expect(result.length).toBe(1);
166:       expect(repository.findByStatus).toHaveBeenCalledWith(AccountStatus.ACTIVE);
167:     });
168:   });
169: 
170:   describe('createAccount', () => {
171:     it('should create account successfully', async () => {
172:       const newAccount = { ...mockAccount, id: 'account-new' };
173:       repository.create.and.returnValue(of(newAccount));
174: 
175:       const result = await service.createAccount({
176:         type: AccountType.USER,
177:         name: 'New User',
178:         email: 'new@example.com'
179:       });
180: 
181:       expect(result).toEqual(newAccount);
182:       expect(service.accounts().length).toBe(1);
183:       expect(service.accounts()[0].id).toBe('account-new');
184:     });
185: 
186:     it('should handle error when creating fails', async () => {
187:       const error = new Error('Create failed');
188:       repository.create.and.returnValue(throwError(() => error));
189: 
190:       try {
191:         await service.createAccount({
192:           type: AccountType.USER,
193:           name: 'New User',
194:           email: 'new@example.com'
195:         });
196:         fail('should have thrown error');
197:       } catch (e) {
198:         expect(service.error()).toBe('Create failed');
199:       }
200:     });
201:   });
202: 
203:   describe('updateAccount', () => {
204:     beforeEach(() => {
205:       service['accountsState'].set(mockAccounts);
206:     });
207: 
208:     it('should update account successfully', async () => {
209:       const updated = { ...mockAccount, name: 'Updated Name' };
210:       repository.update.and.returnValue(of(updated));
211: 
212:       const result = await service.updateAccount('account-1', { name: 'Updated Name' });
213: 
214:       expect(result).toEqual(updated);
215:       expect(service.accounts()[0].name).toBe('Updated Name');
216:     });
217: 
218:     it('should update selected account if it matches', async () => {
219:       service.selectAccount(mockAccount);
220:       const updated = { ...mockAccount, name: 'Updated Name' };
221:       repository.update.and.returnValue(of(updated));
222: 
223:       await service.updateAccount('account-1', { name: 'Updated Name' });
224: 
225:       expect(service.selectedAccount()?.name).toBe('Updated Name');
226:     });
227: 
228:     it('should handle error when updating fails', async () => {
229:       const error = new Error('Update failed');
230:       repository.update.and.returnValue(throwError(() => error));
231: 
232:       try {
233:         await service.updateAccount('account-1', { name: 'Updated' });
234:         fail('should have thrown error');
235:       } catch (e) {
236:         expect(service.error()).toBe('Update failed');
237:       }
238:     });
239:   });
240: 
241:   describe('deleteAccount', () => {
242:     beforeEach(() => {
243:       service['accountsState'].set(mockAccounts);
244:     });
245: 
246:     it('should delete account successfully', async () => {
247:       repository.delete.and.returnValue(of(undefined));
248: 
249:       await service.deleteAccount('account-1');
250: 
251:       expect(service.accounts().length).toBe(1);
252:       expect(service.accounts()[0].id).toBe('account-2');
253:     });
254: 
255:     it('should clear selected account if deleted', async () => {
256:       service.selectAccount(mockAccount);
257:       repository.delete.and.returnValue(of(undefined));
258: 
259:       await service.deleteAccount('account-1');
260: 
261:       expect(service.selectedAccount()).toBeNull();
262:     });
263: 
264:     it('should handle error when deleting fails', async () => {
265:       const error = new Error('Delete failed');
266:       repository.delete.and.returnValue(throwError(() => error));
267: 
268:       try {
269:         await service.deleteAccount('account-1');
270:         fail('should have thrown error');
271:       } catch (e) {
272:         expect(service.error()).toBe('Delete failed');
273:       }
274:     });
275:   });
276: 
277:   describe('selectAccount', () => {
278:     it('should select account', () => {
279:       service.selectAccount(mockAccount);
280: 
281:       expect(service.selectedAccount()).toEqual(mockAccount);
282:     });
283: 
284:     it('should clear selection when null', () => {
285:       service.selectAccount(mockAccount);
286:       service.selectAccount(null);
287: 
288:       expect(service.selectedAccount()).toBeNull();
289:     });
290:   });
291: 
292:   describe('findByAuthUserId', () => {
293:     it('should find account by auth user id', async () => {
294:       repository.findByAuthUserId.and.returnValue(of(mockAccount));
295: 
296:       const result = await service.findByAuthUserId('auth-user-1');
297: 
298:       expect(result).toEqual(mockAccount);
299:       expect(repository.findByAuthUserId).toHaveBeenCalledWith('auth-user-1');
300:     });
301:   });
302: 
303:   describe('findByEmail', () => {
304:     it('should find account by email', async () => {
305:       repository.findByEmail.and.returnValue(of(mockAccount));
306: 
307:       const result = await service.findByEmail('test@example.com');
308: 
309:       expect(result).toEqual(mockAccount);
310:       expect(repository.findByEmail).toHaveBeenCalledWith('test@example.com');
311:     });
312:   });
313: 
314:   describe('reset', () => {
315:     it('should reset all state', () => {
316:       service['accountsState'].set(mockAccounts);
317:       service.selectAccount(mockAccount);
318:       service['errorState'].set('Some error');
319: 
320:       service.reset();
321: 
322:       expect(service.accounts().length).toBe(0);
323:       expect(service.selectedAccount()).toBeNull();
324:       expect(service.error()).toBeNull();
325:     });
326:   });
327: 
328:   describe('Computed signals', () => {
329:     beforeEach(() => {
330:       service['accountsState'].set(mockAccounts);
331:     });
332: 
333:     it('should compute activeAccounts', () => {
334:       expect(service.activeAccounts().length).toBe(1);
335:       expect(service.activeAccounts()[0].status).toBe(AccountStatus.ACTIVE);
336:     });
337: 
338:     it('should compute userAccounts', () => {
339:       expect(service.userAccounts().length).toBe(1);
340:       expect(service.userAccounts()[0].type).toBe(AccountType.USER);
341:     });
342: 
343:     it('should compute organizationAccounts', () => {
344:       expect(service.organizationAccounts().length).toBe(1);
345:       expect(service.organizationAccounts()[0].type).toBe(AccountType.ORGANIZATION);
346:     });
347:   });
348: });
````

## File: src/app/shared/services/account/account.service.ts
````typescript
  1: import { Injectable, computed, inject, signal } from '@angular/core';
  2: import { AccountInsert, AccountRepository, AccountUpdate, CollaborationMemberRepository, OrganizationCollaborationRepository } from '@core';
  3: import { Account, AccountStatus, AccountType } from '@shared';
  4: import { firstValueFrom, forkJoin } from 'rxjs';
  5: 
  6: /**
  7:  * Account Service
  8:  *
  9:  * æä¾›è´¦æˆ·ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†
 10:  * ä½¿ç”¨ Signals ç®¡ç†çŠ¶æ€ï¼Œæš´éœ² ReadonlySignal ç»™ç»„ä»¶
 11:  *
 12:  * @example
 13:  * ```typescript
 14:  * const accountService = inject(AccountService);
 15:  *
 16:  * // è®¢é˜…è´¦æˆ·åˆ—è¡¨
 17:  * effect(() => {
 18:  *   console.log('Accounts:', accountService.accounts());
 19:  * });
 20:  *
 21:  * // åŠ è½½è´¦æˆ·åˆ—è¡¨
 22:  * await accountService.loadAccounts();
 23:  * ```
 24:  */
 25: @Injectable({
 26:   providedIn: 'root'
 27: })
 28: export class AccountService {
 29:   private accountRepository = inject(AccountRepository);
 30:   private collaborationMemberRepository = inject(CollaborationMemberRepository);
 31:   private organizationCollaborationRepository = inject(OrganizationCollaborationRepository);
 32: 
 33:   // ä½¿ç”¨ Signals ç®¡ç†çŠ¶æ€
 34:   private accountsState = signal<Account[]>([]);
 35:   private selectedAccountState = signal<Account | null>(null);
 36:   private loadingState = signal<boolean>(false);
 37:   private errorState = signal<string | null>(null);
 38: 
 39:   // æš´éœ² ReadonlySignal ç»™ç»„ä»¶
 40:   readonly accounts = this.accountsState.asReadonly();
 41:   readonly selectedAccount = this.selectedAccountState.asReadonly();
 42:   readonly loading = this.loadingState.asReadonly();
 43:   readonly error = this.errorState.asReadonly();
 44: 
 45:   // Computed signals
 46:   readonly activeAccounts = computed(() => this.accounts().filter(a => a.status === AccountStatus.ACTIVE));
 47: 
 48:   readonly userAccounts = computed(() => this.accounts().filter(a => a.type === AccountType.USER));
 49: 
 50:   readonly organizationAccounts = computed(() => this.accounts().filter(a => a.type === AccountType.ORGANIZATION));
 51: 
 52:   readonly botAccounts = computed(() => this.accounts().filter(a => a.type === AccountType.BOT));
 53: 
 54:   /** ä¸ªäºº Bot è´¦æˆ·ï¼ˆauth_organization_id ä¸º NULLï¼‰ */
 55:   readonly personalBotAccounts = computed(() => this.accounts().filter(a => a.type === AccountType.BOT && !(a as any).authOrganizationId));
 56: 
 57:   /** ç»„ç»‡ Bot è´¦æˆ·ï¼ˆauth_organization_id ä¸ä¸º NULLï¼‰ */
 58:   readonly organizationBotAccounts = computed(() =>
 59:     this.accounts().filter(a => a.type === AccountType.BOT && !!(a as any).authOrganizationId)
 60:   );
 61: 
 62:   /**
 63:    * åŠ è½½æ‰€æœ‰è´¦æˆ·
 64:    */
 65:   async loadAccounts(): Promise<void> {
 66:     this.loadingState.set(true);
 67:     this.errorState.set(null);
 68: 
 69:     try {
 70:       const accounts = await firstValueFrom(this.accountRepository.findAll());
 71:       this.accountsState.set(accounts);
 72:     } catch (error) {
 73:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½è´¦æˆ·åˆ—è¡¨å¤±è´¥');
 74:       throw error;
 75:     } finally {
 76:       this.loadingState.set(false);
 77:     }
 78:   }
 79: 
 80:   /**
 81:    * æ ¹æ® ID åŠ è½½è´¦æˆ·
 82:    */
 83:   async loadAccountById(id: string): Promise<Account | null> {
 84:     this.loadingState.set(true);
 85:     this.errorState.set(null);
 86: 
 87:     try {
 88:       const account = await firstValueFrom(this.accountRepository.findById(id));
 89:       if (account) {
 90:         this.selectedAccountState.set(account);
 91:       }
 92:       return account;
 93:     } catch (error) {
 94:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½è´¦æˆ·å¤±è´¥');
 95:       throw error;
 96:     } finally {
 97:       this.loadingState.set(false);
 98:     }
 99:   }
100: 
101:   /**
102:    * æ ¹æ®ç±»å‹åŠ è½½è´¦æˆ·
103:    */
104:   async loadAccountsByType(type: AccountType): Promise<Account[]> {
105:     this.loadingState.set(true);
106:     this.errorState.set(null);
107: 
108:     try {
109:       const accounts = await firstValueFrom(this.accountRepository.findByType(type));
110:       return accounts;
111:     } catch (error) {
112:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½è´¦æˆ·åˆ—è¡¨å¤±è´¥');
113:       throw error;
114:     } finally {
115:       this.loadingState.set(false);
116:     }
117:   }
118: 
119:   /**
120:    * æ ¹æ®å¤šä¸ª ID æ‰¹é‡åŠ è½½è´¦æˆ·
121:    *
122:    * @param ids è´¦æˆ· ID æ•°ç»„
123:    * @returns Promise<Account[]>
124:    */
125:   async loadAccountsByIds(ids: string[]): Promise<Account[]> {
126:     if (ids.length === 0) {
127:       return [];
128:     }
129: 
130:     try {
131:       const accounts = await firstValueFrom(this.accountRepository.findByIds(ids));
132:       // æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼ˆåˆå¹¶åˆ°ç°æœ‰è´¦æˆ·åˆ—è¡¨ï¼‰
133:       this.accountsState.update(currentAccounts => {
134:         const existingIds = new Set(currentAccounts.map(a => a.id));
135:         const newAccounts = accounts.filter(a => !existingIds.has(a.id));
136:         return [...currentAccounts, ...newAccounts];
137:       });
138:       return accounts;
139:     } catch (error) {
140:       this.errorState.set(error instanceof Error ? error.message : 'æ‰¹é‡åŠ è½½è´¦æˆ·å¤±è´¥');
141:       throw error;
142:     }
143:   }
144: 
145:   /**
146:    * æ ¹æ®çŠ¶æ€åŠ è½½è´¦æˆ·
147:    */
148:   async loadAccountsByStatus(status: AccountStatus): Promise<Account[]> {
149:     this.loadingState.set(true);
150:     this.errorState.set(null);
151: 
152:     try {
153:       const accounts = await firstValueFrom(this.accountRepository.findByStatus(status));
154:       return accounts;
155:     } catch (error) {
156:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½è´¦æˆ·åˆ—è¡¨å¤±è´¥');
157:       throw error;
158:     } finally {
159:       this.loadingState.set(false);
160:     }
161:   }
162: 
163:   /**
164:    * åˆ›å»ºè´¦æˆ·
165:    */
166:   async createAccount(data: AccountInsert): Promise<Account> {
167:     this.loadingState.set(true);
168:     this.errorState.set(null);
169: 
170:     try {
171:       const account = await firstValueFrom(this.accountRepository.create(data));
172:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
173:       this.accountsState.update(accounts => [...accounts, account]);
174:       return account;
175:     } catch (error) {
176:       this.errorState.set(error instanceof Error ? error.message : 'åˆ›å»ºè´¦æˆ·å¤±è´¥');
177:       throw error;
178:     } finally {
179:       this.loadingState.set(false);
180:     }
181:   }
182: 
183:   /**
184:    * åˆ›å»º Organization è´¦æˆ·ï¼ˆä½¿ç”¨ SECURITY DEFINER å‡½æ•°ç»•è¿‡ RLSï¼‰
185:    *
186:    * @param name ç»„ç»‡åç§°
187:    * @param email é‚®ç®±ï¼ˆå¯é€‰ï¼‰
188:    * @param status è´¦æˆ·çŠ¶æ€ï¼ˆé»˜è®¤ 'active'ï¼‰
189:    * @returns Promise<Account>
190:    */
191:   async createOrganizationAccount(name: string, email?: string | null, status: AccountStatus = AccountStatus.ACTIVE): Promise<Account> {
192:     this.loadingState.set(true);
193:     this.errorState.set(null);
194: 
195:     try {
196:       const account = await firstValueFrom(this.accountRepository.createOrganizationAccount(name, email, status));
197:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
198:       this.accountsState.update(accounts => [...accounts, account]);
199:       return account;
200:     } catch (error) {
201:       this.errorState.set(error instanceof Error ? error.message : 'åˆ›å»ºç»„ç»‡è´¦æˆ·å¤±è´¥');
202:       throw error;
203:     } finally {
204:       this.loadingState.set(false);
205:     }
206:   }
207: 
208:   /**
209:    * åˆ›å»º Bot è´¦æˆ·ï¼ˆä½¿ç”¨ SECURITY DEFINER å‡½æ•°ç»•è¿‡ RLSï¼‰
210:    *
211:    * @param name æœºå™¨äººåç§°
212:    * @param email é‚®ç®±ï¼ˆå¯é€‰ï¼‰
213:    * @param status è´¦æˆ·çŠ¶æ€ï¼ˆé»˜è®¤ 'active'ï¼‰
214:    * @param organizationId ç»„ç»‡è´¦æˆ· IDï¼ˆå¯é€‰ï¼ŒNULL = ä¸ªäºº Botï¼Œæœ‰å€¼ = ç»„ç»‡ Botï¼‰
215:    * @returns Promise<Account>
216:    */
217:   async createBotAccount(
218:     name: string,
219:     email?: string | null,
220:     status: AccountStatus = AccountStatus.ACTIVE,
221:     organizationId?: string | null
222:   ): Promise<Account> {
223:     this.loadingState.set(true);
224:     this.errorState.set(null);
225: 
226:     try {
227:       const account = await firstValueFrom(this.accountRepository.createBotAccount(name, email, status, organizationId));
228:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
229:       this.accountsState.update(accounts => [...accounts, account]);
230:       return account;
231:     } catch (error) {
232:       this.errorState.set(error instanceof Error ? error.message : 'åˆ›å»ºæœºå™¨äººè´¦æˆ·å¤±è´¥');
233:       throw error;
234:     } finally {
235:       this.loadingState.set(false);
236:     }
237:   }
238: 
239:   /**
240:    * æ›´æ–°è´¦æˆ·
241:    */
242:   async updateAccount(id: string, data: AccountUpdate): Promise<Account> {
243:     this.loadingState.set(true);
244:     this.errorState.set(null);
245: 
246:     try {
247:       const account = await firstValueFrom(this.accountRepository.update(id, data));
248:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
249:       this.accountsState.update(accounts => accounts.map(a => (a.id === id ? account : a)));
250:       // å¦‚æœæ›´æ–°çš„æ˜¯å½“å‰é€‰ä¸­çš„è´¦æˆ·ï¼Œä¹Ÿæ›´æ–°é€‰ä¸­çŠ¶æ€
251:       if (this.selectedAccount()?.id === id) {
252:         this.selectedAccountState.set(account);
253:       }
254:       return account;
255:     } catch (error) {
256:       this.errorState.set(error instanceof Error ? error.message : 'æ›´æ–°è´¦æˆ·å¤±è´¥');
257:       throw error;
258:     } finally {
259:       this.loadingState.set(false);
260:     }
261:   }
262: 
263:   /**
264:    * åˆ é™¤è´¦æˆ·
265:    */
266:   async deleteAccount(id: string): Promise<void> {
267:     this.loadingState.set(true);
268:     this.errorState.set(null);
269: 
270:     try {
271:       await firstValueFrom(this.accountRepository.delete(id));
272:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
273:       this.accountsState.update(accounts => accounts.filter(a => a.id !== id));
274:       // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„è´¦æˆ·ï¼Œæ¸…ç©ºé€‰ä¸­çŠ¶æ€
275:       if (this.selectedAccount()?.id === id) {
276:         this.selectedAccountState.set(null);
277:       }
278:     } catch (error) {
279:       this.errorState.set(error instanceof Error ? error.message : 'åˆ é™¤è´¦æˆ·å¤±è´¥');
280:       throw error;
281:     } finally {
282:       this.loadingState.set(false);
283:     }
284:   }
285: 
286:   /**
287:    * é€‰æ‹©è´¦æˆ·
288:    */
289:   selectAccount(account: Account | null): void {
290:     this.selectedAccountState.set(account);
291:   }
292: 
293:   /**
294:    * æ ¹æ® auth_user_id æŸ¥æ‰¾è´¦æˆ·
295:    */
296:   async findByAuthUserId(authUserId: string): Promise<Account | null> {
297:     this.loadingState.set(true);
298:     this.errorState.set(null);
299: 
300:     try {
301:       const account = await firstValueFrom(this.accountRepository.findByAuthUserId(authUserId));
302:       return account;
303:     } catch (error) {
304:       this.errorState.set(error instanceof Error ? error.message : 'æŸ¥æ‰¾è´¦æˆ·å¤±è´¥');
305:       throw error;
306:     } finally {
307:       this.loadingState.set(false);
308:     }
309:   }
310: 
311:   /**
312:    * æ ¹æ®é‚®ç®±æŸ¥æ‰¾è´¦æˆ·
313:    */
314:   async findByEmail(email: string): Promise<Account | null> {
315:     this.loadingState.set(true);
316:     this.errorState.set(null);
317: 
318:     try {
319:       const account = await firstValueFrom(this.accountRepository.findByEmail(email));
320:       return account;
321:     } catch (error) {
322:       this.errorState.set(error instanceof Error ? error.message : 'æŸ¥æ‰¾è´¦æˆ·å¤±è´¥');
323:       throw error;
324:     } finally {
325:       this.loadingState.set(false);
326:     }
327:   }
328: 
329:   /**
330:    * è·å–ç”¨æˆ·å»ºç«‹çš„ç»„ç»‡
331:    * é€šè¿‡ auth_organization_id å­—æ®µæŸ¥è¯¢ç”¨æˆ·åˆ›å»ºçš„ç»„ç»‡è´¦æˆ·
332:    *
333:    * @param authUserId ç”¨æˆ·çš„ auth_user_id
334:    * @returns Promise<Account[]>
335:    */
336:   async getUserCreatedOrganizations(authUserId: string): Promise<Account[]> {
337:     try {
338:       const organizations = await firstValueFrom(this.accountRepository.findByAuthOrganizationId(authUserId));
339:       // è¿‡æ»¤å‡ºç»„ç»‡ç±»å‹çš„è´¦æˆ·
340:       return organizations.filter(org => org.type === AccountType.ORGANIZATION);
341:     } catch (error) {
342:       this.errorState.set(error instanceof Error ? error.message : 'è·å–ç”¨æˆ·å»ºç«‹çš„ç»„ç»‡å¤±è´¥');
343:       return [];
344:     }
345:   }
346: 
347:   /**
348:    * è·å–ç”¨æˆ·åŠ å…¥çš„ç»„ç»‡
349:    * é€šè¿‡ collaboration_members è¡¨æŸ¥è¯¢ç”¨æˆ·ä½œä¸ºæˆå‘˜çš„ç»„ç»‡
350:    *
351:    * @param userAccountId ç”¨æˆ·çš„è´¦æˆ· ID
352:    * @returns Promise<Account[]>
353:    */
354:   async getUserJoinedOrganizations(userAccountId: string): Promise<Account[]> {
355:     try {
356:       // 1. æŸ¥è¯¢ç”¨æˆ·ä½œä¸ºæˆå‘˜çš„æ‰€æœ‰åä½œå…³ç³»
357:       const members = await firstValueFrom(this.collaborationMemberRepository.findByAccountId(userAccountId));
358: 
359:       if (members.length === 0) {
360:         return [];
361:       }
362: 
363:       // 2. è·å–æ‰€æœ‰åä½œå…³ç³» IDï¼ˆæ³¨æ„ï¼šBaseRepository è¿”å›çš„æ˜¯ snake_caseï¼‰
364:       const collaborationIds = members.map(m => (m as any).collaboration_id || (m as any).collaborationId);
365: 
366:       // 3. æŸ¥è¯¢è¿™äº›åä½œå…³ç³»ï¼Œè·å–ç»„ç»‡ ID
367:       const collaborations$ = collaborationIds.map(collabId =>
368:         this.organizationCollaborationRepository.findAll({
369:           filters: { id: collabId }
370:         })
371:       );
372: 
373:       const collaborationsArrays = await firstValueFrom(forkJoin(collaborations$));
374:       const collaborations = collaborationsArrays.flat();
375: 
376:       // 4. æ”¶é›†æ‰€æœ‰ç›¸å…³çš„ç»„ç»‡ IDï¼ˆowner_org_id å’Œ collaborator_org_idï¼‰
377:       // æ³¨æ„ï¼šBaseRepository è¿”å›çš„æ•°æ®å¯èƒ½æ˜¯ snake_caseï¼Œéœ€è¦å…¼å®¹å¤„ç†
378:       const organizationIds = new Set<string>();
379:       collaborations.forEach(collab => {
380:         const ownerOrgId = (collab as any).owner_org_id || (collab as any).ownerOrgId;
381:         const collaboratorOrgId = (collab as any).collaborator_org_id || (collab as any).collaboratorOrgId;
382: 
383:         if (ownerOrgId) {
384:           organizationIds.add(ownerOrgId);
385:         }
386:         if (collaboratorOrgId) {
387:           organizationIds.add(collaboratorOrgId);
388:         }
389:       });
390: 
391:       // 5. æ’é™¤ç”¨æˆ·è‡ªå·±çš„è´¦æˆ· IDï¼ˆé¿å…é‡å¤ï¼‰
392:       organizationIds.delete(userAccountId);
393: 
394:       if (organizationIds.size === 0) {
395:         return [];
396:       }
397: 
398:       // 6. æ‰¹é‡æŸ¥è¯¢ç»„ç»‡è´¦æˆ·
399:       const organizations = await this.loadAccountsByIds(Array.from(organizationIds));
400:       return organizations.filter(org => org.type === AccountType.ORGANIZATION);
401:     } catch (error) {
402:       this.errorState.set(error instanceof Error ? error.message : 'è·å–ç”¨æˆ·åŠ å…¥çš„ç»„ç»‡å¤±è´¥');
403:       return [];
404:     }
405:   }
406: 
407:   /**
408:    * é‡ç½®çŠ¶æ€
409:    */
410:   reset(): void {
411:     this.accountsState.set([]);
412:     this.selectedAccountState.set(null);
413:     this.errorState.set(null);
414:   }
415: }
````

## File: src/app/shared/services/account/organization-schedule.service.ts
````typescript
  1: import { Injectable, inject, signal, computed } from '@angular/core';
  2: import { OrganizationScheduleRepository, OrganizationSchedule, OrganizationScheduleInsert, OrganizationScheduleUpdate } from '@core';
  3: import { Observable, firstValueFrom } from 'rxjs';
  4: 
  5: /**
  6:  * OrganizationSchedule Service
  7:  *
  8:  * æä¾›ç»„ç»‡æ’ç­ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†
  9:  * ä½¿ç”¨ Signals ç®¡ç†çŠ¶æ€ï¼Œæš´éœ² ReadonlySignal ç»™ç»„ä»¶
 10:  *
 11:  * @example
 12:  * ```typescript
 13:  * const scheduleService = inject(OrganizationScheduleService);
 14:  *
 15:  * // è®¢é˜…æ’ç­åˆ—è¡¨
 16:  * effect(() => {
 17:  *   console.log('Schedules:', scheduleService.schedules());
 18:  * });
 19:  *
 20:  * // åŠ è½½ç»„ç»‡ä¸‹çš„æ’ç­åˆ—è¡¨
 21:  * await scheduleService.loadSchedulesByOrganizationId('org-id');
 22:  * ```
 23:  */
 24: @Injectable({
 25:   providedIn: 'root'
 26: })
 27: export class OrganizationScheduleService {
 28:   private scheduleRepository = inject(OrganizationScheduleRepository);
 29: 
 30:   // ä½¿ç”¨ Signals ç®¡ç†çŠ¶æ€
 31:   private schedulesState = signal<OrganizationSchedule[]>([]);
 32:   private selectedScheduleState = signal<OrganizationSchedule | null>(null);
 33:   private loadingState = signal<boolean>(false);
 34:   private errorState = signal<string | null>(null);
 35: 
 36:   // æš´éœ² ReadonlySignal ç»™ç»„ä»¶
 37:   readonly schedules = this.schedulesState.asReadonly();
 38:   readonly selectedSchedule = this.selectedScheduleState.asReadonly();
 39:   readonly loading = this.loadingState.asReadonly();
 40:   readonly error = this.errorState.asReadonly();
 41: 
 42:   /**
 43:    * åŠ è½½æ‰€æœ‰æ’ç­
 44:    */
 45:   async loadSchedules(): Promise<void> {
 46:     this.loadingState.set(true);
 47:     this.errorState.set(null);
 48: 
 49:     try {
 50:       const schedules = (await firstValueFrom(this.scheduleRepository.findAll())) as OrganizationSchedule[];
 51:       this.schedulesState.set(schedules);
 52:     } catch (error) {
 53:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½æ’ç­åˆ—è¡¨å¤±è´¥');
 54:       throw error;
 55:     } finally {
 56:       this.loadingState.set(false);
 57:     }
 58:   }
 59: 
 60:   /**
 61:    * æ ¹æ®ç»„ç»‡ ID åŠ è½½æ’ç­åˆ—è¡¨
 62:    */
 63:   async loadSchedulesByOrganizationId(organizationId: string): Promise<OrganizationSchedule[]> {
 64:     this.loadingState.set(true);
 65:     this.errorState.set(null);
 66: 
 67:     try {
 68:       const schedules = (await firstValueFrom(this.scheduleRepository.findByOrganizationId(organizationId))) as OrganizationSchedule[];
 69:       this.schedulesState.set(schedules);
 70:       return schedules;
 71:     } catch (error) {
 72:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½æ’ç­åˆ—è¡¨å¤±è´¥');
 73:       throw error;
 74:     } finally {
 75:       this.loadingState.set(false);
 76:     }
 77:   }
 78: 
 79:   /**
 80:    * æ ¹æ®è“å›¾ ID åŠ è½½æ’ç­åˆ—è¡¨
 81:    */
 82:   async loadSchedulesByBlueprintId(blueprintId: string): Promise<OrganizationSchedule[]> {
 83:     this.loadingState.set(true);
 84:     this.errorState.set(null);
 85: 
 86:     try {
 87:       const schedules = (await firstValueFrom(this.scheduleRepository.findByBlueprintId(blueprintId))) as OrganizationSchedule[];
 88:       return schedules;
 89:     } catch (error) {
 90:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½æ’ç­åˆ—è¡¨å¤±è´¥');
 91:       throw error;
 92:     } finally {
 93:       this.loadingState.set(false);
 94:     }
 95:   }
 96: 
 97:   /**
 98:    * æ ¹æ®åˆ†æ”¯ ID åŠ è½½æ’ç­åˆ—è¡¨
 99:    */
100:   async loadSchedulesByBranchId(branchId: string): Promise<OrganizationSchedule[]> {
101:     this.loadingState.set(true);
102:     this.errorState.set(null);
103: 
104:     try {
105:       const schedules = (await firstValueFrom(this.scheduleRepository.findByBranchId(branchId))) as OrganizationSchedule[];
106:       return schedules;
107:     } catch (error) {
108:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½æ’ç­åˆ—è¡¨å¤±è´¥');
109:       throw error;
110:     } finally {
111:       this.loadingState.set(false);
112:     }
113:   }
114: 
115:   /**
116:    * æ ¹æ®è´¦æˆ· ID åŠ è½½æ’ç­åˆ—è¡¨
117:    */
118:   async loadSchedulesByAccountId(accountId: string): Promise<OrganizationSchedule[]> {
119:     this.loadingState.set(true);
120:     this.errorState.set(null);
121: 
122:     try {
123:       const schedules = (await firstValueFrom(this.scheduleRepository.findByAccountId(accountId))) as OrganizationSchedule[];
124:       return schedules;
125:     } catch (error) {
126:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½æ’ç­åˆ—è¡¨å¤±è´¥');
127:       throw error;
128:     } finally {
129:       this.loadingState.set(false);
130:     }
131:   }
132: 
133:   /**
134:    * æ ¹æ®å›¢é˜Ÿ ID åŠ è½½æ’ç­åˆ—è¡¨
135:    */
136:   async loadSchedulesByTeamId(teamId: string): Promise<OrganizationSchedule[]> {
137:     this.loadingState.set(true);
138:     this.errorState.set(null);
139: 
140:     try {
141:       const schedules = (await firstValueFrom(this.scheduleRepository.findByTeamId(teamId))) as OrganizationSchedule[];
142:       return schedules;
143:     } catch (error) {
144:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½æ’ç­åˆ—è¡¨å¤±è´¥');
145:       throw error;
146:     } finally {
147:       this.loadingState.set(false);
148:     }
149:   }
150: 
151:   /**
152:    * æ ¹æ®æ—¥æœŸèŒƒå›´åŠ è½½æ’ç­åˆ—è¡¨
153:    */
154:   async loadSchedulesByDateRange(startDate: string, endDate: string): Promise<OrganizationSchedule[]> {
155:     this.loadingState.set(true);
156:     this.errorState.set(null);
157: 
158:     try {
159:       const schedules = (await firstValueFrom(this.scheduleRepository.findByDateRange(startDate, endDate))) as OrganizationSchedule[];
160:       return schedules;
161:     } catch (error) {
162:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½æ’ç­åˆ—è¡¨å¤±è´¥');
163:       throw error;
164:     } finally {
165:       this.loadingState.set(false);
166:     }
167:   }
168: 
169:   /**
170:    * æ ¹æ® ID åŠ è½½æ’ç­
171:    */
172:   async loadScheduleById(id: string): Promise<OrganizationSchedule | null> {
173:     this.loadingState.set(true);
174:     this.errorState.set(null);
175: 
176:     try {
177:       const schedule = (await firstValueFrom(this.scheduleRepository.findById(id))) as OrganizationSchedule | null;
178:       if (schedule) {
179:         this.selectedScheduleState.set(schedule);
180:       }
181:       return schedule;
182:     } catch (error) {
183:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½æ’ç­å¤±è´¥');
184:       throw error;
185:     } finally {
186:       this.loadingState.set(false);
187:     }
188:   }
189: 
190:   /**
191:    * åˆ›å»ºæ’ç­
192:    */
193:   async createSchedule(data: OrganizationScheduleInsert): Promise<OrganizationSchedule> {
194:     this.loadingState.set(true);
195:     this.errorState.set(null);
196: 
197:     try {
198:       const schedule = (await firstValueFrom(this.scheduleRepository.create(data))) as OrganizationSchedule;
199:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
200:       this.schedulesState.update(schedules => [...schedules, schedule]);
201:       return schedule;
202:     } catch (error) {
203:       this.errorState.set(error instanceof Error ? error.message : 'åˆ›å»ºæ’ç­å¤±è´¥');
204:       throw error;
205:     } finally {
206:       this.loadingState.set(false);
207:     }
208:   }
209: 
210:   /**
211:    * æ›´æ–°æ’ç­
212:    */
213:   async updateSchedule(id: string, data: OrganizationScheduleUpdate): Promise<OrganizationSchedule> {
214:     this.loadingState.set(true);
215:     this.errorState.set(null);
216: 
217:     try {
218:       const schedule = (await firstValueFrom(this.scheduleRepository.update(id, data))) as OrganizationSchedule;
219:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
220:       this.schedulesState.update(schedules => schedules.map(s => (s.id === id ? schedule : s)));
221:       // å¦‚æœæ›´æ–°çš„æ˜¯å½“å‰é€‰ä¸­çš„æ’ç­ï¼Œä¹Ÿæ›´æ–°é€‰ä¸­çŠ¶æ€
222:       if (this.selectedSchedule()?.id === id) {
223:         this.selectedScheduleState.set(schedule);
224:       }
225:       return schedule;
226:     } catch (error) {
227:       this.errorState.set(error instanceof Error ? error.message : 'æ›´æ–°æ’ç­å¤±è´¥');
228:       throw error;
229:     } finally {
230:       this.loadingState.set(false);
231:     }
232:   }
233: 
234:   /**
235:    * åˆ é™¤æ’ç­
236:    */
237:   async deleteSchedule(id: string): Promise<void> {
238:     this.loadingState.set(true);
239:     this.errorState.set(null);
240: 
241:     try {
242:       await firstValueFrom(this.scheduleRepository.delete(id));
243:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
244:       this.schedulesState.update(schedules => schedules.filter(s => s.id !== id));
245:       // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„æ’ç­ï¼Œæ¸…ç©ºé€‰ä¸­çŠ¶æ€
246:       if (this.selectedSchedule()?.id === id) {
247:         this.selectedScheduleState.set(null);
248:       }
249:     } catch (error) {
250:       this.errorState.set(error instanceof Error ? error.message : 'åˆ é™¤æ’ç­å¤±è´¥');
251:       throw error;
252:     } finally {
253:       this.loadingState.set(false);
254:     }
255:   }
256: 
257:   /**
258:    * é€‰æ‹©æ’ç­
259:    */
260:   selectSchedule(schedule: OrganizationSchedule | null): void {
261:     this.selectedScheduleState.set(schedule);
262:   }
263: 
264:   /**
265:    * é‡ç½®çŠ¶æ€
266:    */
267:   reset(): void {
268:     this.schedulesState.set([]);
269:     this.selectedScheduleState.set(null);
270:     this.errorState.set(null);
271:   }
272: }
````

## File: src/app/shared/services/account/team.service.spec.ts
````typescript
  1: import { TestBed } from '@angular/core/testing';
  2: import { TeamRepository, TeamMemberRepository, TeamMemberRole } from '@core';
  3: import { Team, TeamMember } from '@shared';
  4: import { of, throwError } from 'rxjs';
  5: 
  6: import { TeamService } from './team.service';
  7: 
  8: describe('TeamService', () => {
  9:   let service: TeamService;
 10:   let teamRepository: jasmine.SpyObj<TeamRepository>;
 11:   let teamMemberRepository: jasmine.SpyObj<TeamMemberRepository>;
 12: 
 13:   const mockTeam: Team = {
 14:     id: 'team-1',
 15:     organization_id: 'org-1',
 16:     name: 'Test Team',
 17:     description: 'Test team description',
 18:     avatar_url: null,
 19:     created_by: 'account-1',
 20:     created_at: '2025-01-01T00:00:00Z',
 21:     updated_at: '2025-01-01T00:00:00Z'
 22:   } as Team;
 23: 
 24:   const mockTeams: Team[] = [
 25:     mockTeam,
 26:     {
 27:       ...mockTeam,
 28:       id: 'team-2',
 29:       name: 'Test Team 2'
 30:     }
 31:   ];
 32: 
 33:   const mockTeamMember: TeamMember = {
 34:     id: 'member-1',
 35:     team_id: 'team-1',
 36:     account_id: 'account-1',
 37:     role: TeamMemberRole.MEMBER,
 38:     joined_at: '2025-01-01T00:00:00Z'
 39:   } as TeamMember;
 40: 
 41:   const mockTeamMembers: TeamMember[] = [
 42:     mockTeamMember,
 43:     {
 44:       ...mockTeamMember,
 45:       id: 'member-2',
 46:       account_id: 'account-2',
 47:       role: TeamMemberRole.LEADER
 48:     }
 49:   ];
 50: 
 51:   beforeEach(() => {
 52:     const teamRepositorySpy = jasmine.createSpyObj('TeamRepository', [
 53:       'findAll',
 54:       'findById',
 55:       'findByOrganizationId',
 56:       'create',
 57:       'update',
 58:       'delete'
 59:     ]);
 60: 
 61:     const teamMemberRepositorySpy = jasmine.createSpyObj('TeamMemberRepository', ['findByTeamId', 'create', 'update', 'delete']);
 62: 
 63:     TestBed.configureTestingModule({
 64:       providers: [
 65:         TeamService,
 66:         { provide: TeamRepository, useValue: teamRepositorySpy },
 67:         { provide: TeamMemberRepository, useValue: teamMemberRepositorySpy }
 68:       ]
 69:     });
 70: 
 71:     service = TestBed.inject(TeamService);
 72:     teamRepository = TestBed.inject(TeamRepository) as jasmine.SpyObj<TeamRepository>;
 73:     teamMemberRepository = TestBed.inject(TeamMemberRepository) as jasmine.SpyObj<TeamMemberRepository>;
 74:   });
 75: 
 76:   it('should be created', () => {
 77:     expect(service).toBeTruthy();
 78:   });
 79: 
 80:   describe('Initial state', () => {
 81:     it('should have empty teams', () => {
 82:       expect(service.teams().length).toBe(0);
 83:     });
 84: 
 85:     it('should have null selected team', () => {
 86:       expect(service.selectedTeam()).toBeNull();
 87:     });
 88: 
 89:     it('should have empty team members', () => {
 90:       expect(service.teamMembers().length).toBe(0);
 91:     });
 92: 
 93:     it('should have false loading state', () => {
 94:       expect(service.loading()).toBe(false);
 95:     });
 96: 
 97:     it('should have null error state', () => {
 98:       expect(service.error()).toBeNull();
 99:     });
100:   });
101: 
102:   describe('loadTeams', () => {
103:     it('should load teams successfully', async () => {
104:       teamRepository.findAll.and.returnValue(of(mockTeams));
105: 
106:       await service.loadTeams();
107: 
108:       expect(service.teams().length).toBe(2);
109:       expect(service.teams()[0].id).toBe('team-1');
110:       expect(service.loading()).toBe(false);
111:     });
112: 
113:     it('should handle error when loading fails', async () => {
114:       const error = new Error('Load failed');
115:       teamRepository.findAll.and.returnValue(throwError(() => error));
116: 
117:       try {
118:         await service.loadTeams();
119:         fail('should have thrown error');
120:       } catch (e) {
121:         expect(service.error()).toBe('Load failed');
122:       }
123:     });
124:   });
125: 
126:   describe('loadTeamsByOrganizationId', () => {
127:     it('should load teams by organization id', async () => {
128:       teamRepository.findByOrganizationId.and.returnValue(of(mockTeams));
129: 
130:       const result = await service.loadTeamsByOrganizationId('org-1');
131: 
132:       expect(result.length).toBe(2);
133:       expect(teamRepository.findByOrganizationId).toHaveBeenCalledWith('org-1');
134:     });
135:   });
136: 
137:   describe('loadTeamById', () => {
138:     it('should load team by id and members', async () => {
139:       teamRepository.findById.and.returnValue(of(mockTeam));
140:       teamMemberRepository.findByTeamId.and.returnValue(of(mockTeamMembers));
141: 
142:       const result = await service.loadTeamById('team-1');
143: 
144:       expect(result).toEqual(mockTeam);
145:       expect(service.selectedTeam()).toEqual(mockTeam);
146:       expect(service.teamMembers().length).toBe(2);
147:     });
148:   });
149: 
150:   describe('createTeam', () => {
151:     it('should create team successfully', async () => {
152:       const newTeam = { ...mockTeam, id: 'team-new' };
153:       teamRepository.create.and.returnValue(of(newTeam));
154: 
155:       const result = await service.createTeam({
156:         organization_id: 'org-1',
157:         name: 'New Team',
158:         created_by: 'account-1'
159:       });
160: 
161:       expect(result).toEqual(newTeam);
162:       expect(service.teams().length).toBe(1);
163:     });
164:   });
165: 
166:   describe('updateTeam', () => {
167:     beforeEach(() => {
168:       service['teamsState'].set(mockTeams);
169:     });
170: 
171:     it('should update team successfully', async () => {
172:       const updated = { ...mockTeam, name: 'Updated Name' };
173:       teamRepository.update.and.returnValue(of(updated));
174: 
175:       const result = await service.updateTeam('team-1', { name: 'Updated Name' });
176: 
177:       expect(result).toEqual(updated);
178:       expect(service.teams()[0].name).toBe('Updated Name');
179:     });
180:   });
181: 
182:   describe('deleteTeam', () => {
183:     beforeEach(() => {
184:       service['teamsState'].set(mockTeams);
185:     });
186: 
187:     it('should delete team successfully', async () => {
188:       teamRepository.delete.and.returnValue(of(undefined));
189: 
190:       await service.deleteTeam('team-1');
191: 
192:       expect(service.teams().length).toBe(1);
193:       expect(service.teams()[0].id).toBe('team-2');
194:     });
195: 
196:     it('should clear selected team and members if deleted', async () => {
197:       teamMemberRepository.findByTeamId.and.returnValue(of(mockTeamMembers));
198:       service.selectTeam(mockTeam);
199:       await new Promise(resolve => setTimeout(resolve, 0)); // Wait for async loadTeamMembers
200:       service['teamMembersState'].set(mockTeamMembers);
201:       teamRepository.delete.and.returnValue(of(undefined));
202: 
203:       await service.deleteTeam('team-1');
204: 
205:       expect(service.selectedTeam()).toBeNull();
206:       expect(service.teamMembers().length).toBe(0);
207:     });
208:   });
209: 
210:   describe('selectTeam', () => {
211:     it('should select team and load members', async () => {
212:       teamMemberRepository.findByTeamId.and.returnValue(of(mockTeamMembers));
213: 
214:       service.selectTeam(mockTeam);
215:       await new Promise(resolve => setTimeout(resolve, 0)); // Wait for async loadTeamMembers
216: 
217:       expect(service.selectedTeam()).toEqual(mockTeam);
218:       expect(teamMemberRepository.findByTeamId).toHaveBeenCalledWith('team-1');
219:     });
220: 
221:     it('should clear selection when null', () => {
222:       teamMemberRepository.findByTeamId.and.returnValue(of(mockTeamMembers));
223:       service.selectTeam(mockTeam);
224:       service.selectTeam(null);
225: 
226:       expect(service.selectedTeam()).toBeNull();
227:       expect(service.teamMembers().length).toBe(0);
228:     });
229:   });
230: 
231:   describe('loadTeamMembers', () => {
232:     it('should load team members successfully', async () => {
233:       teamMemberRepository.findByTeamId.and.returnValue(of(mockTeamMembers));
234: 
235:       const result = await service.loadTeamMembers('team-1');
236: 
237:       expect(result.length).toBe(2);
238:       expect(service.teamMembers().length).toBe(2);
239:     });
240:   });
241: 
242:   describe('addTeamMember', () => {
243:     it('should add team member successfully', async () => {
244:       const newMember = { ...mockTeamMember, id: 'member-new' };
245:       teamMemberRepository.create.and.returnValue(of(newMember));
246: 
247:       const result = await service.addTeamMember('team-1', 'account-3', TeamMemberRole.MEMBER);
248: 
249:       expect(result).toEqual(newMember);
250:       expect(service.teamMembers().length).toBe(1);
251:     });
252:   });
253: 
254:   describe('removeTeamMember', () => {
255:     beforeEach(() => {
256:       service['teamMembersState'].set(mockTeamMembers);
257:     });
258: 
259:     it('should remove team member successfully', async () => {
260:       teamMemberRepository.delete.and.returnValue(of(undefined));
261: 
262:       await service.removeTeamMember('member-1');
263: 
264:       expect(service.teamMembers().length).toBe(1);
265:       expect(service.teamMembers()[0].id).toBe('member-2');
266:     });
267:   });
268: 
269:   describe('updateTeamMemberRole', () => {
270:     beforeEach(() => {
271:       service['teamMembersState'].set(mockTeamMembers);
272:     });
273: 
274:     it('should update team member role successfully', async () => {
275:       const updated = { ...mockTeamMember, role: TeamMemberRole.LEADER };
276:       teamMemberRepository.update.and.returnValue(of(updated));
277: 
278:       const result = await service.updateTeamMemberRole('member-1', TeamMemberRole.LEADER);
279: 
280:       expect(result.role).toBe(TeamMemberRole.LEADER);
281:       expect(service.teamMembers()[0].role).toBe(TeamMemberRole.LEADER);
282:     });
283:   });
284: 
285:   describe('reset', () => {
286:     it('should reset all state', () => {
287:       service['teamsState'].set(mockTeams);
288:       service.selectTeam(mockTeam);
289:       service['teamMembersState'].set(mockTeamMembers);
290:       service['errorState'].set('Some error');
291: 
292:       service.reset();
293: 
294:       expect(service.teams().length).toBe(0);
295:       expect(service.selectedTeam()).toBeNull();
296:       expect(service.teamMembers().length).toBe(0);
297:       expect(service.error()).toBeNull();
298:     });
299:   });
300: });
````

## File: src/app/shared/services/auth/auth.service.ts
````typescript
  1: import { Injectable, inject } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { AccountRepository, SupabaseService, SupabaseSessionAdapterService } from '@core';
  4: import { Observable, from, of, throwError } from 'rxjs';
  5: import { catchError, map, switchMap, tap } from 'rxjs/operators';
  6: 
  7: import { AuthStateService } from './auth.state';
  8: import { AuthResult, SignInRequest, SignUpRequest } from './auth.types';
  9: import { Account } from '../../models';
 10: 
 11: /**
 12:  * è®¤è¯æœåŠ¡ï¼ˆä¸šåŠ¡å±‚ï¼‰
 13:  *
 14:  * èŒè´£ï¼š
 15:  * 1. è®¤è¯æ“ä½œï¼ˆsignIn, signUp, signOutï¼‰
 16:  * 2. è®¤è¯çŠ¶æ€ç®¡ç†
 17:  * 3. ç”¨æˆ·ä¿¡æ¯ç®¡ç†
 18:  *
 19:  * ä¾èµ–ï¼š
 20:  * - SupabaseService (core) - åŸºç¡€è®¾æ–½
 21:  * - SupabaseSessionAdapterService (core) - Session é€‚é…å™¨
 22:  * - AccountRepository (core) - æ•°æ®è®¿é—®
 23:  * - AuthStateService (shared) - çŠ¶æ€ç®¡ç†
 24:  *
 25:  * @example
 26:  * ```typescript
 27:  * const authService = inject(AuthService);
 28:  * authService.signIn({ email: 'user@example.com', password: 'password' })
 29:  *   .subscribe(result => {
 30:  *     if (result.success) {
 31:  *       console.log('ç™»å½•æˆåŠŸ');
 32:  *     }
 33:  *   });
 34:  * ```
 35:  */
 36: @Injectable({
 37:   providedIn: 'root'
 38: })
 39: export class AuthService {
 40:   private readonly supabaseService = inject(SupabaseService);
 41:   private readonly sessionAdapter = inject(SupabaseSessionAdapterService);
 42:   private readonly accountRepository = inject(AccountRepository);
 43:   private readonly authState = inject(AuthStateService);
 44:   private readonly router = inject(Router);
 45: 
 46:   /**
 47:    * ç™»å½•
 48:    *
 49:    * @param request ç™»å½•è¯·æ±‚
 50:    * @returns Observable<AuthResult>
 51:    */
 52:   signIn(request: SignInRequest): Observable<AuthResult> {
 53:     this.authState.setLoading(true);
 54:     this.authState.setError(null);
 55: 
 56:     return from(
 57:       this.supabaseService.client.auth.signInWithPassword({
 58:         email: request.email,
 59:         password: request.password
 60:       })
 61:     ).pipe(
 62:       switchMap(({ data, error }) => {
 63:         if (error) {
 64:           this.authState.setLoading(false);
 65:           this.authState.setError(error.message);
 66:           return of({
 67:             success: false,
 68:             error,
 69:             user: null
 70:           } as AuthResult);
 71:         }
 72: 
 73:         if (!data.session) {
 74:           this.authState.setLoading(false);
 75:           this.authState.setError('ç™»å½•å¤±è´¥ï¼šæœªè¿”å› Session');
 76:           return of({
 77:             success: false,
 78:             error: null,
 79:             user: null
 80:           } as AuthResult);
 81:         }
 82: 
 83:         // åŒæ­¥ Session åˆ° TokenService
 84:         this.sessionAdapter.syncSessionToTokenService(data.session);
 85: 
 86:         // åŠ è½½ç”¨æˆ·è´¦æˆ·ä¿¡æ¯
 87:         return this.loadUserAccount(data.session.user.id).pipe(
 88:           map(account => {
 89:             this.authState.setLoading(false);
 90:             if (account) {
 91:               this.authState.setUser(account);
 92:               return {
 93:                 success: true,
 94:                 error: null,
 95:                 user: account
 96:               } as AuthResult;
 97:             } else {
 98:               this.authState.setError('æ— æ³•åŠ è½½ç”¨æˆ·è´¦æˆ·ä¿¡æ¯');
 99:               return {
100:                 success: false,
101:                 error: null,
102:                 user: null
103:               } as AuthResult;
104:             }
105:           }),
106:           catchError(err => {
107:             this.authState.setLoading(false);
108:             this.authState.setError(err.message || 'åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
109:             return of({
110:               success: false,
111:               error: null,
112:               user: null
113:             } as AuthResult);
114:           })
115:         );
116:       }),
117:       catchError(err => {
118:         this.authState.setLoading(false);
119:         this.authState.setError(err.message || 'ç™»å½•å¤±è´¥');
120:         return of({
121:           success: false,
122:           error: err,
123:           user: null
124:         } as AuthResult);
125:       })
126:     );
127:   }
128: 
129:   /**
130:    * æ³¨å†Œ
131:    *
132:    * @param request æ³¨å†Œè¯·æ±‚
133:    * @returns Observable<AuthResult>
134:    */
135:   signUp(request: SignUpRequest): Observable<AuthResult> {
136:     this.authState.setLoading(true);
137:     this.authState.setError(null);
138: 
139:     return from(
140:       this.supabaseService.client.auth.signUp({
141:         email: request.email,
142:         password: request.password,
143:         options: {
144:           data: request.metadata
145:         }
146:       })
147:     ).pipe(
148:       switchMap(({ data, error }) => {
149:         if (error) {
150:           this.authState.setLoading(false);
151:           this.authState.setError(error.message);
152:           return of({
153:             success: false,
154:             error,
155:             user: null
156:           } as AuthResult);
157:         }
158: 
159:         // Supabase æ³¨å†Œå¯èƒ½è¿”å› sessionï¼ˆemail éªŒè¯å…³é—­ï¼‰æˆ– nullï¼ˆemail éªŒè¯å¼€å¯ï¼‰
160:         if (data.session && data.user) {
161:           // åŒæ­¥ Session åˆ° TokenService
162:           this.sessionAdapter.syncSessionToTokenService(data.session);
163: 
164:           // åŠ è½½ç”¨æˆ·è´¦æˆ·ä¿¡æ¯ï¼ˆå¦‚æœå·²åˆ›å»ºï¼‰
165:           return this.loadUserAccount(data.user.id).pipe(
166:             map(account => {
167:               this.authState.setLoading(false);
168:               if (account) {
169:                 this.authState.setUser(account);
170:                 return {
171:                   success: true,
172:                   error: null,
173:                   user: account
174:                 } as AuthResult;
175:               } else {
176:                 // è´¦æˆ·å¯èƒ½è¿˜æœªåˆ›å»ºï¼ˆéœ€è¦è§¦å‘å™¨ï¼‰ï¼Œä½†æ³¨å†ŒæˆåŠŸ
177:                 return {
178:                   success: true,
179:                   error: null,
180:                   user: null
181:                 } as AuthResult;
182:               }
183:             }),
184:             catchError(() => {
185:               // å³ä½¿åŠ è½½è´¦æˆ·å¤±è´¥ï¼Œæ³¨å†Œä¹Ÿå¯èƒ½æˆåŠŸï¼ˆéœ€è¦ email éªŒè¯ï¼‰
186:               this.authState.setLoading(false);
187:               return of({
188:                 success: true,
189:                 error: null,
190:                 user: null
191:               } as AuthResult);
192:             })
193:           );
194:         } else {
195:           // Email éªŒè¯å·²å¼€å¯ï¼Œéœ€è¦ç”¨æˆ·éªŒè¯é‚®ç®±
196:           this.authState.setLoading(false);
197:           return of({
198:             success: true,
199:             error: null,
200:             user: null
201:           } as AuthResult);
202:         }
203:       }),
204:       catchError(err => {
205:         this.authState.setLoading(false);
206:         this.authState.setError(err.message || 'æ³¨å†Œå¤±è´¥');
207:         return of({
208:           success: false,
209:           error: err,
210:           user: null
211:         } as AuthResult);
212:       })
213:     );
214:   }
215: 
216:   /**
217:    * ç™»å‡º
218:    *
219:    * @returns Observable<void>
220:    */
221:   signOut(): Observable<void> {
222:     this.authState.setLoading(true);
223: 
224:     return from(this.supabaseService.client.auth.signOut()).pipe(
225:       tap(() => {
226:         // æ¸…é™¤è®¤è¯çŠ¶æ€
227:         this.authState.clear();
228:         // æ¸…é™¤ TokenService
229:         this.sessionAdapter.clearTokenService();
230:         this.authState.setLoading(false);
231:       }),
232:       map(() => undefined),
233:       catchError(err => {
234:         this.authState.setLoading(false);
235:         this.authState.setError(err.message || 'ç™»å‡ºå¤±è´¥');
236:         // å³ä½¿ç™»å‡ºå¤±è´¥ï¼Œä¹Ÿæ¸…é™¤æœ¬åœ°çŠ¶æ€
237:         this.authState.clear();
238:         this.sessionAdapter.clearTokenService();
239:         return throwError(() => err);
240:       })
241:     );
242:   }
243: 
244:   /**
245:    * è·å–å½“å‰ç”¨æˆ·
246:    *
247:    * @returns Observable<Account | null>
248:    */
249:   getCurrentUser(): Observable<Account | null> {
250:     return this.sessionAdapter.getCurrentSession().pipe(
251:       switchMap(session => {
252:         if (!session) {
253:           return of(null);
254:         }
255:         return this.loadUserAccount(session.user.id);
256:       })
257:     );
258:   }
259: 
260:   /**
261:    * æ£€æŸ¥è®¤è¯çŠ¶æ€
262:    *
263:    * @returns Observable<boolean>
264:    */
265:   checkAuthStatus(): Observable<boolean> {
266:     return this.sessionAdapter.getCurrentSession().pipe(
267:       map(session => {
268:         const isAuthenticated = session !== null;
269:         this.authState.setAuthenticated(isAuthenticated);
270:         return isAuthenticated;
271:       })
272:     );
273:   }
274: 
275:   /**
276:    * åŠ è½½ç”¨æˆ·è´¦æˆ·ä¿¡æ¯
277:    *
278:    * @param authUserId è®¤è¯ç”¨æˆ· ID
279:    * @returns Observable<Account | null>
280:    */
281:   private loadUserAccount(authUserId: string): Observable<Account | null> {
282:     return this.accountRepository.findByAuthUserId(authUserId).pipe(
283:       tap(account => {
284:         if (account) {
285:           this.authState.setUser(account);
286:         }
287:       })
288:     );
289:   }
290: }
````

## File: src/app/shared/services/auth/auth.state.ts
````typescript
 1: import { Injectable, signal, computed } from '@angular/core';
 2: 
 3: import { AuthState } from './auth.types';
 4: import { Account } from '../../models';
 5: 
 6: /**
 7:  * è®¤è¯çŠ¶æ€ç®¡ç†æœåŠ¡ï¼ˆä½¿ç”¨ Signalsï¼‰
 8:  *
 9:  * æä¾›å“åº”å¼çš„è®¤è¯çŠ¶æ€ç®¡ç†
10:  */
11: @Injectable({
12:   providedIn: 'root'
13: })
14: export class AuthStateService {
15:   private readonly isAuthenticatedState = signal<boolean>(false);
16:   private readonly userState = signal<Account | null>(null);
17:   private readonly loadingState = signal<boolean>(false);
18:   private readonly errorState = signal<string | null>(null);
19: 
20:   // æš´éœ² ReadonlySignal ç»™å¤–éƒ¨
21:   readonly isAuthenticated = this.isAuthenticatedState.asReadonly();
22:   readonly user = this.userState.asReadonly();
23:   readonly loading = this.loadingState.asReadonly();
24:   readonly error = this.errorState.asReadonly();
25: 
26:   // Computed signals
27:   readonly state = computed<AuthState>(() => ({
28:     isAuthenticated: this.isAuthenticatedState(),
29:     user: this.userState(),
30:     loading: this.loadingState(),
31:     error: this.errorState()
32:   }));
33: 
34:   /**
35:    * è®¾ç½®è®¤è¯çŠ¶æ€
36:    */
37:   setAuthenticated(isAuthenticated: boolean): void {
38:     this.isAuthenticatedState.set(isAuthenticated);
39:   }
40: 
41:   /**
42:    * è®¾ç½®ç”¨æˆ·ä¿¡æ¯
43:    */
44:   setUser(user: Account | null): void {
45:     this.userState.set(user);
46:     this.isAuthenticatedState.set(user !== null);
47:   }
48: 
49:   /**
50:    * è®¾ç½®åŠ è½½çŠ¶æ€
51:    */
52:   setLoading(loading: boolean): void {
53:     this.loadingState.set(loading);
54:   }
55: 
56:   /**
57:    * è®¾ç½®é”™è¯¯ä¿¡æ¯
58:    */
59:   setError(error: string | null): void {
60:     this.errorState.set(error);
61:   }
62: 
63:   /**
64:    * æ¸…é™¤æ‰€æœ‰çŠ¶æ€
65:    */
66:   clear(): void {
67:     this.isAuthenticatedState.set(false);
68:     this.userState.set(null);
69:     this.loadingState.set(false);
70:     this.errorState.set(null);
71:   }
72: }
````

## File: src/app/shared/services/auth/auth.types.ts
````typescript
 1: import { AuthError } from '@supabase/supabase-js';
 2: 
 3: import { Account } from '../../models';
 4: 
 5: /**
 6:  * ç™»å½•è¯·æ±‚
 7:  */
 8: export interface SignInRequest {
 9:   email: string;
10:   password: string;
11: }
12: 
13: /**
14:  * æ³¨å†Œè¯·æ±‚
15:  */
16: export interface SignUpRequest {
17:   email: string;
18:   password: string;
19:   metadata?: Record<string, any>;
20: }
21: 
22: /**
23:  * è®¤è¯ç»“æœ
24:  */
25: export interface AuthResult {
26:   success: boolean;
27:   error?: AuthError | null;
28:   user?: Account | null;
29: }
30: 
31: /**
32:  * è®¤è¯çŠ¶æ€
33:  */
34: export interface AuthState {
35:   isAuthenticated: boolean;
36:   user: Account | null;
37:   loading: boolean;
38:   error: string | null;
39: }
````

## File: src/app/shared/services/auth/index.ts
````typescript
1: /**
2:  * è®¤è¯æœåŠ¡æ¨¡å—å¯¼å‡º
3:  */
4: export * from './auth.service';
5: export * from './auth.state';
6: export * from './auth.types';
````

## File: src/app/shared/services/blueprint/blueprint.service.ts
````typescript
  1: import { Injectable, inject, signal, computed } from '@angular/core';
  2: import {
  3:   BlueprintRepository,
  4:   BlueprintConfigRepository,
  5:   BlueprintInsert,
  6:   BlueprintUpdate,
  7:   BlueprintConfigInsert,
  8:   BlueprintConfigUpdate
  9: } from '@core';
 10: import { Blueprint, BlueprintConfig, BlueprintStatus } from '@shared';
 11: import { Observable, firstValueFrom } from 'rxjs';
 12: 
 13: /**
 14:  * Blueprint Service
 15:  *
 16:  * æä¾›è“å›¾ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†
 17:  * ä½¿ç”¨ Signals ç®¡ç†çŠ¶æ€ï¼Œæš´éœ² ReadonlySignal ç»™ç»„ä»¶
 18:  *
 19:  * @example
 20:  * ```typescript
 21:  * const blueprintService = inject(BlueprintService);
 22:  *
 23:  * // è®¢é˜…è“å›¾åˆ—è¡¨
 24:  * effect(() => {
 25:  *   console.log('Blueprints:', blueprintService.blueprints());
 26:  * });
 27:  *
 28:  * // åŠ è½½è“å›¾åˆ—è¡¨
 29:  * await blueprintService.loadBlueprints();
 30:  * ```
 31:  */
 32: @Injectable({
 33:   providedIn: 'root'
 34: })
 35: export class BlueprintService {
 36:   private blueprintRepository = inject(BlueprintRepository);
 37:   private blueprintConfigRepository = inject(BlueprintConfigRepository);
 38: 
 39:   // ä½¿ç”¨ Signals ç®¡ç†çŠ¶æ€
 40:   private blueprintsState = signal<Blueprint[]>([]);
 41:   private selectedBlueprintState = signal<Blueprint | null>(null);
 42:   private configsState = signal<BlueprintConfig[]>([]);
 43:   private loadingState = signal<boolean>(false);
 44:   private errorState = signal<string | null>(null);
 45: 
 46:   // æš´éœ² ReadonlySignal ç»™ç»„ä»¶
 47:   readonly blueprints = this.blueprintsState.asReadonly();
 48:   readonly selectedBlueprint = this.selectedBlueprintState.asReadonly();
 49:   readonly configs = this.configsState.asReadonly();
 50:   readonly loading = this.loadingState.asReadonly();
 51:   readonly error = this.errorState.asReadonly();
 52: 
 53:   // Computed signals
 54:   readonly activeBlueprints = computed(() => this.blueprints().filter(b => b.status === BlueprintStatus.ACTIVE));
 55: 
 56:   readonly planningBlueprints = computed(() => this.blueprints().filter(b => b.status === BlueprintStatus.PLANNING));
 57: 
 58:   readonly completedBlueprints = computed(() => this.blueprints().filter(b => b.status === BlueprintStatus.COMPLETED));
 59: 
 60:   /**
 61:    * åŠ è½½æ‰€æœ‰è“å›¾
 62:    */
 63:   async loadBlueprints(): Promise<void> {
 64:     this.loadingState.set(true);
 65:     this.errorState.set(null);
 66: 
 67:     try {
 68:       const blueprints = await firstValueFrom(this.blueprintRepository.findAll());
 69:       this.blueprintsState.set(blueprints);
 70:     } catch (error) {
 71:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
 72:       throw error;
 73:     } finally {
 74:       this.loadingState.set(false);
 75:     }
 76:   }
 77: 
 78:   /**
 79:    * æ ¹æ® ID åŠ è½½è“å›¾
 80:    */
 81:   async loadBlueprintById(id: string): Promise<Blueprint | null> {
 82:     this.loadingState.set(true);
 83:     this.errorState.set(null);
 84: 
 85:     try {
 86:       const blueprint = await firstValueFrom(this.blueprintRepository.findById(id));
 87:       if (blueprint) {
 88:         this.selectedBlueprintState.set(blueprint);
 89:         // åŒæ—¶åŠ è½½é…ç½®
 90:         await this.loadConfigs(id);
 91:       }
 92:       return blueprint;
 93:     } catch (error) {
 94:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½è“å›¾å¤±è´¥');
 95:       throw error;
 96:     } finally {
 97:       this.loadingState.set(false);
 98:     }
 99:   }
100: 
101:   /**
102:    * æ ¹æ®æ‹¥æœ‰è€… ID åŠ è½½è“å›¾åˆ—è¡¨
103:    */
104:   async loadBlueprintsByOwnerId(ownerId: string): Promise<Blueprint[]> {
105:     this.loadingState.set(true);
106:     this.errorState.set(null);
107: 
108:     try {
109:       const blueprints = await firstValueFrom(this.blueprintRepository.findByOwnerId(ownerId));
110:       this.blueprintsState.set(blueprints);
111:       return blueprints;
112:     } catch (error) {
113:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
114:       throw error;
115:     } finally {
116:       this.loadingState.set(false);
117:     }
118:   }
119: 
120:   /**
121:    * æ ¹æ®çŠ¶æ€åŠ è½½è“å›¾åˆ—è¡¨
122:    */
123:   async loadBlueprintsByStatus(status: BlueprintStatus): Promise<Blueprint[]> {
124:     this.loadingState.set(true);
125:     this.errorState.set(null);
126: 
127:     try {
128:       const blueprints = await firstValueFrom(this.blueprintRepository.findByStatus(status));
129:       return blueprints;
130:     } catch (error) {
131:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
132:       throw error;
133:     } finally {
134:       this.loadingState.set(false);
135:     }
136:   }
137: 
138:   /**
139:    * æ ¹æ®é¡¹ç›®ä»£ç åŠ è½½è“å›¾
140:    */
141:   async loadBlueprintByProjectCode(projectCode: string): Promise<Blueprint | null> {
142:     this.loadingState.set(true);
143:     this.errorState.set(null);
144: 
145:     try {
146:       const blueprint = await firstValueFrom(this.blueprintRepository.findByProjectCode(projectCode));
147:       if (blueprint) {
148:         this.selectedBlueprintState.set(blueprint);
149:       }
150:       return blueprint;
151:     } catch (error) {
152:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½è“å›¾å¤±è´¥');
153:       throw error;
154:     } finally {
155:       this.loadingState.set(false);
156:     }
157:   }
158: 
159:   /**
160:    * åˆ›å»ºè“å›¾
161:    */
162:   async createBlueprint(data: BlueprintInsert): Promise<Blueprint> {
163:     this.loadingState.set(true);
164:     this.errorState.set(null);
165: 
166:     try {
167:       const blueprint = await firstValueFrom(this.blueprintRepository.create(data));
168:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
169:       this.blueprintsState.update(blueprints => [...blueprints, blueprint]);
170:       return blueprint;
171:     } catch (error) {
172:       this.errorState.set(error instanceof Error ? error.message : 'åˆ›å»ºè“å›¾å¤±è´¥');
173:       throw error;
174:     } finally {
175:       this.loadingState.set(false);
176:     }
177:   }
178: 
179:   /**
180:    * æ›´æ–°è“å›¾
181:    */
182:   async updateBlueprint(id: string, data: BlueprintUpdate): Promise<Blueprint> {
183:     this.loadingState.set(true);
184:     this.errorState.set(null);
185: 
186:     try {
187:       const blueprint = await firstValueFrom(this.blueprintRepository.update(id, data));
188:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
189:       this.blueprintsState.update(blueprints => blueprints.map(b => (b.id === id ? blueprint : b)));
190:       // å¦‚æœæ›´æ–°çš„æ˜¯å½“å‰é€‰ä¸­çš„è“å›¾ï¼Œä¹Ÿæ›´æ–°é€‰ä¸­çŠ¶æ€
191:       if (this.selectedBlueprint()?.id === id) {
192:         this.selectedBlueprintState.set(blueprint);
193:       }
194:       return blueprint;
195:     } catch (error) {
196:       this.errorState.set(error instanceof Error ? error.message : 'æ›´æ–°è“å›¾å¤±è´¥');
197:       throw error;
198:     } finally {
199:       this.loadingState.set(false);
200:     }
201:   }
202: 
203:   /**
204:    * åˆ é™¤è“å›¾
205:    */
206:   async deleteBlueprint(id: string): Promise<void> {
207:     this.loadingState.set(true);
208:     this.errorState.set(null);
209: 
210:     try {
211:       await firstValueFrom(this.blueprintRepository.delete(id));
212:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
213:       this.blueprintsState.update(blueprints => blueprints.filter(b => b.id !== id));
214:       // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„è“å›¾ï¼Œæ¸…ç©ºé€‰ä¸­çŠ¶æ€
215:       if (this.selectedBlueprint()?.id === id) {
216:         this.selectedBlueprintState.set(null);
217:         this.configsState.set([]);
218:       }
219:     } catch (error) {
220:       this.errorState.set(error instanceof Error ? error.message : 'åˆ é™¤è“å›¾å¤±è´¥');
221:       throw error;
222:     } finally {
223:       this.loadingState.set(false);
224:     }
225:   }
226: 
227:   /**
228:    * é€‰æ‹©è“å›¾
229:    */
230:   selectBlueprint(blueprint: Blueprint | null): void {
231:     this.selectedBlueprintState.set(blueprint);
232:     if (blueprint) {
233:       this.loadConfigs(blueprint.id);
234:     } else {
235:       this.configsState.set([]);
236:     }
237:   }
238: 
239:   /**
240:    * åŠ è½½è“å›¾é…ç½®
241:    */
242:   async loadConfigs(blueprintId: string): Promise<BlueprintConfig[]> {
243:     this.loadingState.set(true);
244:     this.errorState.set(null);
245: 
246:     try {
247:       const configs = await firstValueFrom(this.blueprintConfigRepository.findByBlueprintId(blueprintId));
248:       this.configsState.set(configs);
249:       return configs;
250:     } catch (error) {
251:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½é…ç½®å¤±è´¥');
252:       throw error;
253:     } finally {
254:       this.loadingState.set(false);
255:     }
256:   }
257: 
258:   /**
259:    * è·å–é…ç½®å€¼
260:    */
261:   async getConfig(blueprintId: string, configKey: string): Promise<BlueprintConfig | null> {
262:     return await firstValueFrom(this.blueprintConfigRepository.findByConfigKey(blueprintId, configKey));
263:   }
264: 
265:   /**
266:    * è®¾ç½®é…ç½®
267:    */
268:   async setConfig(blueprintId: string, configKey: string, configValue: any, updatedBy?: string): Promise<BlueprintConfig> {
269:     this.loadingState.set(true);
270:     this.errorState.set(null);
271: 
272:     try {
273:       const config = await firstValueFrom(this.blueprintConfigRepository.upsertConfig(blueprintId, configKey, configValue, updatedBy));
274:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
275:       this.configsState.update(configs => {
276:         // æ³¨æ„ï¼šæ•°æ®åº“å­—æ®µæ˜¯ config_keyï¼Œä½† BaseRepository ä¼šè½¬æ¢ä¸º configKey
277:         const existing = configs.find(c => (c as any).configKey === configKey || (c as any).config_key === configKey);
278:         if (existing) {
279:           return configs.map(c => (c.id === config.id ? config : c));
280:         }
281:         return [...configs, config];
282:       });
283:       return config;
284:     } catch (error) {
285:       this.errorState.set(error instanceof Error ? error.message : 'è®¾ç½®é…ç½®å¤±è´¥');
286:       throw error;
287:     } finally {
288:       this.loadingState.set(false);
289:     }
290:   }
291: 
292:   /**
293:    * é‡ç½®çŠ¶æ€
294:    */
295:   reset(): void {
296:     this.blueprintsState.set([]);
297:     this.selectedBlueprintState.set(null);
298:     this.configsState.set([]);
299:     this.errorState.set(null);
300:   }
301: }
````

## File: src/app/shared/services/blueprint/branch.service.ts
````typescript
  1: import { Injectable, inject, signal, computed } from '@angular/core';
  2: import {
  3:   BlueprintBranchRepository,
  4:   BranchForkRepository,
  5:   BlueprintBranchInsert,
  6:   BlueprintBranchUpdate,
  7:   BranchForkInsert,
  8:   BranchType,
  9:   BranchStatus
 10: } from '@core';
 11: import { BlueprintBranch, BranchFork } from '@shared';
 12: import { Observable, firstValueFrom } from 'rxjs';
 13: 
 14: /**
 15:  * Branch Service
 16:  *
 17:  * æä¾›åˆ†æ”¯ç®¡ç†ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†
 18:  * å®ç° Git-like åˆ†æ”¯æ¨¡å‹ï¼šFork æœºåˆ¶ã€åˆ†æ”¯åŒæ­¥ç­‰
 19:  *
 20:  * @example
 21:  * ```typescript
 22:  * const branchService = inject(BranchService);
 23:  *
 24:  * // è®¢é˜…åˆ†æ”¯åˆ—è¡¨
 25:  * effect(() => {
 26:  *   console.log('Branches:', branchService.branches());
 27:  * });
 28:  *
 29:  * // Fork åˆ†æ”¯ç»™ç»„ç»‡
 30:  * await branchService.forkBranch('blueprint-id', 'org-id', 'branch-name');
 31:  * ```
 32:  */
 33: @Injectable({
 34:   providedIn: 'root'
 35: })
 36: export class BranchService {
 37:   private branchRepository = inject(BlueprintBranchRepository);
 38:   private branchForkRepository = inject(BranchForkRepository);
 39: 
 40:   // ä½¿ç”¨ Signals ç®¡ç†çŠ¶æ€
 41:   private branchesState = signal<BlueprintBranch[]>([]);
 42:   private selectedBranchState = signal<BlueprintBranch | null>(null);
 43:   private forksState = signal<BranchFork[]>([]);
 44:   private loadingState = signal<boolean>(false);
 45:   private errorState = signal<string | null>(null);
 46: 
 47:   // æš´éœ² ReadonlySignal ç»™ç»„ä»¶
 48:   readonly branches = this.branchesState.asReadonly();
 49:   readonly selectedBranch = this.selectedBranchState.asReadonly();
 50:   readonly forks = this.forksState.asReadonly();
 51:   readonly loading = this.loadingState.asReadonly();
 52:   readonly error = this.errorState.asReadonly();
 53: 
 54:   // Computed signals
 55:   readonly activeBranches = computed(() => this.branches().filter(b => b.status === BranchStatus.ACTIVE));
 56: 
 57:   readonly mergedBranches = computed(() => this.branches().filter(b => b.status === BranchStatus.MERGED));
 58: 
 59:   /**
 60:    * åŠ è½½æ‰€æœ‰åˆ†æ”¯
 61:    */
 62:   async loadBranches(): Promise<void> {
 63:     this.loadingState.set(true);
 64:     this.errorState.set(null);
 65: 
 66:     try {
 67:       const branches = await firstValueFrom(this.branchRepository.findAll());
 68:       this.branchesState.set(branches);
 69:     } catch (error) {
 70:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½åˆ†æ”¯åˆ—è¡¨å¤±è´¥');
 71:       throw error;
 72:     } finally {
 73:       this.loadingState.set(false);
 74:     }
 75:   }
 76: 
 77:   /**
 78:    * æ ¹æ®è“å›¾ ID åŠ è½½åˆ†æ”¯åˆ—è¡¨
 79:    */
 80:   async loadBranchesByBlueprintId(blueprintId: string): Promise<BlueprintBranch[]> {
 81:     this.loadingState.set(true);
 82:     this.errorState.set(null);
 83: 
 84:     try {
 85:       const branches = await firstValueFrom(this.branchRepository.findByBlueprintId(blueprintId));
 86:       this.branchesState.set(branches);
 87:       return branches;
 88:     } catch (error) {
 89:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½åˆ†æ”¯åˆ—è¡¨å¤±è´¥');
 90:       throw error;
 91:     } finally {
 92:       this.loadingState.set(false);
 93:     }
 94:   }
 95: 
 96:   /**
 97:    * æ ¹æ®ç»„ç»‡ ID åŠ è½½åˆ†æ”¯åˆ—è¡¨
 98:    */
 99:   async loadBranchesByOrganizationId(organizationId: string): Promise<BlueprintBranch[]> {
100:     this.loadingState.set(true);
101:     this.errorState.set(null);
102: 
103:     try {
104:       const branches = await firstValueFrom(this.branchRepository.findByOrganizationId(organizationId));
105:       this.branchesState.set(branches);
106:       return branches;
107:     } catch (error) {
108:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½åˆ†æ”¯åˆ—è¡¨å¤±è´¥');
109:       throw error;
110:     } finally {
111:       this.loadingState.set(false);
112:     }
113:   }
114: 
115:   /**
116:    * æ ¹æ® ID åŠ è½½åˆ†æ”¯
117:    */
118:   async loadBranchById(id: string): Promise<BlueprintBranch | null> {
119:     this.loadingState.set(true);
120:     this.errorState.set(null);
121: 
122:     try {
123:       const branch = await firstValueFrom(this.branchRepository.findById(id));
124:       if (branch) {
125:         this.selectedBranchState.set(branch);
126:         // åŒæ—¶åŠ è½½ Fork è®°å½•
127:         await this.loadForksByBranchId(id);
128:       }
129:       return branch;
130:     } catch (error) {
131:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½åˆ†æ”¯å¤±è´¥');
132:       throw error;
133:     } finally {
134:       this.loadingState.set(false);
135:     }
136:   }
137: 
138:   /**
139:    * Fork åˆ†æ”¯ç»™ç»„ç»‡ï¼ˆåˆ›å»ºç»„ç»‡åˆ†æ”¯ï¼‰
140:    *
141:    * @param blueprintId è“å›¾ ID
142:    * @param organizationId ç»„ç»‡ ID
143:    * @param branchName åˆ†æ”¯åç§°
144:    * @param branchType åˆ†æ”¯ç±»å‹
145:    * @param forkedBy Fork æ“ä½œè€… ID
146:    * @param notes å¤‡æ³¨
147:    * @returns åˆ›å»ºçš„åˆ†æ”¯
148:    */
149:   async forkBranch(
150:     blueprintId: string,
151:     organizationId: string,
152:     branchName: string,
153:     branchType: BranchType = BranchType.CONTRACTOR,
154:     forkedBy: string,
155:     notes?: string
156:   ): Promise<BlueprintBranch> {
157:     this.loadingState.set(true);
158:     this.errorState.set(null);
159: 
160:     try {
161:       // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åˆ†æ”¯
162:       const existing = await firstValueFrom(this.branchRepository.findByBlueprintAndOrganization(blueprintId, organizationId));
163: 
164:       if (existing) {
165:         throw new Error('è¯¥ç»„ç»‡å·²å­˜åœ¨åˆ†æ”¯');
166:       }
167: 
168:       // åˆ›å»ºåˆ†æ”¯
169:       // ä½¿ç”¨ç±»å‹æ–­è¨€ï¼Œå› ä¸º BaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ camelCase â†’ snake_case è½¬æ¢
170:       const branchData = {
171:         blueprintId,
172:         organizationId,
173:         branchName,
174:         branchType,
175:         status: BranchStatus.ACTIVE,
176:         notes
177:       } as any as BlueprintBranchInsert;
178: 
179:       const branch = await firstValueFrom(this.branchRepository.create(branchData));
180: 
181:       // åˆ›å»º Fork è®°å½•
182:       // ä½¿ç”¨ç±»å‹æ–­è¨€ï¼Œå› ä¸º BaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ camelCase â†’ snake_case è½¬æ¢
183:       const forkData = {
184:         blueprintId,
185:         branchId: branch.id,
186:         forkedBy,
187:         forkReason: notes
188:       } as any as BranchForkInsert;
189:       await firstValueFrom(this.branchForkRepository.create(forkData));
190: 
191:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
192:       this.branchesState.update(branches => [...branches, branch]);
193:       return branch;
194:     } catch (error) {
195:       this.errorState.set(error instanceof Error ? error.message : 'Fork åˆ†æ”¯å¤±è´¥');
196:       throw error;
197:     } finally {
198:       this.loadingState.set(false);
199:     }
200:   }
201: 
202:   /**
203:    * æ›´æ–°åˆ†æ”¯
204:    */
205:   async updateBranch(id: string, data: BlueprintBranchUpdate): Promise<BlueprintBranch> {
206:     this.loadingState.set(true);
207:     this.errorState.set(null);
208: 
209:     try {
210:       const branch = await firstValueFrom(this.branchRepository.update(id, data));
211:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
212:       this.branchesState.update(branches => branches.map(b => (b.id === id ? branch : b)));
213:       // å¦‚æœæ›´æ–°çš„æ˜¯å½“å‰é€‰ä¸­çš„åˆ†æ”¯ï¼Œä¹Ÿæ›´æ–°é€‰ä¸­çŠ¶æ€
214:       if (this.selectedBranch()?.id === id) {
215:         this.selectedBranchState.set(branch);
216:       }
217:       return branch;
218:     } catch (error) {
219:       this.errorState.set(error instanceof Error ? error.message : 'æ›´æ–°åˆ†æ”¯å¤±è´¥');
220:       throw error;
221:     } finally {
222:       this.loadingState.set(false);
223:     }
224:   }
225: 
226:   /**
227:    * åˆ é™¤åˆ†æ”¯
228:    */
229:   async deleteBranch(id: string): Promise<void> {
230:     this.loadingState.set(true);
231:     this.errorState.set(null);
232: 
233:     try {
234:       await firstValueFrom(this.branchRepository.delete(id));
235:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
236:       this.branchesState.update(branches => branches.filter(b => b.id !== id));
237:       // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„åˆ†æ”¯ï¼Œæ¸…ç©ºé€‰ä¸­çŠ¶æ€
238:       if (this.selectedBranch()?.id === id) {
239:         this.selectedBranchState.set(null);
240:         this.forksState.set([]);
241:       }
242:     } catch (error) {
243:       this.errorState.set(error instanceof Error ? error.message : 'åˆ é™¤åˆ†æ”¯å¤±è´¥');
244:       throw error;
245:     } finally {
246:       this.loadingState.set(false);
247:     }
248:   }
249: 
250:   /**
251:    * é€‰æ‹©åˆ†æ”¯
252:    */
253:   selectBranch(branch: BlueprintBranch | null): void {
254:     this.selectedBranchState.set(branch);
255:     if (branch) {
256:       this.loadForksByBranchId(branch.id);
257:     } else {
258:       this.forksState.set([]);
259:     }
260:   }
261: 
262:   /**
263:    * åŠ è½½åˆ†æ”¯çš„ Fork è®°å½•
264:    */
265:   async loadForksByBranchId(branchId: string): Promise<BranchFork[]> {
266:     this.loadingState.set(true);
267:     this.errorState.set(null);
268: 
269:     try {
270:       const forks = await firstValueFrom(this.branchForkRepository.findByBranchId(branchId));
271:       this.forksState.set(forks);
272:       return forks;
273:     } catch (error) {
274:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½ Fork è®°å½•å¤±è´¥');
275:       throw error;
276:     } finally {
277:       this.loadingState.set(false);
278:     }
279:   }
280: 
281:   /**
282:    * åŒæ­¥ä¸»åˆ†æ”¯æ•°æ®åˆ°åˆ†æ”¯ï¼ˆæ›´æ–° last_sync_atï¼‰
283:    *
284:    * @param branchId åˆ†æ”¯ ID
285:    */
286:   async syncFromMainBranch(branchId: string): Promise<void> {
287:     this.loadingState.set(true);
288:     this.errorState.set(null);
289: 
290:     try {
291:       await this.updateBranch(branchId, {
292:         lastSyncAt: new Date().toISOString()
293:       } as any);
294:     } catch (error) {
295:       this.errorState.set(error instanceof Error ? error.message : 'åŒæ­¥ä¸»åˆ†æ”¯æ•°æ®å¤±è´¥');
296:       throw error;
297:     } finally {
298:       this.loadingState.set(false);
299:     }
300:   }
301: 
302:   /**
303:    * å…³é—­åˆ†æ”¯
304:    */
305:   async closeBranch(branchId: string): Promise<BlueprintBranch> {
306:     return await this.updateBranch(branchId, {
307:       status: BranchStatus.CLOSED
308:     } as any);
309:   }
310: 
311:   /**
312:    * æ ‡è®°åˆ†æ”¯ä¸ºå·²åˆå¹¶
313:    */
314:   async markBranchAsMerged(branchId: string): Promise<BlueprintBranch> {
315:     return await this.updateBranch(branchId, {
316:       status: BranchStatus.MERGED
317:     } as any);
318:   }
319: 
320:   /**
321:    * é‡ç½®çŠ¶æ€
322:    */
323:   reset(): void {
324:     this.branchesState.set([]);
325:     this.selectedBranchState.set(null);
326:     this.forksState.set([]);
327:     this.errorState.set(null);
328:   }
329: }
````

## File: src/app/shared/services/blueprint/pull-request.service.ts
````typescript
  1: import { Injectable, inject, signal, computed } from '@angular/core';
  2: import { PullRequestRepository, PullRequestInsert, PullRequestUpdate, PRStatus } from '@core';
  3: import { PullRequest } from '@shared';
  4: import { Observable, firstValueFrom } from 'rxjs';
  5: 
  6: /**
  7:  * PullRequest Service
  8:  *
  9:  * æä¾› Pull Request ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†
 10:  * å®ç° Git-like PR æœºåˆ¶ï¼šåˆ›å»ºã€å®¡æ ¸ã€åˆå¹¶ï¼ˆæ›´æ–°æ‰¿æ½å­—æ®µï¼‰
 11:  *
 12:  * @example
 13:  * ```typescript
 14:  * const prService = inject(PullRequestService);
 15:  *
 16:  * // è®¢é˜… PR åˆ—è¡¨
 17:  * effect(() => {
 18:  *   console.log('Pull Requests:', prService.pullRequests());
 19:  * });
 20:  *
 21:  * // åˆ›å»º PR
 22:  * await prService.createPullRequest({
 23:  *   blueprintId: 'blueprint-id',
 24:  *   branchId: 'branch-id',
 25:  *   title: 'æäº¤æ‰§è¡Œæ•°æ®',
 26:  *   submittedBy: 'user-id'
 27:  * });
 28:  * ```
 29:  */
 30: @Injectable({
 31:   providedIn: 'root'
 32: })
 33: export class PullRequestService {
 34:   private pullRequestRepository = inject(PullRequestRepository);
 35: 
 36:   // ä½¿ç”¨ Signals ç®¡ç†çŠ¶æ€
 37:   private pullRequestsState = signal<PullRequest[]>([]);
 38:   private selectedPullRequestState = signal<PullRequest | null>(null);
 39:   private loadingState = signal<boolean>(false);
 40:   private errorState = signal<string | null>(null);
 41: 
 42:   // æš´éœ² ReadonlySignal ç»™ç»„ä»¶
 43:   readonly pullRequests = this.pullRequestsState.asReadonly();
 44:   readonly selectedPullRequest = this.selectedPullRequestState.asReadonly();
 45:   readonly loading = this.loadingState.asReadonly();
 46:   readonly error = this.errorState.asReadonly();
 47: 
 48:   // Computed signals
 49:   readonly openPullRequests = computed(() => this.pullRequests().filter(pr => pr.status === PRStatus.OPEN));
 50: 
 51:   readonly reviewingPullRequests = computed(() => this.pullRequests().filter(pr => pr.status === PRStatus.REVIEWING));
 52: 
 53:   readonly approvedPullRequests = computed(() => this.pullRequests().filter(pr => pr.status === PRStatus.APPROVED));
 54: 
 55:   readonly mergedPullRequests = computed(() => this.pullRequests().filter(pr => pr.status === PRStatus.MERGED));
 56: 
 57:   /**
 58:    * åŠ è½½æ‰€æœ‰ Pull Request
 59:    */
 60:   async loadPullRequests(): Promise<void> {
 61:     this.loadingState.set(true);
 62:     this.errorState.set(null);
 63: 
 64:     try {
 65:       const pullRequests = await firstValueFrom(this.pullRequestRepository.findAll());
 66:       this.pullRequestsState.set(pullRequests);
 67:     } catch (error) {
 68:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½ Pull Request åˆ—è¡¨å¤±è´¥');
 69:       throw error;
 70:     } finally {
 71:       this.loadingState.set(false);
 72:     }
 73:   }
 74: 
 75:   /**
 76:    * æ ¹æ® ID åŠ è½½ Pull Request
 77:    */
 78:   async loadPullRequestById(id: string): Promise<PullRequest | null> {
 79:     this.loadingState.set(true);
 80:     this.errorState.set(null);
 81: 
 82:     try {
 83:       const pullRequest = await firstValueFrom(this.pullRequestRepository.findById(id));
 84:       if (pullRequest) {
 85:         this.selectedPullRequestState.set(pullRequest);
 86:       }
 87:       return pullRequest;
 88:     } catch (error) {
 89:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½ Pull Request å¤±è´¥');
 90:       throw error;
 91:     } finally {
 92:       this.loadingState.set(false);
 93:     }
 94:   }
 95: 
 96:   /**
 97:    * æ ¹æ®è“å›¾ ID åŠ è½½ Pull Request åˆ—è¡¨
 98:    */
 99:   async loadPullRequestsByBlueprintId(blueprintId: string): Promise<PullRequest[]> {
100:     this.loadingState.set(true);
101:     this.errorState.set(null);
102: 
103:     try {
104:       const pullRequests = await firstValueFrom(this.pullRequestRepository.findByBlueprintId(blueprintId));
105:       this.pullRequestsState.set(pullRequests);
106:       return pullRequests;
107:     } catch (error) {
108:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½ Pull Request åˆ—è¡¨å¤±è´¥');
109:       throw error;
110:     } finally {
111:       this.loadingState.set(false);
112:     }
113:   }
114: 
115:   /**
116:    * æ ¹æ®åˆ†æ”¯ ID åŠ è½½ Pull Request åˆ—è¡¨
117:    */
118:   async loadPullRequestsByBranchId(branchId: string): Promise<PullRequest[]> {
119:     this.loadingState.set(true);
120:     this.errorState.set(null);
121: 
122:     try {
123:       const pullRequests = await firstValueFrom(this.pullRequestRepository.findByBranchId(branchId));
124:       this.pullRequestsState.set(pullRequests);
125:       return pullRequests;
126:     } catch (error) {
127:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½ Pull Request åˆ—è¡¨å¤±è´¥');
128:       throw error;
129:     } finally {
130:       this.loadingState.set(false);
131:     }
132:   }
133: 
134:   /**
135:    * åˆ›å»º Pull Request
136:    *
137:    * @param data PR æ•°æ®
138:    * @returns åˆ›å»ºçš„ PR
139:    */
140:   async createPullRequest(data: PullRequestInsert): Promise<PullRequest> {
141:     this.loadingState.set(true);
142:     this.errorState.set(null);
143: 
144:     try {
145:       const pullRequest = await firstValueFrom(
146:         this.pullRequestRepository.create({
147:           ...data,
148:           status: PRStatus.OPEN
149:         } as any)
150:       );
151:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
152:       this.pullRequestsState.update(prs => [...prs, pullRequest]);
153:       return pullRequest;
154:     } catch (error) {
155:       this.errorState.set(error instanceof Error ? error.message : 'åˆ›å»º Pull Request å¤±è´¥');
156:       throw error;
157:     } finally {
158:       this.loadingState.set(false);
159:     }
160:   }
161: 
162:   /**
163:    * æ›´æ–° Pull Request
164:    */
165:   async updatePullRequest(id: string, data: PullRequestUpdate): Promise<PullRequest> {
166:     this.loadingState.set(true);
167:     this.errorState.set(null);
168: 
169:     try {
170:       const pullRequest = await firstValueFrom(this.pullRequestRepository.update(id, data));
171:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
172:       this.pullRequestsState.update(prs => prs.map(pr => (pr.id === id ? pullRequest : pr)));
173:       // å¦‚æœæ›´æ–°çš„æ˜¯å½“å‰é€‰ä¸­çš„ PRï¼Œä¹Ÿæ›´æ–°é€‰ä¸­çŠ¶æ€
174:       if (this.selectedPullRequest()?.id === id) {
175:         this.selectedPullRequestState.set(pullRequest);
176:       }
177:       return pullRequest;
178:     } catch (error) {
179:       this.errorState.set(error instanceof Error ? error.message : 'æ›´æ–° Pull Request å¤±è´¥');
180:       throw error;
181:     } finally {
182:       this.loadingState.set(false);
183:     }
184:   }
185: 
186:   /**
187:    * åˆ é™¤ Pull Request
188:    */
189:   async deletePullRequest(id: string): Promise<void> {
190:     this.loadingState.set(true);
191:     this.errorState.set(null);
192: 
193:     try {
194:       await firstValueFrom(this.pullRequestRepository.delete(id));
195:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
196:       this.pullRequestsState.update(prs => prs.filter(pr => pr.id !== id));
197:       // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„ PRï¼Œæ¸…ç©ºé€‰ä¸­çŠ¶æ€
198:       if (this.selectedPullRequest()?.id === id) {
199:         this.selectedPullRequestState.set(null);
200:       }
201:     } catch (error) {
202:       this.errorState.set(error instanceof Error ? error.message : 'åˆ é™¤ Pull Request å¤±è´¥');
203:       throw error;
204:     } finally {
205:       this.loadingState.set(false);
206:     }
207:   }
208: 
209:   /**
210:    * é€‰æ‹© Pull Request
211:    */
212:   selectPullRequest(pullRequest: PullRequest | null): void {
213:     this.selectedPullRequestState.set(pullRequest);
214:   }
215: 
216:   /**
217:    * å¼€å§‹å®¡æ ¸ PRï¼ˆçŠ¶æ€å˜ä¸º reviewingï¼‰
218:    *
219:    * @param prId PR ID
220:    * @param reviewedBy å®¡æ ¸è€… ID
221:    */
222:   async startReview(prId: string, reviewedBy: string): Promise<PullRequest> {
223:     return await this.updatePullRequest(prId, {
224:       status: PRStatus.REVIEWING,
225:       reviewedBy
226:     } as any);
227:   }
228: 
229:   /**
230:    * æ‰¹å‡† PRï¼ˆçŠ¶æ€å˜ä¸º approvedï¼‰
231:    *
232:    * @param prId PR ID
233:    * @param reviewedBy å®¡æ ¸è€… ID
234:    */
235:   async approvePullRequest(prId: string, reviewedBy: string): Promise<PullRequest> {
236:     return await this.updatePullRequest(prId, {
237:       status: PRStatus.APPROVED,
238:       reviewedBy,
239:       reviewedAt: new Date().toISOString()
240:     } as any);
241:   }
242: 
243:   /**
244:    * æ‹’ç» PRï¼ˆçŠ¶æ€å˜ä¸º rejectedï¼‰
245:    *
246:    * @param prId PR ID
247:    * @param reviewedBy å®¡æ ¸è€… ID
248:    */
249:   async rejectPullRequest(prId: string, reviewedBy: string): Promise<PullRequest> {
250:     return await this.updatePullRequest(prId, {
251:       status: PRStatus.REJECTED,
252:       reviewedBy,
253:       reviewedAt: new Date().toISOString()
254:     } as any);
255:   }
256: 
257:   /**
258:    * åˆå¹¶ PRï¼ˆçŠ¶æ€å˜ä¸º mergedï¼Œæ›´æ–°æ‰¿æ½å­—æ®µï¼‰
259:    *
260:    * æ³¨æ„ï¼šå®é™…çš„åˆå¹¶é€»è¾‘ï¼ˆæ›´æ–°ä»»åŠ¡æ‰¿æ½å­—æ®µï¼‰åº”è¯¥åœ¨ Service å±‚æˆ–æ›´é«˜å±‚å®ç°
261:    * è¿™é‡Œåªæ›´æ–° PR çŠ¶æ€
262:    *
263:    * @param prId PR ID
264:    * @param mergedBy åˆå¹¶è€… ID
265:    * @param changesSummary å˜æ›´æ‘˜è¦ï¼ˆç”¨äºè®°å½•åˆå¹¶çš„å†…å®¹ï¼‰
266:    */
267:   async mergePullRequest(prId: string, mergedBy: string, changesSummary?: any): Promise<PullRequest> {
268:     return await this.updatePullRequest(prId, {
269:       status: PRStatus.MERGED,
270:       mergedBy,
271:       mergedAt: new Date().toISOString(),
272:       changesSummary: changesSummary || {}
273:     } as any);
274:   }
275: 
276:   /**
277:    * å…³é—­ PRï¼ˆçŠ¶æ€å˜ä¸º closedï¼‰
278:    *
279:    * @param prId PR ID
280:    */
281:   async closePullRequest(prId: string): Promise<PullRequest> {
282:     return await this.updatePullRequest(prId, {
283:       status: PRStatus.CLOSED
284:     } as any);
285:   }
286: 
287:   /**
288:    * é‡ç½®çŠ¶æ€
289:    */
290:   reset(): void {
291:     this.pullRequestsState.set([]);
292:     this.selectedPullRequestState.set(null);
293:     this.errorState.set(null);
294:   }
295: }
````

## File: src/app/shared/services/collaboration/collaboration.service.spec.ts
````typescript
  1: import { TestBed } from '@angular/core/testing';
  2: import { OrganizationCollaborationRepository, CollaborationType, CollaborationStatus } from '@core';
  3: import { OrganizationCollaboration } from '@shared';
  4: import { of, throwError } from 'rxjs';
  5: 
  6: import { CollaborationService } from './collaboration.service';
  7: 
  8: describe('CollaborationService', () => {
  9:   let service: CollaborationService;
 10:   let repository: jasmine.SpyObj<OrganizationCollaborationRepository>;
 11: 
 12:   const mockCollaboration: OrganizationCollaboration = {
 13:     id: 'collab-1',
 14:     blueprint_id: 'blueprint-1',
 15:     owner_org_id: 'org-1',
 16:     collaborator_org_id: 'org-2',
 17:     collaboration_type: CollaborationType.CONTRACTOR,
 18:     status: CollaborationStatus.ACTIVE,
 19:     contract_start_date: '2025-01-01',
 20:     contract_end_date: '2025-12-31',
 21:     notes: 'Test collaboration',
 22:     created_at: '2025-01-01T00:00:00Z',
 23:     updated_at: '2025-01-01T00:00:00Z'
 24:   } as OrganizationCollaboration;
 25: 
 26:   const mockCollaborations: OrganizationCollaboration[] = [
 27:     mockCollaboration,
 28:     {
 29:       ...mockCollaboration,
 30:       id: 'collab-2',
 31:       status: CollaborationStatus.PENDING,
 32:       collaboration_type: CollaborationType.SUBCONTRACTOR
 33:     }
 34:   ];
 35: 
 36:   beforeEach(() => {
 37:     const repositorySpy = jasmine.createSpyObj('OrganizationCollaborationRepository', [
 38:       'findAll',
 39:       'findById',
 40:       'findByBlueprintId',
 41:       'findByOwnerOrgId',
 42:       'findByCollaboratorOrgId',
 43:       'findByCollaborationType',
 44:       'findByStatus',
 45:       'create',
 46:       'update',
 47:       'delete'
 48:     ]);
 49: 
 50:     TestBed.configureTestingModule({
 51:       providers: [CollaborationService, { provide: OrganizationCollaborationRepository, useValue: repositorySpy }]
 52:     });
 53: 
 54:     service = TestBed.inject(CollaborationService);
 55:     repository = TestBed.inject(OrganizationCollaborationRepository) as jasmine.SpyObj<OrganizationCollaborationRepository>;
 56:   });
 57: 
 58:   it('should be created', () => {
 59:     expect(service).toBeTruthy();
 60:   });
 61: 
 62:   describe('Initial state', () => {
 63:     it('should have empty collaborations', () => {
 64:       expect(service.collaborations().length).toBe(0);
 65:     });
 66: 
 67:     it('should have null selected collaboration', () => {
 68:       expect(service.selectedCollaboration()).toBeNull();
 69:     });
 70: 
 71:     it('should have false loading state', () => {
 72:       expect(service.loading()).toBe(false);
 73:     });
 74: 
 75:     it('should have null error state', () => {
 76:       expect(service.error()).toBeNull();
 77:     });
 78:   });
 79: 
 80:   describe('loadCollaborations', () => {
 81:     it('should load collaborations successfully', async () => {
 82:       repository.findAll.and.returnValue(of(mockCollaborations));
 83: 
 84:       await service.loadCollaborations();
 85: 
 86:       expect(service.collaborations().length).toBe(2);
 87:       expect(service.collaborations()[0].id).toBe('collab-1');
 88:       expect(service.loading()).toBe(false);
 89:       expect(service.error()).toBeNull();
 90:     });
 91: 
 92:     it('should set loading state during load', async () => {
 93:       repository.findAll.and.returnValue(of(mockCollaborations));
 94: 
 95:       const loadPromise = service.loadCollaborations();
 96:       expect(service.loading()).toBe(true);
 97: 
 98:       await loadPromise;
 99:       expect(service.loading()).toBe(false);
100:     });
101: 
102:     it('should handle error when loading fails', async () => {
103:       const error = new Error('Load failed');
104:       repository.findAll.and.returnValue(throwError(() => error));
105: 
106:       try {
107:         await service.loadCollaborations();
108:         fail('should have thrown error');
109:       } catch (_e) {
110:         expect(service.error()).toBe('Load failed');
111:         expect(service.loading()).toBe(false);
112:       }
113:     });
114:   });
115: 
116:   describe('loadCollaborationById', () => {
117:     it('should load collaboration by id successfully', async () => {
118:       repository.findById.and.returnValue(of(mockCollaboration));
119: 
120:       const result = await service.loadCollaborationById('collab-1');
121: 
122:       expect(result).toEqual(mockCollaboration);
123:       expect(service.selectedCollaboration()).toEqual(mockCollaboration);
124:       expect(service.loading()).toBe(false);
125:     });
126: 
127:     it('should return null when collaboration not found', async () => {
128:       repository.findById.and.returnValue(of(null));
129: 
130:       const result = await service.loadCollaborationById('non-existent');
131: 
132:       expect(result).toBeNull();
133:       expect(service.selectedCollaboration()).toBeNull();
134:     });
135: 
136:     it('should handle error when loading by id fails', async () => {
137:       const error = new Error('Not found');
138:       repository.findById.and.returnValue(throwError(() => error));
139: 
140:       try {
141:         await service.loadCollaborationById('collab-1');
142:         fail('should have thrown error');
143:       } catch (_e) {
144:         expect(service.error()).toBe('Not found');
145:       }
146:     });
147:   });
148: 
149:   describe('loadCollaborationsByBlueprintId', () => {
150:     it('should load collaborations by blueprint id', async () => {
151:       repository.findByBlueprintId.and.returnValue(of(mockCollaborations));
152: 
153:       const result = await service.loadCollaborationsByBlueprintId('blueprint-1');
154: 
155:       expect(result.length).toBe(2);
156:       expect(repository.findByBlueprintId).toHaveBeenCalledWith('blueprint-1');
157:     });
158:   });
159: 
160:   describe('loadCollaborationsByOwnerOrgId', () => {
161:     it('should load collaborations by owner org id', async () => {
162:       repository.findByOwnerOrgId.and.returnValue(of(mockCollaborations));
163: 
164:       const result = await service.loadCollaborationsByOwnerOrgId('org-1');
165: 
166:       expect(result.length).toBe(2);
167:       expect(repository.findByOwnerOrgId).toHaveBeenCalledWith('org-1');
168:     });
169:   });
170: 
171:   describe('loadCollaborationsByCollaboratorOrgId', () => {
172:     it('should load collaborations by collaborator org id', async () => {
173:       repository.findByCollaboratorOrgId.and.returnValue(of(mockCollaborations));
174: 
175:       const result = await service.loadCollaborationsByCollaboratorOrgId('org-2');
176: 
177:       expect(result.length).toBe(2);
178:       expect(repository.findByCollaboratorOrgId).toHaveBeenCalledWith('org-2');
179:     });
180:   });
181: 
182:   describe('loadCollaborationsByType', () => {
183:     it('should load collaborations by type', async () => {
184:       repository.findByCollaborationType.and.returnValue(of([mockCollaboration]));
185: 
186:       const result = await service.loadCollaborationsByType(CollaborationType.CONTRACTOR);
187: 
188:       expect(result.length).toBe(1);
189:       expect(repository.findByCollaborationType).toHaveBeenCalledWith(CollaborationType.CONTRACTOR);
190:     });
191:   });
192: 
193:   describe('loadCollaborationsByStatus', () => {
194:     it('should load collaborations by status', async () => {
195:       repository.findByStatus.and.returnValue(of([mockCollaboration]));
196: 
197:       const result = await service.loadCollaborationsByStatus(CollaborationStatus.ACTIVE);
198: 
199:       expect(result.length).toBe(1);
200:       expect(repository.findByStatus).toHaveBeenCalledWith(CollaborationStatus.ACTIVE);
201:     });
202:   });
203: 
204:   describe('createCollaboration', () => {
205:     it('should create collaboration successfully', async () => {
206:       const newCollaboration = { ...mockCollaboration, id: 'collab-new' };
207:       repository.create.and.returnValue(of(newCollaboration));
208: 
209:       const result = await service.createCollaboration({
210:         blueprint_id: 'blueprint-1',
211:         owner_org_id: 'org-1',
212:         collaborator_org_id: 'org-2',
213:         collaboration_type: CollaborationType.CONTRACTOR
214:       });
215: 
216:       expect(result).toEqual(newCollaboration);
217:       expect(service.collaborations().length).toBe(1);
218:       expect(service.collaborations()[0].id).toBe('collab-new');
219:     });
220: 
221:     it('should handle error when creating fails', async () => {
222:       const error = new Error('Create failed');
223:       repository.create.and.returnValue(throwError(() => error));
224: 
225:       try {
226:         await service.createCollaboration({
227:           blueprint_id: 'blueprint-1',
228:           owner_org_id: 'org-1',
229:           collaborator_org_id: 'org-2',
230:           collaboration_type: CollaborationType.CONTRACTOR
231:         });
232:         fail('should have thrown error');
233:       } catch (_e) {
234:         expect(service.error()).toBe('Create failed');
235:       }
236:     });
237:   });
238: 
239:   describe('updateCollaboration', () => {
240:     beforeEach(() => {
241:       service['collaborationsState'].set(mockCollaborations);
242:     });
243: 
244:     it('should update collaboration successfully', async () => {
245:       const updated = { ...mockCollaboration, notes: 'Updated notes' };
246:       repository.update.and.returnValue(of(updated));
247: 
248:       const result = await service.updateCollaboration('collab-1', { notes: 'Updated notes' });
249: 
250:       expect(result).toEqual(updated);
251:       expect(service.collaborations()[0].notes).toBe('Updated notes');
252:     });
253: 
254:     it('should update selected collaboration if it matches', async () => {
255:       service.selectCollaboration(mockCollaboration);
256:       const updated = { ...mockCollaboration, notes: 'Updated notes' };
257:       repository.update.and.returnValue(of(updated));
258: 
259:       await service.updateCollaboration('collab-1', { notes: 'Updated notes' });
260: 
261:       expect(service.selectedCollaboration()?.notes).toBe('Updated notes');
262:     });
263: 
264:     it('should handle error when updating fails', async () => {
265:       const error = new Error('Update failed');
266:       repository.update.and.returnValue(throwError(() => error));
267: 
268:       try {
269:         await service.updateCollaboration('collab-1', { notes: 'Updated' });
270:         fail('should have thrown error');
271:       } catch (_e) {
272:         expect(service.error()).toBe('Update failed');
273:       }
274:     });
275:   });
276: 
277:   describe('deleteCollaboration', () => {
278:     beforeEach(() => {
279:       service['collaborationsState'].set(mockCollaborations);
280:     });
281: 
282:     it('should delete collaboration successfully', async () => {
283:       repository.delete.and.returnValue(of(undefined));
284: 
285:       await service.deleteCollaboration('collab-1');
286: 
287:       expect(service.collaborations().length).toBe(1);
288:       expect(service.collaborations()[0].id).toBe('collab-2');
289:     });
290: 
291:     it('should clear selected collaboration if deleted', async () => {
292:       service.selectCollaboration(mockCollaboration);
293:       repository.delete.and.returnValue(of(undefined));
294: 
295:       await service.deleteCollaboration('collab-1');
296: 
297:       expect(service.selectedCollaboration()).toBeNull();
298:     });
299: 
300:     it('should handle error when deleting fails', async () => {
301:       const error = new Error('Delete failed');
302:       repository.delete.and.returnValue(throwError(() => error));
303: 
304:       try {
305:         await service.deleteCollaboration('collab-1');
306:         fail('should have thrown error');
307:       } catch (_e) {
308:         expect(service.error()).toBe('Delete failed');
309:       }
310:     });
311:   });
312: 
313:   describe('selectCollaboration', () => {
314:     it('should select collaboration', () => {
315:       service.selectCollaboration(mockCollaboration);
316: 
317:       expect(service.selectedCollaboration()).toEqual(mockCollaboration);
318:     });
319: 
320:     it('should clear selection when null', () => {
321:       service.selectCollaboration(mockCollaboration);
322:       service.selectCollaboration(null);
323: 
324:       expect(service.selectedCollaboration()).toBeNull();
325:     });
326:   });
327: 
328:   describe('reset', () => {
329:     it('should reset all state', () => {
330:       service['collaborationsState'].set(mockCollaborations);
331:       service.selectCollaboration(mockCollaboration);
332:       service['errorState'].set('Some error');
333: 
334:       service.reset();
335: 
336:       expect(service.collaborations().length).toBe(0);
337:       expect(service.selectedCollaboration()).toBeNull();
338:       expect(service.error()).toBeNull();
339:     });
340:   });
341: 
342:   describe('Computed signals', () => {
343:     beforeEach(() => {
344:       service['collaborationsState'].set(mockCollaborations);
345:     });
346: 
347:     it('should compute activeCollaborations', () => {
348:       expect(service.activeCollaborations().length).toBe(1);
349:       expect(service.activeCollaborations()[0].status).toBe(CollaborationStatus.ACTIVE);
350:     });
351: 
352:     it('should compute pendingCollaborations', () => {
353:       expect(service.pendingCollaborations().length).toBe(1);
354:       expect(service.pendingCollaborations()[0].status).toBe(CollaborationStatus.PENDING);
355:     });
356: 
357:     it('should compute contractorCollaborations', () => {
358:       expect(service.contractorCollaborations().length).toBe(1);
359:       expect(service.contractorCollaborations()[0].collaboration_type).toBe(CollaborationType.CONTRACTOR);
360:     });
361:   });
362: });
````

## File: src/app/shared/services/collaboration/collaboration.service.ts
````typescript
  1: import { Injectable, inject, signal, computed } from '@angular/core';
  2: import {
  3:   OrganizationCollaborationRepository,
  4:   OrganizationCollaborationInsert,
  5:   OrganizationCollaborationUpdate,
  6:   CollaborationType,
  7:   CollaborationStatus
  8: } from '@core';
  9: import { OrganizationCollaboration } from '@shared';
 10: import { firstValueFrom } from 'rxjs';
 11: 
 12: /**
 13:  * Collaboration Service
 14:  *
 15:  * æä¾›ç»„ç»‡åä½œå…³ç³»ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†
 16:  * ä½¿ç”¨ Signals ç®¡ç†çŠ¶æ€ï¼Œæš´éœ² ReadonlySignal ç»™ç»„ä»¶
 17:  *
 18:  * @example
 19:  * ```typescript
 20:  * const collaborationService = inject(CollaborationService);
 21:  *
 22:  * // è®¢é˜…åä½œå…³ç³»åˆ—è¡¨
 23:  * effect(() => {
 24:  *   console.log('Collaborations:', collaborationService.collaborations());
 25:  * });
 26:  *
 27:  * // åŠ è½½åä½œå…³ç³»åˆ—è¡¨
 28:  * await collaborationService.loadCollaborations();
 29:  * ```
 30:  */
 31: @Injectable({
 32:   providedIn: 'root'
 33: })
 34: export class CollaborationService {
 35:   private collaborationRepository = inject(OrganizationCollaborationRepository);
 36: 
 37:   // ä½¿ç”¨ Signals ç®¡ç†çŠ¶æ€
 38:   private collaborationsState = signal<OrganizationCollaboration[]>([]);
 39:   private selectedCollaborationState = signal<OrganizationCollaboration | null>(null);
 40:   private loadingState = signal<boolean>(false);
 41:   private errorState = signal<string | null>(null);
 42: 
 43:   // æš´éœ² ReadonlySignal ç»™ç»„ä»¶
 44:   readonly collaborations = this.collaborationsState.asReadonly();
 45:   readonly selectedCollaboration = this.selectedCollaborationState.asReadonly();
 46:   readonly loading = this.loadingState.asReadonly();
 47:   readonly error = this.errorState.asReadonly();
 48: 
 49:   // Computed signals
 50:   readonly activeCollaborations = computed(() => this.collaborations().filter(c => c.status === CollaborationStatus.ACTIVE));
 51: 
 52:   readonly pendingCollaborations = computed(() => this.collaborations().filter(c => c.status === CollaborationStatus.PENDING));
 53: 
 54:   readonly contractorCollaborations = computed(() =>
 55:     this.collaborations().filter(c => c.collaboration_type === CollaborationType.CONTRACTOR)
 56:   );
 57: 
 58:   /**
 59:    * åŠ è½½æ‰€æœ‰åä½œå…³ç³»
 60:    */
 61:   async loadCollaborations(): Promise<void> {
 62:     this.loadingState.set(true);
 63:     this.errorState.set(null);
 64: 
 65:     try {
 66:       const collaborations = await firstValueFrom(this.collaborationRepository.findAll());
 67:       this.collaborationsState.set(collaborations);
 68:     } catch (error) {
 69:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½åä½œå…³ç³»åˆ—è¡¨å¤±è´¥');
 70:       throw error;
 71:     } finally {
 72:       this.loadingState.set(false);
 73:     }
 74:   }
 75: 
 76:   /**
 77:    * æ ¹æ® ID åŠ è½½åä½œå…³ç³»
 78:    */
 79:   async loadCollaborationById(id: string): Promise<OrganizationCollaboration | null> {
 80:     this.loadingState.set(true);
 81:     this.errorState.set(null);
 82: 
 83:     try {
 84:       const collaboration = await firstValueFrom(this.collaborationRepository.findById(id));
 85:       if (collaboration) {
 86:         this.selectedCollaborationState.set(collaboration);
 87:       }
 88:       return collaboration;
 89:     } catch (error) {
 90:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½åä½œå…³ç³»å¤±è´¥');
 91:       throw error;
 92:     } finally {
 93:       this.loadingState.set(false);
 94:     }
 95:   }
 96: 
 97:   /**
 98:    * æ ¹æ®è“å›¾ ID åŠ è½½åä½œå…³ç³»
 99:    */
100:   async loadCollaborationsByBlueprintId(blueprintId: string): Promise<OrganizationCollaboration[]> {
101:     this.loadingState.set(true);
102:     this.errorState.set(null);
103: 
104:     try {
105:       const collaborations = await firstValueFrom(this.collaborationRepository.findByBlueprintId(blueprintId));
106:       return collaborations;
107:     } catch (error) {
108:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½åä½œå…³ç³»åˆ—è¡¨å¤±è´¥');
109:       throw error;
110:     } finally {
111:       this.loadingState.set(false);
112:     }
113:   }
114: 
115:   /**
116:    * æ ¹æ®æ‹¥æœ‰è€…ç»„ç»‡ ID åŠ è½½åä½œå…³ç³»
117:    */
118:   async loadCollaborationsByOwnerOrgId(ownerOrgId: string): Promise<OrganizationCollaboration[]> {
119:     this.loadingState.set(true);
120:     this.errorState.set(null);
121: 
122:     try {
123:       const collaborations = await firstValueFrom(this.collaborationRepository.findByOwnerOrgId(ownerOrgId));
124:       return collaborations;
125:     } catch (error) {
126:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½åä½œå…³ç³»åˆ—è¡¨å¤±è´¥');
127:       throw error;
128:     } finally {
129:       this.loadingState.set(false);
130:     }
131:   }
132: 
133:   /**
134:    * æ ¹æ®åä½œç»„ç»‡ ID åŠ è½½åä½œå…³ç³»
135:    */
136:   async loadCollaborationsByCollaboratorOrgId(collaboratorOrgId: string): Promise<OrganizationCollaboration[]> {
137:     this.loadingState.set(true);
138:     this.errorState.set(null);
139: 
140:     try {
141:       const collaborations = await firstValueFrom(this.collaborationRepository.findByCollaboratorOrgId(collaboratorOrgId));
142:       return collaborations;
143:     } catch (error) {
144:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½åä½œå…³ç³»åˆ—è¡¨å¤±è´¥');
145:       throw error;
146:     } finally {
147:       this.loadingState.set(false);
148:     }
149:   }
150: 
151:   /**
152:    * æ ¹æ®åä½œç±»å‹åŠ è½½åä½œå…³ç³»
153:    */
154:   async loadCollaborationsByType(collaborationType: CollaborationType): Promise<OrganizationCollaboration[]> {
155:     this.loadingState.set(true);
156:     this.errorState.set(null);
157: 
158:     try {
159:       const collaborations = await firstValueFrom(this.collaborationRepository.findByCollaborationType(collaborationType));
160:       return collaborations;
161:     } catch (error) {
162:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½åä½œå…³ç³»åˆ—è¡¨å¤±è´¥');
163:       throw error;
164:     } finally {
165:       this.loadingState.set(false);
166:     }
167:   }
168: 
169:   /**
170:    * æ ¹æ®çŠ¶æ€åŠ è½½åä½œå…³ç³»
171:    */
172:   async loadCollaborationsByStatus(status: CollaborationStatus): Promise<OrganizationCollaboration[]> {
173:     this.loadingState.set(true);
174:     this.errorState.set(null);
175: 
176:     try {
177:       const collaborations = await firstValueFrom(this.collaborationRepository.findByStatus(status));
178:       return collaborations;
179:     } catch (error) {
180:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½åä½œå…³ç³»åˆ—è¡¨å¤±è´¥');
181:       throw error;
182:     } finally {
183:       this.loadingState.set(false);
184:     }
185:   }
186: 
187:   /**
188:    * åˆ›å»ºåä½œå…³ç³»
189:    */
190:   async createCollaboration(data: OrganizationCollaborationInsert): Promise<OrganizationCollaboration> {
191:     this.loadingState.set(true);
192:     this.errorState.set(null);
193: 
194:     try {
195:       const collaboration = await firstValueFrom(this.collaborationRepository.create(data));
196:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
197:       this.collaborationsState.update(collaborations => [...collaborations, collaboration]);
198:       return collaboration;
199:     } catch (error) {
200:       this.errorState.set(error instanceof Error ? error.message : 'åˆ›å»ºåä½œå…³ç³»å¤±è´¥');
201:       throw error;
202:     } finally {
203:       this.loadingState.set(false);
204:     }
205:   }
206: 
207:   /**
208:    * æ›´æ–°åä½œå…³ç³»
209:    */
210:   async updateCollaboration(id: string, data: OrganizationCollaborationUpdate): Promise<OrganizationCollaboration> {
211:     this.loadingState.set(true);
212:     this.errorState.set(null);
213: 
214:     try {
215:       const collaboration = await firstValueFrom(this.collaborationRepository.update(id, data));
216:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
217:       this.collaborationsState.update(collaborations => collaborations.map(c => (c.id === id ? collaboration : c)));
218:       // å¦‚æœæ›´æ–°çš„æ˜¯å½“å‰é€‰ä¸­çš„åä½œå…³ç³»ï¼Œä¹Ÿæ›´æ–°é€‰ä¸­çŠ¶æ€
219:       if (this.selectedCollaboration()?.id === id) {
220:         this.selectedCollaborationState.set(collaboration);
221:       }
222:       return collaboration;
223:     } catch (error) {
224:       this.errorState.set(error instanceof Error ? error.message : 'æ›´æ–°åä½œå…³ç³»å¤±è´¥');
225:       throw error;
226:     } finally {
227:       this.loadingState.set(false);
228:     }
229:   }
230: 
231:   /**
232:    * åˆ é™¤åä½œå…³ç³»
233:    */
234:   async deleteCollaboration(id: string): Promise<void> {
235:     this.loadingState.set(true);
236:     this.errorState.set(null);
237: 
238:     try {
239:       await firstValueFrom(this.collaborationRepository.delete(id));
240:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
241:       this.collaborationsState.update(collaborations => collaborations.filter(c => c.id !== id));
242:       // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„åä½œå…³ç³»ï¼Œæ¸…ç©ºé€‰ä¸­çŠ¶æ€
243:       if (this.selectedCollaboration()?.id === id) {
244:         this.selectedCollaborationState.set(null);
245:       }
246:     } catch (error) {
247:       this.errorState.set(error instanceof Error ? error.message : 'åˆ é™¤åä½œå…³ç³»å¤±è´¥');
248:       throw error;
249:     } finally {
250:       this.loadingState.set(false);
251:     }
252:   }
253: 
254:   /**
255:    * é€‰æ‹©åä½œå…³ç³»
256:    */
257:   selectCollaboration(collaboration: OrganizationCollaboration | null): void {
258:     this.selectedCollaborationState.set(collaboration);
259:   }
260: 
261:   /**
262:    * é‡ç½®çŠ¶æ€
263:    */
264:   reset(): void {
265:     this.collaborationsState.set([]);
266:     this.selectedCollaborationState.set(null);
267:     this.errorState.set(null);
268:   }
269: }
````

## File: src/app/shared/services/collaboration/index.ts
````typescript
1: /**
2:  * Collaboration Services
3:  *
4:  * ç»„ç»‡åä½œç³»ç»Ÿç›¸å…³çš„æœåŠ¡
5:  */
6: export * from './collaboration.service';
7: export * from './invitation.service';
````

## File: src/app/shared/services/collaboration/invitation.service.spec.ts
````typescript
  1: import { TestBed } from '@angular/core/testing';
  2: import { CollaborationInvitationRepository, InvitationStatus } from '@core';
  3: import { CollaborationInvitation } from '@shared';
  4: import { of, throwError } from 'rxjs';
  5: 
  6: import { InvitationService } from './invitation.service';
  7: 
  8: describe('InvitationService', () => {
  9:   let service: InvitationService;
 10:   let repository: jasmine.SpyObj<CollaborationInvitationRepository>;
 11: 
 12:   const mockInvitation: CollaborationInvitation = {
 13:     id: 'inv-1',
 14:     blueprint_id: 'blueprint-1',
 15:     from_org_id: 'org-1',
 16:     to_org_id: 'org-2',
 17:     invitation_message: 'Test invitation',
 18:     status: InvitationStatus.PENDING,
 19:     expires_at: '2025-12-31T23:59:59Z',
 20:     responded_at: null,
 21:     created_at: '2025-01-01T00:00:00Z'
 22:   } as CollaborationInvitation;
 23: 
 24:   const mockInvitations: CollaborationInvitation[] = [
 25:     mockInvitation,
 26:     {
 27:       ...mockInvitation,
 28:       id: 'inv-2',
 29:       status: InvitationStatus.ACCEPTED,
 30:       responded_at: '2025-01-02T00:00:00Z'
 31:     },
 32:     {
 33:       ...mockInvitation,
 34:       id: 'inv-3',
 35:       status: InvitationStatus.EXPIRED,
 36:       expires_at: '2024-01-01T00:00:00Z'
 37:     }
 38:   ];
 39: 
 40:   beforeEach(() => {
 41:     const repositorySpy = jasmine.createSpyObj('CollaborationInvitationRepository', [
 42:       'findAll',
 43:       'findById',
 44:       'findByBlueprintId',
 45:       'findByFromOrgId',
 46:       'findByToOrgId',
 47:       'findByStatus',
 48:       'findPending',
 49:       'findExpired',
 50:       'create',
 51:       'update',
 52:       'delete'
 53:     ]);
 54: 
 55:     TestBed.configureTestingModule({
 56:       providers: [InvitationService, { provide: CollaborationInvitationRepository, useValue: repositorySpy }]
 57:     });
 58: 
 59:     service = TestBed.inject(InvitationService);
 60:     repository = TestBed.inject(CollaborationInvitationRepository) as jasmine.SpyObj<CollaborationInvitationRepository>;
 61:   });
 62: 
 63:   it('should be created', () => {
 64:     expect(service).toBeTruthy();
 65:   });
 66: 
 67:   describe('Initial state', () => {
 68:     it('should have empty invitations', () => {
 69:       expect(service.invitations().length).toBe(0);
 70:     });
 71: 
 72:     it('should have null selected invitation', () => {
 73:       expect(service.selectedInvitation()).toBeNull();
 74:     });
 75: 
 76:     it('should have false loading state', () => {
 77:       expect(service.loading()).toBe(false);
 78:     });
 79: 
 80:     it('should have null error state', () => {
 81:       expect(service.error()).toBeNull();
 82:     });
 83:   });
 84: 
 85:   describe('loadInvitations', () => {
 86:     it('should load invitations successfully', async () => {
 87:       repository.findAll.and.returnValue(of(mockInvitations));
 88: 
 89:       await service.loadInvitations();
 90: 
 91:       expect(service.invitations().length).toBe(3);
 92:       expect(service.invitations()[0].id).toBe('inv-1');
 93:       expect(service.loading()).toBe(false);
 94:       expect(service.error()).toBeNull();
 95:     });
 96: 
 97:     it('should handle error when loading fails', async () => {
 98:       const error = new Error('Load failed');
 99:       repository.findAll.and.returnValue(throwError(() => error));
100: 
101:       try {
102:         await service.loadInvitations();
103:         fail('should have thrown error');
104:       } catch (_e) {
105:         expect(service.error()).toBe('Load failed');
106:         expect(service.loading()).toBe(false);
107:       }
108:     });
109:   });
110: 
111:   describe('loadInvitationById', () => {
112:     it('should load invitation by id successfully', async () => {
113:       repository.findById.and.returnValue(of(mockInvitation));
114: 
115:       const result = await service.loadInvitationById('inv-1');
116: 
117:       expect(result).toEqual(mockInvitation);
118:       expect(service.selectedInvitation()).toEqual(mockInvitation);
119:     });
120: 
121:     it('should return null when invitation not found', async () => {
122:       repository.findById.and.returnValue(of(null));
123: 
124:       const result = await service.loadInvitationById('non-existent');
125: 
126:       expect(result).toBeNull();
127:     });
128:   });
129: 
130:   describe('loadInvitationsByBlueprintId', () => {
131:     it('should load invitations by blueprint id', async () => {
132:       repository.findByBlueprintId.and.returnValue(of(mockInvitations));
133: 
134:       const result = await service.loadInvitationsByBlueprintId('blueprint-1');
135: 
136:       expect(result.length).toBe(3);
137:       expect(repository.findByBlueprintId).toHaveBeenCalledWith('blueprint-1');
138:     });
139:   });
140: 
141:   describe('loadInvitationsByFromOrgId', () => {
142:     it('should load invitations by from org id', async () => {
143:       repository.findByFromOrgId.and.returnValue(of(mockInvitations));
144: 
145:       const result = await service.loadInvitationsByFromOrgId('org-1');
146: 
147:       expect(result.length).toBe(3);
148:       expect(repository.findByFromOrgId).toHaveBeenCalledWith('org-1');
149:     });
150:   });
151: 
152:   describe('loadInvitationsByToOrgId', () => {
153:     it('should load invitations by to org id', async () => {
154:       repository.findByToOrgId.and.returnValue(of(mockInvitations));
155: 
156:       const result = await service.loadInvitationsByToOrgId('org-2');
157: 
158:       expect(result.length).toBe(3);
159:       expect(repository.findByToOrgId).toHaveBeenCalledWith('org-2');
160:     });
161:   });
162: 
163:   describe('loadInvitationsByStatus', () => {
164:     it('should load invitations by status', async () => {
165:       repository.findByStatus.and.returnValue(of([mockInvitation]));
166: 
167:       const result = await service.loadInvitationsByStatus(InvitationStatus.PENDING);
168: 
169:       expect(result.length).toBe(1);
170:       expect(repository.findByStatus).toHaveBeenCalledWith(InvitationStatus.PENDING);
171:     });
172:   });
173: 
174:   describe('loadPendingInvitations', () => {
175:     it('should load pending invitations', async () => {
176:       repository.findPending.and.returnValue(of([mockInvitation]));
177: 
178:       const result = await service.loadPendingInvitations();
179: 
180:       expect(result.length).toBe(1);
181:       expect(repository.findPending).toHaveBeenCalled();
182:     });
183:   });
184: 
185:   describe('loadExpiredInvitations', () => {
186:     it('should load expired invitations', async () => {
187:       repository.findExpired.and.returnValue(of([mockInvitations[2]]));
188: 
189:       const result = await service.loadExpiredInvitations();
190: 
191:       expect(result.length).toBe(1);
192:       expect(repository.findExpired).toHaveBeenCalled();
193:     });
194:   });
195: 
196:   describe('createInvitation', () => {
197:     it('should create invitation successfully', async () => {
198:       const newInvitation = { ...mockInvitation, id: 'inv-new' };
199:       repository.create.and.returnValue(of(newInvitation));
200: 
201:       const result = await service.createInvitation({
202:         blueprint_id: 'blueprint-1',
203:         from_org_id: 'org-1',
204:         to_org_id: 'org-2',
205:         expires_at: '2025-12-31T23:59:59Z'
206:       });
207: 
208:       expect(result).toEqual(newInvitation);
209:       expect(service.invitations().length).toBe(1);
210:     });
211:   });
212: 
213:   describe('updateInvitation', () => {
214:     beforeEach(() => {
215:       service['invitationsState'].set(mockInvitations);
216:     });
217: 
218:     it('should update invitation successfully', async () => {
219:       const updated = { ...mockInvitation, invitation_message: 'Updated message' };
220:       repository.update.and.returnValue(of(updated));
221: 
222:       const result = await service.updateInvitation('inv-1', {
223:         invitation_message: 'Updated message'
224:       });
225: 
226:       expect(result).toEqual(updated);
227:       expect(service.invitations()[0].invitation_message).toBe('Updated message');
228:     });
229:   });
230: 
231:   describe('acceptInvitation', () => {
232:     beforeEach(() => {
233:       service['invitationsState'].set([mockInvitation]);
234:     });
235: 
236:     it('should accept invitation successfully', async () => {
237:       const accepted = {
238:         ...mockInvitation,
239:         status: InvitationStatus.ACCEPTED,
240:         responded_at: new Date().toISOString()
241:       };
242:       repository.update.and.returnValue(of(accepted));
243: 
244:       const result = await service.acceptInvitation('inv-1');
245: 
246:       expect(result.status).toBe(InvitationStatus.ACCEPTED);
247:       expect(result.responded_at).toBeTruthy();
248:       expect(repository.update).toHaveBeenCalledWith('inv-1', jasmine.any(Object));
249:     });
250:   });
251: 
252:   describe('rejectInvitation', () => {
253:     beforeEach(() => {
254:       service['invitationsState'].set([mockInvitation]);
255:     });
256: 
257:     it('should reject invitation successfully', async () => {
258:       const rejected = {
259:         ...mockInvitation,
260:         status: InvitationStatus.REJECTED,
261:         responded_at: new Date().toISOString()
262:       };
263:       repository.update.and.returnValue(of(rejected));
264: 
265:       const result = await service.rejectInvitation('inv-1');
266: 
267:       expect(result.status).toBe(InvitationStatus.REJECTED);
268:       expect(result.responded_at).toBeTruthy();
269:       expect(repository.update).toHaveBeenCalledWith('inv-1', jasmine.any(Object));
270:     });
271:   });
272: 
273:   describe('deleteInvitation', () => {
274:     beforeEach(() => {
275:       service['invitationsState'].set(mockInvitations);
276:     });
277: 
278:     it('should delete invitation successfully', async () => {
279:       repository.delete.and.returnValue(of(undefined));
280: 
281:       await service.deleteInvitation('inv-1');
282: 
283:       expect(service.invitations().length).toBe(2);
284:       expect(service.invitations()[0].id).toBe('inv-2');
285:     });
286: 
287:     it('should clear selected invitation if deleted', async () => {
288:       service.selectInvitation(mockInvitation);
289:       repository.delete.and.returnValue(of(undefined));
290: 
291:       await service.deleteInvitation('inv-1');
292: 
293:       expect(service.selectedInvitation()).toBeNull();
294:     });
295:   });
296: 
297:   describe('selectInvitation', () => {
298:     it('should select invitation', () => {
299:       service.selectInvitation(mockInvitation);
300: 
301:       expect(service.selectedInvitation()).toEqual(mockInvitation);
302:     });
303:   });
304: 
305:   describe('reset', () => {
306:     it('should reset all state', () => {
307:       service['invitationsState'].set(mockInvitations);
308:       service.selectInvitation(mockInvitation);
309:       service['errorState'].set('Some error');
310: 
311:       service.reset();
312: 
313:       expect(service.invitations().length).toBe(0);
314:       expect(service.selectedInvitation()).toBeNull();
315:       expect(service.error()).toBeNull();
316:     });
317:   });
318: 
319:   describe('Computed signals', () => {
320:     beforeEach(() => {
321:       service['invitationsState'].set(mockInvitations);
322:     });
323: 
324:     it('should compute pendingInvitations', () => {
325:       expect(service.pendingInvitations().length).toBe(1);
326:       expect(service.pendingInvitations()[0].status).toBe(InvitationStatus.PENDING);
327:     });
328: 
329:     it('should compute acceptedInvitations', () => {
330:       expect(service.acceptedInvitations().length).toBe(1);
331:       expect(service.acceptedInvitations()[0].status).toBe(InvitationStatus.ACCEPTED);
332:     });
333: 
334:     it('should compute expiredInvitations', () => {
335:       expect(service.expiredInvitations().length).toBe(1);
336:       expect(service.expiredInvitations()[0].id).toBe('inv-3');
337:     });
338:   });
339: });
````

## File: src/app/shared/services/collaboration/invitation.service.ts
````typescript
  1: import { Injectable, inject, signal, computed } from '@angular/core';
  2: import { CollaborationInvitationRepository, CollaborationInvitationInsert, CollaborationInvitationUpdate, InvitationStatus } from '@core';
  3: import { CollaborationInvitation } from '@shared';
  4: import { firstValueFrom } from 'rxjs';
  5: 
  6: /**
  7:  * Invitation Service
  8:  *
  9:  * æä¾›åä½œé‚€è¯·ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†
 10:  * ä½¿ç”¨ Signals ç®¡ç†çŠ¶æ€ï¼Œæš´éœ² ReadonlySignal ç»™ç»„ä»¶
 11:  *
 12:  * @example
 13:  * ```typescript
 14:  * const invitationService = inject(InvitationService);
 15:  *
 16:  * // è®¢é˜…é‚€è¯·åˆ—è¡¨
 17:  * effect(() => {
 18:  *   console.log('Invitations:', invitationService.invitations());
 19:  * });
 20:  *
 21:  * // åŠ è½½é‚€è¯·åˆ—è¡¨
 22:  * await invitationService.loadInvitations();
 23:  * ```
 24:  */
 25: @Injectable({
 26:   providedIn: 'root'
 27: })
 28: export class InvitationService {
 29:   private invitationRepository = inject(CollaborationInvitationRepository);
 30: 
 31:   // ä½¿ç”¨ Signals ç®¡ç†çŠ¶æ€
 32:   private invitationsState = signal<CollaborationInvitation[]>([]);
 33:   private selectedInvitationState = signal<CollaborationInvitation | null>(null);
 34:   private loadingState = signal<boolean>(false);
 35:   private errorState = signal<string | null>(null);
 36: 
 37:   // æš´éœ² ReadonlySignal ç»™ç»„ä»¶
 38:   readonly invitations = this.invitationsState.asReadonly();
 39:   readonly selectedInvitation = this.selectedInvitationState.asReadonly();
 40:   readonly loading = this.loadingState.asReadonly();
 41:   readonly error = this.errorState.asReadonly();
 42: 
 43:   // Computed signals
 44:   readonly pendingInvitations = computed(() => this.invitations().filter(i => i.status === InvitationStatus.PENDING));
 45: 
 46:   readonly acceptedInvitations = computed(() => this.invitations().filter(i => i.status === InvitationStatus.ACCEPTED));
 47: 
 48:   readonly expiredInvitations = computed(() =>
 49:     this.invitations().filter(i => {
 50:       if (!i.expires_at) return false;
 51:       return new Date(i.expires_at) < new Date();
 52:     })
 53:   );
 54: 
 55:   /**
 56:    * åŠ è½½æ‰€æœ‰é‚€è¯·
 57:    */
 58:   async loadInvitations(): Promise<void> {
 59:     this.loadingState.set(true);
 60:     this.errorState.set(null);
 61: 
 62:     try {
 63:       const invitations = await firstValueFrom(this.invitationRepository.findAll());
 64:       this.invitationsState.set(invitations);
 65:     } catch (error) {
 66:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½é‚€è¯·åˆ—è¡¨å¤±è´¥');
 67:       throw error;
 68:     } finally {
 69:       this.loadingState.set(false);
 70:     }
 71:   }
 72: 
 73:   /**
 74:    * æ ¹æ® ID åŠ è½½é‚€è¯·
 75:    */
 76:   async loadInvitationById(id: string): Promise<CollaborationInvitation | null> {
 77:     this.loadingState.set(true);
 78:     this.errorState.set(null);
 79: 
 80:     try {
 81:       const invitation = await firstValueFrom(this.invitationRepository.findById(id));
 82:       if (invitation) {
 83:         this.selectedInvitationState.set(invitation);
 84:       }
 85:       return invitation;
 86:     } catch (error) {
 87:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½é‚€è¯·å¤±è´¥');
 88:       throw error;
 89:     } finally {
 90:       this.loadingState.set(false);
 91:     }
 92:   }
 93: 
 94:   /**
 95:    * æ ¹æ®è“å›¾ ID åŠ è½½é‚€è¯·
 96:    */
 97:   async loadInvitationsByBlueprintId(blueprintId: string): Promise<CollaborationInvitation[]> {
 98:     this.loadingState.set(true);
 99:     this.errorState.set(null);
100: 
101:     try {
102:       const invitations = await firstValueFrom(this.invitationRepository.findByBlueprintId(blueprintId));
103:       return invitations;
104:     } catch (error) {
105:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½é‚€è¯·åˆ—è¡¨å¤±è´¥');
106:       throw error;
107:     } finally {
108:       this.loadingState.set(false);
109:     }
110:   }
111: 
112:   /**
113:    * æ ¹æ®å‘é€ç»„ç»‡ ID åŠ è½½é‚€è¯·
114:    */
115:   async loadInvitationsByFromOrgId(fromOrgId: string): Promise<CollaborationInvitation[]> {
116:     this.loadingState.set(true);
117:     this.errorState.set(null);
118: 
119:     try {
120:       const invitations = await firstValueFrom(this.invitationRepository.findByFromOrgId(fromOrgId));
121:       return invitations;
122:     } catch (error) {
123:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½é‚€è¯·åˆ—è¡¨å¤±è´¥');
124:       throw error;
125:     } finally {
126:       this.loadingState.set(false);
127:     }
128:   }
129: 
130:   /**
131:    * æ ¹æ®æ¥æ”¶ç»„ç»‡ ID åŠ è½½é‚€è¯·
132:    */
133:   async loadInvitationsByToOrgId(toOrgId: string): Promise<CollaborationInvitation[]> {
134:     this.loadingState.set(true);
135:     this.errorState.set(null);
136: 
137:     try {
138:       const invitations = await firstValueFrom(this.invitationRepository.findByToOrgId(toOrgId));
139:       return invitations;
140:     } catch (error) {
141:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½é‚€è¯·åˆ—è¡¨å¤±è´¥');
142:       throw error;
143:     } finally {
144:       this.loadingState.set(false);
145:     }
146:   }
147: 
148:   /**
149:    * æ ¹æ®çŠ¶æ€åŠ è½½é‚€è¯·
150:    */
151:   async loadInvitationsByStatus(status: InvitationStatus): Promise<CollaborationInvitation[]> {
152:     this.loadingState.set(true);
153:     this.errorState.set(null);
154: 
155:     try {
156:       const invitations = await firstValueFrom(this.invitationRepository.findByStatus(status));
157:       return invitations;
158:     } catch (error) {
159:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½é‚€è¯·åˆ—è¡¨å¤±è´¥');
160:       throw error;
161:     } finally {
162:       this.loadingState.set(false);
163:     }
164:   }
165: 
166:   /**
167:    * åŠ è½½å¾…å¤„ç†é‚€è¯·
168:    */
169:   async loadPendingInvitations(): Promise<CollaborationInvitation[]> {
170:     this.loadingState.set(true);
171:     this.errorState.set(null);
172: 
173:     try {
174:       const invitations = await firstValueFrom(this.invitationRepository.findPending());
175:       return invitations;
176:     } catch (error) {
177:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½å¾…å¤„ç†é‚€è¯·å¤±è´¥');
178:       throw error;
179:     } finally {
180:       this.loadingState.set(false);
181:     }
182:   }
183: 
184:   /**
185:    * åŠ è½½è¿‡æœŸé‚€è¯·
186:    */
187:   async loadExpiredInvitations(): Promise<CollaborationInvitation[]> {
188:     this.loadingState.set(true);
189:     this.errorState.set(null);
190: 
191:     try {
192:       const invitations = await firstValueFrom(this.invitationRepository.findExpired());
193:       return invitations;
194:     } catch (error) {
195:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½è¿‡æœŸé‚€è¯·å¤±è´¥');
196:       throw error;
197:     } finally {
198:       this.loadingState.set(false);
199:     }
200:   }
201: 
202:   /**
203:    * åˆ›å»ºé‚€è¯·
204:    */
205:   async createInvitation(data: CollaborationInvitationInsert): Promise<CollaborationInvitation> {
206:     this.loadingState.set(true);
207:     this.errorState.set(null);
208: 
209:     try {
210:       const invitation = await firstValueFrom(this.invitationRepository.create(data));
211:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
212:       this.invitationsState.update(invitations => [...invitations, invitation]);
213:       return invitation;
214:     } catch (error) {
215:       this.errorState.set(error instanceof Error ? error.message : 'åˆ›å»ºé‚€è¯·å¤±è´¥');
216:       throw error;
217:     } finally {
218:       this.loadingState.set(false);
219:     }
220:   }
221: 
222:   /**
223:    * æ›´æ–°é‚€è¯·
224:    */
225:   async updateInvitation(id: string, data: CollaborationInvitationUpdate): Promise<CollaborationInvitation> {
226:     this.loadingState.set(true);
227:     this.errorState.set(null);
228: 
229:     try {
230:       const invitation = await firstValueFrom(this.invitationRepository.update(id, data));
231:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
232:       this.invitationsState.update(invitations => invitations.map(i => (i.id === id ? invitation : i)));
233:       // å¦‚æœæ›´æ–°çš„æ˜¯å½“å‰é€‰ä¸­çš„é‚€è¯·ï¼Œä¹Ÿæ›´æ–°é€‰ä¸­çŠ¶æ€
234:       if (this.selectedInvitation()?.id === id) {
235:         this.selectedInvitationState.set(invitation);
236:       }
237:       return invitation;
238:     } catch (error) {
239:       this.errorState.set(error instanceof Error ? error.message : 'æ›´æ–°é‚€è¯·å¤±è´¥');
240:       throw error;
241:     } finally {
242:       this.loadingState.set(false);
243:     }
244:   }
245: 
246:   /**
247:    * æ¥å—é‚€è¯·
248:    */
249:   async acceptInvitation(id: string): Promise<CollaborationInvitation> {
250:     return this.updateInvitation(id, {
251:       status: InvitationStatus.ACCEPTED,
252:       responded_at: new Date().toISOString()
253:     });
254:   }
255: 
256:   /**
257:    * æ‹’ç»é‚€è¯·
258:    */
259:   async rejectInvitation(id: string): Promise<CollaborationInvitation> {
260:     return this.updateInvitation(id, {
261:       status: InvitationStatus.REJECTED,
262:       responded_at: new Date().toISOString()
263:     });
264:   }
265: 
266:   /**
267:    * åˆ é™¤é‚€è¯·
268:    */
269:   async deleteInvitation(id: string): Promise<void> {
270:     this.loadingState.set(true);
271:     this.errorState.set(null);
272: 
273:     try {
274:       await firstValueFrom(this.invitationRepository.delete(id));
275:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
276:       this.invitationsState.update(invitations => invitations.filter(i => i.id !== id));
277:       // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„é‚€è¯·ï¼Œæ¸…ç©ºé€‰ä¸­çŠ¶æ€
278:       if (this.selectedInvitation()?.id === id) {
279:         this.selectedInvitationState.set(null);
280:       }
281:     } catch (error) {
282:       this.errorState.set(error instanceof Error ? error.message : 'åˆ é™¤é‚€è¯·å¤±è´¥');
283:       throw error;
284:     } finally {
285:       this.loadingState.set(false);
286:     }
287:   }
288: 
289:   /**
290:    * é€‰æ‹©é‚€è¯·
291:    */
292:   selectInvitation(invitation: CollaborationInvitation | null): void {
293:     this.selectedInvitationState.set(invitation);
294:   }
295: 
296:   /**
297:    * é‡ç½®çŠ¶æ€
298:    */
299:   reset(): void {
300:     this.invitationsState.set([]);
301:     this.selectedInvitationState.set(null);
302:     this.errorState.set(null);
303:   }
304: }
````

## File: src/app/shared/shared-delon.module.ts
````typescript
  1: // ========== @delon/abc çµ„ä»¶æ¨¡çµ„ ==========
  2: // æ–‡æœ¬è¶…å‡ºçœç•¥é¡¯ç¤º â€” https://ng-alain.com/components/ellipsis
  3: import { CellModule } from '@delon/abc/cell';
  4: import { CountDownModule } from '@delon/abc/count-down';
  5: import { DownFileDirective } from '@delon/abc/down-file';
  6: import { EllipsisComponent } from '@delon/abc/ellipsis';
  7: // é é¢åº•éƒ¨æ“ä½œå·¥å…·æ¬„ â€” https://ng-alain.com/components/footer-toolbar
  8: import { ExceptionModule } from '@delon/abc/exception';
  9: import { FooterToolbarModule } from '@delon/abc/footer-toolbar';
 10: // å…§å®¹å€å…¨å±/å¡«å……åˆ‡æ› â€” https://ng-alain.com/components/full-content
 11: import { FullContentModule } from '@delon/abc/full-content';
 12: // é é¢æ¨™é¡Œå€ï¼ˆéºµåŒ…å±‘ã€æ“ä½œå€ï¼‰ â€” https://ng-alain.com/components/page-header
 13: import { GlobalFooterModule } from '@delon/abc/global-footer';
 14: import { NoticeIconModule } from '@delon/abc/notice-icon';
 15: import { OnboardingModule } from '@delon/abc/onboarding';
 16: import { PageHeaderModule } from '@delon/abc/page-header';
 17: // SEï¼šç°¡æ½”è¡¨å–®ä½ˆå±€ï¼ˆå¿«é€Ÿæ’ç‰ˆè¡¨å–®é …ï¼‰ â€” https://ng-alain.com/components/se
 18: import { QuickMenuModule } from '@delon/abc/quick-menu';
 19: import { ReuseTabModule } from '@delon/abc/reuse-tab';
 20: import { SEModule } from '@delon/abc/se';
 21: // STï¼šSmart Table æ™ºèƒ½è¡¨æ ¼ â€” https://ng-alain.com/components/st
 22: import { STModule } from '@delon/abc/st';
 23: // SVï¼šç°¡å–®è¦–åœ–ï¼Œç”¨æ–¼éµå€¼æè¿°å±•ç¤º â€” https://ng-alain.com/components/sv
 24: import { SVModule } from '@delon/abc/sv';
 25: // Tag å¤šé¸èˆ‡å±•é–‹/æ”¶èµ·é¸æ“‡å™¨ â€” https://ng-alain.com/components/tag-select
 26: import { TagSelectComponent } from '@delon/abc/tag-select';
 27: // ReuseTab æ¨™ç±¤é ï¼ˆè·¯ç”±å¿«å–ï¼‰ â€” https://ng-alain.com/components/reuse-tab
 28: // å¼•å°å¼æ“ä½œ â€” https://ng-alain.com/components/onboarding
 29: // å¿«æ·èœå–® â€” https://ng-alain.com/components/quick-menu
 30: // å€’è¨ˆæ™‚ â€” https://ng-alain.com/components/count-down
 31: // å…¨å±€é è…³ â€” https://ng-alain.com/components/global-footer
 32: // ç•°å¸¸é é¢ â€” https://ng-alain.com/components/exception
 33: // é€šçŸ¥åœ–æ¨™ â€” https://ng-alain.com/components/notice-icon
 34: // ä¸‹è¼‰æ–‡ä»¶æŒ‡ä»¤ â€” https://ng-alain.com/components/down-file
 35: // ACL è¨ªå•æ§åˆ¶æŒ‡ä»¤ï¼ˆé¡¯ç¤º/éš±è—/æ¢ä»¶ï¼‰ â€” https://ng-alain.com/acl
 36: import { ACLDirective, ACLIfDirective } from '@delon/acl';
 37: // å‹•æ…‹è¡¨å–®ï¼ˆåŸºæ–¼ JSON Schema çš„è¡¨å–®ç”Ÿæˆèˆ‡é©—è­‰ï¼‰ â€” https://ng-alain.com/form
 38: // é‡‘é¡/è²¨å¹£æ ¼å¼åŒ–ç®¡é“ â€” https://ng-alain.com/util
 39: // åœ–è¡¨çµ„ä»¶ â€” https://ng-alain.com/docs/chart
 40: // æ³¨æ„ï¼š@delon/chart å¿…é ˆå¾å­æ¨¡çµ„å°å…¥ï¼Œè€Œéå¾ @delon/chart ç›´æ¥å°å…¥
 41: // æŸ±ç‹€åœ– â€” https://ng-alain.com/chart/bar
 42: import { G2BarModule } from '@delon/chart/bar';
 43: // åœ–è¡¨å¡ç‰‡ â€” https://ng-alain.com/chart/card
 44: import { G2CardModule } from '@delon/chart/card';
 45: // ECharts åœ–è¡¨ â€” https://ng-alain.com/chart/chart-echarts
 46: import { ChartEChartsModule } from '@delon/chart/chart-echarts';
 47: // å„€è¡¨ç›¤ â€” https://ng-alain.com/chart/gauge
 48: import { G2GaugeModule } from '@delon/chart/gauge';
 49: // è¿·ä½ é¢ç©åœ– â€” https://ng-alain.com/chart/mini-area
 50: import { G2MiniAreaModule } from '@delon/chart/mini-area';
 51: // è¿·ä½ æŸ±ç‹€åœ– â€” https://ng-alain.com/chart/mini-bar
 52: import { G2MiniBarModule } from '@delon/chart/mini-bar';
 53: // è¿·ä½ é€²åº¦æ¢ â€” https://ng-alain.com/chart/mini-progress
 54: import { G2MiniProgressModule } from '@delon/chart/mini-progress';
 55: // æ•¸æ“šæ–‡æœ¬ â€” https://ng-alain.com/chart/number-info
 56: import { NumberInfoModule } from '@delon/chart/number-info';
 57: // é¤…åœ– â€” https://ng-alain.com/chart/pie
 58: import { G2PieModule } from '@delon/chart/pie';
 59: // é›·é”åœ– â€” https://ng-alain.com/chart/radar
 60: import { G2RadarModule } from '@delon/chart/radar';
 61: // å–®ä¸€æŸ±ç‹€åœ– â€” https://ng-alain.com/chart/single-bar
 62: import { G2SingleBarModule } from '@delon/chart/single-bar';
 63: // æ¨™ç±¤é›² â€” https://ng-alain.com/chart/tag-cloud
 64: import { G2TagCloudModule } from '@delon/chart/tag-cloud';
 65: // æ™‚é–“è»¸ â€” https://ng-alain.com/chart/timeline
 66: import { G2TimelineModule } from '@delon/chart/timeline';
 67: // è¶¨å‹¢æ¨™è¨˜ â€” https://ng-alain.com/chart/trend
 68: import { TrendModule } from '@delon/chart/trend';
 69: // æ°´æ³¢åœ– â€” https://ng-alain.com/chart/water-wave
 70: import { G2WaterWaveModule } from '@delon/chart/water-wave';
 71: import { DelonFormModule } from '@delon/form';
 72: import { LayoutDefaultModule } from '@delon/theme/layout-default';
 73: import { SettingDrawerModule } from '@delon/theme/setting-drawer';
 74: import { ThemeBtnComponent } from '@delon/theme/theme-btn';
 75: import { CurrencyPricePipe } from '@delon/util';
 76: // ========== @delon/theme çµ„ä»¶æ¨¡çµ„ ==========
 77: // é»˜èªä½ˆå±€ â€” https://ng-alain.com/theme/layout-default
 78: // è¨­ç½®æŠ½å±œ â€” https://ng-alain.com/theme/setting-drawer
 79: // ä¸»é¡Œåˆ‡æ›æŒ‰éˆ• â€” https://ng-alain.com/theme/theme-btn
 80: 
 81: export const SHARED_DELON_MODULES = [
 82:   CellModule, // å–®å…ƒæ ¼æ¸²æŸ“ â€” https://ng-alain.com/components/cell/zh
 83:   DelonFormModule, // å‹•æ…‹è¡¨å–® â€” https://ng-alain.com/form
 84:   STModule, // æ™ºèƒ½è¡¨æ ¼ â€” https://ng-alain.com/components/st
 85:   SVModule, // éµå€¼æè¿°è¦–åœ– â€” https://ng-alain.com/components/sv
 86:   SEModule, // è¡¨å–®ä½ˆå±€ â€” https://ng-alain.com/components/se
 87:   PageHeaderModule, // é é¢æ¨™é¡Œ/æ“ä½œ â€” https://ng-alain.com/components/page-header
 88:   EllipsisComponent, // æ–‡æœ¬çœç•¥ â€” https://ng-alain.com/components/ellipsis
 89:   FooterToolbarModule, // åº•éƒ¨å·¥å…·æ¬„ â€” https://ng-alain.com/components/footer-toolbar
 90:   FullContentModule, // å…¨å±å…§å®¹ â€” https://ng-alain.com/components/full-content
 91:   ReuseTabModule, // æ¨™ç±¤é ï¼ˆè·¯ç”±å¿«å–ï¼‰ â€” https://ng-alain.com/components/reuse-tab
 92:   TagSelectComponent, // æ¨™ç±¤é¸æ“‡ â€” https://ng-alain.com/components/tag-select
 93:   OnboardingModule, // å¼•å°å¼æ“ä½œ â€” https://ng-alain.com/components/onboarding
 94:   QuickMenuModule, // å¿«æ·èœå–® â€” https://ng-alain.com/components/quick-menu
 95:   CountDownModule, // å€’è¨ˆæ™‚ â€” https://ng-alain.com/components/count-down
 96:   GlobalFooterModule, // å…¨å±€é è…³ â€” https://ng-alain.com/components/global-footer
 97:   ExceptionModule, // ç•°å¸¸é é¢ â€” https://ng-alain.com/components/exception
 98:   NoticeIconModule, // é€šçŸ¥åœ–æ¨™ â€” https://ng-alain.com/components/notice-icon
 99:   DownFileDirective, // ä¸‹è¼‰æ–‡ä»¶æŒ‡ä»¤ â€” https://ng-alain.com/components/down-file
100:   ACLDirective, // ACL æŒ‡ä»¤ â€” https://ng-alain.com/acl
101:   ACLIfDirective, // æ¢ä»¶ ACL æŒ‡ä»¤ â€” https://ng-alain.com/acl
102:   CurrencyPricePipe, // é‡‘é¡æ ¼å¼åŒ– â€” https://ng-alain.com/util
103:   // ========== @delon/theme çµ„ä»¶æ¨¡çµ„ ==========
104:   LayoutDefaultModule, // é»˜èªä½ˆå±€ â€” https://ng-alain.com/theme/layout-default
105:   SettingDrawerModule, // è¨­ç½®æŠ½å±œ â€” https://ng-alain.com/theme/setting-drawer
106:   ThemeBtnComponent, // ä¸»é¡Œåˆ‡æ›æŒ‰éˆ• â€” https://ng-alain.com/theme/theme-btn
107:   // @delon/chart å®Œæ•´åœ–è¡¨æ¨¡çµ„å¥—ä»¶
108:   G2BarModule, // æŸ±ç‹€åœ– â€” https://ng-alain.com/chart/bar
109:   G2CardModule, // åœ–è¡¨å¡ç‰‡ â€” https://ng-alain.com/chart/card
110:   ChartEChartsModule, // ECharts åœ–è¡¨ â€” https://ng-alain.com/chart/chart-echarts
111:   G2GaugeModule, // å„€è¡¨ç›¤ â€” https://ng-alain.com/chart/gauge
112:   G2MiniAreaModule, // è¿·ä½ é¢ç©åœ– â€” https://ng-alain.com/chart/mini-area
113:   G2MiniBarModule, // è¿·ä½ æŸ±ç‹€åœ– â€” https://ng-alain.com/chart/mini-bar
114:   G2MiniProgressModule, // è¿·ä½ é€²åº¦æ¢ â€” https://ng-alain.com/chart/mini-progress
115:   NumberInfoModule, // æ•¸æ“šæ–‡æœ¬ â€” https://ng-alain.com/chart/number-info
116:   G2PieModule, // é¤…åœ– â€” https://ng-alain.com/chart/pie
117:   G2RadarModule, // é›·é”åœ– â€” https://ng-alain.com/chart/radar
118:   G2SingleBarModule, // å–®ä¸€æŸ±ç‹€åœ– â€” https://ng-alain.com/chart/single-bar
119:   G2TagCloudModule, // æ¨™ç±¤é›² â€” https://ng-alain.com/chart/tag-cloud
120:   G2TimelineModule, // æ™‚é–“è»¸ â€” https://ng-alain.com/chart/timeline
121:   TrendModule, // è¶¨å‹¢æ¨™è¨˜ â€” https://ng-alain.com/chart/trend
122:   G2WaterWaveModule // æ°´æ³¢åœ– â€” https://ng-alain.com/chart/water-wave
123: ];
````

## File: src/app/shared/shared-tinymce.module.ts
````typescript
 1: /**
 2:  * ngx-tinymce å¯Œæ–‡æœ¬ç·¨è¼¯å™¨æ¨¡çµ„
 3:  *
 4:  * æ³¨æ„ï¼šæ­¤æ¨¡çµ„ç‚ºå¯é¸æ¨¡çµ„ï¼Œåƒ…åœ¨éœ€è¦ä½¿ç”¨ TinyMCE å¯Œæ–‡æœ¬ç·¨è¼¯å™¨æ™‚å°å…¥
 5:  *
 6:  * ä½¿ç”¨æ–¹å¼ï¼š
 7:  * ```typescript
 8:  * import { SHARED_TINYMCE_MODULES } from '@shared/shared-tinymce.module';
 9:  *
10:  * @Component({
11:  *   imports: [SHARED_IMPORTS, ...SHARED_TINYMCE_MODULES]
12:  * })
13:  * ```
14:  *
15:  * æˆ–åœ¨éœ€è¦æ™‚ç›´æ¥å°å…¥ï¼š
16:  * ```typescript
17:  * import { EditorModule } from 'ngx-tinymce';
18:  *
19:  * @Component({
20:  *   imports: [SHARED_IMPORTS, EditorModule]
21:  * })
22:  * ```
23:  *
24:  * @see https://github.com/ng-alain/ng-alain/tree/master/packages/tinymce
25:  * @see https://www.tiny.cloud/docs/tinymce/latest/
26:  */
27: 
28: // æ³¨æ„ï¼šngx-tinymce åœ¨ package.json ä¸­å·²å®‰è£ï¼Œä½†ç•¶å‰æœªä½¿ç”¨
29: // å¦‚éœ€ä½¿ç”¨ï¼Œè«‹å–æ¶ˆä¸‹é¢çš„è¨»é‡‹ä¸¦å®‰è£å°æ‡‰çš„é¡å‹å®šç¾©ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
30: // import { EditorModule } from 'ngx-tinymce';
31: 
32: /**
33:  * ngx-tinymce æ¨¡çµ„é›†åˆ
34:  *
35:  * ç›®å‰ç‚ºç©ºæ•¸çµ„ï¼Œå› ç‚ºé …ç›®ä¸­å°šæœªä½¿ç”¨ TinyMCE ç·¨è¼¯å™¨
36:  * å¦‚éœ€ä½¿ç”¨ï¼Œè«‹å–æ¶ˆä¸Šé¢çš„ import ä¸¦å°‡ EditorModule æ·»åŠ åˆ°æ•¸çµ„ä¸­
37:  */
38: export const SHARED_TINYMCE_MODULES: any[] = [
39:   // EditorModule, // TinyMCE å¯Œæ–‡æœ¬ç·¨è¼¯å™¨ â€” https://github.com/ng-alain/ng-alain/tree/master/packages/tinymce
40: ];
````

## File: src/app/shared/shared-zorro.module.ts
````typescript
  1: import { NzAffixModule } from 'ng-zorro-antd/affix';
  2: import { NzAlertModule } from 'ng-zorro-antd/alert';
  3: import { NzAnchorModule } from 'ng-zorro-antd/anchor';
  4: import { NzAutocompleteModule } from 'ng-zorro-antd/auto-complete';
  5: import { NzAvatarModule } from 'ng-zorro-antd/avatar';
  6: import { NzBackTopModule } from 'ng-zorro-antd/back-top';
  7: import { NzBadgeModule } from 'ng-zorro-antd/badge';
  8: import { NzBreadCrumbModule } from 'ng-zorro-antd/breadcrumb';
  9: import { NzButtonModule } from 'ng-zorro-antd/button';
 10: import { NzCalendarModule } from 'ng-zorro-antd/calendar';
 11: import { NzCardModule } from 'ng-zorro-antd/card';
 12: import { NzCarouselModule } from 'ng-zorro-antd/carousel';
 13: import { NzCascaderModule } from 'ng-zorro-antd/cascader';
 14: import { NzCheckListModule } from 'ng-zorro-antd/check-list';
 15: import { NzCheckboxModule } from 'ng-zorro-antd/checkbox';
 16: import { NzCollapseModule } from 'ng-zorro-antd/collapse';
 17: import { NzColorPickerModule } from 'ng-zorro-antd/color-picker';
 18: import { NzCommentModule } from 'ng-zorro-antd/comment';
 19: import { NzDatePickerModule } from 'ng-zorro-antd/date-picker';
 20: import { NzDescriptionsModule } from 'ng-zorro-antd/descriptions';
 21: import { NzDividerModule } from 'ng-zorro-antd/divider';
 22: import { NzDrawerModule } from 'ng-zorro-antd/drawer';
 23: import { NzDropDownModule } from 'ng-zorro-antd/dropdown';
 24: import { NzEmptyModule } from 'ng-zorro-antd/empty';
 25: import { NzFlexModule } from 'ng-zorro-antd/flex';
 26: import { NzFloatButtonModule } from 'ng-zorro-antd/float-button';
 27: import { NzFormModule } from 'ng-zorro-antd/form';
 28: import { NzGridModule } from 'ng-zorro-antd/grid';
 29: import { NzHashCodeModule } from 'ng-zorro-antd/hash-code';
 30: import { NzIconModule } from 'ng-zorro-antd/icon';
 31: import { NzImageModule } from 'ng-zorro-antd/image';
 32: import { NzInputModule } from 'ng-zorro-antd/input';
 33: import { NzInputNumberModule } from 'ng-zorro-antd/input-number';
 34: import { NzLayoutModule } from 'ng-zorro-antd/layout';
 35: import { NzListModule } from 'ng-zorro-antd/list';
 36: import { NzMentionModule } from 'ng-zorro-antd/mention';
 37: import { NzMenuModule } from 'ng-zorro-antd/menu';
 38: import { NzModalModule } from 'ng-zorro-antd/modal';
 39: import { NzPageHeaderModule } from 'ng-zorro-antd/page-header';
 40: import { NzPaginationModule } from 'ng-zorro-antd/pagination';
 41: import { NzPopconfirmModule } from 'ng-zorro-antd/popconfirm';
 42: import { NzPopoverModule } from 'ng-zorro-antd/popover';
 43: import { NzProgressModule } from 'ng-zorro-antd/progress';
 44: import { NzQRCodeModule } from 'ng-zorro-antd/qr-code';
 45: import { NzRadioModule } from 'ng-zorro-antd/radio';
 46: import { NzRateModule } from 'ng-zorro-antd/rate';
 47: import { NzResultModule } from 'ng-zorro-antd/result';
 48: import { NzSegmentedModule } from 'ng-zorro-antd/segmented';
 49: import { NzSelectModule } from 'ng-zorro-antd/select';
 50: import { NzSkeletonModule } from 'ng-zorro-antd/skeleton';
 51: import { NzSliderModule } from 'ng-zorro-antd/slider';
 52: import { NzSpaceModule } from 'ng-zorro-antd/space';
 53: import { NzSpinModule } from 'ng-zorro-antd/spin';
 54: import { NzSplitterModule } from 'ng-zorro-antd/splitter';
 55: import { NzStatisticModule } from 'ng-zorro-antd/statistic';
 56: import { NzStepsModule } from 'ng-zorro-antd/steps';
 57: import { NzSwitchModule } from 'ng-zorro-antd/switch';
 58: import { NzTableModule } from 'ng-zorro-antd/table';
 59: import { NzTabsModule } from 'ng-zorro-antd/tabs';
 60: import { NzTagModule } from 'ng-zorro-antd/tag';
 61: import { NzTimePickerModule } from 'ng-zorro-antd/time-picker';
 62: import { NzTimelineModule } from 'ng-zorro-antd/timeline';
 63: import { NzTooltipModule } from 'ng-zorro-antd/tooltip';
 64: import { NzTransferModule } from 'ng-zorro-antd/transfer';
 65: import { NzTreeModule } from 'ng-zorro-antd/tree';
 66: import { NzTreeSelectModule } from 'ng-zorro-antd/tree-select';
 67: import { NzTreeViewModule } from 'ng-zorro-antd/tree-view';
 68: import { NzTypographyModule } from 'ng-zorro-antd/typography';
 69: import { NzUploadModule } from 'ng-zorro-antd/upload';
 70: import { NzWaterMarkModule } from 'ng-zorro-antd/water-mark';
 71: 
 72: export const SHARED_ZORRO_MODULES = [
 73:   // åé¥‹é¡çµ„ä»¶
 74:   NzAlertModule, // Alert è­¦å‘Šæç¤º - https://ng.ant.design/components/alert/en
 75:   NzResultModule, // Result çµæœ - https://ng.ant.design/components/result/en
 76:   NzSkeletonModule, // Skeleton éª¨æ¶å± - https://ng.ant.design/components/skeleton/en
 77:   NzSpinModule, // Spin åŠ è¼‰ä¸­ - https://ng.ant.design/components/spin/en
 78:   NzProgressModule, // Progress é€²åº¦æ¢ - https://ng.ant.design/components/progress/en
 79:   NzDrawerModule, // Drawer æŠ½å±œ - https://ng.ant.design/components/drawer/en
 80:   NzModalModule, // Modal å°è©±æ¡† - https://ng.ant.design/components/modal/en
 81:   NzPopconfirmModule, // Popconfirm æ°£æ³¡ç¢ºèªæ¡† - https://ng.ant.design/components/popconfirm/en
 82:   // æ³¨æ„ï¼šMessage å’Œ Notification åœ¨ ng-zorro-antd v20+ ä¸­é€šéæœå‹™æä¾›ï¼ˆNzMessageService, NzNotificationServiceï¼‰
 83:   // ä¸éœ€è¦å°å…¥æ¨¡çµ„ï¼Œå¯ç›´æ¥æ³¨å…¥ä½¿ç”¨
 84:   // æ•¸æ“šå±•ç¤ºé¡çµ„ä»¶
 85:   NzAvatarModule, // Avatar é ­åƒ - https://ng.ant.design/components/avatar/en
 86:   NzBadgeModule, // Badge å¾½æ¨™æ•¸ - https://ng.ant.design/components/badge/en
 87:   NzCalendarModule, // Calendar æ—¥æ›† - https://ng.ant.design/components/calendar/en
 88:   NzCardModule, // Card å¡ç‰‡ - https://ng.ant.design/components/card/en
 89:   NzCarouselModule, // Carousel èµ°é¦¬ç‡ˆ - https://ng.ant.design/components/carousel/en
 90:   NzCollapseModule, // Collapse æŠ˜ç–Šé¢æ¿ - https://ng.ant.design/components/collapse/en
 91:   NzCommentModule, // Comment è©•è«– - https://ng.ant.design/components/comment/en
 92:   NzDescriptionsModule, // Descriptions æè¿°åˆ—è¡¨ - https://ng.ant.design/components/descriptions/en
 93:   NzEmptyModule, // Empty ç©ºç‹€æ…‹ - https://ng.ant.design/components/empty/en
 94:   NzImageModule, // Image åœ–ç‰‡ - https://ng.ant.design/components/image/en
 95:   NzListModule, // List åˆ—è¡¨ - https://ng.ant.design/components/list/en
 96:   NzPopoverModule, // Popover æ°£æ³¡å¡ç‰‡ - https://ng.ant.design/components/popover/en
 97:   NzQRCodeModule, // QRCode äºŒç¶­ç¢¼ - https://ng.ant.design/components/qr-code/en
 98:   NzSegmentedModule, // Segmented åˆ†æ®µæ§åˆ¶å™¨ - https://ng.ant.design/components/segmented/en
 99:   NzStatisticModule, // Statistic çµ±è¨ˆ - https://ng.ant.design/components/statistic/en
100:   NzTableModule, // Table è¡¨æ ¼ - https://ng.ant.design/components/table/en
101:   NzTagModule, // Tag æ¨™ç±¤ - https://ng.ant.design/components/tag/en
102:   NzTimelineModule, // Timeline æ™‚é–“è»¸ - https://ng.ant.design/components/timeline/en
103:   NzTooltipModule, // Tooltip æ–‡å­—æç¤º - https://ng.ant.design/components/tooltip/en
104:   NzTreeModule, // Tree æ¨¹å½¢æ§ä»¶ - https://ng.ant.design/components/tree/en
105:   NzTreeViewModule, // TreeView æ¨¹è¦–åœ– - https://ng.ant.design/components/tree-view/en
106:   // æ•¸æ“šéŒ„å…¥é¡çµ„ä»¶
107:   NzAutocompleteModule, // AutoComplete è‡ªå‹•å®Œæˆ - https://ng.ant.design/components/auto-complete/en
108:   NzCascaderModule, // Cascader ç´šè¯é¸æ“‡ - https://ng.ant.design/components/cascader/en
109:   NzCheckboxModule, // Checkbox å¤šé¸æ¡† - https://ng.ant.design/components/checkbox/en
110:   NzColorPickerModule, // ColorPicker é¡è‰²é¸æ“‡å™¨ - https://ng.ant.design/components/color-picker/en
111:   NzDatePickerModule, // DatePicker æ—¥æœŸé¸æ“‡æ¡† - https://ng.ant.design/components/date-picker/en
112:   NzFormModule, // Form è¡¨å–® - https://ng.ant.design/components/form/en
113:   NzInputModule, // Input è¼¸å…¥æ¡† - https://ng.ant.design/components/input/en
114:   NzInputNumberModule, // InputNumber æ•¸å­—è¼¸å…¥æ¡† - https://ng.ant.design/components/input-number/en
115:   NzMentionModule, // Mention æåŠ - https://ng.ant.design/components/mention/en
116:   NzRadioModule, // Radio å–®é¸æ¡† - https://ng.ant.design/components/radio/en
117:   NzRateModule, // Rate è©•åˆ† - https://ng.ant.design/components/rate/en
118:   NzSelectModule, // Select é¸æ“‡å™¨ - https://ng.ant.design/components/select/en
119:   NzSliderModule, // Slider æ»‘å‹•è¼¸å…¥æ¢ - https://ng.ant.design/components/slider/en
120:   NzSwitchModule, // Switch é–‹é—œ - https://ng.ant.design/components/switch/en
121:   NzTimePickerModule, // TimePicker æ™‚é–“é¸æ“‡æ¡† - https://ng.ant.design/components/time-picker/en
122:   NzTransferModule, // Transfer ç©¿æ¢­æ¡† - https://ng.ant.design/components/transfer/en
123:   NzTreeSelectModule, // TreeSelect æ¨¹é¸æ“‡ - https://ng.ant.design/components/tree-select/en
124:   NzUploadModule, // Upload ä¸Šå‚³ - https://ng.ant.design/components/upload/en
125:   // ä½ˆå±€é¡çµ„ä»¶
126:   NzDividerModule, // Divider åˆ†å‰²ç·š - https://ng.ant.design/components/divider/en
127:   NzFlexModule, // Flex å½ˆæ€§ä½ˆå±€ - https://ng.ant.design/components/flex/en
128:   NzGridModule, // Grid æŸµæ ¼ - https://ng.ant.design/components/grid/en
129:   NzLayoutModule, // Layout ä½ˆå±€ - https://ng.ant.design/components/layout/en
130:   NzSpaceModule, // Space é–“è· - https://ng.ant.design/components/space/en
131:   NzSplitterModule, // Splitter åˆ†éš”é¢æ¿ - https://ng.ant.design/components/splitter/en
132:   // é€šç”¨é¡çµ„ä»¶
133:   NzButtonModule, // Button æŒ‰éˆ• - https://ng.ant.design/components/button/en
134:   NzFloatButtonModule, // FloatButton æ‡¸æµ®æŒ‰éˆ• - https://ng.ant.design/components/float-button/en
135:   NzIconModule, // Icon åœ–æ¨™ - https://ng.ant.design/components/icon/en
136:   NzTypographyModule, // Typography æ’ç‰ˆ - https://ng.ant.design/components/typography/en
137:   // å°èˆªé¡çµ„ä»¶
138:   NzAnchorModule, // Anchor éŒ¨é» - https://ng.ant.design/components/anchor/en
139:   NzBreadCrumbModule, // Breadcrumb éºµåŒ…å±‘ - https://ng.ant.design/components/breadcrumb/en
140:   NzDropDownModule, // Dropdown ä¸‹æ‹‰èœå–® - https://ng.ant.design/components/dropdown/en
141:   NzMenuModule, // Menu å°èˆªèœå–® - https://ng.ant.design/components/menu/en
142:   NzPageHeaderModule, // PageHeader é é ­ - https://ng.ant.design/components/page-header/en
143:   NzPaginationModule, // Pagination åˆ†é  - https://ng.ant.design/components/pagination/en
144:   NzStepsModule, // Steps æ­¥é©Ÿæ¢ - https://ng.ant.design/components/steps/en
145:   NzTabsModule, // Tabs æ¨™ç±¤é  - https://ng.ant.design/components/tabs/en
146:   // å…¶ä»–é¡çµ„ä»¶
147:   NzAffixModule, // Affix å›ºé‡˜ - https://ng.ant.design/components/affix/en
148:   NzBackTopModule, // BackTop è¿”å›é ‚éƒ¨ - https://ng.ant.design/components/back-top/en
149:   NzWaterMarkModule, // WaterMark æ°´å° - https://ng.ant.design/components/water-mark/en
150:   // ç‰¹è‰²çµ„ä»¶
151:   NzCheckListModule, // CheckList ä»»å‹™æ¸…å–® - https://ng.ant.design/components/check-list/en
152:   NzHashCodeModule // HashCode å“ˆå¸Œç¢¼ - https://ng.ant.design/components/hash-code/en
153: ];
````

## File: src/app/shared/st-widget/index.ts
````typescript
1: import type { STWidgetProvideConfig } from '@delon/abc/st';
2: 
3: export const ST_WIDGETS: STWidgetProvideConfig[] = [];
````

## File: src/app/shared/utils/yuan.ts
````typescript
 1: /**
 2:  * è½¬åŒ–æˆRMBå…ƒå­—ç¬¦ä¸²
 3:  *
 4:  * @param digits å½“æ•°å­—ç±»å‹æ—¶ï¼Œå…è®¸æŒ‡å®šå°æ•°ç‚¹åæ•°å­—çš„ä¸ªæ•°ï¼Œé»˜è®¤2ä½å°æ•°
 5:  */
 6: export function yuan(value: number | string, digits = 2): string {
 7:   if (typeof value === 'number') {
 8:     value = value.toFixed(digits);
 9:   }
10:   return `&yen ${value}`;
11: }
````

## File: src/environments/environment.prod.ts
````typescript
 1: // This file can be replaced during build by using the `fileReplacements` array.
 2: // `ng build ---prod` replaces `environment.ts` with `environment.prod.ts`.
 3: // The list of file replacements can be found in `angular.json`.
 4: 
 5: import * as MOCKDATA from '@_mock';
 6: import { mockInterceptor, provideMockConfig } from '@delon/mock';
 7: import { Environment } from '@delon/theme';
 8: 
 9: export const environment = {
10:   production: true,
11:   useHash: true,
12:   api: {
13:     baseUrl: './',
14:     refreshTokenEnabled: true,
15:     refreshTokenType: 'auth-refresh'
16:   },
17:   supabase: {
18:     url: 'https://pfxxjtvnqptdvjfakotc.supabase.co',
19:     anonKey:
20:       'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmeHhqdHZucXB0ZHZqZmFrb3RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzgwNjMsImV4cCI6MjA3ODY1NDA2M30.xADVH2fTd4059lZSZWpIM6CSeiixm0VCgN0SC5bKGxo',
21:     storage: {
22:       documentBucket: 'blueprint-documents'
23:     }
24:   },
25:   providers: [provideMockConfig({ data: MOCKDATA })],
26:   interceptorFns: [mockInterceptor]
27: } as Environment;
````

## File: src/environments/environment.ts
````typescript
 1: // This file can be replaced during build by using the `fileReplacements` array.
 2: // `ng build ---prod` replaces `environment.ts` with `environment.prod.ts`.
 3: // The list of file replacements can be found in `angular.json`.
 4: 
 5: import * as MOCKDATA from '@_mock';
 6: import { mockInterceptor, provideMockConfig } from '@delon/mock';
 7: import { Environment } from '@delon/theme';
 8: 
 9: export const environment = {
10:   production: false,
11:   useHash: true,
12:   api: {
13:     baseUrl: './',
14:     refreshTokenEnabled: true,
15:     refreshTokenType: 'auth-refresh'
16:   },
17:   supabase: {
18:     url: 'https://pfxxjtvnqptdvjfakotc.supabase.co',
19:     anonKey:
20:       'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmeHhqdHZucXB0ZHZqZmFrb3RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzgwNjMsImV4cCI6MjA3ODY1NDA2M30.xADVH2fTd4059lZSZWpIM6CSeiixm0VCgN0SC5bKGxo',
21:     storage: {
22:       documentBucket: 'blueprint-documents'
23:     }
24:   },
25:   providers: [provideMockConfig({ data: MOCKDATA })],
26:   interceptorFns: [mockInterceptor]
27: } as Environment;
````

## File: src/main.ts
````typescript
1: import { bootstrapApplication } from '@angular/platform-browser';
2: 
3: import { AppComponent } from './app/app.component';
4: import { appConfig } from './app/app.config';
5: 
6: bootstrapApplication(AppComponent, appConfig).catch(err => console.error(err));
````

## File: src/style-icons-auto.ts
````typescript
  1: /*
  2:  * Automatically generated by 'ng g ng-alain:plugin icon'
  3:  * @see https://ng-alain.com/cli/plugin#icon
  4:  */
  5: 
  6: import {
  7:   AlipayCircleOutline,
  8:   ApartmentOutline,
  9:   ApiOutline,
 10:   AppstoreOutline,
 11:   AreaChartOutline,
 12:   ArrowDownOutline,
 13:   ArrowLeftOutline,
 14:   ArrowRightOutline,
 15:   BarChartOutline,
 16:   BellOutline,
 17:   BookOutline,
 18:   BorderLeftOutline,
 19:   BorderRightOutline,
 20:   BugOutline,
 21:   BulbOutline,
 22:   CalendarOutline,
 23:   CheckCircleOutline,
 24:   CheckOutline,
 25:   CheckSquareOutline,
 26:   ClearOutline,
 27:   ClockCircleOutline,
 28:   CloseCircleOutline,
 29:   CloudOutline,
 30:   CommentOutline,
 31:   ContactsOutline,
 32:   CopyrightOutline,
 33:   CustomerServiceOutline,
 34:   DashboardOutline,
 35:   DatabaseOutline,
 36:   DeleteOutline,
 37:   DingdingOutline,
 38:   DisconnectOutline,
 39:   DislikeOutline,
 40:   DownloadOutline,
 41:   EditOutline,
 42:   EllipsisOutline,
 43:   ExclamationCircleOutline,
 44:   EyeInvisibleOutline,
 45:   EyeOutline,
 46:   FileAddOutline,
 47:   FileExcelOutline,
 48:   FileImageOutline,
 49:   FileOutline,
 50:   FilePdfOutline,
 51:   FileTextOutline,
 52:   FilterOutline,
 53:   FolderAddOutline,
 54:   FolderOpenOutline,
 55:   FolderOutline,
 56:   ForkOutline,
 57:   FrownOutline,
 58:   FullscreenExitOutline,
 59:   FullscreenOutline,
 60:   GithubOutline,
 61:   GlobalOutline,
 62:   GroupOutline,
 63:   HddOutline,
 64:   HeartOutline,
 65:   HistoryOutline,
 66:   HomeOutline,
 67:   InfoCircleOutline,
 68:   LaptopOutline,
 69:   LikeOutline,
 70:   LineChartOutline,
 71:   LinkOutline,
 72:   LockOutline,
 73:   LogoutOutline,
 74:   MailOutline,
 75:   AppstoreOutline as MenuAppOutline,
 76:   MenuFoldOutline,
 77:   MenuOutline,
 78:   MenuUnfoldOutline,
 79:   MessageOutline,
 80:   MinusCircleOutline,
 81:   OrderedListOutline,
 82:   PayCircleOutline,
 83:   PieChartOutline,
 84:   PlusOutline,
 85:   PrinterOutline,
 86:   RedoOutline,
 87:   ReloadOutline,
 88:   RobotOutline,
 89:   RocketOutline,
 90:   RotateLeftOutline,
 91:   SafetyOutline,
 92:   SaveOutline,
 93:   ScanOutline,
 94:   ScheduleOutline,
 95:   SearchOutline,
 96:   SendOutline,
 97:   SettingOutline,
 98:   ShareAltOutline,
 99:   ShoppingCartOutline,
100:   SortAscendingOutline,
101:   SortDescendingOutline,
102:   SoundOutline,
103:   StarOutline,
104:   SwapOutline,
105:   SyncOutline,
106:   TableOutline,
107:   TaobaoCircleOutline,
108:   TaobaoOutline,
109:   TeamOutline,
110:   ThunderboltOutline,
111:   ToolOutline,
112:   TrophyOutline,
113:   UndoOutline,
114:   UnlockOutline,
115:   UnorderedListOutline,
116:   UploadOutline,
117:   UsbOutline,
118:   UserAddOutline,
119:   UserDeleteOutline,
120:   UserOutline,
121:   WarningOutline,
122:   WeiboCircleOutline,
123:   WifiOutline
124: } from '@ant-design/icons-angular/icons';
125: 
126: export const ICONS_AUTO = [
127:   AlipayCircleOutline,
128:   ApiOutline,
129:   AppstoreOutline,
130:   ArrowDownOutline,
131:   BookOutline,
132:   BorderLeftOutline,
133:   BorderRightOutline,
134:   CloudOutline,
135:   CopyrightOutline,
136:   CustomerServiceOutline,
137:   DashboardOutline,
138:   DatabaseOutline,
139:   DingdingOutline,
140:   DislikeOutline,
141:   DownloadOutline,
142:   ForkOutline,
143:   FrownOutline,
144:   FullscreenExitOutline,
145:   FullscreenOutline,
146:   GithubOutline,
147:   GlobalOutline,
148:   HddOutline,
149:   LaptopOutline,
150:   LikeOutline,
151:   LockOutline,
152:   LogoutOutline,
153:   MailOutline,
154:   MenuFoldOutline,
155:   MenuUnfoldOutline,
156:   MessageOutline,
157:   PayCircleOutline,
158:   PieChartOutline,
159:   PrinterOutline,
160:   RocketOutline,
161:   ScanOutline,
162:   SettingOutline,
163:   ShareAltOutline,
164:   ShoppingCartOutline,
165:   SoundOutline,
166:   StarOutline,
167:   TaobaoCircleOutline,
168:   TaobaoOutline,
169:   TeamOutline,
170:   ToolOutline,
171:   TrophyOutline,
172:   UsbOutline,
173:   UserOutline,
174:   WeiboCircleOutline,
175:   ApartmentOutline,
176:   SwapOutline,
177:   PlusOutline,
178:   ArrowLeftOutline,
179:   LinkOutline,
180:   SearchOutline,
181:   CheckOutline,
182:   CloseCircleOutline,
183:   UploadOutline,
184:   CheckCircleOutline,
185:   EllipsisOutline,
186:   ArrowRightOutline,
187:   InfoCircleOutline,
188:   CheckSquareOutline,
189:   EditOutline,
190:   DeleteOutline,
191:   SaveOutline,
192:   FileOutline,
193:   FileAddOutline,
194:   FileTextOutline,
195:   FolderOutline,
196:   FolderOpenOutline,
197:   FolderAddOutline,
198:   UnorderedListOutline,
199:   OrderedListOutline,
200:   TableOutline,
201:   ClockCircleOutline,
202:   CalendarOutline,
203:   ScheduleOutline,
204:   SafetyOutline,
205:   BellOutline,
206:   ExclamationCircleOutline,
207:   WarningOutline,
208:   MinusCircleOutline,
209:   ReloadOutline,
210:   SyncOutline,
211:   RedoOutline,
212:   UndoOutline,
213:   RotateLeftOutline,
214:   HomeOutline,
215:   MenuOutline,
216:   HistoryOutline,
217:   EyeOutline,
218:   EyeInvisibleOutline,
219:   MenuAppOutline,
220:   UserAddOutline,
221:   UserDeleteOutline,
222:   ContactsOutline,
223:   FileExcelOutline,
224:   FilePdfOutline,
225:   FileImageOutline,
226:   SendOutline,
227:   CommentOutline,
228:   FilterOutline,
229:   SortAscendingOutline,
230:   SortDescendingOutline,
231:   ClearOutline,
232:   BarChartOutline,
233:   LineChartOutline,
234:   AreaChartOutline,
235:   WifiOutline,
236:   DisconnectOutline,
237:   UnlockOutline,
238:   GroupOutline,
239:   HeartOutline,
240:   ThunderboltOutline,
241:   BugOutline,
242:   RobotOutline,
243:   BulbOutline
244: ];
````

## File: src/style-icons.ts
````typescript
 1: // Custom icon static resources
 2: 
 3: import {
 4:   BulbOutline,
 5:   ExceptionOutline,
 6:   InfoOutline,
 7:   LinkOutline,
 8:   MinusSquareOutline,
 9:   PlusSquareOutline,
10:   ProfileOutline
11: } from '@ant-design/icons-angular/icons';
12: 
13: export const ICONS = [InfoOutline, BulbOutline, ProfileOutline, ExceptionOutline, LinkOutline, PlusSquareOutline, MinusSquareOutline];
````

## File: src/typings.d.ts
````typescript
1: // # 3rd Party Library
2: // If the library doesn't have typings available at `@types/`,
3: // you can still use it by manually adding typings for it
````

## File: src/app/core/index.ts
````typescript
1: export * from './i18n/i18n.service';
2: export * from './menu-context';
3: export * from './net/index';
4: export * from './startup/startup.service';
5: export * from './start-page.guard';
6: export * from './supabase';
7: export * from './permissions';
8: export * from './infra';
9: export * from './services/branch-context.service';
````

## File: src/app/core/infra/repositories/analytics-cache.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable, from } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: import { toCamelCaseData } from '../utils/transformers';
  8: 
  9: /**
 10:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 11:  */
 12: type AnalyticsCacheRow = Database['public']['Tables']['analytics_cache']['Row'];
 13: type AnalyticsCacheInsert = Database['public']['Tables']['analytics_cache']['Insert'];
 14: type AnalyticsCacheUpdate = Database['public']['Tables']['analytics_cache']['Update'];
 15: 
 16: /**
 17:  * AnalyticsCache å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 18:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 19:  */
 20: export type AnalyticsCache = AnalyticsCacheRow;
 21: export type { AnalyticsCacheInsert, AnalyticsCacheUpdate };
 22: 
 23: /**
 24:  * AnalyticsCache Repository
 25:  *
 26:  * æä¾›åˆ†æç¼“å­˜ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 27:  *
 28:  * @example
 29:  * ```typescript
 30:  * const cacheRepo = inject(AnalyticsCacheRepository);
 31:  * cacheRepo.findByCacheKey('cache-key').subscribe(cache => {
 32:  *   console.log('Cache:', cache);
 33:  * });
 34:  * ```
 35:  */
 36: @Injectable({
 37:   providedIn: 'root'
 38: })
 39: export class AnalyticsCacheRepository extends BaseRepository<AnalyticsCache, AnalyticsCacheInsert, AnalyticsCacheUpdate> {
 40:   protected tableName = 'analytics_cache';
 41: 
 42:   /**
 43:    * æ ¹æ®ç¼“å­˜é”®æŸ¥è¯¢ç¼“å­˜
 44:    *
 45:    * @param cacheKey ç¼“å­˜é”®
 46:    * @returns Observable<AnalyticsCache | null>
 47:    */
 48:   findByCacheKey(cacheKey: string): Observable<AnalyticsCache | null> {
 49:     return this.findAll({
 50:       filters: {
 51:         cacheKey // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º cache_key
 52:       }
 53:     }).pipe(map(caches => (caches.length > 0 ? caches[0] : null)));
 54:   }
 55: 
 56:   /**
 57:    * æ ¹æ®ç¼“å­˜ç±»å‹æŸ¥è¯¢ç¼“å­˜
 58:    *
 59:    * @param cacheType ç¼“å­˜ç±»å‹
 60:    * @param options æŸ¥è¯¢é€‰é¡¹
 61:    * @returns Observable<AnalyticsCache[]>
 62:    */
 63:   findByCacheType(cacheType: string, options?: QueryOptions): Observable<AnalyticsCache[]> {
 64:     return this.findAll({
 65:       ...options,
 66:       filters: {
 67:         ...options?.filters,
 68:         cacheType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º cache_type
 69:       }
 70:     });
 71:   }
 72: 
 73:   /**
 74:    * æ ¹æ®è“å›¾ ID æŸ¥è¯¢ç¼“å­˜
 75:    *
 76:    * @param blueprintId è“å›¾ ID
 77:    * @param options æŸ¥è¯¢é€‰é¡¹
 78:    * @returns Observable<AnalyticsCache[]>
 79:    */
 80:   findByBlueprintId(blueprintId: string, options?: QueryOptions): Observable<AnalyticsCache[]> {
 81:     return this.findAll({
 82:       ...options,
 83:       filters: {
 84:         ...options?.filters,
 85:         blueprintId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º blueprint_id
 86:       }
 87:     });
 88:   }
 89: 
 90:   /**
 91:    * æ ¹æ®åˆ†æ”¯ ID æŸ¥è¯¢ç¼“å­˜
 92:    *
 93:    * @param branchId åˆ†æ”¯ ID
 94:    * @param options æŸ¥è¯¢é€‰é¡¹
 95:    * @returns Observable<AnalyticsCache[]>
 96:    */
 97:   findByBranchId(branchId: string, options?: QueryOptions): Observable<AnalyticsCache[]> {
 98:     return this.findAll({
 99:       ...options,
100:       filters: {
101:         ...options?.filters,
102:         branchId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º branch_id
103:       }
104:     });
105:   }
106: 
107:   /**
108:    * æŸ¥è¯¢è¿‡æœŸçš„ç¼“å­˜
109:    *
110:    * @returns Observable<AnalyticsCache[]>
111:    */
112:   findExpiredCaches(): Observable<AnalyticsCache[]> {
113:     // è¿‡æœŸçš„ç¼“å­˜ï¼šexpires_at < NOW()
114:     const now = new Date().toISOString();
115:     let query: any = this.supabase
116:       .from(this.tableName as any)
117:       .select('*')
118:       .lt('expires_at', now)
119:       .order('expires_at', { ascending: true });
120: 
121:     return from(Promise.resolve(query) as Promise<{ data: any[] | null; error: any }>).pipe(
122:       map((response: { data: any[] | null; error: any }) => {
123:         if (response.error) {
124:           throw new Error(response.error.message || 'æŸ¥è¯¢è¿‡æœŸç¼“å­˜å¤±è´¥');
125:         }
126:         return (response.data || []).map(item => toCamelCaseData<AnalyticsCache>(item));
127:       })
128:     );
129:   }
130: 
131:   /**
132:    * æŸ¥è¯¢æœ‰æ•ˆçš„ç¼“å­˜ï¼ˆæœªè¿‡æœŸï¼‰
133:    *
134:    * @param options æŸ¥è¯¢é€‰é¡¹
135:    * @returns Observable<AnalyticsCache[]>
136:    */
137:   findValidCaches(options?: QueryOptions): Observable<AnalyticsCache[]> {
138:     // æœ‰æ•ˆçš„ç¼“å­˜ï¼šexpires_at >= NOW()
139:     const now = new Date().toISOString();
140:     let query: any = this.supabase
141:       .from(this.tableName as any)
142:       .select('*')
143:       .gte('expires_at', now);
144: 
145:     // åº”ç”¨æ’åº
146:     if (options?.orderBy) {
147:       const snakeOrderBy = options.orderBy.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);
148:       query = query.order(snakeOrderBy, { ascending: options.orderDirection !== 'desc' });
149:     } else {
150:       query = query.order('expires_at', { ascending: true });
151:     }
152: 
153:     // åº”ç”¨åˆ†é¡µ
154:     if (options?.page && options?.pageSize) {
155:       const fromIndex = (options.page - 1) * options.pageSize;
156:       const toIndex = fromIndex + options.pageSize - 1;
157:       query = query.range(fromIndex, toIndex);
158:     }
159: 
160:     return from(Promise.resolve(query) as Promise<{ data: any[] | null; error: any }>).pipe(
161:       map((response: { data: any[] | null; error: any }) => {
162:         if (response.error) {
163:           throw new Error(response.error.message || 'æŸ¥è¯¢æœ‰æ•ˆç¼“å­˜å¤±è´¥');
164:         }
165:         return (response.data || []).map(item => toCamelCaseData<AnalyticsCache>(item));
166:       })
167:     );
168:   }
169: }
````

## File: src/app/core/infra/repositories/blueprint-branch.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { BranchStatus, BranchType } from '../types/blueprint.types';
  7: import { Database } from '../types/database.types';
  8: 
  9: /**
 10:  * BlueprintBranch å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 11:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–ï¼Œåç»­ä¼šé€šè¿‡è½¬æ¢å·¥å…·è½¬æ¢ä¸º camelCase
 12:  */
 13: type BlueprintBranchRow = Database['public']['Tables']['blueprint_branches']['Row'];
 14: type BlueprintBranchInsert = Database['public']['Tables']['blueprint_branches']['Insert'];
 15: type BlueprintBranchUpdate = Database['public']['Tables']['blueprint_branches']['Update'];
 16: 
 17: /**
 18:  * BlueprintBranch å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 19:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 20:  */
 21: export type BlueprintBranch = BlueprintBranchRow;
 22: export type { BlueprintBranchInsert, BlueprintBranchUpdate };
 23: 
 24: /**
 25:  * BlueprintBranch Repository
 26:  *
 27:  * æä¾›è“å›¾åˆ†æ”¯ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 28:  *
 29:  * @example
 30:  * ```typescript
 31:  * const branchRepo = inject(BlueprintBranchRepository);
 32:  * branchRepo.findByBlueprintId('blueprint-id').subscribe(branches => {
 33:  *   console.log('Blueprint branches:', branches);
 34:  * });
 35:  * ```
 36:  */
 37: @Injectable({
 38:   providedIn: 'root'
 39: })
 40: export class BlueprintBranchRepository extends BaseRepository<BlueprintBranch, BlueprintBranchInsert, BlueprintBranchUpdate> {
 41:   protected tableName = 'blueprint_branches';
 42: 
 43:   /**
 44:    * æ ¹æ®è“å›¾ ID æŸ¥è¯¢åˆ†æ”¯
 45:    *
 46:    * @param blueprintId è“å›¾ ID
 47:    * @param options æŸ¥è¯¢é€‰é¡¹
 48:    * @returns Observable<BlueprintBranch[]>
 49:    */
 50:   findByBlueprintId(blueprintId: string, options?: QueryOptions): Observable<BlueprintBranch[]> {
 51:     return this.findAll({
 52:       ...options,
 53:       filters: {
 54:         ...options?.filters,
 55:         blueprintId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º blueprint_id
 56:       }
 57:     });
 58:   }
 59: 
 60:   /**
 61:    * æ ¹æ®ç»„ç»‡ ID æŸ¥è¯¢åˆ†æ”¯
 62:    *
 63:    * @param organizationId ç»„ç»‡ ID
 64:    * @param options æŸ¥è¯¢é€‰é¡¹
 65:    * @returns Observable<BlueprintBranch[]>
 66:    */
 67:   findByOrganizationId(organizationId: string, options?: QueryOptions): Observable<BlueprintBranch[]> {
 68:     return this.findAll({
 69:       ...options,
 70:       filters: {
 71:         ...options?.filters,
 72:         organizationId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º organization_id
 73:       }
 74:     });
 75:   }
 76: 
 77:   /**
 78:    * æ ¹æ®çŠ¶æ€æŸ¥è¯¢åˆ†æ”¯
 79:    *
 80:    * @param status åˆ†æ”¯çŠ¶æ€
 81:    * @param options æŸ¥è¯¢é€‰é¡¹
 82:    * @returns Observable<BlueprintBranch[]>
 83:    */
 84:   findByStatus(status: BranchStatus, options?: QueryOptions): Observable<BlueprintBranch[]> {
 85:     return this.findAll({
 86:       ...options,
 87:       filters: {
 88:         ...options?.filters,
 89:         status
 90:       }
 91:     });
 92:   }
 93: 
 94:   /**
 95:    * æ ¹æ®åˆ†æ”¯ç±»å‹æŸ¥è¯¢åˆ†æ”¯
 96:    *
 97:    * @param branchType åˆ†æ”¯ç±»å‹
 98:    * @param options æŸ¥è¯¢é€‰é¡¹
 99:    * @returns Observable<BlueprintBranch[]>
100:    */
101:   findByBranchType(branchType: BranchType, options?: QueryOptions): Observable<BlueprintBranch[]> {
102:     return this.findAll({
103:       ...options,
104:       filters: {
105:         ...options?.filters,
106:         branchType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º branch_type
107:       }
108:     });
109:   }
110: 
111:   /**
112:    * æŸ¥è¯¢æ´»è·ƒçš„åˆ†æ”¯ï¼ˆçŠ¶æ€ä¸º activeï¼‰
113:    *
114:    * @param options æŸ¥è¯¢é€‰é¡¹
115:    * @returns Observable<BlueprintBranch[]>
116:    */
117:   findActive(options?: QueryOptions): Observable<BlueprintBranch[]> {
118:     return this.findByStatus(BranchStatus.ACTIVE, options);
119:   }
120: 
121:   /**
122:    * æ ¹æ®è“å›¾ ID å’Œç»„ç»‡ ID æŸ¥è¯¢åˆ†æ”¯ï¼ˆå”¯ä¸€æŸ¥è¯¢ï¼‰
123:    *
124:    * @param blueprintId è“å›¾ ID
125:    * @param organizationId ç»„ç»‡ ID
126:    * @returns Observable<BlueprintBranch | null>
127:    */
128:   findByBlueprintAndOrganization(blueprintId: string, organizationId: string): Observable<BlueprintBranch | null> {
129:     return this.findAll({
130:       filters: {
131:         blueprintId,
132:         organizationId
133:       }
134:     }).pipe(map(branches => (branches.length > 0 ? branches[0] : null)));
135:   }
136: 
137:   /**
138:    * åˆ›å»º Fork åˆ†æ”¯
139:    *
140:    * @param blueprintId è“å›¾ ID
141:    * @param organizationId ç»„ç»‡ ID
142:    * @param branchName åˆ†æ”¯åç§°
143:    * @param branchType åˆ†æ”¯ç±»å‹
144:    * @param notes å¤‡æ³¨
145:    * @returns Observable<BlueprintBranch>
146:    */
147:   createFork(
148:     blueprintId: string,
149:     organizationId: string,
150:     branchName: string,
151:     branchType: BranchType = BranchType.CONTRACTOR,
152:     notes?: string
153:   ): Observable<BlueprintBranch> {
154:     // BaseRepository æœƒè‡ªå‹•é€²è¡Œ camelCase â†’ snake_case è½‰æ›
155:     const insertData = {
156:       blueprintId,
157:       organizationId,
158:       branchName,
159:       branchType,
160:       status: BranchStatus.ACTIVE,
161:       forkedAt: new Date().toISOString(),
162:       notes: notes || null
163:     } as any as BlueprintBranchInsert;
164: 
165:     return this.create(insertData);
166:   }
167: }
````

## File: src/app/core/infra/repositories/bot-execution-log.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: 
  8: /**
  9:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 10:  */
 11: type BotExecutionLogRow = Database['public']['Tables']['bot_execution_logs']['Row'];
 12: type BotExecutionLogInsert = Database['public']['Tables']['bot_execution_logs']['Insert'];
 13: type BotExecutionLogUpdate = Database['public']['Tables']['bot_execution_logs']['Update'];
 14: 
 15: /**
 16:  * BotExecutionLog å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 17:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 18:  */
 19: export type BotExecutionLog = BotExecutionLogRow;
 20: export type { BotExecutionLogInsert, BotExecutionLogUpdate };
 21: 
 22: /**
 23:  * BotExecutionLog Repository
 24:  *
 25:  * æä¾›æœºå™¨äººæ‰§è¡Œæ—¥å¿—ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 26:  *
 27:  * @example
 28:  * ```typescript
 29:  * const logRepo = inject(BotExecutionLogRepository);
 30:  * logRepo.findByBotId('bot-id').subscribe(logs => {
 31:  *   console.log('Execution logs:', logs);
 32:  * });
 33:  * ```
 34:  */
 35: @Injectable({
 36:   providedIn: 'root'
 37: })
 38: export class BotExecutionLogRepository extends BaseRepository<BotExecutionLog, BotExecutionLogInsert, BotExecutionLogUpdate> {
 39:   protected tableName = 'bot_execution_logs';
 40: 
 41:   /**
 42:    * æ ¹æ®æœºå™¨äºº ID æŸ¥è¯¢æ‰§è¡Œæ—¥å¿—
 43:    *
 44:    * @param botId æœºå™¨äºº ID
 45:    * @param options æŸ¥è¯¢é€‰é¡¹
 46:    * @returns Observable<BotExecutionLog[]>
 47:    */
 48:   findByBotId(botId: string, options?: QueryOptions): Observable<BotExecutionLog[]> {
 49:     return this.findAll({
 50:       ...options,
 51:       filters: {
 52:         ...options?.filters,
 53:         botId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º bot_id
 54:       },
 55:       orderBy: 'executedAt',
 56:       orderDirection: 'desc'
 57:     });
 58:   }
 59: 
 60:   /**
 61:    * æ ¹æ®æœºå™¨äººä»»åŠ¡ ID æŸ¥è¯¢æ‰§è¡Œæ—¥å¿—
 62:    *
 63:    * @param botTaskId æœºå™¨äººä»»åŠ¡ ID
 64:    * @param options æŸ¥è¯¢é€‰é¡¹
 65:    * @returns Observable<BotExecutionLog[]>
 66:    */
 67:   findByBotTaskId(botTaskId: string, options?: QueryOptions): Observable<BotExecutionLog[]> {
 68:     return this.findAll({
 69:       ...options,
 70:       filters: {
 71:         ...options?.filters,
 72:         botTaskId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º bot_task_id
 73:       },
 74:       orderBy: 'executedAt',
 75:       orderDirection: 'desc'
 76:     });
 77:   }
 78: 
 79:   /**
 80:    * æ ¹æ®æ‰§è¡ŒçŠ¶æ€æŸ¥è¯¢æ‰§è¡Œæ—¥å¿—
 81:    *
 82:    * @param executionStatus æ‰§è¡ŒçŠ¶æ€
 83:    * @param options æŸ¥è¯¢é€‰é¡¹
 84:    * @returns Observable<BotExecutionLog[]>
 85:    */
 86:   findByExecutionStatus(executionStatus: string, options?: QueryOptions): Observable<BotExecutionLog[]> {
 87:     return this.findAll({
 88:       ...options,
 89:       filters: {
 90:         ...options?.filters,
 91:         executionStatus // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º execution_status
 92:       },
 93:       orderBy: 'executedAt',
 94:       orderDirection: 'desc'
 95:     });
 96:   }
 97: 
 98:   /**
 99:    * æŸ¥è¯¢æœ€è¿‘çš„æ‰§è¡Œæ—¥å¿—
100:    *
101:    * @param botId æœºå™¨äºº IDï¼ˆå¯é€‰ï¼‰
102:    * @param limit é™åˆ¶æ•°é‡ï¼ˆé»˜è®¤ 50ï¼‰
103:    * @returns Observable<BotExecutionLog[]>
104:    */
105:   findRecentLogs(botId?: string, limit = 50): Observable<BotExecutionLog[]> {
106:     let query: any = this.supabase
107:       .from(this.tableName as any)
108:       .select('*')
109:       .order('executed_at', { ascending: false })
110:       .limit(limit);
111: 
112:     if (botId) {
113:       query = query.eq('bot_id', botId);
114:     }
115: 
116:     return this.findAll({
117:       filters: botId ? { botId } : undefined,
118:       orderBy: 'executed_at',
119:       orderDirection: 'desc'
120:     }).pipe(map((logs: BotExecutionLog[]) => logs.slice(0, limit)));
121:   }
122: 
123:   /**
124:    * æŸ¥è¯¢å¤±è´¥çš„æ‰§è¡Œæ—¥å¿—
125:    *
126:    * @param botId æœºå™¨äºº IDï¼ˆå¯é€‰ï¼‰
127:    * @param options æŸ¥è¯¢é€‰é¡¹
128:    * @returns Observable<BotExecutionLog[]>
129:    */
130:   findFailedLogs(botId?: string, options?: QueryOptions): Observable<BotExecutionLog[]> {
131:     return this.findAll({
132:       ...options,
133:       filters: {
134:         ...options?.filters,
135:         executionStatus: 'failed',
136:         ...(botId ? { botId } : {})
137:       },
138:       orderBy: 'executedAt',
139:       orderDirection: 'desc'
140:     });
141:   }
142: }
````

## File: src/app/core/infra/repositories/bot-task.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable, from } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: import { toCamelCaseData } from '../utils/transformers';
  8: 
  9: /**
 10:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 11:  */
 12: type BotTaskRow = Database['public']['Tables']['bot_tasks']['Row'];
 13: type BotTaskInsert = Database['public']['Tables']['bot_tasks']['Insert'];
 14: type BotTaskUpdate = Database['public']['Tables']['bot_tasks']['Update'];
 15: 
 16: /**
 17:  * BotTask å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 18:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 19:  */
 20: export type BotTask = BotTaskRow;
 21: export type { BotTaskInsert, BotTaskUpdate };
 22: 
 23: /**
 24:  * BotTask Repository
 25:  *
 26:  * æä¾›æœºå™¨äººä»»åŠ¡ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 27:  *
 28:  * @example
 29:  * ```typescript
 30:  * const botTaskRepo = inject(BotTaskRepository);
 31:  * botTaskRepo.findByBotId('bot-id').subscribe(tasks => {
 32:  *   console.log('Bot tasks:', tasks);
 33:  * });
 34:  * ```
 35:  */
 36: @Injectable({
 37:   providedIn: 'root'
 38: })
 39: export class BotTaskRepository extends BaseRepository<BotTask, BotTaskInsert, BotTaskUpdate> {
 40:   protected tableName = 'bot_tasks';
 41: 
 42:   /**
 43:    * æ ¹æ®æœºå™¨äºº ID æŸ¥è¯¢æœºå™¨äººä»»åŠ¡
 44:    *
 45:    * @param botId æœºå™¨äºº ID
 46:    * @param options æŸ¥è¯¢é€‰é¡¹
 47:    * @returns Observable<BotTask[]>
 48:    */
 49:   findByBotId(botId: string, options?: QueryOptions): Observable<BotTask[]> {
 50:     return this.findAll({
 51:       ...options,
 52:       filters: {
 53:         ...options?.filters,
 54:         botId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º bot_id
 55:       },
 56:       orderBy: 'createdAt',
 57:       orderDirection: 'desc'
 58:     });
 59:   }
 60: 
 61:   /**
 62:    * æ ¹æ®çŠ¶æ€æŸ¥è¯¢æœºå™¨äººä»»åŠ¡
 63:    *
 64:    * @param status ä»»åŠ¡çŠ¶æ€
 65:    * @param options æŸ¥è¯¢é€‰é¡¹
 66:    * @returns Observable<BotTask[]>
 67:    */
 68:   findByStatus(status: string, options?: QueryOptions): Observable<BotTask[]> {
 69:     return this.findAll({
 70:       ...options,
 71:       filters: {
 72:         ...options?.filters,
 73:         status
 74:       }
 75:     });
 76:   }
 77: 
 78:   /**
 79:    * æŸ¥è¯¢å¾…å¤„ç†ä»»åŠ¡
 80:    *
 81:    * @param options æŸ¥è¯¢é€‰é¡¹
 82:    * @returns Observable<BotTask[]>
 83:    */
 84:   findPendingTasks(options?: QueryOptions): Observable<BotTask[]> {
 85:     // å¾…å¤„ç†ä»»åŠ¡ï¼šstatus = 'pending' æˆ– null
 86:     let query: any = this.supabase
 87:       .from(this.tableName as any)
 88:       .select('*')
 89:       .or('status.is.null,status.eq.pending')
 90:       .order('priority', { ascending: false, nullsFirst: false })
 91:       .order('created_at', { ascending: true });
 92: 
 93:     // åº”ç”¨åˆ†é¡µ
 94:     if (options?.page && options?.pageSize) {
 95:       const fromIndex = (options.page - 1) * options.pageSize;
 96:       const toIndex = fromIndex + options.pageSize - 1;
 97:       query = query.range(fromIndex, toIndex);
 98:     }
 99: 
100:     return from(Promise.resolve(query) as Promise<{ data: any[] | null; error: any }>).pipe(
101:       map((response: { data: any[] | null; error: any }) => {
102:         if (response.error) {
103:           throw new Error(response.error.message || 'æŸ¥è¯¢å¾…å¤„ç†ä»»åŠ¡å¤±è´¥');
104:         }
105:         return (response.data || []).map(item => toCamelCaseData<BotTask>(item));
106:       })
107:     );
108:   }
109: 
110:   /**
111:    * æ ¹æ®ä»»åŠ¡ç±»å‹æŸ¥è¯¢æœºå™¨äººä»»åŠ¡
112:    *
113:    * @param taskType ä»»åŠ¡ç±»å‹
114:    * @param options æŸ¥è¯¢é€‰é¡¹
115:    * @returns Observable<BotTask[]>
116:    */
117:   findByTaskType(taskType: string, options?: QueryOptions): Observable<BotTask[]> {
118:     return this.findAll({
119:       ...options,
120:       filters: {
121:         ...options?.filters,
122:         taskType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º task_type
123:       }
124:     });
125:   }
126: 
127:   /**
128:    * æŸ¥è¯¢è®¡åˆ’æ‰§è¡Œçš„ä»»åŠ¡
129:    *
130:    * @param scheduledAt è®¡åˆ’æ‰§è¡Œæ—¶é—´
131:    * @returns Observable<BotTask[]>
132:    */
133:   findScheduledTasks(scheduledAt: Date): Observable<BotTask[]> {
134:     // è®¡åˆ’æ‰§è¡Œçš„ä»»åŠ¡ï¼šscheduled_at <= scheduledAt ä¸” status = 'pending'
135:     const scheduledAtStr = scheduledAt.toISOString();
136:     let query: any = this.supabase
137:       .from(this.tableName as any)
138:       .select('*')
139:       .lte('scheduled_at', scheduledAtStr)
140:       .or('status.is.null,status.eq.pending')
141:       .order('scheduled_at', { ascending: true });
142: 
143:     return from(Promise.resolve(query) as Promise<{ data: any[] | null; error: any }>).pipe(
144:       map((response: { data: any[] | null; error: any }) => {
145:         if (response.error) {
146:           throw new Error(response.error.message || 'æŸ¥è¯¢è®¡åˆ’æ‰§è¡Œä»»åŠ¡å¤±è´¥');
147:         }
148:         return (response.data || []).map(item => toCamelCaseData<BotTask>(item));
149:       })
150:     );
151:   }
152: }
````

## File: src/app/core/infra/repositories/bot.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: 
  4: import { BaseRepository, QueryOptions } from './base.repository';
  5: import { Database } from '../types/database.types';
  6: 
  7: /**
  8:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
  9:  */
 10: type BotRow = Database['public']['Tables']['bots']['Row'];
 11: type BotInsert = Database['public']['Tables']['bots']['Insert'];
 12: type BotUpdate = Database['public']['Tables']['bots']['Update'];
 13: 
 14: /**
 15:  * Bot å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 16:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 17:  */
 18: export type Bot = BotRow;
 19: export type { BotInsert, BotUpdate };
 20: 
 21: /**
 22:  * Bot Repository
 23:  *
 24:  * æä¾›æœºå™¨äººç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 25:  *
 26:  * @example
 27:  * ```typescript
 28:  * const botRepo = inject(BotRepository);
 29:  * botRepo.findByAccountId('account-id').subscribe(bots => {
 30:  *   console.log('Bots:', bots);
 31:  * });
 32:  * ```
 33:  */
 34: @Injectable({
 35:   providedIn: 'root'
 36: })
 37: export class BotRepository extends BaseRepository<Bot, BotInsert, BotUpdate> {
 38:   protected tableName = 'bots';
 39: 
 40:   /**
 41:    * æ ¹æ®è´¦æˆ· ID æŸ¥è¯¢æœºå™¨äºº
 42:    *
 43:    * @param accountId è´¦æˆ· ID
 44:    * @param options æŸ¥è¯¢é€‰é¡¹
 45:    * @returns Observable<Bot[]>
 46:    */
 47:   findByAccountId(accountId: string, options?: QueryOptions): Observable<Bot[]> {
 48:     return this.findAll({
 49:       ...options,
 50:       filters: {
 51:         ...options?.filters,
 52:         accountId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º account_id
 53:       }
 54:     });
 55:   }
 56: 
 57:   /**
 58:    * æ ¹æ®æœºå™¨äººç±»å‹æŸ¥è¯¢æœºå™¨äºº
 59:    *
 60:    * @param botType æœºå™¨äººç±»å‹
 61:    * @param options æŸ¥è¯¢é€‰é¡¹
 62:    * @returns Observable<Bot[]>
 63:    */
 64:   findByBotType(botType: string, options?: QueryOptions): Observable<Bot[]> {
 65:     return this.findAll({
 66:       ...options,
 67:       filters: {
 68:         ...options?.filters,
 69:         botType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º bot_type
 70:       }
 71:     });
 72:   }
 73: 
 74:   /**
 75:    * æŸ¥è¯¢å¯ç”¨çš„æœºå™¨äºº
 76:    *
 77:    * @param options æŸ¥è¯¢é€‰é¡¹
 78:    * @returns Observable<Bot[]>
 79:    */
 80:   findEnabledBots(options?: QueryOptions): Observable<Bot[]> {
 81:     return this.findAll({
 82:       ...options,
 83:       filters: {
 84:         ...options?.filters,
 85:         isEnabled: true // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º is_enabled
 86:       }
 87:     });
 88:   }
 89: 
 90:   /**
 91:    * æ ¹æ®åˆ›å»ºäºº ID æŸ¥è¯¢æœºå™¨äºº
 92:    *
 93:    * @param createdBy åˆ›å»ºäºº ID
 94:    * @param options æŸ¥è¯¢é€‰é¡¹
 95:    * @returns Observable<Bot[]>
 96:    */
 97:   findByCreatedBy(createdBy: string, options?: QueryOptions): Observable<Bot[]> {
 98:     return this.findAll({
 99:       ...options,
100:       filters: {
101:         ...options?.filters,
102:         createdBy // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º created_by
103:       }
104:     });
105:   }
106: }
````

## File: src/app/core/infra/repositories/branch-permission.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: 
  8: /**
  9:  * BranchPermission å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 10:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–ï¼Œåç»­ä¼šé€šè¿‡è½¬æ¢å·¥å…·è½¬æ¢ä¸º camelCase
 11:  */
 12: type BranchPermissionRow = Database['public']['Tables']['branch_permissions']['Row'];
 13: type BranchPermissionInsert = Database['public']['Tables']['branch_permissions']['Insert'];
 14: type BranchPermissionUpdate = Database['public']['Tables']['branch_permissions']['Update'];
 15: 
 16: /**
 17:  * BranchPermission å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 18:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 19:  */
 20: export type BranchPermission = BranchPermissionRow;
 21: export type { BranchPermissionInsert, BranchPermissionUpdate };
 22: 
 23: /**
 24:  * åˆ†æ”¯æ¬Šé™ç´šåˆ¥æšèˆ‰
 25:  */
 26: export enum BranchPermissionLevel {
 27:   /** æ“æœ‰è€…ï¼šå…¨æ¬Šæ§åˆ¶ */
 28:   OWNER = 'owner',
 29:   /** ç®¡ç†å“¡ï¼šç®¡ç†æ¬Šé™ */
 30:   ADMIN = 'admin',
 31:   /** å¯«å…¥ï¼šå¯ä»¥ä¿®æ”¹æ‰¿æ”¬æ¬„ä½ */
 32:   WRITE = 'write',
 33:   /** è®€å–ï¼šå”¯è®€ */
 34:   READ = 'read'
 35: }
 36: 
 37: /**
 38:  * BranchPermission Repository
 39:  *
 40:  * æä¾›åˆ†æ”¯æ¬Šé™ç›¸é—œçš„æ•¸æ“šè¨ªå•æ–¹æ³•
 41:  *
 42:  * @example
 43:  * ```typescript
 44:  * const branchPermRepo = inject(BranchPermissionRepository);
 45:  * branchPermRepo.findByBranchId('branch-id').subscribe(permissions => {
 46:  *   console.log('Branch permissions:', permissions);
 47:  * });
 48:  * ```
 49:  */
 50: @Injectable({
 51:   providedIn: 'root'
 52: })
 53: export class BranchPermissionRepository extends BaseRepository<BranchPermission, BranchPermissionInsert, BranchPermissionUpdate> {
 54:   protected tableName = 'branch_permissions';
 55: 
 56:   /**
 57:    * æ ¹æ®åˆ†æ”¯ ID æŸ¥è¯¢æƒé™
 58:    *
 59:    * @param branchId åˆ†æ”¯ ID
 60:    * @param options æŸ¥è¯¢é€‰é¡¹
 61:    * @returns Observable<BranchPermission[]>
 62:    */
 63:   findByBranchId(branchId: string, options?: QueryOptions): Observable<BranchPermission[]> {
 64:     return this.findAll({
 65:       ...options,
 66:       filters: {
 67:         ...options?.filters,
 68:         branchId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º branch_id
 69:       }
 70:     });
 71:   }
 72: 
 73:   /**
 74:    * æ ¹æ®è´¦æˆ· ID æŸ¥è¯¢æƒé™
 75:    *
 76:    * @param accountId è´¦æˆ· ID
 77:    * @param options æŸ¥è¯¢é€‰é¡¹
 78:    * @returns Observable<BranchPermission[]>
 79:    */
 80:   findByAccountId(accountId: string, options?: QueryOptions): Observable<BranchPermission[]> {
 81:     return this.findAll({
 82:       ...options,
 83:       filters: {
 84:         ...options?.filters,
 85:         accountId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º account_id
 86:       }
 87:     });
 88:   }
 89: 
 90:   /**
 91:    * æ ¹æ®åˆ†æ”¯ ID å’Œè´¦æˆ· ID æŸ¥è¯¢æƒé™ï¼ˆå”¯ä¸€æŸ¥è¯¢ï¼‰
 92:    *
 93:    * @param branchId åˆ†æ”¯ ID
 94:    * @param accountId è´¦æˆ· ID
 95:    * @returns Observable<BranchPermission | null>
 96:    */
 97:   findByBranchAndAccount(branchId: string, accountId: string): Observable<BranchPermission | null> {
 98:     return this.findAll({
 99:       filters: {
100:         branchId,
101:         accountId
102:       }
103:     }).pipe(map(permissions => (permissions.length > 0 ? permissions[0] : null)));
104:   }
105: 
106:   /**
107:    * æ ¹æ®æƒé™çº§åˆ«æŸ¥è¯¢æƒé™
108:    *
109:    * @param permissionLevel æƒé™çº§åˆ«
110:    * @param options æŸ¥è¯¢é€‰é¡¹
111:    * @returns Observable<BranchPermission[]>
112:    */
113:   findByPermissionLevel(permissionLevel: BranchPermissionLevel, options?: QueryOptions): Observable<BranchPermission[]> {
114:     return this.findAll({
115:       ...options,
116:       filters: {
117:         ...options?.filters,
118:         permissionLevel // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º permission_level
119:       }
120:     });
121:   }
122: 
123:   /**
124:    * æˆäºˆåˆ†æ”¯æƒé™
125:    *
126:    * @param branchId åˆ†æ”¯ ID
127:    * @param accountId è´¦æˆ· ID
128:    * @param permissionLevel æƒé™çº§åˆ«
129:    * @param grantedBy æˆäºˆè€… ID
130:    * @returns Observable<BranchPermission>
131:    */
132:   grantPermission(
133:     branchId: string,
134:     accountId: string,
135:     permissionLevel: BranchPermissionLevel,
136:     grantedBy: string
137:   ): Observable<BranchPermission> {
138:     const insertData = {
139:       branchId,
140:       accountId,
141:       permissionLevel,
142:       grantedBy,
143:       grantedAt: new Date().toISOString()
144:     } as any as BranchPermissionInsert;
145: 
146:     return this.create(insertData);
147:   }
148: 
149:   /**
150:    * æ›´æ–°æƒé™çº§åˆ«
151:    *
152:    * @param id æƒé™ ID
153:    * @param permissionLevel æ–°çš„æƒé™çº§åˆ«
154:    * @param grantedBy æ›´æ–°è€… ID
155:    * @returns Observable<BranchPermission>
156:    */
157:   updatePermissionLevel(id: string, permissionLevel: BranchPermissionLevel, grantedBy: string): Observable<BranchPermission> {
158:     const updateData = {
159:       permissionLevel,
160:       grantedBy,
161:       grantedAt: new Date().toISOString()
162:     } as any as BranchPermissionUpdate;
163: 
164:     return this.update(id, updateData);
165:   }
166: 
167:   /**
168:    * æ’¤é”€æƒé™
169:    *
170:    * @param branchId åˆ†æ”¯ ID
171:    * @param accountId è´¦æˆ· ID
172:    * @returns Observable<void>
173:    */
174:   revokePermission(branchId: string, accountId: string): Observable<void> {
175:     return this.findAll({
176:       filters: {
177:         branchId,
178:         accountId
179:       }
180:     }).pipe(
181:       map(permissions => {
182:         if (permissions.length > 0) {
183:           return this.delete(permissions[0].id);
184:         }
185:         throw new Error('æƒé™ä¸å­˜åœ¨');
186:       }),
187:       map(() => undefined)
188:     );
189:   }
190: }
````

## File: src/app/core/infra/repositories/comment.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: 
  4: import { BaseRepository, QueryOptions } from './base.repository';
  5: import { Database } from '../types/database.types';
  6: 
  7: /**
  8:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
  9:  */
 10: type CommentRow = Database['public']['Tables']['comments']['Row'];
 11: type CommentInsert = Database['public']['Tables']['comments']['Insert'];
 12: type CommentUpdate = Database['public']['Tables']['comments']['Update'];
 13: 
 14: /**
 15:  * Comment å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 16:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 17:  */
 18: export type Comment = CommentRow;
 19: export type { CommentInsert, CommentUpdate };
 20: 
 21: /**
 22:  * Comment Repository
 23:  *
 24:  * æä¾›ç•™è¨€/è¯„è®ºç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 25:  *
 26:  * @example
 27:  * ```typescript
 28:  * const commentRepo = inject(CommentRepository);
 29:  * commentRepo.findByCommentableId('Task', 'task-id').subscribe(comments => {
 30:  *   console.log('Comments:', comments);
 31:  * });
 32:  * ```
 33:  */
 34: @Injectable({
 35:   providedIn: 'root'
 36: })
 37: export class CommentRepository extends BaseRepository<Comment, CommentInsert, CommentUpdate> {
 38:   protected tableName = 'comments';
 39: 
 40:   /**
 41:    * æ ¹æ®å¯è¯„è®ºç±»å‹æŸ¥è¯¢è¯„è®º
 42:    *
 43:    * @param commentableType å¯è¯„è®ºç±»å‹ï¼ˆå¦‚ 'Task', 'Issue'ï¼‰
 44:    * @param options æŸ¥è¯¢é€‰é¡¹
 45:    * @returns Observable<Comment[]>
 46:    */
 47:   findByCommentableType(commentableType: string, options?: QueryOptions): Observable<Comment[]> {
 48:     return this.findAll({
 49:       ...options,
 50:       filters: {
 51:         ...options?.filters,
 52:         commentableType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º commentable_type
 53:       }
 54:     });
 55:   }
 56: 
 57:   /**
 58:    * æ ¹æ®å¯è¯„è®ºå¯¹è±¡æŸ¥è¯¢è¯„è®º
 59:    *
 60:    * @param commentableType å¯è¯„è®ºç±»å‹
 61:    * @param commentableId å¯è¯„è®ºå¯¹è±¡ ID
 62:    * @param options æŸ¥è¯¢é€‰é¡¹
 63:    * @returns Observable<Comment[]>
 64:    */
 65:   findByCommentableId(commentableType: string, commentableId: string, options?: QueryOptions): Observable<Comment[]> {
 66:     return this.findAll({
 67:       ...options,
 68:       filters: {
 69:         ...options?.filters,
 70:         commentableType,
 71:         commentableId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º commentable_id
 72:       },
 73:       orderBy: 'createdAt',
 74:       orderDirection: 'asc'
 75:     });
 76:   }
 77: 
 78:   /**
 79:    * æ ¹æ®çˆ¶è¯„è®º ID æŸ¥è¯¢è¯„è®ºï¼ˆåµŒå¥—å›å¤ï¼‰
 80:    *
 81:    * @param parentCommentId çˆ¶è¯„è®º ID
 82:    * @param options æŸ¥è¯¢é€‰é¡¹
 83:    * @returns Observable<Comment[]>
 84:    */
 85:   findByParentCommentId(parentCommentId: string, options?: QueryOptions): Observable<Comment[]> {
 86:     return this.findAll({
 87:       ...options,
 88:       filters: {
 89:         ...options?.filters,
 90:         parentCommentId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º parent_comment_id
 91:       },
 92:       orderBy: 'createdAt',
 93:       orderDirection: 'asc'
 94:     });
 95:   }
 96: 
 97:   /**
 98:    * æ ¹æ®ä½œè€… ID æŸ¥è¯¢è¯„è®º
 99:    *
100:    * @param authorId ä½œè€… ID
101:    * @param options æŸ¥è¯¢é€‰é¡¹
102:    * @returns Observable<Comment[]>
103:    */
104:   findByAuthorId(authorId: string, options?: QueryOptions): Observable<Comment[]> {
105:     return this.findAll({
106:       ...options,
107:       filters: {
108:         ...options?.filters,
109:         authorId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º author_id
110:       },
111:       orderBy: 'createdAt',
112:       orderDirection: 'desc'
113:     });
114:   }
115: 
116:   /**
117:    * æŸ¥è¯¢æ ¹è¯„è®ºï¼ˆæ— çˆ¶è¯„è®ºï¼‰
118:    *
119:    * @param commentableType å¯è¯„è®ºç±»å‹
120:    * @param commentableId å¯è¯„è®ºå¯¹è±¡ ID
121:    * @returns Observable<Comment[]>
122:    */
123:   findRootComments(commentableType: string, commentableId: string): Observable<Comment[]> {
124:     return this.findAll({
125:       filters: {
126:         commentableType,
127:         commentableId,
128:         parentCommentId: null // æ ¹è¯„è®ºæ²¡æœ‰çˆ¶è¯„è®º
129:       },
130:       orderBy: 'createdAt',
131:       orderDirection: 'asc'
132:     });
133:   }
134: }
````

## File: src/app/core/infra/repositories/document-thumbnail.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: import { map } from 'rxjs/operators';
 4: 
 5: import { BaseRepository, QueryOptions } from './base.repository';
 6: import { Database } from '../types/database.types';
 7: 
 8: /**
 9:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
10:  */
11: type DocumentThumbnailRow = Database['public']['Tables']['document_thumbnails']['Row'];
12: type DocumentThumbnailInsert = Database['public']['Tables']['document_thumbnails']['Insert'];
13: type DocumentThumbnailUpdate = Database['public']['Tables']['document_thumbnails']['Update'];
14: 
15: /**
16:  * DocumentThumbnail å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
17:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
18:  */
19: export type DocumentThumbnail = DocumentThumbnailRow;
20: export type { DocumentThumbnailInsert, DocumentThumbnailUpdate };
21: 
22: /**
23:  * DocumentThumbnail Repository
24:  *
25:  * æä¾›æ–‡æ¡£ç¼©å›¾ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
26:  *
27:  * @example
28:  * ```typescript
29:  * const thumbnailRepo = inject(DocumentThumbnailRepository);
30:  * thumbnailRepo.findByDocumentId('document-id').subscribe(thumbnails => {
31:  *   console.log('Thumbnails:', thumbnails);
32:  * });
33:  * ```
34:  */
35: @Injectable({
36:   providedIn: 'root'
37: })
38: export class DocumentThumbnailRepository extends BaseRepository<DocumentThumbnail, DocumentThumbnailInsert, DocumentThumbnailUpdate> {
39:   protected tableName = 'document_thumbnails';
40: 
41:   /**
42:    * æ ¹æ®æ–‡æ¡£ ID æŸ¥è¯¢æ–‡æ¡£ç¼©å›¾
43:    *
44:    * @param documentId æ–‡æ¡£ ID
45:    * @param options æŸ¥è¯¢é€‰é¡¹
46:    * @returns Observable<DocumentThumbnail[]>
47:    */
48:   findByDocumentId(documentId: string, options?: QueryOptions): Observable<DocumentThumbnail[]> {
49:     return this.findAll({
50:       ...options,
51:       filters: {
52:         ...options?.filters,
53:         documentId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º document_id
54:       }
55:     });
56:   }
57: 
58:   /**
59:    * æ ¹æ®å°ºå¯¸æŸ¥è¯¢æ–‡æ¡£ç¼©å›¾
60:    *
61:    * @param documentId æ–‡æ¡£ ID
62:    * @param thumbnailSize ç¼©å›¾å°ºå¯¸
63:    * @returns Observable<DocumentThumbnail | null>
64:    */
65:   findBySize(documentId: string, thumbnailSize: string): Observable<DocumentThumbnail | null> {
66:     return this.findAll({
67:       filters: {
68:         documentId,
69:         thumbnailSize // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º thumbnail_size
70:       }
71:     }).pipe(map(thumbnails => (thumbnails.length > 0 ? thumbnails[0] : null)));
72:   }
73: 
74:   /**
75:    * æŸ¥è¯¢æŒ‡å®šæ–‡æ¡£å’Œå°ºå¯¸çš„ç¼©å›¾
76:    *
77:    * @param documentId æ–‡æ¡£ ID
78:    * @param thumbnailSize ç¼©å›¾å°ºå¯¸
79:    * @returns Observable<DocumentThumbnail | null>
80:    */
81:   findByDocumentAndSize(documentId: string, thumbnailSize: string): Observable<DocumentThumbnail | null> {
82:     return this.findBySize(documentId, thumbnailSize);
83:   }
84: }
````

## File: src/app/core/infra/repositories/document-version.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: 
  8: /**
  9:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 10:  */
 11: type DocumentVersionRow = Database['public']['Tables']['document_versions']['Row'];
 12: type DocumentVersionInsert = Database['public']['Tables']['document_versions']['Insert'];
 13: type DocumentVersionUpdate = Database['public']['Tables']['document_versions']['Update'];
 14: 
 15: /**
 16:  * DocumentVersion å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 17:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 18:  */
 19: export type DocumentVersion = DocumentVersionRow;
 20: export type { DocumentVersionInsert, DocumentVersionUpdate };
 21: 
 22: /**
 23:  * DocumentVersion Repository
 24:  *
 25:  * æä¾›æ–‡æ¡£ç‰ˆæœ¬ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 26:  *
 27:  * @example
 28:  * ```typescript
 29:  * const versionRepo = inject(DocumentVersionRepository);
 30:  * versionRepo.findByDocumentId('document-id').subscribe(versions => {
 31:  *   console.log('Document versions:', versions);
 32:  * });
 33:  * ```
 34:  */
 35: @Injectable({
 36:   providedIn: 'root'
 37: })
 38: export class DocumentVersionRepository extends BaseRepository<DocumentVersion, DocumentVersionInsert, DocumentVersionUpdate> {
 39:   protected tableName = 'document_versions';
 40: 
 41:   /**
 42:    * æ ¹æ®æ–‡æ¡£ ID æŸ¥è¯¢æ–‡æ¡£ç‰ˆæœ¬
 43:    *
 44:    * @param documentId æ–‡æ¡£ ID
 45:    * @param options æŸ¥è¯¢é€‰é¡¹
 46:    * @returns Observable<DocumentVersion[]>
 47:    */
 48:   findByDocumentId(documentId: string, options?: QueryOptions): Observable<DocumentVersion[]> {
 49:     return this.findAll({
 50:       ...options,
 51:       filters: {
 52:         ...options?.filters,
 53:         documentId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º document_id
 54:       },
 55:       orderBy: 'versionNumber', // æŒ‰ç‰ˆæœ¬å·æ’åº
 56:       orderDirection: 'desc'
 57:     });
 58:   }
 59: 
 60:   /**
 61:    * æŸ¥è¯¢æœ€æ–°ç‰ˆæœ¬
 62:    *
 63:    * @param documentId æ–‡æ¡£ ID
 64:    * @returns Observable<DocumentVersion | null>
 65:    */
 66:   findLatestVersion(documentId: string): Observable<DocumentVersion | null> {
 67:     return this.findAll({
 68:       filters: {
 69:         documentId
 70:       },
 71:       orderBy: 'versionNumber',
 72:       orderDirection: 'desc'
 73:     }).pipe(map(versions => (versions.length > 0 ? versions[0] : null)));
 74:   }
 75: 
 76:   /**
 77:    * æ ¹æ®ç‰ˆæœ¬å·æŸ¥è¯¢æ–‡æ¡£ç‰ˆæœ¬
 78:    *
 79:    * @param documentId æ–‡æ¡£ ID
 80:    * @param versionNumber ç‰ˆæœ¬å·
 81:    * @returns Observable<DocumentVersion | null>
 82:    */
 83:   findByVersionNumber(documentId: string, versionNumber: number): Observable<DocumentVersion | null> {
 84:     return this.findAll({
 85:       filters: {
 86:         documentId,
 87:         versionNumber // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º version_number
 88:       }
 89:     }).pipe(map(versions => (versions.length > 0 ? versions[0] : null)));
 90:   }
 91: 
 92:   /**
 93:    * æ ¹æ®åˆ›å»ºäºº ID æŸ¥è¯¢æ–‡æ¡£ç‰ˆæœ¬
 94:    *
 95:    * @param createdBy åˆ›å»ºäºº ID
 96:    * @param options æŸ¥è¯¢é€‰é¡¹
 97:    * @returns Observable<DocumentVersion[]>
 98:    */
 99:   findByCreatedBy(createdBy: string, options?: QueryOptions): Observable<DocumentVersion[]> {
100:     return this.findAll({
101:       ...options,
102:       filters: {
103:         ...options?.filters,
104:         createdBy // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º created_by
105:       },
106:       orderBy: 'createdAt',
107:       orderDirection: 'desc'
108:     });
109:   }
110: }
````

## File: src/app/core/infra/repositories/document.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable, from } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: import { toCamelCaseData } from '../utils/transformers';
  8: 
  9: /**
 10:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 11:  */
 12: type DocumentRow = Database['public']['Tables']['documents']['Row'];
 13: type DocumentInsert = Database['public']['Tables']['documents']['Insert'];
 14: type DocumentUpdate = Database['public']['Tables']['documents']['Update'];
 15: 
 16: /**
 17:  * Document å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 18:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 19:  */
 20: export type Document = DocumentRow;
 21: export type { DocumentInsert, DocumentUpdate };
 22: 
 23: /**
 24:  * Document Repository
 25:  *
 26:  * æä¾›æ–‡æ¡£ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 27:  *
 28:  * @example
 29:  * ```typescript
 30:  * const documentRepo = inject(DocumentRepository);
 31:  * documentRepo.findByUploaderId('account-id').subscribe(documents => {
 32:  *   console.log('Documents:', documents);
 33:  * });
 34:  * ```
 35:  */
 36: @Injectable({
 37:   providedIn: 'root'
 38: })
 39: export class DocumentRepository extends BaseRepository<Document, DocumentInsert, DocumentUpdate> {
 40:   protected tableName = 'documents';
 41: 
 42:   /**
 43:    * æ ¹æ®ä¸Šä¼ äºº ID æŸ¥è¯¢æ–‡æ¡£
 44:    *
 45:    * @param uploaderId ä¸Šä¼ äºº ID
 46:    * @param options æŸ¥è¯¢é€‰é¡¹
 47:    * @returns Observable<Document[]>
 48:    */
 49:   findByUploaderId(uploaderId: string, options?: QueryOptions): Observable<Document[]> {
 50:     return this.findAll({
 51:       ...options,
 52:       filters: {
 53:         ...options?.filters,
 54:         uploaderId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º uploader_id
 55:       },
 56:       orderBy: 'uploadedAt',
 57:       orderDirection: 'desc'
 58:     });
 59:   }
 60: 
 61:   /**
 62:    * æ ¹æ®å­˜å‚¨æ¡¶æŸ¥è¯¢æ–‡æ¡£
 63:    *
 64:    * @param storageBucket å­˜å‚¨æ¡¶
 65:    * @param options æŸ¥è¯¢é€‰é¡¹
 66:    * @returns Observable<Document[]>
 67:    */
 68:   findByStorageBucket(storageBucket: string, options?: QueryOptions): Observable<Document[]> {
 69:     return this.findAll({
 70:       ...options,
 71:       filters: {
 72:         ...options?.filters,
 73:         storageBucket // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º storage_bucket
 74:       }
 75:     });
 76:   }
 77: 
 78:   /**
 79:    * æ ¹æ®æ–‡ä»¶ç±»å‹æŸ¥è¯¢æ–‡æ¡£
 80:    *
 81:    * @param fileType æ–‡ä»¶ç±»å‹
 82:    * @param options æŸ¥è¯¢é€‰é¡¹
 83:    * @returns Observable<Document[]>
 84:    */
 85:   findByFileType(fileType: string, options?: QueryOptions): Observable<Document[]> {
 86:     return this.findAll({
 87:       ...options,
 88:       filters: {
 89:         ...options?.filters,
 90:         fileType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º file_type
 91:       }
 92:     });
 93:   }
 94: 
 95:   /**
 96:    * æŸ¥è¯¢æœªåˆ é™¤çš„æ–‡ä»¶
 97:    *
 98:    * @param options æŸ¥è¯¢é€‰é¡¹
 99:    * @returns Observable<Document[]>
100:    */
101:   findNotDeleted(options?: QueryOptions): Observable<Document[]> {
102:     // æœªåˆ é™¤çš„æ–‡ä»¶ï¼šsoft_deleted_at IS NULL
103:     // éœ€è¦ä½¿ç”¨ Supabase client ç›´æ¥æŸ¥è¯¢
104:     let query: any = this.supabase
105:       .from(this.tableName as any)
106:       .select('*')
107:       .is('soft_deleted_at', null);
108: 
109:     // åº”ç”¨æ’åº
110:     if (options?.orderBy) {
111:       const snakeOrderBy = options.orderBy.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);
112:       query = query.order(snakeOrderBy, { ascending: options.orderDirection !== 'desc' });
113:     } else {
114:       query = query.order('uploaded_at', { ascending: false });
115:     }
116: 
117:     // åº”ç”¨åˆ†é¡µ
118:     if (options?.page && options?.pageSize) {
119:       const fromIndex = (options.page - 1) * options.pageSize;
120:       const toIndex = fromIndex + options.pageSize - 1;
121:       query = query.range(fromIndex, toIndex);
122:     }
123: 
124:     return from(Promise.resolve(query) as Promise<{ data: any[] | null; error: any }>).pipe(
125:       map((response: { data: any[] | null; error: any }) => {
126:         if (response.error) {
127:           throw new Error(response.error.message || 'æŸ¥è¯¢æœªåˆ é™¤æ–‡ä»¶å¤±è´¥');
128:         }
129:         return (response.data || []).map(item => toCamelCaseData<Document>(item));
130:       })
131:     );
132:   }
133: 
134:   /**
135:    * æŸ¥è¯¢å…¬å¼€æ–‡ä»¶
136:    *
137:    * @param options æŸ¥è¯¢é€‰é¡¹
138:    * @returns Observable<Document[]>
139:    */
140:   findPublicDocuments(options?: QueryOptions): Observable<Document[]> {
141:     return this.findAll({
142:       ...options,
143:       filters: {
144:         ...options?.filters,
145:         isPublic: true // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º is_public
146:       }
147:     });
148:   }
149: 
150:   /**
151:    * æ ¹æ®ä¸Šä¼ æ¥æºæŸ¥è¯¢æ–‡æ¡£
152:    *
153:    * @param uploadSource ä¸Šä¼ æ¥æº
154:    * @param options æŸ¥è¯¢é€‰é¡¹
155:    * @returns Observable<Document[]>
156:    */
157:   findByUploadSource(uploadSource: string, options?: QueryOptions): Observable<Document[]> {
158:     return this.findAll({
159:       ...options,
160:       filters: {
161:         ...options?.filters,
162:         uploadSource // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º upload_source
163:       }
164:     });
165:   }
166: 
167:   /**
168:    * æŸ¥è¯¢è½¯åˆ é™¤çš„æ–‡ä»¶
169:    *
170:    * @returns Observable<Document[]>
171:    */
172:   findSoftDeleted(): Observable<Document[]> {
173:     // è½¯åˆ é™¤çš„æ–‡ä»¶ï¼šsoft_deleted_at IS NOT NULL
174:     let query: any = this.supabase
175:       .from(this.tableName as any)
176:       .select('*')
177:       .not('soft_deleted_at', 'is', null)
178:       .order('soft_deleted_at', { ascending: false });
179: 
180:     return from(Promise.resolve(query) as Promise<{ data: any[] | null; error: any }>).pipe(
181:       map((response: { data: any[] | null; error: any }) => {
182:         if (response.error) {
183:           throw new Error(response.error.message || 'æŸ¥è¯¢è½¯åˆ é™¤æ–‡ä»¶å¤±è´¥');
184:         }
185:         return (response.data || []).map(item => toCamelCaseData<Document>(item));
186:       })
187:     );
188:   }
189: }
````

## File: src/app/core/infra/repositories/feature-flag.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable, from } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: import { toCamelCaseData } from '../utils/transformers';
  8: 
  9: /**
 10:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 11:  */
 12: type FeatureFlagRow = Database['public']['Tables']['feature_flags']['Row'];
 13: type FeatureFlagInsert = Database['public']['Tables']['feature_flags']['Insert'];
 14: type FeatureFlagUpdate = Database['public']['Tables']['feature_flags']['Update'];
 15: 
 16: /**
 17:  * FeatureFlag å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 18:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 19:  */
 20: export type FeatureFlag = FeatureFlagRow;
 21: export type { FeatureFlagInsert, FeatureFlagUpdate };
 22: 
 23: /**
 24:  * FeatureFlag Repository
 25:  *
 26:  * æä¾›åŠŸèƒ½å¼€å…³ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 27:  *
 28:  * @example
 29:  * ```typescript
 30:  * const flagRepo = inject(FeatureFlagRepository);
 31:  * flagRepo.findByKey('new-feature').subscribe(flag => {
 32:  *   console.log('Feature flag:', flag);
 33:  * });
 34:  * ```
 35:  */
 36: @Injectable({
 37:   providedIn: 'root'
 38: })
 39: export class FeatureFlagRepository extends BaseRepository<FeatureFlag, FeatureFlagInsert, FeatureFlagUpdate> {
 40:   protected tableName = 'feature_flags';
 41: 
 42:   /**
 43:    * æ ¹æ®é”®æŸ¥è¯¢åŠŸèƒ½å¼€å…³
 44:    *
 45:    * @param flagKey åŠŸèƒ½å¼€å…³é”®
 46:    * @returns Observable<FeatureFlag | null>
 47:    */
 48:   findByKey(flagKey: string): Observable<FeatureFlag | null> {
 49:     return this.findAll({
 50:       filters: {
 51:         flagKey // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º flag_key
 52:       }
 53:     }).pipe(map(flags => (flags.length > 0 ? flags[0] : null)));
 54:   }
 55: 
 56:   /**
 57:    * æŸ¥è¯¢å¯ç”¨çš„åŠŸèƒ½å¼€å…³
 58:    *
 59:    * @param options æŸ¥è¯¢é€‰é¡¹
 60:    * @returns Observable<FeatureFlag[]>
 61:    */
 62:   findEnabledFlags(options?: QueryOptions): Observable<FeatureFlag[]> {
 63:     return this.findAll({
 64:       ...options,
 65:       filters: {
 66:         ...options?.filters,
 67:         isEnabled: true // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º is_enabled
 68:       }
 69:     });
 70:   }
 71: 
 72:   /**
 73:    * æ ¹æ®ç›®æ ‡è´¦æˆ·æŸ¥è¯¢åŠŸèƒ½å¼€å…³
 74:    *
 75:    * @param accountId è´¦æˆ· ID
 76:    * @returns Observable<FeatureFlag[]>
 77:    */
 78:   findByTargetAccount(accountId: string): Observable<FeatureFlag[]> {
 79:     // éœ€è¦åœ¨ target_accounts JSON å­—æ®µä¸­æŸ¥æ‰¾ accountId
 80:     // è¿™éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ Supabase çš„ JSON æŸ¥è¯¢åŠŸèƒ½
 81:     // æš‚æ—¶ä½¿ç”¨ findAll ç„¶åè¿‡æ»¤ï¼Œæˆ–è€…æ ‡è®°ä¸º TODO
 82:     return this.findAll({
 83:       filters: {
 84:         isEnabled: true
 85:       }
 86:     }).pipe(
 87:       map(flags =>
 88:         flags.filter(flag => {
 89:           // BaseRepository ä¼šè‡ªåŠ¨è½¬æ¢ï¼Œä½†ç±»å‹å®šä¹‰ä»ç„¶æ˜¯ snake_case
 90:           // ä½¿ç”¨ snake_case å±æ€§åè®¿é—®ï¼ˆBaseRepository è½¬æ¢åå¯èƒ½ä»ç„¶æ˜¯ snake_caseï¼‰
 91:           const targetAccounts = (flag as any).target_accounts as string[] | null;
 92:           return targetAccounts && targetAccounts.includes(accountId);
 93:         })
 94:       )
 95:     );
 96:   }
 97: 
 98:   /**
 99:    * æ ¹æ®ç›®æ ‡ç»„ç»‡æŸ¥è¯¢åŠŸèƒ½å¼€å…³
100:    *
101:    * @param organizationId ç»„ç»‡ ID
102:    * @returns Observable<FeatureFlag[]>
103:    */
104:   findByTargetOrganization(organizationId: string): Observable<FeatureFlag[]> {
105:     return this.findAll({
106:       filters: {
107:         isEnabled: true
108:       }
109:     }).pipe(
110:       map(flags =>
111:         flags.filter(flag => {
112:           // BaseRepository ä¼šè‡ªåŠ¨è½¬æ¢ï¼Œä½†ç±»å‹å®šä¹‰ä»ç„¶æ˜¯ snake_case
113:           // ä½¿ç”¨ snake_case å±æ€§åè®¿é—®ï¼ˆBaseRepository è½¬æ¢åå¯èƒ½ä»ç„¶æ˜¯ snake_caseï¼‰
114:           const targetOrganizations = (flag as any).target_organizations as string[] | null;
115:           return targetOrganizations && targetOrganizations.includes(organizationId);
116:         })
117:       )
118:     );
119:   }
120: 
121:   /**
122:    * æŸ¥è¯¢å½“å‰æœ‰æ•ˆçš„åŠŸèƒ½å¼€å…³ï¼ˆåœ¨æœ‰æ•ˆæœŸå†…ï¼‰
123:    *
124:    * @returns Observable<FeatureFlag[]>
125:    */
126:   findActiveFlags(): Observable<FeatureFlag[]> {
127:     // æœ‰æ•ˆçš„åŠŸèƒ½å¼€å…³ï¼šenabled = true AND (starts_at IS NULL OR starts_at <= NOW()) AND (ends_at IS NULL OR ends_at >= NOW())
128:     // éœ€è¦ä½¿ç”¨ Supabase client ç›´æ¥æŸ¥è¯¢
129:     const now = new Date().toISOString();
130:     let query: any = this.supabase
131:       .from(this.tableName as any)
132:       .select('*')
133:       .eq('is_enabled', true)
134:       .or(`start_date.is.null,start_date.lte.${now}`)
135:       .or(`end_date.is.null,end_date.gte.${now}`);
136: 
137:     return from(Promise.resolve(query) as Promise<{ data: any[] | null; error: any }>).pipe(
138:       map((response: { data: any[] | null; error: any }) => {
139:         if (response.error) {
140:           throw new Error(response.error.message || 'æŸ¥è¯¢æœ‰æ•ˆåŠŸèƒ½å¼€å…³å¤±è´¥');
141:         }
142:         return (response.data || []).map(item => toCamelCaseData<FeatureFlag>(item));
143:       })
144:     );
145:   }
146: }
````

## File: src/app/core/infra/repositories/inspection.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: 
 4: import { BaseRepository, QueryOptions } from './base.repository';
 5: import { Database } from '../types/database.types';
 6: 
 7: /**
 8:  * Inspection å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 9:  */
10: type InspectionRow = Database['public']['Tables']['inspections']['Row'];
11: type InspectionInsert = Database['public']['Tables']['inspections']['Insert'];
12: type InspectionUpdate = Database['public']['Tables']['inspections']['Update'];
13: 
14: export type Inspection = InspectionRow;
15: export type { InspectionInsert, InspectionUpdate };
16: 
17: /**
18:  * Inspection Repository
19:  *
20:  * æä¾›éªŒæ”¶è®°å½•ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
21:  */
22: @Injectable({
23:   providedIn: 'root'
24: })
25: export class InspectionRepository extends BaseRepository<Inspection, InspectionInsert, InspectionUpdate> {
26:   protected tableName = 'inspections';
27: 
28:   /**
29:    * æ ¹æ®ä»»åŠ¡ ID æŸ¥è¯¢éªŒæ”¶è®°å½•
30:    *
31:    * @param taskId ä»»åŠ¡ ID
32:    * @param options æŸ¥è¯¢é€‰é¡¹
33:    * @returns Observable<Inspection[]>
34:    */
35:   findByTaskId(taskId: string, options?: QueryOptions): Observable<Inspection[]> {
36:     return this.findAll({
37:       ...options,
38:       filters: {
39:         ...options?.filters,
40:         taskId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º task_id
41:       },
42:       orderBy: 'inspected_at',
43:       orderDirection: 'desc'
44:     });
45:   }
46: 
47:   /**
48:    * æ ¹æ®æ£€æŸ¥å‘˜ ID æŸ¥è¯¢éªŒæ”¶è®°å½•
49:    *
50:    * @param inspectorId æ£€æŸ¥å‘˜ ID
51:    * @param options æŸ¥è¯¢é€‰é¡¹
52:    * @returns Observable<Inspection[]>
53:    */
54:   findByInspectorId(inspectorId: string, options?: QueryOptions): Observable<Inspection[]> {
55:     return this.findAll({
56:       ...options,
57:       filters: {
58:         ...options?.filters,
59:         inspectorId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º inspector_id
60:       },
61:       orderBy: 'inspected_at',
62:       orderDirection: 'desc'
63:     });
64:   }
65: 
66:   /**
67:    * æ ¹æ®çŠ¶æ€æŸ¥è¯¢éªŒæ”¶è®°å½•
68:    *
69:    * @param status çŠ¶æ€
70:    * @param options æŸ¥è¯¢é€‰é¡¹
71:    * @returns Observable<Inspection[]>
72:    */
73:   findByStatus(status: string, options?: QueryOptions): Observable<Inspection[]> {
74:     return this.findAll({
75:       ...options,
76:       filters: {
77:         ...options?.filters,
78:         status
79:       },
80:       orderBy: 'inspected_at',
81:       orderDirection: 'desc'
82:     });
83:   }
84: }
````

## File: src/app/core/infra/repositories/issue-assignment.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: 
  8: /**
  9:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 10:  */
 11: type IssueAssignmentRow = Database['public']['Tables']['issue_assignments']['Row'];
 12: type IssueAssignmentInsert = Database['public']['Tables']['issue_assignments']['Insert'];
 13: type IssueAssignmentUpdate = Database['public']['Tables']['issue_assignments']['Update'];
 14: 
 15: /**
 16:  * IssueAssignment å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 17:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 18:  */
 19: export type IssueAssignment = IssueAssignmentRow;
 20: export type { IssueAssignmentInsert, IssueAssignmentUpdate };
 21: 
 22: /**
 23:  * IssueAssignment Repository
 24:  *
 25:  * æä¾›é—®é¢˜æŒ‡æ´¾ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 26:  *
 27:  * @example
 28:  * ```typescript
 29:  * const issueAssignmentRepo = inject(IssueAssignmentRepository);
 30:  * issueAssignmentRepo.findByIssueId('issue-id').subscribe(assignments => {
 31:  *   console.log('Issue assignments:', assignments);
 32:  * });
 33:  * ```
 34:  */
 35: @Injectable({
 36:   providedIn: 'root'
 37: })
 38: export class IssueAssignmentRepository extends BaseRepository<IssueAssignment, IssueAssignmentInsert, IssueAssignmentUpdate> {
 39:   protected tableName = 'issue_assignments';
 40: 
 41:   /**
 42:    * æ ¹æ®é—®é¢˜ ID æŸ¥è¯¢é—®é¢˜æŒ‡æ´¾
 43:    *
 44:    * @param issueId é—®é¢˜ ID
 45:    * @param options æŸ¥è¯¢é€‰é¡¹
 46:    * @returns Observable<IssueAssignment[]>
 47:    */
 48:   findByIssueId(issueId: string, options?: QueryOptions): Observable<IssueAssignment[]> {
 49:     return this.findAll({
 50:       ...options,
 51:       filters: {
 52:         ...options?.filters,
 53:         issueId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º issue_id
 54:       }
 55:     });
 56:   }
 57: 
 58:   /**
 59:    * æ ¹æ®è¢«æŒ‡æ´¾äºº ID æŸ¥è¯¢é—®é¢˜æŒ‡æ´¾
 60:    *
 61:    * @param assigneeId è¢«æŒ‡æ´¾äºº ID
 62:    * @param options æŸ¥è¯¢é€‰é¡¹
 63:    * @returns Observable<IssueAssignment[]>
 64:    */
 65:   findByAssigneeId(assigneeId: string, options?: QueryOptions): Observable<IssueAssignment[]> {
 66:     return this.findAll({
 67:       ...options,
 68:       filters: {
 69:         ...options?.filters,
 70:         assigneeId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º assignee_id
 71:       }
 72:     });
 73:   }
 74: 
 75:   /**
 76:    * æ ¹æ®æŒ‡æ´¾äºº ID æŸ¥è¯¢é—®é¢˜æŒ‡æ´¾
 77:    *
 78:    * @param assignedBy æŒ‡æ´¾äºº ID
 79:    * @param options æŸ¥è¯¢é€‰é¡¹
 80:    * @returns Observable<IssueAssignment[]>
 81:    */
 82:   findByAssignedBy(assignedBy: string, options?: QueryOptions): Observable<IssueAssignment[]> {
 83:     return this.findAll({
 84:       ...options,
 85:       filters: {
 86:         ...options?.filters,
 87:         assignedBy // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º assigned_by
 88:       }
 89:     });
 90:   }
 91: 
 92:   /**
 93:    * æŸ¥è¯¢é—®é¢˜æŒ‡æ´¾å…³ç³»
 94:    *
 95:    * @param issueId é—®é¢˜ ID
 96:    * @param assigneeId è¢«æŒ‡æ´¾äºº ID
 97:    * @returns Observable<IssueAssignment | null>
 98:    */
 99:   findByIssueAndAssignee(issueId: string, assigneeId: string): Observable<IssueAssignment | null> {
100:     return this.findAll({
101:       filters: {
102:         issueId,
103:         assigneeId
104:       }
105:     }).pipe(map(assignments => (assignments.length > 0 ? assignments[0] : null)));
106:   }
107: }
````

## File: src/app/core/infra/repositories/issue-photo.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: 
 4: import { BaseRepository, QueryOptions } from './base.repository';
 5: import { Database } from '../types/database.types';
 6: 
 7: /**
 8:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 9:  */
10: type IssuePhotoRow = Database['public']['Tables']['issue_photos']['Row'];
11: type IssuePhotoInsert = Database['public']['Tables']['issue_photos']['Insert'];
12: type IssuePhotoUpdate = Database['public']['Tables']['issue_photos']['Update'];
13: 
14: /**
15:  * IssuePhoto å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
16:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
17:  */
18: export type IssuePhoto = IssuePhotoRow;
19: export type { IssuePhotoInsert, IssuePhotoUpdate };
20: 
21: /**
22:  * IssuePhoto Repository
23:  *
24:  * æä¾›é—®é¢˜ç…§ç‰‡ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
25:  *
26:  * @example
27:  * ```typescript
28:  * const issuePhotoRepo = inject(IssuePhotoRepository);
29:  * issuePhotoRepo.findByIssueId('issue-id').subscribe(photos => {
30:  *   console.log('Issue photos:', photos);
31:  * });
32:  * ```
33:  */
34: @Injectable({
35:   providedIn: 'root'
36: })
37: export class IssuePhotoRepository extends BaseRepository<IssuePhoto, IssuePhotoInsert, IssuePhotoUpdate> {
38:   protected tableName = 'issue_photos';
39: 
40:   /**
41:    * æ ¹æ®é—®é¢˜ ID æŸ¥è¯¢é—®é¢˜ç…§ç‰‡
42:    *
43:    * @param issueId é—®é¢˜ ID
44:    * @param options æŸ¥è¯¢é€‰é¡¹
45:    * @returns Observable<IssuePhoto[]>
46:    */
47:   findByIssueId(issueId: string, options?: QueryOptions): Observable<IssuePhoto[]> {
48:     return this.findAll({
49:       ...options,
50:       filters: {
51:         ...options?.filters,
52:         issueId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º issue_id
53:       },
54:       orderBy: 'sequenceOrder', // æŒ‰é¡ºåºæ’åº
55:       orderDirection: 'asc'
56:     });
57:   }
58: 
59:   /**
60:    * æ ¹æ®æ–‡æ¡£ ID æŸ¥è¯¢é—®é¢˜ç…§ç‰‡
61:    *
62:    * @param documentId æ–‡æ¡£ ID
63:    * @param options æŸ¥è¯¢é€‰é¡¹
64:    * @returns Observable<IssuePhoto[]>
65:    */
66:   findByDocumentId(documentId: string, options?: QueryOptions): Observable<IssuePhoto[]> {
67:     return this.findAll({
68:       ...options,
69:       filters: {
70:         ...options?.filters,
71:         documentId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º document_id
72:       }
73:     });
74:   }
75: 
76:   /**
77:    * æ ¹æ®ç…§ç‰‡ç±»å‹æŸ¥è¯¢é—®é¢˜ç…§ç‰‡
78:    *
79:    * @param photoType ç…§ç‰‡ç±»å‹
80:    * @param options æŸ¥è¯¢é€‰é¡¹
81:    * @returns Observable<IssuePhoto[]>
82:    */
83:   findByPhotoType(photoType: string, options?: QueryOptions): Observable<IssuePhoto[]> {
84:     return this.findAll({
85:       ...options,
86:       filters: {
87:         ...options?.filters,
88:         photoType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º photo_type
89:       }
90:     });
91:   }
92: }
````

## File: src/app/core/infra/repositories/issue-sync-log.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: 
  4: import { BaseRepository, QueryOptions } from './base.repository';
  5: import { Database } from '../types/database.types';
  6: 
  7: /**
  8:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
  9:  */
 10: type IssueSyncLogRow = Database['public']['Tables']['issue_sync_logs']['Row'];
 11: type IssueSyncLogInsert = Database['public']['Tables']['issue_sync_logs']['Insert'];
 12: type IssueSyncLogUpdate = Database['public']['Tables']['issue_sync_logs']['Update'];
 13: 
 14: /**
 15:  * IssueSyncLog å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 16:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 17:  */
 18: export type IssueSyncLog = IssueSyncLogRow;
 19: export type { IssueSyncLogInsert, IssueSyncLogUpdate };
 20: 
 21: /**
 22:  * IssueSyncLog Repository
 23:  *
 24:  * æä¾›é—®é¢˜åŒæ­¥è®°å½•ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 25:  *
 26:  * @example
 27:  * ```typescript
 28:  * const issueSyncLogRepo = inject(IssueSyncLogRepository);
 29:  * issueSyncLogRepo.findByIssueId('issue-id').subscribe(logs => {
 30:  *   console.log('Sync logs:', logs);
 31:  * });
 32:  * ```
 33:  */
 34: @Injectable({
 35:   providedIn: 'root'
 36: })
 37: export class IssueSyncLogRepository extends BaseRepository<IssueSyncLog, IssueSyncLogInsert, IssueSyncLogUpdate> {
 38:   protected tableName = 'issue_sync_logs';
 39: 
 40:   /**
 41:    * æ ¹æ®é—®é¢˜ ID æŸ¥è¯¢é—®é¢˜åŒæ­¥è®°å½•
 42:    *
 43:    * @param issueId é—®é¢˜ ID
 44:    * @param options æŸ¥è¯¢é€‰é¡¹
 45:    * @returns Observable<IssueSyncLog[]>
 46:    */
 47:   findByIssueId(issueId: string, options?: QueryOptions): Observable<IssueSyncLog[]> {
 48:     return this.findAll({
 49:       ...options,
 50:       filters: {
 51:         ...options?.filters,
 52:         issueId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º issue_id
 53:       },
 54:       orderBy: 'syncedAt', // æŒ‰åŒæ­¥æ—¶é—´æ’åº
 55:       orderDirection: 'desc'
 56:     });
 57:   }
 58: 
 59:   /**
 60:    * æ ¹æ®æºåˆ†æ”¯ ID æŸ¥è¯¢é—®é¢˜åŒæ­¥è®°å½•
 61:    *
 62:    * @param sourceBranchId æºåˆ†æ”¯ ID
 63:    * @param options æŸ¥è¯¢é€‰é¡¹
 64:    * @returns Observable<IssueSyncLog[]>
 65:    */
 66:   findBySourceBranchId(sourceBranchId: string, options?: QueryOptions): Observable<IssueSyncLog[]> {
 67:     return this.findAll({
 68:       ...options,
 69:       filters: {
 70:         ...options?.filters,
 71:         sourceBranchId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º source_branch_id
 72:       },
 73:       orderBy: 'syncedAt',
 74:       orderDirection: 'desc'
 75:     });
 76:   }
 77: 
 78:   /**
 79:    * æ ¹æ®ç›®æ ‡è“å›¾ ID æŸ¥è¯¢é—®é¢˜åŒæ­¥è®°å½•
 80:    *
 81:    * @param targetBlueprintId ç›®æ ‡è“å›¾ ID
 82:    * @param options æŸ¥è¯¢é€‰é¡¹
 83:    * @returns Observable<IssueSyncLog[]>
 84:    */
 85:   findByTargetBlueprintId(targetBlueprintId: string, options?: QueryOptions): Observable<IssueSyncLog[]> {
 86:     return this.findAll({
 87:       ...options,
 88:       filters: {
 89:         ...options?.filters,
 90:         targetBlueprintId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º target_blueprint_id
 91:       },
 92:       orderBy: 'syncedAt',
 93:       orderDirection: 'desc'
 94:     });
 95:   }
 96: 
 97:   /**
 98:    * æ ¹æ®åŒæ­¥ç±»å‹æŸ¥è¯¢é—®é¢˜åŒæ­¥è®°å½•
 99:    *
100:    * @param syncType åŒæ­¥ç±»å‹
101:    * @param options æŸ¥è¯¢é€‰é¡¹
102:    * @returns Observable<IssueSyncLog[]>
103:    */
104:   findBySyncType(syncType: string, options?: QueryOptions): Observable<IssueSyncLog[]> {
105:     return this.findAll({
106:       ...options,
107:       filters: {
108:         ...options?.filters,
109:         syncType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º sync_type
110:       },
111:       orderBy: 'syncedAt',
112:       orderDirection: 'desc'
113:     });
114:   }
115: }
````

## File: src/app/core/infra/repositories/issue.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable, from } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: import { toCamelCaseData } from '../utils/transformers';
  8: 
  9: /**
 10:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 11:  */
 12: type IssueRow = Database['public']['Tables']['issues']['Row'];
 13: type IssueInsert = Database['public']['Tables']['issues']['Insert'];
 14: type IssueUpdate = Database['public']['Tables']['issues']['Update'];
 15: 
 16: /**
 17:  * Issue å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 18:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 19:  */
 20: export type Issue = IssueRow;
 21: export type { IssueInsert, IssueUpdate };
 22: 
 23: /**
 24:  * Issue Repository
 25:  *
 26:  * æä¾›é—®é¢˜ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 27:  *
 28:  * @example
 29:  * ```typescript
 30:  * const issueRepo = inject(IssueRepository);
 31:  * issueRepo.findByBlueprintId('blueprint-id').subscribe(issues => {
 32:  *   console.log('Issues:', issues);
 33:  * });
 34:  * ```
 35:  */
 36: @Injectable({
 37:   providedIn: 'root'
 38: })
 39: export class IssueRepository extends BaseRepository<Issue, IssueInsert, IssueUpdate> {
 40:   protected tableName = 'issues';
 41: 
 42:   /**
 43:    * æ ¹æ®è“å›¾ ID æŸ¥è¯¢é—®é¢˜
 44:    *
 45:    * @param blueprintId è“å›¾ ID
 46:    * @param options æŸ¥è¯¢é€‰é¡¹
 47:    * @returns Observable<Issue[]>
 48:    */
 49:   findByBlueprintId(blueprintId: string, options?: QueryOptions): Observable<Issue[]> {
 50:     return this.findAll({
 51:       ...options,
 52:       filters: {
 53:         ...options?.filters,
 54:         blueprintId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º blueprint_id
 55:       }
 56:     });
 57:   }
 58: 
 59:   /**
 60:    * æ ¹æ®åˆ†æ”¯ ID æŸ¥è¯¢é—®é¢˜
 61:    *
 62:    * @param branchId åˆ†æ”¯ ID
 63:    * @param options æŸ¥è¯¢é€‰é¡¹
 64:    * @returns Observable<Issue[]>
 65:    */
 66:   findByBranchId(branchId: string, options?: QueryOptions): Observable<Issue[]> {
 67:     return this.findAll({
 68:       ...options,
 69:       filters: {
 70:         ...options?.filters,
 71:         branchId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º branch_id
 72:       }
 73:     });
 74:   }
 75: 
 76:   /**
 77:    * æ ¹æ®ä»»åŠ¡ ID æŸ¥è¯¢é—®é¢˜
 78:    *
 79:    * @param taskId ä»»åŠ¡ ID
 80:    * @param options æŸ¥è¯¢é€‰é¡¹
 81:    * @returns Observable<Issue[]>
 82:    */
 83:   findByTaskId(taskId: string, options?: QueryOptions): Observable<Issue[]> {
 84:     return this.findAll({
 85:       ...options,
 86:       filters: {
 87:         ...options?.filters,
 88:         taskId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º task_id
 89:       }
 90:     });
 91:   }
 92: 
 93:   /**
 94:    * æ ¹æ®çŠ¶æ€æŸ¥è¯¢é—®é¢˜
 95:    *
 96:    * @param status é—®é¢˜çŠ¶æ€
 97:    * @param options æŸ¥è¯¢é€‰é¡¹
 98:    * @returns Observable<Issue[]>
 99:    */
100:   findByStatus(status: string, options?: QueryOptions): Observable<Issue[]> {
101:     return this.findAll({
102:       ...options,
103:       filters: {
104:         ...options?.filters,
105:         status
106:       }
107:     });
108:   }
109: 
110:   /**
111:    * æ ¹æ®ä¸¥é‡ç¨‹åº¦æŸ¥è¯¢é—®é¢˜
112:    *
113:    * @param severity ä¸¥é‡ç¨‹åº¦
114:    * @param options æŸ¥è¯¢é€‰é¡¹
115:    * @returns Observable<Issue[]>
116:    */
117:   findBySeverity(severity: string, options?: QueryOptions): Observable<Issue[]> {
118:     return this.findAll({
119:       ...options,
120:       filters: {
121:         ...options?.filters,
122:         severity
123:       }
124:     });
125:   }
126: 
127:   /**
128:    * æ ¹æ®é—®é¢˜ç±»å‹æŸ¥è¯¢é—®é¢˜
129:    *
130:    * @param issueType é—®é¢˜ç±»å‹
131:    * @param options æŸ¥è¯¢é€‰é¡¹
132:    * @returns Observable<Issue[]>
133:    */
134:   findByIssueType(issueType: string, options?: QueryOptions): Observable<Issue[]> {
135:     return this.findAll({
136:       ...options,
137:       filters: {
138:         ...options?.filters,
139:         issueType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º issue_type
140:       }
141:     });
142:   }
143: 
144:   /**
145:    * æ ¹æ®æŠ¥å‘ŠäººæŸ¥è¯¢é—®é¢˜
146:    *
147:    * @param reportedBy æŠ¥å‘Šäºº ID
148:    * @param options æŸ¥è¯¢é€‰é¡¹
149:    * @returns Observable<Issue[]>
150:    */
151:   findByReportedBy(reportedBy: string, options?: QueryOptions): Observable<Issue[]> {
152:     return this.findAll({
153:       ...options,
154:       filters: {
155:         ...options?.filters,
156:         reportedBy // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º reported_by
157:       }
158:     });
159:   }
160: 
161:   /**
162:    * æŸ¥è¯¢æœªè§£å†³çš„é—®é¢˜
163:    *
164:    * @param blueprintId è“å›¾ IDï¼ˆå¯é€‰ï¼‰
165:    * @returns Observable<Issue[]>
166:    */
167:   findOpenIssues(blueprintId?: string): Observable<Issue[]> {
168:     const filters: Record<string, any> = {};
169:     // æœªè§£å†³çš„é—®é¢˜ï¼šstatus ä¸ä¸º 'closed' æˆ– 'resolved'
170:     // ç”±äº BaseRepository çš„ filters åªæ”¯æŒç­‰å€¼æŸ¥è¯¢ï¼Œè¿™é‡Œéœ€è¦ç‰¹æ®Šå¤„ç†
171:     // ä½¿ç”¨ Supabase client ç›´æ¥æŸ¥è¯¢
172:     let query: any = this.supabase
173:       .from(this.tableName as any)
174:       .select('*')
175:       .or('status.is.null,status.neq.closed,status.neq.resolved');
176: 
177:     if (blueprintId) {
178:       query = query.eq('blueprint_id', blueprintId);
179:     }
180: 
181:     return from(Promise.resolve(query) as Promise<{ data: any[] | null; error: any }>).pipe(
182:       map((response: { data: any[] | null; error: any }) => {
183:         if (response.error) {
184:           throw new Error(response.error.message || 'æŸ¥è¯¢æœªè§£å†³é—®é¢˜å¤±è´¥');
185:         }
186:         return (response.data || []).map(item => toCamelCaseData<Issue>(item));
187:       })
188:     );
189:   }
190: 
191:   /**
192:    * æŸ¥è¯¢å·²åŒæ­¥åˆ°ä¸»åˆ†æ”¯çš„é—®é¢˜
193:    *
194:    * @param options æŸ¥è¯¢é€‰é¡¹
195:    * @returns Observable<Issue[]>
196:    */
197:   findSyncedToMain(options?: QueryOptions): Observable<Issue[]> {
198:     return this.findAll({
199:       ...options,
200:       filters: {
201:         ...options?.filters,
202:         syncedToMain: true // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º synced_to_main
203:       }
204:     });
205:   }
206: }
````

## File: src/app/core/infra/repositories/notification-rule.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: 
  4: import { BaseRepository, QueryOptions } from './base.repository';
  5: import { Database } from '../types/database.types';
  6: 
  7: /**
  8:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
  9:  */
 10: type NotificationRuleRow = Database['public']['Tables']['notification_rules']['Row'];
 11: type NotificationRuleInsert = Database['public']['Tables']['notification_rules']['Insert'];
 12: type NotificationRuleUpdate = Database['public']['Tables']['notification_rules']['Update'];
 13: 
 14: /**
 15:  * NotificationRule å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 16:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 17:  */
 18: export type NotificationRule = NotificationRuleRow;
 19: export type { NotificationRuleInsert, NotificationRuleUpdate };
 20: 
 21: /**
 22:  * NotificationRule Repository
 23:  *
 24:  * æä¾›é€šçŸ¥è§„åˆ™ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 25:  *
 26:  * @example
 27:  * ```typescript
 28:  * const notificationRuleRepo = inject(NotificationRuleRepository);
 29:  * notificationRuleRepo.findByAccountId('account-id').subscribe(rules => {
 30:  *   console.log('Notification rules:', rules);
 31:  * });
 32:  * ```
 33:  */
 34: @Injectable({
 35:   providedIn: 'root'
 36: })
 37: export class NotificationRuleRepository extends BaseRepository<NotificationRule, NotificationRuleInsert, NotificationRuleUpdate> {
 38:   protected tableName = 'notification_rules';
 39: 
 40:   /**
 41:    * æ ¹æ®è´¦æˆ· ID æŸ¥è¯¢é€šçŸ¥è§„åˆ™
 42:    *
 43:    * @param accountId è´¦æˆ· ID
 44:    * @param options æŸ¥è¯¢é€‰é¡¹
 45:    * @returns Observable<NotificationRule[]>
 46:    */
 47:   findByAccountId(accountId: string, options?: QueryOptions): Observable<NotificationRule[]> {
 48:     return this.findAll({
 49:       ...options,
 50:       filters: {
 51:         ...options?.filters,
 52:         accountId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º account_id
 53:       }
 54:     });
 55:   }
 56: 
 57:   /**
 58:    * æ ¹æ®é€šçŸ¥ç±»å‹æŸ¥è¯¢é€šçŸ¥è§„åˆ™
 59:    *
 60:    * @param notificationType é€šçŸ¥ç±»å‹
 61:    * @param options æŸ¥è¯¢é€‰é¡¹
 62:    * @returns Observable<NotificationRule[]>
 63:    */
 64:   findByNotificationType(notificationType: string, options?: QueryOptions): Observable<NotificationRule[]> {
 65:     return this.findAll({
 66:       ...options,
 67:       filters: {
 68:         ...options?.filters,
 69:         notificationType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º notification_type
 70:       }
 71:     });
 72:   }
 73: 
 74:   /**
 75:    * æŸ¥è¯¢å¯ç”¨çš„è§„åˆ™
 76:    *
 77:    * @param accountId è´¦æˆ· ID
 78:    * @returns Observable<NotificationRule[]>
 79:    */
 80:   findEnabledRules(accountId: string): Observable<NotificationRule[]> {
 81:     return this.findAll({
 82:       filters: {
 83:         accountId,
 84:         isEnabled: true // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º is_enabled
 85:       }
 86:     });
 87:   }
 88: 
 89:   /**
 90:    * æ ¹æ®æ¸ é“æŸ¥è¯¢é€šçŸ¥è§„åˆ™
 91:    *
 92:    * @param channel æ¸ é“
 93:    * @param options æŸ¥è¯¢é€‰é¡¹
 94:    * @returns Observable<NotificationRule[]>
 95:    */
 96:   findByChannel(channel: string, options?: QueryOptions): Observable<NotificationRule[]> {
 97:     return this.findAll({
 98:       ...options,
 99:       filters: {
100:         ...options?.filters,
101:         channel
102:       }
103:     });
104:   }
105: }
````

## File: src/app/core/infra/repositories/notification-subscription.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: 
  8: /**
  9:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 10:  */
 11: type NotificationSubscriptionRow = Database['public']['Tables']['notification_subscriptions']['Row'];
 12: type NotificationSubscriptionInsert = Database['public']['Tables']['notification_subscriptions']['Insert'];
 13: type NotificationSubscriptionUpdate = Database['public']['Tables']['notification_subscriptions']['Update'];
 14: 
 15: /**
 16:  * NotificationSubscription å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 17:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 18:  */
 19: export type NotificationSubscription = NotificationSubscriptionRow;
 20: export type { NotificationSubscriptionInsert, NotificationSubscriptionUpdate };
 21: 
 22: /**
 23:  * NotificationSubscription Repository
 24:  *
 25:  * æä¾›é€šçŸ¥è®¢é˜…ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 26:  *
 27:  * @example
 28:  * ```typescript
 29:  * const subscriptionRepo = inject(NotificationSubscriptionRepository);
 30:  * subscriptionRepo.findByAccountId('account-id').subscribe(subscriptions => {
 31:  *   console.log('Subscriptions:', subscriptions);
 32:  * });
 33:  * ```
 34:  */
 35: @Injectable({
 36:   providedIn: 'root'
 37: })
 38: export class NotificationSubscriptionRepository extends BaseRepository<
 39:   NotificationSubscription,
 40:   NotificationSubscriptionInsert,
 41:   NotificationSubscriptionUpdate
 42: > {
 43:   protected tableName = 'notification_subscriptions';
 44: 
 45:   /**
 46:    * æ ¹æ®è´¦æˆ· ID æŸ¥è¯¢é€šçŸ¥è®¢é˜…
 47:    *
 48:    * @param accountId è´¦æˆ· ID
 49:    * @param options æŸ¥è¯¢é€‰é¡¹
 50:    * @returns Observable<NotificationSubscription[]>
 51:    */
 52:   findByAccountId(accountId: string, options?: QueryOptions): Observable<NotificationSubscription[]> {
 53:     return this.findAll({
 54:       ...options,
 55:       filters: {
 56:         ...options?.filters,
 57:         accountId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º account_id
 58:       }
 59:     });
 60:   }
 61: 
 62:   /**
 63:    * æ ¹æ®è®¢é˜…ç±»å‹æŸ¥è¯¢é€šçŸ¥è®¢é˜…
 64:    *
 65:    * @param subscribableType è®¢é˜…ç±»å‹
 66:    * @param options æŸ¥è¯¢é€‰é¡¹
 67:    * @returns Observable<NotificationSubscription[]>
 68:    */
 69:   findBySubscribableType(subscribableType: string, options?: QueryOptions): Observable<NotificationSubscription[]> {
 70:     return this.findAll({
 71:       ...options,
 72:       filters: {
 73:         ...options?.filters,
 74:         subscribableType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º subscribable_type
 75:       }
 76:     });
 77:   }
 78: 
 79:   /**
 80:    * æ ¹æ®è®¢é˜…å¯¹è±¡æŸ¥è¯¢é€šçŸ¥è®¢é˜…
 81:    *
 82:    * @param subscribableType è®¢é˜…ç±»å‹
 83:    * @param subscribableId è®¢é˜…å¯¹è±¡ ID
 84:    * @param options æŸ¥è¯¢é€‰é¡¹
 85:    * @returns Observable<NotificationSubscription[]>
 86:    */
 87:   findBySubscribableId(subscribableType: string, subscribableId: string, options?: QueryOptions): Observable<NotificationSubscription[]> {
 88:     return this.findAll({
 89:       ...options,
 90:       filters: {
 91:         ...options?.filters,
 92:         subscribableType,
 93:         subscribableId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º subscribable_id
 94:       }
 95:     });
 96:   }
 97: 
 98:   /**
 99:    * æŸ¥è¯¢è®¢é˜…å…³ç³»
100:    *
101:    * @param accountId è´¦æˆ· ID
102:    * @param subscribableType è®¢é˜…ç±»å‹
103:    * @param subscribableId è®¢é˜…å¯¹è±¡ ID
104:    * @returns Observable<NotificationSubscription | null>
105:    */
106:   findByAccountAndSubscribable(
107:     accountId: string,
108:     subscribableType: string,
109:     subscribableId: string
110:   ): Observable<NotificationSubscription | null> {
111:     return this.findAll({
112:       filters: {
113:         accountId,
114:         subscribableType,
115:         subscribableId
116:       }
117:     }).pipe(map(subscriptions => (subscriptions.length > 0 ? subscriptions[0] : null)));
118:   }
119: }
````

## File: src/app/core/infra/repositories/notification.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable, from } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: import { toCamelCaseData } from '../utils/transformers';
  8: 
  9: /**
 10:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 11:  */
 12: type NotificationRow = Database['public']['Tables']['notifications']['Row'];
 13: type NotificationInsert = Database['public']['Tables']['notifications']['Insert'];
 14: type NotificationUpdate = Database['public']['Tables']['notifications']['Update'];
 15: 
 16: /**
 17:  * Notification å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 18:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 19:  */
 20: export type Notification = NotificationRow;
 21: export type { NotificationInsert, NotificationUpdate };
 22: 
 23: /**
 24:  * Notification Repository
 25:  *
 26:  * æä¾›é€šçŸ¥ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 27:  *
 28:  * @example
 29:  * ```typescript
 30:  * const notificationRepo = inject(NotificationRepository);
 31:  * notificationRepo.findByRecipientId('account-id').subscribe(notifications => {
 32:  *   console.log('Notifications:', notifications);
 33:  * });
 34:  * ```
 35:  */
 36: @Injectable({
 37:   providedIn: 'root'
 38: })
 39: export class NotificationRepository extends BaseRepository<Notification, NotificationInsert, NotificationUpdate> {
 40:   protected tableName = 'notifications';
 41: 
 42:   /**
 43:    * æ ¹æ®æ¥æ”¶äºº ID æŸ¥è¯¢é€šçŸ¥
 44:    *
 45:    * @param recipientId æ¥æ”¶äºº ID
 46:    * @param options æŸ¥è¯¢é€‰é¡¹
 47:    * @returns Observable<Notification[]>
 48:    */
 49:   findByRecipientId(recipientId: string, options?: QueryOptions): Observable<Notification[]> {
 50:     return this.findAll({
 51:       ...options,
 52:       filters: {
 53:         ...options?.filters,
 54:         recipientId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º recipient_id
 55:       },
 56:       orderBy: 'createdAt',
 57:       orderDirection: 'desc'
 58:     });
 59:   }
 60: 
 61:   /**
 62:    * æŸ¥è¯¢æœªè¯»é€šçŸ¥
 63:    *
 64:    * @param recipientId æ¥æ”¶äºº ID
 65:    * @param options æŸ¥è¯¢é€‰é¡¹
 66:    * @returns Observable<Notification[]>
 67:    */
 68:   findUnreadByRecipientId(recipientId: string, options?: QueryOptions): Observable<Notification[]> {
 69:     // æœªè¯»é€šçŸ¥ï¼šis_read = false æˆ– null
 70:     let query: any = this.supabase
 71:       .from(this.tableName as any)
 72:       .select('*')
 73:       .eq('recipient_id', recipientId)
 74:       .or('is_read.is.null,is_read.eq.false');
 75: 
 76:     // åº”ç”¨æ’åº
 77:     if (options?.orderBy) {
 78:       const snakeOrderBy = options.orderBy.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);
 79:       query = query.order(snakeOrderBy, { ascending: options.orderDirection !== 'desc' });
 80:     } else {
 81:       query = query.order('created_at', { ascending: false });
 82:     }
 83: 
 84:     // åº”ç”¨åˆ†é¡µ
 85:     if (options?.page && options?.pageSize) {
 86:       const fromIndex = (options.page - 1) * options.pageSize;
 87:       const toIndex = fromIndex + options.pageSize - 1;
 88:       query = query.range(fromIndex, toIndex);
 89:     }
 90: 
 91:     return from(Promise.resolve(query) as Promise<{ data: any[] | null; error: any }>).pipe(
 92:       map((response: { data: any[] | null; error: any }) => {
 93:         if (response.error) {
 94:           throw new Error(response.error.message || 'æŸ¥è¯¢æœªè¯»é€šçŸ¥å¤±è´¥');
 95:         }
 96:         return (response.data || []).map(item => toCamelCaseData<Notification>(item));
 97:       })
 98:     );
 99:   }
100: 
101:   /**
102:    * æ ¹æ®å‘é€äºº ID æŸ¥è¯¢é€šçŸ¥
103:    *
104:    * @param senderId å‘é€äºº ID
105:    * @param options æŸ¥è¯¢é€‰é¡¹
106:    * @returns Observable<Notification[]>
107:    */
108:   findBySenderId(senderId: string, options?: QueryOptions): Observable<Notification[]> {
109:     return this.findAll({
110:       ...options,
111:       filters: {
112:         ...options?.filters,
113:         senderId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º sender_id
114:       },
115:       orderBy: 'createdAt',
116:       orderDirection: 'desc'
117:     });
118:   }
119: 
120:   /**
121:    * æ ¹æ®é€šçŸ¥ç±»å‹æŸ¥è¯¢é€šçŸ¥
122:    *
123:    * @param notificationType é€šçŸ¥ç±»å‹
124:    * @param options æŸ¥è¯¢é€‰é¡¹
125:    * @returns Observable<Notification[]>
126:    */
127:   findByNotificationType(notificationType: string, options?: QueryOptions): Observable<Notification[]> {
128:     return this.findAll({
129:       ...options,
130:       filters: {
131:         ...options?.filters,
132:         notificationType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º notification_type
133:       },
134:       orderBy: 'createdAt',
135:       orderDirection: 'desc'
136:     });
137:   }
138: 
139:   /**
140:    * æ ¹æ®å…³è”å¯¹è±¡æŸ¥è¯¢é€šçŸ¥
141:    *
142:    * @param relatedType å…³è”ç±»å‹
143:    * @param relatedId å…³è” ID
144:    * @param options æŸ¥è¯¢é€‰é¡¹
145:    * @returns Observable<Notification[]>
146:    */
147:   findByRelatedType(relatedType: string, relatedId: string, options?: QueryOptions): Observable<Notification[]> {
148:     return this.findAll({
149:       ...options,
150:       filters: {
151:         ...options?.filters,
152:         relatedType, // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º related_type
153:         relatedId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º related_id
154:       },
155:       orderBy: 'createdAt',
156:       orderDirection: 'desc'
157:     });
158:   }
159: 
160:   /**
161:    * æ ‡è®°ä¸ºå·²è¯»
162:    *
163:    * @param notificationId é€šçŸ¥ ID
164:    * @returns Observable<void>
165:    */
166:   markAsRead(notificationId: string): Observable<void> {
167:     return this.update(notificationId, {
168:       isRead: true,
169:       readAt: new Date().toISOString()
170:     } as NotificationUpdate).pipe(map(() => undefined));
171:   }
172: 
173:   /**
174:    * æ ‡è®°æ‰€æœ‰ä¸ºå·²è¯»
175:    *
176:    * @param recipientId æ¥æ”¶äºº ID
177:    * @returns Observable<void>
178:    */
179:   markAllAsRead(recipientId: string): Observable<void> {
180:     // ä½¿ç”¨ Supabase client æ‰¹é‡æ›´æ–°
181:     return from(
182:       this.supabase
183:         .from(this.tableName as any)
184:         .update({
185:           is_read: true,
186:           read_at: new Date().toISOString()
187:         })
188:         .eq('recipient_id', recipientId)
189:         .or('is_read.is.null,is_read.eq.false')
190:     ).pipe(
191:       map((response: { error: any }) => {
192:         if (response.error) {
193:           throw new Error(response.error.message || 'æ ‡è®°æ‰€æœ‰é€šçŸ¥ä¸ºå·²è¯»å¤±è´¥');
194:         }
195:       })
196:     );
197:   }
198: }
````

## File: src/app/core/infra/repositories/organization-member.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: 
  4: import { OrganizationMemberRole } from '../types/account.types';
  5: import { Database } from '../types/database.types';
  6: import { BaseRepository, QueryOptions } from './base.repository';
  7: 
  8: /**
  9:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 10:  */
 11: type OrganizationMemberRow = Database['public']['Tables']['organization_members']['Row'];
 12: type OrganizationMemberInsert = Database['public']['Tables']['organization_members']['Insert'];
 13: type OrganizationMemberUpdate = Database['public']['Tables']['organization_members']['Update'];
 14: 
 15: /**
 16:  * OrganizationMember å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 17:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 18:  */
 19: export type OrganizationMember = OrganizationMemberRow;
 20: export type { OrganizationMemberInsert, OrganizationMemberUpdate };
 21: 
 22: /**
 23:  * OrganizationMember Repository
 24:  *
 25:  * æä¾›ç»„ç»‡æˆå‘˜ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 26:  *
 27:  * @example
 28:  * ```typescript
 29:  * const orgMemberRepo = inject(OrganizationMemberRepository);
 30:  * orgMemberRepo.findByOrganizationId('org-id').subscribe(members => {
 31:  *   console.log('Organization members:', members);
 32:  * });
 33:  * ```
 34:  */
 35: @Injectable({
 36:   providedIn: 'root'
 37: })
 38: export class OrganizationMemberRepository extends BaseRepository<OrganizationMember, OrganizationMemberInsert, OrganizationMemberUpdate> {
 39:   protected tableName = 'organization_members';
 40: 
 41:   /**
 42:    * æ ¹æ®ç»„ç»‡ ID æŸ¥è¯¢ç»„ç»‡æˆå‘˜åˆ—è¡¨
 43:    *
 44:    * @param organizationId ç»„ç»‡ ID
 45:    * @param options æŸ¥è¯¢é€‰é¡¹
 46:    * @returns Observable<OrganizationMember[]>
 47:    */
 48:   findByOrganizationId(organizationId: string, options?: QueryOptions): Observable<OrganizationMember[]> {
 49:     return this.findAll({
 50:       ...options,
 51:       filters: {
 52:         ...options?.filters,
 53:         organizationId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º organization_id
 54:       }
 55:     });
 56:   }
 57: 
 58:   /**
 59:    * æ ¹æ®è´¦æˆ· ID æŸ¥è¯¢ç»„ç»‡æˆå‘˜å…³ç³»
 60:    *
 61:    * @param accountId è´¦æˆ· ID
 62:    * @param options æŸ¥è¯¢é€‰é¡¹
 63:    * @returns Observable<OrganizationMember[]>
 64:    */
 65:   findByAccountId(accountId: string, options?: QueryOptions): Observable<OrganizationMember[]> {
 66:     return this.findAll({
 67:       ...options,
 68:       filters: {
 69:         ...options?.filters,
 70:         accountId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º account_id
 71:       }
 72:     });
 73:   }
 74: 
 75:   /**
 76:    * æ ¹æ®è§’è‰²æŸ¥è¯¢ç»„ç»‡æˆå‘˜
 77:    *
 78:    * @param role æˆå‘˜è§’è‰²
 79:    * @param options æŸ¥è¯¢é€‰é¡¹
 80:    * @returns Observable<OrganizationMember[]>
 81:    */
 82:   findByRole(role: OrganizationMemberRole, options?: QueryOptions): Observable<OrganizationMember[]> {
 83:     return this.findAll({
 84:       ...options,
 85:       filters: {
 86:         ...options?.filters,
 87:         role
 88:       }
 89:     });
 90:   }
 91: 
 92:   /**
 93:    * æŸ¥è¯¢ç»„ç»‡ä¸­çš„æ‹¥æœ‰è€…ï¼ˆownerï¼‰
 94:    *
 95:    * @param organizationId ç»„ç»‡ ID
 96:    * @returns Observable<OrganizationMember[]>
 97:    */
 98:   findOwnersByOrganizationId(organizationId: string): Observable<OrganizationMember[]> {
 99:     return this.findAll({
100:       filters: {
101:         organizationId, // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º organization_id
102:         role: OrganizationMemberRole.OWNER
103:       }
104:     });
105:   }
106: }
````

## File: src/app/core/infra/repositories/permission.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: 
  8: /**
  9:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 10:  */
 11: type PermissionRow = Database['public']['Tables']['permissions']['Row'];
 12: type PermissionInsert = Database['public']['Tables']['permissions']['Insert'];
 13: type PermissionUpdate = Database['public']['Tables']['permissions']['Update'];
 14: 
 15: /**
 16:  * Permission å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 17:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 18:  * æ³¨æ„ï¼šæ­¤ç±»å‹ä¸ core/permissions/types.ts ä¸­çš„ Permission æ¥å£ä¸åŒï¼Œæ­¤ç±»å‹ç”¨äºæ•°æ®è®¿é—®å±‚
 19:  */
 20: // æ³¨æ„ï¼šä¸å¯¼å‡º Permission ç±»å‹ï¼Œé¿å…ä¸ core/permissions/types.ts ä¸­çš„ Permission æ¥å£å†²çª
 21: // å¦‚æœéœ€è¦ä½¿ç”¨æ­¤ç±»å‹ï¼Œè¯·ä½¿ç”¨ PermissionEntity æˆ–ç›´æ¥ä» Repository æ–¹æ³•è¿”å›ç±»å‹æ¨æ–­
 22: type PermissionEntity = PermissionRow;
 23: export type { PermissionInsert, PermissionUpdate };
 24: 
 25: /**
 26:  * Permission Repository
 27:  *
 28:  * æä¾›æƒé™ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 29:  *
 30:  * @example
 31:  * ```typescript
 32:  * const permissionRepo = inject(PermissionRepository);
 33:  * permissionRepo.findByResource('blueprint').subscribe(permissions => {
 34:  *   console.log('Permissions:', permissions);
 35:  * });
 36:  * ```
 37:  */
 38: @Injectable({
 39:   providedIn: 'root'
 40: })
 41: export class PermissionRepository extends BaseRepository<PermissionEntity, PermissionInsert, PermissionUpdate> {
 42:   protected tableName = 'permissions';
 43: 
 44:   /**
 45:    * æ ¹æ®åç§°æŸ¥è¯¢æƒé™
 46:    *
 47:    * @param name æƒé™åç§°
 48:    * @returns Observable<Permission | null>
 49:    */
 50:   findByName(name: string): Observable<PermissionEntity | null> {
 51:     return this.findAll({
 52:       filters: {
 53:         name
 54:       }
 55:     }).pipe(map(permissions => (permissions.length > 0 ? permissions[0] : null)));
 56:   }
 57: 
 58:   /**
 59:    * æ ¹æ®èµ„æºæŸ¥è¯¢æƒé™
 60:    *
 61:    * @param resource èµ„æºåç§°
 62:    * @param options æŸ¥è¯¢é€‰é¡¹
 63:    * @returns Observable<Permission[]>
 64:    */
 65:   findByResource(resource: string, options?: QueryOptions): Observable<PermissionEntity[]> {
 66:     return this.findAll({
 67:       ...options,
 68:       filters: {
 69:         ...options?.filters,
 70:         resource
 71:       }
 72:     });
 73:   }
 74: 
 75:   /**
 76:    * æŸ¥è¯¢ç³»ç»Ÿæƒé™
 77:    *
 78:    * @param options æŸ¥è¯¢é€‰é¡¹
 79:    * @returns Observable<Permission[]>
 80:    */
 81:   findSystemPermissions(options?: QueryOptions): Observable<PermissionEntity[]> {
 82:     return this.findAll({
 83:       ...options,
 84:       filters: {
 85:         ...options?.filters,
 86:         isSystemPermission: true // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º is_system_permission
 87:       }
 88:     });
 89:   }
 90: 
 91:   /**
 92:    * æ ¹æ®èµ„æºå’Œæ“ä½œæŸ¥è¯¢æƒé™
 93:    *
 94:    * @param resource èµ„æºåç§°
 95:    * @param action æ“ä½œåç§°
 96:    * @returns Observable<Permission | null>
 97:    */
 98:   findByResourceAndAction(resource: string, action: string): Observable<PermissionEntity | null> {
 99:     return this.findAll({
100:       filters: {
101:         resource,
102:         action
103:       }
104:     }).pipe(map(permissions => (permissions.length > 0 ? permissions[0] : null)));
105:   }
106: }
````

## File: src/app/core/infra/repositories/personal-todo.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable, from } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: import { toCamelCaseData } from '../utils/transformers';
  8: 
  9: /**
 10:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 11:  */
 12: type PersonalTodoRow = Database['public']['Tables']['personal_todos']['Row'];
 13: type PersonalTodoInsert = Database['public']['Tables']['personal_todos']['Insert'];
 14: type PersonalTodoUpdate = Database['public']['Tables']['personal_todos']['Update'];
 15: 
 16: /**
 17:  * PersonalTodo å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 18:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 19:  */
 20: export type PersonalTodo = PersonalTodoRow;
 21: export type { PersonalTodoInsert, PersonalTodoUpdate };
 22: 
 23: /**
 24:  * PersonalTodo Repository
 25:  *
 26:  * æä¾›ä¸ªäººå¾…åŠç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 27:  *
 28:  * @example
 29:  * ```typescript
 30:  * const todoRepo = inject(PersonalTodoRepository);
 31:  * todoRepo.findByAccountId('account-id').subscribe(todos => {
 32:  *   console.log('Todos:', todos);
 33:  * });
 34:  * ```
 35:  */
 36: @Injectable({
 37:   providedIn: 'root'
 38: })
 39: export class PersonalTodoRepository extends BaseRepository<PersonalTodo, PersonalTodoInsert, PersonalTodoUpdate> {
 40:   protected tableName = 'personal_todos';
 41: 
 42:   /**
 43:    * æ ¹æ®è´¦æˆ· ID æŸ¥è¯¢ä¸ªäººå¾…åŠ
 44:    *
 45:    * @param accountId è´¦æˆ· ID
 46:    * @param options æŸ¥è¯¢é€‰é¡¹
 47:    * @returns Observable<PersonalTodo[]>
 48:    */
 49:   findByAccountId(accountId: string, options?: QueryOptions): Observable<PersonalTodo[]> {
 50:     return this.findAll({
 51:       ...options,
 52:       filters: {
 53:         ...options?.filters,
 54:         accountId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º account_id
 55:       },
 56:       orderBy: 'createdAt',
 57:       orderDirection: 'desc'
 58:     });
 59:   }
 60: 
 61:   /**
 62:    * æ ¹æ®çŠ¶æ€æŸ¥è¯¢ä¸ªäººå¾…åŠ
 63:    *
 64:    * @param status å¾…åŠçŠ¶æ€
 65:    * @param options æŸ¥è¯¢é€‰é¡¹
 66:    * @returns Observable<PersonalTodo[]>
 67:    */
 68:   findByStatus(status: string, options?: QueryOptions): Observable<PersonalTodo[]> {
 69:     return this.findAll({
 70:       ...options,
 71:       filters: {
 72:         ...options?.filters,
 73:         status
 74:       }
 75:     });
 76:   }
 77: 
 78:   /**
 79:    * æ ¹æ®å¾…åŠç±»å‹æŸ¥è¯¢ä¸ªäººå¾…åŠ
 80:    *
 81:    * @param todoType å¾…åŠç±»å‹
 82:    * @param options æŸ¥è¯¢é€‰é¡¹
 83:    * @returns Observable<PersonalTodo[]>
 84:    */
 85:   findByTodoType(todoType: string, options?: QueryOptions): Observable<PersonalTodo[]> {
 86:     return this.findAll({
 87:       ...options,
 88:       filters: {
 89:         ...options?.filters,
 90:         todoType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º todo_type
 91:       }
 92:     });
 93:   }
 94: 
 95:   /**
 96:    * æ ¹æ®å…³è”å¯¹è±¡æŸ¥è¯¢ä¸ªäººå¾…åŠ
 97:    *
 98:    * @param relatedType å…³è”ç±»å‹
 99:    * @param relatedId å…³è” ID
100:    * @param options æŸ¥è¯¢é€‰é¡¹
101:    * @returns Observable<PersonalTodo[]>
102:    */
103:   findByRelatedType(relatedType: string, relatedId: string, options?: QueryOptions): Observable<PersonalTodo[]> {
104:     return this.findAll({
105:       ...options,
106:       filters: {
107:         ...options?.filters,
108:         relatedType, // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º related_type
109:         relatedId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º related_id
110:       }
111:     });
112:   }
113: 
114:   /**
115:    * æ ¹æ®ä¼˜å…ˆçº§æŸ¥è¯¢ä¸ªäººå¾…åŠ
116:    *
117:    * @param priority ä¼˜å…ˆçº§
118:    * @param options æŸ¥è¯¢é€‰é¡¹
119:    * @returns Observable<PersonalTodo[]>
120:    */
121:   findByPriority(priority: string, options?: QueryOptions): Observable<PersonalTodo[]> {
122:     return this.findAll({
123:       ...options,
124:       filters: {
125:         ...options?.filters,
126:         priority
127:       }
128:     });
129:   }
130: 
131:   /**
132:    * æŸ¥è¯¢è¿‡æœŸå¾…åŠ
133:    *
134:    * @param accountId è´¦æˆ· ID
135:    * @returns Observable<PersonalTodo[]>
136:    */
137:   findOverdue(accountId: string): Observable<PersonalTodo[]> {
138:     // è¿‡æœŸå¾…åŠï¼šdue_date < NOW() ä¸” status ä¸ä¸º 'completed'
139:     // éœ€è¦ä½¿ç”¨ Supabase client ç›´æ¥æŸ¥è¯¢
140:     const now = new Date().toISOString();
141:     let query: any = this.supabase
142:       .from(this.tableName as any)
143:       .select('*')
144:       .eq('account_id', accountId)
145:       .lt('due_date', now)
146:       .or('status.is.null,status.neq.completed');
147: 
148:     query = query.order('due_date', { ascending: true });
149: 
150:     return from(Promise.resolve(query) as Promise<{ data: any[] | null; error: any }>).pipe(
151:       map((response: { data: any[] | null; error: any }) => {
152:         if (response.error) {
153:           throw new Error(response.error.message || 'æŸ¥è¯¢è¿‡æœŸå¾…åŠå¤±è´¥');
154:         }
155:         return (response.data || []).map(item => toCamelCaseData<PersonalTodo>(item));
156:       })
157:     );
158:   }
159: 
160:   /**
161:    * æŸ¥è¯¢å¾…æ‰§è¡Œçš„å¾…åŠ
162:    *
163:    * @param accountId è´¦æˆ· ID
164:    * @returns Observable<PersonalTodo[]>
165:    */
166:   findPending(accountId: string): Observable<PersonalTodo[]> {
167:     // å¾…æ‰§è¡Œçš„å¾…åŠï¼šstatus = 'pending' æˆ– null
168:     let query: any = this.supabase
169:       .from(this.tableName as any)
170:       .select('*')
171:       .eq('account_id', accountId)
172:       .or('status.is.null,status.eq.pending');
173: 
174:     query = query.order('created_at', { ascending: false });
175: 
176:     return from(Promise.resolve(query) as Promise<{ data: any[] | null; error: any }>).pipe(
177:       map((response: { data: any[] | null; error: any }) => {
178:         if (response.error) {
179:           throw new Error(response.error.message || 'æŸ¥è¯¢å¾…æ‰§è¡Œå¾…åŠå¤±è´¥');
180:         }
181:         return (response.data || []).map(item => toCamelCaseData<PersonalTodo>(item));
182:       })
183:     );
184:   }
185: }
````

## File: src/app/core/infra/repositories/progress-tracking.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable, from } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: import { toCamelCaseData } from '../utils/transformers';
  8: 
  9: /**
 10:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 11:  */
 12: type ProgressTrackingRow = Database['public']['Tables']['progress_tracking']['Row'];
 13: type ProgressTrackingInsert = Database['public']['Tables']['progress_tracking']['Insert'];
 14: type ProgressTrackingUpdate = Database['public']['Tables']['progress_tracking']['Update'];
 15: 
 16: /**
 17:  * ProgressTracking å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 18:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 19:  */
 20: export type ProgressTracking = ProgressTrackingRow;
 21: export type { ProgressTrackingInsert, ProgressTrackingUpdate };
 22: 
 23: /**
 24:  * ProgressTracking Repository
 25:  *
 26:  * æä¾›è¿›åº¦è¿½è¸ªç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 27:  *
 28:  * @example
 29:  * ```typescript
 30:  * const trackingRepo = inject(ProgressTrackingRepository);
 31:  * trackingRepo.findByBlueprintId('blueprint-id').subscribe(trackings => {
 32:  *   console.log('Progress tracking:', trackings);
 33:  * });
 34:  * ```
 35:  */
 36: @Injectable({
 37:   providedIn: 'root'
 38: })
 39: export class ProgressTrackingRepository extends BaseRepository<ProgressTracking, ProgressTrackingInsert, ProgressTrackingUpdate> {
 40:   protected tableName = 'progress_tracking';
 41: 
 42:   /**
 43:    * æ ¹æ®è“å›¾ ID æŸ¥è¯¢è¿›åº¦è¿½è¸ª
 44:    *
 45:    * @param blueprintId è“å›¾ ID
 46:    * @param options æŸ¥è¯¢é€‰é¡¹
 47:    * @returns Observable<ProgressTracking[]>
 48:    */
 49:   findByBlueprintId(blueprintId: string, options?: QueryOptions): Observable<ProgressTracking[]> {
 50:     return this.findAll({
 51:       ...options,
 52:       filters: {
 53:         ...options?.filters,
 54:         blueprintId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º blueprint_id
 55:       },
 56:       orderBy: 'trackingDate',
 57:       orderDirection: 'desc'
 58:     });
 59:   }
 60: 
 61:   /**
 62:    * æ ¹æ®åˆ†æ”¯ ID æŸ¥è¯¢è¿›åº¦è¿½è¸ª
 63:    *
 64:    * @param branchId åˆ†æ”¯ ID
 65:    * @param options æŸ¥è¯¢é€‰é¡¹
 66:    * @returns Observable<ProgressTracking[]>
 67:    */
 68:   findByBranchId(branchId: string, options?: QueryOptions): Observable<ProgressTracking[]> {
 69:     return this.findAll({
 70:       ...options,
 71:       filters: {
 72:         ...options?.filters,
 73:         branchId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º branch_id
 74:       },
 75:       orderBy: 'trackingDate',
 76:       orderDirection: 'desc'
 77:     });
 78:   }
 79: 
 80:   /**
 81:    * æ ¹æ®è¿½è¸ªæ—¥æœŸæŸ¥è¯¢è¿›åº¦è¿½è¸ª
 82:    *
 83:    * @param trackingDate è¿½è¸ªæ—¥æœŸ
 84:    * @param options æŸ¥è¯¢é€‰é¡¹
 85:    * @returns Observable<ProgressTracking[]>
 86:    */
 87:   findByTrackingDate(trackingDate: Date, options?: QueryOptions): Observable<ProgressTracking[]> {
 88:     const dateStr = trackingDate.toISOString().split('T')[0]; // åªå–æ—¥æœŸéƒ¨åˆ†
 89:     return this.findAll({
 90:       ...options,
 91:       filters: {
 92:         ...options?.filters,
 93:         trackingDate: dateStr // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º tracking_date
 94:       }
 95:     });
 96:   }
 97: 
 98:   /**
 99:    * æŸ¥è¯¢æœ€æ–°çš„è¿›åº¦è¿½è¸ª
100:    *
101:    * @param blueprintId è“å›¾ ID
102:    * @param branchId åˆ†æ”¯ IDï¼ˆå¯é€‰ï¼‰
103:    * @returns Observable<ProgressTracking | null>
104:    */
105:   findLatestByBlueprintId(blueprintId: string, branchId?: string): Observable<ProgressTracking | null> {
106:     return this.findAll({
107:       filters: {
108:         blueprintId,
109:         ...(branchId ? { branchId } : {})
110:       },
111:       orderBy: 'trackingDate',
112:       orderDirection: 'desc'
113:     }).pipe(map(trackings => (trackings.length > 0 ? trackings[0] : null)));
114:   }
115: 
116:   /**
117:    * æ ¹æ®æ—¥æœŸèŒƒå›´æŸ¥è¯¢è¿›åº¦è¿½è¸ª
118:    *
119:    * @param blueprintId è“å›¾ ID
120:    * @param startDate å¼€å§‹æ—¥æœŸ
121:    * @param endDate ç»“æŸæ—¥æœŸ
122:    * @param branchId åˆ†æ”¯ IDï¼ˆå¯é€‰ï¼‰
123:    * @returns Observable<ProgressTracking[]>
124:    */
125:   findByDateRange(blueprintId: string, startDate: Date, endDate: Date, branchId?: string): Observable<ProgressTracking[]> {
126:     // éœ€è¦æ—¥æœŸèŒƒå›´æŸ¥è¯¢ï¼Œä½¿ç”¨ Supabase client ç›´æ¥æŸ¥è¯¢
127:     const startDateStr = startDate.toISOString().split('T')[0];
128:     const endDateStr = endDate.toISOString().split('T')[0];
129: 
130:     let query: any = this.supabase
131:       .from(this.tableName as any)
132:       .select('*')
133:       .eq('blueprint_id', blueprintId)
134:       .gte('tracking_date', startDateStr)
135:       .lte('tracking_date', endDateStr);
136: 
137:     if (branchId) {
138:       query = query.eq('branch_id', branchId);
139:     }
140: 
141:     query = query.order('tracking_date', { ascending: false });
142: 
143:     return from(Promise.resolve(query) as Promise<{ data: any[] | null; error: any }>).pipe(
144:       map((response: { data: any[] | null; error: any }) => {
145:         if (response.error) {
146:           throw new Error(response.error.message || 'æ—¥æœŸèŒƒå›´æŸ¥è¯¢å¤±è´¥');
147:         }
148:         return (response.data || []).map(item => toCamelCaseData<ProgressTracking>(item));
149:       })
150:     );
151:   }
152: }
````

## File: src/app/core/infra/repositories/qc-photo.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: 
  4: import { BaseRepository, QueryOptions } from './base.repository';
  5: import { Database } from '../types/database.types';
  6: 
  7: /**
  8:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
  9:  */
 10: type QcPhotoRow = Database['public']['Tables']['qc_photos']['Row'];
 11: type QcPhotoInsert = Database['public']['Tables']['qc_photos']['Insert'];
 12: type QcPhotoUpdate = Database['public']['Tables']['qc_photos']['Update'];
 13: 
 14: /**
 15:  * QcPhoto å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 16:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 17:  */
 18: export type QcPhoto = QcPhotoRow;
 19: export type { QcPhotoInsert, QcPhotoUpdate };
 20: 
 21: /**
 22:  * QcPhoto Repository
 23:  *
 24:  * æä¾›å“è´¨æ£€æŸ¥ç…§ç‰‡ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 25:  *
 26:  * @example
 27:  * ```typescript
 28:  * const qcPhotoRepo = inject(QcPhotoRepository);
 29:  * qcPhotoRepo.findByQcId('qc-id').subscribe(photos => {
 30:  *   console.log('QC photos:', photos);
 31:  * });
 32:  * ```
 33:  */
 34: @Injectable({
 35:   providedIn: 'root'
 36: })
 37: export class QcPhotoRepository extends BaseRepository<QcPhoto, QcPhotoInsert, QcPhotoUpdate> {
 38:   protected tableName = 'qc_photos';
 39: 
 40:   /**
 41:    * æ ¹æ®å“è´¨æ£€æŸ¥ ID æŸ¥è¯¢ç…§ç‰‡
 42:    *
 43:    * @param qcId å“è´¨æ£€æŸ¥ ID
 44:    * @param options æŸ¥è¯¢é€‰é¡¹
 45:    * @returns Observable<QcPhoto[]>
 46:    */
 47:   findByQcId(qcId: string, options?: QueryOptions): Observable<QcPhoto[]> {
 48:     return this.findAll({
 49:       ...options,
 50:       filters: {
 51:         ...options?.filters,
 52:         qcId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º qc_id
 53:       },
 54:       orderBy: 'sequenceOrder', // æŒ‰é¡ºåºæ’åº
 55:       orderDirection: 'asc'
 56:     });
 57:   }
 58: 
 59:   /**
 60:    * æ ¹æ®æ–‡æ¡£ ID æŸ¥è¯¢ç…§ç‰‡
 61:    *
 62:    * @param documentId æ–‡æ¡£ ID
 63:    * @param options æŸ¥è¯¢é€‰é¡¹
 64:    * @returns Observable<QcPhoto[]>
 65:    */
 66:   findByDocumentId(documentId: string, options?: QueryOptions): Observable<QcPhoto[]> {
 67:     return this.findAll({
 68:       ...options,
 69:       filters: {
 70:         ...options?.filters,
 71:         documentId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º document_id
 72:       }
 73:     });
 74:   }
 75: 
 76:   /**
 77:    * æ ¹æ®ç…§ç‰‡ç±»å‹æŸ¥è¯¢ç…§ç‰‡
 78:    *
 79:    * @param photoType ç…§ç‰‡ç±»å‹
 80:    * @param options æŸ¥è¯¢é€‰é¡¹
 81:    * @returns Observable<QcPhoto[]>
 82:    */
 83:   findByPhotoType(photoType: string, options?: QueryOptions): Observable<QcPhoto[]> {
 84:     return this.findAll({
 85:       ...options,
 86:       filters: {
 87:         ...options?.filters,
 88:         photoType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º photo_type
 89:       }
 90:     });
 91:   }
 92: 
 93:   /**
 94:    * æ ¹æ®ä¸Šä¼ äºº ID æŸ¥è¯¢ç…§ç‰‡
 95:    *
 96:    * @param uploadedBy ä¸Šä¼ äºº ID
 97:    * @param options æŸ¥è¯¢é€‰é¡¹
 98:    * @returns Observable<QcPhoto[]>
 99:    */
100:   findByUploadedBy(uploadedBy: string, options?: QueryOptions): Observable<QcPhoto[]> {
101:     return this.findAll({
102:       ...options,
103:       filters: {
104:         ...options?.filters,
105:         uploadedBy // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º uploaded_by
106:       },
107:       orderBy: 'uploadedAt',
108:       orderDirection: 'desc'
109:     });
110:   }
111: }
````

## File: src/app/core/infra/repositories/quality-check.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: 
 4: import { BaseRepository, QueryOptions } from './base.repository';
 5: import { Database } from '../types/database.types';
 6: 
 7: /**
 8:  * QualityCheck å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 9:  */
10: type QualityCheckRow = Database['public']['Tables']['quality_checks']['Row'];
11: type QualityCheckInsert = Database['public']['Tables']['quality_checks']['Insert'];
12: type QualityCheckUpdate = Database['public']['Tables']['quality_checks']['Update'];
13: 
14: export type QualityCheck = QualityCheckRow;
15: export type { QualityCheckInsert, QualityCheckUpdate };
16: 
17: /**
18:  * QualityCheck Repository
19:  *
20:  * æä¾›å“è´¨æ£€æŸ¥ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
21:  */
22: @Injectable({
23:   providedIn: 'root'
24: })
25: export class QualityCheckRepository extends BaseRepository<QualityCheck, QualityCheckInsert, QualityCheckUpdate> {
26:   protected tableName = 'quality_checks';
27: 
28:   /**
29:    * æ ¹æ®ä»»åŠ¡ ID æŸ¥è¯¢å“è´¨æ£€æŸ¥
30:    *
31:    * @param taskId ä»»åŠ¡ ID
32:    * @param options æŸ¥è¯¢é€‰é¡¹
33:    * @returns Observable<QualityCheck[]>
34:    */
35:   findByTaskId(taskId: string, options?: QueryOptions): Observable<QualityCheck[]> {
36:     return this.findAll({
37:       ...options,
38:       filters: {
39:         ...options?.filters,
40:         taskId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º task_id
41:       },
42:       orderBy: 'checked_at',
43:       orderDirection: 'desc'
44:     });
45:   }
46: 
47:   /**
48:    * æ ¹æ®æ£€æŸ¥å‘˜ ID æŸ¥è¯¢å“è´¨æ£€æŸ¥
49:    *
50:    * @param inspectorId æ£€æŸ¥å‘˜ ID
51:    * @param options æŸ¥è¯¢é€‰é¡¹
52:    * @returns Observable<QualityCheck[]>
53:    */
54:   findByInspectorId(inspectorId: string, options?: QueryOptions): Observable<QualityCheck[]> {
55:     return this.findAll({
56:       ...options,
57:       filters: {
58:         ...options?.filters,
59:         inspectorId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º inspector_id
60:       },
61:       orderBy: 'checked_at',
62:       orderDirection: 'desc'
63:     });
64:   }
65: 
66:   /**
67:    * æ ¹æ®çŠ¶æ€æŸ¥è¯¢å“è´¨æ£€æŸ¥
68:    *
69:    * @param status çŠ¶æ€
70:    * @param options æŸ¥è¯¢é€‰é¡¹
71:    * @returns Observable<QualityCheck[]>
72:    */
73:   findByStatus(status: string, options?: QueryOptions): Observable<QualityCheck[]> {
74:     return this.findAll({
75:       ...options,
76:       filters: {
77:         ...options?.filters,
78:         status
79:       },
80:       orderBy: 'checked_at',
81:       orderDirection: 'desc'
82:     });
83:   }
84: }
````

## File: src/app/core/infra/repositories/role-permission.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: import { map } from 'rxjs/operators';
 4: 
 5: import { BaseRepository, QueryOptions } from './base.repository';
 6: import { Database } from '../types/database.types';
 7: 
 8: /**
 9:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
10:  */
11: type RolePermissionRow = Database['public']['Tables']['role_permissions']['Row'];
12: type RolePermissionInsert = Database['public']['Tables']['role_permissions']['Insert'];
13: type RolePermissionUpdate = Database['public']['Tables']['role_permissions']['Update'];
14: 
15: /**
16:  * RolePermission å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
17:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
18:  */
19: export type RolePermission = RolePermissionRow;
20: export type { RolePermissionInsert, RolePermissionUpdate };
21: 
22: /**
23:  * RolePermission Repository
24:  *
25:  * æä¾›è§’è‰²æƒé™å…³è”ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
26:  *
27:  * @example
28:  * ```typescript
29:  * const rolePermissionRepo = inject(RolePermissionRepository);
30:  * rolePermissionRepo.findByRoleId('role-id').subscribe(rolePermissions => {
31:  *   console.log('Role permissions:', rolePermissions);
32:  * });
33:  * ```
34:  */
35: @Injectable({
36:   providedIn: 'root'
37: })
38: export class RolePermissionRepository extends BaseRepository<RolePermission, RolePermissionInsert, RolePermissionUpdate> {
39:   protected tableName = 'role_permissions';
40: 
41:   /**
42:    * æ ¹æ®è§’è‰² ID æŸ¥è¯¢è§’è‰²æƒé™å…³è”
43:    *
44:    * @param roleId è§’è‰² ID
45:    * @param options æŸ¥è¯¢é€‰é¡¹
46:    * @returns Observable<RolePermission[]>
47:    */
48:   findByRoleId(roleId: string, options?: QueryOptions): Observable<RolePermission[]> {
49:     return this.findAll({
50:       ...options,
51:       filters: {
52:         ...options?.filters,
53:         roleId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º role_id
54:       }
55:     });
56:   }
57: 
58:   /**
59:    * æ ¹æ®æƒé™ ID æŸ¥è¯¢è§’è‰²æƒé™å…³è”
60:    *
61:    * @param permissionId æƒé™ ID
62:    * @param options æŸ¥è¯¢é€‰é¡¹
63:    * @returns Observable<RolePermission[]>
64:    */
65:   findByPermissionId(permissionId: string, options?: QueryOptions): Observable<RolePermission[]> {
66:     return this.findAll({
67:       ...options,
68:       filters: {
69:         ...options?.filters,
70:         permissionId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º permission_id
71:       }
72:     });
73:   }
74: 
75:   /**
76:    * æŸ¥è¯¢è§’è‰²æƒé™å…³è”
77:    *
78:    * @param roleId è§’è‰² ID
79:    * @param permissionId æƒé™ ID
80:    * @returns Observable<RolePermission | null>
81:    */
82:   findByRoleAndPermission(roleId: string, permissionId: string): Observable<RolePermission | null> {
83:     return this.findAll({
84:       filters: {
85:         roleId,
86:         permissionId
87:       }
88:     }).pipe(map(rolePermissions => (rolePermissions.length > 0 ? rolePermissions[0] : null)));
89:   }
90: }
````

## File: src/app/core/infra/repositories/role.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable, from } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: import { toCamelCaseData } from '../utils/transformers';
  8: 
  9: /**
 10:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 11:  */
 12: type RoleRow = Database['public']['Tables']['roles']['Row'];
 13: type RoleInsert = Database['public']['Tables']['roles']['Insert'];
 14: type RoleUpdate = Database['public']['Tables']['roles']['Update'];
 15: 
 16: /**
 17:  * Role å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 18:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 19:  * æ³¨æ„ï¼šæ­¤ç±»å‹ä¸ core/permissions/types.ts ä¸­çš„ Role æ¥å£ä¸åŒï¼Œæ­¤ç±»å‹ç”¨äºæ•°æ®è®¿é—®å±‚
 20:  */
 21: // æ³¨æ„ï¼šä¸å¯¼å‡º Role ç±»å‹ï¼Œé¿å…ä¸ core/permissions/types.ts ä¸­çš„ Role æ¥å£å†²çª
 22: // å¦‚æœéœ€è¦ä½¿ç”¨æ­¤ç±»å‹ï¼Œè¯·ä½¿ç”¨ RoleEntity æˆ–ç›´æ¥ä» Repository æ–¹æ³•è¿”å›ç±»å‹æ¨æ–­
 23: type RoleEntity = RoleRow;
 24: export type { RoleInsert, RoleUpdate };
 25: 
 26: /**
 27:  * Role Repository
 28:  *
 29:  * æä¾›è§’è‰²ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 30:  *
 31:  * @example
 32:  * ```typescript
 33:  * const roleRepo = inject(RoleRepository);
 34:  * roleRepo.findByName('admin').subscribe(role => {
 35:  *   console.log('Role:', role);
 36:  * });
 37:  * ```
 38:  */
 39: @Injectable({
 40:   providedIn: 'root'
 41: })
 42: export class RoleRepository extends BaseRepository<RoleEntity, RoleInsert, RoleUpdate> {
 43:   protected tableName = 'roles';
 44: 
 45:   /**
 46:    * æ ¹æ®åç§°æŸ¥è¯¢è§’è‰²
 47:    *
 48:    * @param name è§’è‰²åç§°
 49:    * @returns Observable<Role | null>
 50:    */
 51:   findByName(name: string): Observable<RoleEntity | null> {
 52:     return this.findAll({
 53:       filters: {
 54:         name
 55:       }
 56:     }).pipe(map(roles => (roles.length > 0 ? roles[0] : null)));
 57:   }
 58: 
 59:   /**
 60:    * æŸ¥è¯¢ç³»ç»Ÿè§’è‰²
 61:    *
 62:    * @param options æŸ¥è¯¢é€‰é¡¹
 63:    * @returns Observable<Role[]>
 64:    */
 65:   findSystemRoles(options?: QueryOptions): Observable<RoleEntity[]> {
 66:     return this.findAll({
 67:       ...options,
 68:       filters: {
 69:         ...options?.filters,
 70:         isSystemRole: true // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º is_system_role
 71:       }
 72:     });
 73:   }
 74: 
 75:   /**
 76:    * æŸ¥è¯¢è‡ªå®šä¹‰è§’è‰²
 77:    *
 78:    * @param options æŸ¥è¯¢é€‰é¡¹
 79:    * @returns Observable<Role[]>
 80:    */
 81:   findCustomRoles(options?: QueryOptions): Observable<RoleEntity[]> {
 82:     // è‡ªå®šä¹‰è§’è‰²ï¼šis_system_role = false æˆ– null
 83:     // ç”±äº BaseRepository çš„ filters åªæ”¯æŒç­‰å€¼æŸ¥è¯¢ï¼Œè¿™é‡Œéœ€è¦ç‰¹æ®Šå¤„ç†
 84:     // ä½¿ç”¨ Supabase client ç›´æ¥æŸ¥è¯¢
 85:     let query: any = this.supabase
 86:       .from(this.tableName as any)
 87:       .select('*')
 88:       .or('is_system_role.is.null,is_system_role.eq.false');
 89: 
 90:     // åº”ç”¨æ’åº
 91:     if (options?.orderBy) {
 92:       const snakeOrderBy = options.orderBy.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);
 93:       query = query.order(snakeOrderBy, { ascending: options.orderDirection !== 'desc' });
 94:     }
 95: 
 96:     // åº”ç”¨åˆ†é¡µ
 97:     if (options?.page && options?.pageSize) {
 98:       const fromIndex = (options.page - 1) * options.pageSize;
 99:       const toIndex = fromIndex + options.pageSize - 1;
100:       query = query.range(fromIndex, toIndex);
101:     }
102: 
103:     return from(Promise.resolve(query) as Promise<{ data: any[] | null; error: any }>).pipe(
104:       map((response: { data: any[] | null; error: any }) => {
105:         if (response.error) {
106:           throw new Error(response.error.message || 'æŸ¥è¯¢è‡ªå®šä¹‰è§’è‰²å¤±è´¥');
107:         }
108:         return (response.data || []).map(item => toCamelCaseData<RoleEntity>(item));
109:       })
110:     );
111:   }
112: }
````

## File: src/app/core/infra/repositories/setting.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: 
  8: /**
  9:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 10:  */
 11: type SettingRow = Database['public']['Tables']['settings']['Row'];
 12: type SettingInsert = Database['public']['Tables']['settings']['Insert'];
 13: type SettingUpdate = Database['public']['Tables']['settings']['Update'];
 14: 
 15: /**
 16:  * Setting å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 17:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 18:  */
 19: export type Setting = SettingRow;
 20: export type { SettingInsert, SettingUpdate };
 21: 
 22: /**
 23:  * Setting Repository
 24:  *
 25:  * æä¾›ç³»ç»Ÿè®¾ç½®ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 26:  *
 27:  * @example
 28:  * ```typescript
 29:  * const settingRepo = inject(SettingRepository);
 30:  * settingRepo.findByKey('theme').subscribe(setting => {
 31:  *   console.log('Setting:', setting);
 32:  * });
 33:  * ```
 34:  */
 35: @Injectable({
 36:   providedIn: 'root'
 37: })
 38: export class SettingRepository extends BaseRepository<Setting, SettingInsert, SettingUpdate> {
 39:   protected tableName = 'settings';
 40: 
 41:   /**
 42:    * æ ¹æ®é”®æŸ¥è¯¢è®¾ç½®
 43:    *
 44:    * @param settingKey è®¾ç½®é”®
 45:    * @returns Observable<Setting | null>
 46:    */
 47:   findByKey(settingKey: string): Observable<Setting | null> {
 48:     return this.findAll({
 49:       filters: {
 50:         settingKey // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º setting_key
 51:       }
 52:     }).pipe(map(settings => (settings.length > 0 ? settings[0] : null)));
 53:   }
 54: 
 55:   /**
 56:    * æ ¹æ®ç±»å‹æŸ¥è¯¢è®¾ç½®
 57:    *
 58:    * @param settingType è®¾ç½®ç±»å‹
 59:    * @param options æŸ¥è¯¢é€‰é¡¹
 60:    * @returns Observable<Setting[]>
 61:    */
 62:   findByType(settingType: string, options?: QueryOptions): Observable<Setting[]> {
 63:     return this.findAll({
 64:       ...options,
 65:       filters: {
 66:         ...options?.filters,
 67:         settingType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º setting_type
 68:       }
 69:     });
 70:   }
 71: 
 72:   /**
 73:    * æ ¹æ®ä½œç”¨åŸŸ ID æŸ¥è¯¢è®¾ç½®
 74:    *
 75:    * @param scopeId ä½œç”¨åŸŸ ID
 76:    * @param options æŸ¥è¯¢é€‰é¡¹
 77:    * @returns Observable<Setting[]>
 78:    */
 79:   findByScopeId(scopeId: string, options?: QueryOptions): Observable<Setting[]> {
 80:     return this.findAll({
 81:       ...options,
 82:       filters: {
 83:         ...options?.filters,
 84:         scopeId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º scope_id
 85:       }
 86:     });
 87:   }
 88: 
 89:   /**
 90:    * æŸ¥è¯¢å…¬å¼€è®¾ç½®
 91:    *
 92:    * @param options æŸ¥è¯¢é€‰é¡¹
 93:    * @returns Observable<Setting[]>
 94:    */
 95:   findPublicSettings(options?: QueryOptions): Observable<Setting[]> {
 96:     return this.findAll({
 97:       ...options,
 98:       filters: {
 99:         ...options?.filters,
100:         isPublic: true // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º is_public
101:       }
102:     });
103:   }
104: 
105:   /**
106:    * æ ¹æ®ç±»å‹å’Œä½œç”¨åŸŸæŸ¥è¯¢è®¾ç½®
107:    *
108:    * @param settingType è®¾ç½®ç±»å‹
109:    * @param scopeId ä½œç”¨åŸŸ ID
110:    * @returns Observable<Setting[]>
111:    */
112:   findByTypeAndScope(settingType: string, scopeId: string): Observable<Setting[]> {
113:     return this.findAll({
114:       filters: {
115:         settingType,
116:         scopeId
117:       }
118:     });
119:   }
120: }
````

## File: src/app/core/infra/repositories/team.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: 
 4: import { Database } from '../types/database.types';
 5: import { BaseRepository, QueryOptions } from './base.repository';
 6: 
 7: /**
 8:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 9:  */
10: type TeamRow = Database['public']['Tables']['teams']['Row'];
11: type TeamInsert = Database['public']['Tables']['teams']['Insert'];
12: type TeamUpdate = Database['public']['Tables']['teams']['Update'];
13: 
14: /**
15:  * Team å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
16:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
17:  */
18: export type Team = TeamRow;
19: export type { TeamInsert, TeamUpdate };
20: 
21: /**
22:  * Team Repository
23:  *
24:  * æä¾›å›¢é˜Ÿç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
25:  * RLS ç­–ç•¥å·²å¤„ç†æ‰€æœ‰æƒé™æ£€æŸ¥ï¼Œæ— éœ€é¢å¤–é€»è¾‘
26:  */
27: @Injectable({
28:   providedIn: 'root'
29: })
30: export class TeamRepository extends BaseRepository<Team, TeamInsert, TeamUpdate> {
31:   protected tableName = 'teams';
32: 
33:   /**
34:    * æ ¹æ®ç»„ç»‡ ID æŸ¥è¯¢å›¢é˜Ÿåˆ—è¡¨
35:    */
36:   findByOrganizationId(organizationId: string, options?: QueryOptions): Observable<Team[]> {
37:     return this.findAll({
38:       ...options,
39:       filters: {
40:         ...options?.filters,
41:         organizationId
42:       }
43:     });
44:   }
45: }
````

## File: src/app/core/infra/repositories/todo-status-tracking.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: 
 4: import { BaseRepository, QueryOptions } from './base.repository';
 5: import { Database } from '../types/database.types';
 6: 
 7: /**
 8:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 9:  */
10: type TodoStatusTrackingRow = Database['public']['Tables']['todo_status_tracking']['Row'];
11: type TodoStatusTrackingInsert = Database['public']['Tables']['todo_status_tracking']['Insert'];
12: type TodoStatusTrackingUpdate = Database['public']['Tables']['todo_status_tracking']['Update'];
13: 
14: /**
15:  * TodoStatusTracking å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
16:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
17:  */
18: export type TodoStatusTracking = TodoStatusTrackingRow;
19: export type { TodoStatusTrackingInsert, TodoStatusTrackingUpdate };
20: 
21: /**
22:  * TodoStatusTracking Repository
23:  *
24:  * æä¾›å¾…åŠçŠ¶æ€è¿½è¸ªç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
25:  *
26:  * @example
27:  * ```typescript
28:  * const trackingRepo = inject(TodoStatusTrackingRepository);
29:  * trackingRepo.findByTodoId('todo-id').subscribe(trackings => {
30:  *   console.log('Status tracking:', trackings);
31:  * });
32:  * ```
33:  */
34: @Injectable({
35:   providedIn: 'root'
36: })
37: export class TodoStatusTrackingRepository extends BaseRepository<TodoStatusTracking, TodoStatusTrackingInsert, TodoStatusTrackingUpdate> {
38:   protected tableName = 'todo_status_tracking';
39: 
40:   /**
41:    * æ ¹æ®å¾…åŠ ID æŸ¥è¯¢çŠ¶æ€è¿½è¸ª
42:    *
43:    * @param todoId å¾…åŠ ID
44:    * @param options æŸ¥è¯¢é€‰é¡¹
45:    * @returns Observable<TodoStatusTracking[]>
46:    */
47:   findByTodoId(todoId: string, options?: QueryOptions): Observable<TodoStatusTracking[]> {
48:     return this.findAll({
49:       ...options,
50:       filters: {
51:         ...options?.filters,
52:         todoId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º todo_id
53:       },
54:       orderBy: 'changedAt', // æŒ‰å˜æ›´æ—¶é—´æ’åº
55:       orderDirection: 'desc'
56:     });
57:   }
58: 
59:   /**
60:    * æ ¹æ®å˜æ›´äºº ID æŸ¥è¯¢çŠ¶æ€è¿½è¸ª
61:    *
62:    * @param changedBy å˜æ›´äºº ID
63:    * @param options æŸ¥è¯¢é€‰é¡¹
64:    * @returns Observable<TodoStatusTracking[]>
65:    */
66:   findByChangedBy(changedBy: string, options?: QueryOptions): Observable<TodoStatusTracking[]> {
67:     return this.findAll({
68:       ...options,
69:       filters: {
70:         ...options?.filters,
71:         changedBy // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º changed_by
72:       },
73:       orderBy: 'changedAt',
74:       orderDirection: 'desc'
75:     });
76:   }
77: 
78:   /**
79:    * æ ¹æ®ç›®æ ‡çŠ¶æ€æŸ¥è¯¢çŠ¶æ€è¿½è¸ª
80:    *
81:    * @param toStatus ç›®æ ‡çŠ¶æ€
82:    * @param options æŸ¥è¯¢é€‰é¡¹
83:    * @returns Observable<TodoStatusTracking[]>
84:    */
85:   findByToStatus(toStatus: string, options?: QueryOptions): Observable<TodoStatusTracking[]> {
86:     return this.findAll({
87:       ...options,
88:       filters: {
89:         ...options?.filters,
90:         toStatus // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º to_status
91:       },
92:       orderBy: 'changedAt',
93:       orderDirection: 'desc'
94:     });
95:   }
96: }
````

## File: src/app/core/infra/repositories/user-role.repository.ts
````typescript
  1: import { Injectable } from '@angular/core';
  2: import { Observable } from 'rxjs';
  3: import { map } from 'rxjs/operators';
  4: 
  5: import { BaseRepository, QueryOptions } from './base.repository';
  6: import { Database } from '../types/database.types';
  7: 
  8: /**
  9:  * ä»æ•°æ®åº“ç±»å‹ä¸­æå–åŸå§‹ç±»å‹ï¼ˆsnake_caseï¼‰
 10:  */
 11: type UserRoleRow = Database['public']['Tables']['user_roles']['Row'];
 12: type UserRoleInsert = Database['public']['Tables']['user_roles']['Insert'];
 13: type UserRoleUpdate = Database['public']['Tables']['user_roles']['Update'];
 14: 
 15: /**
 16:  * UserRole å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 17:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 18:  * æ³¨æ„ï¼šæ­¤ç±»å‹ä¸ core/permissions/types.ts ä¸­çš„ UserRole æ¥å£ä¸åŒï¼Œæ­¤ç±»å‹ç”¨äºæ•°æ®è®¿é—®å±‚
 19:  */
 20: // æ³¨æ„ï¼šä¸å¯¼å‡º UserRole ç±»å‹ï¼Œé¿å…ä¸ core/permissions/types.ts ä¸­çš„ UserRole æ¥å£å†²çª
 21: // å¦‚æœéœ€è¦ä½¿ç”¨æ­¤ç±»å‹ï¼Œè¯·ä½¿ç”¨ UserRoleEntity æˆ–ç›´æ¥ä» Repository æ–¹æ³•è¿”å›ç±»å‹æ¨æ–­
 22: type UserRoleEntity = UserRoleRow;
 23: export type { UserRoleInsert, UserRoleUpdate };
 24: 
 25: /**
 26:  * UserRole Repository
 27:  *
 28:  * æä¾›ç”¨æˆ·è§’è‰²å…³è”ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
 29:  *
 30:  * @example
 31:  * ```typescript
 32:  * const userRoleRepo = inject(UserRoleRepository);
 33:  * userRoleRepo.findByAccountId('account-id').subscribe(userRoles => {
 34:  *   console.log('User roles:', userRoles);
 35:  * });
 36:  * ```
 37:  */
 38: @Injectable({
 39:   providedIn: 'root'
 40: })
 41: export class UserRoleRepository extends BaseRepository<UserRoleEntity, UserRoleInsert, UserRoleUpdate> {
 42:   protected tableName = 'user_roles';
 43: 
 44:   /**
 45:    * æ ¹æ®è´¦æˆ· ID æŸ¥è¯¢ç”¨æˆ·è§’è‰²
 46:    *
 47:    * @param accountId è´¦æˆ· ID
 48:    * @param options æŸ¥è¯¢é€‰é¡¹
 49:    * @returns Observable<UserRole[]>
 50:    */
 51:   findByAccountId(accountId: string, options?: QueryOptions): Observable<UserRoleEntity[]> {
 52:     return this.findAll({
 53:       ...options,
 54:       filters: {
 55:         ...options?.filters,
 56:         accountId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º account_id
 57:       }
 58:     });
 59:   }
 60: 
 61:   /**
 62:    * æ ¹æ®è§’è‰² ID æŸ¥è¯¢ç”¨æˆ·è§’è‰²
 63:    *
 64:    * @param roleId è§’è‰² ID
 65:    * @param options æŸ¥è¯¢é€‰é¡¹
 66:    * @returns Observable<UserRole[]>
 67:    */
 68:   findByRoleId(roleId: string, options?: QueryOptions): Observable<UserRoleEntity[]> {
 69:     return this.findAll({
 70:       ...options,
 71:       filters: {
 72:         ...options?.filters,
 73:         roleId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º role_id
 74:       }
 75:     });
 76:   }
 77: 
 78:   /**
 79:    * æ ¹æ®è“å›¾ ID æŸ¥è¯¢ç”¨æˆ·è§’è‰²
 80:    *
 81:    * @param blueprintId è“å›¾ ID
 82:    * @param options æŸ¥è¯¢é€‰é¡¹
 83:    * @returns Observable<UserRole[]>
 84:    */
 85:   findByBlueprintId(blueprintId: string, options?: QueryOptions): Observable<UserRoleEntity[]> {
 86:     return this.findAll({
 87:       ...options,
 88:       filters: {
 89:         ...options?.filters,
 90:         blueprintId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º blueprint_id
 91:       }
 92:     });
 93:   }
 94: 
 95:   /**
 96:    * æ ¹æ®åˆ†æ”¯ ID æŸ¥è¯¢ç”¨æˆ·è§’è‰²
 97:    *
 98:    * @param branchId åˆ†æ”¯ ID
 99:    * @param options æŸ¥è¯¢é€‰é¡¹
100:    * @returns Observable<UserRole[]>
101:    */
102:   findByBranchId(branchId: string, options?: QueryOptions): Observable<UserRoleEntity[]> {
103:     return this.findAll({
104:       ...options,
105:       filters: {
106:         ...options?.filters,
107:         branchId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º branch_id
108:       }
109:     });
110:   }
111: 
112:   /**
113:    * æŸ¥è¯¢è´¦æˆ·åœ¨è“å›¾ä¸­çš„è§’è‰²
114:    *
115:    * @param accountId è´¦æˆ· ID
116:    * @param blueprintId è“å›¾ ID
117:    * @returns Observable<UserRole | null>
118:    */
119:   findByAccountAndBlueprint(accountId: string, blueprintId: string): Observable<UserRoleEntity | null> {
120:     return this.findAll({
121:       filters: {
122:         accountId,
123:         blueprintId
124:       }
125:     }).pipe(map(userRoles => (userRoles.length > 0 ? userRoles[0] : null)));
126:   }
127: }
````

## File: src/app/core/infra/types/account.types.ts
````typescript
 1: /**
 2:  * è´¦æˆ·ç›¸å…³ç±»å‹å®šä¹‰ï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰
 3:  *
 4:  * è¿™äº›ç±»å‹è¢« Repository å±‚ä½¿ç”¨ï¼Œå› æ­¤æ”¾åœ¨ core å±‚
 5:  * ç¬¦åˆåˆ†å±‚æ¶æ„ï¼šcore ä¸ä¾èµ– shared
 6:  *
 7:  * @module core/infra/types
 8:  */
 9: 
10: /**
11:  * è´¦æˆ·ç±»å‹æšä¸¾
12:  * å¯¹åº”æ•°æ®åº“ accounts.type å­—æ®µ
13:  */
14: export enum AccountType {
15:   /** ç”¨æˆ·è´¦æˆ· */
16:   USER = 'User',
17:   /** æœºå™¨äººè´¦æˆ· */
18:   BOT = 'Bot',
19:   /** ç»„ç»‡è´¦æˆ· */
20:   ORGANIZATION = 'Organization'
21: }
22: 
23: /**
24:  * è´¦æˆ·çŠ¶æ€æšä¸¾
25:  * å¯¹åº”æ•°æ®åº“ accounts.status å­—æ®µ
26:  */
27: export enum AccountStatus {
28:   /** æ´»è·ƒ */
29:   ACTIVE = 'active',
30:   /** éæ´»è·ƒ */
31:   INACTIVE = 'inactive',
32:   /** å·²æš‚åœ */
33:   SUSPENDED = 'suspended'
34: }
35: 
36: /**
37:  * å›¢é˜Ÿæˆå‘˜è§’è‰²æšä¸¾
38:  * å¯¹åº”æ•°æ®åº“ team_members.role å­—æ®µ
39:  */
40: export enum TeamMemberRole {
41:   /** å›¢é˜Ÿè´Ÿè´£äºº */
42:   LEADER = 'leader',
43:   /** å›¢é˜Ÿæˆå‘˜ */
44:   MEMBER = 'member'
45: }
46: 
47: /**
48:  * ç»„ç»‡æˆå‘˜è§’è‰²æšä¸¾
49:  * å¯¹åº”æ•°æ®åº“ organization_members.role å­—æ®µ
50:  */
51: export enum OrganizationMemberRole {
52:   /** ç»„ç»‡æ‹¥æœ‰è€… */
53:   OWNER = 'owner',
54:   /** ç»„ç»‡ç®¡ç†å‘˜ */
55:   ADMIN = 'admin',
56:   /** ç»„ç»‡æˆå‘˜ */
57:   MEMBER = 'member'
58: }
````

## File: src/app/core/infra/types/database.types.ts
````typescript
   1: export type Json = string | number | boolean | null | { [key: string]: Json | undefined } | Json[];
   2: 
   3: export interface Database {
   4:   // Allows to automatically instantiate createClient with right options
   5:   // instead of createClient<Database, { PostgrestVersion: 'XX' }>(URL, KEY)
   6:   __InternalSupabase: {
   7:     PostgrestVersion: '13.0.5';
   8:   };
   9:   public: {
  10:     Tables: {
  11:       accounts: {
  12:         Row: {
  13:           auth_user_id: string | null;
  14:           avatar_url: string | null;
  15:           created_at: string | null;
  16:           email: string | null;
  17:           id: string;
  18:           metadata: Json | null;
  19:           name: string;
  20:           status: string | null;
  21:           type: string;
  22:           updated_at: string | null;
  23:         };
  24:         Insert: {
  25:           auth_user_id?: string | null;
  26:           avatar_url?: string | null;
  27:           created_at?: string | null;
  28:           email?: string | null;
  29:           id?: string;
  30:           metadata?: Json | null;
  31:           name: string;
  32:           status?: string | null;
  33:           type: string;
  34:           updated_at?: string | null;
  35:         };
  36:         Update: {
  37:           auth_user_id?: string | null;
  38:           avatar_url?: string | null;
  39:           created_at?: string | null;
  40:           email?: string | null;
  41:           id?: string;
  42:           metadata?: Json | null;
  43:           name?: string;
  44:           status?: string | null;
  45:           type?: string;
  46:           updated_at?: string | null;
  47:         };
  48:         Relationships: [];
  49:       };
  50:       activity_logs: {
  51:         Row: {
  52:           action: string;
  53:           action_details: Json | null;
  54:           actor_id: string;
  55:           blueprint_id: string;
  56:           branch_id: string | null;
  57:           created_at: string | null;
  58:           id: string;
  59:           ip_address: unknown;
  60:           resource_id: string | null;
  61:           resource_type: string;
  62:           user_agent: string | null;
  63:         };
  64:         Insert: {
  65:           action: string;
  66:           action_details?: Json | null;
  67:           actor_id: string;
  68:           blueprint_id: string;
  69:           branch_id?: string | null;
  70:           created_at?: string | null;
  71:           id?: string;
  72:           ip_address?: unknown;
  73:           resource_id?: string | null;
  74:           resource_type: string;
  75:           user_agent?: string | null;
  76:         };
  77:         Update: {
  78:           action?: string;
  79:           action_details?: Json | null;
  80:           actor_id?: string;
  81:           blueprint_id?: string;
  82:           branch_id?: string | null;
  83:           created_at?: string | null;
  84:           id?: string;
  85:           ip_address?: unknown;
  86:           resource_id?: string | null;
  87:           resource_type?: string;
  88:           user_agent?: string | null;
  89:         };
  90:         Relationships: [
  91:           {
  92:             foreignKeyName: 'activity_logs_actor_id_fkey';
  93:             columns: ['actor_id'];
  94:             isOneToOne: false;
  95:             referencedRelation: 'accounts';
  96:             referencedColumns: ['id'];
  97:           },
  98:           {
  99:             foreignKeyName: 'activity_logs_blueprint_id_fkey';
 100:             columns: ['blueprint_id'];
 101:             isOneToOne: false;
 102:             referencedRelation: 'blueprints';
 103:             referencedColumns: ['id'];
 104:           },
 105:           {
 106:             foreignKeyName: 'activity_logs_branch_id_fkey';
 107:             columns: ['branch_id'];
 108:             isOneToOne: false;
 109:             referencedRelation: 'blueprint_branches';
 110:             referencedColumns: ['id'];
 111:           }
 112:         ];
 113:       };
 114:       analytics_cache: {
 115:         Row: {
 116:           aggregation_level: string | null;
 117:           blueprint_id: string | null;
 118:           branch_id: string | null;
 119:           cache_key: string;
 120:           cache_type: string;
 121:           data: Json;
 122:           expires_at: string;
 123:           generated_at: string | null;
 124:           id: string;
 125:         };
 126:         Insert: {
 127:           aggregation_level?: string | null;
 128:           blueprint_id?: string | null;
 129:           branch_id?: string | null;
 130:           cache_key: string;
 131:           cache_type: string;
 132:           data: Json;
 133:           expires_at: string;
 134:           generated_at?: string | null;
 135:           id?: string;
 136:         };
 137:         Update: {
 138:           aggregation_level?: string | null;
 139:           blueprint_id?: string | null;
 140:           branch_id?: string | null;
 141:           cache_key?: string;
 142:           cache_type?: string;
 143:           data?: Json;
 144:           expires_at?: string;
 145:           generated_at?: string | null;
 146:           id?: string;
 147:         };
 148:         Relationships: [
 149:           {
 150:             foreignKeyName: 'analytics_cache_blueprint_id_fkey';
 151:             columns: ['blueprint_id'];
 152:             isOneToOne: false;
 153:             referencedRelation: 'blueprints';
 154:             referencedColumns: ['id'];
 155:           },
 156:           {
 157:             foreignKeyName: 'analytics_cache_branch_id_fkey';
 158:             columns: ['branch_id'];
 159:             isOneToOne: false;
 160:             referencedRelation: 'blueprint_branches';
 161:             referencedColumns: ['id'];
 162:           }
 163:         ];
 164:       };
 165:       blueprint_branches: {
 166:         Row: {
 167:           blueprint_id: string;
 168:           branch_name: string;
 169:           branch_type: string | null;
 170:           forked_at: string | null;
 171:           id: string;
 172:           last_sync_at: string | null;
 173:           notes: string | null;
 174:           organization_id: string;
 175:           status: string | null;
 176:         };
 177:         Insert: {
 178:           blueprint_id: string;
 179:           branch_name: string;
 180:           branch_type?: string | null;
 181:           forked_at?: string | null;
 182:           id?: string;
 183:           last_sync_at?: string | null;
 184:           notes?: string | null;
 185:           organization_id: string;
 186:           status?: string | null;
 187:         };
 188:         Update: {
 189:           blueprint_id?: string;
 190:           branch_name?: string;
 191:           branch_type?: string | null;
 192:           forked_at?: string | null;
 193:           id?: string;
 194:           last_sync_at?: string | null;
 195:           notes?: string | null;
 196:           organization_id?: string;
 197:           status?: string | null;
 198:         };
 199:         Relationships: [
 200:           {
 201:             foreignKeyName: 'blueprint_branches_blueprint_id_fkey';
 202:             columns: ['blueprint_id'];
 203:             isOneToOne: false;
 204:             referencedRelation: 'blueprints';
 205:             referencedColumns: ['id'];
 206:           },
 207:           {
 208:             foreignKeyName: 'blueprint_branches_organization_id_fkey';
 209:             columns: ['organization_id'];
 210:             isOneToOne: false;
 211:             referencedRelation: 'accounts';
 212:             referencedColumns: ['id'];
 213:           }
 214:         ];
 215:       };
 216:       blueprint_configs: {
 217:         Row: {
 218:           blueprint_id: string;
 219:           config_key: string;
 220:           config_value: Json;
 221:           id: string;
 222:           updated_at: string | null;
 223:           updated_by: string | null;
 224:         };
 225:         Insert: {
 226:           blueprint_id: string;
 227:           config_key: string;
 228:           config_value: Json;
 229:           id?: string;
 230:           updated_at?: string | null;
 231:           updated_by?: string | null;
 232:         };
 233:         Update: {
 234:           blueprint_id?: string;
 235:           config_key?: string;
 236:           config_value?: Json;
 237:           id?: string;
 238:           updated_at?: string | null;
 239:           updated_by?: string | null;
 240:         };
 241:         Relationships: [
 242:           {
 243:             foreignKeyName: 'blueprint_configs_blueprint_id_fkey';
 244:             columns: ['blueprint_id'];
 245:             isOneToOne: false;
 246:             referencedRelation: 'blueprints';
 247:             referencedColumns: ['id'];
 248:           },
 249:           {
 250:             foreignKeyName: 'blueprint_configs_updated_by_fkey';
 251:             columns: ['updated_by'];
 252:             isOneToOne: false;
 253:             referencedRelation: 'accounts';
 254:             referencedColumns: ['id'];
 255:           }
 256:         ];
 257:       };
 258:       blueprints: {
 259:         Row: {
 260:           budget: number | null;
 261:           created_at: string | null;
 262:           description: string | null;
 263:           end_date: string | null;
 264:           id: string;
 265:           location: string | null;
 266:           metadata: Json | null;
 267:           name: string;
 268:           owner_id: string;
 269:           project_code: string | null;
 270:           start_date: string | null;
 271:           status: string | null;
 272:           updated_at: string | null;
 273:         };
 274:         Insert: {
 275:           budget?: number | null;
 276:           created_at?: string | null;
 277:           description?: string | null;
 278:           end_date?: string | null;
 279:           id?: string;
 280:           location?: string | null;
 281:           metadata?: Json | null;
 282:           name: string;
 283:           owner_id: string;
 284:           project_code?: string | null;
 285:           start_date?: string | null;
 286:           status?: string | null;
 287:           updated_at?: string | null;
 288:         };
 289:         Update: {
 290:           budget?: number | null;
 291:           created_at?: string | null;
 292:           description?: string | null;
 293:           end_date?: string | null;
 294:           id?: string;
 295:           location?: string | null;
 296:           metadata?: Json | null;
 297:           name?: string;
 298:           owner_id?: string;
 299:           project_code?: string | null;
 300:           start_date?: string | null;
 301:           status?: string | null;
 302:           updated_at?: string | null;
 303:         };
 304:         Relationships: [
 305:           {
 306:             foreignKeyName: 'blueprints_owner_id_fkey';
 307:             columns: ['owner_id'];
 308:             isOneToOne: false;
 309:             referencedRelation: 'accounts';
 310:             referencedColumns: ['id'];
 311:           }
 312:         ];
 313:       };
 314:       bot_execution_logs: {
 315:         Row: {
 316:           bot_id: string;
 317:           bot_task_id: string | null;
 318:           error_logs: Json | null;
 319:           executed_at: string | null;
 320:           execution_details: Json | null;
 321:           execution_duration_ms: number | null;
 322:           execution_status: string;
 323:           id: string;
 324:           items_failed: number | null;
 325:           items_processed: number | null;
 326:         };
 327:         Insert: {
 328:           bot_id: string;
 329:           bot_task_id?: string | null;
 330:           error_logs?: Json | null;
 331:           executed_at?: string | null;
 332:           execution_details?: Json | null;
 333:           execution_duration_ms?: number | null;
 334:           execution_status: string;
 335:           id?: string;
 336:           items_failed?: number | null;
 337:           items_processed?: number | null;
 338:         };
 339:         Update: {
 340:           bot_id?: string;
 341:           bot_task_id?: string | null;
 342:           error_logs?: Json | null;
 343:           executed_at?: string | null;
 344:           execution_details?: Json | null;
 345:           execution_duration_ms?: number | null;
 346:           execution_status?: string;
 347:           id?: string;
 348:           items_failed?: number | null;
 349:           items_processed?: number | null;
 350:         };
 351:         Relationships: [
 352:           {
 353:             foreignKeyName: 'bot_execution_logs_bot_id_fkey';
 354:             columns: ['bot_id'];
 355:             isOneToOne: false;
 356:             referencedRelation: 'bots';
 357:             referencedColumns: ['id'];
 358:           },
 359:           {
 360:             foreignKeyName: 'bot_execution_logs_bot_task_id_fkey';
 361:             columns: ['bot_task_id'];
 362:             isOneToOne: false;
 363:             referencedRelation: 'bot_tasks';
 364:             referencedColumns: ['id'];
 365:           }
 366:         ];
 367:       };
 368:       bot_tasks: {
 369:         Row: {
 370:           bot_id: string;
 371:           completed_at: string | null;
 372:           created_at: string | null;
 373:           error_message: string | null;
 374:           id: string;
 375:           max_retries: number | null;
 376:           priority: number | null;
 377:           retry_count: number | null;
 378:           scheduled_at: string | null;
 379:           started_at: string | null;
 380:           status: string | null;
 381:           task_config: Json;
 382:           task_type: string;
 383:         };
 384:         Insert: {
 385:           bot_id: string;
 386:           completed_at?: string | null;
 387:           created_at?: string | null;
 388:           error_message?: string | null;
 389:           id?: string;
 390:           max_retries?: number | null;
 391:           priority?: number | null;
 392:           retry_count?: number | null;
 393:           scheduled_at?: string | null;
 394:           started_at?: string | null;
 395:           status?: string | null;
 396:           task_config: Json;
 397:           task_type: string;
 398:         };
 399:         Update: {
 400:           bot_id?: string;
 401:           completed_at?: string | null;
 402:           created_at?: string | null;
 403:           error_message?: string | null;
 404:           id?: string;
 405:           max_retries?: number | null;
 406:           priority?: number | null;
 407:           retry_count?: number | null;
 408:           scheduled_at?: string | null;
 409:           started_at?: string | null;
 410:           status?: string | null;
 411:           task_config?: Json;
 412:           task_type?: string;
 413:         };
 414:         Relationships: [
 415:           {
 416:             foreignKeyName: 'bot_tasks_bot_id_fkey';
 417:             columns: ['bot_id'];
 418:             isOneToOne: false;
 419:             referencedRelation: 'bots';
 420:             referencedColumns: ['id'];
 421:           }
 422:         ];
 423:       };
 424:       bots: {
 425:         Row: {
 426:           account_id: string;
 427:           bot_type: string;
 428:           config: Json;
 429:           created_at: string | null;
 430:           created_by: string;
 431:           description: string | null;
 432:           id: string;
 433:           is_enabled: boolean | null;
 434:           name: string;
 435:           updated_at: string | null;
 436:         };
 437:         Insert: {
 438:           account_id: string;
 439:           bot_type: string;
 440:           config: Json;
 441:           created_at?: string | null;
 442:           created_by: string;
 443:           description?: string | null;
 444:           id?: string;
 445:           is_enabled?: boolean | null;
 446:           name: string;
 447:           updated_at?: string | null;
 448:         };
 449:         Update: {
 450:           account_id?: string;
 451:           bot_type?: string;
 452:           config?: Json;
 453:           created_at?: string | null;
 454:           created_by?: string;
 455:           description?: string | null;
 456:           id?: string;
 457:           is_enabled?: boolean | null;
 458:           name?: string;
 459:           updated_at?: string | null;
 460:         };
 461:         Relationships: [
 462:           {
 463:             foreignKeyName: 'bots_account_id_fkey';
 464:             columns: ['account_id'];
 465:             isOneToOne: false;
 466:             referencedRelation: 'accounts';
 467:             referencedColumns: ['id'];
 468:           },
 469:           {
 470:             foreignKeyName: 'bots_created_by_fkey';
 471:             columns: ['created_by'];
 472:             isOneToOne: false;
 473:             referencedRelation: 'accounts';
 474:             referencedColumns: ['id'];
 475:           }
 476:         ];
 477:       };
 478:       branch_forks: {
 479:         Row: {
 480:           blueprint_id: string;
 481:           branch_id: string;
 482:           fork_reason: string | null;
 483:           forked_at: string | null;
 484:           forked_by: string;
 485:           forked_from_task_id: string | null;
 486:           id: string;
 487:         };
 488:         Insert: {
 489:           blueprint_id: string;
 490:           branch_id: string;
 491:           fork_reason?: string | null;
 492:           forked_at?: string | null;
 493:           forked_by: string;
 494:           forked_from_task_id?: string | null;
 495:           id?: string;
 496:         };
 497:         Update: {
 498:           blueprint_id?: string;
 499:           branch_id?: string;
 500:           fork_reason?: string | null;
 501:           forked_at?: string | null;
 502:           forked_by?: string;
 503:           forked_from_task_id?: string | null;
 504:           id?: string;
 505:         };
 506:         Relationships: [
 507:           {
 508:             foreignKeyName: 'branch_forks_blueprint_id_fkey';
 509:             columns: ['blueprint_id'];
 510:             isOneToOne: false;
 511:             referencedRelation: 'blueprints';
 512:             referencedColumns: ['id'];
 513:           },
 514:           {
 515:             foreignKeyName: 'branch_forks_branch_id_fkey';
 516:             columns: ['branch_id'];
 517:             isOneToOne: false;
 518:             referencedRelation: 'blueprint_branches';
 519:             referencedColumns: ['id'];
 520:           },
 521:           {
 522:             foreignKeyName: 'branch_forks_forked_by_fkey';
 523:             columns: ['forked_by'];
 524:             isOneToOne: false;
 525:             referencedRelation: 'accounts';
 526:             referencedColumns: ['id'];
 527:           },
 528:           {
 529:             foreignKeyName: 'branch_forks_forked_from_task_id_fkey';
 530:             columns: ['forked_from_task_id'];
 531:             isOneToOne: false;
 532:             referencedRelation: 'tasks';
 533:             referencedColumns: ['id'];
 534:           }
 535:         ];
 536:       };
 537:       branch_permissions: {
 538:         Row: {
 539:           account_id: string;
 540:           branch_id: string;
 541:           granted_at: string | null;
 542:           granted_by: string;
 543:           id: string;
 544:           permission_level: string;
 545:         };
 546:         Insert: {
 547:           account_id: string;
 548:           branch_id: string;
 549:           granted_at?: string | null;
 550:           granted_by: string;
 551:           id?: string;
 552:           permission_level: string;
 553:         };
 554:         Update: {
 555:           account_id?: string;
 556:           branch_id?: string;
 557:           granted_at?: string | null;
 558:           granted_by?: string;
 559:           id?: string;
 560:           permission_level?: string;
 561:         };
 562:         Relationships: [
 563:           {
 564:             foreignKeyName: 'branch_permissions_account_id_fkey';
 565:             columns: ['account_id'];
 566:             isOneToOne: false;
 567:             referencedRelation: 'accounts';
 568:             referencedColumns: ['id'];
 569:           },
 570:           {
 571:             foreignKeyName: 'branch_permissions_branch_id_fkey';
 572:             columns: ['branch_id'];
 573:             isOneToOne: false;
 574:             referencedRelation: 'blueprint_branches';
 575:             referencedColumns: ['id'];
 576:           },
 577:           {
 578:             foreignKeyName: 'branch_permissions_granted_by_fkey';
 579:             columns: ['granted_by'];
 580:             isOneToOne: false;
 581:             referencedRelation: 'accounts';
 582:             referencedColumns: ['id'];
 583:           }
 584:         ];
 585:       };
 586:       collaboration_invitations: {
 587:         Row: {
 588:           blueprint_id: string;
 589:           created_at: string | null;
 590:           expires_at: string;
 591:           from_org_id: string;
 592:           id: string;
 593:           invitation_message: string | null;
 594:           responded_at: string | null;
 595:           status: string | null;
 596:           to_org_id: string;
 597:         };
 598:         Insert: {
 599:           blueprint_id: string;
 600:           created_at?: string | null;
 601:           expires_at: string;
 602:           from_org_id: string;
 603:           id?: string;
 604:           invitation_message?: string | null;
 605:           responded_at?: string | null;
 606:           status?: string | null;
 607:           to_org_id: string;
 608:         };
 609:         Update: {
 610:           blueprint_id?: string;
 611:           created_at?: string | null;
 612:           expires_at?: string;
 613:           from_org_id?: string;
 614:           id?: string;
 615:           invitation_message?: string | null;
 616:           responded_at?: string | null;
 617:           status?: string | null;
 618:           to_org_id?: string;
 619:         };
 620:         Relationships: [
 621:           {
 622:             foreignKeyName: 'collaboration_invitations_blueprint_id_fkey';
 623:             columns: ['blueprint_id'];
 624:             isOneToOne: false;
 625:             referencedRelation: 'blueprints';
 626:             referencedColumns: ['id'];
 627:           },
 628:           {
 629:             foreignKeyName: 'collaboration_invitations_from_org_id_fkey';
 630:             columns: ['from_org_id'];
 631:             isOneToOne: false;
 632:             referencedRelation: 'accounts';
 633:             referencedColumns: ['id'];
 634:           },
 635:           {
 636:             foreignKeyName: 'collaboration_invitations_to_org_id_fkey';
 637:             columns: ['to_org_id'];
 638:             isOneToOne: false;
 639:             referencedRelation: 'accounts';
 640:             referencedColumns: ['id'];
 641:           }
 642:         ];
 643:       };
 644:       collaboration_members: {
 645:         Row: {
 646:           account_id: string;
 647:           collaboration_id: string;
 648:           id: string;
 649:           joined_at: string | null;
 650:           permissions: Json | null;
 651:           role: string | null;
 652:         };
 653:         Insert: {
 654:           account_id: string;
 655:           collaboration_id: string;
 656:           id?: string;
 657:           joined_at?: string | null;
 658:           permissions?: Json | null;
 659:           role?: string | null;
 660:         };
 661:         Update: {
 662:           account_id?: string;
 663:           collaboration_id?: string;
 664:           id?: string;
 665:           joined_at?: string | null;
 666:           permissions?: Json | null;
 667:           role?: string | null;
 668:         };
 669:         Relationships: [
 670:           {
 671:             foreignKeyName: 'collaboration_members_account_id_fkey';
 672:             columns: ['account_id'];
 673:             isOneToOne: false;
 674:             referencedRelation: 'accounts';
 675:             referencedColumns: ['id'];
 676:           },
 677:           {
 678:             foreignKeyName: 'collaboration_members_collaboration_id_fkey';
 679:             columns: ['collaboration_id'];
 680:             isOneToOne: false;
 681:             referencedRelation: 'organization_collaborations';
 682:             referencedColumns: ['id'];
 683:           }
 684:         ];
 685:       };
 686:       comments: {
 687:         Row: {
 688:           attachments: Json | null;
 689:           author_id: string;
 690:           commentable_id: string;
 691:           commentable_type: string;
 692:           content: string;
 693:           created_at: string | null;
 694:           edited_at: string | null;
 695:           id: string;
 696:           is_edited: boolean | null;
 697:           mentions: Json | null;
 698:           parent_comment_id: string | null;
 699:         };
 700:         Insert: {
 701:           attachments?: Json | null;
 702:           author_id: string;
 703:           commentable_id: string;
 704:           commentable_type: string;
 705:           content: string;
 706:           created_at?: string | null;
 707:           edited_at?: string | null;
 708:           id?: string;
 709:           is_edited?: boolean | null;
 710:           mentions?: Json | null;
 711:           parent_comment_id?: string | null;
 712:         };
 713:         Update: {
 714:           attachments?: Json | null;
 715:           author_id?: string;
 716:           commentable_id?: string;
 717:           commentable_type?: string;
 718:           content?: string;
 719:           created_at?: string | null;
 720:           edited_at?: string | null;
 721:           id?: string;
 722:           is_edited?: boolean | null;
 723:           mentions?: Json | null;
 724:           parent_comment_id?: string | null;
 725:         };
 726:         Relationships: [
 727:           {
 728:             foreignKeyName: 'comments_author_id_fkey';
 729:             columns: ['author_id'];
 730:             isOneToOne: false;
 731:             referencedRelation: 'accounts';
 732:             referencedColumns: ['id'];
 733:           },
 734:           {
 735:             foreignKeyName: 'comments_parent_comment_id_fkey';
 736:             columns: ['parent_comment_id'];
 737:             isOneToOne: false;
 738:             referencedRelation: 'comments';
 739:             referencedColumns: ['id'];
 740:           }
 741:         ];
 742:       };
 743:       daily_reports: {
 744:         Row: {
 745:           blueprint_id: string;
 746:           branch_id: string | null;
 747:           created_at: string | null;
 748:           equipment_used: string | null;
 749:           id: string;
 750:           issues_encountered: string | null;
 751:           materials_used: string | null;
 752:           progress_notes: string | null;
 753:           report_date: string;
 754:           reported_by: string;
 755:           task_id: string;
 756:           updated_at: string | null;
 757:           weather_info: Json | null;
 758:           work_description: string;
 759:           worker_count: number | null;
 760:         };
 761:         Insert: {
 762:           blueprint_id: string;
 763:           branch_id?: string | null;
 764:           created_at?: string | null;
 765:           equipment_used?: string | null;
 766:           id?: string;
 767:           issues_encountered?: string | null;
 768:           materials_used?: string | null;
 769:           progress_notes?: string | null;
 770:           report_date: string;
 771:           reported_by: string;
 772:           task_id: string;
 773:           updated_at?: string | null;
 774:           weather_info?: Json | null;
 775:           work_description: string;
 776:           worker_count?: number | null;
 777:         };
 778:         Update: {
 779:           blueprint_id?: string;
 780:           branch_id?: string | null;
 781:           created_at?: string | null;
 782:           equipment_used?: string | null;
 783:           id?: string;
 784:           issues_encountered?: string | null;
 785:           materials_used?: string | null;
 786:           progress_notes?: string | null;
 787:           report_date?: string;
 788:           reported_by?: string;
 789:           task_id?: string;
 790:           updated_at?: string | null;
 791:           weather_info?: Json | null;
 792:           work_description?: string;
 793:           worker_count?: number | null;
 794:         };
 795:         Relationships: [
 796:           {
 797:             foreignKeyName: 'daily_reports_blueprint_id_fkey';
 798:             columns: ['blueprint_id'];
 799:             isOneToOne: false;
 800:             referencedRelation: 'blueprints';
 801:             referencedColumns: ['id'];
 802:           },
 803:           {
 804:             foreignKeyName: 'daily_reports_branch_id_fkey';
 805:             columns: ['branch_id'];
 806:             isOneToOne: false;
 807:             referencedRelation: 'blueprint_branches';
 808:             referencedColumns: ['id'];
 809:           },
 810:           {
 811:             foreignKeyName: 'daily_reports_reported_by_fkey';
 812:             columns: ['reported_by'];
 813:             isOneToOne: false;
 814:             referencedRelation: 'accounts';
 815:             referencedColumns: ['id'];
 816:           },
 817:           {
 818:             foreignKeyName: 'daily_reports_task_id_fkey';
 819:             columns: ['task_id'];
 820:             isOneToOne: false;
 821:             referencedRelation: 'tasks';
 822:             referencedColumns: ['id'];
 823:           }
 824:         ];
 825:       };
 826:       document_thumbnails: {
 827:         Row: {
 828:           document_id: string;
 829:           file_size: number;
 830:           generated_at: string | null;
 831:           height: number;
 832:           id: string;
 833:           storage_path: string;
 834:           thumbnail_size: string;
 835:           width: number;
 836:         };
 837:         Insert: {
 838:           document_id: string;
 839:           file_size: number;
 840:           generated_at?: string | null;
 841:           height: number;
 842:           id?: string;
 843:           storage_path: string;
 844:           thumbnail_size: string;
 845:           width: number;
 846:         };
 847:         Update: {
 848:           document_id?: string;
 849:           file_size?: number;
 850:           generated_at?: string | null;
 851:           height?: number;
 852:           id?: string;
 853:           storage_path?: string;
 854:           thumbnail_size?: string;
 855:           width?: number;
 856:         };
 857:         Relationships: [
 858:           {
 859:             foreignKeyName: 'document_thumbnails_document_id_fkey';
 860:             columns: ['document_id'];
 861:             isOneToOne: false;
 862:             referencedRelation: 'documents';
 863:             referencedColumns: ['id'];
 864:           }
 865:         ];
 866:       };
 867:       document_versions: {
 868:         Row: {
 869:           change_description: string | null;
 870:           checksum: string | null;
 871:           created_at: string | null;
 872:           created_by: string;
 873:           document_id: string;
 874:           file_name: string;
 875:           file_size: number;
 876:           id: string;
 877:           storage_path: string;
 878:           version_number: number;
 879:         };
 880:         Insert: {
 881:           change_description?: string | null;
 882:           checksum?: string | null;
 883:           created_at?: string | null;
 884:           created_by: string;
 885:           document_id: string;
 886:           file_name: string;
 887:           file_size: number;
 888:           id?: string;
 889:           storage_path: string;
 890:           version_number: number;
 891:         };
 892:         Update: {
 893:           change_description?: string | null;
 894:           checksum?: string | null;
 895:           created_at?: string | null;
 896:           created_by?: string;
 897:           document_id?: string;
 898:           file_name?: string;
 899:           file_size?: number;
 900:           id?: string;
 901:           storage_path?: string;
 902:           version_number?: number;
 903:         };
 904:         Relationships: [
 905:           {
 906:             foreignKeyName: 'document_versions_created_by_fkey';
 907:             columns: ['created_by'];
 908:             isOneToOne: false;
 909:             referencedRelation: 'accounts';
 910:             referencedColumns: ['id'];
 911:           },
 912:           {
 913:             foreignKeyName: 'document_versions_document_id_fkey';
 914:             columns: ['document_id'];
 915:             isOneToOne: false;
 916:             referencedRelation: 'documents';
 917:             referencedColumns: ['id'];
 918:           }
 919:         ];
 920:       };
 921:       documents: {
 922:         Row: {
 923:           checksum: string | null;
 924:           file_name: string;
 925:           file_size: number;
 926:           file_type: string;
 927:           id: string;
 928:           is_public: boolean | null;
 929:           metadata: Json | null;
 930:           mime_type: string;
 931:           permanent_delete_at: string | null;
 932:           soft_deleted_at: string | null;
 933:           storage_bucket: string | null;
 934:           storage_path: string;
 935:           upload_source: string | null;
 936:           uploaded_at: string | null;
 937:           uploader_id: string;
 938:         };
 939:         Insert: {
 940:           checksum?: string | null;
 941:           file_name: string;
 942:           file_size: number;
 943:           file_type: string;
 944:           id?: string;
 945:           is_public?: boolean | null;
 946:           metadata?: Json | null;
 947:           mime_type: string;
 948:           permanent_delete_at?: string | null;
 949:           soft_deleted_at?: string | null;
 950:           storage_bucket?: string | null;
 951:           storage_path: string;
 952:           upload_source?: string | null;
 953:           uploaded_at?: string | null;
 954:           uploader_id: string;
 955:         };
 956:         Update: {
 957:           checksum?: string | null;
 958:           file_name?: string;
 959:           file_size?: number;
 960:           file_type?: string;
 961:           id?: string;
 962:           is_public?: boolean | null;
 963:           metadata?: Json | null;
 964:           mime_type?: string;
 965:           permanent_delete_at?: string | null;
 966:           soft_deleted_at?: string | null;
 967:           storage_bucket?: string | null;
 968:           storage_path?: string;
 969:           upload_source?: string | null;
 970:           uploaded_at?: string | null;
 971:           uploader_id?: string;
 972:         };
 973:         Relationships: [
 974:           {
 975:             foreignKeyName: 'documents_uploader_id_fkey';
 976:             columns: ['uploader_id'];
 977:             isOneToOne: false;
 978:             referencedRelation: 'accounts';
 979:             referencedColumns: ['id'];
 980:           }
 981:         ];
 982:       };
 983:       feature_flags: {
 984:         Row: {
 985:           created_at: string | null;
 986:           created_by: string | null;
 987:           description: string | null;
 988:           end_date: string | null;
 989:           flag_key: string;
 990:           flag_name: string;
 991:           id: string;
 992:           is_enabled: boolean | null;
 993:           rollout_percentage: number | null;
 994:           start_date: string | null;
 995:           target_accounts: Json | null;
 996:           target_organizations: Json | null;
 997:           updated_at: string | null;
 998:         };
 999:         Insert: {
1000:           created_at?: string | null;
1001:           created_by?: string | null;
1002:           description?: string | null;
1003:           end_date?: string | null;
1004:           flag_key: string;
1005:           flag_name: string;
1006:           id?: string;
1007:           is_enabled?: boolean | null;
1008:           rollout_percentage?: number | null;
1009:           start_date?: string | null;
1010:           target_accounts?: Json | null;
1011:           target_organizations?: Json | null;
1012:           updated_at?: string | null;
1013:         };
1014:         Update: {
1015:           created_at?: string | null;
1016:           created_by?: string | null;
1017:           description?: string | null;
1018:           end_date?: string | null;
1019:           flag_key?: string;
1020:           flag_name?: string;
1021:           id?: string;
1022:           is_enabled?: boolean | null;
1023:           rollout_percentage?: number | null;
1024:           start_date?: string | null;
1025:           target_accounts?: Json | null;
1026:           target_organizations?: Json | null;
1027:           updated_at?: string | null;
1028:         };
1029:         Relationships: [
1030:           {
1031:             foreignKeyName: 'feature_flags_created_by_fkey';
1032:             columns: ['created_by'];
1033:             isOneToOne: false;
1034:             referencedRelation: 'accounts';
1035:             referencedColumns: ['id'];
1036:           }
1037:         ];
1038:       };
1039:       inspection_photos: {
1040:         Row: {
1041:           caption: string | null;
1042:           document_id: string;
1043:           id: string;
1044:           inspection_id: string;
1045:           photo_type: string | null;
1046:           sequence_order: number | null;
1047:           uploaded_at: string | null;
1048:           uploaded_by: string;
1049:         };
1050:         Insert: {
1051:           caption?: string | null;
1052:           document_id: string;
1053:           id?: string;
1054:           inspection_id: string;
1055:           photo_type?: string | null;
1056:           sequence_order?: number | null;
1057:           uploaded_at?: string | null;
1058:           uploaded_by: string;
1059:         };
1060:         Update: {
1061:           caption?: string | null;
1062:           document_id?: string;
1063:           id?: string;
1064:           inspection_id?: string;
1065:           photo_type?: string | null;
1066:           sequence_order?: number | null;
1067:           uploaded_at?: string | null;
1068:           uploaded_by?: string;
1069:         };
1070:         Relationships: [
1071:           {
1072:             foreignKeyName: 'inspection_photos_document_id_fkey';
1073:             columns: ['document_id'];
1074:             isOneToOne: false;
1075:             referencedRelation: 'documents';
1076:             referencedColumns: ['id'];
1077:           },
1078:           {
1079:             foreignKeyName: 'inspection_photos_inspection_id_fkey';
1080:             columns: ['inspection_id'];
1081:             isOneToOne: false;
1082:             referencedRelation: 'inspections';
1083:             referencedColumns: ['id'];
1084:           },
1085:           {
1086:             foreignKeyName: 'inspection_photos_uploaded_by_fkey';
1087:             columns: ['uploaded_by'];
1088:             isOneToOne: false;
1089:             referencedRelation: 'accounts';
1090:             referencedColumns: ['id'];
1091:           }
1092:         ];
1093:       };
1094:       inspections: {
1095:         Row: {
1096:           acceptance_criteria: string | null;
1097:           completed_at: string | null;
1098:           corrective_actions: string | null;
1099:           defects_found: Json | null;
1100:           findings: string | null;
1101:           id: string;
1102:           inspected_at: string | null;
1103:           inspection_items: Json;
1104:           inspection_type: string | null;
1105:           inspector_id: string;
1106:           qc_id: string | null;
1107:           responsibility_transferred: boolean | null;
1108:           status: string | null;
1109:           task_id: string;
1110:           transfer_date: string | null;
1111:         };
1112:         Insert: {
1113:           acceptance_criteria?: string | null;
1114:           completed_at?: string | null;
1115:           corrective_actions?: string | null;
1116:           defects_found?: Json | null;
1117:           findings?: string | null;
1118:           id?: string;
1119:           inspected_at?: string | null;
1120:           inspection_items: Json;
1121:           inspection_type?: string | null;
1122:           inspector_id: string;
1123:           qc_id?: string | null;
1124:           responsibility_transferred?: boolean | null;
1125:           status?: string | null;
1126:           task_id: string;
1127:           transfer_date?: string | null;
1128:         };
1129:         Update: {
1130:           acceptance_criteria?: string | null;
1131:           completed_at?: string | null;
1132:           corrective_actions?: string | null;
1133:           defects_found?: Json | null;
1134:           findings?: string | null;
1135:           id?: string;
1136:           inspected_at?: string | null;
1137:           inspection_items?: Json;
1138:           inspection_type?: string | null;
1139:           inspector_id?: string;
1140:           qc_id?: string | null;
1141:           responsibility_transferred?: boolean | null;
1142:           status?: string | null;
1143:           task_id?: string;
1144:           transfer_date?: string | null;
1145:         };
1146:         Relationships: [
1147:           {
1148:             foreignKeyName: 'inspections_inspector_id_fkey';
1149:             columns: ['inspector_id'];
1150:             isOneToOne: false;
1151:             referencedRelation: 'accounts';
1152:             referencedColumns: ['id'];
1153:           },
1154:           {
1155:             foreignKeyName: 'inspections_qc_id_fkey';
1156:             columns: ['qc_id'];
1157:             isOneToOne: false;
1158:             referencedRelation: 'quality_checks';
1159:             referencedColumns: ['id'];
1160:           },
1161:           {
1162:             foreignKeyName: 'inspections_task_id_fkey';
1163:             columns: ['task_id'];
1164:             isOneToOne: false;
1165:             referencedRelation: 'tasks';
1166:             referencedColumns: ['id'];
1167:           }
1168:         ];
1169:       };
1170:       issue_assignments: {
1171:         Row: {
1172:           assigned_at: string | null;
1173:           assigned_by: string;
1174:           assignee_id: string;
1175:           assignment_note: string | null;
1176:           id: string;
1177:           issue_id: string;
1178:         };
1179:         Insert: {
1180:           assigned_at?: string | null;
1181:           assigned_by: string;
1182:           assignee_id: string;
1183:           assignment_note?: string | null;
1184:           id?: string;
1185:           issue_id: string;
1186:         };
1187:         Update: {
1188:           assigned_at?: string | null;
1189:           assigned_by?: string;
1190:           assignee_id?: string;
1191:           assignment_note?: string | null;
1192:           id?: string;
1193:           issue_id?: string;
1194:         };
1195:         Relationships: [
1196:           {
1197:             foreignKeyName: 'issue_assignments_assigned_by_fkey';
1198:             columns: ['assigned_by'];
1199:             isOneToOne: false;
1200:             referencedRelation: 'accounts';
1201:             referencedColumns: ['id'];
1202:           },
1203:           {
1204:             foreignKeyName: 'issue_assignments_assignee_id_fkey';
1205:             columns: ['assignee_id'];
1206:             isOneToOne: false;
1207:             referencedRelation: 'accounts';
1208:             referencedColumns: ['id'];
1209:           },
1210:           {
1211:             foreignKeyName: 'issue_assignments_issue_id_fkey';
1212:             columns: ['issue_id'];
1213:             isOneToOne: false;
1214:             referencedRelation: 'issues';
1215:             referencedColumns: ['id'];
1216:           }
1217:         ];
1218:       };
1219:       issue_photos: {
1220:         Row: {
1221:           caption: string | null;
1222:           document_id: string;
1223:           id: string;
1224:           issue_id: string;
1225:           photo_type: string | null;
1226:           sequence_order: number | null;
1227:           uploaded_at: string | null;
1228:           uploaded_by: string;
1229:         };
1230:         Insert: {
1231:           caption?: string | null;
1232:           document_id: string;
1233:           id?: string;
1234:           issue_id: string;
1235:           photo_type?: string | null;
1236:           sequence_order?: number | null;
1237:           uploaded_at?: string | null;
1238:           uploaded_by: string;
1239:         };
1240:         Update: {
1241:           caption?: string | null;
1242:           document_id?: string;
1243:           id?: string;
1244:           issue_id?: string;
1245:           photo_type?: string | null;
1246:           sequence_order?: number | null;
1247:           uploaded_at?: string | null;
1248:           uploaded_by?: string;
1249:         };
1250:         Relationships: [
1251:           {
1252:             foreignKeyName: 'issue_photos_document_id_fkey';
1253:             columns: ['document_id'];
1254:             isOneToOne: false;
1255:             referencedRelation: 'documents';
1256:             referencedColumns: ['id'];
1257:           },
1258:           {
1259:             foreignKeyName: 'issue_photos_issue_id_fkey';
1260:             columns: ['issue_id'];
1261:             isOneToOne: false;
1262:             referencedRelation: 'issues';
1263:             referencedColumns: ['id'];
1264:           },
1265:           {
1266:             foreignKeyName: 'issue_photos_uploaded_by_fkey';
1267:             columns: ['uploaded_by'];
1268:             isOneToOne: false;
1269:             referencedRelation: 'accounts';
1270:             referencedColumns: ['id'];
1271:           }
1272:         ];
1273:       };
1274:       issue_sync_logs: {
1275:         Row: {
1276:           id: string;
1277:           issue_id: string;
1278:           source_branch_id: string | null;
1279:           sync_data: Json | null;
1280:           sync_type: string | null;
1281:           synced_at: string | null;
1282:           synced_by: string | null;
1283:           target_blueprint_id: string;
1284:         };
1285:         Insert: {
1286:           id?: string;
1287:           issue_id: string;
1288:           source_branch_id?: string | null;
1289:           sync_data?: Json | null;
1290:           sync_type?: string | null;
1291:           synced_at?: string | null;
1292:           synced_by?: string | null;
1293:           target_blueprint_id: string;
1294:         };
1295:         Update: {
1296:           id?: string;
1297:           issue_id?: string;
1298:           source_branch_id?: string | null;
1299:           sync_data?: Json | null;
1300:           sync_type?: string | null;
1301:           synced_at?: string | null;
1302:           synced_by?: string | null;
1303:           target_blueprint_id?: string;
1304:         };
1305:         Relationships: [
1306:           {
1307:             foreignKeyName: 'issue_sync_logs_issue_id_fkey';
1308:             columns: ['issue_id'];
1309:             isOneToOne: false;
1310:             referencedRelation: 'issues';
1311:             referencedColumns: ['id'];
1312:           },
1313:           {
1314:             foreignKeyName: 'issue_sync_logs_source_branch_id_fkey';
1315:             columns: ['source_branch_id'];
1316:             isOneToOne: false;
1317:             referencedRelation: 'blueprint_branches';
1318:             referencedColumns: ['id'];
1319:           },
1320:           {
1321:             foreignKeyName: 'issue_sync_logs_synced_by_fkey';
1322:             columns: ['synced_by'];
1323:             isOneToOne: false;
1324:             referencedRelation: 'accounts';
1325:             referencedColumns: ['id'];
1326:           },
1327:           {
1328:             foreignKeyName: 'issue_sync_logs_target_blueprint_id_fkey';
1329:             columns: ['target_blueprint_id'];
1330:             isOneToOne: false;
1331:             referencedRelation: 'blueprints';
1332:             referencedColumns: ['id'];
1333:           }
1334:         ];
1335:       };
1336:       issues: {
1337:         Row: {
1338:           blueprint_id: string;
1339:           branch_id: string | null;
1340:           closed_at: string | null;
1341:           description: string;
1342:           id: string;
1343:           issue_type: string | null;
1344:           priority: string | null;
1345:           reported_at: string | null;
1346:           reported_by: string;
1347:           resolution_note: string | null;
1348:           resolved_at: string | null;
1349:           severity: string | null;
1350:           status: string | null;
1351:           synced_to_main: boolean | null;
1352:           task_id: string | null;
1353:           title: string;
1354:         };
1355:         Insert: {
1356:           blueprint_id: string;
1357:           branch_id?: string | null;
1358:           closed_at?: string | null;
1359:           description: string;
1360:           id?: string;
1361:           issue_type?: string | null;
1362:           priority?: string | null;
1363:           reported_at?: string | null;
1364:           reported_by: string;
1365:           resolution_note?: string | null;
1366:           resolved_at?: string | null;
1367:           severity?: string | null;
1368:           status?: string | null;
1369:           synced_to_main?: boolean | null;
1370:           task_id?: string | null;
1371:           title: string;
1372:         };
1373:         Update: {
1374:           blueprint_id?: string;
1375:           branch_id?: string | null;
1376:           closed_at?: string | null;
1377:           description?: string;
1378:           id?: string;
1379:           issue_type?: string | null;
1380:           priority?: string | null;
1381:           reported_at?: string | null;
1382:           reported_by?: string;
1383:           resolution_note?: string | null;
1384:           resolved_at?: string | null;
1385:           severity?: string | null;
1386:           status?: string | null;
1387:           synced_to_main?: boolean | null;
1388:           task_id?: string | null;
1389:           title?: string;
1390:         };
1391:         Relationships: [
1392:           {
1393:             foreignKeyName: 'issues_blueprint_id_fkey';
1394:             columns: ['blueprint_id'];
1395:             isOneToOne: false;
1396:             referencedRelation: 'blueprints';
1397:             referencedColumns: ['id'];
1398:           },
1399:           {
1400:             foreignKeyName: 'issues_branch_id_fkey';
1401:             columns: ['branch_id'];
1402:             isOneToOne: false;
1403:             referencedRelation: 'blueprint_branches';
1404:             referencedColumns: ['id'];
1405:           },
1406:           {
1407:             foreignKeyName: 'issues_reported_by_fkey';
1408:             columns: ['reported_by'];
1409:             isOneToOne: false;
1410:             referencedRelation: 'accounts';
1411:             referencedColumns: ['id'];
1412:           },
1413:           {
1414:             foreignKeyName: 'issues_task_id_fkey';
1415:             columns: ['task_id'];
1416:             isOneToOne: false;
1417:             referencedRelation: 'tasks';
1418:             referencedColumns: ['id'];
1419:           }
1420:         ];
1421:       };
1422:       notification_rules: {
1423:         Row: {
1424:           account_id: string;
1425:           channel: string;
1426:           created_at: string | null;
1427:           frequency: string | null;
1428:           id: string;
1429:           is_enabled: boolean | null;
1430:           notification_type: string;
1431:           quiet_hours_end: string | null;
1432:           quiet_hours_start: string | null;
1433:           updated_at: string | null;
1434:         };
1435:         Insert: {
1436:           account_id: string;
1437:           channel: string;
1438:           created_at?: string | null;
1439:           frequency?: string | null;
1440:           id?: string;
1441:           is_enabled?: boolean | null;
1442:           notification_type: string;
1443:           quiet_hours_end?: string | null;
1444:           quiet_hours_start?: string | null;
1445:           updated_at?: string | null;
1446:         };
1447:         Update: {
1448:           account_id?: string;
1449:           channel?: string;
1450:           created_at?: string | null;
1451:           frequency?: string | null;
1452:           id?: string;
1453:           is_enabled?: boolean | null;
1454:           notification_type?: string;
1455:           quiet_hours_end?: string | null;
1456:           quiet_hours_start?: string | null;
1457:           updated_at?: string | null;
1458:         };
1459:         Relationships: [
1460:           {
1461:             foreignKeyName: 'notification_rules_account_id_fkey';
1462:             columns: ['account_id'];
1463:             isOneToOne: false;
1464:             referencedRelation: 'accounts';
1465:             referencedColumns: ['id'];
1466:           }
1467:         ];
1468:       };
1469:       notification_subscriptions: {
1470:         Row: {
1471:           account_id: string;
1472:           id: string;
1473:           subscribable_id: string;
1474:           subscribable_type: string;
1475:           subscribed_at: string | null;
1476:           subscription_level: string | null;
1477:         };
1478:         Insert: {
1479:           account_id: string;
1480:           id?: string;
1481:           subscribable_id: string;
1482:           subscribable_type: string;
1483:           subscribed_at?: string | null;
1484:           subscription_level?: string | null;
1485:         };
1486:         Update: {
1487:           account_id?: string;
1488:           id?: string;
1489:           subscribable_id?: string;
1490:           subscribable_type?: string;
1491:           subscribed_at?: string | null;
1492:           subscription_level?: string | null;
1493:         };
1494:         Relationships: [
1495:           {
1496:             foreignKeyName: 'notification_subscriptions_account_id_fkey';
1497:             columns: ['account_id'];
1498:             isOneToOne: false;
1499:             referencedRelation: 'accounts';
1500:             referencedColumns: ['id'];
1501:           }
1502:         ];
1503:       };
1504:       notifications: {
1505:         Row: {
1506:           action_url: string | null;
1507:           content: string | null;
1508:           created_at: string | null;
1509:           id: string;
1510:           is_read: boolean | null;
1511:           notification_type: string;
1512:           priority: string | null;
1513:           read_at: string | null;
1514:           recipient_id: string;
1515:           related_id: string | null;
1516:           related_type: string | null;
1517:           sender_id: string | null;
1518:           title: string;
1519:         };
1520:         Insert: {
1521:           action_url?: string | null;
1522:           content?: string | null;
1523:           created_at?: string | null;
1524:           id?: string;
1525:           is_read?: boolean | null;
1526:           notification_type: string;
1527:           priority?: string | null;
1528:           read_at?: string | null;
1529:           recipient_id: string;
1530:           related_id?: string | null;
1531:           related_type?: string | null;
1532:           sender_id?: string | null;
1533:           title: string;
1534:         };
1535:         Update: {
1536:           action_url?: string | null;
1537:           content?: string | null;
1538:           created_at?: string | null;
1539:           id?: string;
1540:           is_read?: boolean | null;
1541:           notification_type?: string;
1542:           priority?: string | null;
1543:           read_at?: string | null;
1544:           recipient_id?: string;
1545:           related_id?: string | null;
1546:           related_type?: string | null;
1547:           sender_id?: string | null;
1548:           title?: string;
1549:         };
1550:         Relationships: [
1551:           {
1552:             foreignKeyName: 'notifications_recipient_id_fkey';
1553:             columns: ['recipient_id'];
1554:             isOneToOne: false;
1555:             referencedRelation: 'accounts';
1556:             referencedColumns: ['id'];
1557:           },
1558:           {
1559:             foreignKeyName: 'notifications_sender_id_fkey';
1560:             columns: ['sender_id'];
1561:             isOneToOne: false;
1562:             referencedRelation: 'accounts';
1563:             referencedColumns: ['id'];
1564:           }
1565:         ];
1566:       };
1567:       organization_collaborations: {
1568:         Row: {
1569:           blueprint_id: string;
1570:           collaboration_type: string | null;
1571:           collaborator_org_id: string;
1572:           contract_end_date: string | null;
1573:           contract_start_date: string | null;
1574:           created_at: string | null;
1575:           id: string;
1576:           notes: string | null;
1577:           owner_org_id: string;
1578:           status: string | null;
1579:           updated_at: string | null;
1580:         };
1581:         Insert: {
1582:           blueprint_id: string;
1583:           collaboration_type?: string | null;
1584:           collaborator_org_id: string;
1585:           contract_end_date?: string | null;
1586:           contract_start_date?: string | null;
1587:           created_at?: string | null;
1588:           id?: string;
1589:           notes?: string | null;
1590:           owner_org_id: string;
1591:           status?: string | null;
1592:           updated_at?: string | null;
1593:         };
1594:         Update: {
1595:           blueprint_id?: string;
1596:           collaboration_type?: string | null;
1597:           collaborator_org_id?: string;
1598:           contract_end_date?: string | null;
1599:           contract_start_date?: string | null;
1600:           created_at?: string | null;
1601:           id?: string;
1602:           notes?: string | null;
1603:           owner_org_id?: string;
1604:           status?: string | null;
1605:           updated_at?: string | null;
1606:         };
1607:         Relationships: [
1608:           {
1609:             foreignKeyName: 'organization_collaborations_blueprint_id_fkey';
1610:             columns: ['blueprint_id'];
1611:             isOneToOne: false;
1612:             referencedRelation: 'blueprints';
1613:             referencedColumns: ['id'];
1614:           },
1615:           {
1616:             foreignKeyName: 'organization_collaborations_collaborator_org_id_fkey';
1617:             columns: ['collaborator_org_id'];
1618:             isOneToOne: false;
1619:             referencedRelation: 'accounts';
1620:             referencedColumns: ['id'];
1621:           },
1622:           {
1623:             foreignKeyName: 'organization_collaborations_owner_org_id_fkey';
1624:             columns: ['owner_org_id'];
1625:             isOneToOne: false;
1626:             referencedRelation: 'accounts';
1627:             referencedColumns: ['id'];
1628:           }
1629:         ];
1630:       };
1631:       organization_members: {
1632:         Row: {
1633:           account_id: string;
1634:           id: string;
1635:           joined_at: string | null;
1636:           organization_id: string;
1637:           role: string | null;
1638:         };
1639:         Insert: {
1640:           account_id: string;
1641:           id?: string;
1642:           joined_at?: string | null;
1643:           organization_id: string;
1644:           role?: string | null;
1645:         };
1646:         Update: {
1647:           account_id?: string;
1648:           id?: string;
1649:           joined_at?: string | null;
1650:           organization_id?: string;
1651:           role?: string | null;
1652:         };
1653:         Relationships: [
1654:           {
1655:             foreignKeyName: 'organization_members_account_id_fkey';
1656:             columns: ['account_id'];
1657:             isOneToOne: false;
1658:             referencedRelation: 'accounts';
1659:             referencedColumns: ['id'];
1660:           },
1661:           {
1662:             foreignKeyName: 'organization_members_organization_id_fkey';
1663:             columns: ['organization_id'];
1664:             isOneToOne: false;
1665:             referencedRelation: 'accounts';
1666:             referencedColumns: ['id'];
1667:           }
1668:         ];
1669:       };
1670:       organization_schedules: {
1671:         Row: {
1672:           account_id: string | null;
1673:           blueprint_id: string | null;
1674:           branch_id: string | null;
1675:           created_at: string | null;
1676:           created_by: string;
1677:           end_time: string | null;
1678:           id: string;
1679:           notes: string | null;
1680:           organization_id: string;
1681:           schedule_date: string;
1682:           start_time: string | null;
1683:           team_id: string | null;
1684:           updated_at: string | null;
1685:           weather_info: Json | null;
1686:         };
1687:         Insert: {
1688:           account_id?: string | null;
1689:           blueprint_id?: string | null;
1690:           branch_id?: string | null;
1691:           created_at?: string | null;
1692:           created_by: string;
1693:           end_time?: string | null;
1694:           id?: string;
1695:           notes?: string | null;
1696:           organization_id: string;
1697:           schedule_date: string;
1698:           start_time?: string | null;
1699:           team_id?: string | null;
1700:           updated_at?: string | null;
1701:           weather_info?: Json | null;
1702:         };
1703:         Update: {
1704:           account_id?: string | null;
1705:           blueprint_id?: string | null;
1706:           branch_id?: string | null;
1707:           created_at?: string | null;
1708:           created_by?: string;
1709:           end_time?: string | null;
1710:           id?: string;
1711:           notes?: string | null;
1712:           organization_id?: string;
1713:           schedule_date?: string;
1714:           start_time?: string | null;
1715:           team_id?: string | null;
1716:           updated_at?: string | null;
1717:           weather_info?: Json | null;
1718:         };
1719:         Relationships: [
1720:           {
1721:             foreignKeyName: 'organization_schedules_account_id_fkey';
1722:             columns: ['account_id'];
1723:             isOneToOne: false;
1724:             referencedRelation: 'accounts';
1725:             referencedColumns: ['id'];
1726:           },
1727:           {
1728:             foreignKeyName: 'organization_schedules_blueprint_id_fkey';
1729:             columns: ['blueprint_id'];
1730:             isOneToOne: false;
1731:             referencedRelation: 'blueprints';
1732:             referencedColumns: ['id'];
1733:           },
1734:           {
1735:             foreignKeyName: 'organization_schedules_branch_id_fkey';
1736:             columns: ['branch_id'];
1737:             isOneToOne: false;
1738:             referencedRelation: 'blueprint_branches';
1739:             referencedColumns: ['id'];
1740:           },
1741:           {
1742:             foreignKeyName: 'organization_schedules_created_by_fkey';
1743:             columns: ['created_by'];
1744:             isOneToOne: false;
1745:             referencedRelation: 'accounts';
1746:             referencedColumns: ['id'];
1747:           },
1748:           {
1749:             foreignKeyName: 'organization_schedules_organization_id_fkey';
1750:             columns: ['organization_id'];
1751:             isOneToOne: false;
1752:             referencedRelation: 'accounts';
1753:             referencedColumns: ['id'];
1754:           },
1755:           {
1756:             foreignKeyName: 'organization_schedules_team_id_fkey';
1757:             columns: ['team_id'];
1758:             isOneToOne: false;
1759:             referencedRelation: 'teams';
1760:             referencedColumns: ['id'];
1761:           }
1762:         ];
1763:       };
1764:       permissions: {
1765:         Row: {
1766:           action: string;
1767:           created_at: string | null;
1768:           description: string | null;
1769:           id: string;
1770:           is_system_permission: boolean | null;
1771:           name: string;
1772:           resource: string;
1773:         };
1774:         Insert: {
1775:           action: string;
1776:           created_at?: string | null;
1777:           description?: string | null;
1778:           id?: string;
1779:           is_system_permission?: boolean | null;
1780:           name: string;
1781:           resource: string;
1782:         };
1783:         Update: {
1784:           action?: string;
1785:           created_at?: string | null;
1786:           description?: string | null;
1787:           id?: string;
1788:           is_system_permission?: boolean | null;
1789:           name?: string;
1790:           resource?: string;
1791:         };
1792:         Relationships: [];
1793:       };
1794:       personal_todos: {
1795:         Row: {
1796:           account_id: string;
1797:           completed_at: string | null;
1798:           created_at: string | null;
1799:           description: string | null;
1800:           due_date: string | null;
1801:           id: string;
1802:           priority: string | null;
1803:           related_id: string | null;
1804:           related_type: string | null;
1805:           status: string | null;
1806:           title: string;
1807:           todo_type: string;
1808:           updated_at: string | null;
1809:         };
1810:         Insert: {
1811:           account_id: string;
1812:           completed_at?: string | null;
1813:           created_at?: string | null;
1814:           description?: string | null;
1815:           due_date?: string | null;
1816:           id?: string;
1817:           priority?: string | null;
1818:           related_id?: string | null;
1819:           related_type?: string | null;
1820:           status?: string | null;
1821:           title: string;
1822:           todo_type: string;
1823:           updated_at?: string | null;
1824:         };
1825:         Update: {
1826:           account_id?: string;
1827:           completed_at?: string | null;
1828:           created_at?: string | null;
1829:           description?: string | null;
1830:           due_date?: string | null;
1831:           id?: string;
1832:           priority?: string | null;
1833:           related_id?: string | null;
1834:           related_type?: string | null;
1835:           status?: string | null;
1836:           title?: string;
1837:           todo_type?: string;
1838:           updated_at?: string | null;
1839:         };
1840:         Relationships: [
1841:           {
1842:             foreignKeyName: 'personal_todos_account_id_fkey';
1843:             columns: ['account_id'];
1844:             isOneToOne: false;
1845:             referencedRelation: 'accounts';
1846:             referencedColumns: ['id'];
1847:           }
1848:         ];
1849:       };
1850:       progress_tracking: {
1851:         Row: {
1852:           blueprint_id: string;
1853:           branch_id: string | null;
1854:           budget_spent: number | null;
1855:           budget_variance: number | null;
1856:           calculated_at: string | null;
1857:           completed_tasks: number | null;
1858:           completion_percentage: number | null;
1859:           id: string;
1860:           in_progress_tasks: number | null;
1861:           overdue_tasks: number | null;
1862:           pending_tasks: number | null;
1863:           quality_score: number | null;
1864:           safety_incidents: number | null;
1865:           schedule_variance_days: number | null;
1866:           total_tasks: number | null;
1867:           tracking_date: string;
1868:         };
1869:         Insert: {
1870:           blueprint_id: string;
1871:           branch_id?: string | null;
1872:           budget_spent?: number | null;
1873:           budget_variance?: number | null;
1874:           calculated_at?: string | null;
1875:           completed_tasks?: number | null;
1876:           completion_percentage?: number | null;
1877:           id?: string;
1878:           in_progress_tasks?: number | null;
1879:           overdue_tasks?: number | null;
1880:           pending_tasks?: number | null;
1881:           quality_score?: number | null;
1882:           safety_incidents?: number | null;
1883:           schedule_variance_days?: number | null;
1884:           total_tasks?: number | null;
1885:           tracking_date: string;
1886:         };
1887:         Update: {
1888:           blueprint_id?: string;
1889:           branch_id?: string | null;
1890:           budget_spent?: number | null;
1891:           budget_variance?: number | null;
1892:           calculated_at?: string | null;
1893:           completed_tasks?: number | null;
1894:           completion_percentage?: number | null;
1895:           id?: string;
1896:           in_progress_tasks?: number | null;
1897:           overdue_tasks?: number | null;
1898:           pending_tasks?: number | null;
1899:           quality_score?: number | null;
1900:           safety_incidents?: number | null;
1901:           schedule_variance_days?: number | null;
1902:           total_tasks?: number | null;
1903:           tracking_date?: string;
1904:         };
1905:         Relationships: [
1906:           {
1907:             foreignKeyName: 'progress_tracking_blueprint_id_fkey';
1908:             columns: ['blueprint_id'];
1909:             isOneToOne: false;
1910:             referencedRelation: 'blueprints';
1911:             referencedColumns: ['id'];
1912:           },
1913:           {
1914:             foreignKeyName: 'progress_tracking_branch_id_fkey';
1915:             columns: ['branch_id'];
1916:             isOneToOne: false;
1917:             referencedRelation: 'blueprint_branches';
1918:             referencedColumns: ['id'];
1919:           }
1920:         ];
1921:       };
1922:       pull_requests: {
1923:         Row: {
1924:           blueprint_id: string;
1925:           branch_id: string;
1926:           changes_summary: Json | null;
1927:           description: string | null;
1928:           id: string;
1929:           merged_at: string | null;
1930:           merged_by: string | null;
1931:           reviewed_at: string | null;
1932:           reviewed_by: string | null;
1933:           status: string | null;
1934:           submitted_at: string | null;
1935:           submitted_by: string;
1936:           title: string;
1937:         };
1938:         Insert: {
1939:           blueprint_id: string;
1940:           branch_id: string;
1941:           changes_summary?: Json | null;
1942:           description?: string | null;
1943:           id?: string;
1944:           merged_at?: string | null;
1945:           merged_by?: string | null;
1946:           reviewed_at?: string | null;
1947:           reviewed_by?: string | null;
1948:           status?: string | null;
1949:           submitted_at?: string | null;
1950:           submitted_by: string;
1951:           title: string;
1952:         };
1953:         Update: {
1954:           blueprint_id?: string;
1955:           branch_id?: string;
1956:           changes_summary?: Json | null;
1957:           description?: string | null;
1958:           id?: string;
1959:           merged_at?: string | null;
1960:           merged_by?: string | null;
1961:           reviewed_at?: string | null;
1962:           reviewed_by?: string | null;
1963:           status?: string | null;
1964:           submitted_at?: string | null;
1965:           submitted_by?: string;
1966:           title?: string;
1967:         };
1968:         Relationships: [
1969:           {
1970:             foreignKeyName: 'pull_requests_blueprint_id_fkey';
1971:             columns: ['blueprint_id'];
1972:             isOneToOne: false;
1973:             referencedRelation: 'blueprints';
1974:             referencedColumns: ['id'];
1975:           },
1976:           {
1977:             foreignKeyName: 'pull_requests_branch_id_fkey';
1978:             columns: ['branch_id'];
1979:             isOneToOne: false;
1980:             referencedRelation: 'blueprint_branches';
1981:             referencedColumns: ['id'];
1982:           },
1983:           {
1984:             foreignKeyName: 'pull_requests_merged_by_fkey';
1985:             columns: ['merged_by'];
1986:             isOneToOne: false;
1987:             referencedRelation: 'accounts';
1988:             referencedColumns: ['id'];
1989:           },
1990:           {
1991:             foreignKeyName: 'pull_requests_reviewed_by_fkey';
1992:             columns: ['reviewed_by'];
1993:             isOneToOne: false;
1994:             referencedRelation: 'accounts';
1995:             referencedColumns: ['id'];
1996:           },
1997:           {
1998:             foreignKeyName: 'pull_requests_submitted_by_fkey';
1999:             columns: ['submitted_by'];
2000:             isOneToOne: false;
2001:             referencedRelation: 'accounts';
2002:             referencedColumns: ['id'];
2003:           }
2004:         ];
2005:       };
2006:       qc_photos: {
2007:         Row: {
2008:           caption: string | null;
2009:           document_id: string;
2010:           id: string;
2011:           photo_type: string | null;
2012:           qc_id: string;
2013:           sequence_order: number | null;
2014:           uploaded_at: string | null;
2015:           uploaded_by: string;
2016:         };
2017:         Insert: {
2018:           caption?: string | null;
2019:           document_id: string;
2020:           id?: string;
2021:           photo_type?: string | null;
2022:           qc_id: string;
2023:           sequence_order?: number | null;
2024:           uploaded_at?: string | null;
2025:           uploaded_by: string;
2026:         };
2027:         Update: {
2028:           caption?: string | null;
2029:           document_id?: string;
2030:           id?: string;
2031:           photo_type?: string | null;
2032:           qc_id?: string;
2033:           sequence_order?: number | null;
2034:           uploaded_at?: string | null;
2035:           uploaded_by?: string;
2036:         };
2037:         Relationships: [
2038:           {
2039:             foreignKeyName: 'qc_photos_document_id_fkey';
2040:             columns: ['document_id'];
2041:             isOneToOne: false;
2042:             referencedRelation: 'documents';
2043:             referencedColumns: ['id'];
2044:           },
2045:           {
2046:             foreignKeyName: 'qc_photos_qc_id_fkey';
2047:             columns: ['qc_id'];
2048:             isOneToOne: false;
2049:             referencedRelation: 'quality_checks';
2050:             referencedColumns: ['id'];
2051:           },
2052:           {
2053:             foreignKeyName: 'qc_photos_uploaded_by_fkey';
2054:             columns: ['uploaded_by'];
2055:             isOneToOne: false;
2056:             referencedRelation: 'accounts';
2057:             referencedColumns: ['id'];
2058:           }
2059:         ];
2060:       };
2061:       quality_checks: {
2062:         Row: {
2063:           check_items: Json;
2064:           check_type: string | null;
2065:           checked_at: string | null;
2066:           completed_at: string | null;
2067:           findings: string | null;
2068:           id: string;
2069:           inspector_id: string;
2070:           recommendations: string | null;
2071:           staging_id: string | null;
2072:           status: string | null;
2073:           task_id: string;
2074:         };
2075:         Insert: {
2076:           check_items: Json;
2077:           check_type?: string | null;
2078:           checked_at?: string | null;
2079:           completed_at?: string | null;
2080:           findings?: string | null;
2081:           id?: string;
2082:           inspector_id: string;
2083:           recommendations?: string | null;
2084:           staging_id?: string | null;
2085:           status?: string | null;
2086:           task_id: string;
2087:         };
2088:         Update: {
2089:           check_items?: Json;
2090:           check_type?: string | null;
2091:           checked_at?: string | null;
2092:           completed_at?: string | null;
2093:           findings?: string | null;
2094:           id?: string;
2095:           inspector_id?: string;
2096:           recommendations?: string | null;
2097:           staging_id?: string | null;
2098:           status?: string | null;
2099:           task_id?: string;
2100:         };
2101:         Relationships: [
2102:           {
2103:             foreignKeyName: 'quality_checks_inspector_id_fkey';
2104:             columns: ['inspector_id'];
2105:             isOneToOne: false;
2106:             referencedRelation: 'accounts';
2107:             referencedColumns: ['id'];
2108:           },
2109:           {
2110:             foreignKeyName: 'quality_checks_staging_id_fkey';
2111:             columns: ['staging_id'];
2112:             isOneToOne: false;
2113:             referencedRelation: 'task_staging';
2114:             referencedColumns: ['id'];
2115:           },
2116:           {
2117:             foreignKeyName: 'quality_checks_task_id_fkey';
2118:             columns: ['task_id'];
2119:             isOneToOne: false;
2120:             referencedRelation: 'tasks';
2121:             referencedColumns: ['id'];
2122:           }
2123:         ];
2124:       };
2125:       report_photos: {
2126:         Row: {
2127:           caption: string | null;
2128:           document_id: string;
2129:           id: string;
2130:           photo_type: string | null;
2131:           report_id: string;
2132:           sequence_order: number | null;
2133:           uploaded_at: string | null;
2134:           uploaded_by: string;
2135:         };
2136:         Insert: {
2137:           caption?: string | null;
2138:           document_id: string;
2139:           id?: string;
2140:           photo_type?: string | null;
2141:           report_id: string;
2142:           sequence_order?: number | null;
2143:           uploaded_at?: string | null;
2144:           uploaded_by: string;
2145:         };
2146:         Update: {
2147:           caption?: string | null;
2148:           document_id?: string;
2149:           id?: string;
2150:           photo_type?: string | null;
2151:           report_id?: string;
2152:           sequence_order?: number | null;
2153:           uploaded_at?: string | null;
2154:           uploaded_by?: string;
2155:         };
2156:         Relationships: [
2157:           {
2158:             foreignKeyName: 'report_photos_document_id_fkey';
2159:             columns: ['document_id'];
2160:             isOneToOne: false;
2161:             referencedRelation: 'documents';
2162:             referencedColumns: ['id'];
2163:           },
2164:           {
2165:             foreignKeyName: 'report_photos_report_id_fkey';
2166:             columns: ['report_id'];
2167:             isOneToOne: false;
2168:             referencedRelation: 'daily_reports';
2169:             referencedColumns: ['id'];
2170:           },
2171:           {
2172:             foreignKeyName: 'report_photos_uploaded_by_fkey';
2173:             columns: ['uploaded_by'];
2174:             isOneToOne: false;
2175:             referencedRelation: 'accounts';
2176:             referencedColumns: ['id'];
2177:           }
2178:         ];
2179:       };
2180:       role_permissions: {
2181:         Row: {
2182:           created_at: string | null;
2183:           id: string;
2184:           permission_id: string;
2185:           role_id: string;
2186:         };
2187:         Insert: {
2188:           created_at?: string | null;
2189:           id?: string;
2190:           permission_id: string;
2191:           role_id: string;
2192:         };
2193:         Update: {
2194:           created_at?: string | null;
2195:           id?: string;
2196:           permission_id?: string;
2197:           role_id?: string;
2198:         };
2199:         Relationships: [
2200:           {
2201:             foreignKeyName: 'role_permissions_permission_id_fkey';
2202:             columns: ['permission_id'];
2203:             isOneToOne: false;
2204:             referencedRelation: 'permissions';
2205:             referencedColumns: ['id'];
2206:           },
2207:           {
2208:             foreignKeyName: 'role_permissions_role_id_fkey';
2209:             columns: ['role_id'];
2210:             isOneToOne: false;
2211:             referencedRelation: 'roles';
2212:             referencedColumns: ['id'];
2213:           }
2214:         ];
2215:       };
2216:       roles: {
2217:         Row: {
2218:           created_at: string | null;
2219:           description: string | null;
2220:           id: string;
2221:           is_system_role: boolean | null;
2222:           name: string;
2223:           updated_at: string | null;
2224:         };
2225:         Insert: {
2226:           created_at?: string | null;
2227:           description?: string | null;
2228:           id?: string;
2229:           is_system_role?: boolean | null;
2230:           name: string;
2231:           updated_at?: string | null;
2232:         };
2233:         Update: {
2234:           created_at?: string | null;
2235:           description?: string | null;
2236:           id?: string;
2237:           is_system_role?: boolean | null;
2238:           name?: string;
2239:           updated_at?: string | null;
2240:         };
2241:         Relationships: [];
2242:       };
2243:       settings: {
2244:         Row: {
2245:           created_at: string | null;
2246:           description: string | null;
2247:           id: string;
2248:           is_public: boolean | null;
2249:           scope_id: string | null;
2250:           setting_key: string;
2251:           setting_type: string | null;
2252:           setting_value: Json;
2253:           updated_at: string | null;
2254:           updated_by: string | null;
2255:         };
2256:         Insert: {
2257:           created_at?: string | null;
2258:           description?: string | null;
2259:           id?: string;
2260:           is_public?: boolean | null;
2261:           scope_id?: string | null;
2262:           setting_key: string;
2263:           setting_type?: string | null;
2264:           setting_value: Json;
2265:           updated_at?: string | null;
2266:           updated_by?: string | null;
2267:         };
2268:         Update: {
2269:           created_at?: string | null;
2270:           description?: string | null;
2271:           id?: string;
2272:           is_public?: boolean | null;
2273:           scope_id?: string | null;
2274:           setting_key?: string;
2275:           setting_type?: string | null;
2276:           setting_value?: Json;
2277:           updated_at?: string | null;
2278:           updated_by?: string | null;
2279:         };
2280:         Relationships: [
2281:           {
2282:             foreignKeyName: 'settings_updated_by_fkey';
2283:             columns: ['updated_by'];
2284:             isOneToOne: false;
2285:             referencedRelation: 'accounts';
2286:             referencedColumns: ['id'];
2287:           }
2288:         ];
2289:       };
2290:       task_assignments: {
2291:         Row: {
2292:           accepted_at: string | null;
2293:           assigned_at: string | null;
2294:           assigned_by: string;
2295:           assignee_id: string;
2296:           assignee_type: string;
2297:           assignment_note: string | null;
2298:           id: string;
2299:           task_id: string;
2300:         };
2301:         Insert: {
2302:           accepted_at?: string | null;
2303:           assigned_at?: string | null;
2304:           assigned_by: string;
2305:           assignee_id: string;
2306:           assignee_type: string;
2307:           assignment_note?: string | null;
2308:           id?: string;
2309:           task_id: string;
2310:         };
2311:         Update: {
2312:           accepted_at?: string | null;
2313:           assigned_at?: string | null;
2314:           assigned_by?: string;
2315:           assignee_id?: string;
2316:           assignee_type?: string;
2317:           assignment_note?: string | null;
2318:           id?: string;
2319:           task_id?: string;
2320:         };
2321:         Relationships: [
2322:           {
2323:             foreignKeyName: 'task_assignments_assigned_by_fkey';
2324:             columns: ['assigned_by'];
2325:             isOneToOne: false;
2326:             referencedRelation: 'accounts';
2327:             referencedColumns: ['id'];
2328:           },
2329:           {
2330:             foreignKeyName: 'task_assignments_assignee_id_fkey';
2331:             columns: ['assignee_id'];
2332:             isOneToOne: false;
2333:             referencedRelation: 'accounts';
2334:             referencedColumns: ['id'];
2335:           },
2336:           {
2337:             foreignKeyName: 'task_assignments_task_id_fkey';
2338:             columns: ['task_id'];
2339:             isOneToOne: false;
2340:             referencedRelation: 'tasks';
2341:             referencedColumns: ['id'];
2342:           }
2343:         ];
2344:       };
2345:       task_dependencies: {
2346:         Row: {
2347:           created_at: string | null;
2348:           dependency_type: string | null;
2349:           depends_on_task_id: string;
2350:           id: string;
2351:           lag_days: number | null;
2352:           task_id: string;
2353:         };
2354:         Insert: {
2355:           created_at?: string | null;
2356:           dependency_type?: string | null;
2357:           depends_on_task_id: string;
2358:           id?: string;
2359:           lag_days?: number | null;
2360:           task_id: string;
2361:         };
2362:         Update: {
2363:           created_at?: string | null;
2364:           dependency_type?: string | null;
2365:           depends_on_task_id?: string;
2366:           id?: string;
2367:           lag_days?: number | null;
2368:           task_id?: string;
2369:         };
2370:         Relationships: [
2371:           {
2372:             foreignKeyName: 'task_dependencies_depends_on_task_id_fkey';
2373:             columns: ['depends_on_task_id'];
2374:             isOneToOne: false;
2375:             referencedRelation: 'tasks';
2376:             referencedColumns: ['id'];
2377:           },
2378:           {
2379:             foreignKeyName: 'task_dependencies_task_id_fkey';
2380:             columns: ['task_id'];
2381:             isOneToOne: false;
2382:             referencedRelation: 'tasks';
2383:             referencedColumns: ['id'];
2384:           }
2385:         ];
2386:       };
2387:       task_lists: {
2388:         Row: {
2389:           account_id: string;
2390:           added_at: string | null;
2391:           id: string;
2392:           list_type: string | null;
2393:           task_id: string;
2394:         };
2395:         Insert: {
2396:           account_id: string;
2397:           added_at?: string | null;
2398:           id?: string;
2399:           list_type?: string | null;
2400:           task_id: string;
2401:         };
2402:         Update: {
2403:           account_id?: string;
2404:           added_at?: string | null;
2405:           id?: string;
2406:           list_type?: string | null;
2407:           task_id?: string;
2408:         };
2409:         Relationships: [
2410:           {
2411:             foreignKeyName: 'task_lists_account_id_fkey';
2412:             columns: ['account_id'];
2413:             isOneToOne: false;
2414:             referencedRelation: 'accounts';
2415:             referencedColumns: ['id'];
2416:           },
2417:           {
2418:             foreignKeyName: 'task_lists_task_id_fkey';
2419:             columns: ['task_id'];
2420:             isOneToOne: false;
2421:             referencedRelation: 'tasks';
2422:             referencedColumns: ['id'];
2423:           }
2424:         ];
2425:       };
2426:       task_staging: {
2427:         Row: {
2428:           can_withdraw: boolean | null;
2429:           confirmed_at: string | null;
2430:           expires_at: string;
2431:           id: string;
2432:           notes: string | null;
2433:           photos: Json | null;
2434:           staging_data: Json;
2435:           submitted_at: string | null;
2436:           submitted_by: string;
2437:           task_id: string;
2438:           withdrawn_at: string | null;
2439:         };
2440:         Insert: {
2441:           can_withdraw?: boolean | null;
2442:           confirmed_at?: string | null;
2443:           expires_at?: string;
2444:           id?: string;
2445:           notes?: string | null;
2446:           photos?: Json | null;
2447:           staging_data: Json;
2448:           submitted_at?: string | null;
2449:           submitted_by: string;
2450:           task_id: string;
2451:           withdrawn_at?: string | null;
2452:         };
2453:         Update: {
2454:           can_withdraw?: boolean | null;
2455:           confirmed_at?: string | null;
2456:           expires_at?: string;
2457:           id?: string;
2458:           notes?: string | null;
2459:           photos?: Json | null;
2460:           staging_data?: Json;
2461:           submitted_at?: string | null;
2462:           submitted_by?: string;
2463:           task_id?: string;
2464:           withdrawn_at?: string | null;
2465:         };
2466:         Relationships: [
2467:           {
2468:             foreignKeyName: 'task_staging_submitted_by_fkey';
2469:             columns: ['submitted_by'];
2470:             isOneToOne: false;
2471:             referencedRelation: 'accounts';
2472:             referencedColumns: ['id'];
2473:           },
2474:           {
2475:             foreignKeyName: 'task_staging_task_id_fkey';
2476:             columns: ['task_id'];
2477:             isOneToOne: false;
2478:             referencedRelation: 'tasks';
2479:             referencedColumns: ['id'];
2480:           }
2481:         ];
2482:       };
2483:       task_templates: {
2484:         Row: {
2485:           created_at: string | null;
2486:           created_by: string;
2487:           description: string | null;
2488:           id: string;
2489:           is_public: boolean | null;
2490:           name: string;
2491:           organization_id: string;
2492:           template_data: Json;
2493:           updated_at: string | null;
2494:           usage_count: number | null;
2495:         };
2496:         Insert: {
2497:           created_at?: string | null;
2498:           created_by: string;
2499:           description?: string | null;
2500:           id?: string;
2501:           is_public?: boolean | null;
2502:           name: string;
2503:           organization_id: string;
2504:           template_data: Json;
2505:           updated_at?: string | null;
2506:           usage_count?: number | null;
2507:         };
2508:         Update: {
2509:           created_at?: string | null;
2510:           created_by?: string;
2511:           description?: string | null;
2512:           id?: string;
2513:           is_public?: boolean | null;
2514:           name?: string;
2515:           organization_id?: string;
2516:           template_data?: Json;
2517:           updated_at?: string | null;
2518:           usage_count?: number | null;
2519:         };
2520:         Relationships: [
2521:           {
2522:             foreignKeyName: 'task_templates_created_by_fkey';
2523:             columns: ['created_by'];
2524:             isOneToOne: false;
2525:             referencedRelation: 'accounts';
2526:             referencedColumns: ['id'];
2527:           },
2528:           {
2529:             foreignKeyName: 'task_templates_organization_id_fkey';
2530:             columns: ['organization_id'];
2531:             isOneToOne: false;
2532:             referencedRelation: 'accounts';
2533:             referencedColumns: ['id'];
2534:           }
2535:         ];
2536:       };
2537:       tasks: {
2538:         Row: {
2539:           actual_end_date: string | null;
2540:           actual_hours: number | null;
2541:           actual_start_date: string | null;
2542:           blueprint_id: string;
2543:           branch_id: string | null;
2544:           contractor_fields: Json | null;
2545:           created_at: string | null;
2546:           created_by: string;
2547:           description: string | null;
2548:           estimated_hours: number | null;
2549:           id: string;
2550:           parent_task_id: string | null;
2551:           planned_end_date: string | null;
2552:           planned_start_date: string | null;
2553:           priority: string | null;
2554:           progress_percentage: number | null;
2555:           sequence_order: number | null;
2556:           status: string | null;
2557:           task_type: string | null;
2558:           title: string;
2559:           tree_level: number | null;
2560:           tree_path: unknown;
2561:           updated_at: string | null;
2562:         };
2563:         Insert: {
2564:           actual_end_date?: string | null;
2565:           actual_hours?: number | null;
2566:           actual_start_date?: string | null;
2567:           blueprint_id: string;
2568:           branch_id?: string | null;
2569:           contractor_fields?: Json | null;
2570:           created_at?: string | null;
2571:           created_by: string;
2572:           description?: string | null;
2573:           estimated_hours?: number | null;
2574:           id?: string;
2575:           parent_task_id?: string | null;
2576:           planned_end_date?: string | null;
2577:           planned_start_date?: string | null;
2578:           priority?: string | null;
2579:           progress_percentage?: number | null;
2580:           sequence_order?: number | null;
2581:           status?: string | null;
2582:           task_type?: string | null;
2583:           title: string;
2584:           tree_level?: number | null;
2585:           tree_path?: unknown;
2586:           updated_at?: string | null;
2587:         };
2588:         Update: {
2589:           actual_end_date?: string | null;
2590:           actual_hours?: number | null;
2591:           actual_start_date?: string | null;
2592:           blueprint_id?: string;
2593:           branch_id?: string | null;
2594:           contractor_fields?: Json | null;
2595:           created_at?: string | null;
2596:           created_by?: string;
2597:           description?: string | null;
2598:           estimated_hours?: number | null;
2599:           id?: string;
2600:           parent_task_id?: string | null;
2601:           planned_end_date?: string | null;
2602:           planned_start_date?: string | null;
2603:           priority?: string | null;
2604:           progress_percentage?: number | null;
2605:           sequence_order?: number | null;
2606:           status?: string | null;
2607:           task_type?: string | null;
2608:           title?: string;
2609:           tree_level?: number | null;
2610:           tree_path?: unknown;
2611:           updated_at?: string | null;
2612:         };
2613:         Relationships: [
2614:           {
2615:             foreignKeyName: 'tasks_blueprint_id_fkey';
2616:             columns: ['blueprint_id'];
2617:             isOneToOne: false;
2618:             referencedRelation: 'blueprints';
2619:             referencedColumns: ['id'];
2620:           },
2621:           {
2622:             foreignKeyName: 'tasks_branch_id_fkey';
2623:             columns: ['branch_id'];
2624:             isOneToOne: false;
2625:             referencedRelation: 'blueprint_branches';
2626:             referencedColumns: ['id'];
2627:           },
2628:           {
2629:             foreignKeyName: 'tasks_created_by_fkey';
2630:             columns: ['created_by'];
2631:             isOneToOne: false;
2632:             referencedRelation: 'accounts';
2633:             referencedColumns: ['id'];
2634:           },
2635:           {
2636:             foreignKeyName: 'tasks_parent_task_id_fkey';
2637:             columns: ['parent_task_id'];
2638:             isOneToOne: false;
2639:             referencedRelation: 'tasks';
2640:             referencedColumns: ['id'];
2641:           }
2642:         ];
2643:       };
2644:       team_members: {
2645:         Row: {
2646:           account_id: string;
2647:           id: string;
2648:           joined_at: string | null;
2649:           role: string | null;
2650:           team_id: string;
2651:         };
2652:         Insert: {
2653:           account_id: string;
2654:           id?: string;
2655:           joined_at?: string | null;
2656:           role?: string | null;
2657:           team_id: string;
2658:         };
2659:         Update: {
2660:           account_id?: string;
2661:           id?: string;
2662:           joined_at?: string | null;
2663:           role?: string | null;
2664:           team_id?: string;
2665:         };
2666:         Relationships: [
2667:           {
2668:             foreignKeyName: 'team_members_account_id_fkey';
2669:             columns: ['account_id'];
2670:             isOneToOne: false;
2671:             referencedRelation: 'accounts';
2672:             referencedColumns: ['id'];
2673:           },
2674:           {
2675:             foreignKeyName: 'team_members_team_id_fkey';
2676:             columns: ['team_id'];
2677:             isOneToOne: false;
2678:             referencedRelation: 'teams';
2679:             referencedColumns: ['id'];
2680:           }
2681:         ];
2682:       };
2683:       teams: {
2684:         Row: {
2685:           avatar_url: string | null;
2686:           created_at: string | null;
2687:           created_by: string;
2688:           description: string | null;
2689:           id: string;
2690:           name: string;
2691:           organization_id: string;
2692:           updated_at: string | null;
2693:         };
2694:         Insert: {
2695:           avatar_url?: string | null;
2696:           created_at?: string | null;
2697:           created_by: string;
2698:           description?: string | null;
2699:           id?: string;
2700:           name: string;
2701:           organization_id: string;
2702:           updated_at?: string | null;
2703:         };
2704:         Update: {
2705:           avatar_url?: string | null;
2706:           created_at?: string | null;
2707:           created_by?: string;
2708:           description?: string | null;
2709:           id?: string;
2710:           name?: string;
2711:           organization_id?: string;
2712:           updated_at?: string | null;
2713:         };
2714:         Relationships: [
2715:           {
2716:             foreignKeyName: 'teams_created_by_fkey';
2717:             columns: ['created_by'];
2718:             isOneToOne: false;
2719:             referencedRelation: 'accounts';
2720:             referencedColumns: ['id'];
2721:           },
2722:           {
2723:             foreignKeyName: 'teams_organization_id_fkey';
2724:             columns: ['organization_id'];
2725:             isOneToOne: false;
2726:             referencedRelation: 'accounts';
2727:             referencedColumns: ['id'];
2728:           }
2729:         ];
2730:       };
2731:       todo_status_tracking: {
2732:         Row: {
2733:           change_note: string | null;
2734:           changed_at: string | null;
2735:           changed_by: string | null;
2736:           from_status: string | null;
2737:           id: string;
2738:           to_status: string;
2739:           todo_id: string;
2740:         };
2741:         Insert: {
2742:           change_note?: string | null;
2743:           changed_at?: string | null;
2744:           changed_by?: string | null;
2745:           from_status?: string | null;
2746:           id?: string;
2747:           to_status: string;
2748:           todo_id: string;
2749:         };
2750:         Update: {
2751:           change_note?: string | null;
2752:           changed_at?: string | null;
2753:           changed_by?: string | null;
2754:           from_status?: string | null;
2755:           id?: string;
2756:           to_status?: string;
2757:           todo_id?: string;
2758:         };
2759:         Relationships: [
2760:           {
2761:             foreignKeyName: 'todo_status_tracking_changed_by_fkey';
2762:             columns: ['changed_by'];
2763:             isOneToOne: false;
2764:             referencedRelation: 'accounts';
2765:             referencedColumns: ['id'];
2766:           },
2767:           {
2768:             foreignKeyName: 'todo_status_tracking_todo_id_fkey';
2769:             columns: ['todo_id'];
2770:             isOneToOne: false;
2771:             referencedRelation: 'personal_todos';
2772:             referencedColumns: ['id'];
2773:           }
2774:         ];
2775:       };
2776:       user_roles: {
2777:         Row: {
2778:           account_id: string;
2779:           blueprint_id: string | null;
2780:           branch_id: string | null;
2781:           granted_at: string | null;
2782:           granted_by: string | null;
2783:           id: string;
2784:           role_id: string;
2785:         };
2786:         Insert: {
2787:           account_id: string;
2788:           blueprint_id?: string | null;
2789:           branch_id?: string | null;
2790:           granted_at?: string | null;
2791:           granted_by?: string | null;
2792:           id?: string;
2793:           role_id: string;
2794:         };
2795:         Update: {
2796:           account_id?: string;
2797:           blueprint_id?: string | null;
2798:           branch_id?: string | null;
2799:           granted_at?: string | null;
2800:           granted_by?: string | null;
2801:           id?: string;
2802:           role_id?: string;
2803:         };
2804:         Relationships: [
2805:           {
2806:             foreignKeyName: 'user_roles_account_id_fkey';
2807:             columns: ['account_id'];
2808:             isOneToOne: false;
2809:             referencedRelation: 'accounts';
2810:             referencedColumns: ['id'];
2811:           },
2812:           {
2813:             foreignKeyName: 'user_roles_blueprint_id_fkey';
2814:             columns: ['blueprint_id'];
2815:             isOneToOne: false;
2816:             referencedRelation: 'blueprints';
2817:             referencedColumns: ['id'];
2818:           },
2819:           {
2820:             foreignKeyName: 'user_roles_branch_id_fkey';
2821:             columns: ['branch_id'];
2822:             isOneToOne: false;
2823:             referencedRelation: 'blueprint_branches';
2824:             referencedColumns: ['id'];
2825:           },
2826:           {
2827:             foreignKeyName: 'user_roles_granted_by_fkey';
2828:             columns: ['granted_by'];
2829:             isOneToOne: false;
2830:             referencedRelation: 'accounts';
2831:             referencedColumns: ['id'];
2832:           },
2833:           {
2834:             foreignKeyName: 'user_roles_role_id_fkey';
2835:             columns: ['role_id'];
2836:             isOneToOne: false;
2837:             referencedRelation: 'roles';
2838:             referencedColumns: ['id'];
2839:           }
2840:         ];
2841:       };
2842:       weather_cache: {
2843:         Row: {
2844:           api_source: string | null;
2845:           expires_at: string;
2846:           fetched_at: string | null;
2847:           forecast_date: string;
2848:           id: string;
2849:           location: string;
2850:           weather_data: Json;
2851:         };
2852:         Insert: {
2853:           api_source?: string | null;
2854:           expires_at: string;
2855:           fetched_at?: string | null;
2856:           forecast_date: string;
2857:           id?: string;
2858:           location: string;
2859:           weather_data: Json;
2860:         };
2861:         Update: {
2862:           api_source?: string | null;
2863:           expires_at?: string;
2864:           fetched_at?: string | null;
2865:           forecast_date?: string;
2866:           id?: string;
2867:           location?: string;
2868:           weather_data?: Json;
2869:         };
2870:         Relationships: [];
2871:       };
2872:     };
2873:     Views: Record<never, never>;
2874:     Functions: {
2875:       text2ltree: { Args: { '': string }; Returns: unknown };
2876:     };
2877:     Enums: Record<never, never>;
2878:     CompositeTypes: Record<never, never>;
2879:   };
2880: }
2881: 
2882: type DatabaseWithoutInternals = Omit<Database, '__InternalSupabase'>;
2883: 
2884: type DefaultSchema = DatabaseWithoutInternals[Extract<keyof Database, 'public'>];
2885: 
2886: export type Tables<
2887:   DefaultSchemaTableNameOrOptions extends
2888:     | keyof (DefaultSchema['Tables'] & DefaultSchema['Views'])
2889:     | { schema: keyof DatabaseWithoutInternals },
2890:   TableName extends DefaultSchemaTableNameOrOptions extends {
2891:     schema: keyof DatabaseWithoutInternals;
2892:   }
2893:     ? keyof (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions['schema']]['Tables'] &
2894:         DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions['schema']]['Views'])
2895:     : never = never
2896: > = DefaultSchemaTableNameOrOptions extends {
2897:   schema: keyof DatabaseWithoutInternals;
2898: }
2899:   ? (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions['schema']]['Tables'] &
2900:       DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions['schema']]['Views'])[TableName] extends {
2901:       Row: infer R;
2902:     }
2903:     ? R
2904:     : never
2905:   : DefaultSchemaTableNameOrOptions extends keyof (DefaultSchema['Tables'] & DefaultSchema['Views'])
2906:     ? (DefaultSchema['Tables'] & DefaultSchema['Views'])[DefaultSchemaTableNameOrOptions] extends {
2907:         Row: infer R;
2908:       }
2909:       ? R
2910:       : never
2911:     : never;
2912: 
2913: export type TablesInsert<
2914:   DefaultSchemaTableNameOrOptions extends keyof DefaultSchema['Tables'] | { schema: keyof DatabaseWithoutInternals },
2915:   TableName extends DefaultSchemaTableNameOrOptions extends {
2916:     schema: keyof DatabaseWithoutInternals;
2917:   }
2918:     ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions['schema']]['Tables']
2919:     : never = never
2920: > = DefaultSchemaTableNameOrOptions extends {
2921:   schema: keyof DatabaseWithoutInternals;
2922: }
2923:   ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions['schema']]['Tables'][TableName] extends {
2924:       Insert: infer I;
2925:     }
2926:     ? I
2927:     : never
2928:   : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema['Tables']
2929:     ? DefaultSchema['Tables'][DefaultSchemaTableNameOrOptions] extends {
2930:         Insert: infer I;
2931:       }
2932:       ? I
2933:       : never
2934:     : never;
2935: 
2936: export type TablesUpdate<
2937:   DefaultSchemaTableNameOrOptions extends keyof DefaultSchema['Tables'] | { schema: keyof DatabaseWithoutInternals },
2938:   TableName extends DefaultSchemaTableNameOrOptions extends {
2939:     schema: keyof DatabaseWithoutInternals;
2940:   }
2941:     ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions['schema']]['Tables']
2942:     : never = never
2943: > = DefaultSchemaTableNameOrOptions extends {
2944:   schema: keyof DatabaseWithoutInternals;
2945: }
2946:   ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions['schema']]['Tables'][TableName] extends {
2947:       Update: infer U;
2948:     }
2949:     ? U
2950:     : never
2951:   : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema['Tables']
2952:     ? DefaultSchema['Tables'][DefaultSchemaTableNameOrOptions] extends {
2953:         Update: infer U;
2954:       }
2955:       ? U
2956:       : never
2957:     : never;
2958: 
2959: export type Enums<
2960:   DefaultSchemaEnumNameOrOptions extends keyof DefaultSchema['Enums'] | { schema: keyof DatabaseWithoutInternals },
2961:   EnumName extends DefaultSchemaEnumNameOrOptions extends {
2962:     schema: keyof DatabaseWithoutInternals;
2963:   }
2964:     ? keyof DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions['schema']]['Enums']
2965:     : never = never
2966: > = DefaultSchemaEnumNameOrOptions extends {
2967:   schema: keyof DatabaseWithoutInternals;
2968: }
2969:   ? DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions['schema']]['Enums'][EnumName]
2970:   : DefaultSchemaEnumNameOrOptions extends keyof DefaultSchema['Enums']
2971:     ? DefaultSchema['Enums'][DefaultSchemaEnumNameOrOptions]
2972:     : never;
2973: 
2974: export type CompositeTypes<
2975:   PublicCompositeTypeNameOrOptions extends keyof DefaultSchema['CompositeTypes'] | { schema: keyof DatabaseWithoutInternals },
2976:   CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {
2977:     schema: keyof DatabaseWithoutInternals;
2978:   }
2979:     ? keyof DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions['schema']]['CompositeTypes']
2980:     : never = never
2981: > = PublicCompositeTypeNameOrOptions extends {
2982:   schema: keyof DatabaseWithoutInternals;
2983: }
2984:   ? DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions['schema']]['CompositeTypes'][CompositeTypeName]
2985:   : PublicCompositeTypeNameOrOptions extends keyof DefaultSchema['CompositeTypes']
2986:     ? DefaultSchema['CompositeTypes'][PublicCompositeTypeNameOrOptions]
2987:     : never;
2988: 
2989: export const Constants = {
2990:   public: {
2991:     Enums: {}
2992:   }
2993: } as const;
````

## File: src/app/core/permissions/types.ts
````typescript
 1: /**
 2:  * æƒé™æœåŠ¡ç±»å‹å®šä¹‰
 3:  *
 4:  * å‚è€ƒ docs/30-0-å®Œæ•´SQLè¡¨çµæ§‹å®šç¾©.md ä¸­çš„æƒé™è¡¨ç»“æ„
 5:  */
 6: 
 7: /**
 8:  * è§’è‰²å®šä¹‰
 9:  * å¯¹åº” roles è¡¨
10:  */
11: export interface Role {
12:   id: string;
13:   name: string;
14:   code: string;
15:   description?: string;
16:   is_system_role: boolean;
17:   priority: number;
18:   created_at?: string;
19:   updated_at?: string;
20: }
21: 
22: /**
23:  * æƒé™å®šä¹‰
24:  * å¯¹åº” permissions è¡¨
25:  */
26: export interface Permission {
27:   id: string;
28:   name: string;
29:   resource: string;
30:   action: string;
31:   description?: string;
32:   is_system_permission?: boolean;
33:   created_at?: string;
34: }
35: 
36: /**
37:  * ç”¨æˆ·è§’è‰²å…³è”
38:  * å¯¹åº” user_roles è¡¨
39:  */
40: export interface UserRole {
41:   id: string;
42:   account_id: string;
43:   role_id: string;
44:   blueprint_id?: string | null;
45:   branch_id?: string | null;
46:   granted_by?: string | null;
47:   granted_at?: string;
48:   // å…³è”æŸ¥è¯¢æ—¶åŒ…å«çš„è§’è‰²ä¿¡æ¯
49:   roles?: Role;
50: }
51: 
52: // BranchPermission å·²ç§»è‡³ @shared/models/permission
53: // æ­¤è™•ä¸å†å°å‡ºï¼Œé¿å…é‡è¤‡å°å‡ºéŒ¯èª¤
54: 
55: /**
56:  * æƒé™æ£€æŸ¥ç»“æœ
57:  */
58: export interface PermissionCheckResult {
59:   hasPermission: boolean;
60:   reason?: string;
61: }
62: 
63: /**
64:  * æƒé™ç¼“å­˜é¡¹
65:  */
66: export interface PermissionCacheItem {
67:   permission: string;
68:   hasPermission: boolean;
69:   expiresAt: number;
70:   roles?: string[];
71:   abilities?: string[];
72: }
````

## File: src/app/core/services/branch-context.service.ts
````typescript
  1: import { Injectable, inject, signal, computed } from '@angular/core';
  2: import { BlueprintBranch, BranchService } from '@shared';
  3: 
  4: /**
  5:  * Branch Context Service
  6:  *
  7:  * ç®¡ç†ç•¶å‰é¸ä¸­çš„åˆ†æ”¯ä¸Šä¸‹æ–‡ï¼Œç”¨æ–¼æ•¸æ“šéš”é›¢
  8:  * ç¢ºä¿Repositoryå±¤å’ŒServiceå±¤èƒ½å¤ æ ¹æ“šç•¶å‰åˆ†æ”¯éæ¿¾æ•¸æ“š
  9:  *
 10:  * @example
 11:  * ```typescript
 12:  * const branchContext = inject(BranchContextService);
 13:  *
 14:  * // è¨­ç½®ç•¶å‰åˆ†æ”¯
 15:  * branchContext.setCurrentBranch(branch);
 16:  *
 17:  * // ç²å–ç•¶å‰åˆ†æ”¯
 18:  * const currentBranch = branchContext.currentBranch();
 19:  *
 20:  * // æª¢æŸ¥æ˜¯å¦åœ¨ä¸»åˆ†æ”¯
 21:  * const isMainBranch = branchContext.isMainBranch();
 22:  * ```
 23:  */
 24: @Injectable({
 25:   providedIn: 'root'
 26: })
 27: export class BranchContextService {
 28:   private branchService = inject(BranchService);
 29: 
 30:   // ç•¶å‰åˆ†æ”¯ç‹€æ…‹ï¼ˆnullè¡¨ç¤ºä¸»åˆ†æ”¯ï¼‰
 31:   private currentBranchState = signal<BlueprintBranch | null>(null);
 32: 
 33:   // æš´éœ² ReadonlySignal çµ¦çµ„ä»¶
 34:   readonly currentBranch = this.currentBranchState.asReadonly();
 35: 
 36:   // Computed signals
 37:   readonly isMainBranch = computed(() => this.currentBranchState() === null);
 38:   readonly isOrganizationBranch = computed(() => this.currentBranchState() !== null);
 39:   readonly currentBranchId = computed(() => this.currentBranchState()?.id || null);
 40:   readonly currentBlueprintId = computed(() => {
 41:     const branch = this.currentBranchState();
 42:     return branch?.blueprint_id || null;
 43:   });
 44: 
 45:   /**
 46:    * è¨­ç½®ç•¶å‰åˆ†æ”¯
 47:    *
 48:    * @param branch åˆ†æ”¯å°è±¡ï¼Œnullè¡¨ç¤ºåˆ‡æ›åˆ°ä¸»åˆ†æ”¯
 49:    */
 50:   setCurrentBranch(branch: BlueprintBranch | null): void {
 51:     this.currentBranchState.set(branch);
 52:     // åŒæ™‚æ›´æ–°BranchServiceçš„é¸ä¸­ç‹€æ…‹
 53:     this.branchService.selectBranch(branch);
 54:   }
 55: 
 56:   /**
 57:    * æ ¹æ“šåˆ†æ”¯IDè¨­ç½®ç•¶å‰åˆ†æ”¯
 58:    *
 59:    * @param branchId åˆ†æ”¯IDï¼Œnullè¡¨ç¤ºåˆ‡æ›åˆ°ä¸»åˆ†æ”¯
 60:    */
 61:   async setCurrentBranchById(branchId: string | null): Promise<void> {
 62:     if (!branchId) {
 63:       this.setCurrentBranch(null);
 64:       return;
 65:     }
 66: 
 67:     try {
 68:       const branch = await this.branchService.loadBranchById(branchId);
 69:       if (branch) {
 70:         this.setCurrentBranch(branch);
 71:       } else {
 72:         throw new Error('åˆ†æ”¯ä¸å­˜åœ¨');
 73:       }
 74:     } catch (error) {
 75:       throw new Error(`è¨­ç½®ç•¶å‰åˆ†æ”¯å¤±æ•—: ${error instanceof Error ? error.message : 'æœªçŸ¥éŒ¯èª¤'}`);
 76:     }
 77:   }
 78: 
 79:   /**
 80:    * æ¸…é™¤ç•¶å‰åˆ†æ”¯ï¼ˆåˆ‡æ›åˆ°ä¸»åˆ†æ”¯ï¼‰
 81:    */
 82:   clearCurrentBranch(): void {
 83:     this.setCurrentBranch(null);
 84:   }
 85: 
 86:   /**
 87:    * æª¢æŸ¥ç•¶å‰åˆ†æ”¯æ˜¯å¦ç‚ºæŒ‡å®šåˆ†æ”¯
 88:    *
 89:    * @param branchId åˆ†æ”¯ID
 90:    * @returns æ˜¯å¦ç‚ºç•¶å‰åˆ†æ”¯
 91:    */
 92:   isCurrentBranch(branchId: string): boolean {
 93:     return this.currentBranchState()?.id === branchId;
 94:   }
 95: 
 96:   /**
 97:    * æª¢æŸ¥ç•¶å‰åˆ†æ”¯æ˜¯å¦å±¬æ–¼æŒ‡å®šè—åœ–
 98:    *
 99:    * @param blueprintId è—åœ–ID
100:    * @returns æ˜¯å¦å±¬æ–¼è©²è—åœ–
101:    */
102:   belongsToBlueprint(blueprintId: string): boolean {
103:     return this.currentBlueprintId() === blueprintId;
104:   }
105: }
````

## File: src/app/layout/basic/basic.component.ts
````typescript
  1: import { Component, computed, effect, inject, OnInit, signal } from '@angular/core';
  2: import { RouterLink, RouterOutlet } from '@angular/router';
  3: import { MenuContextService } from '@core';
  4: import { DA_SERVICE_TOKEN } from '@delon/auth';
  5: import { I18nPipe, SettingsService, User } from '@delon/theme';
  6: import { LayoutDefaultModule, LayoutDefaultOptions } from '@delon/theme/layout-default';
  7: import { SettingDrawerModule } from '@delon/theme/setting-drawer';
  8: import { ThemeBtnComponent } from '@delon/theme/theme-btn';
  9: import { environment } from '@env/environment';
 10: import { Account, AccountService } from '@shared';
 11: import { NzAvatarModule } from 'ng-zorro-antd/avatar';
 12: import { NzDividerModule } from 'ng-zorro-antd/divider';
 13: import { NzDropDownModule } from 'ng-zorro-antd/dropdown';
 14: import { NzIconModule } from 'ng-zorro-antd/icon';
 15: import { NzMenuModule } from 'ng-zorro-antd/menu';
 16: 
 17: import { HeaderClearStorageComponent } from './widgets/clear-storage.component';
 18: import { HeaderContextSwitcherComponent } from './widgets/context-switcher.component';
 19: import { HeaderFullScreenComponent } from './widgets/fullscreen.component';
 20: import { HeaderI18nComponent } from './widgets/i18n.component';
 21: import { HeaderIconComponent } from './widgets/icon.component';
 22: import { HeaderNotifyComponent } from './widgets/notify.component';
 23: import { HeaderRTLComponent } from './widgets/rtl.component';
 24: import { HeaderSearchComponent } from './widgets/search.component';
 25: import { HeaderTaskComponent } from './widgets/task.component';
 26: import { HeaderUserComponent } from './widgets/user.component';
 27: 
 28: @Component({
 29:   selector: 'layout-basic',
 30:   template: `
 31:     <layout-default [options]="options" [asideUser]="asideUserTpl" [content]="contentTpl" [customError]="null">
 32:       <layout-default-header-item direction="left">
 33:         <a layout-default-header-item-trigger href="//github.com/ng-alain/ng-alain-gighub" target="_blank">
 34:           <i nz-icon nzType="github"></i>
 35:         </a>
 36:       </layout-default-header-item>
 37:       <layout-default-header-item direction="left" hidden="mobile">
 38:         <a layout-default-header-item-trigger routerLink="/passport/lock">
 39:           <i nz-icon nzType="lock"></i>
 40:         </a>
 41:       </layout-default-header-item>
 42:       <layout-default-header-item direction="left" hidden="pc">
 43:         <div layout-default-header-item-trigger (click)="searchToggleStatus = !searchToggleStatus">
 44:           <i nz-icon nzType="search"></i>
 45:         </div>
 46:       </layout-default-header-item>
 47:       <layout-default-header-item direction="middle">
 48:         <header-search class="alain-default__search" [(toggleChange)]="searchToggleStatus" />
 49:       </layout-default-header-item>
 50:       <layout-default-header-item direction="right">
 51:         <header-notify />
 52:       </layout-default-header-item>
 53:       <layout-default-header-item direction="right" hidden="mobile">
 54:         <header-task />
 55:       </layout-default-header-item>
 56:       <layout-default-header-item direction="right" hidden="mobile">
 57:         <header-icon />
 58:       </layout-default-header-item>
 59:       <layout-default-header-item direction="right" hidden="mobile">
 60:         <header-context-switcher />
 61:       </layout-default-header-item>
 62:       <layout-default-header-item direction="right" hidden="mobile">
 63:         <div layout-default-header-item-trigger nz-dropdown [nzDropdownMenu]="settingsMenu" nzTrigger="click" nzPlacement="bottomRight">
 64:           <i nz-icon nzType="setting"></i>
 65:         </div>
 66:         <nz-dropdown-menu #settingsMenu="nzDropdownMenu">
 67:           <div nz-menu style="width: 200px;">
 68:             <div nz-menu-item>
 69:               <header-rtl />
 70:             </div>
 71:             <div nz-menu-item>
 72:               <header-fullscreen />
 73:             </div>
 74:             <div nz-menu-item>
 75:               <header-clear-storage />
 76:             </div>
 77:             <div nz-menu-item>
 78:               <header-i18n />
 79:             </div>
 80:           </div>
 81:         </nz-dropdown-menu>
 82:       </layout-default-header-item>
 83:       <layout-default-header-item direction="right">
 84:         <header-user />
 85:       </layout-default-header-item>
 86:       <ng-template #asideUserTpl>
 87:         <div nz-dropdown nzTrigger="click" [nzDropdownMenu]="userMenu" class="alain-default__aside-user">
 88:           <nz-avatar class="alain-default__aside-user-avatar" [nzSrc]="user.avatar" />
 89:           <div class="alain-default__aside-user-info">
 90:             <strong>{{ user.name }}</strong>
 91:             <p class="mb0">{{ user.email }}</p>
 92:           </div>
 93:         </div>
 94:         <nz-dropdown-menu #userMenu="nzDropdownMenu">
 95:           <ul nz-menu>
 96:             <li nz-menu-item routerLink="/pro/account/center">{{ 'menu.account.center' | i18n }}</li>
 97:             <li nz-menu-item routerLink="/pro/account/settings">{{ 'menu.account.settings' | i18n }}</li>
 98:             @if (allOrganizations().length > 0) {
 99:               <li nz-menu-divider></li>
100:               @for (org of allOrganizations(); track org.id) {
101:                 <li nz-menu-item (click)="switchToOrganization(org.id)">
102:                   <i nz-icon nzType="team" class="mr-sm"></i>
103:                   <span>{{ org.name }}</span>
104:                 </li>
105:               }
106:             }
107:           </ul>
108:         </nz-dropdown-menu>
109:       </ng-template>
110:       <ng-template #contentTpl>
111:         <router-outlet />
112:       </ng-template>
113:     </layout-default>
114:     @if (showSettingDrawer) {
115:       <setting-drawer />
116:     }
117:     <theme-btn />
118:   `,
119:   imports: [
120:     RouterOutlet,
121:     RouterLink,
122:     I18nPipe,
123:     LayoutDefaultModule,
124:     NzIconModule,
125:     NzMenuModule,
126:     NzDropDownModule,
127:     NzAvatarModule,
128:     NzDividerModule,
129:     SettingDrawerModule,
130:     ThemeBtnComponent,
131:     HeaderSearchComponent,
132:     HeaderNotifyComponent,
133:     HeaderTaskComponent,
134:     HeaderIconComponent,
135:     HeaderRTLComponent,
136:     HeaderI18nComponent,
137:     HeaderClearStorageComponent,
138:     HeaderFullScreenComponent,
139:     HeaderContextSwitcherComponent,
140:     HeaderUserComponent
141:   ]
142: })
143: export class LayoutBasicComponent implements OnInit {
144:   private readonly settings = inject(SettingsService);
145:   private readonly accountService = inject(AccountService);
146:   private readonly menuContextService = inject(MenuContextService);
147:   private readonly tokenService = inject(DA_SERVICE_TOKEN);
148: 
149:   // ç»„ç»‡åˆ—è¡¨çŠ¶æ€
150:   readonly createdOrganizations = signal<Account[]>([]);
151:   readonly joinedOrganizations = signal<Account[]>([]);
152:   readonly loadingOrganizations = signal<boolean>(false);
153: 
154:   // åˆå¹¶æ‰€æœ‰ç»„ç»‡ï¼ˆå»é‡ï¼‰
155:   readonly allOrganizations = computed(() => {
156:     const all = [...this.createdOrganizations(), ...this.joinedOrganizations()];
157:     // æ ¹æ® ID å»é‡
158:     const uniqueMap = new Map<string, Account>();
159:     all.forEach(org => {
160:       if (!uniqueMap.has(org.id)) {
161:         uniqueMap.set(org.id, org);
162:       }
163:     });
164:     return Array.from(uniqueMap.values());
165:   });
166: 
167:   options: LayoutDefaultOptions = {
168:     logoExpanded: `./assets/logo-full.svg`,
169:     logoCollapsed: `./assets/logo.svg`
170:   };
171:   searchToggleStatus = false;
172:   showSettingDrawer = true;
173: 
174:   get user(): User {
175:     return this.settings.user;
176:   }
177: 
178:   constructor() {
179:     // ç›‘å¬ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼Œè‡ªåŠ¨åŠ è½½ç»„ç»‡åˆ—è¡¨
180:     effect(() => {
181:       const token = this.tokenService.get();
182:       if (token?.['user']?.['id']) {
183:         this.loadUserOrganizations(token['user']['id']);
184:       }
185:     });
186:   }
187: 
188:   ngOnInit(): void {
189:     // å¦‚æœå·²æœ‰ tokenï¼Œç«‹å³åŠ è½½ç»„ç»‡åˆ—è¡¨
190:     const token = this.tokenService.get();
191:     if (token?.['user']?.['id']) {
192:       this.loadUserOrganizations(token['user']['id']);
193:     }
194:   }
195: 
196:   /**
197:    * åŠ è½½ç”¨æˆ·çš„ç»„ç»‡åˆ—è¡¨
198:    */
199:   private async loadUserOrganizations(authUserId: string): Promise<void> {
200:     this.loadingOrganizations.set(true);
201: 
202:     try {
203:       // 1. è·å–ç”¨æˆ·è´¦æˆ·ä¿¡æ¯
204:       const userAccount = await this.accountService.findByAuthUserId(authUserId);
205:       if (!userAccount) {
206:         this.loadingOrganizations.set(false);
207:         return;
208:       }
209: 
210:       // 2. å¹¶è¡ŒåŠ è½½å»ºç«‹çš„ç»„ç»‡å’ŒåŠ å…¥çš„ç»„ç»‡
211:       const [createdOrgs, joinedOrgs] = await Promise.all([
212:         this.accountService.getUserCreatedOrganizations(authUserId),
213:         this.accountService.getUserJoinedOrganizations(userAccount.id)
214:       ]);
215: 
216:       this.createdOrganizations.set(createdOrgs);
217:       this.joinedOrganizations.set(joinedOrgs);
218:     } catch (error) {
219:       console.error('åŠ è½½ç”¨æˆ·ç»„ç»‡åˆ—è¡¨å¤±è´¥:', error);
220:     } finally {
221:       this.loadingOrganizations.set(false);
222:     }
223:   }
224: 
225:   /**
226:    * åˆ‡æ¢åˆ°ç»„ç»‡èœå•
227:    */
228:   switchToOrganization(organizationId: string): void {
229:     this.menuContextService.switchToOrganization(organizationId);
230:     // åŒæ—¶æ›´æ–° AccountService çš„é€‰ä¸­è´¦æˆ·
231:     const account = this.allOrganizations().find(org => org.id === organizationId);
232:     if (account) {
233:       this.accountService.selectAccount(account);
234:     }
235:   }
236: }
````

## File: src/app/routes/accounts/detail/account-detail.component.ts
````typescript
  1: import { Component, OnInit, computed, inject } from '@angular/core';
  2: import { ActivatedRoute, Router } from '@angular/router';
  3: import { isValidUUID } from '@core';
  4: import {
  5:   AccountService,
  6:   AccountStatus,
  7:   AccountType,
  8:   OrganizationMemberService,
  9:   OrganizationScheduleService,
 10:   SHARED_IMPORTS,
 11:   TeamService
 12: } from '@shared';
 13: import { NzMessageService } from 'ng-zorro-antd/message';
 14: 
 15: import { OrganizationRoleManageComponent } from '../organizations/organization-role-manage/organization-role-manage.component';
 16: 
 17: @Component({
 18:   selector: 'app-account-detail',
 19:   standalone: true,
 20:   imports: [SHARED_IMPORTS, OrganizationRoleManageComponent],
 21:   template: `
 22:     <page-header [title]="'è´¦æˆ·è¯¦æƒ…'">
 23:       <ng-template #extra>
 24:         <button nz-button nzType="default" (click)="goBack()" style="margin-right: 8px;">
 25:           <span nz-icon nzType="arrow-left"></span>
 26:           è¿”å›
 27:         </button>
 28:         @if (account()) {
 29:           <button nz-button nzType="primary" (click)="edit()" style="margin-right: 8px;">
 30:             <span nz-icon nzType="edit"></span>
 31:             ç¼–è¾‘
 32:           </button>
 33:           <button nz-button nzDanger (click)="delete()">
 34:             <span nz-icon nzType="delete"></span>
 35:             åˆ é™¤
 36:           </button>
 37:         }
 38:       </ng-template>
 39:     </page-header>
 40: 
 41:     @if (accountService.loading()) {
 42:       <nz-spin nzSimple [nzSize]="'large'" style="display: block; padding: 50px; text-align: center;">
 43:         <ng-template #indicator>
 44:           <span nz-icon nzType="loading" style="font-size: 24px;"></span>
 45:         </ng-template>
 46:       </nz-spin>
 47:     } @else if (accountService.error()) {
 48:       <nz-alert
 49:         nzType="error"
 50:         [nzMessage]="'åŠ è½½å¤±è´¥'"
 51:         [nzDescription]="accountService.error()"
 52:         nzShowIcon
 53:         style="margin: 16px;"
 54:       ></nz-alert>
 55:     } @else if (account()) {
 56:       <div style="padding: 16px;">
 57:         <!-- è´¦æˆ·åŸºæœ¬ä¿¡æ¯ -->
 58:         <nz-card nzTitle="åŸºæœ¬ä¿¡æ¯" style="margin-bottom: 16px;">
 59:           <nz-descriptions nzBordered [nzColumn]="{ xxl: 3, xl: 2, lg: 2, md: 1, sm: 1, xs: 1 }">
 60:             <nz-descriptions-item nzTitle="ID">{{ account()!.id }}</nz-descriptions-item>
 61:             <nz-descriptions-item nzTitle="åç§°">{{ account()!.name }}</nz-descriptions-item>
 62:             <nz-descriptions-item nzTitle="é‚®ç®±">{{ account()!.email || '-' }}</nz-descriptions-item>
 63:             <nz-descriptions-item nzTitle="ç±»å‹">
 64:               @switch (account()!.type) {
 65:                 @case ('User') {
 66:                   <nz-tag nzColor="blue">ç”¨æˆ·</nz-tag>
 67:                 }
 68:                 @case ('Bot') {
 69:                   <nz-tag nzColor="purple">æœºå™¨äºº</nz-tag>
 70:                 }
 71:                 @case ('Organization') {
 72:                   <nz-tag nzColor="green">ç»„ç»‡</nz-tag>
 73:                 }
 74:               }
 75:             </nz-descriptions-item>
 76:             <nz-descriptions-item nzTitle="çŠ¶æ€">
 77:               @switch (account()!.status) {
 78:                 @case ('active') {
 79:                   <nz-tag nzColor="success">æ´»è·ƒ</nz-tag>
 80:                 }
 81:                 @case ('inactive') {
 82:                   <nz-tag nzColor="default">éæ´»è·ƒ</nz-tag>
 83:                 }
 84:                 @case ('suspended') {
 85:                   <nz-tag nzColor="error">å·²æš‚åœ</nz-tag>
 86:                 }
 87:               }
 88:             </nz-descriptions-item>
 89:             <nz-descriptions-item nzTitle="åˆ›å»ºæ—¶é—´">
 90:               {{ account()!.created_at | date: 'yyyy-MM-dd HH:mm:ss' }}
 91:             </nz-descriptions-item>
 92:             <nz-descriptions-item nzTitle="æ›´æ–°æ—¶é—´">
 93:               {{ account()!.updated_at | date: 'yyyy-MM-dd HH:mm:ss' }}
 94:             </nz-descriptions-item>
 95:           </nz-descriptions>
 96:         </nz-card>
 97: 
 98:         <!-- ç»„ç»‡è´¦æˆ·ï¼šæ˜¾ç¤ºæˆå‘˜ç®¡ç† -->
 99:         @if (account()!.type === AccountType.ORGANIZATION) {
100:           <!-- ç»„ç»‡æˆå‘˜å’Œè§’è‰²ç®¡ç† -->
101:           @if (account()?.id) {
102:             <app-organization-role-manage [organizationId]="account()!.id"></app-organization-role-manage>
103:           }
104: 
105:           <!-- ç»„ç»‡è´¦æˆ·ï¼šæ˜¾ç¤ºå›¢é˜Ÿä¿¡æ¯ -->
106:           <nz-card nzTitle="å›¢é˜Ÿä¿¡æ¯" style="margin-bottom: 16px;">
107:             @if (teamService.loading()) {
108:               <nz-spin nzSimple></nz-spin>
109:             } @else if (teamService.teams().length > 0) {
110:               <nz-table [nzData]="teamService.teams()" [nzShowPagination]="false" [nzSize]="'small'">
111:                 <thead>
112:                   <tr>
113:                     <th>å›¢é˜Ÿåç§°</th>
114:                     <th>æè¿°</th>
115:                     <th>åˆ›å»ºæ—¶é—´</th>
116:                     <th>æ“ä½œ</th>
117:                   </tr>
118:                 </thead>
119:                 <tbody>
120:                   @for (team of teamService.teams(); track team.id) {
121:                     <tr>
122:                       <td>{{ team.name }}</td>
123:                       <td>{{ team.description || '-' }}</td>
124:                       <td>{{ team.created_at | date: 'yyyy-MM-dd' }}</td>
125:                       <td>
126:                         <button nz-button nzType="link" nzSize="small" (click)="viewTeam(team.id)"> æŸ¥çœ‹ </button>
127:                       </td>
128:                     </tr>
129:                   }
130:                 </tbody>
131:               </nz-table>
132:             } @else {
133:               <nz-empty nzNotFoundContent="æš‚æ— å›¢é˜Ÿ"></nz-empty>
134:             }
135:           </nz-card>
136: 
137:           <!-- ç»„ç»‡è´¦æˆ·ï¼šæ˜¾ç¤ºæ’ç­ä¿¡æ¯ -->
138:           <nz-card nzTitle="æ’ç­ä¿¡æ¯">
139:             @if (scheduleService.loading()) {
140:               <nz-spin nzSimple></nz-spin>
141:             } @else if (scheduleService.schedules().length > 0) {
142:               <nz-table [nzData]="scheduleService.schedules()" [nzShowPagination]="false" [nzSize]="'small'">
143:                 <thead>
144:                   <tr>
145:                     <th>æ—¥æœŸ</th>
146:                     <th>è´¦æˆ·</th>
147:                     <th>å›¢é˜Ÿ</th>
148:                     <th>å¤‡æ³¨</th>
149:                   </tr>
150:                 </thead>
151:                 <tbody>
152:                   @for (schedule of scheduleService.schedules(); track schedule.id) {
153:                     <tr>
154:                       <td>{{ schedule.schedule_date | date: 'yyyy-MM-dd' }}</td>
155:                       <td>{{ schedule.account_id || '-' }}</td>
156:                       <td>{{ schedule.team_id || '-' }}</td>
157:                       <td>{{ schedule.notes || '-' }}</td>
158:                     </tr>
159:                   }
160:                 </tbody>
161:               </nz-table>
162:             } @else {
163:               <nz-empty nzNotFoundContent="æš‚æ— æ’ç­è®°å½•"></nz-empty>
164:             }
165:           </nz-card>
166:         }
167:       </div>
168:     } @else {
169:       <nz-empty nzNotFoundContent="è´¦æˆ·ä¸å­˜åœ¨"></nz-empty>
170:     }
171:   `
172: })
173: export class AccountDetailComponent implements OnInit {
174:   accountService = inject(AccountService);
175:   teamService = inject(TeamService);
176:   scheduleService = inject(OrganizationScheduleService);
177:   organizationMemberService = inject(OrganizationMemberService);
178:   route = inject(ActivatedRoute);
179:   router = inject(Router);
180:   message = inject(NzMessageService);
181: 
182:   // ä½¿ç”¨ computed ä» Service è·å–è´¦æˆ·ä¿¡æ¯
183:   account = computed(() => this.accountService.selectedAccount());
184: 
185:   // å¯¼å‡ºæšä¸¾ä¾›æ¨¡æ¿ä½¿ç”¨
186:   AccountType = AccountType;
187:   AccountStatus = AccountStatus;
188: 
189:   ngOnInit(): void {
190:     const accountId = this.route.snapshot.paramMap.get('id');
191:     if (accountId) {
192:       // éªŒè¯ id æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ UUID æ ¼å¼ï¼Œé¿å…å°†é UUID å­—ç¬¦ä¸²ï¼ˆå¦‚ "users", "teams" ç­‰ï¼‰ä¼ é€’ç»™æ•°æ®åº“æŸ¥è¯¢
193:       if (!isValidUUID(accountId)) {
194:         // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„ UUIDï¼Œå¯èƒ½æ˜¯è·¯ç”±åŒ¹é…é”™è¯¯ï¼Œå¯¼èˆªå›è´¦æˆ·åˆ—è¡¨
195:         console.warn(`Invalid account ID format: ${accountId}. Redirecting to account list.`);
196:         this.goBack();
197:         return;
198:       }
199:       this.loadAccount(accountId);
200:     }
201:   }
202: 
203:   async loadAccount(id: string): Promise<void> {
204:     try {
205:       const account = await this.accountService.loadAccountById(id);
206:       if (account) {
207:         // å¦‚æœæ˜¯ç»„ç»‡è´¦æˆ·ï¼Œæ¸…ç©ºæˆå‘˜æœåŠ¡çŠ¶æ€å¹¶åŠ è½½ç›¸å…³ä¿¡æ¯
208:         if (account.type === AccountType.ORGANIZATION) {
209:           // æ¸…ç©ºç»„ç»‡æˆå‘˜æœåŠ¡çŠ¶æ€ï¼Œç¡®ä¿åŠ è½½çš„æ˜¯å½“å‰ç»„ç»‡çš„æˆå‘˜
210:           this.organizationMemberService.clearState();
211:           await this.loadTeams(account.id);
212:           await this.loadSchedules(account.id);
213:         }
214:       } else {
215:         this.message.warning('è´¦æˆ·ä¸å­˜åœ¨');
216:         this.goBack();
217:       }
218:     } catch (error) {
219:       this.message.error('åŠ è½½è´¦æˆ·è¯¦æƒ…å¤±è´¥');
220:     }
221:   }
222: 
223:   async loadTeams(organizationId: string): Promise<void> {
224:     try {
225:       await this.teamService.loadTeamsByOrganizationId(organizationId);
226:     } catch (error) {
227:       // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ä¸»æµç¨‹
228:       console.error('åŠ è½½å›¢é˜Ÿä¿¡æ¯å¤±è´¥', error);
229:     }
230:   }
231: 
232:   async loadSchedules(organizationId: string): Promise<void> {
233:     try {
234:       await this.scheduleService.loadSchedulesByOrganizationId(organizationId);
235:     } catch (error) {
236:       // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ä¸»æµç¨‹
237:       console.error('åŠ è½½æ’ç­ä¿¡æ¯å¤±è´¥', error);
238:     }
239:   }
240: 
241:   goBack(): void {
242:     this.router.navigate(['/accounts']);
243:   }
244: 
245:   edit(): void {
246:     if (this.account()) {
247:       this.router.navigate(['/accounts', this.account()!.id, 'edit']);
248:     }
249:   }
250: 
251:   async delete(): Promise<void> {
252:     if (!this.account()) {
253:       return;
254:     }
255: 
256:     // ä½¿ç”¨ nz-modal ç¡®è®¤åˆ é™¤ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä½¿ç”¨ ModalHelperï¼‰
257:     if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤è´¦æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
258:       try {
259:         await this.accountService.deleteAccount(this.account()!.id);
260:         this.message.success('åˆ é™¤æˆåŠŸ');
261:         this.goBack();
262:       } catch (error) {
263:         this.message.error('åˆ é™¤å¤±è´¥');
264:       }
265:     }
266:   }
267: 
268:   viewTeam(teamId: string): void {
269:     this.router.navigate(['/accounts/teams', teamId]);
270:   }
271: }
````

## File: src/app/routes/accounts/organizations/organization-list/organization-list.component.ts
````typescript
  1: import { Component, OnInit, inject } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { AppError } from '@core';
  4: import { STColumn } from '@delon/abc/st';
  5: import { Account, AccountService, SHARED_IMPORTS } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: 
  8: @Component({
  9:   selector: 'app-organization-list',
 10:   standalone: true,
 11:   imports: [SHARED_IMPORTS],
 12:   template: `
 13:     <page-header [title]="'ç»„ç»‡ç®¡ç†'">
 14:       <ng-template #extra>
 15:         <button nz-button nzType="primary" (click)="createOrganization()">
 16:           <span nz-icon nzType="plus"></span>
 17:           æ–°å»ºç»„ç»‡
 18:         </button>
 19:       </ng-template>
 20:     </page-header>
 21: 
 22:     <nz-card nzTitle="ç®¡ç†ç³»ç»Ÿä¸­çš„æ‰€æœ‰ç»„ç»‡è´¦æˆ·" style="margin-top: 16px;">
 23:       <st
 24:         #st
 25:         [data]="organizations()"
 26:         [columns]="columns"
 27:         [loading]="loading()"
 28:         [page]="{ front: false, show: true, showSize: true }"
 29:         (change)="onTableChange($event)"
 30:       >
 31:         <ng-template #status let-record>
 32:           @switch (record.status) {
 33:             @case ('active') {
 34:               <nz-tag nzColor="success">æ´»è·ƒ</nz-tag>
 35:             }
 36:             @case ('inactive') {
 37:               <nz-tag nzColor="default">éæ´»è·ƒ</nz-tag>
 38:             }
 39:             @case ('suspended') {
 40:               <nz-tag nzColor="error">å·²æš‚åœ</nz-tag>
 41:             }
 42:           }
 43:         </ng-template>
 44:       </st>
 45:     </nz-card>
 46:   `
 47: })
 48: export class OrganizationListComponent implements OnInit {
 49:   accountService = inject(AccountService);
 50:   router = inject(Router);
 51:   message = inject(NzMessageService);
 52: 
 53:   organizations = this.accountService.organizationAccounts;
 54:   loading = this.accountService.loading;
 55: 
 56:   columns: STColumn[] = [
 57:     { title: 'ID', index: 'id', width: 100 },
 58:     { title: 'ç»„ç»‡åç§°', index: 'name', width: 200 },
 59:     { title: 'é‚®ç®±', index: 'email', width: 200 },
 60:     { title: 'çŠ¶æ€', index: 'status', width: 100, render: 'status' },
 61:     { title: 'åˆ›å»ºæ—¶é—´', index: 'created_at', type: 'date', width: 180 },
 62:     {
 63:       title: 'æ“ä½œ',
 64:       width: 250,
 65:       buttons: [
 66:         {
 67:           text: 'æŸ¥çœ‹',
 68:           click: (record: Account) => this.viewDetail(record.id)
 69:         },
 70:         {
 71:           text: 'ç¼–è¾‘',
 72:           click: (record: Account) => this.edit(record.id)
 73:         },
 74:         {
 75:           text: 'æˆå‘˜ç®¡ç†',
 76:           click: (record: Account) => this.manageMembers(record.id)
 77:         },
 78:         {
 79:           text: 'åˆ é™¤',
 80:           type: 'del',
 81:           pop: true,
 82:           click: (record: Account) => this.delete(record.id)
 83:         }
 84:       ]
 85:     }
 86:   ];
 87: 
 88:   ngOnInit(): void {
 89:     this.loadOrganizations();
 90:   }
 91: 
 92:   async loadOrganizations(): Promise<void> {
 93:     try {
 94:       await this.accountService.loadAccounts();
 95:       // organizationAccounts computed signal ä¼šè‡ªåŠ¨è¿‡æ»¤å‡ºç»„ç»‡ç±»å‹çš„è´¦æˆ·
 96:     } catch (error) {
 97:       // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
 98:       let errorMessage = 'åŠ è½½ç»„ç»‡åˆ—è¡¨å¤±è´¥';
 99: 
100:       if (error instanceof Error) {
101:         const appError = error as AppError;
102:         if (appError.type && appError.severity) {
103:           errorMessage = appError.message || errorMessage;
104:           if (appError.details) {
105:             errorMessage += `: ${appError.details}`;
106:           }
107:         } else {
108:           errorMessage = error.message || errorMessage;
109:         }
110:       }
111: 
112:       console.error('åŠ è½½ç»„ç»‡åˆ—è¡¨å¤±è´¥:', error);
113:       this.message.error(errorMessage, { nzDuration: 5000 });
114:     }
115:   }
116: 
117:   onTableChange(event: any): void {
118:     // å¤„ç†è¡¨æ ¼å˜åŒ–äº‹ä»¶ï¼ˆåˆ†é¡µã€æ’åºç­‰ï¼‰
119:   }
120: 
121:   createOrganization(): void {
122:     this.router.navigate(['/accounts/create/organization']);
123:   }
124: 
125:   viewDetail(id: string): void {
126:     this.router.navigate(['/accounts', id]);
127:   }
128: 
129:   edit(id: string): void {
130:     this.router.navigate(['/accounts', id, 'edit']);
131:   }
132: 
133:   manageMembers(id: string): void {
134:     // å¯¼èˆªåˆ°ç»„ç»‡è¯¦æƒ…é¡µé¢ï¼ˆå¯ä»¥åœ¨è¯¦æƒ…é¡µé¢ä¸­ç®¡ç†æˆå‘˜ï¼‰
135:     this.router.navigate(['/accounts', id]);
136:   }
137: 
138:   async delete(id: string): Promise<void> {
139:     try {
140:       await this.accountService.deleteAccount(id);
141:       this.message.success('åˆ é™¤æˆåŠŸ');
142:       await this.loadOrganizations();
143:     } catch (error) {
144:       // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
145:       let errorMessage = 'åˆ é™¤å¤±è´¥';
146: 
147:       if (error instanceof Error) {
148:         const appError = error as AppError;
149:         if (appError.type && appError.severity) {
150:           errorMessage = appError.message || errorMessage;
151:           if (appError.details) {
152:             errorMessage += `: ${appError.details}`;
153:           }
154:         } else {
155:           errorMessage = error.message || errorMessage;
156:         }
157:       }
158: 
159:       console.error('åˆ é™¤å¤±è´¥:', error);
160:       this.message.error(errorMessage, { nzDuration: 5000 });
161:     }
162:   }
163: }
````

## File: src/app/routes/accounts/organizations/organization-member/organization-member-add.component.ts
````typescript
  1: import { Component, inject, OnInit, signal } from '@angular/core';
  2: import { FormControl, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
  3: import { OrganizationMemberRole } from '@core';
  4: import { AccountService, OrganizationMemberService, SHARED_IMPORTS } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
  7: 
  8: export interface OrganizationMemberAddData {
  9:   organizationId: string;
 10: }
 11: 
 12: /**
 13:  * æ·»åŠ ç»„ç»‡æˆå‘˜ç»„ä»¶
 14:  * èŒè´£ï¼šä»…è´Ÿè´£æ·»åŠ æˆå‘˜ï¼Œé»˜è®¤è§’è‰²ä¸º MEMBER
 15:  * æ³¨æ„ï¼šè®¾ç½®æˆå‘˜è§’è‰²æ˜¯å•ç‹¬çš„åŠŸèƒ½ï¼Œä¸åœ¨æ­¤ç»„ä»¶ä¸­
 16:  */
 17: @Component({
 18:   selector: 'app-organization-member-add',
 19:   standalone: true,
 20:   imports: [SHARED_IMPORTS, ReactiveFormsModule],
 21:   template: `
 22:     <form nz-form [formGroup]="form" (ngSubmit)="submit()">
 23:       <nz-form-item>
 24:         <nz-form-label [nzSpan]="6" nzRequired>é€‰æ‹©æˆå‘˜</nz-form-label>
 25:         <nz-form-control [nzSpan]="18" [nzErrorTip]="'è¯·é€‰æ‹©æˆå‘˜'">
 26:           <nz-select
 27:             formControlName="accountId"
 28:             nzPlaceHolder="è¯·é€‰æ‹©ç”¨æˆ·è´¦æˆ·"
 29:             nzShowSearch
 30:             [nzLoading]="accountService.loading()"
 31:             style="width: 100%;"
 32:           >
 33:             @for (user of accountService.userAccounts(); track user.id) {
 34:               <nz-option [nzValue]="user.id" [nzLabel]="user.name || user.id"></nz-option>
 35:             }
 36:           </nz-select>
 37:         </nz-form-control>
 38:       </nz-form-item>
 39: 
 40:       <nz-alert
 41:         nzType="info"
 42:         nzMessage="æç¤º"
 43:         nzDescription="æ·»åŠ æˆå‘˜åï¼Œè¯¥ç”¨æˆ·å°†èƒ½å¤Ÿè®¿é—®ç»„ç»‡ç›¸å…³çš„èµ„æºå’Œæ•°æ®ã€‚æ–°æˆå‘˜é»˜è®¤è§’è‰²ä¸ºæ™®é€šæˆå‘˜ï¼Œå¯åœ¨æˆå‘˜åˆ—è¡¨ä¸­ä¿®æ”¹è§’è‰²ã€‚"
 44:         nzShowIcon
 45:         style="margin-bottom: 16px;"
 46:       ></nz-alert>
 47: 
 48:       <nz-form-item>
 49:         <nz-form-control [nzSpan]="18" [nzOffset]="6">
 50:           <button nz-button nzType="default" type="button" (click)="cancel()" [disabled]="submitting()" style="margin-right: 8px;">
 51:             å–æ¶ˆ
 52:           </button>
 53:           <button nz-button nzType="primary" type="submit" [nzLoading]="submitting()" [disabled]="!form.valid || submitting()">
 54:             æ·»åŠ æˆå‘˜
 55:           </button>
 56:         </nz-form-control>
 57:       </nz-form-item>
 58:     </form>
 59:   `
 60: })
 61: export class OrganizationMemberAddComponent implements OnInit {
 62:   private organizationMemberService = inject(OrganizationMemberService);
 63:   private modalRef = inject(NzModalRef);
 64:   private message = inject(NzMessageService);
 65:   readonly accountService = inject(AccountService);
 66: 
 67:   readonly data: OrganizationMemberAddData = inject(NZ_MODAL_DATA);
 68:   readonly submitting = signal(false);
 69: 
 70:   form = new FormGroup({
 71:     accountId: new FormControl('', { nonNullable: true, validators: [Validators.required] })
 72:   });
 73: 
 74:   async ngOnInit(): Promise<void> {
 75:     try {
 76:       await this.accountService.loadAccounts();
 77:     } catch (error) {
 78:       this.message.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
 79:     }
 80:   }
 81: 
 82:   async submit(): Promise<void> {
 83:     if (this.form.invalid) {
 84:       Object.values(this.form.controls).forEach(control => {
 85:         control.markAsTouched();
 86:         control.updateValueAndValidity({ onlySelf: true });
 87:       });
 88:       return;
 89:     }
 90: 
 91:     this.submitting.set(true);
 92:     try {
 93:       const accountId = this.form.value.accountId!;
 94:       await this.organizationMemberService.addMember({
 95:         organizationId: this.data.organizationId,
 96:         accountId,
 97:         role: OrganizationMemberRole.MEMBER
 98:       });
 99:       this.message.success('æˆå‘˜æ·»åŠ æˆåŠŸ');
100:       this.modalRef.close(true);
101:     } catch (error) {
102:       const errorMessage = error instanceof Error ? error.message : 'æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•';
103:       this.message.error(errorMessage);
104:     } finally {
105:       this.submitting.set(false);
106:     }
107:   }
108: 
109:   cancel(): void {
110:     this.modalRef.close(false);
111:   }
112: }
````

## File: src/app/routes/accounts/organizations/organization-member/organization-member-delete.component.ts
````typescript
 1: import { Component, inject, OnInit, signal } from '@angular/core';
 2: import { OrganizationMemberService, SHARED_IMPORTS } from '@shared';
 3: import { NzMessageService } from 'ng-zorro-antd/message';
 4: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
 5: 
 6: export interface OrganizationMemberDeleteData {
 7:   memberId: string;
 8:   accountName: string;
 9: }
10: 
11: /**
12:  * åˆ é™¤ç»„ç»‡æˆå‘˜ç¡®è®¤ç»„ä»¶
13:  * èŒè´£ï¼šç¡®è®¤åˆ é™¤ç»„ç»‡æˆå‘˜æ“ä½œ
14:  */
15: @Component({
16:   selector: 'app-organization-member-delete',
17:   standalone: true,
18:   imports: [SHARED_IMPORTS],
19:   template: `
20:     <div style="padding: 16px;">
21:       <nz-alert
22:         nzType="warning"
23:         nzMessage="è­¦å‘Š"
24:         [nzDescription]="'ç¡®å®šè¦ç§»é™¤æˆå‘˜ã€Œ' + data.accountName + 'ã€å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚'"
25:         nzShowIcon
26:         style="margin-bottom: 16px;"
27:       ></nz-alert>
28: 
29:       <div style="text-align: right; margin-top: 24px;">
30:         <button nz-button nzType="default" (click)="cancel()" [disabled]="submitting()" style="margin-right: 8px;">
31:           å–æ¶ˆ
32:         </button>
33:         <button nz-button nzType="primary" nzDanger (click)="confirm()" [nzLoading]="submitting()" [disabled]="submitting()">
34:           ç¡®è®¤ç§»é™¤
35:         </button>
36:       </div>
37:     </div>
38:   `
39: })
40: export class OrganizationMemberDeleteComponent implements OnInit {
41:   private organizationMemberService = inject(OrganizationMemberService);
42:   private modalRef = inject(NzModalRef);
43:   private message = inject(NzMessageService);
44: 
45:   readonly data: OrganizationMemberDeleteData = inject(NZ_MODAL_DATA);
46:   readonly submitting = signal(false);
47: 
48:   ngOnInit(): void {
49:     // ç»„ä»¶åˆå§‹åŒ–
50:   }
51: 
52:   async confirm(): Promise<void> {
53:     this.submitting.set(true);
54:     try {
55:       await this.organizationMemberService.removeMember(this.data.memberId);
56:       this.message.success('ç§»é™¤æˆåŠŸ');
57:       this.modalRef.close(true);
58:     } catch (error) {
59:       const errorMessage = error instanceof Error ? error.message : 'ç§»é™¤å¤±è´¥';
60:       this.message.error(errorMessage);
61:     } finally {
62:       this.submitting.set(false);
63:     }
64:   }
65: 
66:   cancel(): void {
67:     this.modalRef.close(false);
68:   }
69: }
````

## File: src/app/routes/accounts/organizations/organization-role-manage/organization-role-manage.component.ts
````typescript
  1: import { Component, OnInit, inject, input } from '@angular/core';
  2: import { OrganizationMember } from '@core';
  3: import { AccountService, OrganizationMemberService, SHARED_IMPORTS } from '@shared';
  4: import { NzMessageService } from 'ng-zorro-antd/message';
  5: import { NzModalService } from 'ng-zorro-antd/modal';
  6: 
  7: import { OrganizationMemberAddComponent } from '../organization-member/organization-member-add.component';
  8: import {
  9:   OrganizationMemberDeleteComponent,
 10:   OrganizationMemberDeleteData
 11: } from '../organization-member/organization-member-delete.component';
 12: import { OrganizationRoleEditComponent } from '../organization-role/organization-role-edit.component';
 13: 
 14: /**
 15:  * ç»„ç»‡æˆå‘˜å’Œè§’è‰²ç®¡ç†ç»„ä»¶
 16:  * èŒè´£ï¼šæ˜¾ç¤ºæˆå‘˜åˆ—è¡¨ã€æ·»åŠ æˆå‘˜ã€ç¼–è¾‘è§’è‰²ã€ç§»é™¤æˆå‘˜
 17:  */
 18: @Component({
 19:   selector: 'app-organization-role-manage',
 20:   standalone: true,
 21:   imports: [SHARED_IMPORTS],
 22:   template: `
 23:     <nz-card nzTitle="ç»„ç»‡æˆå‘˜" [nzExtra]="cardExtra" style="margin-bottom: 16px;">
 24:       <ng-template #cardExtra>
 25:         <button nz-button nzType="primary" nzSize="small" (click)="addMember()">
 26:           <span nz-icon nzType="plus"></span>
 27:           æ·»åŠ æˆå‘˜
 28:         </button>
 29:       </ng-template>
 30: 
 31:       @if (organizationMemberService.loading()) {
 32:         <nz-spin nzSimple [nzSize]="'large'" style="display: block; padding: 50px; text-align: center;"></nz-spin>
 33:       } @else if (organizationMemberService.error()) {
 34:         <nz-alert
 35:           nzType="error"
 36:           [nzMessage]="'åŠ è½½å¤±è´¥'"
 37:           [nzDescription]="organizationMemberService.error()"
 38:           nzShowIcon
 39:           style="margin: 16px;"
 40:         ></nz-alert>
 41:       } @else if (organizationMemberService.members().length > 0) {
 42:         <nz-table [nzData]="organizationMemberService.members()" [nzShowPagination]="false" [nzSize]="'small'">
 43:           <thead>
 44:             <tr>
 45:               <th>è´¦æˆ·åç§°</th>
 46:               <th>è§’è‰²</th>
 47:               <th>åŠ å…¥æ—¶é—´</th>
 48:               <th>æ“ä½œ</th>
 49:             </tr>
 50:           </thead>
 51:           <tbody>
 52:             @for (member of organizationMemberService.members(); track member.id) {
 53:               <tr>
 54:                 <td>{{ getAccountName(member.account_id) }}</td>
 55:                 <td>
 56:                   @switch (member.role) {
 57:                     @case ('owner') {
 58:                       <nz-tag nzColor="red">æ‹¥æœ‰è€…</nz-tag>
 59:                     }
 60:                     @case ('admin') {
 61:                       <nz-tag nzColor="orange">ç®¡ç†å‘˜</nz-tag>
 62:                     }
 63:                     @case ('member') {
 64:                       <nz-tag nzColor="blue">æˆå‘˜</nz-tag>
 65:                     }
 66:                   }
 67:                 </td>
 68:                 <td>{{ member.joined_at | date: 'yyyy-MM-dd' }}</td>
 69:                 <td>
 70:                   <button nz-button nzType="link" nzSize="small" (click)="editRole(member)">ç¼–è¾‘è§’è‰²</button>
 71:                   <button nz-button nzType="link" nzDanger nzSize="small" (click)="removeMember(member)">ç§»é™¤</button>
 72:                 </td>
 73:               </tr>
 74:             }
 75:           </tbody>
 76:         </nz-table>
 77:       } @else {
 78:         <nz-empty nzNotFoundContent="æš‚æ— æˆå‘˜"></nz-empty>
 79:       }
 80:     </nz-card>
 81:   `
 82: })
 83: export class OrganizationRoleManageComponent implements OnInit {
 84:   private accountService = inject(AccountService);
 85:   private message = inject(NzMessageService);
 86:   private modal = inject(NzModalService);
 87:   readonly organizationMemberService = inject(OrganizationMemberService);
 88: 
 89:   readonly organizationId = input.required<string>();
 90: 
 91:   async ngOnInit(): Promise<void> {
 92:     // å…ˆæ¸…ç©ºçŠ¶æ€ï¼Œç¡®ä¿åŠ è½½çš„æ˜¯å½“å‰ç»„ç»‡çš„æˆå‘˜
 93:     this.organizationMemberService.clearState();
 94:     await this.loadMembers();
 95:     
 96:     // å¦‚æœè´¦æˆ·åˆ—è¡¨ä¸ºç©ºï¼Œæ‰åŠ è½½è´¦æˆ·åˆ—è¡¨ä»¥ä¾¿æ˜¾ç¤ºè´¦æˆ·åç§°
 97:     // æ³¨æ„ï¼šä¸ç­‰å¾…åŠ è½½å®Œæˆï¼Œé¿å…é˜»å¡é¡µé¢æ¸²æŸ“
 98:     if (this.accountService.accounts().length === 0) {
 99:       this.accountService.loadAccounts().catch(error => {
100:         console.error('åŠ è½½è´¦æˆ·åˆ—è¡¨å¤±è´¥:', error);
101:       });
102:     }
103:   }
104: 
105:   /**
106:    * åŠ è½½ç»„ç»‡æˆå‘˜åˆ—è¡¨
107:    */
108:   async loadMembers(): Promise<void> {
109:     try {
110:       await this.organizationMemberService.loadMembersByOrganizationId(this.organizationId());
111:     } catch (error) {
112:       const errorMessage = error instanceof Error ? error.message : 'åŠ è½½æˆå‘˜åˆ—è¡¨å¤±è´¥';
113:       this.message.error(errorMessage);
114:     }
115:   }
116: 
117:   /**
118:    * æ·»åŠ æˆå‘˜
119:    */
120:   addMember(): void {
121:     const modalRef = this.modal.create({
122:       nzTitle: 'æ·»åŠ ç»„ç»‡æˆå‘˜',
123:       nzContent: OrganizationMemberAddComponent,
124:       nzData: {
125:         organizationId: this.organizationId()
126:       },
127:       nzWidth: 600,
128:       nzFooter: null
129:     });
130: 
131:     modalRef.afterClose.subscribe(result => {
132:       if (result) {
133:         this.loadMembers();
134:       }
135:     });
136:   }
137: 
138:   /**
139:    * ç¼–è¾‘è§’è‰²
140:    */
141:   editRole(member: OrganizationMember): void {
142:     const modalRef = this.modal.create({
143:       nzTitle: 'ç¼–è¾‘æˆå‘˜è§’è‰²',
144:       nzContent: OrganizationRoleEditComponent,
145:       nzData: {
146:         member
147:       },
148:       nzWidth: 500,
149:       nzFooter: null
150:     });
151: 
152:     modalRef.afterClose.subscribe(result => {
153:       if (result) {
154:         this.loadMembers();
155:       }
156:     });
157:   }
158: 
159:   /**
160:    * ç§»é™¤æˆå‘˜
161:    */
162:   removeMember(member: OrganizationMember): void {
163:     const accountName = this.getAccountName(member.account_id);
164:     const modalRef = this.modal.create({
165:       nzTitle: 'ç§»é™¤ç»„ç»‡æˆå‘˜',
166:       nzContent: OrganizationMemberDeleteComponent,
167:       nzData: {
168:         memberId: member.id,
169:         accountName
170:       } as OrganizationMemberDeleteData,
171:       nzWidth: 500,
172:       nzFooter: null
173:     });
174: 
175:     modalRef.afterClose.subscribe(result => {
176:       if (result) {
177:         this.loadMembers();
178:       }
179:     });
180:   }
181: 
182:   /**
183:    * è·å–è´¦æˆ·åç§°
184:    */
185:   getAccountName(accountId: string): string {
186:     const accounts = this.accountService.accounts();
187:     const account = accounts.find(a => a.id === accountId);
188:     return account?.name || accountId;
189:   }
190: }
````

## File: src/app/routes/accounts/organizations/organization-role/organization-role-edit.component.ts
````typescript
  1: import { Component, inject, OnInit, signal } from '@angular/core';
  2: import { FormControl, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
  3: import { OrganizationMember, OrganizationMemberRole } from '@core';
  4: import { OrganizationMemberService, SHARED_IMPORTS } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
  7: 
  8: export interface OrganizationRoleEditData {
  9:   member: OrganizationMember;
 10: }
 11: 
 12: /**
 13:  * ç¼–è¾‘ç»„ç»‡æˆå‘˜è§’è‰²ç»„ä»¶
 14:  * èŒè´£ï¼šä»…è´Ÿè´£ç¼–è¾‘å•ä¸ªæˆå‘˜çš„è§’è‰²
 15:  */
 16: @Component({
 17:   selector: 'app-organization-role-edit',
 18:   standalone: true,
 19:   imports: [SHARED_IMPORTS, ReactiveFormsModule],
 20:   template: `
 21:     <form nz-form [formGroup]="form" (ngSubmit)="submit()">
 22:       <nz-form-item>
 23:         <nz-form-label [nzSpan]="6" nzRequired>æˆå‘˜è´¦æˆ·</nz-form-label>
 24:         <nz-form-control [nzSpan]="18">
 25:           <input nz-input [value]="data.member.account_id" [disabled]="true" />
 26:         </nz-form-control>
 27:       </nz-form-item>
 28: 
 29:       <nz-form-item>
 30:         <nz-form-label [nzSpan]="6" nzRequired>è§’è‰²</nz-form-label>
 31:         <nz-form-control [nzSpan]="18" [nzErrorTip]="'è¯·é€‰æ‹©è§’è‰²'">
 32:           <nz-radio-group formControlName="role">
 33:             <label nz-radio [nzValue]="OrganizationMemberRole.OWNER">æ‹¥æœ‰è€…</label>
 34:             <label nz-radio [nzValue]="OrganizationMemberRole.ADMIN">ç®¡ç†å‘˜</label>
 35:             <label nz-radio [nzValue]="OrganizationMemberRole.MEMBER">æˆå‘˜</label>
 36:           </nz-radio-group>
 37:         </nz-form-control>
 38:       </nz-form-item>
 39: 
 40:       <nz-form-item>
 41:         <nz-form-control [nzSpan]="18" [nzOffset]="6">
 42:           <button nz-button nzType="default" type="button" (click)="cancel()" [disabled]="submitting()" style="margin-right: 8px;">
 43:             å–æ¶ˆ
 44:           </button>
 45:           <button nz-button nzType="primary" type="submit" [nzLoading]="submitting()" [disabled]="!form.valid || submitting()">
 46:             ä¿å­˜
 47:           </button>
 48:         </nz-form-control>
 49:       </nz-form-item>
 50:     </form>
 51:   `
 52: })
 53: export class OrganizationRoleEditComponent implements OnInit {
 54:   private organizationMemberService = inject(OrganizationMemberService);
 55:   private modalRef = inject(NzModalRef);
 56:   private message = inject(NzMessageService);
 57: 
 58:   readonly data: OrganizationRoleEditData = inject(NZ_MODAL_DATA);
 59:   readonly submitting = signal(false);
 60:   readonly OrganizationMemberRole = OrganizationMemberRole;
 61: 
 62:   form = new FormGroup({
 63:     role: new FormControl<OrganizationMemberRole>(OrganizationMemberRole.MEMBER, {
 64:       nonNullable: true,
 65:       validators: [Validators.required]
 66:     })
 67:   });
 68: 
 69:   ngOnInit(): void {
 70:     // è®¾ç½®å½“å‰è§’è‰²ï¼ˆç®€åŒ–é€»è¾‘ï¼Œå‚è€ƒå›¢é˜Ÿä»£ç ï¼‰
 71:     const currentRole =
 72:       this.data.member.role === OrganizationMemberRole.OWNER
 73:         ? OrganizationMemberRole.OWNER
 74:         : this.data.member.role === OrganizationMemberRole.ADMIN
 75:           ? OrganizationMemberRole.ADMIN
 76:           : OrganizationMemberRole.MEMBER;
 77:     this.form.controls.role.setValue(currentRole);
 78:   }
 79: 
 80:   async submit(): Promise<void> {
 81:     if (this.form.invalid) {
 82:       Object.values(this.form.controls).forEach(control => {
 83:         control.markAsTouched();
 84:         control.updateValueAndValidity({ onlySelf: true });
 85:       });
 86:       return;
 87:     }
 88: 
 89:     this.submitting.set(true);
 90:     try {
 91:       await this.organizationMemberService.updateMemberRole(this.data.member.id, this.form.value.role!);
 92:       this.message.success('è§’è‰²æ›´æ–°æˆåŠŸ');
 93:       this.modalRef.close(true);
 94:     } catch (error) {
 95:       const errorMessage = error instanceof Error ? error.message : 'æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•';
 96:       this.message.error(errorMessage);
 97:     } finally {
 98:       this.submitting.set(false);
 99:     }
100:   }
101: 
102:   cancel(): void {
103:     this.modalRef.close(false);
104:   }
105: }
````

## File: src/app/routes/accounts/teams/team-create/team-create.component.ts
````typescript
  1: import { Component, OnInit, inject } from '@angular/core';
  2: import { FormControl, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
  3: import { ActivatedRoute, Router } from '@angular/router';
  4: import { DA_SERVICE_TOKEN } from '@delon/auth';
  5: import { AccountService, SHARED_IMPORTS, TeamService } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
  8: 
  9: interface CreateTeamFormValue {
 10:   name: string;
 11:   description: string | null;
 12:   organizationId: string;
 13: }
 14: 
 15: export interface CreateTeamData {
 16:   organizationId: string | null;
 17: }
 18: 
 19: @Component({
 20:   selector: 'app-team-create',
 21:   standalone: true,
 22:   imports: [SHARED_IMPORTS, ReactiveFormsModule],
 23:   template: `
 24:     @if (isModalMode()) {
 25:       <!-- Modal æ¨¡å¼ï¼šçº¯è¡¨å• -->
 26:       <form nz-form [formGroup]="form" (ngSubmit)="onSubmit()">
 27:         <!-- ç»„ç»‡é€‰æ‹© -->
 28:         <nz-form-item>
 29:           <nz-form-label [nzSpan]="6" nzRequired>ç»„ç»‡</nz-form-label>
 30:           <nz-form-control [nzSpan]="18" [nzErrorTip]="'è¯·é€‰æ‹©ç»„ç»‡'">
 31:             <nz-select
 32:               formControlName="organizationId"
 33:               nzPlaceHolder="è¯·é€‰æ‹©ç»„ç»‡"
 34:               [nzLoading]="accountService.loading()"
 35:               style="width: 100%;"
 36:             >
 37:               @for (org of accountService.organizationAccounts(); track org.id) {
 38:                 <nz-option [nzValue]="org.id" [nzLabel]="org.name"></nz-option>
 39:               }
 40:             </nz-select>
 41:           </nz-form-control>
 42:         </nz-form-item>
 43: 
 44:         <!-- å›¢é˜Ÿåç§° -->
 45:         <nz-form-item>
 46:           <nz-form-label [nzSpan]="6" nzRequired>å›¢é˜Ÿåç§°</nz-form-label>
 47:           <nz-form-control [nzSpan]="18" [nzErrorTip]="'è¯·è¾“å…¥å›¢é˜Ÿåç§°'">
 48:             <input nz-input formControlName="name" placeholder="è¯·è¾“å…¥å›¢é˜Ÿåç§°" />
 49:           </nz-form-control>
 50:         </nz-form-item>
 51: 
 52:         <!-- æè¿° -->
 53:         <nz-form-item>
 54:           <nz-form-label [nzSpan]="6">æè¿°</nz-form-label>
 55:           <nz-form-control [nzSpan]="18">
 56:             <textarea nz-input rows="3" formControlName="description" placeholder="å¯é€‰ï¼Œç®€è¦æè¿°è¯¥å›¢é˜Ÿ"></textarea>
 57:           </nz-form-control>
 58:         </nz-form-item>
 59: 
 60:         <nz-form-item>
 61:           <nz-form-control [nzSpan]="18" [nzOffset]="6">
 62:             <button
 63:               nz-button
 64:               nzType="default"
 65:               type="button"
 66:               (click)="cancel()"
 67:               [disabled]="teamService.loading()"
 68:               style="margin-right: 8px;"
 69:             >
 70:               å–æ¶ˆ
 71:             </button>
 72:             <button nz-button nzType="primary" type="submit" [nzLoading]="teamService.loading()" [disabled]="form.invalid">
 73:               <span nz-icon nzType="save"></span>
 74:               åˆ›å»ºå›¢é˜Ÿ
 75:             </button>
 76:           </nz-form-control>
 77:         </nz-form-item>
 78:       </form>
 79:     } @else {
 80:       <!-- é¡µé¢æ¨¡å¼ï¼šå¸¦ page-header -->
 81:       <page-header [title]="'åˆ›å»ºå›¢é˜Ÿ'" [extra]="headerExtra">
 82:         <ng-template #headerExtra>
 83:           <button nz-button nzType="default" (click)="goBack()" style="margin-right: 8px;">
 84:             <span nz-icon nzType="arrow-left"></span>
 85:             è¿”å›
 86:           </button>
 87:         </ng-template>
 88:       </page-header>
 89: 
 90:       <div style="padding: 16px;">
 91:         <nz-card nzTitle="å›¢é˜Ÿä¿¡æ¯">
 92:           <form nz-form [formGroup]="form" (ngSubmit)="onSubmit()">
 93:             <!-- ç»„ç»‡é€‰æ‹© -->
 94:             <nz-form-item>
 95:               <nz-form-label [nzSpan]="4" nzRequired>ç»„ç»‡</nz-form-label>
 96:               <nz-form-control [nzSpan]="20" [nzErrorTip]="'è¯·é€‰æ‹©ç»„ç»‡'">
 97:                 <nz-select
 98:                   formControlName="organizationId"
 99:                   nzPlaceHolder="è¯·é€‰æ‹©ç»„ç»‡"
100:                   [nzLoading]="accountService.loading()"
101:                   style="width: 100%;"
102:                 >
103:                   @for (org of accountService.organizationAccounts(); track org.id) {
104:                     <nz-option [nzValue]="org.id" [nzLabel]="org.name"></nz-option>
105:                   }
106:                 </nz-select>
107:               </nz-form-control>
108:             </nz-form-item>
109: 
110:             <!-- å›¢é˜Ÿåç§° -->
111:             <nz-form-item>
112:               <nz-form-label [nzSpan]="4" nzRequired>å›¢é˜Ÿåç§°</nz-form-label>
113:               <nz-form-control [nzSpan]="20" [nzErrorTip]="'è¯·è¾“å…¥å›¢é˜Ÿåç§°'">
114:                 <input nz-input formControlName="name" placeholder="è¯·è¾“å…¥å›¢é˜Ÿåç§°" />
115:               </nz-form-control>
116:             </nz-form-item>
117: 
118:             <!-- æè¿° -->
119:             <nz-form-item>
120:               <nz-form-label [nzSpan]="4">æè¿°</nz-form-label>
121:               <nz-form-control [nzSpan]="20">
122:                 <textarea nz-input rows="3" formControlName="description" placeholder="å¯é€‰ï¼Œç®€è¦æè¿°è¯¥å›¢é˜Ÿ"></textarea>
123:               </nz-form-control>
124:             </nz-form-item>
125: 
126:             <nz-form-item>
127:               <nz-form-control [nzSpan]="24" [nzOffset]="4">
128:                 <button nz-button nzType="primary" [nzLoading]="teamService.loading()" [disabled]="form.invalid">
129:                   <span nz-icon nzType="save"></span>
130:                   åˆ›å»ºå›¢é˜Ÿ
131:                 </button>
132:                 <button nz-button nzType="default" type="button" (click)="goBack()" style="margin-left: 8px;"> å–æ¶ˆ </button>
133:               </nz-form-control>
134:             </nz-form-item>
135:           </form>
136:         </nz-card>
137:       </div>
138:     }
139:   `
140: })
141: export class TeamCreateComponent implements OnInit {
142:   readonly teamService = inject(TeamService);
143:   readonly accountService = inject(AccountService);
144:   readonly tokenService = inject(DA_SERVICE_TOKEN);
145:   readonly route = inject(ActivatedRoute);
146:   readonly router = inject(Router);
147:   readonly message = inject(NzMessageService);
148:   readonly modalRef = inject(NzModalRef, { optional: true });
149:   readonly modalData = inject<CreateTeamData>(NZ_MODAL_DATA, { optional: true });
150: 
151:   form = new FormGroup<{
152:     organizationId: FormControl<string>;
153:     name: FormControl<string>;
154:     description: FormControl<string | null>;
155:   }>({
156:     organizationId: new FormControl('', { nonNullable: true, validators: [Validators.required] }),
157:     name: new FormControl('', { nonNullable: true, validators: [Validators.required] }),
158:     description: new FormControl<string | null>(null)
159:   });
160: 
161:   // åˆ¤æ–­æ˜¯å¦ä¸º Modal æ¨¡å¼
162:   isModalMode(): boolean {
163:     return !!this.modalRef;
164:   }
165: 
166:   async ngOnInit(): Promise<void> {
167:     // åŠ è½½ç»„ç»‡è´¦æˆ·åˆ—è¡¨ä»¥ä¾¿é€‰æ‹©
168:     await this.accountService.loadAccounts();
169: 
170:     // ä¼˜å…ˆä½¿ç”¨ Modal ä¼ å…¥çš„ organizationIdï¼Œå¦åˆ™ä½¿ç”¨è·¯ç”±å‚æ•°
171:     const orgId = this.modalData?.organizationId || this.route.snapshot.queryParamMap.get('organizationId');
172:     if (orgId) {
173:       const exists = this.accountService.organizationAccounts().some(o => o.id === orgId);
174:       if (exists) this.form.controls.organizationId.setValue(orgId);
175:     }
176:   }
177: 
178:   async onSubmit(): Promise<void> {
179:     if (this.form.invalid) {
180:       Object.values(this.form.controls).forEach(c => {
181:         c.markAsTouched();
182:         c.updateValueAndValidity({ onlySelf: true });
183:       });
184:       return;
185:     }
186: 
187:     // è·å–å½“å‰ç”¨æˆ·çš„ account.id ä½œä¸ºåˆ›å»ºè€…
188:     const currentUserAuthId = this.tokenService.get()?.['user']?.id;
189:     if (!currentUserAuthId) {
190:       this.message.error('ç³»ç»Ÿé”™è¯¯ï¼šæ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯');
191:       return;
192:     }
193: 
194:     // æŸ¥æ‰¾å½“å‰ç”¨æˆ·å¯¹åº”çš„ account.id
195:     const userAccount = this.accountService.userAccounts().find(a => (a as any).authUserId === currentUserAuthId);
196:     if (!userAccount) {
197:       this.message.error('ç³»ç»Ÿé”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°ç”¨æˆ·è´¦æˆ·');
198:       return;
199:     }
200: 
201:     const value = this.form.value as CreateTeamFormValue;
202:     try {
203:       const team = await this.teamService.createTeam({
204:         name: value.name,
205:         description: value.description ?? undefined,
206:         organizationId: value.organizationId,
207:         createdBy: userAccount.id
208:       });
209:       this.message.success('åˆ›å»ºå›¢é˜ŸæˆåŠŸ');
210: 
211:       if (this.isModalMode()) {
212:         this.modalRef?.close(team);
213:       } else {
214:         this.router.navigate(['/accounts/teams', team.id]);
215:       }
216:     } catch (error) {
217:       const errorMessage = error instanceof Error ? error.message : 'åˆ›å»ºå›¢é˜Ÿå¤±è´¥';
218:       this.message.error(errorMessage);
219:     }
220:   }
221: 
222:   cancel(): void {
223:     if (this.isModalMode()) {
224:       this.modalRef?.close(false);
225:     }
226:   }
227: 
228:   goBack(): void {
229:     if (!this.isModalMode()) {
230:       this.router.navigate(['/accounts/teams']);
231:     }
232:   }
233: }
````

## File: src/app/routes/accounts/teams/team-delete/team-delete.component.ts
````typescript
 1: import { Component, inject, OnInit, signal } from '@angular/core';
 2: import { SHARED_IMPORTS, TeamService } from '@shared';
 3: import { NzMessageService } from 'ng-zorro-antd/message';
 4: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
 5: 
 6: export interface TeamDeleteData {
 7:   teamId: string;
 8:   teamName: string;
 9: }
10: 
11: /**
12:  * åˆ é™¤å›¢é˜Ÿç¡®è®¤ç»„ä»¶
13:  * èŒè´£ï¼šç¡®è®¤åˆ é™¤å›¢é˜Ÿæ“ä½œ
14:  */
15: @Component({
16:   selector: 'app-team-delete',
17:   standalone: true,
18:   imports: [SHARED_IMPORTS],
19:   template: `
20:     <div style="padding: 16px;">
21:       <nz-alert
22:         nzType="warning"
23:         nzMessage="è­¦å‘Š"
24:         [nzDescription]="'ç¡®å®šè¦åˆ é™¤å›¢é˜Ÿã€Œ' + data.teamName + 'ã€å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œå°†åŒæ—¶åˆ é™¤æ‰€æœ‰å›¢é˜Ÿæˆå‘˜å…³ç³»ã€‚'"
25:         nzShowIcon
26:         style="margin-bottom: 16px;"
27:       ></nz-alert>
28: 
29:       <div style="text-align: right; margin-top: 24px;">
30:         <button nz-button nzType="default" (click)="cancel()" [disabled]="submitting()" style="margin-right: 8px;">
31:           å–æ¶ˆ
32:         </button>
33:         <button nz-button nzType="primary" nzDanger (click)="confirm()" [nzLoading]="submitting()" [disabled]="submitting()">
34:           ç¡®è®¤åˆ é™¤
35:         </button>
36:       </div>
37:     </div>
38:   `
39: })
40: export class TeamDeleteComponent implements OnInit {
41:   private teamService = inject(TeamService);
42:   private modalRef = inject(NzModalRef);
43:   private message = inject(NzMessageService);
44: 
45:   readonly data: TeamDeleteData = inject(NZ_MODAL_DATA);
46:   readonly submitting = signal(false);
47: 
48:   ngOnInit(): void {
49:     // ç»„ä»¶åˆå§‹åŒ–
50:   }
51: 
52:   async confirm(): Promise<void> {
53:     this.submitting.set(true);
54:     try {
55:       await this.teamService.deleteTeam(this.data.teamId);
56:       this.message.success('åˆ é™¤æˆåŠŸ');
57:       this.modalRef.close(true);
58:     } catch (error) {
59:       const errorMessage = error instanceof Error ? error.message : 'åˆ é™¤å¤±è´¥';
60:       this.message.error(errorMessage);
61:     } finally {
62:       this.submitting.set(false);
63:     }
64:   }
65: 
66:   cancel(): void {
67:     this.modalRef.close(false);
68:   }
69: }
````

## File: src/app/routes/accounts/teams/team-edit/team-edit.component.ts
````typescript
  1: import { Component, OnInit, inject } from '@angular/core';
  2: import { FormControl, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
  3: import { ActivatedRoute, Router } from '@angular/router';
  4: import { TeamUpdate } from '@core';
  5: import { SHARED_IMPORTS, TeamService } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: 
  8: /**
  9:  * ç¼–è¾‘å›¢é˜Ÿç»„ä»¶
 10:  * èŒè´£ï¼šç¼–è¾‘å›¢é˜ŸåŸºæœ¬ä¿¡æ¯ï¼ˆåç§°ã€æè¿°ï¼‰
 11:  */
 12: @Component({
 13:   selector: 'app-team-edit',
 14:   standalone: true,
 15:   imports: [SHARED_IMPORTS, ReactiveFormsModule],
 16:   template: `
 17:     <page-header [title]="'ç¼–è¾‘å›¢é˜Ÿ'" [extra]="headerExtra">
 18:       <ng-template #headerExtra>
 19:         <button nz-button nzType="default" (click)="goBack()" style="margin-right: 8px;">
 20:           <span nz-icon nzType="arrow-left"></span>
 21:           è¿”å›
 22:         </button>
 23:       </ng-template>
 24:     </page-header>
 25: 
 26:     <div style="padding: 16px;">
 27:       @if (teamService.loading()) {
 28:         <nz-spin nzSimple [nzSize]="'large'" style="display: block; padding: 50px; text-align: center;"></nz-spin>
 29:       } @else if (teamService.error()) {
 30:         <nz-alert nzType="error" [nzMessage]="'åŠ è½½å¤±è´¥'" [nzDescription]="teamService.error()" nzShowIcon style="margin: 16px;"></nz-alert>
 31:       } @else {
 32:         <nz-card nzTitle="å›¢é˜Ÿä¿¡æ¯">
 33:           <form nz-form [formGroup]="form" (ngSubmit)="onSubmit()">
 34:             <!-- å›¢é˜Ÿåç§° -->
 35:             <nz-form-item>
 36:               <nz-form-label [nzSpan]="4" nzRequired>å›¢é˜Ÿåç§°</nz-form-label>
 37:               <nz-form-control [nzSpan]="20" [nzErrorTip]="'è¯·è¾“å…¥å›¢é˜Ÿåç§°'">
 38:                 <input nz-input formControlName="name" placeholder="è¯·è¾“å…¥å›¢é˜Ÿåç§°" />
 39:               </nz-form-control>
 40:             </nz-form-item>
 41: 
 42:             <!-- æè¿° -->
 43:             <nz-form-item>
 44:               <nz-form-label [nzSpan]="4">æè¿°</nz-form-label>
 45:               <nz-form-control [nzSpan]="20">
 46:                 <textarea nz-input rows="3" formControlName="description" placeholder="å¯é€‰ï¼Œç®€è¦æè¿°è¯¥å›¢é˜Ÿ"></textarea>
 47:               </nz-form-control>
 48:             </nz-form-item>
 49: 
 50:             <nz-form-item>
 51:               <nz-form-control [nzSpan]="24" [nzOffset]="4">
 52:                 <button nz-button nzType="primary" [nzLoading]="teamService.loading()" [disabled]="form.invalid">
 53:                   <span nz-icon nzType="save"></span>
 54:                   ä¿å­˜
 55:                 </button>
 56:                 <button nz-button nzType="default" type="button" (click)="goBack()" style="margin-left: 8px;"> å–æ¶ˆ </button>
 57:               </nz-form-control>
 58:             </nz-form-item>
 59:           </form>
 60:         </nz-card>
 61:       }
 62:     </div>
 63:   `
 64: })
 65: export class TeamEditComponent implements OnInit {
 66:   readonly teamService = inject(TeamService);
 67:   private route = inject(ActivatedRoute);
 68:   private router = inject(Router);
 69:   private message = inject(NzMessageService);
 70: 
 71:   form = new FormGroup<{
 72:     name: FormControl<string>;
 73:     description: FormControl<string | null>;
 74:   }>({
 75:     name: new FormControl('', { nonNullable: true, validators: [Validators.required] }),
 76:     description: new FormControl<string | null>(null)
 77:   });
 78: 
 79:   async ngOnInit(): Promise<void> {
 80:     const teamId = this.route.snapshot.paramMap.get('id');
 81:     if (!teamId) {
 82:       this.message.error('å›¢é˜ŸIDä¸å­˜åœ¨');
 83:       this.goBack();
 84:       return;
 85:     }
 86: 
 87:     try {
 88:       const team = await this.teamService.loadTeamById(teamId);
 89:       if (!team) {
 90:         this.message.warning('å›¢é˜Ÿä¸å­˜åœ¨');
 91:         this.goBack();
 92:         return;
 93:       }
 94: 
 95:       // å¡«å……è¡¨å•
 96:       this.form.patchValue({
 97:         name: team.name,
 98:         description: team.description
 99:       });
100:     } catch (error) {
101:       const errorMessage = error instanceof Error ? error.message : 'åŠ è½½å›¢é˜Ÿä¿¡æ¯å¤±è´¥';
102:       this.message.error(errorMessage);
103:     }
104:   }
105: 
106:   async onSubmit(): Promise<void> {
107:     if (this.form.invalid) {
108:       Object.values(this.form.controls).forEach(c => {
109:         c.markAsTouched();
110:         c.updateValueAndValidity({ onlySelf: true });
111:       });
112:       return;
113:     }
114: 
115:     const teamId = this.route.snapshot.paramMap.get('id');
116:     if (!teamId) {
117:       this.message.error('å›¢é˜ŸIDä¸å­˜åœ¨');
118:       return;
119:     }
120: 
121:     const value = this.form.value;
122:     try {
123:       const updateData: TeamUpdate = {
124:         name: value.name!,
125:         description: value.description ?? undefined
126:       };
127: 
128:       await this.teamService.updateTeam(teamId, updateData);
129:       this.message.success('æ›´æ–°æˆåŠŸ');
130:       this.router.navigate(['/accounts/teams', teamId]);
131:     } catch (error) {
132:       const errorMessage = error instanceof Error ? error.message : 'æ›´æ–°å¤±è´¥';
133:       this.message.error(errorMessage);
134:     }
135:   }
136: 
137:   goBack(): void {
138:     const teamId = this.route.snapshot.paramMap.get('id');
139:     if (teamId) {
140:       this.router.navigate(['/accounts/teams', teamId]);
141:     } else {
142:       this.router.navigate(['/accounts/teams']);
143:     }
144:   }
145: }
````

## File: src/app/routes/accounts/teams/team-member/team-member-add.component.ts
````typescript
  1: import { Component, inject, OnInit, signal } from '@angular/core';
  2: import { FormControl, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
  3: import { TeamMemberInsert, TeamMemberRepository, TeamMemberRole } from '@core';
  4: import { AccountService, SHARED_IMPORTS } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
  7: import { firstValueFrom } from 'rxjs';
  8: 
  9: export interface TeamMemberAddData {
 10:   teamId: string;
 11: }
 12: 
 13: /**
 14:  * æ·»åŠ å›¢é˜Ÿæˆå‘˜ç»„ä»¶
 15:  * èŒè´£ï¼šä»…è´Ÿè´£æ·»åŠ æˆå‘˜ï¼Œé»˜è®¤è§’è‰²ä¸º MEMBER
 16:  * æ³¨æ„ï¼šè®¾ç½®æˆå‘˜è§’è‰²æ˜¯å•ç‹¬çš„åŠŸèƒ½ï¼Œä¸åœ¨æ­¤ç»„ä»¶ä¸­
 17:  */
 18: @Component({
 19:   selector: 'app-team-member-add',
 20:   standalone: true,
 21:   imports: [SHARED_IMPORTS, ReactiveFormsModule],
 22:   template: `
 23:     <form nz-form [formGroup]="form" (ngSubmit)="submit()">
 24:       <nz-form-item>
 25:         <nz-form-label [nzSpan]="6" nzRequired>é€‰æ‹©æˆå‘˜</nz-form-label>
 26:         <nz-form-control [nzSpan]="18" [nzErrorTip]="'è¯·é€‰æ‹©æˆå‘˜'">
 27:           <nz-select
 28:             formControlName="accountId"
 29:             nzPlaceHolder="è¯·é€‰æ‹©ç”¨æˆ·è´¦æˆ·"
 30:             nzShowSearch
 31:             [nzLoading]="accountService.loading()"
 32:             style="width: 100%;"
 33:           >
 34:             @for (user of accountService.userAccounts(); track user.id) {
 35:               <nz-option [nzValue]="user.id" [nzLabel]="user.name || user.id"></nz-option>
 36:             }
 37:           </nz-select>
 38:         </nz-form-control>
 39:       </nz-form-item>
 40: 
 41:       <nz-alert
 42:         nzType="info"
 43:         nzMessage="æç¤º"
 44:         nzDescription="æ·»åŠ æˆå‘˜åï¼Œè¯¥ç”¨æˆ·å°†èƒ½å¤Ÿè®¿é—®å›¢é˜Ÿç›¸å…³çš„èµ„æºå’Œæ•°æ®ã€‚æ–°æˆå‘˜é»˜è®¤è§’è‰²ä¸ºæ™®é€šæˆå‘˜ï¼Œå¯åœ¨æˆå‘˜åˆ—è¡¨ä¸­ä¿®æ”¹è§’è‰²ã€‚"
 45:         nzShowIcon
 46:         style="margin-bottom: 16px;"
 47:       ></nz-alert>
 48: 
 49:       <nz-form-item>
 50:         <nz-form-control [nzSpan]="18" [nzOffset]="6">
 51:           <button nz-button nzType="default" type="button" (click)="cancel()" [disabled]="submitting()" style="margin-right: 8px;">
 52:             å–æ¶ˆ
 53:           </button>
 54:           <button nz-button nzType="primary" type="submit" [nzLoading]="submitting()" [disabled]="!form.valid || submitting()">
 55:             æ·»åŠ æˆå‘˜
 56:           </button>
 57:         </nz-form-control>
 58:       </nz-form-item>
 59:     </form>
 60:   `
 61: })
 62: export class TeamMemberAddComponent implements OnInit {
 63:   private teamMemberRepository = inject(TeamMemberRepository);
 64:   private modalRef = inject(NzModalRef);
 65:   private message = inject(NzMessageService);
 66:   readonly accountService = inject(AccountService);
 67: 
 68:   readonly data: TeamMemberAddData = inject(NZ_MODAL_DATA);
 69:   readonly submitting = signal(false);
 70: 
 71:   form = new FormGroup({
 72:     accountId: new FormControl('', { nonNullable: true, validators: [Validators.required] })
 73:   });
 74: 
 75:   async ngOnInit(): Promise<void> {
 76:     try {
 77:       await this.accountService.loadAccounts();
 78:     } catch (error) {
 79:       this.message.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
 80:     }
 81:   }
 82: 
 83:   async submit(): Promise<void> {
 84:     if (this.form.invalid) {
 85:       Object.values(this.form.controls).forEach(control => {
 86:         control.markAsTouched();
 87:         control.updateValueAndValidity({ onlySelf: true });
 88:       });
 89:       return;
 90:     }
 91: 
 92:     this.submitting.set(true);
 93:     try {
 94:       const accountId = this.form.value.accountId!;
 95:       const memberData: TeamMemberInsert = {
 96:         team_id: this.data.teamId,
 97:         account_id: accountId,
 98:         role: TeamMemberRole.MEMBER // é»˜è®¤è§’è‰²ä¸º MEMBER
 99:       };
100: 
101:       await firstValueFrom(this.teamMemberRepository.create(memberData));
102:       this.message.success('æˆå‘˜æ·»åŠ æˆåŠŸ');
103:       this.modalRef.close(true);
104:     } catch (error) {
105:       const errorMessage = error instanceof Error ? error.message : 'æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•';
106:       this.message.error(errorMessage);
107:     } finally {
108:       this.submitting.set(false);
109:     }
110:   }
111: 
112:   cancel(): void {
113:     this.modalRef.close(false);
114:   }
115: }
````

## File: src/app/routes/accounts/teams/team-member/team-member-delete.component.ts
````typescript
 1: import { Component, inject, OnInit, signal } from '@angular/core';
 2: import { TeamMemberRepository } from '@core';
 3: import { AccountService, SHARED_IMPORTS } from '@shared';
 4: import { NzMessageService } from 'ng-zorro-antd/message';
 5: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
 6: import { firstValueFrom } from 'rxjs';
 7: 
 8: export interface TeamMemberDeleteData {
 9:   memberId: string;
10:   accountName: string;
11: }
12: 
13: /**
14:  * åˆ é™¤å›¢é˜Ÿæˆå‘˜ç¡®è®¤ç»„ä»¶
15:  * èŒè´£ï¼šç¡®è®¤åˆ é™¤å›¢é˜Ÿæˆå‘˜æ“ä½œ
16:  */
17: @Component({
18:   selector: 'app-team-member-delete',
19:   standalone: true,
20:   imports: [SHARED_IMPORTS],
21:   template: `
22:     <div style="padding: 16px;">
23:       <nz-alert
24:         nzType="warning"
25:         nzMessage="è­¦å‘Š"
26:         [nzDescription]="'ç¡®å®šè¦ç§»é™¤æˆå‘˜ã€Œ' + data.accountName + 'ã€å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚'"
27:         nzShowIcon
28:         style="margin-bottom: 16px;"
29:       ></nz-alert>
30: 
31:       <div style="text-align: right; margin-top: 24px;">
32:         <button nz-button nzType="default" (click)="cancel()" [disabled]="submitting()" style="margin-right: 8px;">
33:           å–æ¶ˆ
34:         </button>
35:         <button nz-button nzType="primary" nzDanger (click)="confirm()" [nzLoading]="submitting()" [disabled]="submitting()">
36:           ç¡®è®¤ç§»é™¤
37:         </button>
38:       </div>
39:     </div>
40:   `
41: })
42: export class TeamMemberDeleteComponent implements OnInit {
43:   private teamMemberRepository = inject(TeamMemberRepository);
44:   private modalRef = inject(NzModalRef);
45:   private message = inject(NzMessageService);
46: 
47:   readonly data: TeamMemberDeleteData = inject(NZ_MODAL_DATA);
48:   readonly submitting = signal(false);
49: 
50:   ngOnInit(): void {
51:     // ç»„ä»¶åˆå§‹åŒ–
52:   }
53: 
54:   async confirm(): Promise<void> {
55:     this.submitting.set(true);
56:     try {
57:       await firstValueFrom(this.teamMemberRepository.delete(this.data.memberId));
58:       this.message.success('ç§»é™¤æˆåŠŸ');
59:       this.modalRef.close(true);
60:     } catch (error) {
61:       const errorMessage = error instanceof Error ? error.message : 'ç§»é™¤å¤±è´¥';
62:       this.message.error(errorMessage);
63:     } finally {
64:       this.submitting.set(false);
65:     }
66:   }
67: 
68:   cancel(): void {
69:     this.modalRef.close(false);
70:   }
71: }
````

## File: src/app/routes/accounts/teams/team-role-manage/team-role-manage.component.ts
````typescript
  1: import { Component, OnInit, inject, input, signal } from '@angular/core';
  2: import { TeamMember, TeamMemberRepository } from '@core';
  3: import { AccountService, SHARED_IMPORTS } from '@shared';
  4: import { NzMessageService } from 'ng-zorro-antd/message';
  5: import { NzModalService } from 'ng-zorro-antd/modal';
  6: import { firstValueFrom } from 'rxjs';
  7: 
  8: import { TeamMemberAddComponent } from '../team-member/team-member-add.component';
  9: import { TeamMemberDeleteComponent, TeamMemberDeleteData } from '../team-member/team-member-delete.component';
 10: import { TeamRoleEditComponent } from '../team-role/team-role-edit.component';
 11: 
 12: /**
 13:  * å›¢é˜Ÿæˆå‘˜å’Œè§’è‰²ç®¡ç†ç»„ä»¶
 14:  * èŒè´£ï¼šæ˜¾ç¤ºæˆå‘˜åˆ—è¡¨ã€æ·»åŠ æˆå‘˜ã€ç¼–è¾‘è§’è‰²ã€ç§»é™¤æˆå‘˜
 15:  */
 16: @Component({
 17:   selector: 'app-team-role-manage',
 18:   standalone: true,
 19:   imports: [SHARED_IMPORTS],
 20:   template: `
 21:     <nz-card nzTitle="å›¢é˜Ÿæˆå‘˜" [nzExtra]="cardExtra" style="margin-bottom: 16px;">
 22:       <ng-template #cardExtra>
 23:         <button nz-button nzType="primary" nzSize="small" (click)="addMember()">
 24:           <span nz-icon nzType="plus"></span>
 25:           æ·»åŠ æˆå‘˜
 26:         </button>
 27:       </ng-template>
 28: 
 29:       @if (loading()) {
 30:         <nz-spin nzSimple [nzSize]="'large'" style="display: block; padding: 50px; text-align: center;"></nz-spin>
 31:       } @else if (members().length > 0) {
 32:         <nz-table [nzData]="members()" [nzShowPagination]="false" [nzSize]="'small'">
 33:           <thead>
 34:             <tr>
 35:               <th>è´¦æˆ·åç§°</th>
 36:               <th>è§’è‰²</th>
 37:               <th>åŠ å…¥æ—¶é—´</th>
 38:               <th>æ“ä½œ</th>
 39:             </tr>
 40:           </thead>
 41:           <tbody>
 42:             @for (member of members(); track member.id) {
 43:               <tr>
 44:                 <td>{{ getAccountName(member.account_id) }}</td>
 45:                 <td>
 46:                   @switch (member.role) {
 47:                     @case ('leader') {
 48:                       <nz-tag nzColor="red">è´Ÿè´£äºº</nz-tag>
 49:                     }
 50:                     @case ('member') {
 51:                       <nz-tag nzColor="blue">æˆå‘˜</nz-tag>
 52:                     }
 53:                   }
 54:                 </td>
 55:                 <td>{{ member.joined_at | date: 'yyyy-MM-dd' }}</td>
 56:                 <td>
 57:                   <button nz-button nzType="link" nzSize="small" (click)="editRole(member)">ç¼–è¾‘è§’è‰²</button>
 58:                   <button nz-button nzType="link" nzDanger nzSize="small" (click)="removeMember(member)">ç§»é™¤</button>
 59:                 </td>
 60:               </tr>
 61:             }
 62:           </tbody>
 63:         </nz-table>
 64:       } @else {
 65:         <nz-empty nzNotFoundContent="æš‚æ— æˆå‘˜"></nz-empty>
 66:       }
 67:     </nz-card>
 68:   `
 69: })
 70: export class TeamRoleManageComponent implements OnInit {
 71:   private teamMemberRepository = inject(TeamMemberRepository);
 72:   private accountService = inject(AccountService);
 73:   private message = inject(NzMessageService);
 74:   private modal = inject(NzModalService);
 75: 
 76:   readonly teamId = input.required<string>();
 77:   readonly members = signal<TeamMember[]>([]);
 78:   readonly loading = signal(false);
 79: 
 80:   async ngOnInit(): Promise<void> {
 81:     // åŠ è½½è´¦æˆ·åˆ—è¡¨ä»¥ä¾¿æ˜¾ç¤ºè´¦æˆ·åç§°
 82:     try {
 83:       await this.accountService.loadAccounts();
 84:     } catch (error) {
 85:       console.error('åŠ è½½è´¦æˆ·åˆ—è¡¨å¤±è´¥:', error);
 86:     }
 87:     await this.loadMembers();
 88:   }
 89: 
 90:   /**
 91:    * åŠ è½½å›¢é˜Ÿæˆå‘˜åˆ—è¡¨
 92:    */
 93:   async loadMembers(): Promise<void> {
 94:     this.loading.set(true);
 95:     try {
 96:       const members = await firstValueFrom(this.teamMemberRepository.findByTeamId(this.teamId()));
 97:       this.members.set(members);
 98:     } catch (error) {
 99:       const errorMessage = error instanceof Error ? error.message : 'åŠ è½½æˆå‘˜åˆ—è¡¨å¤±è´¥';
100:       this.message.error(errorMessage);
101:     } finally {
102:       this.loading.set(false);
103:     }
104:   }
105: 
106:   /**
107:    * æ·»åŠ æˆå‘˜
108:    */
109:   addMember(): void {
110:     const modalRef = this.modal.create({
111:       nzTitle: 'æ·»åŠ å›¢é˜Ÿæˆå‘˜',
112:       nzContent: TeamMemberAddComponent,
113:       nzData: {
114:         teamId: this.teamId()
115:       },
116:       nzWidth: 600,
117:       nzFooter: null
118:     });
119: 
120:     modalRef.afterClose.subscribe(result => {
121:       if (result) {
122:         this.loadMembers();
123:       }
124:     });
125:   }
126: 
127:   /**
128:    * ç¼–è¾‘è§’è‰²
129:    */
130:   editRole(member: TeamMember): void {
131:     const modalRef = this.modal.create({
132:       nzTitle: 'ç¼–è¾‘æˆå‘˜è§’è‰²',
133:       nzContent: TeamRoleEditComponent,
134:       nzData: {
135:         member
136:       },
137:       nzWidth: 500,
138:       nzFooter: null
139:     });
140: 
141:     modalRef.afterClose.subscribe(result => {
142:       if (result) {
143:         this.loadMembers();
144:       }
145:     });
146:   }
147: 
148:   /**
149:    * ç§»é™¤æˆå‘˜
150:    */
151:   removeMember(member: TeamMember): void {
152:     const accountName = this.getAccountName(member.account_id);
153:     const modalRef = this.modal.create({
154:       nzTitle: 'ç§»é™¤å›¢é˜Ÿæˆå‘˜',
155:       nzContent: TeamMemberDeleteComponent,
156:       nzData: {
157:         memberId: member.id,
158:         accountName
159:       } as TeamMemberDeleteData,
160:       nzWidth: 500,
161:       nzFooter: null
162:     });
163: 
164:     modalRef.afterClose.subscribe(result => {
165:       if (result) {
166:         this.loadMembers();
167:       }
168:     });
169:   }
170: 
171:   /**
172:    * è·å–è´¦æˆ·åç§°
173:    */
174:   getAccountName(accountId: string): string {
175:     const accounts = this.accountService.accounts();
176:     const account = accounts.find(a => a.id === accountId);
177:     return account?.name || accountId;
178:   }
179: }
````

## File: src/app/routes/accounts/teams/team-role/team-role-edit.component.ts
````typescript
  1: import { Component, inject, OnInit, signal } from '@angular/core';
  2: import { FormControl, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
  3: import { TeamMember, TeamMemberRepository, TeamMemberRole, TeamMemberUpdate } from '@core';
  4: import { SHARED_IMPORTS } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
  7: import { firstValueFrom } from 'rxjs';
  8: 
  9: export interface TeamRoleEditData {
 10:   member: TeamMember;
 11: }
 12: 
 13: /**
 14:  * ç¼–è¾‘å›¢é˜Ÿæˆå‘˜è§’è‰²ç»„ä»¶
 15:  * èŒè´£ï¼šä»…è´Ÿè´£ç¼–è¾‘å•ä¸ªæˆå‘˜çš„è§’è‰²
 16:  */
 17: @Component({
 18:   selector: 'app-team-role-edit',
 19:   standalone: true,
 20:   imports: [SHARED_IMPORTS, ReactiveFormsModule],
 21:   template: `
 22:     <form nz-form [formGroup]="form" (ngSubmit)="submit()">
 23:       <nz-form-item>
 24:         <nz-form-label [nzSpan]="6" nzRequired>æˆå‘˜è´¦æˆ·</nz-form-label>
 25:         <nz-form-control [nzSpan]="18">
 26:           <input nz-input [value]="data.member.account_id" [disabled]="true" />
 27:         </nz-form-control>
 28:       </nz-form-item>
 29: 
 30:       <nz-form-item>
 31:         <nz-form-label [nzSpan]="6" nzRequired>è§’è‰²</nz-form-label>
 32:         <nz-form-control [nzSpan]="18" [nzErrorTip]="'è¯·é€‰æ‹©è§’è‰²'">
 33:           <nz-radio-group formControlName="role">
 34:             <label nz-radio [nzValue]="TeamMemberRole.LEADER">è´Ÿè´£äºº</label>
 35:             <label nz-radio [nzValue]="TeamMemberRole.MEMBER">æˆå‘˜</label>
 36:           </nz-radio-group>
 37:         </nz-form-control>
 38:       </nz-form-item>
 39: 
 40:       <nz-form-item>
 41:         <nz-form-control [nzSpan]="18" [nzOffset]="6">
 42:           <button nz-button nzType="default" type="button" (click)="cancel()" [disabled]="submitting()" style="margin-right: 8px;">
 43:             å–æ¶ˆ
 44:           </button>
 45:           <button nz-button nzType="primary" type="submit" [nzLoading]="submitting()" [disabled]="!form.valid || submitting()">
 46:             ä¿å­˜
 47:           </button>
 48:         </nz-form-control>
 49:       </nz-form-item>
 50:     </form>
 51:   `
 52: })
 53: export class TeamRoleEditComponent implements OnInit {
 54:   private teamMemberRepository = inject(TeamMemberRepository);
 55:   private modalRef = inject(NzModalRef);
 56:   private message = inject(NzMessageService);
 57: 
 58:   readonly data: TeamRoleEditData = inject(NZ_MODAL_DATA);
 59:   readonly submitting = signal(false);
 60:   readonly TeamMemberRole = TeamMemberRole;
 61: 
 62:   form = new FormGroup({
 63:     role: new FormControl<TeamMemberRole>(TeamMemberRole.MEMBER, { nonNullable: true, validators: [Validators.required] })
 64:   });
 65: 
 66:   ngOnInit(): void {
 67:     // è®¾ç½®å½“å‰è§’è‰²
 68:     const currentRole = this.data.member.role === TeamMemberRole.LEADER ? TeamMemberRole.LEADER : TeamMemberRole.MEMBER;
 69:     this.form.controls.role.setValue(currentRole);
 70:   }
 71: 
 72:   async submit(): Promise<void> {
 73:     if (this.form.invalid) {
 74:       Object.values(this.form.controls).forEach(control => {
 75:         control.markAsTouched();
 76:         control.updateValueAndValidity({ onlySelf: true });
 77:       });
 78:       return;
 79:     }
 80: 
 81:     this.submitting.set(true);
 82:     try {
 83:       const updateData: TeamMemberUpdate = {
 84:         role: this.form.value.role!
 85:       };
 86: 
 87:       await firstValueFrom(this.teamMemberRepository.update(this.data.member.id, updateData));
 88:       this.message.success('è§’è‰²æ›´æ–°æˆåŠŸ');
 89:       this.modalRef.close(true);
 90:     } catch (error) {
 91:       const errorMessage = error instanceof Error ? error.message : 'æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•';
 92:       this.message.error(errorMessage);
 93:     } finally {
 94:       this.submitting.set(false);
 95:     }
 96:   }
 97: 
 98:   cancel(): void {
 99:     this.modalRef.close(false);
100:   }
101: }
````

## File: src/app/routes/analytics/activity-logs/detail/activity-log-detail.component.spec.ts
````typescript
 1: import { ComponentFixture, TestBed } from '@angular/core/testing';
 2: import { ActivatedRoute } from '@angular/router';
 3: import { AnalyticsService } from '@shared';
 4: import { of } from 'rxjs';
 5: 
 6: import { ActivityLogDetailComponent } from './activity-log-detail.component';
 7: 
 8: describe('ActivityLogDetailComponent', () => {
 9:   let component: ActivityLogDetailComponent;
10:   let fixture: ComponentFixture<ActivityLogDetailComponent>;
11: 
12:   beforeEach(async () => {
13:     const mockActivatedRoute = {
14:       snapshot: {
15:         paramMap: {
16:           get: (key: string) => 'test-id'
17:         }
18:       }
19:     };
20: 
21:     const mockAnalyticsService = {
22:       getActivityLogById: jasmine.createSpy('getActivityLogById').and.returnValue(Promise.resolve(null)),
23:       loading: jasmine.createSpy('loading').and.returnValue(of(false)),
24:       error: jasmine.createSpy('error').and.returnValue(of(null))
25:     };
26: 
27:     await TestBed.configureTestingModule({
28:       imports: [ActivityLogDetailComponent],
29:       providers: [
30:         { provide: ActivatedRoute, useValue: mockActivatedRoute },
31:         { provide: AnalyticsService, useValue: mockAnalyticsService }
32:       ]
33:     }).compileComponents();
34: 
35:     fixture = TestBed.createComponent(ActivityLogDetailComponent);
36:     component = fixture.componentInstance;
37:   });
38: 
39:   it('should create', () => {
40:     expect(component).toBeTruthy();
41:   });
42: 
43:   it('should have signals initialized', () => {
44:     expect(component.activityLog()).toBeNull();
45:     expect(component.loading()).toBe(false);
46:     expect(component.error()).toBeNull();
47:   });
48: 
49:   it('should format resource type labels', () => {
50:     expect(component.getResourceTypeLabel('task')).toBe('ä»»å‹™');
51:     expect(component.getResourceTypeLabel('blueprint')).toBe('è—åœ–');
52:     expect(component.getResourceTypeLabel('unknown')).toBe('unknown');
53:   });
54: });
````

## File: src/app/routes/analytics/activity-logs/detail/activity-log-detail.component.ts
````typescript
 1: import { Component, OnInit, inject, signal, ChangeDetectionStrategy } from '@angular/core';
 2: import { ActivatedRoute, Router } from '@angular/router';
 3: import { SHARED_IMPORTS, AnalyticsService } from '@shared';
 4: import type { ActivityLogDetail } from '@shared';
 5: 
 6: @Component({
 7:   selector: 'app-activity-log-detail',
 8:   imports: [SHARED_IMPORTS],
 9:   templateUrl: './activity-log-detail.component.html',
10:   styleUrl: './activity-log-detail.component.less',
11:   standalone: true,
12:   changeDetection: ChangeDetectionStrategy.OnPush
13: })
14: export class ActivityLogDetailComponent implements OnInit {
15:   private route = inject(ActivatedRoute);
16:   private router = inject(Router);
17:   private analyticsService = inject(AnalyticsService);
18: 
19:   // Signals for component state
20:   activityLog = signal<ActivityLogDetail | null>(null);
21:   loading = signal<boolean>(false);
22:   error = signal<string | null>(null);
23: 
24:   ngOnInit(): void {
25:     this.loadActivityLog();
26:   }
27: 
28:   private async loadActivityLog(): Promise<void> {
29:     const id = this.route.snapshot.paramMap.get('id');
30:     if (!id) {
31:       this.error.set('ç¼ºå°‘æ´»å‹•è¨˜éŒ„ ID');
32:       return;
33:     }
34: 
35:     this.loading.set(true);
36:     this.error.set(null);
37: 
38:     try {
39:       const data = await this.analyticsService.getActivityLogById(id);
40:       if (data) {
41:         this.activityLog.set(data);
42:       } else {
43:         this.error.set('æ‰¾ä¸åˆ°æ´»å‹•è¨˜éŒ„');
44:       }
45:     } catch (err) {
46:       this.error.set(err instanceof Error ? err.message : 'è¼‰å…¥å¤±æ•—');
47:     } finally {
48:       this.loading.set(false);
49:     }
50:   }
51: 
52:   goBack(): void {
53:     this.router.navigate(['/analytics/activity-logs']);
54:   }
55: 
56:   getResourceTypeLabel(resourceType: string): string {
57:     const labels: Record<string, string> = {
58:       blueprint: 'è—åœ–',
59:       branch: 'åˆ†æ”¯',
60:       task: 'ä»»å‹™',
61:       issue: 'å•é¡Œ',
62:       pr: 'Pull Request',
63:       comment: 'ç•™è¨€',
64:       document: 'æ–‡ä»¶',
65:       inspection: 'æª¢æŸ¥',
66:       qa: 'å“è³ªé©—æ”¶'
67:     };
68:     return labels[resourceType] || resourceType;
69:   }
70: 
71:   formatActionDetails(details: Record<string, unknown> | null): string {
72:     if (!details) {
73:       return 'ç„¡';
74:     }
75:     return JSON.stringify(details, null, 2);
76:   }
77: }
````

## File: src/app/routes/analytics/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: 
 3: export const ANALYTICS_ROUTES: Routes = [
 4:   {
 5:     path: '',
 6:     redirectTo: 'statistics',
 7:     pathMatch: 'full'
 8:   },
 9:   {
10:     path: 'statistics',
11:     loadComponent: () => import('./statistics/statistics.component').then(m => m.StatisticsComponent)
12:   },
13:   {
14:     path: 'progress',
15:     loadComponent: () => import('./progress/progress-tracking.component').then(m => m.ProgressTrackingComponent)
16:   },
17:   {
18:     path: 'progress-update',
19:     loadComponent: () => import('./progress-update/progress-update.component').then(m => m.ProgressUpdateComponent)
20:   },
21:   {
22:     path: 'main-reports',
23:     loadComponent: () => import('./reports/main-report.component').then(m => m.MainReportComponent)
24:   },
25:   {
26:     path: 'branch-reports',
27:     loadComponent: () => import('./reports/branch-report.component').then(m => m.BranchReportComponent)
28:   },
29:   {
30:     path: 'cross-branch',
31:     loadComponent: () => import('./reports/cross-branch.component').then(m => m.CrossBranchComponent)
32:   },
33:   {
34:     path: 'activity-logs',
35:     loadComponent: () => import('./activity-logs/activity-log.component').then(m => m.ActivityLogComponent)
36:   },
37:   {
38:     path: 'activity-logs/:id',
39:     loadComponent: () => import('./activity-logs/detail/activity-log-detail.component').then(m => m.ActivityLogDetailComponent)
40:   },
41:   {
42:     path: 'reports',
43:     loadComponent: () => import('./reports/data-report.component').then(m => m.DataReportComponent)
44:   },
45:   {
46:     path: 'export',
47:     loadComponent: () => import('./reports/report-export.component').then(m => m.ReportExportComponent)
48:   },
49:   {
50:     path: 'charts',
51:     loadComponent: () => import('./charts/chart-center.component').then(m => m.ChartCenterComponent)
52:   }
53: ];
````

## File: src/app/routes/blueprints/branches/branch-detail/branch-detail.ts
````typescript
  1: import { Component, OnInit, inject, signal, computed } from '@angular/core';
  2: import { ActivatedRoute, Router } from '@angular/router';
  3: import { BranchType, BranchStatus, BranchContextService } from '@core';
  4: import { SHARED_IMPORTS, BranchService, BlueprintService, AccountService, BranchPermissionService, BranchPermissionLevel } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: 
  7: @Component({
  8:   selector: 'app-branch-detail',
  9:   standalone: true,
 10:   imports: [SHARED_IMPORTS],
 11:   templateUrl: './branch-detail.html',
 12:   styleUrl: './branch-detail.less'
 13: })
 14: export class BranchDetail implements OnInit {
 15:   branchService = inject(BranchService);
 16:   blueprintService = inject(BlueprintService);
 17:   accountService = inject(AccountService);
 18:   branchPermissionService = inject(BranchPermissionService);
 19:   branchContext = inject(BranchContextService);
 20:   route = inject(ActivatedRoute);
 21:   router = inject(Router);
 22:   message = inject(NzMessageService);
 23: 
 24:   branchId = signal<string | null>(null);
 25:   loading = signal<boolean>(false);
 26:   switching = signal<boolean>(false);
 27: 
 28:   // å°å‡ºæšèˆ‰ä¾›æ¨¡æ¿ä½¿ç”¨
 29:   BranchType = BranchType;
 30:   BranchStatus = BranchStatus;
 31:   BranchPermissionLevel = BranchPermissionLevel;
 32: 
 33:   // ä½¿ç”¨ computed ç²å–åˆ†æ”¯å’Œç›¸é—œä¿¡æ¯
 34:   branch = computed(() => this.branchService.selectedBranch());
 35:   blueprint = computed(() => this.blueprintService.selectedBlueprint());
 36: 
 37:   // çµ„ç¹”ä¿¡æ¯
 38:   organization = computed(() => {
 39:     const branch = this.branch();
 40:     if (!branch) return null;
 41:     return this.accountService.accounts().find(a => a.id === branch.organization_id) || null;
 42:   });
 43: 
 44:   // ç•¶å‰ç”¨æˆ¶æ¬Šé™
 45:   currentUserPermission = computed(() => {
 46:     const branch = this.branch();
 47:     if (!branch) return null;
 48:     // TODO: å¾ AuthStateService ç²å–ç•¶å‰ç”¨æˆ¶ID
 49:     return null;
 50:   });
 51: 
 52:   ngOnInit(): void {
 53:     const id = this.route.snapshot.queryParamMap.get('id');
 54:     const shouldSwitch = this.route.snapshot.queryParamMap.get('switch') === 'true';
 55: 
 56:     if (!id) {
 57:       this.message.error('åˆ†æ”¯IDä¸å­˜åœ¨');
 58:       this.router.navigate(['/blueprints']);
 59:       return;
 60:     }
 61: 
 62:     this.branchId.set(id);
 63:     this.loadBranch(id);
 64: 
 65:     // å¦‚æœéœ€è¦åˆ‡æ›åˆ†æ”¯ï¼Œè‡ªå‹•åŸ·è¡Œåˆ‡æ›
 66:     if (shouldSwitch) {
 67:       this.switchToBranch();
 68:     }
 69:   }
 70: 
 71:   async loadBranch(id: string): Promise<void> {
 72:     this.loading.set(true);
 73:     try {
 74:       const branch = await this.branchService.loadBranchById(id);
 75:       if (branch) {
 76:         this.branchService.selectBranch(branch);
 77: 
 78:         // åŠ è¼‰è—åœ–ä¿¡æ¯
 79:         if (branch.blueprint_id) {
 80:           await this.blueprintService.loadBlueprintById(branch.blueprint_id);
 81:         }
 82: 
 83:         // åŠ è¼‰çµ„ç¹”ä¿¡æ¯
 84:         if (branch.organization_id) {
 85:           await this.accountService.loadAccountById(branch.organization_id);
 86:         }
 87: 
 88:         // åŠ è¼‰åˆ†æ”¯æ¬Šé™
 89:         await this.branchPermissionService.loadPermissionsByBranchId(id);
 90:       }
 91:     } catch (error) {
 92:       this.message.error('åŠ è¼‰åˆ†æ”¯è©³æƒ…å¤±æ•—');
 93:       console.error('Load branch error:', error);
 94:     } finally {
 95:       this.loading.set(false);
 96:     }
 97:   }
 98: 
 99:   /**
100:    * åˆ‡æ›åˆ°ç•¶å‰åˆ†æ”¯
101:    */
102:   async switchToBranch(): Promise<void> {
103:     const branch = this.branch();
104:     if (!branch) {
105:       this.message.error('åˆ†æ”¯ä¸å­˜åœ¨');
106:       return;
107:     }
108: 
109:     this.switching.set(true);
110:     try {
111:       // è¨­ç½®ç•¶å‰åˆ†æ”¯åˆ°å…¨å±€ä¸Šä¸‹æ–‡
112:       this.branchContext.setCurrentBranch(branch);
113: 
114:       // å°èˆªåˆ°è—åœ–ä¸»é é¢ï¼Œä¸¦è¨­ç½®ç•¶å‰åˆ†æ”¯åƒæ•¸
115:       if (branch.blueprint_id) {
116:         this.router.navigate(['/blueprints', branch.blueprint_id], {
117:           queryParams: { branchId: branch.id }
118:         });
119:         this.message.success(`å·²åˆ‡æ›åˆ°åˆ†æ”¯ï¼š${branch.branch_name}`);
120:       }
121:     } catch (error) {
122:       this.message.error('åˆ‡æ›åˆ†æ”¯å¤±æ•—');
123:       console.error('Switch branch error:', error);
124:     } finally {
125:       this.switching.set(false);
126:     }
127:   }
128: 
129:   /**
130:    * è¿”å›åˆ†æ”¯åˆ—è¡¨
131:    */
132:   goBack(): void {
133:     const branch = this.branch();
134:     if (branch?.blueprint_id) {
135:       this.router.navigate(['/blueprints', branch.blueprint_id, 'branches']);
136:     } else {
137:       this.router.navigate(['/blueprints']);
138:     }
139:   }
140: 
141:   /**
142:    * ç²å–åˆ†æ”¯é¡å‹æ¨™ç±¤
143:    */
144:   getBranchTypeLabel(type: string | null): string {
145:     if (!type) return 'æœªçŸ¥';
146:     const labels: Record<string, string> = {
147:       contractor: 'æ‰¿æ”¬å•†',
148:       subcontractor: 'æ¬¡æ‰¿æ”¬å•†',
149:       consultant: 'é¡§å•'
150:     };
151:     return labels[type] || type;
152:   }
153: 
154:   /**
155:    * ç²å–åˆ†æ”¯ç‹€æ…‹æ¨™ç±¤
156:    */
157:   getBranchStatusLabel(status: string | null): string {
158:     if (!status) return 'æœªçŸ¥';
159:     const labels: Record<string, string> = {
160:       active: 'æ´»èº',
161:       merged: 'å·²åˆä½µ',
162:       closed: 'å·²é—œé–‰',
163:       archived: 'å·²æ­¸æª”'
164:     };
165:     return labels[status] || status;
166:   }
167: 
168:   /**
169:    * ç²å–åˆ†æ”¯ç‹€æ…‹é¡è‰²
170:    */
171:   getBranchStatusColor(status: string | null): string {
172:     if (!status) return 'default';
173:     const colors: Record<string, string> = {
174:       active: 'success',
175:       merged: 'blue',
176:       closed: 'default',
177:       archived: 'orange'
178:     };
179:     return colors[status] || 'default';
180:   }
181: 
182:   /**
183:    * ç²å–è³¬æˆ¶åç¨±
184:    */
185:   getAccountName(accountId: string): string | null {
186:     const account = this.accountService.accounts().find(a => a.id === accountId);
187:     return account?.name || null;
188:   }
189: }
````

## File: src/app/routes/blueprints/fork/blueprint-fork.component.ts
````typescript
  1: import { Component, OnInit, inject, signal, computed } from '@angular/core';
  2: import { FormBuilder, FormGroup, Validators } from '@angular/forms';
  3: import { ActivatedRoute, Router } from '@angular/router';
  4: import { CollaborationType, CollaborationStatus } from '@core';
  5: import {
  6:   SHARED_IMPORTS,
  7:   BlueprintService,
  8:   BranchService,
  9:   CollaborationService,
 10:   AccountService,
 11:   AccountType,
 12:   BranchType,
 13:   AuthStateService,
 14:   BranchPermissionService,
 15:   BranchPermissionLevel
 16: } from '@shared';
 17: import { NzMessageService } from 'ng-zorro-antd/message';
 18: 
 19: @Component({
 20:   selector: 'app-blueprint-fork',
 21:   standalone: true,
 22:   imports: [SHARED_IMPORTS],
 23:   template: `
 24:     <page-header [title]="'Fork åˆ†æ”¯'">
 25:       <ng-template #breadcrumb>
 26:         <nz-breadcrumb>
 27:           <nz-breadcrumb-item>
 28:             <a routerLink="/blueprints">è“å›¾åˆ—è¡¨</a>
 29:           </nz-breadcrumb-item>
 30:           <nz-breadcrumb-item>
 31:             <a [routerLink]="['/blueprints', blueprintId]">è“å›¾è¯¦æƒ…</a>
 32:           </nz-breadcrumb-item>
 33:           <nz-breadcrumb-item>Fork åˆ†æ”¯</nz-breadcrumb-item>
 34:         </nz-breadcrumb>
 35:       </ng-template>
 36:     </page-header>
 37: 
 38:     <nz-card nzTitle="åˆ›å»º Fork åˆ†æ”¯" style="margin-top: 16px;">
 39:       @if (blueprintService.loading() || accountService.loading() || branchService.loading()) {
 40:         <div style="text-align: center; padding: 40px;">
 41:           <nz-spin nzSize="large"></nz-spin>
 42:         </div>
 43:       } @else if (blueprintService.error() || accountService.error() || branchService.error()) {
 44:         <nz-alert
 45:           nzType="error"
 46:           [nzMessage]="'åŠ è½½å¤±è´¥'"
 47:           [nzDescription]="blueprintService.error() || accountService.error() || branchService.error()"
 48:           nzShowIcon
 49:           style="margin-bottom: 16px;"
 50:         ></nz-alert>
 51:       } @else {
 52:         <form nz-form [formGroup]="form" (ngSubmit)="submit()" nzLayout="vertical">
 53:           <nz-form-item>
 54:             <nz-form-label nzRequired>æ¥æºè“å›¾</nz-form-label>
 55:             <nz-form-control nzErrorTip="è¯·é€‰æ‹©è“å›¾">
 56:               <input nz-input [value]="blueprint()?.name || ''" disabled />
 57:             </nz-form-control>
 58:           </nz-form-item>
 59: 
 60:           <nz-form-item>
 61:             <nz-form-label nzRequired>é€‰æ‹©ç»„ç»‡</nz-form-label>
 62:             <nz-form-control nzErrorTip="è¯·é€‰æ‹©è¦Forkçš„ç»„ç»‡">
 63:               <nz-select
 64:                 formControlName="organizationId"
 65:                 nzPlaceHolder="è¯·é€‰æ‹©ç»„ç»‡"
 66:                 [nzLoading]="accountService.loading()"
 67:                 nzShowSearch
 68:                 [nzFilterOption]="filterOrganizationOption"
 69:               >
 70:                 @for (org of availableOrganizations(); track org.id) {
 71:                   <nz-option [nzValue]="org.id" [nzLabel]="org.name">
 72:                     <div style="display: flex; align-items: center; gap: 8px;">
 73:                       <span nz-icon nzType="team" style="color: #1890ff;"></span>
 74:                       <span>{{ org.name }}</span>
 75:                       @if (org.email) {
 76:                         <span style="color: #999; font-size: 12px;">({{ org.email }})</span>
 77:                       }
 78:                     </div>
 79:                   </nz-option>
 80:                 }
 81:               </nz-select>
 82:             </nz-form-control>
 83:           </nz-form-item>
 84: 
 85:           <nz-form-item>
 86:             <nz-form-label nzRequired>åˆ†æ”¯åç§°</nz-form-label>
 87:             <nz-form-control nzErrorTip="è¯·è¾“å…¥åˆ†æ”¯åç§°">
 88:               <input nz-input formControlName="branchName" placeholder="ä¾‹å¦‚ï¼šcontractor-org-name" />
 89:             </nz-form-control>
 90:           </nz-form-item>
 91: 
 92:           <nz-form-item>
 93:             <nz-form-label nzRequired>åˆ†æ”¯ç±»å‹</nz-form-label>
 94:             <nz-form-control nzErrorTip="è¯·é€‰æ‹©åˆ†æ”¯ç±»å‹">
 95:               <nz-select formControlName="branchType" nzPlaceHolder="è¯·é€‰æ‹©åˆ†æ”¯ç±»å‹">
 96:                 <nz-option [nzValue]="BranchType.CONTRACTOR" nzLabel="æ‰¿æ½å•†"></nz-option>
 97:                 <nz-option [nzValue]="BranchType.SUBCONTRACTOR" nzLabel="åˆ†åŒ…å•†"></nz-option>
 98:                 <nz-option [nzValue]="BranchType.CONSULTANT" nzLabel="é¡¾é—®"></nz-option>
 99:               </nz-select>
100:             </nz-form-control>
101:           </nz-form-item>
102: 
103:           <nz-form-item>
104:             <nz-form-label>å¤‡æ³¨</nz-form-label>
105:             <nz-form-control>
106:               <textarea
107:                 nz-input
108:                 formControlName="notes"
109:                 [nzAutosize]="{ minRows: 3, maxRows: 6 }"
110:                 placeholder="å¯é€‰ï¼šæ·»åŠ å…³äºæ­¤Forkçš„è¯´æ˜"
111:               ></textarea>
112:             </nz-form-control>
113:           </nz-form-item>
114: 
115:           <nz-form-item>
116:             <nz-form-control>
117:               <div style="display: flex; justify-content: flex-end; gap: 8px;">
118:                 <button nz-button nzType="default" type="button" (click)="cancel()" [disabled]="submitting()"> å–æ¶ˆ </button>
119:                 <button nz-button nzType="primary" type="submit" [nzLoading]="submitting()" [disabled]="!form.valid || submitting()">
120:                   <span nz-icon nzType="git-branch"></span>
121:                   åˆ›å»º Fork
122:                 </button>
123:               </div>
124:             </nz-form-control>
125:           </nz-form-item>
126:         </form>
127:       }
128:     </nz-card>
129:   `
130: })
131: export class BlueprintForkComponent implements OnInit {
132:   blueprintService = inject(BlueprintService);
133:   branchService = inject(BranchService);
134:   collaborationService = inject(CollaborationService);
135:   accountService = inject(AccountService);
136:   branchPermissionService = inject(BranchPermissionService);
137:   authState = inject(AuthStateService);
138:   route = inject(ActivatedRoute);
139:   router = inject(Router);
140:   message = inject(NzMessageService);
141:   fb = inject(FormBuilder);
142: 
143:   blueprintId = signal<string>('');
144:   submitting = signal<boolean>(false);
145:   form!: FormGroup;
146: 
147:   // å°å‡ºæšèˆ‰ä¾›æ¨¡æ¿ä½¿ç”¨
148:   BranchType = BranchType;
149:   AccountType = AccountType;
150: 
151:   // ä½¿ç”¨ computed ç²å–ç•¶å‰è—åœ–
152:   blueprint = computed(() => {
153:     const id = this.blueprintId();
154:     if (!id) return null;
155:     return this.blueprintService.blueprints().find(b => b.id === id) || null;
156:   });
157: 
158:   // éæ¿¾å‡ºå¯ç”¨çš„çµ„ç¹”ï¼ˆæ’é™¤ç•¶å‰è—åœ–æ“æœ‰è€…ï¼‰
159:   availableOrganizations = computed(() => {
160:     const blueprint = this.blueprint();
161:     if (!blueprint) return [];
162: 
163:     return this.accountService.organizationAccounts().filter(org => org.id !== blueprint.owner_id);
164:   });
165: 
166:   // çµ„ç¹”é¸æ“‡å™¨éæ¿¾å‡½æ•¸
167:   filterOrganizationOption = (input: string, option: any): boolean => {
168:     const label = option.nzLabel?.toLowerCase() || '';
169:     const value = input.toLowerCase();
170:     return label.includes(value);
171:   };
172: 
173:   ngOnInit(): void {
174:     const id = this.route.snapshot.paramMap.get('id');
175:     if (!id) {
176:       this.message.error('è“å›¾IDä¸å­˜åœ¨');
177:       this.router.navigate(['/blueprints']);
178:       return;
179:     }
180: 
181:     this.blueprintId.set(id);
182:     this.initForm();
183:     this.loadData();
184:   }
185: 
186:   initForm(): void {
187:     this.form = this.fb.group({
188:       organizationId: ['', [Validators.required]],
189:       branchName: ['', [Validators.required, Validators.minLength(2), Validators.maxLength(255)]],
190:       branchType: [BranchType.CONTRACTOR, [Validators.required]],
191:       notes: ['']
192:     });
193:   }
194: 
195:   async loadData(): Promise<void> {
196:     try {
197:       // ä¸¦è¡ŒåŠ è¼‰è—åœ–å’Œçµ„ç¹”åˆ—è¡¨
198:       await Promise.all([this.blueprintService.loadBlueprintById(this.blueprintId()), this.accountService.loadAccounts()]);
199: 
200:       const blueprint = this.blueprint();
201:       if (!blueprint) {
202:         this.message.error('è“å›¾ä¸å­˜åœ¨');
203:         this.router.navigate(['/blueprints']);
204:         return;
205:       }
206: 
207:       // æª¢æŸ¥æ˜¯å¦å·²æœ‰å”ä½œé—œä¿‚
208:       const existingCollaborations = await this.collaborationService.loadCollaborationsByBlueprintId(blueprint.id);
209: 
210:       // å¦‚æœå·²å­˜åœ¨å”ä½œé—œä¿‚ï¼Œå¯ä»¥é å¡«å……çµ„ç¹”é¸æ“‡
211:       if (existingCollaborations.length > 0) {
212:         // å¯ä»¥è€ƒæ…®é å¡«å……ï¼Œä½†é€™è£¡å…ˆä¸è™•ç†
213:       }
214:     } catch (error) {
215:       this.message.error('åŠ è½½æ•°æ®å¤±è´¥');
216:       console.error('Load data error:', error);
217:     }
218:   }
219: 
220:   async submit(): Promise<void> {
221:     if (!this.form.valid) {
222:       Object.values(this.form.controls).forEach(control => {
223:         if (control.invalid) {
224:           control.markAsDirty();
225:           control.updateValueAndValidity({ onlySelf: true });
226:         }
227:       });
228:       return;
229:     }
230: 
231:     const blueprint = this.blueprint();
232:     if (!blueprint) {
233:       this.message.error('è“å›¾ä¸å­˜åœ¨');
234:       return;
235:     }
236: 
237:     this.submitting.set(true);
238: 
239:     try {
240:       const formValue = this.form.value;
241:       const organizationId = formValue.organizationId;
242:       const branchName = formValue.branchName;
243:       const branchType = formValue.branchType;
244:       const notes = formValue.notes || undefined;
245: 
246:       // æ­¥é©Ÿ1: æª¢æŸ¥æˆ–å‰µå»ºå”ä½œé—œä¿‚
247:       let collaboration = await this.ensureCollaboration(blueprint.id, blueprint.owner_id, organizationId);
248: 
249:       // æ­¥é©Ÿ2: å‰µå»ºåˆ†æ”¯ï¼ˆBranchService.forkBranch æœƒè‡ªå‹•å‰µå»º Fork è¨˜éŒ„ï¼‰
250:       // éœ€è¦ç²å–ç•¶å‰ç”¨æˆ¶IDä½œç‚ºforkedBy
251:       const currentUser = this.getCurrentUserId();
252:       if (!currentUser) {
253:         throw new Error('æ— æ³•è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯');
254:       }
255: 
256:       const branch = await this.branchService.forkBranch(blueprint.id, organizationId, branchName, branchType, currentUser, notes);
257: 
258:       // æ­¥é©Ÿ3: è¨­ç½®åˆ†æ”¯æ¬Šé™
259:       // ç‚ºå”ä½œçµ„ç¹”è¨­ç½® WRITE æ¬Šé™ï¼ˆå¯ä»¥å¡«å¯«æ‰¿æ”¬æ¬„ä½ï¼‰
260:       await this.branchPermissionService.grantPermission(branch.id, organizationId, BranchPermissionLevel.WRITE, currentUser);
261: 
262:       // ç‚ºè—åœ–æ“æœ‰è€…è¨­ç½® OWNER æ¬Šé™ï¼ˆå¦‚æœé‚„æ²’æœ‰ï¼‰
263:       const ownerPermission = await this.branchPermissionService.getPermissionLevel(branch.id, blueprint.owner_id);
264:       if (!ownerPermission) {
265:         await this.branchPermissionService.grantPermission(branch.id, blueprint.owner_id, BranchPermissionLevel.OWNER, currentUser);
266:       }
267: 
268:       this.message.success('Fork åˆ†æ”¯åˆ›å»ºæˆåŠŸ');
269: 
270:       // å°èˆªåˆ°åˆ†æ”¯è©³æƒ…é é¢
271:       this.router.navigate(['/blueprints/branches/detail'], {
272:         queryParams: { id: branch.id }
273:       });
274:     } catch (error) {
275:       const errorMessage = error instanceof Error ? error.message : 'åˆ›å»º Fork åˆ†æ”¯å¤±è´¥';
276:       this.message.error(errorMessage);
277:       console.error('Fork branch error:', error);
278:     } finally {
279:       this.submitting.set(false);
280:     }
281:   }
282: 
283:   /**
284:    * ç¢ºä¿å”ä½œé—œä¿‚å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡å‰µå»º
285:    */
286:   private async ensureCollaboration(blueprintId: string, ownerOrgId: string, collaboratorOrgId: string): Promise<any> {
287:     // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨å”ä½œé—œä¿‚
288:     const existingCollaborations = await this.collaborationService.loadCollaborationsByBlueprintId(blueprintId);
289:     const existing = existingCollaborations.find(c => c.collaborator_org_id === collaboratorOrgId && c.owner_org_id === ownerOrgId);
290: 
291:     if (existing) {
292:       return existing;
293:     }
294: 
295:     // å‰µå»ºæ–°çš„å”ä½œé—œä¿‚
296:     const collaboration = await this.collaborationService.createCollaboration({
297:       blueprint_id: blueprintId,
298:       owner_org_id: ownerOrgId,
299:       collaborator_org_id: collaboratorOrgId,
300:       collaboration_type: CollaborationType.CONTRACTOR,
301:       status: CollaborationStatus.ACTIVE
302:     } as any);
303: 
304:     return collaboration;
305:   }
306: 
307:   /**
308:    * ç²å–ç•¶å‰ç”¨æˆ¶ID
309:    */
310:   private getCurrentUserId(): string | null {
311:     const currentUser = this.authState.user();
312:     if (!currentUser) {
313:       return null;
314:     }
315:     return currentUser.id || null;
316:   }
317: 
318:   cancel(): void {
319:     const blueprintId = this.blueprintId();
320:     if (blueprintId) {
321:       this.router.navigate(['/blueprints', blueprintId]);
322:     } else {
323:       this.router.navigate(['/blueprints']);
324:     }
325:   }
326: }
````

## File: src/app/routes/blueprints/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: 
 3: export const BLUEPRINT_ROUTES: Routes = [
 4:   {
 5:     path: '',
 6:     redirectTo: 'list',
 7:     pathMatch: 'full'
 8:   },
 9:   {
10:     path: 'list',
11:     loadComponent: () => import('./list/blueprint-list.component').then(m => m.BlueprintListComponent)
12:   },
13:   {
14:     path: 'create',
15:     loadComponent: () => import('./form/blueprint-form.component').then(m => m.BlueprintFormComponent)
16:   },
17:   {
18:     path: 'detail',
19:     loadComponent: () => import('./detail-shell/blueprint-detail-shell.component').then(m => m.BlueprintDetailShellComponent)
20:   },
21:   {
22:     path: 'settings',
23:     loadComponent: () => import('./settings-shell/blueprint-settings-shell.component').then(m => m.BlueprintSettingsShellComponent)
24:   },
25:   {
26:     path: 'main-branch',
27:     loadComponent: () => import('./main-branch/blueprint-main-branch.component').then(m => m.BlueprintMainBranchComponent)
28:   },
29:   {
30:     path: 'branches',
31:     loadComponent: () => import('./branches/blueprint-branches-overview.component').then(m => m.BlueprintBranchesOverviewComponent)
32:   },
33:   {
34:     path: 'branches/detail',
35:     loadComponent: () => import('./branches/branch-detail/branch-detail').then(m => m.BranchDetail)
36:   },
37:   {
38:     path: 'fork',
39:     loadComponent: () => import('./fork/blueprint-fork-landing.component').then(m => m.BlueprintForkLandingComponent)
40:   },
41:   {
42:     path: 'pull-requests',
43:     loadComponent: () => import('./pull-requests/pull-request-center.component').then(m => m.PullRequestCenterComponent)
44:   },
45:   {
46:     path: 'pull-requests/detail',
47:     loadComponent: () => import('./pull-requests/detail/pull-request-detail').then(m => m.PullRequestDetailComponent)
48:   },
49:   {
50:     path: 'review',
51:     loadComponent: () => import('./review/blueprint-review-workspace.component').then(m => m.BlueprintReviewWorkspaceComponent)
52:   },
53:   {
54:     path: ':id',
55:     loadComponent: () => import('./detail/blueprint-detail.component').then(m => m.BlueprintDetailComponent)
56:   },
57:   {
58:     path: ':id/edit',
59:     loadComponent: () => import('./form/blueprint-form.component').then(m => m.BlueprintFormComponent)
60:   },
61:   {
62:     path: ':id/branches',
63:     loadComponent: () => import('./branches/branch-management.component').then(m => m.BranchManagementComponent)
64:   },
65:   {
66:     path: ':id/pull-requests',
67:     loadComponent: () => import('./pull-requests/pull-request-list.component').then(m => m.PullRequestListComponent)
68:   },
69:   {
70:     path: ':id/settings',
71:     loadComponent: () => import('./settings/blueprint-settings.component').then(m => m.BlueprintSettingsComponent)
72:   },
73:   {
74:     path: ':id/fork',
75:     loadComponent: () => import('./fork/blueprint-fork.component').then(m => m.BlueprintForkComponent)
76:   },
77:   {
78:     path: ':id/pull-requests/:prId/review',
79:     loadComponent: () => import('./review/pr-review.component').then(m => m.PrReviewComponent)
80:   }
81: ];
````

## File: src/app/routes/bots/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: 
 3: export const BOT_ROUTES: Routes = [
 4:   {
 5:     path: '',
 6:     redirectTo: 'list',
 7:     pathMatch: 'full'
 8:   },
 9:   {
10:     path: 'list',
11:     loadComponent: () => import('./list/bot-list.component').then(m => m.BotListComponent)
12:   },
13:   {
14:     path: 'config',
15:     loadComponent: () => import('./config/bot-config.component').then(m => m.BotConfigComponent)
16:   },
17:   {
18:     path: 'executions',
19:     loadComponent: () => import('./executions/bot-execution.component').then(m => m.BotExecutionComponent)
20:   },
21:   {
22:     path: 'tasks',
23:     loadComponent: () => import('./tasks/bots-tasks-skeleton.component').then(m => m.BotsTasksSkeletonComponent)
24:   }
25: ];
````

## File: src/app/routes/bots/tasks/bots-tasks-skeleton.component.spec.ts
````typescript
 1: import { ComponentFixture, TestBed } from '@angular/core/testing';
 2: 
 3: import { BotsTasksSkeletonComponent } from './bots-tasks-skeleton.component';
 4: 
 5: describe('BotsTasksSkeletonComponent', () => {
 6:   let component: BotsTasksSkeletonComponent;
 7:   let fixture: ComponentFixture<BotsTasksSkeletonComponent>;
 8: 
 9:   beforeEach(async () => {
10:     await TestBed.configureTestingModule({
11:       imports: [BotsTasksSkeletonComponent]
12:     }).compileComponents();
13: 
14:     fixture = TestBed.createComponent(BotsTasksSkeletonComponent);
15:     component = fixture.componentInstance;
16:     fixture.detectChanges();
17:   });
18: 
19:   it('should create', () => {
20:     expect(component).toBeTruthy();
21:   });
22: 
23:   it('should have createSampleBotTask method', () => {
24:     expect(component.createSampleBotTask).toBeDefined();
25:     spyOn(console, 'log');
26:     component.createSampleBotTask();
27:     expect(console.log).toHaveBeenCalledWith('å»ºç«‹ç¯„ä¾‹æ©Ÿå™¨äººä»»å‹™ (æœªå¯¦ä½œ)');
28:   });
29: });
````

## File: src/app/routes/bots/tasks/bots-tasks-skeleton.component.ts
````typescript
 1: import { Component, ChangeDetectionStrategy } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: @Component({
 5:   selector: 'app-bots-tasks-skeleton',
 6:   imports: [SHARED_IMPORTS],
 7:   templateUrl: './bots-tasks-skeleton.component.html',
 8:   styleUrl: './bots-tasks-skeleton.component.less',
 9:   standalone: true,
10:   changeDetection: ChangeDetectionStrategy.OnPush
11: })
12: export class BotsTasksSkeletonComponent {
13:   /**
14:    * å»ºç«‹ç¯„ä¾‹æ©Ÿå™¨äººä»»å‹™
15:    * æ­¤åŠŸèƒ½ç›®å‰æœªå¯¦ä½œï¼Œåƒ…ä½œç‚º UI éª¨æ¶å±•ç¤º
16:    */
17:   createSampleBotTask(): void {
18:     console.log('å»ºç«‹ç¯„ä¾‹æ©Ÿå™¨äººä»»å‹™ (æœªå¯¦ä½œ)');
19:   }
20: }
````

## File: src/app/routes/quality/checks/detail/quality-check-detail.component.spec.ts
````typescript
 1: import { ComponentFixture, TestBed } from '@angular/core/testing';
 2: import { ActivatedRoute } from '@angular/router';
 3: import { QualityCheckService } from '@shared';
 4: import { of } from 'rxjs';
 5: 
 6: import { QualityCheckDetailComponent } from './quality-check-detail.component';
 7: 
 8: describe('QualityCheckDetailComponent', () => {
 9:   let component: QualityCheckDetailComponent;
10:   let fixture: ComponentFixture<QualityCheckDetailComponent>;
11: 
12:   beforeEach(async () => {
13:     const mockActivatedRoute = {
14:       snapshot: {
15:         paramMap: {
16:           get: (key: string) => 'test-id'
17:         }
18:       }
19:     };
20: 
21:     const mockQualityCheckService = {
22:       getById: jasmine.createSpy('getById').and.returnValue(Promise.resolve(null)),
23:       update: jasmine.createSpy('update').and.returnValue(Promise.resolve({})),
24:       loading: jasmine.createSpy('loading').and.returnValue(of(false)),
25:       error: jasmine.createSpy('error').and.returnValue(of(null))
26:     };
27: 
28:     await TestBed.configureTestingModule({
29:       imports: [QualityCheckDetailComponent],
30:       providers: [
31:         { provide: ActivatedRoute, useValue: mockActivatedRoute },
32:         { provide: QualityCheckService, useValue: mockQualityCheckService }
33:       ]
34:     }).compileComponents();
35: 
36:     fixture = TestBed.createComponent(QualityCheckDetailComponent);
37:     component = fixture.componentInstance;
38:   });
39: 
40:   it('should create', () => {
41:     expect(component).toBeTruthy();
42:   });
43: 
44:   it('should have edit form initialized', () => {
45:     expect(component.editForm).toBeDefined();
46:     expect(component.editForm.controls.status).toBeDefined();
47:     expect(component.editForm.controls.findings).toBeDefined();
48:     expect(component.editForm.controls.recommendations).toBeDefined();
49:   });
50: 
51:   it('should toggle edit mode', () => {
52:     expect(component.isEditMode()).toBe(false);
53:     component.toggleEditMode();
54:     expect(component.isEditMode()).toBe(true);
55:     component.toggleEditMode();
56:     expect(component.isEditMode()).toBe(false);
57:   });
58: });
````

## File: src/app/routes/tasks/daily-reports/daily-report-detail.component.ts
````typescript
 1: import { Component, inject, signal, OnInit } from '@angular/core';
 2: import { DailyReportRepository } from '@core';
 3: import { SHARED_IMPORTS, DailyReport } from '@shared';
 4: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
 5: import { firstValueFrom } from 'rxjs';
 6: 
 7: export interface DailyReportDetailData {
 8:   reportId: string;
 9: }
10: 
11: @Component({
12:   selector: 'app-daily-report-detail',
13:   standalone: true,
14:   imports: [SHARED_IMPORTS],
15:   template: `
16:     @if (loading()) {
17:       <div style="text-align: center; padding: 40px;">
18:         <nz-spin nzSize="large"></nz-spin>
19:       </div>
20:     } @else if (report()) {
21:       <nz-descriptions nzBordered [nzColumn]="2">
22:         <nz-descriptions-item nzTitle="æŠ¥å‘ŠID" [nzSpan]="2">{{ report()!.id }}</nz-descriptions-item>
23:         <nz-descriptions-item nzTitle="ä»»åŠ¡ID" [nzSpan]="2">{{ report()!.task_id }}</nz-descriptions-item>
24:         <nz-descriptions-item nzTitle="æŠ¥å‘Šæ—¥æœŸ" [nzSpan]="1">{{ report()!.report_date }}</nz-descriptions-item>
25:         <nz-descriptions-item nzTitle="å·¥äººæ•°é‡" [nzSpan]="1">
26:           {{ report()!.worker_count || 'æœªè®°å½•' }}
27:         </nz-descriptions-item>
28:         <nz-descriptions-item nzTitle="å·¥ä½œæè¿°" [nzSpan]="2">
29:           <pre style="white-space: pre-wrap; margin: 0;">{{ report()!.work_description }}</pre>
30:         </nz-descriptions-item>
31:         @if (report()!.equipment_used) {
32:           <nz-descriptions-item nzTitle="ä½¿ç”¨è®¾å¤‡" [nzSpan]="2">
33:             <pre style="white-space: pre-wrap; margin: 0;">{{ report()!.equipment_used }}</pre>
34:           </nz-descriptions-item>
35:         }
36:         @if (report()!.materials_used) {
37:           <nz-descriptions-item nzTitle="ä½¿ç”¨ææ–™" [nzSpan]="2">
38:             <pre style="white-space: pre-wrap; margin: 0;">{{ report()!.materials_used }}</pre>
39:           </nz-descriptions-item>
40:         }
41:         @if (report()!.progress_notes) {
42:           <nz-descriptions-item nzTitle="è¿›åº¦è¯´æ˜" [nzSpan]="2">
43:             <pre style="white-space: pre-wrap; margin: 0;">{{ report()!.progress_notes }}</pre>
44:           </nz-descriptions-item>
45:         }
46:         @if (report()!.issues_encountered) {
47:           <nz-descriptions-item nzTitle="é‡åˆ°çš„é—®é¢˜" [nzSpan]="2">
48:             <pre style="white-space: pre-wrap; margin: 0;">{{ report()!.issues_encountered }}</pre>
49:           </nz-descriptions-item>
50:         }
51:         @if (report()!.weather_info) {
52:           <nz-descriptions-item nzTitle="å¤©æ°”ä¿¡æ¯" [nzSpan]="2">
53:             {{ report()!.weather_info | json }}
54:           </nz-descriptions-item>
55:         }
56:         <nz-descriptions-item nzTitle="æŠ¥å‘Šè€…ID" [nzSpan]="1">{{ report()!.reported_by }}</nz-descriptions-item>
57:         <nz-descriptions-item nzTitle="åˆ›å»ºæ—¶é—´" [nzSpan]="1">{{
58:           report()!.created_at | date: 'yyyy-MM-dd HH:mm:ss'
59:         }}</nz-descriptions-item>
60:       </nz-descriptions>
61: 
62:       <div style="margin-top: 16px; text-align: right;">
63:         <button nz-button nzType="default" (click)="close()">å…³é—­</button>
64:       </div>
65:     } @else {
66:       <nz-empty nzNotFoundContent="æ—¥å¿—ä¸å­˜åœ¨"></nz-empty>
67:     }
68:   `
69: })
70: export class DailyReportDetailComponent implements OnInit {
71:   private modalRef = inject(NzModalRef);
72:   private dailyReportRepo = inject(DailyReportRepository);
73: 
74:   readonly data: DailyReportDetailData = inject(NZ_MODAL_DATA);
75:   readonly loading = signal(false);
76:   readonly report = signal<DailyReport | null>(null);
77: 
78:   async ngOnInit(): Promise<void> {
79:     await this.loadReport();
80:   }
81: 
82:   async loadReport(): Promise<void> {
83:     this.loading.set(true);
84:     try {
85:       const result = await firstValueFrom(this.dailyReportRepo.findById(this.data.reportId));
86:       this.report.set(result);
87:     } catch (error) {
88:       console.error('åŠ è½½æ—¥å¿—è¯¦æƒ…å¤±è´¥:', error);
89:       this.report.set(null);
90:     } finally {
91:       this.loading.set(false);
92:     }
93:   }
94: 
95:   close(): void {
96:     this.modalRef.close();
97:   }
98: }
````

## File: src/app/routes/tasks/daily-reports/daily-report-form.component.ts
````typescript
  1: import { Component, inject, signal, OnInit } from '@angular/core';
  2: import { FormBuilder, FormGroup, Validators } from '@angular/forms';
  3: import { DailyReportRepository } from '@core';
  4: import { SHARED_IMPORTS, Task, DailyReportInsert } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
  7: import { firstValueFrom } from 'rxjs';
  8: 
  9: export interface DailyReportFormData {
 10:   task: Task;
 11:   blueprintId: string;
 12:   branchId?: string;
 13: }
 14: 
 15: @Component({
 16:   selector: 'app-daily-report-form',
 17:   standalone: true,
 18:   imports: [SHARED_IMPORTS],
 19:   template: `
 20:     <form nz-form [formGroup]="form" (ngSubmit)="submit()">
 21:       <nz-form-item>
 22:         <nz-form-label [nzSpan]="6" nzRequired>ä»»åŠ¡</nz-form-label>
 23:         <nz-form-control [nzSpan]="18">
 24:           <input nz-input [value]="data.task.title" disabled />
 25:         </nz-form-control>
 26:       </nz-form-item>
 27: 
 28:       <nz-form-item>
 29:         <nz-form-label [nzSpan]="6" nzRequired>æŠ¥å‘Šæ—¥æœŸ</nz-form-label>
 30:         <nz-form-control [nzSpan]="18" nzErrorTip="è¯·é€‰æ‹©æŠ¥å‘Šæ—¥æœŸ">
 31:           <nz-date-picker formControlName="reportDate" style="width: 100%;" nzPlaceHolder="é€‰æ‹©æ—¥æœŸ"></nz-date-picker>
 32:         </nz-form-control>
 33:       </nz-form-item>
 34: 
 35:       <nz-form-item>
 36:         <nz-form-label [nzSpan]="6" nzRequired>å·¥ä½œæè¿°</nz-form-label>
 37:         <nz-form-control [nzSpan]="18" nzErrorTip="è¯·è¾“å…¥å·¥ä½œæè¿°">
 38:           <textarea
 39:             nz-input
 40:             formControlName="workDescription"
 41:             [nzAutosize]="{ minRows: 4, maxRows: 8 }"
 42:             placeholder="è¯¦ç»†æè¿°ä»Šæ—¥å®Œæˆçš„å·¥ä½œå†…å®¹"
 43:           ></textarea>
 44:         </nz-form-control>
 45:       </nz-form-item>
 46: 
 47:       <nz-form-item>
 48:         <nz-form-label [nzSpan]="6">å·¥äººæ•°é‡</nz-form-label>
 49:         <nz-form-control [nzSpan]="18">
 50:           <nz-input-number
 51:             formControlName="workerCount"
 52:             [nzMin]="0"
 53:             [nzStep]="1"
 54:             style="width: 100%;"
 55:             nzPlaceHolder="ä»Šæ—¥åœ¨åœºå·¥äººæ•°é‡"
 56:           ></nz-input-number>
 57:         </nz-form-control>
 58:       </nz-form-item>
 59: 
 60:       <nz-form-item>
 61:         <nz-form-label [nzSpan]="6">ä½¿ç”¨è®¾å¤‡</nz-form-label>
 62:         <nz-form-control [nzSpan]="18">
 63:           <textarea
 64:             nz-input
 65:             formControlName="equipmentUsed"
 66:             [nzAutosize]="{ minRows: 2, maxRows: 4 }"
 67:             placeholder="ä½¿ç”¨çš„è®¾å¤‡æ¸…å•ï¼ˆä¾‹å¦‚ï¼šæŒ–æ˜æœºã€èµ·é‡æœºç­‰ï¼‰"
 68:           ></textarea>
 69:         </nz-form-control>
 70:       </nz-form-item>
 71: 
 72:       <nz-form-item>
 73:         <nz-form-label [nzSpan]="6">ä½¿ç”¨ææ–™</nz-form-label>
 74:         <nz-form-control [nzSpan]="18">
 75:           <textarea
 76:             nz-input
 77:             formControlName="materialsUsed"
 78:             [nzAutosize]="{ minRows: 2, maxRows: 4 }"
 79:             placeholder="ä½¿ç”¨çš„ææ–™æ¸…å•ï¼ˆä¾‹å¦‚ï¼šæ°´æ³¥ 10 å¨ã€é’¢ç­‹ 5 å¨ç­‰ï¼‰"
 80:           ></textarea>
 81:         </nz-form-control>
 82:       </nz-form-item>
 83: 
 84:       <nz-form-item>
 85:         <nz-form-label [nzSpan]="6">è¿›åº¦è¯´æ˜</nz-form-label>
 86:         <nz-form-control [nzSpan]="18">
 87:           <textarea
 88:             nz-input
 89:             formControlName="progressNotes"
 90:             [nzAutosize]="{ minRows: 2, maxRows: 4 }"
 91:             placeholder="å·¥ç¨‹è¿›åº¦è¯´æ˜å’Œå¤‡æ³¨"
 92:           ></textarea>
 93:         </nz-form-control>
 94:       </nz-form-item>
 95: 
 96:       <nz-form-item>
 97:         <nz-form-label [nzSpan]="6">é‡åˆ°çš„é—®é¢˜</nz-form-label>
 98:         <nz-form-control [nzSpan]="18">
 99:           <textarea
100:             nz-input
101:             formControlName="issuesEncountered"
102:             [nzAutosize]="{ minRows: 2, maxRows: 4 }"
103:             placeholder="æ–½å·¥è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜æˆ–éšœç¢"
104:           ></textarea>
105:         </nz-form-control>
106:       </nz-form-item>
107: 
108:       <nz-form-item>
109:         <nz-form-control [nzSpan]="18" [nzOffset]="6">
110:           <button nz-button nzType="default" type="button" (click)="cancel()" [disabled]="submitting()" style="margin-right: 8px;">
111:             å–æ¶ˆ
112:           </button>
113:           <button nz-button nzType="primary" type="submit" [nzLoading]="submitting()" [disabled]="!form.valid || submitting()">
114:             æäº¤
115:           </button>
116:         </nz-form-control>
117:       </nz-form-item>
118:     </form>
119:   `
120: })
121: export class DailyReportFormComponent implements OnInit {
122:   private fb = inject(FormBuilder);
123:   private modalRef = inject(NzModalRef);
124:   private message = inject(NzMessageService);
125:   private dailyReportRepo = inject(DailyReportRepository);
126: 
127:   readonly data: DailyReportFormData = inject(NZ_MODAL_DATA);
128:   readonly submitting = signal(false);
129: 
130:   form!: FormGroup;
131: 
132:   ngOnInit(): void {
133:     this.form = this.fb.group({
134:       reportDate: [new Date(), [Validators.required]],
135:       workDescription: ['', [Validators.required, Validators.minLength(10)]],
136:       workerCount: [null],
137:       equipmentUsed: [''],
138:       materialsUsed: [''],
139:       progressNotes: [''],
140:       issuesEncountered: ['']
141:     });
142:   }
143: 
144:   async submit(): Promise<void> {
145:     if (!this.form.valid) {
146:       Object.values(this.form.controls).forEach(control => {
147:         if (control.invalid) {
148:           control.markAsDirty();
149:           control.updateValueAndValidity({ onlySelf: true });
150:         }
151:       });
152:       return;
153:     }
154: 
155:     this.submitting.set(true);
156:     try {
157:       const formValue = this.form.value;
158: 
159:       // Format date to YYYY-MM-DD
160:       const reportDate = new Date(formValue.reportDate);
161:       const formattedDate = reportDate.toISOString().split('T')[0];
162: 
163:       const dailyReport: DailyReportInsert = {
164:         task_id: this.data.task.id,
165:         blueprint_id: this.data.blueprintId,
166:         branch_id: this.data.branchId || null,
167:         report_date: formattedDate,
168:         work_description: formValue.workDescription,
169:         worker_count: formValue.workerCount,
170:         equipment_used: formValue.equipmentUsed || null,
171:         materials_used: formValue.materialsUsed || null,
172:         progress_notes: formValue.progressNotes || null,
173:         issues_encountered: formValue.issuesEncountered || null,
174:         weather_info: null, // TODO: å°†æ¥å¯ä»¥é›†æˆå¤©æ°”API
175:         reported_by: this.data.task.created_by // ä½¿ç”¨ä»»åŠ¡åˆ›å»ºè€…IDï¼Œå®é™…åº”è¯¥ç”¨å½“å‰ç™»å½•ç”¨æˆ·ID
176:       };
177: 
178:       await firstValueFrom(this.dailyReportRepo.create(dailyReport));
179:       this.message.success('æ–½å·¥æ—¥å¿—åˆ›å»ºæˆåŠŸ');
180:       this.modalRef.close(true);
181:     } catch (error: any) {
182:       console.error('åˆ›å»ºæ–½å·¥æ—¥å¿—å¤±è´¥:', error);
183:       this.message.error(error.message || 'åˆ›å»ºæ–½å·¥æ—¥å¿—å¤±è´¥ï¼Œè¯·é‡è¯•');
184:     } finally {
185:       this.submitting.set(false);
186:     }
187:   }
188: 
189:   cancel(): void {
190:     this.modalRef.close(false);
191:   }
192: }
````

## File: src/app/routes/tasks/daily-reports/daily-reports.component.ts
````typescript
  1: import { Component, OnInit, inject, signal, computed } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { DailyReportRepository } from '@core';
  4: import { STColumn } from '@delon/abc/st';
  5: import { SHARED_IMPORTS, TaskService, Task, DailyReport, BlueprintService } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: import { NzModalService } from 'ng-zorro-antd/modal';
  8: import { firstValueFrom } from 'rxjs';
  9: 
 10: import { DailyReportDetailComponent } from './daily-report-detail.component';
 11: import { DailyReportFormComponent } from './daily-report-form.component';
 12: 
 13: @Component({
 14:   selector: 'app-daily-reports',
 15:   standalone: true,
 16:   imports: [SHARED_IMPORTS],
 17:   template: `
 18:     <page-header [title]="'æ–½å·¥æ—¥å¿—'">
 19:       <ng-template #extra>
 20:         <nz-select
 21:           [ngModel]="selectedBlueprintId()"
 22:           (ngModelChange)="selectedBlueprintId.set($event); onBlueprintChange()"
 23:           nzPlaceHolder="è¯·é€‰æ‹©è“å›¾"
 24:           style="width: 300px; margin-right: 8px;"
 25:         >
 26:           @for (blueprint of blueprintService.blueprints(); track blueprint.id) {
 27:             <nz-option [nzValue]="blueprint.id" [nzLabel]="blueprint.name"></nz-option>
 28:           }
 29:         </nz-select>
 30:         <button nz-button nzType="primary" (click)="createReport()">
 31:           <span nz-icon nzType="plus"></span>
 32:           æ–°å»ºæ—¥å¿—
 33:         </button>
 34:       </ng-template>
 35:     </page-header>
 36: 
 37:     <nz-card style="margin-top: 16px;">
 38:       @if (!selectedBlueprintId()) {
 39:         <nz-empty nzNotFoundContent="è¯·å…ˆé€‰æ‹©è“å›¾"></nz-empty>
 40:       } @else if (loading()) {
 41:         <div style="text-align: center; padding: 40px;">
 42:           <nz-spin nzSize="large"></nz-spin>
 43:         </div>
 44:       } @else {
 45:         <st #st [data]="reports()" [columns]="columns" [loading]="loading()" [page]="{ front: false, show: true, showSize: true }">
 46:           <ng-template #weather let-record>
 47:             @if (record.weather_data) {
 48:               <nz-tag>{{ record.weather_data }}</nz-tag>
 49:             } @else {
 50:               <span>-</span>
 51:             }
 52:           </ng-template>
 53:         </st>
 54:       }
 55:     </nz-card>
 56:   `
 57: })
 58: export class DailyReportsComponent implements OnInit {
 59:   readonly taskService = inject(TaskService);
 60:   readonly blueprintService = inject(BlueprintService);
 61:   private readonly dailyReportRepository = inject(DailyReportRepository);
 62:   private readonly router = inject(Router);
 63:   private readonly message = inject(NzMessageService);
 64:   private readonly modal = inject(NzModalService);
 65: 
 66:   readonly selectedBlueprintId = signal<string | null>(null);
 67:   readonly loading = signal<boolean>(false);
 68:   readonly reports = signal<DailyReport[]>([]);
 69: 
 70:   columns: STColumn[] = [
 71:     { title: 'ID', index: 'id', width: 100 },
 72:     { title: 'ä»»åŠ¡ID', index: 'task_id', width: 120 },
 73:     { title: 'ä»»åŠ¡æ ‡é¢˜', index: 'taskTitle', width: 200, format: (item: any) => item.taskTitle || item.task_id },
 74:     { title: 'æŠ¥å‘Šæ—¥æœŸ', index: 'report_date', type: 'date', width: 120 },
 75:     { title: 'æŠ¥å‘Šè€…ID', index: 'reported_by', width: 120 },
 76:     { title: 'å·¥ä½œå†…å®¹', index: 'work_content', width: 300 },
 77:     { title: 'å¤©æ°”', index: 'weather_data', width: 100, render: 'weather' },
 78:     { title: 'åˆ›å»ºæ—¶é—´', index: 'created_at', type: 'date', width: 180 },
 79:     {
 80:       title: 'æ“ä½œ',
 81:       width: 150,
 82:       buttons: [
 83:         {
 84:           text: 'æŸ¥çœ‹',
 85:           click: (record: DailyReport) => this.viewReport(record.id)
 86:         }
 87:       ]
 88:     }
 89:   ];
 90: 
 91:   ngOnInit(): void {
 92:     this.loadBlueprints();
 93:   }
 94: 
 95:   async loadBlueprints(): Promise<void> {
 96:     try {
 97:       await this.blueprintService.loadBlueprints();
 98:     } catch (error) {
 99:       this.message.error('åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
100:     }
101:   }
102: 
103:   async onBlueprintChange(): Promise<void> {
104:     const blueprintId = this.selectedBlueprintId();
105:     if (!blueprintId) return;
106: 
107:     this.loading.set(true);
108:     try {
109:       // å…ˆåŠ è½½ä»»åŠ¡åˆ—è¡¨
110:       await this.taskService.loadTasksByBlueprint(blueprintId);
111: 
112:       // ç„¶ååŠ è½½æ‰€æœ‰ä»»åŠ¡çš„æ–½å·¥æ—¥å¿—
113:       const tasks = this.taskService.tasks();
114:       const reportPromises = tasks.map(task => firstValueFrom(this.dailyReportRepository.findByTaskId(task.id)));
115:       const reportArrays = await Promise.all(reportPromises);
116:       const allReports = reportArrays.flat();
117: 
118:       // å…³è”ä»»åŠ¡æ ‡é¢˜
119:       const reportsWithTitle = allReports.map(report => {
120:         const task = tasks.find(t => t.id === report.task_id);
121:         return {
122:           ...report,
123:           taskTitle: task?.title || 'ä»»åŠ¡ä¸å­˜åœ¨'
124:         } as any;
125:       });
126: 
127:       this.reports.set(reportsWithTitle as DailyReport[]);
128:     } catch (error) {
129:       this.message.error('åŠ è½½æ–½å·¥æ—¥å¿—å¤±è´¥');
130:     } finally {
131:       this.loading.set(false);
132:     }
133:   }
134: 
135:   createReport(): void {
136:     const blueprintId = this.selectedBlueprintId();
137:     if (!blueprintId) {
138:       this.message.warning('è¯·å…ˆé€‰æ‹©è“å›¾');
139:       return;
140:     }
141: 
142:     const tasks = this.taskService.tasks();
143:     if (tasks.length === 0) {
144:       this.message.warning('å½“å‰è“å›¾æ²¡æœ‰ä»»åŠ¡ï¼Œè¯·å…ˆåˆ›å»ºä»»åŠ¡');
145:       return;
146:     }
147: 
148:     // ç®€å•èµ·è§ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªä»»åŠ¡ã€‚å®é™…åº”è¯¥è®©ç”¨æˆ·é€‰æ‹©ä»»åŠ¡
149:     const task = tasks[0];
150: 
151:     const modalRef = this.modal.create({
152:       nzTitle: 'åˆ›å»ºæ–½å·¥æ—¥å¿—',
153:       nzContent: DailyReportFormComponent,
154:       nzData: {
155:         task,
156:         blueprintId,
157:         branchId: null // TODO: å¦‚æœåœ¨åˆ†æ”¯ä¸­ï¼Œä¼ é€’ branchId
158:       },
159:       nzWidth: 720,
160:       nzFooter: null
161:     });
162: 
163:     modalRef.afterClose.subscribe(result => {
164:       if (result) {
165:         // åˆ·æ–°åˆ—è¡¨
166:         this.onBlueprintChange();
167:       }
168:     });
169:   }
170: 
171:   viewReport(id: string): void {
172:     this.modal.create({
173:       nzTitle: 'æ–½å·¥æ—¥å¿—è¯¦æƒ…',
174:       nzContent: DailyReportDetailComponent,
175:       nzData: {
176:         reportId: id
177:       },
178:       nzWidth: 800,
179:       nzFooter: null
180:     });
181:   }
182: }
````

## File: src/app/routes/tasks/list/task-list.component.spec.ts
````typescript
  1: import { ComponentFixture, TestBed } from '@angular/core/testing';
  2: import { signal } from '@angular/core';
  3: import { Router } from '@angular/router';
  4: import { NzMessageService } from 'ng-zorro-antd/message';
  5: import { of } from 'rxjs';
  6: 
  7: import { TaskListComponent } from './task-list.component';
  8: import {
  9:   TaskService,
 10:   BlueprintService,
 11:   TaskStagingService,
 12:   AuthStateService,
 13:   Task,
 14:   TaskStatus,
 15:   TaskPriority,
 16:   TaskType,
 17:   Blueprint,
 18:   TaskStaging,
 19:   Account
 20: } from '@shared';
 21: 
 22: describe('TaskListComponent', () => {
 23:   let component: TaskListComponent;
 24:   let fixture: ComponentFixture<TaskListComponent>;
 25:   let mockTaskService: jasmine.SpyObj<TaskService>;
 26:   let mockBlueprintService: jasmine.SpyObj<BlueprintService>;
 27:   let mockTaskStagingService: jasmine.SpyObj<TaskStagingService>;
 28:   let mockAuthState: jasmine.SpyObj<AuthStateService>;
 29:   let mockRouter: jasmine.SpyObj<Router>;
 30:   let mockMessage: jasmine.SpyObj<NzMessageService>;
 31: 
 32:   // Mock data
 33:   const mockBlueprint: Blueprint = {
 34:     id: 'blueprint-1',
 35:     name: 'Test Blueprint',
 36:     description: 'Test Description',
 37:     owner_id: 'owner-1',
 38:     status: 'active',
 39:     created_at: '2024-01-01T00:00:00Z',
 40:     updated_at: '2024-01-01T00:00:00Z'
 41:   } as Blueprint;
 42: 
 43:   const mockTask: Task = {
 44:     id: 'task-1',
 45:     blueprint_id: 'blueprint-1',
 46:     title: 'Test Task',
 47:     task_type: 'task' as TaskType,
 48:     status: 'pending' as TaskStatus,
 49:     priority: 'medium' as TaskPriority,
 50:     progress_percentage: 0,
 51:     created_at: '2024-01-01T00:00:00Z',
 52:     updated_at: '2024-01-01T00:00:00Z'
 53:   } as Task;
 54: 
 55:   const mockStagingTask: Task = {
 56:     ...mockTask,
 57:     id: 'task-2',
 58:     status: 'staging' as TaskStatus
 59:   };
 60: 
 61:   const mockTaskStaging: TaskStaging = {
 62:     id: 'staging-1',
 63:     task_id: 'task-2',
 64:     submitted_by: 'user-1',
 65:     staging_data: {},
 66:     can_withdraw: true,
 67:     expires_at: new Date(Date.now() + 48 * 60 * 60 * 1000).toISOString(),
 68:     submitted_at: new Date().toISOString()
 69:   } as TaskStaging;
 70: 
 71:   const mockAccount: Account = {
 72:     id: 'user-1',
 73:     email: 'test@example.com',
 74:     username: 'testuser'
 75:   } as Account;
 76: 
 77:   beforeEach(async () => {
 78:     // Create spies with signal support
 79:     const taskServiceSpy = jasmine.createSpyObj('TaskService', [
 80:       'loadTasksByBlueprint',
 81:       'deleteTask',
 82:       'updateTaskStatus',
 83:       'getAllowedNextStatuses',
 84:       'getRecommendedNextStatus'
 85:     ]);
 86:     taskServiceSpy.tasks = signal([mockTask]);
 87:     taskServiceSpy.loading = signal(false);
 88:     taskServiceSpy.stagingTasks = signal([]);
 89: 
 90:     const blueprintServiceSpy = jasmine.createSpyObj('BlueprintService', ['loadBlueprints']);
 91:     blueprintServiceSpy.blueprints = signal([mockBlueprint]);
 92: 
 93:     const taskStagingServiceSpy = jasmine.createSpyObj('TaskStagingService', [
 94:       'loadStagingByTaskId',
 95:       'canWithdraw',
 96:       'withdrawStaging',
 97:       'confirmStaging'
 98:     ]);
 99:     taskStagingServiceSpy.stagingItems = signal([]);
100: 
101:     const authStateSpy = jasmine.createSpyObj('AuthStateService', []);
102:     authStateSpy.user = signal(mockAccount);
103: 
104:     const routerSpy = jasmine.createSpyObj('Router', ['navigate']);
105:     const messageSpy = jasmine.createSpyObj('NzMessageService', ['success', 'error']);
106: 
107:     await TestBed.configureTestingModule({
108:       imports: [TaskListComponent],
109:       providers: [
110:         { provide: TaskService, useValue: taskServiceSpy },
111:         { provide: BlueprintService, useValue: blueprintServiceSpy },
112:         { provide: TaskStagingService, useValue: taskStagingServiceSpy },
113:         { provide: AuthStateService, useValue: authStateSpy },
114:         { provide: Router, useValue: routerSpy },
115:         { provide: NzMessageService, useValue: messageSpy }
116:       ]
117:     }).compileComponents();
118: 
119:     mockTaskService = TestBed.inject(TaskService) as jasmine.SpyObj<TaskService>;
120:     mockBlueprintService = TestBed.inject(BlueprintService) as jasmine.SpyObj<BlueprintService>;
121:     mockTaskStagingService = TestBed.inject(TaskStagingService) as jasmine.SpyObj<TaskStagingService>;
122:     mockAuthState = TestBed.inject(AuthStateService) as jasmine.SpyObj<AuthStateService>;
123:     mockRouter = TestBed.inject(Router) as jasmine.SpyObj<Router>;
124:     mockMessage = TestBed.inject(NzMessageService) as jasmine.SpyObj<NzMessageService>;
125: 
126:     fixture = TestBed.createComponent(TaskListComponent);
127:     component = fixture.componentInstance;
128:   });
129: 
130:   it('should create', () => {
131:     expect(component).toBeTruthy();
132:   });
133: 
134:   describe('OnPush Change Detection', () => {
135:     it('should use OnPush strategy', () => {
136:       const metadata = (component.constructor as any).Éµcmp;
137:       expect(metadata.changeDetection).toBe(1); // OnPush = 1
138:     });
139:   });
140: 
141:   describe('Initialization', () => {
142:     it('should load blueprints on init', async () => {
143:       mockBlueprintService.loadBlueprints.and.returnValue(Promise.resolve());
144: 
145:       await component.ngOnInit();
146: 
147:       expect(mockBlueprintService.loadBlueprints).toHaveBeenCalled();
148:     });
149: 
150:     it('should show error message if blueprint loading fails', async () => {
151:       mockBlueprintService.loadBlueprints.and.returnValue(Promise.reject(new Error('Load failed')));
152: 
153:       await component.ngOnInit();
154: 
155:       expect(mockMessage.error).toHaveBeenCalledWith('åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
156:     });
157:   });
158: 
159:   describe('Blueprint Selection', () => {
160:     it('should load tasks when blueprint is selected', async () => {
161:       mockTaskService.loadTasksByBlueprint.and.returnValue(Promise.resolve());
162:       mockTaskService.stagingTasks = signal([]);
163: 
164:       component.selectedBlueprintId.set('blueprint-1');
165:       await component.onBlueprintChange();
166: 
167:       expect(mockTaskService.loadTasksByBlueprint).toHaveBeenCalledWith('blueprint-1');
168:     });
169: 
170:     it('should load staging info and allowed statuses after blueprint change', async () => {
171:       mockTaskService.loadTasksByBlueprint.and.returnValue(Promise.resolve());
172:       mockTaskService.stagingTasks = signal([]);
173:       mockTaskService.tasks = signal([mockTask]);
174:       mockTaskService.getAllowedNextStatuses.and.returnValue(Promise.resolve([TaskStatus.ASSIGNED]));
175: 
176:       component.selectedBlueprintId.set('blueprint-1');
177:       await component.onBlueprintChange();
178: 
179:       expect(mockTaskService.getAllowedNextStatuses).toHaveBeenCalledWith('task-1');
180:     });
181: 
182:     it('should show error message if task loading fails', async () => {
183:       mockTaskService.loadTasksByBlueprint.and.returnValue(Promise.reject(new Error('Load failed')));
184: 
185:       component.selectedBlueprintId.set('blueprint-1');
186:       await component.onBlueprintChange();
187: 
188:       expect(mockMessage.error).toHaveBeenCalledWith('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥');
189:     });
190:   });
191: 
192:   describe('Staging Information', () => {
193:     it('should load staging info for staging tasks', async () => {
194:       mockTaskService.stagingTasks = signal([mockStagingTask]);
195:       mockTaskStagingService.loadStagingByTaskId.and.returnValue(Promise.resolve());
196:       mockTaskStagingService.stagingItems = signal([mockTaskStaging]);
197:       mockTaskStagingService.canWithdraw.and.returnValue(Promise.resolve(true));
198: 
199:       await component.loadStagingInfo();
200: 
201:       expect(mockTaskStagingService.loadStagingByTaskId).toHaveBeenCalledWith('task-2');
202:       expect(mockTaskStagingService.canWithdraw).toHaveBeenCalledWith('staging-1');
203:       
204:       const info = component.stagingInfo();
205:       expect(info['task-2']).toBeDefined();
206:       expect(info['task-2'].canWithdraw).toBe(true);
207:       expect(info['task-2'].stagingId).toBe('staging-1');
208:     });
209: 
210:     it('should calculate remaining hours correctly', async () => {
211:       const futureDate = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 hours from now
212:       const staging = { ...mockTaskStaging, expires_at: futureDate.toISOString() };
213:       
214:       mockTaskService.stagingTasks = signal([mockStagingTask]);
215:       mockTaskStagingService.loadStagingByTaskId.and.returnValue(Promise.resolve());
216:       mockTaskStagingService.stagingItems = signal([staging]);
217:       mockTaskStagingService.canWithdraw.and.returnValue(Promise.resolve(true));
218: 
219:       await component.loadStagingInfo();
220: 
221:       const info = component.stagingInfo();
222:       expect(info['task-2'].remainingHours).toBeGreaterThanOrEqual(23);
223:       expect(info['task-2'].remainingHours).toBeLessThanOrEqual(24);
224:     });
225:   });
226: 
227:   describe('Allowed Statuses', () => {
228:     it('should load allowed next statuses for all tasks', async () => {
229:       mockTaskService.tasks = signal([mockTask]);
230:       mockTaskService.getAllowedNextStatuses.and.returnValue(
231:         Promise.resolve([TaskStatus.ASSIGNED, TaskStatus.IN_PROGRESS])
232:       );
233: 
234:       await component.loadAllowedStatuses();
235: 
236:       expect(mockTaskService.getAllowedNextStatuses).toHaveBeenCalledWith('task-1');
237:       
238:       const allowed = component.allowedStatuses();
239:       expect(allowed['task-1']).toEqual([TaskStatus.ASSIGNED, TaskStatus.IN_PROGRESS]);
240:     });
241: 
242:     it('should handle errors gracefully when loading allowed statuses', async () => {
243:       mockTaskService.tasks = signal([mockTask]);
244:       mockTaskService.getAllowedNextStatuses.and.returnValue(
245:         Promise.reject(new Error('Failed'))
246:       );
247: 
248:       await component.loadAllowedStatuses();
249: 
250:       const allowed = component.allowedStatuses();
251:       expect(allowed['task-1']).toEqual([]);
252:     });
253:   });
254: 
255:   describe('Status Transitions', () => {
256:     it('should change task status successfully', async () => {
257:       const updatedTask = { ...mockTask, status: 'assigned' as TaskStatus };
258:       mockTaskService.updateTaskStatus.and.returnValue(Promise.resolve(updatedTask));
259:       mockTaskService.stagingTasks = signal([]);
260:       mockTaskService.tasks = signal([updatedTask]);
261:       mockTaskService.getAllowedNextStatuses.and.returnValue(Promise.resolve([]));
262: 
263:       await component.changeTaskStatus('task-1', TaskStatus.ASSIGNED);
264: 
265:       expect(mockTaskService.updateTaskStatus).toHaveBeenCalledWith('task-1', TaskStatus.ASSIGNED);
266:       expect(mockMessage.success).toHaveBeenCalledWith('çŠ¶æ€æ›´æ–°æˆåŠŸ');
267:     });
268: 
269:     it('should show error message if status change fails', async () => {
270:       mockTaskService.updateTaskStatus.and.returnValue(
271:         Promise.reject(new Error('Invalid transition'))
272:       );
273: 
274:       await component.changeTaskStatus('task-1', TaskStatus.COMPLETED);
275: 
276:       expect(mockMessage.error).toHaveBeenCalledWith('Invalid transition');
277:     });
278: 
279:     it('should reload staging info after status change', async () => {
280:       mockTaskService.updateTaskStatus.and.returnValue(Promise.resolve(mockTask));
281:       mockTaskService.stagingTasks = signal([]);
282:       mockTaskService.tasks = signal([mockTask]);
283:       mockTaskService.getAllowedNextStatuses.and.returnValue(Promise.resolve([]));
284:       
285:       spyOn(component, 'loadStagingInfo').and.returnValue(Promise.resolve());
286:       spyOn(component, 'loadAllowedStatuses').and.returnValue(Promise.resolve());
287: 
288:       await component.changeTaskStatus('task-1', TaskStatus.ASSIGNED);
289: 
290:       expect(component.loadStagingInfo).toHaveBeenCalled();
291:       expect(component.loadAllowedStatuses).toHaveBeenCalled();
292:     });
293:   });
294: 
295:   describe('Staging Withdrawal', () => {
296:     beforeEach(() => {
297:       component.stagingInfo.set({
298:         'task-2': {
299:           remainingHours: 24,
300:           canWithdraw: true,
301:           stagingId: 'staging-1'
302:         }
303:       });
304:     });
305: 
306:     it('should withdraw staging successfully', async () => {
307:       mockTaskStagingService.withdrawStaging.and.returnValue(Promise.resolve(mockTaskStaging));
308:       mockTaskService.loadTasksByBlueprint.and.returnValue(Promise.resolve());
309:       mockTaskService.stagingTasks = signal([]);
310:       mockTaskService.tasks = signal([mockTask]);
311:       mockTaskService.getAllowedNextStatuses.and.returnValue(Promise.resolve([]));
312:       
313:       component.selectedBlueprintId.set('blueprint-1');
314:       
315:       await component.withdrawStaging('task-2');
316: 
317:       expect(mockTaskStagingService.withdrawStaging).toHaveBeenCalledWith('staging-1', 'user-1');
318:       expect(mockMessage.success).toHaveBeenCalledWith('æ’¤å›æˆåŠŸ');
319:     });
320: 
321:     it('should show error if staging info not found', async () => {
322:       await component.withdrawStaging('task-999');
323: 
324:       expect(mockMessage.error).toHaveBeenCalledWith('æ‰¾ä¸åˆ°æš‚å­˜ä¿¡æ¯');
325:       expect(mockTaskStagingService.withdrawStaging).not.toHaveBeenCalled();
326:     });
327: 
328:     it('should show error if user is not logged in', async () => {
329:       mockAuthState.user = signal(null);
330: 
331:       await component.withdrawStaging('task-2');
332: 
333:       expect(mockMessage.error).toHaveBeenCalledWith('æœªç™»å½•ç”¨æˆ·æ— æ³•æ‰§è¡Œæ­¤æ“ä½œ');
334:       expect(mockTaskStagingService.withdrawStaging).not.toHaveBeenCalled();
335:     });
336: 
337:     it('should show error message if withdrawal fails', async () => {
338:       mockTaskStagingService.withdrawStaging.and.returnValue(
339:         Promise.reject(new Error('Withdrawal failed'))
340:       );
341: 
342:       await component.withdrawStaging('task-2');
343: 
344:       expect(mockMessage.error).toHaveBeenCalledWith('Withdrawal failed');
345:     });
346:   });
347: 
348:   describe('Filters', () => {
349:     beforeEach(() => {
350:       const tasks: Task[] = [
351:         { ...mockTask, id: '1', status: 'pending' as TaskStatus, priority: 'low' as TaskPriority, task_type: 'task' as TaskType },
352:         { ...mockTask, id: '2', status: 'in_progress' as TaskStatus, priority: 'high' as TaskPriority, task_type: 'milestone' as TaskType },
353:         { ...mockTask, id: '3', status: 'staging' as TaskStatus, priority: 'urgent' as TaskPriority, task_type: 'phase' as TaskType },
354:         { ...mockTask, id: '4', status: 'completed' as TaskStatus, priority: 'medium' as TaskPriority, task_type: 'subtask' as TaskType }
355:       ];
356:       mockTaskService.tasks = signal(tasks);
357:     });
358: 
359:     it('should filter tasks by status', () => {
360:       component.filterStatus.set(TaskStatus.PENDING);
361:       
362:       const filtered = component.filteredTasks();
363:       
364:       expect(filtered.length).toBe(1);
365:       expect(filtered[0].status).toBe('pending');
366:     });
367: 
368:     it('should filter tasks by priority', () => {
369:       component.filterPriority.set(TaskPriority.HIGH);
370:       
371:       const filtered = component.filteredTasks();
372:       
373:       expect(filtered.length).toBe(1);
374:       expect(filtered[0].priority).toBe('high');
375:     });
376: 
377:     it('should filter tasks by type', () => {
378:       component.filterType.set(TaskType.MILESTONE);
379:       
380:       const filtered = component.filteredTasks();
381:       
382:       expect(filtered.length).toBe(1);
383:       expect(filtered[0].task_type).toBe('milestone');
384:     });
385: 
386:     it('should apply multiple filters simultaneously', () => {
387:       component.filterStatus.set(TaskStatus.STAGING);
388:       component.filterPriority.set(TaskPriority.URGENT);
389:       component.filterType.set(TaskType.PHASE);
390:       
391:       const filtered = component.filteredTasks();
392:       
393:       expect(filtered.length).toBe(1);
394:       expect(filtered[0].id).toBe('3');
395:     });
396: 
397:     it('should return all tasks when no filters are set', () => {
398:       const filtered = component.filteredTasks();
399:       
400:       expect(filtered.length).toBe(4);
401:     });
402:   });
403: 
404:   describe('Status Labels', () => {
405:     it('should return correct Chinese labels for all statuses', () => {
406:       expect(component.getStatusLabel(TaskStatus.PENDING)).toBe('å¾…å¤„ç†');
407:       expect(component.getStatusLabel(TaskStatus.ASSIGNED)).toBe('å·²æŒ‡æ´¾');
408:       expect(component.getStatusLabel(TaskStatus.IN_PROGRESS)).toBe('è¿›è¡Œä¸­');
409:       expect(component.getStatusLabel(TaskStatus.STAGING)).toBe('æš‚å­˜ä¸­');
410:       expect(component.getStatusLabel(TaskStatus.IN_QA)).toBe('å“ç®¡ä¸­');
411:       expect(component.getStatusLabel(TaskStatus.IN_INSPECTION)).toBe('éªŒæ”¶ä¸­');
412:       expect(component.getStatusLabel(TaskStatus.COMPLETED)).toBe('å·²å®Œæˆ');
413:       expect(component.getStatusLabel(TaskStatus.CANCELLED)).toBe('å·²å–æ¶ˆ');
414:     });
415:   });
416: 
417:   describe('Navigation', () => {
418:     it('should navigate to task detail on viewDetail', () => {
419:       component.viewDetail('task-1');
420:       
421:       expect(mockRouter.navigate).toHaveBeenCalledWith(['/tasks', 'task-1']);
422:     });
423: 
424:     it('should navigate to task edit on edit', () => {
425:       component.edit('task-1');
426:       
427:       expect(mockRouter.navigate).toHaveBeenCalledWith(['/tasks', 'task-1', 'edit']);
428:     });
429: 
430:     it('should navigate to task create on createTask', () => {
431:       component.createTask();
432:       
433:       expect(mockRouter.navigate).toHaveBeenCalledWith(['/tasks/create']);
434:     });
435:   });
436: 
437:   describe('Task Deletion', () => {
438:     it('should delete task successfully', async () => {
439:       mockTaskService.deleteTask.and.returnValue(Promise.resolve());
440: 
441:       await component.delete('task-1');
442: 
443:       expect(mockTaskService.deleteTask).toHaveBeenCalledWith('task-1');
444:       expect(mockMessage.success).toHaveBeenCalledWith('åˆ é™¤æˆåŠŸ');
445:     });
446: 
447:     it('should show error message if deletion fails', async () => {
448:       mockTaskService.deleteTask.and.returnValue(Promise.reject(new Error('Delete failed')));
449: 
450:       await component.delete('task-1');
451: 
452:       expect(mockMessage.error).toHaveBeenCalledWith('åˆ é™¤å¤±è´¥');
453:     });
454:   });
455: });
````

## File: src/app/routes/tasks/list/task-list.component.ts
````typescript
  1: import { Component, OnInit, OnDestroy, inject, signal, computed, ChangeDetectionStrategy } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { STColumn } from '@delon/abc/st';
  4: import {
  5:   SHARED_IMPORTS,
  6:   TaskService,
  7:   Task,
  8:   TaskStatus,
  9:   TaskType,
 10:   TaskPriority,
 11:   BlueprintService,
 12:   Blueprint,
 13:   TaskStagingService,
 14:   AuthStateService
 15: } from '@shared';
 16: import { NzMessageService } from 'ng-zorro-antd/message';
 17: 
 18: @Component({
 19:   selector: 'app-task-list',
 20:   standalone: true,
 21:   imports: [SHARED_IMPORTS],
 22:   changeDetection: ChangeDetectionStrategy.OnPush,
 23:   template: `
 24:     <page-header [title]="'ä»»åŠ¡åˆ—è¡¨'">
 25:       <ng-template #extra>
 26:         <button nz-button nzType="primary" (click)="createTask()">
 27:           <span nz-icon nzType="plus"></span>
 28:           æ–°å»ºä»»åŠ¡
 29:         </button>
 30:       </ng-template>
 31:     </page-header>
 32: 
 33:     <nz-card nzTitle="ä»»åŠ¡åˆ—è¡¨" style="margin-top: 16px;">
 34:       <!-- Blueprint and Filters -->
 35:       <div style="margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
 36:         <nz-form-item style="margin-bottom: 0;">
 37:           <nz-form-label>é€‰æ‹©è“å›¾</nz-form-label>
 38:           <nz-form-control>
 39:             <nz-select
 40:               [ngModel]="selectedBlueprintId()"
 41:               (ngModelChange)="selectedBlueprintId.set($event); onBlueprintChange()"
 42:               nzPlaceHolder="è¯·é€‰æ‹©è“å›¾"
 43:               style="width: 250px;"
 44:             >
 45:               @for (blueprint of blueprintService.blueprints(); track blueprint.id) {
 46:                 <nz-option [nzValue]="blueprint.id" [nzLabel]="blueprint.name"></nz-option>
 47:               }
 48:             </nz-select>
 49:           </nz-form-control>
 50:         </nz-form-item>
 51: 
 52:         @if (selectedBlueprintId()) {
 53:           <nz-form-item style="margin-bottom: 0;">
 54:             <nz-form-label>çŠ¶æ€</nz-form-label>
 55:             <nz-form-control>
 56:               <nz-select
 57:                 [ngModel]="filterStatus()"
 58:                 (ngModelChange)="filterStatus.set($event)"
 59:                 nzPlaceHolder="å…¨éƒ¨çŠ¶æ€"
 60:                 nzAllowClear
 61:                 style="width: 150px;"
 62:               >
 63:                 <nz-option nzValue="pending" nzLabel="å¾…å¤„ç†"></nz-option>
 64:                 <nz-option nzValue="assigned" nzLabel="å·²æŒ‡æ´¾"></nz-option>
 65:                 <nz-option nzValue="in_progress" nzLabel="è¿›è¡Œä¸­"></nz-option>
 66:                 <nz-option nzValue="staging" nzLabel="æš‚å­˜ä¸­"></nz-option>
 67:                 <nz-option nzValue="in_qa" nzLabel="å“ç®¡ä¸­"></nz-option>
 68:                 <nz-option nzValue="in_inspection" nzLabel="éªŒæ”¶ä¸­"></nz-option>
 69:                 <nz-option nzValue="completed" nzLabel="å·²å®Œæˆ"></nz-option>
 70:                 <nz-option nzValue="cancelled" nzLabel="å·²å–æ¶ˆ"></nz-option>
 71:               </nz-select>
 72:             </nz-form-control>
 73:           </nz-form-item>
 74: 
 75:           <nz-form-item style="margin-bottom: 0;">
 76:             <nz-form-label>ä¼˜å…ˆçº§</nz-form-label>
 77:             <nz-form-control>
 78:               <nz-select
 79:                 [ngModel]="filterPriority()"
 80:                 (ngModelChange)="filterPriority.set($event)"
 81:                 nzPlaceHolder="å…¨éƒ¨ä¼˜å…ˆçº§"
 82:                 nzAllowClear
 83:                 style="width: 120px;"
 84:               >
 85:                 <nz-option nzValue="low" nzLabel="ä½"></nz-option>
 86:                 <nz-option nzValue="medium" nzLabel="ä¸­"></nz-option>
 87:                 <nz-option nzValue="high" nzLabel="é«˜"></nz-option>
 88:                 <nz-option nzValue="urgent" nzLabel="ç´§æ€¥"></nz-option>
 89:               </nz-select>
 90:             </nz-form-control>
 91:           </nz-form-item>
 92: 
 93:           <nz-form-item style="margin-bottom: 0;">
 94:             <nz-form-label>ç±»å‹</nz-form-label>
 95:             <nz-form-control>
 96:               <nz-select
 97:                 [ngModel]="filterType()"
 98:                 (ngModelChange)="filterType.set($event)"
 99:                 nzPlaceHolder="å…¨éƒ¨ç±»å‹"
100:                 nzAllowClear
101:                 style="width: 120px;"
102:               >
103:                 <nz-option nzValue="milestone" nzLabel="é‡Œç¨‹ç¢‘"></nz-option>
104:                 <nz-option nzValue="phase" nzLabel="é˜¶æ®µ"></nz-option>
105:                 <nz-option nzValue="task" nzLabel="ä»»åŠ¡"></nz-option>
106:                 <nz-option nzValue="subtask" nzLabel="å­ä»»åŠ¡"></nz-option>
107:               </nz-select>
108:             </nz-form-control>
109:           </nz-form-item>
110:         }
111:       </div>
112: 
113:       @if (!selectedBlueprintId()) {
114:         <nz-empty nzNotFoundContent="è¯·å…ˆé€‰æ‹©è“å›¾"></nz-empty>
115:       } @else {
116:         <st
117:           #st
118:           [data]="filteredTasks()"
119:           [columns]="columns"
120:           [loading]="taskService.loading()"
121:           [page]="{ front: false, show: true, showSize: true }"
122:           (change)="onTableChange()"
123:         >
124:           <ng-template #type let-record>
125:             @switch (record.task_type) {
126:               @case ('milestone') {
127:                 <nz-tag nzColor="purple">é‡Œç¨‹ç¢‘</nz-tag>
128:               }
129:               @case ('phase') {
130:                 <nz-tag nzColor="blue">é˜¶æ®µ</nz-tag>
131:               }
132:               @case ('task') {
133:                 <nz-tag nzColor="cyan">ä»»åŠ¡</nz-tag>
134:               }
135:               @case ('subtask') {
136:                 <nz-tag nzColor="default">å­ä»»åŠ¡</nz-tag>
137:               }
138:             }
139:           </ng-template>
140: 
141:           <ng-template #status let-record>
142:             @switch (record.status) {
143:               @case ('pending') {
144:                 <nz-tag nzColor="default">å¾…å¤„ç†</nz-tag>
145:               }
146:               @case ('assigned') {
147:                 <nz-tag nzColor="blue">å·²æŒ‡æ´¾</nz-tag>
148:               }
149:               @case ('in_progress') {
150:                 <nz-tag nzColor="processing">è¿›è¡Œä¸­</nz-tag>
151:               }
152:               @case ('staging') {
153:                 <div style="display: flex; flex-direction: column; gap: 4px;">
154:                   <nz-tag nzColor="orange">æš‚å­˜ä¸­</nz-tag>
155:                   @if (stagingInfo()[record.id]) {
156:                     <small style="color: #ff7a45;">
157:                       å‰©ä½™ {{ stagingInfo()[record.id].remainingHours }}h
158:                     </small>
159:                   }
160:                 </div>
161:               }
162:               @case ('in_qa') {
163:                 <nz-tag nzColor="gold">å“ç®¡ä¸­</nz-tag>
164:               }
165:               @case ('in_inspection') {
166:                 <nz-tag nzColor="lime">éªŒæ”¶ä¸­</nz-tag>
167:               }
168:               @case ('completed') {
169:                 <nz-tag nzColor="success">å·²å®Œæˆ</nz-tag>
170:               }
171:               @case ('cancelled') {
172:                 <nz-tag nzColor="error">å·²å–æ¶ˆ</nz-tag>
173:               }
174:             }
175:           </ng-template>
176: 
177:           <ng-template #priority let-record>
178:             @switch (record.priority) {
179:               @case ('low') {
180:                 <nz-tag nzColor="default">ä½</nz-tag>
181:               }
182:               @case ('medium') {
183:                 <nz-tag nzColor="blue">ä¸­</nz-tag>
184:               }
185:               @case ('high') {
186:                 <nz-tag nzColor="orange">é«˜</nz-tag>
187:               }
188:               @case ('urgent') {
189:                 <nz-tag nzColor="red">ç´§æ€¥</nz-tag>
190:               }
191:             }
192:           </ng-template>
193: 
194:           <ng-template #statusActions let-record>
195:             @if (record.status !== 'completed' && record.status !== 'cancelled') {
196:               <button
197:                 nz-button
198:                 nzType="link"
199:                 nz-dropdown
200:                 [nzDropdownMenu]="statusMenu"
201:                 nzSize="small"
202:               >
203:                 å˜æ›´çŠ¶æ€
204:                 <span nz-icon nzType="down"></span>
205:               </button>
206:               <nz-dropdown-menu #statusMenu="nzDropdownMenu">
207:                 <ul nz-menu>
208:                   @for (status of allowedStatuses()[record.id]; track status) {
209:                     <li nz-menu-item (click)="changeTaskStatus(record.id, status)">
210:                       {{ getStatusLabel(status) }}
211:                     </li>
212:                   }
213:                   @if (!allowedStatuses()[record.id] || allowedStatuses()[record.id].length === 0) {
214:                     <li nz-menu-item nzDisabled>æ— å¯ç”¨è½¬æ¢</li>
215:                   }
216:                 </ul>
217:               </nz-dropdown-menu>
218:             }
219:           </ng-template>
220: 
221:           <ng-template #stagingActions let-record>
222:             @if (record.status === 'staging' && stagingInfo()[record.id]?.canWithdraw) {
223:               <button
224:                 nz-button
225:                 nzType="link"
226:                 nzDanger
227:                 nzSize="small"
228:                 (click)="withdrawStaging(record.id)"
229:               >
230:                 æ’¤å›
231:               </button>
232:             }
233:           </ng-template>
234:         </st>
235:       }
236:     </nz-card>
237:   `
238: })
239: export class TaskListComponent implements OnInit, OnDestroy {
240:   taskService = inject(TaskService);
241:   blueprintService = inject(BlueprintService);
242:   taskStagingService = inject(TaskStagingService);
243:   authState = inject(AuthStateService);
244:   router = inject(Router);
245:   message = inject(NzMessageService);
246: 
247:   // Component signals
248:   selectedBlueprintId = signal<string | null>(null);
249:   filterStatus = signal<TaskStatus | null>(null);
250:   filterPriority = signal<TaskPriority | null>(null);
251:   filterType = signal<TaskType | null>(null);
252: 
253:   // Staging info map: taskId -> { remainingHours, canWithdraw, stagingId }
254:   stagingInfo = signal<Record<string, { remainingHours: number; canWithdraw: boolean; stagingId: string }>>({});
255: 
256:   // Allowed statuses map: taskId -> TaskStatus[]
257:   allowedStatuses = signal<Record<string, TaskStatus[]>>({});
258: 
259:   // Computed filtered tasks
260:   filteredTasks = computed(() => {
261:     let tasks = this.taskService.tasks();
262: 
263:     if (this.filterStatus()) {
264:       tasks = tasks.filter(t => t.status === this.filterStatus());
265:     }
266: 
267:     if (this.filterPriority()) {
268:       tasks = tasks.filter(t => t.priority === this.filterPriority());
269:     }
270: 
271:     if (this.filterType()) {
272:       tasks = tasks.filter(t => t.task_type === this.filterType());
273:     }
274: 
275:     return tasks;
276:   });
277: 
278:   columns: STColumn[] = [
279:     { title: 'ID', index: 'id', width: 100 },
280:     { title: 'æ ‡é¢˜', index: 'title', width: 250 },
281:     { title: 'ç±»å‹', index: 'task_type', width: 100, render: 'type' },
282:     { title: 'çŠ¶æ€', index: 'status', width: 120, render: 'status' },
283:     { title: 'ä¼˜å…ˆçº§', index: 'priority', width: 100, render: 'priority' },
284:     { title: 'è®¡åˆ’å¼€å§‹', index: 'planned_start_date', type: 'date', width: 120 },
285:     { title: 'è®¡åˆ’ç»“æŸ', index: 'planned_end_date', type: 'date', width: 120 },
286:     { title: 'è¿›åº¦', index: 'progress_percentage', width: 100, format: (item: Task) => `${item.progress_percentage || 0}%` },
287:     { title: 'åˆ›å»ºæ—¶é—´', index: 'created_at', type: 'date', width: 180 },
288:     {
289:       title: 'æ“ä½œ',
290:       width: 320,
291:       buttons: [
292:         {
293:           text: 'æŸ¥çœ‹',
294:           click: (record: Task) => this.viewDetail(record.id)
295:         },
296:         {
297:           text: 'ç¼–è¾‘',
298:           click: (record: Task) => this.edit(record.id)
299:         },
300:         {
301:           text: 'å˜æ›´çŠ¶æ€',
302:           type: 'none',
303:           render: 'statusActions'
304:         },
305:         {
306:           text: 'æš‚å­˜æ“ä½œ',
307:           type: 'none',
308:           render: 'stagingActions',
309:           iif: (record: Task) => record.status === 'staging'
310:         },
311:         {
312:           text: 'åˆ é™¤',
313:           type: 'del',
314:           pop: true,
315:           click: (record: Task) => this.delete(record.id)
316:         }
317:       ]
318:     }
319:   ];
320: 
321:   ngOnInit(): void {
322:     this.loadBlueprints();
323:   }
324: 
325:   ngOnDestroy(): void {
326:     // Cleanup if needed
327:   }
328: 
329:   async loadBlueprints(): Promise<void> {
330:     try {
331:       await this.blueprintService.loadBlueprints();
332:     } catch (error) {
333:       this.message.error('åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
334:     }
335:   }
336: 
337:   async onBlueprintChange(): Promise<void> {
338:     const blueprintId = this.selectedBlueprintId();
339:     if (blueprintId) {
340:       try {
341:         await this.taskService.loadTasksByBlueprint(blueprintId);
342:         await this.loadStagingInfo();
343:         await this.loadAllowedStatuses();
344:       } catch (error) {
345:         this.message.error('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥');
346:       }
347:     }
348:   }
349: 
350:   /**
351:    * Load staging information for all staging tasks
352:    */
353:   async loadStagingInfo(): Promise<void> {
354:     const stagingTasks = this.taskService.stagingTasks();
355:     const info: Record<string, { remainingHours: number; canWithdraw: boolean; stagingId: string }> = {};
356: 
357:     for (const task of stagingTasks) {
358:       try {
359:         await this.taskStagingService.loadStagingByTaskId(task.id);
360:         const stagingItems = this.taskStagingService.stagingItems();
361:         const stagingItem = stagingItems.find(s => s.task_id === task.id);
362: 
363:         if (stagingItem) {
364:           const now = new Date();
365:           const expiresAt = new Date(stagingItem.expires_at);
366:           const remainingMs = expiresAt.getTime() - now.getTime();
367:           const remainingHours = Math.max(0, Math.floor(remainingMs / (1000 * 60 * 60)));
368: 
369:           const canWithdraw = await this.taskStagingService.canWithdraw(stagingItem.id);
370: 
371:           info[task.id] = {
372:             remainingHours,
373:             canWithdraw,
374:             stagingId: stagingItem.id
375:           };
376:         }
377:       } catch (error) {
378:         console.error(`Failed to load staging info for task ${task.id}:`, error);
379:       }
380:     }
381: 
382:     this.stagingInfo.set(info);
383:   }
384: 
385:   /**
386:    * Load allowed next statuses for all tasks
387:    */
388:   async loadAllowedStatuses(): Promise<void> {
389:     const tasks = this.taskService.tasks();
390:     const allowed: Record<string, TaskStatus[]> = {};
391: 
392:     for (const task of tasks) {
393:       try {
394:         const statuses = await this.taskService.getAllowedNextStatuses(task.id);
395:         allowed[task.id] = statuses;
396:       } catch (error) {
397:         console.error(`Failed to load allowed statuses for task ${task.id}:`, error);
398:         allowed[task.id] = [];
399:       }
400:     }
401: 
402:     this.allowedStatuses.set(allowed);
403:   }
404: 
405:   /**
406:    * Change task status
407:    */
408:   async changeTaskStatus(taskId: string, newStatus: TaskStatus): Promise<void> {
409:     try {
410:       await this.taskService.updateTaskStatus(taskId, newStatus);
411:       this.message.success('çŠ¶æ€æ›´æ–°æˆåŠŸ');
412:       
413:       // Reload staging info if transitioning to/from staging
414:       await this.loadStagingInfo();
415:       await this.loadAllowedStatuses();
416:     } catch (error) {
417:       this.message.error(error instanceof Error ? error.message : 'çŠ¶æ€æ›´æ–°å¤±è´¥');
418:     }
419:   }
420: 
421:   /**
422:    * Withdraw task from staging
423:    */
424:   async withdrawStaging(taskId: string): Promise<void> {
425:     const info = this.stagingInfo()[taskId];
426:     if (!info) {
427:       this.message.error('æ‰¾ä¸åˆ°æš‚å­˜ä¿¡æ¯');
428:       return;
429:     }
430: 
431:     const currentUser = this.authState.user();
432:     if (!currentUser) {
433:       this.message.error('æœªç™»å½•ç”¨æˆ·æ— æ³•æ‰§è¡Œæ­¤æ“ä½œ');
434:       return;
435:     }
436: 
437:     try {
438:       await this.taskStagingService.withdrawStaging(info.stagingId, currentUser.id);
439:       this.message.success('æ’¤å›æˆåŠŸ');
440:       
441:       // Reload data
442:       await this.onBlueprintChange();
443:     } catch (error) {
444:       this.message.error(error instanceof Error ? error.message : 'æ’¤å›å¤±è´¥');
445:     }
446:   }
447: 
448:   /**
449:    * Get status label in Chinese
450:    */
451:   getStatusLabel(status: TaskStatus): string {
452:     const labels: Record<TaskStatus, string> = {
453:       [TaskStatus.PENDING]: 'å¾…å¤„ç†',
454:       [TaskStatus.ASSIGNED]: 'å·²æŒ‡æ´¾',
455:       [TaskStatus.IN_PROGRESS]: 'è¿›è¡Œä¸­',
456:       [TaskStatus.STAGING]: 'æš‚å­˜ä¸­',
457:       [TaskStatus.IN_QA]: 'å“ç®¡ä¸­',
458:       [TaskStatus.IN_INSPECTION]: 'éªŒæ”¶ä¸­',
459:       [TaskStatus.COMPLETED]: 'å·²å®Œæˆ',
460:       [TaskStatus.CANCELLED]: 'å·²å–æ¶ˆ'
461:     };
462:     return labels[status] || status;
463:   }
464: 
465:   onTableChange(): void {
466:     // å¤„ç†è¡¨æ ¼å˜åŒ–äº‹ä»¶ï¼ˆåˆ†é¡µã€æ’åºç­‰ï¼‰
467:   }
468: 
469:   createTask(): void {
470:     this.router.navigate(['/tasks/create']);
471:   }
472: 
473:   viewDetail(id: string): void {
474:     this.router.navigate(['/tasks', id]);
475:   }
476: 
477:   edit(id: string): void {
478:     this.router.navigate(['/tasks', id, 'edit']);
479:   }
480: 
481:   async delete(id: string): Promise<void> {
482:     try {
483:       await this.taskService.deleteTask(id);
484:       this.message.success('åˆ é™¤æˆåŠŸ');
485:     } catch (error) {
486:       this.message.error('åˆ é™¤å¤±è´¥');
487:     }
488:   }
489: }
````

## File: src/app/routes/tasks/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: 
 3: export const TASK_ROUTES: Routes = [
 4:   {
 5:     path: '',
 6:     redirectTo: 'list',
 7:     pathMatch: 'full'
 8:   },
 9:   {
10:     path: 'list',
11:     loadComponent: () => import('./list/task-list.component').then(m => m.TaskListComponent)
12:   },
13:   {
14:     path: 'board',
15:     loadComponent: () => import('./board/task-board.component').then(m => m.TaskBoardComponent)
16:   },
17:   {
18:     path: 'calendar',
19:     loadComponent: () => import('./calendar/task-calendar.component').then(m => m.TaskCalendarComponent)
20:   },
21:   {
22:     path: 'detail',
23:     loadComponent: () => import('./detail-shell/task-detail-shell.component').then(m => m.TaskDetailShellComponent)
24:   },
25:   {
26:     path: 'form',
27:     loadComponent: () => import('./form-hub/task-form-hub.component').then(m => m.TaskFormHubComponent)
28:   },
29:   {
30:     path: 'create',
31:     loadComponent: () => import('./form/task-form.component').then(m => m.TaskFormComponent)
32:   },
33:   {
34:     path: 'assignments',
35:     loadComponent: () => import('./assignments/task-assignments.component').then(m => m.TaskAssignmentsComponent)
36:   },
37:   {
38:     path: 'todo',
39:     loadComponent: () => import('./todo/task-todo.component').then(m => m.TaskTodoComponent)
40:   },
41:   {
42:     path: 'staging',
43:     loadComponent: () => import('./staging/task-staging.component').then(m => m.TaskStagingComponent)
44:   },
45:   {
46:     path: 'daily-reports',
47:     loadComponent: () => import('./daily-reports/daily-reports.component').then(m => m.DailyReportsComponent)
48:   },
49:   {
50:     path: 'photos',
51:     loadComponent: () => import('./photos/task-photos.component').then(m => m.TaskPhotosComponent)
52:   },
53:   {
54:     path: 'weather',
55:     loadComponent: () => import('./weather/task-weather.component').then(m => m.TaskWeatherComponent)
56:   },
57:   {
58:     path: 'progress',
59:     loadComponent: () => import('./progress/task-progress').then(m => m.TaskProgressComponent)
60:   },
61:   {
62:     path: ':id',
63:     loadComponent: () => import('./detail/task-detail.component').then(m => m.TaskDetailComponent)
64:   },
65:   {
66:     path: ':id/edit',
67:     loadComponent: () => import('./form/task-form.component').then(m => m.TaskFormComponent)
68:   }
69: ];
````

## File: src/app/shared/components/chart-wrapper/chart-wrapper.component.ts
````typescript
  1: import { Component, ChangeDetectionStrategy, input, effect } from '@angular/core';
  2: import { SHARED_IMPORTS } from '@shared';
  3: 
  4: export interface ChartData {
  5:   labels: string[];
  6:   datasets: {
  7:     label: string;
  8:     data: number[];
  9:     backgroundColor?: string | string[];
 10:     borderColor?: string | string[];
 11:     borderWidth?: number;
 12:   }[];
 13: }
 14: 
 15: export type ChartType = 'line' | 'bar' | 'pie' | 'doughnut' | 'radar' | 'polarArea';
 16: 
 17: /**
 18:  * åœ–è¡¨å°è£å…ƒä»¶
 19:  * 
 20:  * ç”¨é€”ï¼šçµ±ä¸€çš„åœ–è¡¨é¡¯ç¤ºä»‹é¢ï¼Œæ”¯æ´å¤šç¨®åœ–è¡¨é¡å‹
 21:  * 
 22:  * @example
 23:  * ```html
 24:  * <app-chart-wrapper 
 25:  *   [type]="'bar'"
 26:  *   [data]="chartData()"
 27:  *   [title]="'æœˆåº¦çµ±è¨ˆ'"
 28:  *   [height]="300" />
 29:  * ```
 30:  */
 31: @Component({
 32:   selector: 'app-chart-wrapper',
 33:   standalone: true,
 34:   imports: [SHARED_IMPORTS],
 35:   changeDetection: ChangeDetectionStrategy.OnPush,
 36:   template: `
 37:     <nz-card [nzTitle]="title()" class="chart-card">
 38:       @if (loading()) {
 39:         <div class="chart-loading">
 40:           <nz-spin nzSize="large" />
 41:         </div>
 42:       } @else if (data()) {
 43:         <div class="chart-container" [style.height.px]="height()">
 44:           <!-- Chart will be rendered here using a charting library -->
 45:           <div class="chart-placeholder">
 46:             <span nz-icon nzType="bar-chart" nzTheme="outline" class="chart-icon"></span>
 47:             <p class="chart-type-label">{{ getChartTypeLabel() }} åœ–è¡¨</p>
 48:             <p class="chart-info">åœ–è¡¨é¡å‹: {{ type() }}</p>
 49:             <p class="chart-info">è³‡æ–™é»æ•¸: {{ getDataPointsCount() }}</p>
 50:             
 51:             <!-- Simple data preview -->
 52:             <div class="data-preview">
 53:               <h4>è³‡æ–™é è¦½ï¼š</h4>
 54:               <nz-tag *ngFor="let label of data()!.labels.slice(0, 5)" nzColor="blue">
 55:                 {{ label }}
 56:               </nz-tag>
 57:               @if (data()!.labels.length > 5) {
 58:                 <nz-tag>...</nz-tag>
 59:               }
 60:             </div>
 61: 
 62:             <nz-alert
 63:               nzType="info"
 64:               nzMessage="åœ–è¡¨æ¸²æŸ“èªªæ˜"
 65:               nzDescription="æ­¤å…ƒä»¶ç‚ºåœ–è¡¨å°è£ä»‹é¢ï¼Œå¯¦éš›åœ–è¡¨æ¸²æŸ“éœ€æ•´åˆ ECharts æˆ– ngx-charts ç­‰åœ–è¡¨åº«ã€‚"
 66:               [nzCloseable]="true"
 67:               class="chart-alert" />
 68:           </div>
 69:         </div>
 70:       } @else {
 71:         <nz-empty nzNotFoundContent="æš«ç„¡åœ–è¡¨è³‡æ–™" />
 72:       }
 73: 
 74:       @if (description()) {
 75:         <div class="chart-description">
 76:           {{ description() }}
 77:         </div>
 78:       }
 79:     </nz-card>
 80:   `,
 81:   styles: [`
 82:     .chart-card {
 83:       height: 100%;
 84: 
 85:       :host ::ng-deep .ant-card-body {
 86:         padding: 24px;
 87:       }
 88:     }
 89: 
 90:     .chart-loading {
 91:       display: flex;
 92:       align-items: center;
 93:       justify-content: center;
 94:       min-height: 300px;
 95:     }
 96: 
 97:     .chart-container {
 98:       position: relative;
 99:       width: 100%;
100:     }
101: 
102:     .chart-placeholder {
103:       display: flex;
104:       flex-direction: column;
105:       align-items: center;
106:       justify-content: center;
107:       height: 100%;
108:       background: #fafafa;
109:       border: 2px dashed #d9d9d9;
110:       border-radius: 4px;
111:       padding: 24px;
112: 
113:       .chart-icon {
114:         font-size: 64px;
115:         color: #d9d9d9;
116:         margin-bottom: 16px;
117:       }
118: 
119:       .chart-type-label {
120:         font-size: 18px;
121:         font-weight: 500;
122:         color: rgba(0, 0, 0, 0.85);
123:         margin-bottom: 8px;
124:       }
125: 
126:       .chart-info {
127:         font-size: 14px;
128:         color: rgba(0, 0, 0, 0.45);
129:         margin-bottom: 4px;
130:       }
131: 
132:       .data-preview {
133:         margin-top: 16px;
134:         text-align: center;
135: 
136:         h4 {
137:           font-size: 14px;
138:           margin-bottom: 8px;
139:         }
140: 
141:         nz-tag {
142:           margin: 4px;
143:         }
144:       }
145: 
146:       .chart-alert {
147:         margin-top: 16px;
148:         max-width: 500px;
149:       }
150:     }
151: 
152:     .chart-description {
153:       margin-top: 16px;
154:       padding-top: 16px;
155:       border-top: 1px solid #f0f0f0;
156:       color: rgba(0, 0, 0, 0.65);
157:       font-size: 14px;
158:       line-height: 1.6;
159:     }
160:   `]
161: })
162: export class ChartWrapperComponent {
163:   /** åœ–è¡¨é¡å‹ */
164:   type = input.required<ChartType>();
165: 
166:   /** åœ–è¡¨è³‡æ–™ */
167:   data = input<ChartData>();
168: 
169:   /** åœ–è¡¨æ¨™é¡Œ */
170:   title = input<string>('åœ–è¡¨');
171: 
172:   /** åœ–è¡¨é«˜åº¦ */
173:   height = input<number>(300);
174: 
175:   /** åœ–è¡¨æè¿° */
176:   description = input<string>();
177: 
178:   /** è¼‰å…¥ç‹€æ…‹ */
179:   loading = input<boolean>(false);
180: 
181:   /**
182:    * å–å¾—åœ–è¡¨é¡å‹æ¨™ç±¤
183:    */
184:   getChartTypeLabel(): string {
185:     const labels: Record<ChartType, string> = {
186:       line: 'æŠ˜ç·š',
187:       bar: 'æŸ±ç‹€',
188:       pie: 'åœ“é¤…',
189:       doughnut: 'ç’°åœˆ',
190:       radar: 'é›·é”',
191:       polarArea: 'æ¥µå€'
192:     };
193:     return labels[this.type()];
194:   }
195: 
196:   /**
197:    * å–å¾—è³‡æ–™é»æ•¸é‡
198:    */
199:   getDataPointsCount(): number {
200:     const chartData = this.data();
201:     if (!chartData) return 0;
202:     
203:     return chartData.datasets.reduce((sum, dataset) => {
204:       return sum + dataset.data.length;
205:     }, 0);
206:   }
207: 
208:   constructor() {
209:     // Effect to handle data changes and trigger chart rendering
210:     effect(() => {
211:       const chartData = this.data();
212:       const chartType = this.type();
213:       
214:       if (chartData && chartType) {
215:         // Here you would integrate with actual charting library
216:         // e.g., ECharts, Chart.js, or ngx-charts
217:         console.log('Chart data updated:', { type: chartType, data: chartData });
218:       }
219:     });
220:   }
221: }
````

## File: src/app/shared/components/chart-wrapper/index.ts
````typescript
1: export * from './chart-wrapper.component';
````

## File: src/app/shared/components/comment-thread/comment-thread.component.ts
````typescript
  1: import { Component, ChangeDetectionStrategy, input, output } from '@angular/core';
  2: import { SHARED_IMPORTS } from '@shared';
  3: 
  4: export interface CommentData {
  5:   id: string;
  6:   content: string;
  7:   authorId: string;
  8:   authorName: string;
  9:   authorAvatar?: string;
 10:   createdAt: string;
 11:   updatedAt?: string;
 12:   parentId?: string;
 13:   replies?: CommentData[];
 14:   mentions?: string[];
 15: }
 16: 
 17: /**
 18:  * è¨è«–ä¸²å…ƒä»¶
 19:  * 
 20:  * ç”¨é€”ï¼šå·¢ç‹€ç•™è¨€è¨è«–ï¼Œæ”¯æ´ @æåŠå’Œå³æ™‚æ›´æ–°
 21:  * 
 22:  * @example
 23:  * ```html
 24:  * <app-comment-thread 
 25:  *   [comments]="comments()"
 26:  *   [currentUserId]="userId()"
 27:  *   (commentSubmit)="handleSubmit($event)"
 28:  *   (commentEdit)="handleEdit($event)"
 29:  *   (commentDelete)="handleDelete($event)" />
 30:  * ```
 31:  */
 32: @Component({
 33:   selector: 'app-comment-thread',
 34:   standalone: true,
 35:   imports: [SHARED_IMPORTS],
 36:   changeDetection: ChangeDetectionStrategy.OnPush,
 37:   template: `
 38:     <div class="comment-thread">
 39:       <!-- Add comment -->
 40:       <div class="comment-editor">
 41:         <nz-comment>
 42:           <nz-avatar 
 43:             nz-comment-avatar
 44:             [nzSrc]="currentUserAvatar() || undefined"
 45:             [nzText]="currentUserName().charAt(0)" />
 46:           <nz-comment-content>
 47:             <textarea
 48:               nz-input
 49:               [(ngModel)]="newCommentText"
 50:               [placeholder]="'è¼¸å…¥ç•™è¨€... ä½¿ç”¨ @ æåŠå…¶ä»–äºº'"
 51:               [nzAutosize]="{ minRows: 3, maxRows: 6 }"
 52:               (keydown.enter)="handleKeyDown($event)">
 53:             </textarea>
 54:             <div class="comment-actions">
 55:               <button 
 56:                 nz-button 
 57:                 nzType="primary" 
 58:                 nzSize="small"
 59:                 [disabled]="!newCommentText.trim()"
 60:                 (click)="submitComment()">
 61:                 <span nz-icon nzType="send"></span>
 62:                 ç™¼é€
 63:               </button>
 64:               <button 
 65:                 nz-button 
 66:                 nzType="default" 
 67:                 nzSize="small"
 68:                 (click)="cancelComment()">
 69:                 å–æ¶ˆ
 70:               </button>
 71:             </div>
 72:           </nz-comment-content>
 73:         </nz-comment>
 74:       </div>
 75: 
 76:       <!-- Comment list -->
 77:       <nz-list 
 78:         [nzDataSource]="topLevelComments()" 
 79:         [nzRenderItem]="commentTemplate"
 80:         class="comment-list">
 81:         
 82:         <ng-template #commentTemplate let-comment>
 83:           <nz-comment>
 84:             <nz-avatar 
 85:               nz-comment-avatar
 86:               [nzSrc]="comment.authorAvatar || undefined"
 87:               [nzText]="comment.authorName.charAt(0)" />
 88:             
 89:             <nz-comment-content>
 90:               <p class="comment-author">
 91:                 {{ comment.authorName }}
 92:                 <span class="comment-time">{{ comment.createdAt | date:'yyyy-MM-dd HH:mm' }}</span>
 93:               </p>
 94:               
 95:               <div class="comment-text" [innerHTML]="formatCommentContent(comment.content)"></div>
 96: 
 97:               @if (comment.updatedAt && comment.updatedAt !== comment.createdAt) {
 98:                 <span class="comment-edited">(å·²ç·¨è¼¯)</span>
 99:               }
100: 
101:               <div class="comment-actions-inline">
102:                 <button 
103:                   nz-button 
104:                   nzType="link" 
105:                   nzSize="small"
106:                   (click)="replyToComment(comment)">
107:                   <span nz-icon nzType="message"></span>
108:                   å›è¦†
109:                 </button>
110:                 
111:                 @if (canEditComment(comment)) {
112:                   <button 
113:                     nz-button 
114:                     nzType="link" 
115:                     nzSize="small"
116:                     (click)="editComment(comment)">
117:                     <span nz-icon nzType="edit"></span>
118:                     ç·¨è¼¯
119:                   </button>
120:                 }
121: 
122:                 @if (canDeleteComment(comment)) {
123:                   <button 
124:                     nz-button 
125:                     nzType="link" 
126:                     nzSize="small"
127:                     nzDanger
128:                     (click)="deleteComment(comment)">
129:                     <span nz-icon nzType="delete"></span>
130:                     åˆªé™¤
131:                   </button>
132:                 }
133:               </div>
134: 
135:               <!-- Nested replies -->
136:               @if (comment.replies && comment.replies.length > 0) {
137:                 <div class="comment-replies">
138:                   @for (reply of comment.replies; track reply.id) {
139:                     <app-comment-thread
140:                       [comments]="[reply]"
141:                       [currentUserId]="currentUserId()"
142:                       [currentUserName]="currentUserName()"
143:                       [currentUserAvatar]="currentUserAvatar()"
144:                       [isNested]="true"
145:                       (commentSubmit)="commentSubmit.emit($event)"
146:                       (commentEdit)="commentEdit.emit($event)"
147:                       (commentDelete)="commentDelete.emit($event)"
148:                       (commentReply)="commentReply.emit($event)" />
149:                   }
150:                 </div>
151:               }
152:             </nz-comment-content>
153:           </nz-comment>
154:         </ng-template>
155:       </nz-list>
156: 
157:       @if (comments().length === 0 && !isNested()) {
158:         <nz-empty nzNotFoundContent="æš«ç„¡ç•™è¨€" />
159:       }
160:     </div>
161:   `,
162:   styles: [`
163:     .comment-thread {
164:       width: 100%;
165:     }
166: 
167:     .comment-editor {
168:       margin-bottom: 24px;
169:     }
170: 
171:     .comment-actions {
172:       display: flex;
173:       gap: 8px;
174:       margin-top: 8px;
175:     }
176: 
177:     .comment-list {
178:       :host ::ng-deep .ant-list-item {
179:         border-bottom: 1px solid #f0f0f0;
180:         padding: 16px 0;
181:       }
182:     }
183: 
184:     .comment-author {
185:       font-weight: 500;
186:       margin-bottom: 8px;
187:     }
188: 
189:     .comment-time {
190:       margin-left: 8px;
191:       font-size: 12px;
192:       color: rgba(0, 0, 0, 0.45);
193:       font-weight: normal;
194:     }
195: 
196:     .comment-text {
197:       line-height: 1.6;
198:       color: rgba(0, 0, 0, 0.85);
199:       margin-bottom: 8px;
200: 
201:       :host ::ng-deep .mention {
202:         color: #1890ff;
203:         font-weight: 500;
204:       }
205:     }
206: 
207:     .comment-edited {
208:       font-size: 12px;
209:       color: rgba(0, 0, 0, 0.45);
210:       font-style: italic;
211:     }
212: 
213:     .comment-actions-inline {
214:       display: flex;
215:       gap: 4px;
216:       margin-top: 8px;
217:     }
218: 
219:     .comment-replies {
220:       margin-left: 48px;
221:       margin-top: 16px;
222:       padding-left: 16px;
223:       border-left: 2px solid #f0f0f0;
224:     }
225:   `]
226: })
227: export class CommentThreadComponent {
228:   /** ç•™è¨€åˆ—è¡¨ */
229:   comments = input.required<CommentData[]>();
230: 
231:   /** ç•¶å‰ç”¨æˆ¶ ID */
232:   currentUserId = input.required<string>();
233: 
234:   /** ç•¶å‰ç”¨æˆ¶åç¨± */
235:   currentUserName = input<string>('');
236: 
237:   /** ç•¶å‰ç”¨æˆ¶é ­åƒ */
238:   currentUserAvatar = input<string>();
239: 
240:   /** æ˜¯å¦ç‚ºå·¢ç‹€é¡¯ç¤º */
241:   isNested = input<boolean>(false);
242: 
243:   /** æäº¤ç•™è¨€äº‹ä»¶ */
244:   commentSubmit = output<{ content: string; parentId?: string }>();
245: 
246:   /** ç·¨è¼¯ç•™è¨€äº‹ä»¶ */
247:   commentEdit = output<{ commentId: string; content: string }>();
248: 
249:   /** åˆªé™¤ç•™è¨€äº‹ä»¶ */
250:   commentDelete = output<string>();
251: 
252:   /** å›è¦†ç•™è¨€äº‹ä»¶ */
253:   commentReply = output<CommentData>();
254: 
255:   /** æ–°ç•™è¨€å…§å®¹ */
256:   newCommentText = '';
257: 
258:   /** é ‚å±¤ç•™è¨€ï¼ˆä¸åŒ…å«å›è¦†ï¼‰ */
259:   topLevelComments = () => this.comments().filter(c => !c.parentId);
260: 
261:   /**
262:    * æäº¤ç•™è¨€
263:    */
264:   submitComment(parentId?: string): void {
265:     const content = this.newCommentText.trim();
266:     if (content) {
267:       this.commentSubmit.emit({ content, parentId });
268:       this.newCommentText = '';
269:     }
270:   }
271: 
272:   /**
273:    * å–æ¶ˆç•™è¨€
274:    */
275:   cancelComment(): void {
276:     this.newCommentText = '';
277:   }
278: 
279:   /**
280:    * å›è¦†ç•™è¨€
281:    */
282:   replyToComment(comment: CommentData): void {
283:     this.commentReply.emit(comment);
284:   }
285: 
286:   /**
287:    * ç·¨è¼¯ç•™è¨€
288:    */
289:   editComment(comment: CommentData): void {
290:     // è§¸ç™¼ç·¨è¼¯äº‹ä»¶ï¼Œç”±çˆ¶å…ƒä»¶è™•ç†ç·¨è¼¯é‚è¼¯
291:     this.commentEdit.emit({ commentId: comment.id, content: comment.content });
292:   }
293: 
294:   /**
295:    * åˆªé™¤ç•™è¨€
296:    */
297:   deleteComment(comment: CommentData): void {
298:     this.commentDelete.emit(comment.id);
299:   }
300: 
301:   /**
302:    * æª¢æŸ¥æ˜¯å¦å¯ä»¥ç·¨è¼¯ç•™è¨€
303:    */
304:   canEditComment(comment: CommentData): boolean {
305:     return comment.authorId === this.currentUserId();
306:   }
307: 
308:   /**
309:    * æª¢æŸ¥æ˜¯å¦å¯ä»¥åˆªé™¤ç•™è¨€
310:    */
311:   canDeleteComment(comment: CommentData): boolean {
312:     return comment.authorId === this.currentUserId();
313:   }
314: 
315:   /**
316:    * æ ¼å¼åŒ–ç•™è¨€å…§å®¹ï¼ˆè™•ç† @æåŠï¼‰
317:    */
318:   formatCommentContent(content: string): string {
319:     // å°‡ @username è½‰æ›ç‚º HTML
320:     return content.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
321:   }
322: 
323:   /**
324:    * è™•ç† Enter éµ
325:    */
326:   handleKeyDown(event: Event): void {
327:     const keyboardEvent = event as KeyboardEvent;
328:     if (keyboardEvent.key === 'Enter' && !keyboardEvent.shiftKey) {
329:       keyboardEvent.preventDefault();
330:       this.submitComment();
331:     }
332:   }
333: }
````

## File: src/app/shared/components/comment-thread/index.ts
````typescript
1: export * from './comment-thread.component';
````

## File: src/app/shared/components/confirmation-dialog/confirmation-dialog.service.spec.ts
````typescript
 1: import { TestBed } from '@angular/core/testing';
 2: import { ConfirmationDialogService } from './confirmation-dialog.service';
 3: import { NzModalService } from 'ng-zorro-antd/modal';
 4: 
 5: describe('ConfirmationDialogService', () => {
 6:   let service: ConfirmationDialogService;
 7:   let modalService: jasmine.SpyObj<NzModalService>;
 8: 
 9:   beforeEach(() => {
10:     const modalServiceSpy = jasmine.createSpyObj('NzModalService', [
11:       'confirm', 
12:       'warning', 
13:       'success', 
14:       'error', 
15:       'info'
16:     ]);
17: 
18:     TestBed.configureTestingModule({
19:       providers: [
20:         ConfirmationDialogService,
21:         { provide: NzModalService, useValue: modalServiceSpy }
22:       ]
23:     });
24: 
25:     service = TestBed.inject(ConfirmationDialogService);
26:     modalService = TestBed.inject(NzModalService) as jasmine.SpyObj<NzModalService>;
27:   });
28: 
29:   it('should be created', () => {
30:     expect(service).toBeTruthy();
31:   });
32: 
33:   it('should call modal.confirm with correct config', () => {
34:     service.confirm({
35:       title: 'æ¸¬è©¦æ¨™é¡Œ',
36:       content: 'æ¸¬è©¦å…§å®¹'
37:     });
38: 
39:     expect(modalService.confirm).toHaveBeenCalledWith(
40:       jasmine.objectContaining({
41:         nzTitle: 'æ¸¬è©¦æ¨™é¡Œ',
42:         nzContent: 'æ¸¬è©¦å…§å®¹'
43:       })
44:     );
45:   });
46: 
47:   it('should call confirmDelete with danger type', () => {
48:     service.confirmDelete({
49:       itemName: 'æ¸¬è©¦é …ç›®'
50:     });
51: 
52:     expect(modalService.confirm).toHaveBeenCalledWith(
53:       jasmine.objectContaining({
54:         nzOkDanger: true
55:       })
56:     );
57:   });
58: 
59:   it('should call modal.success', () => {
60:     service.success({
61:       title: 'æˆåŠŸ',
62:       content: 'æ“ä½œæˆåŠŸ'
63:     });
64: 
65:     expect(modalService.success).toHaveBeenCalled();
66:   });
67: 
68:   it('should call modal.error', () => {
69:     service.error({
70:       title: 'éŒ¯èª¤',
71:       content: 'æ“ä½œå¤±æ•—'
72:     });
73: 
74:     expect(modalService.error).toHaveBeenCalled();
75:   });
76: });
````

## File: src/app/shared/components/confirmation-dialog/confirmation-dialog.service.ts
````typescript
  1: import { Component, inject } from '@angular/core';
  2: import { SHARED_IMPORTS } from '@shared';
  3: import { NzModalService } from 'ng-zorro-antd/modal';
  4: 
  5: export interface ConfirmationConfig {
  6:   title?: string;
  7:   content?: string;
  8:   okText?: string;
  9:   cancelText?: string;
 10:   okType?: 'primary' | 'default' | 'dashed';
 11:   onOk?: () => void | Promise<void>;
 12:   onCancel?: () => void;
 13: }
 14: 
 15: /**
 16:  * ç¢ºèªå°è©±æ¡†æœå‹™
 17:  * 
 18:  * ç”¨é€”ï¼šçµ±ä¸€çš„ç¢ºèªå°è©±æ¡†æœå‹™
 19:  * 
 20:  * @example
 21:  * ```typescript
 22:  * constructor(private confirmService: ConfirmationDialogService) {}
 23:  * 
 24:  * handleDelete() {
 25:  *   this.confirmService.confirm({
 26:  *     title: 'ç¢ºèªåˆªé™¤',
 27:  *     content: 'ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ',
 28:  *     okType: 'danger',
 29:  *     onOk: () => this.deleteItem()
 30:  *   });
 31:  * }
 32:  * ```
 33:  */
 34: @Component({
 35:   selector: 'app-confirmation-dialog',
 36:   standalone: true,
 37:   imports: [SHARED_IMPORTS],
 38:   template: ''
 39: })
 40: export class ConfirmationDialogService {
 41:   private modal = inject(NzModalService);
 42: 
 43:   /**
 44:    * é¡¯ç¤ºç¢ºèªå°è©±æ¡†
 45:    */
 46:   confirm(config: ConfirmationConfig): void {
 47:     this.modal.confirm({
 48:       nzTitle: config.title || 'ç¢ºèªæ“ä½œ',
 49:       nzContent: config.content || 'ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ',
 50:       nzOkText: config.okText || 'ç¢ºå®š',
 51:       nzCancelText: config.cancelText || 'å–æ¶ˆ',
 52:       nzOkType: config.okType || 'primary',
 53:       nzOnOk: config.onOk,
 54:       nzOnCancel: config.onCancel
 55:     });
 56:   }
 57: 
 58:   /**
 59:    * é¡¯ç¤ºåˆªé™¤ç¢ºèªå°è©±æ¡†
 60:    */
 61:   confirmDelete(config: Omit<ConfirmationConfig, 'okType'> & { itemName?: string }): void {
 62:     this.modal.confirm({
 63:       nzTitle: config.title || 'ç¢ºèªåˆªé™¤',
 64:       nzContent: config.content || `ç¢ºå®šè¦åˆªé™¤${config.itemName || 'æ­¤é …ç›®'}å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`,
 65:       nzOkText: config.okText || 'åˆªé™¤',
 66:       nzCancelText: config.cancelText || 'å–æ¶ˆ',
 67:       nzOkDanger: true,
 68:       nzOnOk: config.onOk,
 69:       nzOnCancel: config.onCancel
 70:     });
 71:   }
 72: 
 73:   /**
 74:    * é¡¯ç¤ºè­¦å‘Šå°è©±æ¡†
 75:    */
 76:   warning(config: ConfirmationConfig): void {
 77:     this.modal.warning({
 78:       nzTitle: config.title || 'è­¦å‘Š',
 79:       nzContent: config.content || '',
 80:       nzOkText: config.okText || 'ç¢ºå®š',
 81:       nzOnOk: config.onOk
 82:     });
 83:   }
 84: 
 85:   /**
 86:    * é¡¯ç¤ºæˆåŠŸå°è©±æ¡†
 87:    */
 88:   success(config: Omit<ConfirmationConfig, 'cancelText' | 'onCancel'>): void {
 89:     this.modal.success({
 90:       nzTitle: config.title || 'æˆåŠŸ',
 91:       nzContent: config.content || 'æ“ä½œå·²æˆåŠŸå®Œæˆ',
 92:       nzOkText: config.okText || 'ç¢ºå®š',
 93:       nzOnOk: config.onOk
 94:     });
 95:   }
 96: 
 97:   /**
 98:    * é¡¯ç¤ºéŒ¯èª¤å°è©±æ¡†
 99:    */
100:   error(config: Omit<ConfirmationConfig, 'cancelText' | 'onCancel'>): void {
101:     this.modal.error({
102:       nzTitle: config.title || 'éŒ¯èª¤',
103:       nzContent: config.content || 'æ“ä½œå¤±æ•—',
104:       nzOkText: config.okText || 'ç¢ºå®š',
105:       nzOnOk: config.onOk
106:     });
107:   }
108: 
109:   /**
110:    * é¡¯ç¤ºè³‡è¨Šå°è©±æ¡†
111:    */
112:   info(config: Omit<ConfirmationConfig, 'cancelText' | 'onCancel'>): void {
113:     this.modal.info({
114:       nzTitle: config.title || 'æç¤º',
115:       nzContent: config.content || '',
116:       nzOkText: config.okText || 'ç¢ºå®š',
117:       nzOnOk: config.onOk
118:     });
119:   }
120: }
````

## File: src/app/shared/components/confirmation-dialog/index.ts
````typescript
1: export * from './confirmation-dialog.service';
````

## File: src/app/shared/components/empty-state/empty-state.component.spec.ts
````typescript
 1: import { ComponentFixture, TestBed } from '@angular/core/testing';
 2: import { EmptyStateComponent } from './empty-state.component';
 3: 
 4: describe('EmptyStateComponent', () => {
 5:   let component: EmptyStateComponent;
 6:   let fixture: ComponentFixture<EmptyStateComponent>;
 7: 
 8:   beforeEach(async () => {
 9:     await TestBed.configureTestingModule({
10:       imports: [EmptyStateComponent]
11:     }).compileComponents();
12: 
13:     fixture = TestBed.createComponent(EmptyStateComponent);
14:     component = fixture.componentInstance;
15:   });
16: 
17:   it('should create', () => {
18:     expect(component).toBeTruthy();
19:   });
20: 
21:   it('should display default description', () => {
22:     fixture.detectChanges();
23:     
24:     const text = fixture.nativeElement.textContent;
25:     expect(text).toContain('æš«ç„¡è³‡æ–™');
26:   });
27: 
28:   it('should display custom description', () => {
29:     fixture.componentRef.setInput('description', 'æ‰¾ä¸åˆ°ç›¸é—œè³‡æ–™');
30:     fixture.detectChanges();
31:     
32:     const text = fixture.nativeElement.textContent;
33:     expect(text).toContain('æ‰¾ä¸åˆ°ç›¸é—œè³‡æ–™');
34:   });
35: 
36:   it('should call action function when action button clicked', () => {
37:     const actionSpy = jasmine.createSpy('actionSpy');
38:     fixture.componentRef.setInput('actionText', 'æ–°å¢');
39:     fixture.componentRef.setInput('action', actionSpy);
40:     fixture.detectChanges();
41:     
42:     const button = fixture.nativeElement.querySelector('button');
43:     button.click();
44:     
45:     expect(actionSpy).toHaveBeenCalled();
46:   });
47: });
````

## File: src/app/shared/components/empty-state/empty-state.component.ts
````typescript
 1: import { Component, ChangeDetectionStrategy, input } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: /**
 5:  * ç©ºç‹€æ…‹å…ƒä»¶
 6:  * 
 7:  * ç”¨é€”ï¼šçµ±ä¸€çš„ç©ºè³‡æ–™ç‹€æ…‹é¡¯ç¤º
 8:  * 
 9:  * @example
10:  * ```html
11:  * <app-empty-state 
12:  *   [description]="'æš«ç„¡è³‡æ–™'" 
13:  *   [icon]="'inbox'"
14:  *   [actionText]="'æ–°å¢é …ç›®'"
15:  *   (action)="handleCreate()" />
16:  * ```
17:  */
18: @Component({
19:   selector: 'app-empty-state',
20:   standalone: true,
21:   imports: [SHARED_IMPORTS],
22:   changeDetection: ChangeDetectionStrategy.OnPush,
23:   template: `
24:     <nz-empty 
25:       [nzNotFoundContent]="contentTemplate"
26:       [nzNotFoundImage]="image() || 'simple'"
27:       class="empty-state">
28:       <ng-template #contentTemplate>
29:         <div class="empty-content">
30:           @if (icon()) {
31:             <span nz-icon [nzType]="icon()!" class="empty-icon"></span>
32:           }
33:           <p class="empty-description">{{ description() }}</p>
34:           @if (actionText()) {
35:             <button nz-button nzType="primary" (click)="handleAction()">
36:               {{ actionText() }}
37:             </button>
38:           }
39:         </div>
40:       </ng-template>
41:     </nz-empty>
42:   `,
43:   styles: [`
44:     .empty-state {
45:       padding: 48px 24px;
46:     }
47: 
48:     .empty-content {
49:       text-align: center;
50: 
51:       .empty-icon {
52:         font-size: 64px;
53:         color: #d9d9d9;
54:         margin-bottom: 16px;
55:         display: block;
56:       }
57: 
58:       .empty-description {
59:         color: rgba(0, 0, 0, 0.45);
60:         font-size: 14px;
61:         margin-bottom: 16px;
62:       }
63:     }
64:   `]
65: })
66: export class EmptyStateComponent {
67:   /** ç©ºç‹€æ…‹æè¿°æ–‡å­— */
68:   description = input<string>('æš«ç„¡è³‡æ–™');
69: 
70:   /** é¡¯ç¤ºçš„åœ–ç¤º */
71:   icon = input<string>();
72: 
73:   /** è‡ªè¨‚åœ–ç‰‡ URL */
74:   image = input<string>();
75: 
76:   /** æ“ä½œæŒ‰éˆ•æ–‡å­— */
77:   actionText = input<string>();
78: 
79:   /** æ“ä½œæŒ‰éˆ•é»æ“Šäº‹ä»¶ */
80:   action = input<() => void>();
81: 
82:   handleAction(): void {
83:     const actionFn = this.action();
84:     if (actionFn) {
85:       actionFn();
86:     }
87:   }
88: }
````

## File: src/app/shared/components/empty-state/index.ts
````typescript
1: export * from './empty-state.component';
````

## File: src/app/shared/components/form-error/form-error.component.spec.ts
````typescript
 1: import { ComponentFixture, TestBed } from '@angular/core/testing';
 2: import { FormErrorComponent } from './form-error.component';
 3: 
 4: describe('FormErrorComponent', () => {
 5:   let component: FormErrorComponent;
 6:   let fixture: ComponentFixture<FormErrorComponent>;
 7: 
 8:   beforeEach(async () => {
 9:     await TestBed.configureTestingModule({
10:       imports: [FormErrorComponent]
11:     }).compileComponents();
12: 
13:     fixture = TestBed.createComponent(FormErrorComponent);
14:     component = fixture.componentInstance;
15:   });
16: 
17:   it('should create', () => {
18:     expect(component).toBeTruthy();
19:   });
20: 
21:   it('should not display errors when errors is null', () => {
22:     fixture.componentRef.setInput('errors', null);
23:     fixture.detectChanges();
24:     
25:     const errorElement = fixture.nativeElement.querySelector('.form-error');
26:     expect(errorElement).toBeNull();
27:   });
28: 
29:   it('should display required error message', () => {
30:     fixture.componentRef.setInput('errors', { required: true });
31:     fixture.detectChanges();
32:     
33:     const errorText = fixture.nativeElement.textContent;
34:     expect(errorText).toContain('æ­¤æ¬„ä½ç‚ºå¿…å¡«');
35:   });
36: 
37:   it('should display email error message', () => {
38:     fixture.componentRef.setInput('errors', { email: true });
39:     fixture.detectChanges();
40:     
41:     const errorText = fixture.nativeElement.textContent;
42:     expect(errorText).toContain('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€');
43:   });
44: 
45:   it('should display minlength error with required length', () => {
46:     fixture.componentRef.setInput('errors', { 
47:       minlength: { requiredLength: 5, actualLength: 3 } 
48:     });
49:     fixture.detectChanges();
50:     
51:     const errorText = fixture.nativeElement.textContent;
52:     expect(errorText).toContain('æœ€å°‘éœ€è¦ 5 å€‹å­—å…ƒ');
53:   });
54: 
55:   it('should display multiple errors', () => {
56:     fixture.componentRef.setInput('errors', { 
57:       required: true,
58:       minlength: { requiredLength: 5 }
59:     });
60:     fixture.detectChanges();
61:     
62:     const errorElements = fixture.nativeElement.querySelectorAll('small');
63:     expect(errorElements.length).toBe(2);
64:   });
65: });
````

## File: src/app/shared/components/form-error/form-error.component.ts
````typescript
 1: import { Component, ChangeDetectionStrategy, input } from '@angular/core';
 2: import { ValidationErrors } from '@angular/forms';
 3: import { SHARED_IMPORTS } from '@shared';
 4: 
 5: /**
 6:  * è¡¨å–®éŒ¯èª¤é¡¯ç¤ºå…ƒä»¶
 7:  * 
 8:  * ç”¨é€”ï¼šçµ±ä¸€é¡¯ç¤ºè¡¨å–®é©—è­‰éŒ¯èª¤è¨Šæ¯
 9:  * 
10:  * @example
11:  * ```html
12:  * <app-form-error [errors]="control.errors" />
13:  * ```
14:  */
15: @Component({
16:   selector: 'app-form-error',
17:   standalone: true,
18:   imports: [SHARED_IMPORTS],
19:   changeDetection: ChangeDetectionStrategy.OnPush,
20:   template: `
21:     @if (errors()) {
22:       <div class="form-error">
23:         @for (error of errorMessages(); track error.key) {
24:           <small class="text-danger">{{ error.message }}</small>
25:         }
26:       </div>
27:     }
28:   `,
29:   styles: [`
30:     .form-error {
31:       margin-top: 4px;
32:       
33:       small {
34:         display: block;
35:         line-height: 1.5;
36:       }
37:     }
38:   `]
39: })
40: export class FormErrorComponent {
41:   /** é©—è­‰éŒ¯èª¤ç‰©ä»¶ */
42:   errors = input<ValidationErrors | null>(null);
43: 
44:   /** è½‰æ›éŒ¯èª¤ç‚ºå¯é¡¯ç¤ºçš„è¨Šæ¯é™£åˆ— */
45:   errorMessages = () => {
46:     const errors = this.errors();
47:     if (!errors) return [];
48: 
49:     return Object.keys(errors).map(key => ({
50:       key,
51:       message: this.getErrorMessage(key, errors[key])
52:     }));
53:   };
54: 
55:   /**
56:    * æ ¹æ“šéŒ¯èª¤é¡å‹ç”ŸæˆéŒ¯èª¤è¨Šæ¯
57:    */
58:   private getErrorMessage(errorKey: string, errorValue: any): string {
59:     const messages: Record<string, string> = {
60:       required: 'æ­¤æ¬„ä½ç‚ºå¿…å¡«',
61:       email: 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€',
62:       minlength: `æœ€å°‘éœ€è¦ ${errorValue.requiredLength} å€‹å­—å…ƒ`,
63:       maxlength: `æœ€å¤šåªèƒ½ ${errorValue.requiredLength} å€‹å­—å…ƒ`,
64:       min: `æœ€å°å€¼ç‚º ${errorValue.min}`,
65:       max: `æœ€å¤§å€¼ç‚º ${errorValue.max}`,
66:       pattern: 'æ ¼å¼ä¸æ­£ç¢º'
67:     };
68: 
69:     return messages[errorKey] || 'è¼¸å…¥ä¸æ­£ç¢º';
70:   }
71: }
````

## File: src/app/shared/components/form-error/index.ts
````typescript
1: export * from './form-error.component';
````

## File: src/app/shared/components/loading-indicator/index.ts
````typescript
1: export * from './loading-indicator.component';
````

## File: src/app/shared/components/loading-indicator/loading-indicator.component.spec.ts
````typescript
 1: import { ComponentFixture, TestBed } from '@angular/core/testing';
 2: import { LoadingIndicatorComponent } from './loading-indicator.component';
 3: 
 4: describe('LoadingIndicatorComponent', () => {
 5:   let component: LoadingIndicatorComponent;
 6:   let fixture: ComponentFixture<LoadingIndicatorComponent>;
 7: 
 8:   beforeEach(async () => {
 9:     await TestBed.configureTestingModule({
10:       imports: [LoadingIndicatorComponent]
11:     }).compileComponents();
12: 
13:     fixture = TestBed.createComponent(LoadingIndicatorComponent);
14:     component = fixture.componentInstance;
15:   });
16: 
17:   it('should create', () => {
18:     expect(component).toBeTruthy();
19:   });
20: 
21:   it('should not display when loading is false', () => {
22:     fixture.componentRef.setInput('loading', false);
23:     fixture.detectChanges();
24:     
25:     const container = fixture.nativeElement.querySelector('.loading-container');
26:     expect(container).toBeNull();
27:   });
28: 
29:   it('should display when loading is true', () => {
30:     fixture.componentRef.setInput('loading', true);
31:     fixture.detectChanges();
32:     
33:     const container = fixture.nativeElement.querySelector('.loading-container');
34:     expect(container).toBeTruthy();
35:   });
36: 
37:   it('should display custom text', () => {
38:     fixture.componentRef.setInput('loading', true);
39:     fixture.componentRef.setInput('text', 'è™•ç†ä¸­...');
40:     fixture.detectChanges();
41:     
42:     const text = fixture.nativeElement.textContent;
43:     expect(text).toContain('è™•ç†ä¸­...');
44:   });
45: 
46:   it('should apply fullscreen class when fullscreen is true', () => {
47:     fixture.componentRef.setInput('loading', true);
48:     fixture.componentRef.setInput('fullscreen', true);
49:     fixture.detectChanges();
50:     
51:     const container = fixture.nativeElement.querySelector('.loading-container');
52:     expect(container.classList.contains('fullscreen')).toBe(true);
53:   });
54: });
````

## File: src/app/shared/components/loading-indicator/loading-indicator.component.ts
````typescript
 1: import { Component, ChangeDetectionStrategy, input } from '@angular/core';
 2: import { SHARED_IMPORTS } from '@shared';
 3: 
 4: /**
 5:  * è¼‰å…¥æŒ‡ç¤ºå™¨å…ƒä»¶
 6:  * 
 7:  * ç”¨é€”ï¼šçµ±ä¸€çš„è¼‰å…¥ä¸­ç‹€æ…‹é¡¯ç¤º
 8:  * 
 9:  * @example
10:  * ```html
11:  * <app-loading-indicator [loading]="isLoading()" [text]="'è¼‰å…¥ä¸­...'" />
12:  * ```
13:  */
14: @Component({
15:   selector: 'app-loading-indicator',
16:   standalone: true,
17:   imports: [SHARED_IMPORTS],
18:   changeDetection: ChangeDetectionStrategy.OnPush,
19:   template: `
20:     @if (loading()) {
21:       <div class="loading-container" [ngClass]="{ 'fullscreen': fullscreen() }">
22:         <nz-spin [nzSize]="size()" [nzTip]="text()" />
23:       </div>
24:     }
25:   `,
26:   styles: [`
27:     .loading-container {
28:       display: flex;
29:       align-items: center;
30:       justify-content: center;
31:       padding: 24px;
32:       
33:       &.fullscreen {
34:         position: fixed;
35:         top: 0;
36:         left: 0;
37:         right: 0;
38:         bottom: 0;
39:         background-color: rgba(255, 255, 255, 0.8);
40:         z-index: 1000;
41:       }
42:     }
43:   `]
44: })
45: export class LoadingIndicatorComponent {
46:   /** æ˜¯å¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹ */
47:   loading = input<boolean>(false);
48: 
49:   /** è¼‰å…¥æç¤ºæ–‡å­— */
50:   text = input<string>('è¼‰å…¥ä¸­...');
51: 
52:   /** è¼‰å…¥æŒ‡ç¤ºå™¨å¤§å° */
53:   size = input<'small' | 'default' | 'large'>('default');
54: 
55:   /** æ˜¯å¦å…¨è¢å¹•é¡¯ç¤º */
56:   fullscreen = input<boolean>(false);
57: }
````

## File: src/app/shared/components/photo-gallery/index.ts
````typescript
1: export * from './photo-gallery.component';
````

## File: src/app/shared/components/photo-gallery/photo-gallery.component.ts
````typescript
  1: import { Component, ChangeDetectionStrategy, input, signal } from '@angular/core';
  2: import { SHARED_IMPORTS } from '@shared';
  3: 
  4: export interface PhotoItem {
  5:   id: string;
  6:   url: string;
  7:   thumbnailUrl?: string;
  8:   title?: string;
  9:   description?: string;
 10:   exif?: {
 11:     camera?: string;
 12:     lens?: string;
 13:     iso?: string;
 14:     aperture?: string;
 15:     shutterSpeed?: string;
 16:     focalLength?: string;
 17:     dateTaken?: string;
 18:     gps?: {
 19:       latitude: number;
 20:       longitude: number;
 21:     };
 22:   };
 23: }
 24: 
 25: /**
 26:  * ç…§ç‰‡ç•«å»Šå…ƒä»¶
 27:  * 
 28:  * ç”¨é€”ï¼šé¡¯ç¤ºç…§ç‰‡é›†åˆï¼Œæ”¯æ´ Lightbox æª¢è¦–å’Œ EXIF è³‡è¨Š
 29:  * 
 30:  * @example
 31:  * ```html
 32:  * <app-photo-gallery 
 33:  *   [photos]="photoList()" 
 34:  *   [showExif]="true" />
 35:  * ```
 36:  */
 37: @Component({
 38:   selector: 'app-photo-gallery',
 39:   standalone: true,
 40:   imports: [SHARED_IMPORTS],
 41:   changeDetection: ChangeDetectionStrategy.OnPush,
 42:   template: `
 43:     <div class="photo-gallery">
 44:       <div class="gallery-grid">
 45:         @for (photo of photos(); track photo.id) {
 46:           <div class="photo-item" (click)="openLightbox(photo)">
 47:             <img 
 48:               [src]="photo.thumbnailUrl || photo.url" 
 49:               [alt]="photo.title || 'ç…§ç‰‡'"
 50:               class="photo-thumbnail" />
 51:             @if (photo.title) {
 52:               <div class="photo-title">{{ photo.title }}</div>
 53:             }
 54:           </div>
 55:         }
 56:       </div>
 57: 
 58:       <!-- Lightbox Modal -->
 59:       <nz-modal
 60:         [nzVisible]="isLightboxVisible()"
 61:         [nzTitle]="currentPhoto()?.title || 'ç…§ç‰‡'"
 62:         [nzFooter]="null"
 63:         [nzWidth]="'90%'"
 64:         [nzBodyStyle]="{ padding: '24px' }"
 65:         (nzOnCancel)="closeLightbox()">
 66:         @if (currentPhoto()) {
 67:           <div class="lightbox-content">
 68:             <img 
 69:               [src]="currentPhoto()!.url" 
 70:               [alt]="currentPhoto()!.title || 'ç…§ç‰‡'"
 71:               class="lightbox-image" />
 72:             
 73:             @if (showExif() && currentPhoto()!.exif) {
 74:               <div class="exif-info">
 75:                 <h4>ç…§ç‰‡è³‡è¨Š (EXIF)</h4>
 76:                 <nz-descriptions [nzColumn]="2" nzSize="small">
 77:                   @if (currentPhoto()!.exif?.camera) {
 78:                     <nz-descriptions-item nzTitle="ç›¸æ©Ÿ">
 79:                       {{ currentPhoto()!.exif!.camera }}
 80:                     </nz-descriptions-item>
 81:                   }
 82:                   @if (currentPhoto()!.exif?.lens) {
 83:                     <nz-descriptions-item nzTitle="é¡é ­">
 84:                       {{ currentPhoto()!.exif!.lens }}
 85:                     </nz-descriptions-item>
 86:                   }
 87:                   @if (currentPhoto()!.exif?.iso) {
 88:                     <nz-descriptions-item nzTitle="ISO">
 89:                       {{ currentPhoto()!.exif!.iso }}
 90:                     </nz-descriptions-item>
 91:                   }
 92:                   @if (currentPhoto()!.exif?.aperture) {
 93:                     <nz-descriptions-item nzTitle="å…‰åœˆ">
 94:                       {{ currentPhoto()!.exif!.aperture }}
 95:                     </nz-descriptions-item>
 96:                   }
 97:                   @if (currentPhoto()!.exif?.shutterSpeed) {
 98:                     <nz-descriptions-item nzTitle="å¿«é–€">
 99:                       {{ currentPhoto()!.exif!.shutterSpeed }}
100:                     </nz-descriptions-item>
101:                   }
102:                   @if (currentPhoto()!.exif?.focalLength) {
103:                     <nz-descriptions-item nzTitle="ç„¦è·">
104:                       {{ currentPhoto()!.exif!.focalLength }}
105:                     </nz-descriptions-item>
106:                   }
107:                   @if (currentPhoto()!.exif?.dateTaken) {
108:                     <nz-descriptions-item nzTitle="æ‹æ”æ™‚é–“">
109:                       {{ currentPhoto()!.exif!.dateTaken }}
110:                     </nz-descriptions-item>
111:                   }
112:                   @if (currentPhoto()!.exif?.gps) {
113:                     <nz-descriptions-item nzTitle="GPS åº§æ¨™" [nzSpan]="2">
114:                       {{ currentPhoto()!.exif!.gps!.latitude }}, 
115:                       {{ currentPhoto()!.exif!.gps!.longitude }}
116:                     </nz-descriptions-item>
117:                   }
118:                 </nz-descriptions>
119:               </div>
120:             }
121: 
122:             @if (currentPhoto()!.description) {
123:               <p class="photo-description">{{ currentPhoto()!.description }}</p>
124:             }
125: 
126:             <!-- Navigation buttons -->
127:             <div class="lightbox-nav">
128:               <button 
129:                 nz-button 
130:                 nzType="default"
131:                 [disabled]="!canGoPrevious()"
132:                 (click)="previousPhoto()">
133:                 <span nz-icon nzType="left"></span>
134:                 ä¸Šä¸€å¼µ
135:               </button>
136:               <span class="photo-counter">
137:                 {{ currentIndex() + 1 }} / {{ photos().length }}
138:               </span>
139:               <button 
140:                 nz-button 
141:                 nzType="default"
142:                 [disabled]="!canGoNext()"
143:                 (click)="nextPhoto()">
144:                 ä¸‹ä¸€å¼µ
145:                 <span nz-icon nzType="right"></span>
146:               </button>
147:             </div>
148:           </div>
149:         }
150:       </nz-modal>
151:     </div>
152:   `,
153:   styles: [`
154:     .photo-gallery {
155:       width: 100%;
156:     }
157: 
158:     .gallery-grid {
159:       display: grid;
160:       grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
161:       gap: 16px;
162:       padding: 16px 0;
163:     }
164: 
165:     .photo-item {
166:       position: relative;
167:       cursor: pointer;
168:       border-radius: 4px;
169:       overflow: hidden;
170:       transition: transform 0.2s;
171: 
172:       &:hover {
173:         transform: scale(1.05);
174: 
175:         .photo-title {
176:           opacity: 1;
177:         }
178:       }
179:     }
180: 
181:     .photo-thumbnail {
182:       width: 100%;
183:       height: 200px;
184:       object-fit: cover;
185:       display: block;
186:     }
187: 
188:     .photo-title {
189:       position: absolute;
190:       bottom: 0;
191:       left: 0;
192:       right: 0;
193:       background: rgba(0, 0, 0, 0.7);
194:       color: white;
195:       padding: 8px;
196:       font-size: 14px;
197:       opacity: 0;
198:       transition: opacity 0.2s;
199:     }
200: 
201:     .lightbox-content {
202:       display: flex;
203:       flex-direction: column;
204:       gap: 16px;
205:     }
206: 
207:     .lightbox-image {
208:       width: 100%;
209:       height: auto;
210:       max-height: 60vh;
211:       object-fit: contain;
212:       border-radius: 4px;
213:     }
214: 
215:     .exif-info {
216:       background: #f5f5f5;
217:       padding: 16px;
218:       border-radius: 4px;
219: 
220:       h4 {
221:         margin-bottom: 12px;
222:         font-size: 16px;
223:         font-weight: 500;
224:       }
225:     }
226: 
227:     .photo-description {
228:       color: rgba(0, 0, 0, 0.65);
229:       line-height: 1.6;
230:     }
231: 
232:     .lightbox-nav {
233:       display: flex;
234:       align-items: center;
235:       justify-content: center;
236:       gap: 16px;
237:       padding-top: 16px;
238:       border-top: 1px solid #f0f0f0;
239: 
240:       .photo-counter {
241:         color: rgba(0, 0, 0, 0.45);
242:         font-size: 14px;
243:       }
244:     }
245:   `]
246: })
247: export class PhotoGalleryComponent {
248:   /** ç…§ç‰‡åˆ—è¡¨ */
249:   photos = input.required<PhotoItem[]>();
250: 
251:   /** æ˜¯å¦é¡¯ç¤º EXIF è³‡è¨Š */
252:   showExif = input<boolean>(true);
253: 
254:   /** æ˜¯å¦é¡¯ç¤º Lightbox */
255:   isLightboxVisible = signal(false);
256: 
257:   /** ç•¶å‰é¡¯ç¤ºçš„ç…§ç‰‡ */
258:   currentPhoto = signal<PhotoItem | null>(null);
259: 
260:   /** ç•¶å‰ç…§ç‰‡ç´¢å¼• */
261:   currentIndex = signal(0);
262: 
263:   /**
264:    * é–‹å•Ÿ Lightbox
265:    */
266:   openLightbox(photo: PhotoItem): void {
267:     const index = this.photos().findIndex(p => p.id === photo.id);
268:     this.currentIndex.set(index);
269:     this.currentPhoto.set(photo);
270:     this.isLightboxVisible.set(true);
271:   }
272: 
273:   /**
274:    * é—œé–‰ Lightbox
275:    */
276:   closeLightbox(): void {
277:     this.isLightboxVisible.set(false);
278:     this.currentPhoto.set(null);
279:   }
280: 
281:   /**
282:    * ä¸Šä¸€å¼µç…§ç‰‡
283:    */
284:   previousPhoto(): void {
285:     if (this.canGoPrevious()) {
286:       const newIndex = this.currentIndex() - 1;
287:       this.currentIndex.set(newIndex);
288:       this.currentPhoto.set(this.photos()[newIndex]);
289:     }
290:   }
291: 
292:   /**
293:    * ä¸‹ä¸€å¼µç…§ç‰‡
294:    */
295:   nextPhoto(): void {
296:     if (this.canGoNext()) {
297:       const newIndex = this.currentIndex() + 1;
298:       this.currentIndex.set(newIndex);
299:       this.currentPhoto.set(this.photos()[newIndex]);
300:     }
301:   }
302: 
303:   /**
304:    * æ˜¯å¦å¯ä»¥å‰å¾€ä¸Šä¸€å¼µ
305:    */
306:   canGoPrevious(): boolean {
307:     return this.currentIndex() > 0;
308:   }
309: 
310:   /**
311:    * æ˜¯å¦å¯ä»¥å‰å¾€ä¸‹ä¸€å¼µ
312:    */
313:   canGoNext(): boolean {
314:     return this.currentIndex() < this.photos().length - 1;
315:   }
316: }
````

## File: src/app/shared/components/qc-camera/index.ts
````typescript
1: export * from './qc-camera.component';
````

## File: src/app/shared/components/qc-camera/qc-camera.component.ts
````typescript
  1: import { Component, ChangeDetectionStrategy, signal, output } from '@angular/core';
  2: import { SHARED_IMPORTS } from '@shared';
  3: 
  4: export interface CapturedPhoto {
  5:   id: string;
  6:   dataUrl: string;
  7:   timestamp: string;
  8:   annotations?: {
  9:     text: string;
 10:     x: number;
 11:     y: number;
 12:   }[];
 13: }
 14: 
 15: /**
 16:  * å“ç®¡ç›¸æ©Ÿå…ƒä»¶
 17:  * 
 18:  * ç”¨é€”ï¼šæ•´åˆç›¸æ©ŸåŠŸèƒ½ï¼Œæ”¯æ´æ‹ç…§å’Œç…§ç‰‡æ¨™è¨»
 19:  * 
 20:  * @example
 21:  * ```html
 22:  * <app-qc-camera 
 23:  *   (photoCapture)="handlePhotoCapture($event)"
 24:  *   (photosComplete)="handleComplete($event)" />
 25:  * ```
 26:  */
 27: @Component({
 28:   selector: 'app-qc-camera',
 29:   standalone: true,
 30:   imports: [SHARED_IMPORTS],
 31:   changeDetection: ChangeDetectionStrategy.OnPush,
 32:   template: `
 33:     <nz-card nzTitle="å“ç®¡æ‹ç…§" class="qc-camera-card">
 34:       <div class="camera-container">
 35:         @if (isCapturing()) {
 36:           <!-- Camera view (placeholder) -->
 37:           <div class="camera-view">
 38:             <span nz-icon nzType="camera" nzTheme="outline" class="camera-icon"></span>
 39:             <p>ç›¸æ©Ÿè¦–åœ–</p>
 40:             <p class="camera-hint">å¯¦éš›æ‡‰ç”¨éœ€æ•´åˆ WebRTC MediaDevices API</p>
 41:             
 42:             <div class="camera-controls">
 43:               <button 
 44:                 nz-button 
 45:                 nzType="primary" 
 46:                 nzSize="large"
 47:                 nzShape="circle"
 48:                 (click)="capturePhoto()">
 49:                 <span nz-icon nzType="camera" nzTheme="outline"></span>
 50:               </button>
 51:               <button 
 52:                 nz-button 
 53:                 nzType="default"
 54:                 (click)="stopCapture()">
 55:                 å–æ¶ˆ
 56:               </button>
 57:             </div>
 58:           </div>
 59:         } @else {
 60:           <!-- Start button -->
 61:           <div class="camera-start">
 62:             <button 
 63:               nz-button 
 64:               nzType="primary" 
 65:               nzSize="large"
 66:               (click)="startCapture()">
 67:               <span nz-icon nzType="camera" nzTheme="outline"></span>
 68:               é–‹å§‹æ‹ç…§
 69:             </button>
 70:             
 71:             <nz-divider nzText="æˆ–"></nz-divider>
 72: 
 73:             <button 
 74:               nz-button 
 75:               nzType="default"
 76:               (click)="uploadFromFile()">
 77:               <span nz-icon nzType="upload" nzTheme="outline"></span>
 78:               å¾æª”æ¡ˆä¸Šå‚³
 79:             </button>
 80:           </div>
 81:         }
 82: 
 83:         <!-- Captured photos -->
 84:         @if (capturedPhotos().length > 0) {
 85:           <div class="captured-photos">
 86:             <nz-divider nzText="å·²æ‹æ”ç…§ç‰‡"></nz-divider>
 87:             
 88:             <div class="photos-grid">
 89:               @for (photo of capturedPhotos(); track photo.id) {
 90:                 <div class="photo-item">
 91:                   <img [src]="photo.dataUrl" [alt]="'ç…§ç‰‡ ' + photo.id" />
 92:                   <div class="photo-overlay">
 93:                     <button 
 94:                       nz-button 
 95:                       nzType="primary" 
 96:                       nzSize="small"
 97:                       nzShape="circle"
 98:                       (click)="annotatePhoto(photo)">
 99:                       <span nz-icon nzType="edit" nzTheme="outline"></span>
100:                     </button>
101:                     <button 
102:                       nz-button 
103:                       nzDanger 
104:                       nzSize="small"
105:                       nzShape="circle"
106:                       (click)="deletePhoto(photo)">
107:                       <span nz-icon nzType="delete" nzTheme="outline"></span>
108:                     </button>
109:                   </div>
110:                   <div class="photo-info">
111:                     {{ photo.timestamp | date:'yyyy-MM-dd HH:mm:ss' }}
112:                   </div>
113:                 </div>
114:               }
115:             </div>
116: 
117:             <div class="photos-actions">
118:               <button 
119:                 nz-button 
120:                 nzType="primary"
121:                 [disabled]="capturedPhotos().length === 0"
122:                 (click)="completePhotos()">
123:                 <span nz-icon nzType="check" nzTheme="outline"></span>
124:                 å®Œæˆæ‹æ” ({{ capturedPhotos().length }})
125:               </button>
126:               <button 
127:                 nz-button 
128:                 nzType="default"
129:                 (click)="clearPhotos()">
130:                 æ¸…é™¤å…¨éƒ¨
131:               </button>
132:             </div>
133:           </div>
134:         }
135:       </div>
136: 
137:       <!-- Annotation Modal -->
138:       <nz-modal
139:         [nzVisible]="isAnnotating()"
140:         nzTitle="ç…§ç‰‡æ¨™è¨»"
141:         [nzFooter]="annotationFooter"
142:         [nzWidth]="'80%'"
143:         (nzOnCancel)="closeAnnotation()">
144:         
145:         @if (currentAnnotatingPhoto()) {
146:           <div class="annotation-container">
147:             <div class="annotation-canvas">
148:               <img 
149:                 [src]="currentAnnotatingPhoto()!.dataUrl" 
150:                 alt="æ¨™è¨»ç…§ç‰‡"
151:                 class="annotation-image" />
152:               <!-- Canvas overlay for annotations would go here -->
153:               <div class="annotation-hint">
154:                 é»æ“Šç…§ç‰‡å¯æ·»åŠ æ¨™è¨»æ–‡å­—
155:               </div>
156:             </div>
157: 
158:             <div class="annotation-controls">
159:               <nz-input-group [nzPrefix]="prefixTemplate">
160:                 <input 
161:                   nz-input 
162:                   placeholder="è¼¸å…¥æ¨™è¨»æ–‡å­—"
163:                   [(ngModel)]="annotationText" />
164:               </nz-input-group>
165:               <button 
166:                 nz-button 
167:                 nzType="primary"
168:                 [disabled]="!annotationText.trim()"
169:                 (click)="addAnnotation()">
170:                 æ·»åŠ æ¨™è¨»
171:               </button>
172: 
173:               <ng-template #prefixTemplate>
174:                 <span nz-icon nzType="edit" nzTheme="outline"></span>
175:               </ng-template>
176:             </div>
177: 
178:             @if (currentAnnotatingPhoto()!.annotations && currentAnnotatingPhoto()!.annotations!.length > 0) {
179:               <div class="annotations-list">
180:                 <h4>å·²æ·»åŠ çš„æ¨™è¨»ï¼š</h4>
181:                 <nz-list [nzDataSource]="currentAnnotatingPhoto()!.annotations!" nzSize="small">
182:                   <ng-template #renderItem let-annotation let-index="index">
183:                     <nz-list-item [nzActions]="[deleteAction]">
184:                       <span>{{ index + 1 }}. {{ annotation.text }}</span>
185:                       <ng-template #deleteAction>
186:                         <a (click)="removeAnnotation(index)">åˆªé™¤</a>
187:                       </ng-template>
188:                     </nz-list-item>
189:                   </ng-template>
190:                 </nz-list>
191:               </div>
192:             }
193:           </div>
194:         }
195: 
196:         <ng-template #annotationFooter>
197:           <button nz-button nzType="default" (click)="closeAnnotation()">é—œé–‰</button>
198:           <button nz-button nzType="primary" (click)="saveAnnotation()">å„²å­˜</button>
199:         </ng-template>
200:       </nz-modal>
201:     </nz-card>
202:   `,
203:   styles: [`
204:     .qc-camera-card {
205:       :host ::ng-deep .ant-card-body {
206:         padding: 24px;
207:       }
208:     }
209: 
210:     .camera-container {
211:       min-height: 400px;
212:     }
213: 
214:     .camera-view {
215:       display: flex;
216:       flex-direction: column;
217:       align-items: center;
218:       justify-content: center;
219:       height: 400px;
220:       background: #000;
221:       border-radius: 4px;
222:       color: #fff;
223: 
224:       .camera-icon {
225:         font-size: 64px;
226:         margin-bottom: 16px;
227:       }
228: 
229:       .camera-hint {
230:         color: #bfbfbf;
231:         font-size: 12px;
232:         margin-top: 8px;
233:       }
234: 
235:       .camera-controls {
236:         display: flex;
237:         gap: 16px;
238:         margin-top: 24px;
239:       }
240:     }
241: 
242:     .camera-start {
243:       display: flex;
244:       flex-direction: column;
245:       align-items: center;
246:       justify-content: center;
247:       min-height: 300px;
248:     }
249: 
250:     .captured-photos {
251:       margin-top: 24px;
252:     }
253: 
254:     .photos-grid {
255:       display: grid;
256:       grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
257:       gap: 16px;
258:       margin-bottom: 16px;
259:     }
260: 
261:     .photo-item {
262:       position: relative;
263:       border-radius: 4px;
264:       overflow: hidden;
265:       border: 1px solid #d9d9d9;
266: 
267:       img {
268:         width: 100%;
269:         height: 200px;
270:         object-fit: cover;
271:         display: block;
272:       }
273: 
274:       .photo-overlay {
275:         position: absolute;
276:         top: 8px;
277:         right: 8px;
278:         display: flex;
279:         gap: 8px;
280:         opacity: 0;
281:         transition: opacity 0.2s;
282:       }
283: 
284:       &:hover .photo-overlay {
285:         opacity: 1;
286:       }
287: 
288:       .photo-info {
289:         padding: 8px;
290:         background: #fafafa;
291:         font-size: 12px;
292:         color: rgba(0, 0, 0, 0.65);
293:         text-align: center;
294:       }
295:     }
296: 
297:     .photos-actions {
298:       display: flex;
299:       justify-content: center;
300:       gap: 16px;
301:       margin-top: 16px;
302:     }
303: 
304:     .annotation-container {
305:       display: flex;
306:       flex-direction: column;
307:       gap: 16px;
308:     }
309: 
310:     .annotation-canvas {
311:       position: relative;
312:       background: #f0f0f0;
313:       border-radius: 4px;
314:       overflow: hidden;
315: 
316:       .annotation-image {
317:         width: 100%;
318:         height: auto;
319:         display: block;
320:       }
321: 
322:       .annotation-hint {
323:         position: absolute;
324:         bottom: 16px;
325:         left: 50%;
326:         transform: translateX(-50%);
327:         background: rgba(0, 0, 0, 0.7);
328:         color: #fff;
329:         padding: 8px 16px;
330:         border-radius: 4px;
331:         font-size: 12px;
332:       }
333:     }
334: 
335:     .annotation-controls {
336:       display: flex;
337:       gap: 8px;
338: 
339:       nz-input-group {
340:         flex: 1;
341:       }
342:     }
343: 
344:     .annotations-list {
345:       h4 {
346:         margin-bottom: 12px;
347:         font-size: 14px;
348:         font-weight: 500;
349:       }
350:     }
351:   `]
352: })
353: export class QcCameraComponent {
354:   /** æ˜¯å¦æ­£åœ¨æ‹ç…§ */
355:   isCapturing = signal(false);
356: 
357:   /** æ˜¯å¦æ­£åœ¨æ¨™è¨» */
358:   isAnnotating = signal(false);
359: 
360:   /** å·²æ‹æ”çš„ç…§ç‰‡ */
361:   capturedPhotos = signal<CapturedPhoto[]>([]);
362: 
363:   /** ç•¶å‰æ¨™è¨»çš„ç…§ç‰‡ */
364:   currentAnnotatingPhoto = signal<CapturedPhoto | null>(null);
365: 
366:   /** æ¨™è¨»æ–‡å­— */
367:   annotationText = '';
368: 
369:   /** æ‹ç…§äº‹ä»¶ */
370:   photoCapture = output<CapturedPhoto>();
371: 
372:   /** å®Œæˆæ‹ç…§äº‹ä»¶ */
373:   photosComplete = output<CapturedPhoto[]>();
374: 
375:   /**
376:    * é–‹å§‹æ‹ç…§
377:    */
378:   startCapture(): void {
379:     this.isCapturing.set(true);
380:     // Actual implementation would initialize camera using MediaDevices API
381:   }
382: 
383:   /**
384:    * åœæ­¢æ‹ç…§
385:    */
386:   stopCapture(): void {
387:     this.isCapturing.set(false);
388:   }
389: 
390:   /**
391:    * æ‹ç…§
392:    */
393:   capturePhoto(): void {
394:     // Simulate photo capture
395:     const photo: CapturedPhoto = {
396:       id: Date.now().toString(),
397:       dataUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjIwIiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+5ZOB566h5ri45r2HP+eBvjwvdGV4dD48L3N2Zz4=',
398:       timestamp: new Date().toISOString(),
399:       annotations: []
400:     };
401: 
402:     this.capturedPhotos.update(photos => [...photos, photo]);
403:     this.photoCapture.emit(photo);
404:   }
405: 
406:   /**
407:    * å¾æª”æ¡ˆä¸Šå‚³
408:    */
409:   uploadFromFile(): void {
410:     // Trigger file input
411:     const input = document.createElement('input');
412:     input.type = 'file';
413:     input.accept = 'image/*';
414:     input.onchange = (e: any) => {
415:       const file = e.target.files[0];
416:       if (file) {
417:         const reader = new FileReader();
418:         reader.onload = (event: any) => {
419:           const photo: CapturedPhoto = {
420:             id: Date.now().toString(),
421:             dataUrl: event.target.result,
422:             timestamp: new Date().toISOString(),
423:             annotations: []
424:           };
425:           this.capturedPhotos.update(photos => [...photos, photo]);
426:           this.photoCapture.emit(photo);
427:         };
428:         reader.readAsDataURL(file);
429:       }
430:     };
431:     input.click();
432:   }
433: 
434:   /**
435:    * æ¨™è¨»ç…§ç‰‡
436:    */
437:   annotatePhoto(photo: CapturedPhoto): void {
438:     this.currentAnnotatingPhoto.set(photo);
439:     this.isAnnotating.set(true);
440:   }
441: 
442:   /**
443:    * é—œé–‰æ¨™è¨»
444:    */
445:   closeAnnotation(): void {
446:     this.isAnnotating.set(false);
447:     this.currentAnnotatingPhoto.set(null);
448:     this.annotationText = '';
449:   }
450: 
451:   /**
452:    * å„²å­˜æ¨™è¨»
453:    */
454:   saveAnnotation(): void {
455:     this.closeAnnotation();
456:   }
457: 
458:   /**
459:    * æ·»åŠ æ¨™è¨»
460:    */
461:   addAnnotation(): void {
462:     const photo = this.currentAnnotatingPhoto();
463:     const text = this.annotationText.trim();
464:     
465:     if (photo && text) {
466:       const annotation = {
467:         text,
468:         x: Math.random() * 100,
469:         y: Math.random() * 100
470:       };
471: 
472:       photo.annotations = photo.annotations || [];
473:       photo.annotations.push(annotation);
474:       
475:       this.annotationText = '';
476:     }
477:   }
478: 
479:   /**
480:    * ç§»é™¤æ¨™è¨»
481:    */
482:   removeAnnotation(index: number): void {
483:     const photo = this.currentAnnotatingPhoto();
484:     if (photo && photo.annotations) {
485:       photo.annotations.splice(index, 1);
486:     }
487:   }
488: 
489:   /**
490:    * åˆªé™¤ç…§ç‰‡
491:    */
492:   deletePhoto(photo: CapturedPhoto): void {
493:     this.capturedPhotos.update(photos => 
494:       photos.filter(p => p.id !== photo.id)
495:     );
496:   }
497: 
498:   /**
499:    * æ¸…é™¤æ‰€æœ‰ç…§ç‰‡
500:    */
501:   clearPhotos(): void {
502:     this.capturedPhotos.set([]);
503:   }
504: 
505:   /**
506:    * å®Œæˆæ‹æ”
507:    */
508:   completePhotos(): void {
509:     this.photosComplete.emit(this.capturedPhotos());
510:   }
511: }
````

## File: src/app/shared/components/todo-widget/index.ts
````typescript
1: export * from './todo-widget.component';
````

## File: src/app/shared/components/todo-widget/todo-widget.component.ts
````typescript
  1: import { Component, ChangeDetectionStrategy, input, output, signal } from '@angular/core';
  2: import { SHARED_IMPORTS } from '@shared';
  3: 
  4: export interface TodoItem {
  5:   id: string;
  6:   title: string;
  7:   status: 'pending' | 'staging' | 'qc' | 'acceptance' | 'issue';
  8:   priority?: 'low' | 'medium' | 'high' | 'urgent';
  9:   dueDate?: string;
 10:   assignee?: string;
 11: }
 12: 
 13: export type TodoStatusFilter = 'all' | 'pending' | 'staging' | 'qc' | 'acceptance' | 'issue';
 14: 
 15: /**
 16:  * å¾…è¾¦å°å·¥å…·å…ƒä»¶
 17:  * 
 18:  * ç”¨é€”ï¼šé¡¯ç¤ºå€‹äººå¾…è¾¦äº‹é …çš„å°å·¥å…·ï¼Œç”¨æ–¼å´é‚Šæ¬„æˆ–å„€è¡¨æ¿
 19:  * 
 20:  * @example
 21:  * ```html
 22:  * <app-todo-widget 
 23:  *   [todos]="todoList()" 
 24:  *   [loading]="isLoading()"
 25:  *   (itemClick)="handleItemClick($event)"
 26:  *   (statusChange)="handleStatusChange($event)" />
 27:  * ```
 28:  */
 29: @Component({
 30:   selector: 'app-todo-widget',
 31:   standalone: true,
 32:   imports: [SHARED_IMPORTS],
 33:   changeDetection: ChangeDetectionStrategy.OnPush,
 34:   template: `
 35:     <nz-card 
 36:       [nzTitle]="cardTitle" 
 37:       [nzExtra]="extraTemplate"
 38:       [nzBodyStyle]="{ padding: '0' }"
 39:       class="todo-widget">
 40:       
 41:       <ng-template #cardTitle>
 42:         <span nz-icon nzType="check-square" nzTheme="outline"></span>
 43:         å¾…è¾¦ä¸­å¿ƒ
 44:       </ng-template>
 45: 
 46:       <ng-template #extraTemplate>
 47:         <nz-badge [nzCount]="filteredTodos().length" [nzShowZero]="true" />
 48:       </ng-template>
 49: 
 50:       <!-- Status filter tabs -->
 51:       <nz-tabset 
 52:         [(nzSelectedIndex)]="selectedTabIndex"
 53:         (nzSelectedIndexChange)="handleTabChange($event)"
 54:         nzSize="small">
 55:         
 56:         <nz-tab nzTitle="å…¨éƒ¨">
 57:           <ng-template nz-tab>
 58:             <span nz-icon nzType="appstore" nzTheme="outline"></span>
 59:             å…¨éƒ¨ ({{ getCountByStatus('all') }})
 60:           </ng-template>
 61:         </nz-tab>
 62: 
 63:         <nz-tab nzTitle="å¾…åŸ·è¡Œ">
 64:           <ng-template nz-tab>
 65:             <span nz-icon nzType="clock-circle" nzTheme="outline"></span>
 66:             å¾…åŸ·è¡Œ ({{ getCountByStatus('pending') }})
 67:           </ng-template>
 68:         </nz-tab>
 69: 
 70:         <nz-tab nzTitle="æš«å­˜ä¸­">
 71:           <ng-template nz-tab>
 72:             <span nz-icon nzType="inbox" nzTheme="outline"></span>
 73:             æš«å­˜ä¸­ ({{ getCountByStatus('staging') }})
 74:           </ng-template>
 75:         </nz-tab>
 76: 
 77:         <nz-tab nzTitle="å“ç®¡ä¸­">
 78:           <ng-template nz-tab>
 79:             <span nz-icon nzType="safety" nzTheme="outline"></span>
 80:             å“ç®¡ä¸­ ({{ getCountByStatus('qc') }})
 81:           </ng-template>
 82:         </nz-tab>
 83: 
 84:         <nz-tab nzTitle="é©—æ”¶ä¸­">
 85:           <ng-template nz-tab>
 86:             <span nz-icon nzType="file-done" nzTheme="outline"></span>
 87:             é©—æ”¶ä¸­ ({{ getCountByStatus('acceptance') }})
 88:           </ng-template>
 89:         </nz-tab>
 90: 
 91:         <nz-tab nzTitle="å•é¡Œè¿½è¹¤">
 92:           <ng-template nz-tab>
 93:             <span nz-icon nzType="warning" nzTheme="outline"></span>
 94:             å•é¡Œ ({{ getCountByStatus('issue') }})
 95:           </ng-template>
 96:         </nz-tab>
 97:       </nz-tabset>
 98: 
 99:       <!-- Todo list -->
100:       <div class="todo-list">
101:         @if (loading()) {
102:           <div class="loading-state">
103:             <nz-spin nzSimple />
104:           </div>
105:         } @else if (filteredTodos().length === 0) {
106:           <nz-empty 
107:             nzNotFoundContent="æš«ç„¡å¾…è¾¦äº‹é …"
108:             [nzNotFoundImage]="'simple'"
109:             class="empty-state" />
110:         } @else {
111:           @for (todo of filteredTodos(); track todo.id) {
112:             <div 
113:               class="todo-item"
114:               [class.priority-high]="todo.priority === 'high'"
115:               [class.priority-urgent]="todo.priority === 'urgent'"
116:               (click)="handleItemClick(todo)">
117:               
118:               <div class="todo-content">
119:                 <nz-badge 
120:                   [nzStatus]="getStatusBadge(todo.status)"
121:                   [nzText]="todo.title" />
122:                 
123:                 @if (todo.dueDate) {
124:                   <div class="todo-meta">
125:                     <span nz-icon nzType="calendar" nzTheme="outline"></span>
126:                     {{ todo.dueDate | date:'yyyy-MM-dd' }}
127:                   </div>
128:                 }
129:               </div>
130: 
131:               @if (todo.priority) {
132:                 <nz-tag 
133:                   [nzColor]="getPriorityColor(todo.priority)"
134:                   class="priority-tag">
135:                   {{ getPriorityLabel(todo.priority) }}
136:                 </nz-tag>
137:               }
138:             </div>
139:           }
140:         }
141:       </div>
142: 
143:       @if (!loading() && filteredTodos().length > 0 && showViewAll()) {
144:         <div class="todo-footer">
145:           <a (click)="handleViewAll()">æŸ¥çœ‹å…¨éƒ¨ â†’</a>
146:         </div>
147:       }
148:     </nz-card>
149:   `,
150:   styles: [`
151:     .todo-widget {
152:       height: 100%;
153: 
154:       :host ::ng-deep .ant-card-body {
155:         padding: 0;
156:       }
157:     }
158: 
159:     .todo-list {
160:       max-height: 400px;
161:       overflow-y: auto;
162:     }
163: 
164:     .loading-state {
165:       padding: 48px;
166:       text-align: center;
167:     }
168: 
169:     .empty-state {
170:       padding: 48px 24px;
171:     }
172: 
173:     .todo-item {
174:       display: flex;
175:       align-items: center;
176:       justify-content: space-between;
177:       padding: 12px 16px;
178:       border-bottom: 1px solid #f0f0f0;
179:       cursor: pointer;
180:       transition: background-color 0.2s;
181: 
182:       &:hover {
183:         background-color: #f5f5f5;
184:       }
185: 
186:       &:last-child {
187:         border-bottom: none;
188:       }
189: 
190:       &.priority-high {
191:         border-left: 3px solid #faad14;
192:       }
193: 
194:       &.priority-urgent {
195:         border-left: 3px solid #ff4d4f;
196:       }
197:     }
198: 
199:     .todo-content {
200:       flex: 1;
201:       display: flex;
202:       flex-direction: column;
203:       gap: 4px;
204:     }
205: 
206:     .todo-meta {
207:       font-size: 12px;
208:       color: rgba(0, 0, 0, 0.45);
209:       display: flex;
210:       align-items: center;
211:       gap: 4px;
212:     }
213: 
214:     .priority-tag {
215:       margin-left: 8px;
216:     }
217: 
218:     .todo-footer {
219:       padding: 12px 16px;
220:       text-align: center;
221:       border-top: 1px solid #f0f0f0;
222: 
223:       a {
224:         color: #1890ff;
225:         cursor: pointer;
226: 
227:         &:hover {
228:           color: #40a9ff;
229:         }
230:       }
231:     }
232:   `]
233: })
234: export class TodoWidgetComponent {
235:   /** å¾…è¾¦äº‹é …åˆ—è¡¨ */
236:   todos = input.required<TodoItem[]>();
237: 
238:   /** è¼‰å…¥ç‹€æ…‹ */
239:   loading = input<boolean>(false);
240: 
241:   /** æ˜¯å¦é¡¯ç¤ºã€ŒæŸ¥çœ‹å…¨éƒ¨ã€é€£çµ */
242:   showViewAll = input<boolean>(true);
243: 
244:   /** é»æ“Šå¾…è¾¦äº‹é … */
245:   itemClick = output<TodoItem>();
246: 
247:   /** ç‹€æ…‹è®Šæ›´ */
248:   statusChange = output<TodoStatusFilter>();
249: 
250:   /** æŸ¥çœ‹å…¨éƒ¨ */
251:   viewAll = output<void>();
252: 
253:   /** ç•¶å‰é¸ä¸­çš„ Tab ç´¢å¼• */
254:   selectedTabIndex = signal(0);
255: 
256:   /** ç•¶å‰ç¯©é¸ç‹€æ…‹ */
257:   currentFilter = signal<TodoStatusFilter>('all');
258: 
259:   /**
260:    * ç¯©é¸å¾Œçš„å¾…è¾¦äº‹é …
261:    */
262:   filteredTodos = () => {
263:     const filter = this.currentFilter();
264:     const todos = this.todos();
265:     
266:     if (filter === 'all') {
267:       return todos;
268:     }
269:     
270:     return todos.filter(todo => todo.status === filter);
271:   };
272: 
273:   /**
274:    * å–å¾—æŒ‡å®šç‹€æ…‹çš„å¾…è¾¦æ•¸é‡
275:    */
276:   getCountByStatus(status: TodoStatusFilter): number {
277:     if (status === 'all') {
278:       return this.todos().length;
279:     }
280:     return this.todos().filter(todo => todo.status === status).length;
281:   }
282: 
283:   /**
284:    * Tab åˆ‡æ›è™•ç†
285:    */
286:   handleTabChange(index: number): void {
287:     const statuses: TodoStatusFilter[] = ['all', 'pending', 'staging', 'qc', 'acceptance', 'issue'];
288:     const newFilter = statuses[index];
289:     this.currentFilter.set(newFilter);
290:     this.statusChange.emit(newFilter);
291:   }
292: 
293:   /**
294:    * é»æ“Šå¾…è¾¦äº‹é …
295:    */
296:   handleItemClick(todo: TodoItem): void {
297:     this.itemClick.emit(todo);
298:   }
299: 
300:   /**
301:    * æŸ¥çœ‹å…¨éƒ¨
302:    */
303:   handleViewAll(): void {
304:     this.viewAll.emit();
305:   }
306: 
307:   /**
308:    * å–å¾—ç‹€æ…‹å¾½ç« é¡å‹
309:    */
310:   getStatusBadge(status: TodoItem['status']): 'success' | 'processing' | 'warning' | 'error' | 'default' {
311:     const statusMap = {
312:       pending: 'default',
313:       staging: 'processing',
314:       qc: 'warning',
315:       acceptance: 'processing',
316:       issue: 'error'
317:     } as const;
318:     
319:     return statusMap[status] || 'default';
320:   }
321: 
322:   /**
323:    * å–å¾—å„ªå…ˆç´šé¡è‰²
324:    */
325:   getPriorityColor(priority: TodoItem['priority']): string {
326:     const colorMap = {
327:       low: 'default',
328:       medium: 'blue',
329:       high: 'orange',
330:       urgent: 'red'
331:     };
332:     
333:     return colorMap[priority || 'low'];
334:   }
335: 
336:   /**
337:    * å–å¾—å„ªå…ˆç´šæ¨™ç±¤
338:    */
339:   getPriorityLabel(priority: TodoItem['priority']): string {
340:     const labelMap = {
341:       low: 'ä½',
342:       medium: 'ä¸­',
343:       high: 'é«˜',
344:       urgent: 'ç·Šæ€¥'
345:     };
346:     
347:     return labelMap[priority || 'low'];
348:   }
349: }
````

## File: src/app/shared/index.ts
````typescript
 1: // Components
 2: export * from './components/account-selector';
 3: export * from './components/form-error';
 4: export * from './components/loading-indicator';
 5: export * from './components/empty-state';
 6: export * from './components/confirmation-dialog';
 7: export * from './components/photo-gallery';
 8: export * from './components/todo-widget';
 9: export * from './components/comment-thread';
10: export * from './components/chart-wrapper';
11: export * from './components/qc-camera';
12: 
13: // Utils
14: export * from './utils/yuan';
15: 
16: // Models
17: export * from './models';
18: 
19: // Services
20: export * from './services';
21: 
22: // Module
23: export * from './cell-widget/index';
24: export * from './json-schema/index';
25: export * from './shared-imports';
26: export * from './st-widget/index';
````

## File: src/app/shared/models/account.models.ts
````typescript
 1: import { Database, AccountType, AccountStatus, TeamMemberRole } from '@core';
 2: 
 3: /**
 4:  * é‡æ–°å¯¼å‡ºè´¦æˆ·ç›¸å…³æšä¸¾ï¼ˆä» core å±‚å¯¼å…¥ï¼‰
 5:  * ä¿æŒå‘åå…¼å®¹ï¼Œå…è®¸ä» @shared/models/account å¯¼å…¥
 6:  *
 7:  * è¿™äº›æšä¸¾å®šä¹‰åœ¨ core å±‚ï¼Œå› ä¸º Repository å±‚éœ€è¦ä½¿ç”¨å®ƒä»¬
 8:  * ç¬¦åˆåˆ†å±‚æ¶æ„ï¼šcore ä¸ä¾èµ– shared
 9:  */
10: export { AccountType, AccountStatus, TeamMemberRole };
11: 
12: /**
13:  * Account å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
14:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
15:  */
16: export type Account = Database['public']['Tables']['accounts']['Row'];
17: export type AccountInsert = Database['public']['Tables']['accounts']['Insert'];
18: export type AccountUpdate = Database['public']['Tables']['accounts']['Update'];
19: 
20: /**
21:  * Team å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
22:  */
23: export type Team = Database['public']['Tables']['teams']['Row'];
24: export type TeamInsert = Database['public']['Tables']['teams']['Insert'];
25: export type TeamUpdate = Database['public']['Tables']['teams']['Update'];
26: 
27: /**
28:  * TeamMember å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
29:  */
30: export type TeamMember = Database['public']['Tables']['team_members']['Row'];
31: export type TeamMemberInsert = Database['public']['Tables']['team_members']['Insert'];
32: export type TeamMemberUpdate = Database['public']['Tables']['team_members']['Update'];
33: 
34: /**
35:  * OrganizationSchedule å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
36:  */
37: export type OrganizationSchedule = Database['public']['Tables']['organization_schedules']['Row'];
38: export type OrganizationScheduleInsert = Database['public']['Tables']['organization_schedules']['Insert'];
39: export type OrganizationScheduleUpdate = Database['public']['Tables']['organization_schedules']['Update'];
````

## File: src/app/shared/models/blueprint.models.ts
````typescript
 1: import { Database, BlueprintStatus, BranchType, BranchStatus, PRStatus } from '@core';
 2: 
 3: /**
 4:  * é‡æ–°å¯¼å‡ºè“å›¾ç³»ç»Ÿç›¸å…³æšä¸¾ï¼ˆä» core å±‚å¯¼å…¥ï¼‰
 5:  * ä¿æŒå‘åå…¼å®¹ï¼Œå…è®¸ä» @shared/models/blueprint å¯¼å…¥
 6:  *
 7:  * è¿™äº›æšä¸¾å®šä¹‰åœ¨ core å±‚ï¼Œå› ä¸º Repository å±‚éœ€è¦ä½¿ç”¨å®ƒä»¬
 8:  * ç¬¦åˆåˆ†å±‚æ¶æ„ï¼šcore ä¸ä¾èµ– shared
 9:  */
10: export { BlueprintStatus, BranchType, BranchStatus, PRStatus };
11: 
12: /**
13:  * Blueprint å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
14:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
15:  */
16: export type Blueprint = Database['public']['Tables']['blueprints']['Row'];
17: export type BlueprintInsert = Database['public']['Tables']['blueprints']['Insert'];
18: export type BlueprintUpdate = Database['public']['Tables']['blueprints']['Update'];
19: 
20: /**
21:  * BlueprintConfig å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
22:  */
23: export type BlueprintConfig = Database['public']['Tables']['blueprint_configs']['Row'];
24: export type BlueprintConfigInsert = Database['public']['Tables']['blueprint_configs']['Insert'];
25: export type BlueprintConfigUpdate = Database['public']['Tables']['blueprint_configs']['Update'];
26: 
27: /**
28:  * BlueprintBranch å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
29:  */
30: export type BlueprintBranch = Database['public']['Tables']['blueprint_branches']['Row'];
31: export type BlueprintBranchInsert = Database['public']['Tables']['blueprint_branches']['Insert'];
32: export type BlueprintBranchUpdate = Database['public']['Tables']['blueprint_branches']['Update'];
33: 
34: /**
35:  * BranchFork å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
36:  */
37: export type BranchFork = Database['public']['Tables']['branch_forks']['Row'];
38: export type BranchForkInsert = Database['public']['Tables']['branch_forks']['Insert'];
39: export type BranchForkUpdate = Database['public']['Tables']['branch_forks']['Update'];
40: 
41: /**
42:  * PullRequest å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
43:  */
44: export type PullRequest = Database['public']['Tables']['pull_requests']['Row'];
45: export type PullRequestInsert = Database['public']['Tables']['pull_requests']['Insert'];
46: export type PullRequestUpdate = Database['public']['Tables']['pull_requests']['Update'];
````

## File: src/app/shared/models/bot.models.ts
````typescript
 1: import { Database } from '@core';
 2: 
 3: /**
 4:  * æœºå™¨äººç³»ç»Ÿæ•°æ®æ¨¡å‹
 5:  *
 6:  * å¯¹åº”æ•°æ®åº“è¡¨ï¼š
 7:  * - bots: æœºå™¨äººå®šä¹‰è¡¨
 8:  * - bot_tasks: æœºå™¨äººä»»åŠ¡è¡¨
 9:  * - bot_execution_logs: æœºå™¨äººæ‰§è¡Œæ—¥å¿—è¡¨
10:  *
11:  * @module shared/models/bot
12:  */
13: 
14: /**
15:  * Bot å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
16:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
17:  */
18: export type Bot = Database['public']['Tables']['bots']['Row'];
19: export type BotInsert = Database['public']['Tables']['bots']['Insert'];
20: export type BotUpdate = Database['public']['Tables']['bots']['Update'];
21: 
22: /**
23:  * BotTask å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
24:  */
25: export type BotTask = Database['public']['Tables']['bot_tasks']['Row'];
26: export type BotTaskInsert = Database['public']['Tables']['bot_tasks']['Insert'];
27: export type BotTaskUpdate = Database['public']['Tables']['bot_tasks']['Update'];
28: 
29: /**
30:  * BotExecutionLog å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
31:  */
32: export type BotExecutionLog = Database['public']['Tables']['bot_execution_logs']['Row'];
33: export type BotExecutionLogInsert = Database['public']['Tables']['bot_execution_logs']['Insert'];
34: export type BotExecutionLogUpdate = Database['public']['Tables']['bot_execution_logs']['Update'];
````

## File: src/app/shared/models/collaboration.models.ts
````typescript
 1: import { Database, CollaborationType, CollaborationStatus, InvitationStatus } from '@core';
 2: 
 3: /**
 4:  * é‡æ–°å¯¼å‡ºåä½œç›¸å…³æšä¸¾ï¼ˆä» core å±‚å¯¼å…¥ï¼‰
 5:  * ä¿æŒå‘åå…¼å®¹ï¼Œå…è®¸ä» @shared/models/collaboration å¯¼å…¥
 6:  *
 7:  * è¿™äº›æšä¸¾å®šä¹‰åœ¨ core å±‚ï¼Œå› ä¸º Repository å±‚éœ€è¦ä½¿ç”¨å®ƒä»¬
 8:  * ç¬¦åˆåˆ†å±‚æ¶æ„ï¼šcore ä¸ä¾èµ– shared
 9:  */
10: export { CollaborationType, CollaborationStatus, InvitationStatus };
11: 
12: /**
13:  * OrganizationCollaboration å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
14:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
15:  */
16: export type OrganizationCollaboration = Database['public']['Tables']['organization_collaborations']['Row'];
17: export type OrganizationCollaborationInsert = Database['public']['Tables']['organization_collaborations']['Insert'];
18: export type OrganizationCollaborationUpdate = Database['public']['Tables']['organization_collaborations']['Update'];
19: 
20: /**
21:  * CollaborationInvitation å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
22:  */
23: export type CollaborationInvitation = Database['public']['Tables']['collaboration_invitations']['Row'];
24: export type CollaborationInvitationInsert = Database['public']['Tables']['collaboration_invitations']['Insert'];
25: export type CollaborationInvitationUpdate = Database['public']['Tables']['collaboration_invitations']['Update'];
26: 
27: /**
28:  * CollaborationMember å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
29:  */
30: export type CollaborationMember = Database['public']['Tables']['collaboration_members']['Row'];
31: export type CollaborationMemberInsert = Database['public']['Tables']['collaboration_members']['Insert'];
32: export type CollaborationMemberUpdate = Database['public']['Tables']['collaboration_members']['Update'];
````

## File: src/app/shared/models/communication.models.ts
````typescript
 1: import { Database } from '@core';
 2: 
 3: /**
 4:  * åä½œæ²Ÿé€šç³»ç»Ÿæ•°æ®æ¨¡å‹
 5:  *
 6:  * å¯¹åº”æ•°æ®åº“è¡¨ï¼š
 7:  * - comments: ç•™è¨€è¡¨
 8:  * - notifications: é€šçŸ¥è¡¨
 9:  * - notification_rules: é€šçŸ¥è§„åˆ™è¡¨
10:  * - notification_subscriptions: é€šçŸ¥è®¢é˜…è¡¨
11:  * - personal_todos: ä¸ªäººå¾…åŠä¸­å¿ƒè¡¨
12:  * - todo_status_tracking: å¾…åŠçŠ¶æ€è¿½è¸ªè¡¨
13:  *
14:  * @module shared/models/communication
15:  */
16: 
17: /**
18:  * Comment å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
19:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
20:  */
21: export type Comment = Database['public']['Tables']['comments']['Row'];
22: export type CommentInsert = Database['public']['Tables']['comments']['Insert'];
23: export type CommentUpdate = Database['public']['Tables']['comments']['Update'];
24: 
25: /**
26:  * Notification å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
27:  */
28: export type Notification = Database['public']['Tables']['notifications']['Row'];
29: export type NotificationInsert = Database['public']['Tables']['notifications']['Insert'];
30: export type NotificationUpdate = Database['public']['Tables']['notifications']['Update'];
31: 
32: /**
33:  * NotificationRule å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
34:  */
35: export type NotificationRule = Database['public']['Tables']['notification_rules']['Row'];
36: export type NotificationRuleInsert = Database['public']['Tables']['notification_rules']['Insert'];
37: export type NotificationRuleUpdate = Database['public']['Tables']['notification_rules']['Update'];
38: 
39: /**
40:  * NotificationSubscription å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
41:  */
42: export type NotificationSubscription = Database['public']['Tables']['notification_subscriptions']['Row'];
43: export type NotificationSubscriptionInsert = Database['public']['Tables']['notification_subscriptions']['Insert'];
44: export type NotificationSubscriptionUpdate = Database['public']['Tables']['notification_subscriptions']['Update'];
45: 
46: /**
47:  * PersonalTodo å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
48:  */
49: export type PersonalTodo = Database['public']['Tables']['personal_todos']['Row'];
50: export type PersonalTodoInsert = Database['public']['Tables']['personal_todos']['Insert'];
51: export type PersonalTodoUpdate = Database['public']['Tables']['personal_todos']['Update'];
52: 
53: /**
54:  * TodoStatusTracking å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
55:  */
56: export type TodoStatusTracking = Database['public']['Tables']['todo_status_tracking']['Row'];
57: export type TodoStatusTrackingInsert = Database['public']['Tables']['todo_status_tracking']['Insert'];
58: export type TodoStatusTrackingUpdate = Database['public']['Tables']['todo_status_tracking']['Update'];
````

## File: src/app/shared/models/data.models.ts
````typescript
  1: import { Database } from '@core';
  2: 
  3: /**
  4:  * èµ„æ–™åˆ†æç³»ç»Ÿæ•°æ®æ¨¡å‹
  5:  *
  6:  * å¯¹åº”æ•°æ®åº“è¡¨ï¼š
  7:  * - documents: æ–‡ä»¶å…ƒèµ„æ–™è¡¨ï¼ˆç»Ÿä¸€æ–‡ä»¶ç®¡ç†ï¼Œæ”¯æ´ç‰ˆæœ¬æ§åˆ¶ã€ç¼©å›¾ã€è½¯åˆ é™¤ï¼‰
  8:  * - document_versions: æ–‡ä»¶ç‰ˆæœ¬æ§åˆ¶è¡¨
  9:  * - document_thumbnails: å›¾ç‰‡ç¼©å›¾è¡¨
 10:  * - progress_tracking: è¿›åº¦è¿½è¸ªè¡¨ï¼ˆè§†è§‰åŒ–ä»ªè¡¨æ¿æ•°æ®ï¼‰
 11:  * - activity_logs: æ´»åŠ¨è®°å½•è¡¨ï¼ˆé›†ä¸­è®°å½•æ‰€æœ‰æ“ä½œï¼Œæ‰€æœ‰åˆ†æ”¯åŒæ­¥åˆ°ä¸»åˆ†æ”¯ï¼‰
 12:  * - analytics_cache: æ•°æ®åˆ†æå¿«å–è¡¨ï¼ˆé¢„è®¡ç®—çš„åˆ†ææŠ¥è¡¨å¿«å–ï¼‰
 13:  *
 14:  * @module shared/models/data
 15:  */
 16: 
 17: /**
 18:  * Document å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 19:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 20:  */
 21: export type Document = Database['public']['Tables']['documents']['Row'];
 22: export type DocumentInsert = Database['public']['Tables']['documents']['Insert'];
 23: export type DocumentUpdate = Database['public']['Tables']['documents']['Update'];
 24: 
 25: /**
 26:  * DocumentVersion å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 27:  */
 28: export type DocumentVersion = Database['public']['Tables']['document_versions']['Row'];
 29: export type DocumentVersionInsert = Database['public']['Tables']['document_versions']['Insert'];
 30: export type DocumentVersionUpdate = Database['public']['Tables']['document_versions']['Update'];
 31: 
 32: /**
 33:  * DocumentThumbnail å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 34:  */
 35: export type DocumentThumbnail = Database['public']['Tables']['document_thumbnails']['Row'];
 36: export type DocumentThumbnailInsert = Database['public']['Tables']['document_thumbnails']['Insert'];
 37: export type DocumentThumbnailUpdate = Database['public']['Tables']['document_thumbnails']['Update'];
 38: 
 39: /**
 40:  * ProgressTracking å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 41:  */
 42: export type ProgressTracking = Database['public']['Tables']['progress_tracking']['Row'];
 43: export type ProgressTrackingInsert = Database['public']['Tables']['progress_tracking']['Insert'];
 44: export type ProgressTrackingUpdate = Database['public']['Tables']['progress_tracking']['Update'];
 45: 
 46: /**
 47:  * ActivityLog æ•°æ®åº“ç±»å‹ï¼ˆsnake_caseï¼‰
 48:  */
 49: type ActivityLogDb = Database['public']['Tables']['activity_logs']['Row'];
 50: type ActivityLogInsertDb = Database['public']['Tables']['activity_logs']['Insert'];
 51: type ActivityLogUpdateDb = Database['public']['Tables']['activity_logs']['Update'];
 52: 
 53: /**
 54:  * ActivityLog å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 55:  * æ‡‰ç”¨å±¤ä½¿ç”¨ camelCase å±¬æ€§åç¨±
 56:  */
 57: export interface ActivityLog {
 58:   id: string;
 59:   blueprintId: string;
 60:   branchId: string | null;
 61:   actorId: string;
 62:   action: string;
 63:   resourceType: string;
 64:   resourceId: string | null;
 65:   actionDetails: Record<string, unknown> | null;
 66:   ipAddress: string | null;
 67:   userAgent: string | null;
 68:   createdAt: string;
 69: }
 70: 
 71: /**
 72:  * ActivityLog æ’å…¥é¡å‹ï¼ˆcamelCaseï¼‰
 73:  */
 74: export interface ActivityLogInsert {
 75:   actorId: string;
 76:   blueprintId: string;
 77:   branchId?: string | null;
 78:   action: string;
 79:   resourceType: string;
 80:   resourceId?: string | null;
 81:   actionDetails?: Record<string, unknown> | null;
 82:   ipAddress?: string | null;
 83:   userAgent?: string | null;
 84: }
 85: 
 86: /**
 87:  * ActivityLog æ›´æ–°é¡å‹ï¼ˆcamelCaseï¼‰
 88:  */
 89: export interface ActivityLogUpdate {
 90:   action?: string;
 91:   resourceType?: string;
 92:   resourceId?: string | null;
 93:   actionDetails?: Record<string, unknown> | null;
 94:   ipAddress?: string | null;
 95:   userAgent?: string | null;
 96: }
 97: 
 98: /**
 99:  * AnalyticsCache å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
100:  */
101: export type AnalyticsCache = Database['public']['Tables']['analytics_cache']['Row'];
102: export type AnalyticsCacheInsert = Database['public']['Tables']['analytics_cache']['Insert'];
103: export type AnalyticsCacheUpdate = Database['public']['Tables']['analytics_cache']['Update'];
104: 
105: /**
106:  * è³‡æºé¡å‹
107:  * ä¿ç•™åŸæœ‰æšä¸¾å®šä¹‰ä»¥ä¿æŒå‘åå…¼å®¹
108:  */
109: export enum ActivityLogResourceType {
110:   BLUEPRINT = 'blueprint',
111:   BRANCH = 'branch',
112:   TASK = 'task',
113:   ISSUE = 'issue',
114:   PR = 'pr',
115:   COMMENT = 'comment',
116:   DOCUMENT = 'document',
117:   INSPECTION = 'inspection',
118:   QA = 'qa'
119: }
120: 
121: /**
122:  * æ´»å‹•è¨˜éŒ„è©³æƒ…ï¼ˆåŒ…å«é—œè¯è³‡æ–™ï¼‰
123:  * ä½¿ç”¨ camelCase å±¬æ€§åç¨±ä»¥ä¿æŒèˆ‡æ‡‰ç”¨å±¤ä¸€è‡´
124:  */
125: export interface ActivityLogDetail {
126:   id: string;
127:   blueprintId: string;
128:   branchId: string | null;
129:   actorId: string;
130:   action: string;
131:   resourceType: ActivityLogResourceType;
132:   resourceId: string | null;
133:   actionDetails: Record<string, unknown> | null;
134:   ipAddress: string | null;
135:   userAgent: string | null;
136:   createdAt: string;
137:   actor?: {
138:     id: string;
139:     name: string;
140:     email: string;
141:   };
142:   blueprint?: {
143:     id: string;
144:     name: string;
145:   };
146:   branch?: {
147:     id: string;
148:     name: string;
149:   };
150: }
151: 
152: /**
153:  * æ´»å‹•è¨˜éŒ„éæ¿¾æ¢ä»¶
154:  * ä¿ç•™åŸæœ‰æ¥å£å®šä¹‰ä»¥ä¿æŒå‘åå…¼å®¹
155:  */
156: export interface ActivityLogFilters {
157:   blueprintId?: string;
158:   branchId?: string | null;
159:   actorId?: string;
160:   resourceType?: ActivityLogResourceType;
161:   resourceId?: string;
162:   startDate?: string;
163:   endDate?: string;
164: }
````

## File: src/app/shared/models/issue.models.ts
````typescript
 1: import { Database } from '@core';
 2: 
 3: /**
 4:  * é—®é¢˜è¿½è¸ªç³»ç»Ÿæ•°æ®æ¨¡å‹
 5:  *
 6:  * å¯¹åº”æ•°æ®åº“è¡¨ï¼š
 7:  * - issues: é—®é¢˜ä¸»è¡¨
 8:  * - issue_assignments: é—®é¢˜æŒ‡æ´¾è¡¨
 9:  * - issue_photos: é—®é¢˜ç…§ç‰‡è¡¨
10:  * - issue_sync_logs: é—®é¢˜åŒæ­¥è®°å½•è¡¨
11:  *
12:  * @module shared/models/issue
13:  */
14: 
15: /**
16:  * Issue å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
17:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
18:  */
19: export type Issue = Database['public']['Tables']['issues']['Row'];
20: export type IssueInsert = Database['public']['Tables']['issues']['Insert'];
21: export type IssueUpdate = Database['public']['Tables']['issues']['Update'];
22: 
23: /**
24:  * IssueAssignment å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
25:  */
26: export type IssueAssignment = Database['public']['Tables']['issue_assignments']['Row'];
27: export type IssueAssignmentInsert = Database['public']['Tables']['issue_assignments']['Insert'];
28: export type IssueAssignmentUpdate = Database['public']['Tables']['issue_assignments']['Update'];
29: 
30: /**
31:  * IssuePhoto å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
32:  */
33: export type IssuePhoto = Database['public']['Tables']['issue_photos']['Row'];
34: export type IssuePhotoInsert = Database['public']['Tables']['issue_photos']['Insert'];
35: export type IssuePhotoUpdate = Database['public']['Tables']['issue_photos']['Update'];
36: 
37: /**
38:  * IssueSyncLog å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
39:  */
40: export type IssueSyncLog = Database['public']['Tables']['issue_sync_logs']['Row'];
41: export type IssueSyncLogInsert = Database['public']['Tables']['issue_sync_logs']['Insert'];
42: export type IssueSyncLogUpdate = Database['public']['Tables']['issue_sync_logs']['Update'];
````

## File: src/app/shared/models/permission.models.ts
````typescript
 1: import { Database } from '@core';
 2: 
 3: /**
 4:  * æ¬Šé™ç³»çµ±æ¨¡å‹é¡å‹å®šç¾©
 5:  *
 6:  * ä½¿ç”¨ Database é¡å‹è‡ªå‹•ç”Ÿæˆï¼Œç¢ºä¿èˆ‡æ•¸æ“šåº«çµæ§‹ä¸€è‡´
 7:  */
 8: 
 9: /**
10:  * Role å¯¦é«”é¡å‹ï¼ˆcamelCaseï¼‰
11:  * å°æ‡‰ roles è¡¨
12:  */
13: export type Role = Database['public']['Tables']['roles']['Row'];
14: export type RoleInsert = Database['public']['Tables']['roles']['Insert'];
15: export type RoleUpdate = Database['public']['Tables']['roles']['Update'];
16: 
17: /**
18:  * Permission å¯¦é«”é¡å‹ï¼ˆcamelCaseï¼‰
19:  * å°æ‡‰ permissions è¡¨
20:  */
21: export type Permission = Database['public']['Tables']['permissions']['Row'];
22: export type PermissionInsert = Database['public']['Tables']['permissions']['Insert'];
23: export type PermissionUpdate = Database['public']['Tables']['permissions']['Update'];
24: 
25: /**
26:  * UserRole å¯¦é«”é¡å‹ï¼ˆcamelCaseï¼‰
27:  * å°æ‡‰ user_roles è¡¨
28:  */
29: export type UserRole = Database['public']['Tables']['user_roles']['Row'];
30: export type UserRoleInsert = Database['public']['Tables']['user_roles']['Insert'];
31: export type UserRoleUpdate = Database['public']['Tables']['user_roles']['Update'];
32: 
33: /**
34:  * RolePermission å¯¦é«”é¡å‹ï¼ˆcamelCaseï¼‰
35:  * å°æ‡‰ role_permissions è¡¨
36:  */
37: export type RolePermission = Database['public']['Tables']['role_permissions']['Row'];
38: export type RolePermissionInsert = Database['public']['Tables']['role_permissions']['Insert'];
39: export type RolePermissionUpdate = Database['public']['Tables']['role_permissions']['Update'];
40: 
41: /**
42:  * BranchPermission å¯¦é«”é¡å‹ï¼ˆcamelCaseï¼‰
43:  * å°æ‡‰ branch_permissions è¡¨
44:  */
45: export type BranchPermission = Database['public']['Tables']['branch_permissions']['Row'];
46: export type BranchPermissionInsert = Database['public']['Tables']['branch_permissions']['Insert'];
47: export type BranchPermissionUpdate = Database['public']['Tables']['branch_permissions']['Update'];
48: 
49: /**
50:  * åˆ†æ”¯æ¬Šé™ç´šåˆ¥æšèˆ‰
51:  */
52: export enum BranchPermissionLevel {
53:   /** æ“æœ‰è€…ï¼šå…¨æ¬Šæ§åˆ¶ */
54:   OWNER = 'owner',
55:   /** ç®¡ç†å“¡ï¼šç®¡ç†æ¬Šé™ */
56:   ADMIN = 'admin',
57:   /** å¯«å…¥ï¼šå¯ä»¥ä¿®æ”¹æ‰¿æ”¬æ¬„ä½ */
58:   WRITE = 'write',
59:   /** è®€å–ï¼šå”¯è®€ */
60:   READ = 'read'
61: }
````

## File: src/app/shared/models/quality.models.ts
````typescript
  1: import { Database } from '@core';
  2: 
  3: /**
  4:  * å“è´¨éªŒæ”¶ç³»ç»Ÿæ•°æ®æ¨¡å‹
  5:  *
  6:  * å¯¹åº”æ•°æ®åº“è¡¨ï¼š
  7:  * - quality_checks: å“è´¨ç®¡ç†è¡¨ï¼ˆå“ç®¡æ£€æŸ¥è®°å½•ï¼‰
  8:  * - qc_photos: å“ç®¡ç…§ç‰‡è¡¨
  9:  * - inspections: éªŒæ”¶è¡¨ï¼ˆæœ€ç»ˆéªŒæ”¶/è´£ä»»åˆ‡å‰²ï¼‰
 10:  * - inspection_photos: éªŒæ”¶ç…§ç‰‡è¡¨
 11:  *
 12:  * @module shared/models/quality
 13:  */
 14: 
 15: /**
 16:  * QualityCheck æ•°æ®åº“ç±»å‹ï¼ˆsnake_caseï¼‰
 17:  */
 18: type QualityCheckDb = Database['public']['Tables']['quality_checks']['Row'];
 19: type QualityCheckInsertDb = Database['public']['Tables']['quality_checks']['Insert'];
 20: type QualityCheckUpdateDb = Database['public']['Tables']['quality_checks']['Update'];
 21: 
 22: /**
 23:  * QualityCheck å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 24:  * æ‡‰ç”¨å±¤ä½¿ç”¨ camelCase å±¬æ€§åç¨±
 25:  */
 26: export interface QualityCheck {
 27:   id: string;
 28:   taskId: string;
 29:   stagingId: string | null;
 30:   inspectorId: string;
 31:   checkType: string | null;
 32:   status: string | null;
 33:   checkItems: unknown[] | null;
 34:   findings: string | null;
 35:   recommendations: string | null;
 36:   checkedAt: string | null;
 37:   completedAt: string | null;
 38: }
 39: 
 40: /**
 41:  * QualityCheck æ’å…¥é¡å‹ï¼ˆcamelCaseï¼‰
 42:  */
 43: export interface QualityCheckInsert {
 44:   taskId: string;
 45:   stagingId?: string | null;
 46:   inspectorId: string;
 47:   checkType?: string | null;
 48:   status?: string | null;
 49:   checkItems?: unknown[] | null;
 50:   findings?: string | null;
 51:   recommendations?: string | null;
 52:   checkedAt?: string | null;
 53:   completedAt?: string | null;
 54: }
 55: 
 56: /**
 57:  * QualityCheck æ›´æ–°é¡å‹ï¼ˆcamelCaseï¼‰
 58:  */
 59: export interface QualityCheckUpdate {
 60:   status?: string | null;
 61:   checkItems?: unknown[] | null;
 62:   findings?: string | null;
 63:   recommendations?: string | null;
 64:   checkedAt?: string | null;
 65:   completedAt?: string | null;
 66: }
 67: 
 68: /**
 69:  * QcPhoto å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 70:  */
 71: export type QcPhoto = Database['public']['Tables']['qc_photos']['Row'];
 72: export type QcPhotoInsert = Database['public']['Tables']['qc_photos']['Insert'];
 73: export type QcPhotoUpdate = Database['public']['Tables']['qc_photos']['Update'];
 74: 
 75: /**
 76:  * Inspection å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 77:  */
 78: export type Inspection = Database['public']['Tables']['inspections']['Row'];
 79: export type InspectionInsert = Database['public']['Tables']['inspections']['Insert'];
 80: export type InspectionUpdate = Database['public']['Tables']['inspections']['Update'];
 81: 
 82: /**
 83:  * InspectionPhoto å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 84:  */
 85: export type InspectionPhoto = Database['public']['Tables']['inspection_photos']['Row'];
 86: export type InspectionPhotoInsert = Database['public']['Tables']['inspection_photos']['Insert'];
 87: export type InspectionPhotoUpdate = Database['public']['Tables']['inspection_photos']['Update'];
 88: 
 89: /**
 90:  * æ£€æŸ¥é¡å‹
 91:  * ä¿ç•™åŸæœ‰æšä¸¾å®šä¹‰ä»¥ä¿æŒå‘åå…¼å®¹
 92:  */
 93: export enum QualityCheckType {
 94:   ROUTINE = 'routine', // ä¾‹è¡Œæª¢æŸ¥
 95:   MILESTONE = 'milestone', // é‡Œç¨‹ç¢‘æª¢æŸ¥
 96:   FINAL = 'final', // æœ€çµ‚é©—æ”¶
 97:   SPOT_CHECK = 'spot_check' // æŠ½æŸ¥
 98: }
 99: 
100: /**
101:  * æª¢æŸ¥ç‹€æ…‹
102:  * ä¿ç•™åŸæœ‰æšä¸¾å®šä¹‰ä»¥ä¿æŒå‘åå…¼å®¹
103:  */
104: export enum QualityCheckStatus {
105:   PENDING = 'pending', // å¾…æª¢æŸ¥
106:   IN_PROGRESS = 'in_progress', // æª¢æŸ¥ä¸­
107:   PASSED = 'passed', // é€šé
108:   FAILED = 'failed', // æœªé€šé
109:   CONDITIONAL_PASS = 'conditional_pass' // æ¢ä»¶é€šé
110: }
111: 
112: /**
113:  * æª¢æŸ¥é …ç›®
114:  * ä¿ç•™åŸæœ‰æ¥å£å®šä¹‰ä»¥ä¿æŒå‘åå…¼å®¹
115:  */
116: export interface QualityCheckItem {
117:   id: string;
118:   name: string;
119:   description?: string;
120:   required: boolean;
121:   passed: boolean;
122:   remarks?: string;
123: }
124: 
125: /**
126:  * å“è³ªæª¢æŸ¥è©³æƒ…ï¼ˆåŒ…å«é—œè¯è³‡æ–™ï¼‰
127:  * ä½¿ç”¨ camelCase å±¬æ€§åç¨±ä»¥ä¿æŒèˆ‡æ‡‰ç”¨å±¤ä¸€è‡´
128:  * æ³¨æ„ï¼šä¸ç›´æ¥ç¹¼æ‰¿ QualityCheckï¼ˆæ•¸æ“šåº«é¡å‹ï¼Œsnake_caseï¼‰ï¼Œè€Œæ˜¯æ˜ç¢ºå®šç¾© camelCase å±¬æ€§
129:  */
130: export interface QualityCheckDetail {
131:   // åŸºæœ¬å±¬æ€§ï¼ˆcamelCaseï¼‰
132:   id: string;
133:   taskId: string | null;
134:   stagingId: string | null;
135:   inspectorId: string | null;
136:   checkType: string | null;
137:   status: string | null;
138:   checkItems: unknown[] | null;
139:   findings: string | null;
140:   recommendations: string | null;
141:   checkedAt: string | null;
142:   completedAt: string | null;
143: 
144:   // é—œè¯è³‡æ–™
145:   task?: {
146:     id: string;
147:     name: string;
148:     code: string;
149:   };
150:   inspector?: {
151:     id: string;
152:     name: string;
153:     email: string;
154:   };
155:   photos?: Array<{
156:     id: string;
157:     url: string;
158:     caption?: string;
159:   }>;
160: }
````

## File: src/app/shared/models/system.models.ts
````typescript
 1: import { Database } from '@core';
 2: 
 3: /**
 4:  * ç³»ç»Ÿç®¡ç†æ•°æ®æ¨¡å‹
 5:  *
 6:  * å¯¹åº”æ•°æ®åº“è¡¨ï¼š
 7:  * - settings: ç³»ç»Ÿè®¾å®šè¡¨
 8:  * - feature_flags: åŠŸèƒ½å¼€å…³è¡¨
 9:  *
10:  * @module shared/models/system
11:  */
12: 
13: /**
14:  * Setting å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
15:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
16:  */
17: export type Setting = Database['public']['Tables']['settings']['Row'];
18: export type SettingInsert = Database['public']['Tables']['settings']['Insert'];
19: export type SettingUpdate = Database['public']['Tables']['settings']['Update'];
20: 
21: /**
22:  * FeatureFlag å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
23:  */
24: export type FeatureFlag = Database['public']['Tables']['feature_flags']['Row'];
25: export type FeatureFlagInsert = Database['public']['Tables']['feature_flags']['Insert'];
26: export type FeatureFlagUpdate = Database['public']['Tables']['feature_flags']['Update'];
````

## File: src/app/shared/models/task.models.ts
````typescript
  1: import { Database, TaskType, TaskStatus, TaskPriority, TaskAssigneeType, TaskListType, TaskDependencyType } from '@core';
  2: 
  3: /**
  4:  * é‡æ–°å¯¼å‡ºä»»åŠ¡ç›¸å…³æšä¸¾ï¼ˆä» core å±‚å¯¼å…¥ï¼‰
  5:  * ä¿æŒå‘åå…¼å®¹ï¼Œå…è®¸ä» @shared/models/task å¯¼å…¥
  6:  *
  7:  * è¿™äº›æšä¸¾å®šä¹‰åœ¨ core å±‚ï¼Œå› ä¸º Repository å±‚éœ€è¦ä½¿ç”¨å®ƒä»¬
  8:  * ç¬¦åˆåˆ†å±‚æ¶æ„ï¼šcore ä¸ä¾èµ– shared
  9:  */
 10: export { TaskType, TaskStatus, TaskPriority, TaskAssigneeType, TaskListType, TaskDependencyType };
 11: 
 12: /**
 13:  * Task å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 14:  * æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ï¼ŒBaseRepository ä¼šè‡ªåŠ¨è¿›è¡Œ snake_case â†’ camelCase è½¬æ¢
 15:  */
 16: export type Task = Database['public']['Tables']['tasks']['Row'];
 17: export type TaskInsert = Database['public']['Tables']['tasks']['Insert'];
 18: export type TaskUpdate = Database['public']['Tables']['tasks']['Update'];
 19: 
 20: /**
 21:  * TaskAssignment å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 22:  */
 23: export type TaskAssignment = Database['public']['Tables']['task_assignments']['Row'];
 24: export type TaskAssignmentInsert = Database['public']['Tables']['task_assignments']['Insert'];
 25: export type TaskAssignmentUpdate = Database['public']['Tables']['task_assignments']['Update'];
 26: 
 27: /**
 28:  * TaskList å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 29:  */
 30: export type TaskList = Database['public']['Tables']['task_lists']['Row'];
 31: export type TaskListInsert = Database['public']['Tables']['task_lists']['Insert'];
 32: export type TaskListUpdate = Database['public']['Tables']['task_lists']['Update'];
 33: 
 34: /**
 35:  * TaskStaging å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 36:  */
 37: export type TaskStaging = Database['public']['Tables']['task_staging']['Row'];
 38: export type TaskStagingInsert = Database['public']['Tables']['task_staging']['Insert'];
 39: export type TaskStagingUpdate = Database['public']['Tables']['task_staging']['Update'];
 40: 
 41: /**
 42:  * TaskDependency å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 43:  */
 44: export type TaskDependency = Database['public']['Tables']['task_dependencies']['Row'];
 45: export type TaskDependencyInsert = Database['public']['Tables']['task_dependencies']['Insert'];
 46: export type TaskDependencyUpdate = Database['public']['Tables']['task_dependencies']['Update'];
 47: 
 48: /**
 49:  * TaskTemplate å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 50:  */
 51: export type TaskTemplate = Database['public']['Tables']['task_templates']['Row'];
 52: export type TaskTemplateInsert = Database['public']['Tables']['task_templates']['Insert'];
 53: export type TaskTemplateUpdate = Database['public']['Tables']['task_templates']['Update'];
 54: 
 55: /**
 56:  * DailyReport å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 57:  */
 58: export type DailyReport = Database['public']['Tables']['daily_reports']['Row'];
 59: export type DailyReportInsert = Database['public']['Tables']['daily_reports']['Insert'];
 60: export type DailyReportUpdate = Database['public']['Tables']['daily_reports']['Update'];
 61: 
 62: /**
 63:  * ReportPhoto å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 64:  */
 65: export type ReportPhoto = Database['public']['Tables']['report_photos']['Row'];
 66: export type ReportPhotoInsert = Database['public']['Tables']['report_photos']['Insert'];
 67: export type ReportPhotoUpdate = Database['public']['Tables']['report_photos']['Update'];
 68: 
 69: /**
 70:  * WeatherCache å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 71:  */
 72: export type WeatherCache = Database['public']['Tables']['weather_cache']['Row'];
 73: export type WeatherCacheInsert = Database['public']['Tables']['weather_cache']['Insert'];
 74: export type WeatherCacheUpdate = Database['public']['Tables']['weather_cache']['Update'];
 75: 
 76: // Note: Inspection å’Œ InspectionPhoto ç±»å‹å·²è¿ç§»åˆ° quality æ¨¡å—
 77: // è¯·ä» @shared/models/quality å¯¼å…¥
 78: 
 79: /**
 80:  * ä»»åŠ¡æ ‘èŠ‚ç‚¹ç±»å‹ï¼ˆç”¨äºå‰ç«¯æ ‘çŠ¶ç»“æ„å±•ç¤ºï¼‰
 81:  */
 82: export interface TaskTreeNode extends Task {
 83:   children?: TaskTreeNode[];
 84:   expanded?: boolean;
 85:   loading?: boolean;
 86: }
 87: 
 88: /**
 89:  * ä»»åŠ¡æŒ‡æ´¾ä¿¡æ¯ï¼ˆåŒ…å«æŒ‡æ´¾å¯¹è±¡ä¿¡æ¯ï¼‰
 90:  */
 91: export interface TaskAssignmentWithAssignee extends TaskAssignment {
 92:   assignee?: {
 93:     id: string;
 94:     name: string;
 95:     type: string;
 96:   };
 97:   assignedBy?: {
 98:     id: string;
 99:     name: string;
100:   };
101: }
102: 
103: /**
104:  * ä»»åŠ¡è¯¦æƒ…ï¼ˆåŒ…å«å…³è”ä¿¡æ¯ï¼‰
105:  */
106: export interface TaskDetail extends Task {
107:   assignments?: TaskAssignmentWithAssignee[];
108:   children?: Task[];
109:   parent?: Task;
110:   dependencies?: TaskDependency[];
111:   staging?: TaskStaging;
112:   dailyReports?: DailyReport[];
113: }
````

## File: src/app/shared/services/account/index.ts
````typescript
 1: /**
 2:  * è´¦æˆ·æœåŠ¡å¯¼å‡º
 3:  *
 4:  * æä¾›è´¦æˆ·å’Œå›¢é˜Ÿç®¡ç†çš„æœåŠ¡ï¼š
 5:  * - AccountService: è´¦æˆ· CRUD æ“ä½œ
 6:  * - TeamService: å›¢é˜Ÿ CRUD æ“ä½œå’Œæˆå‘˜ç®¡ç†
 7:  * - OrganizationScheduleService: ç»„ç»‡æ’ç­ç®¡ç†
 8:  *
 9:  * @module shared/services/account
10:  */
11: 
12: export * from './account.service';
13: export * from './organization-member.service';
14: export * from './organization-schedule.service';
15: export * from './team.service';
````

## File: src/app/shared/services/account/organization-member.service.ts
````typescript
  1: import { Injectable, inject, signal } from '@angular/core';
  2: import {
  3:   OrganizationMember,
  4:   OrganizationMemberInsert,
  5:   OrganizationMemberRepository,
  6:   OrganizationMemberRole,
  7:   OrganizationMemberUpdate
  8: } from '@core';
  9: import { firstValueFrom } from 'rxjs';
 10: 
 11: /**
 12:  * OrganizationMember Service
 13:  *
 14:  * æä¾›ç»„ç»‡æˆå‘˜ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†
 15:  * RLS ç­–ç•¥å·²å¤„ç†æ‰€æœ‰æƒé™æ£€æŸ¥
 16:  */
 17: @Injectable({
 18:   providedIn: 'root'
 19: })
 20: export class OrganizationMemberService {
 21:   private organizationMemberRepository = inject(OrganizationMemberRepository);
 22: 
 23:   // ä½¿ç”¨ Signals ç®¡ç†çŠ¶æ€
 24:   private membersState = signal<OrganizationMember[]>([]);
 25:   private loadingState = signal<boolean>(false);
 26:   private errorState = signal<string | null>(null);
 27: 
 28:   // æš´éœ² ReadonlySignal ç»™ç»„ä»¶
 29:   readonly members = this.membersState.asReadonly();
 30:   readonly loading = this.loadingState.asReadonly();
 31:   readonly error = this.errorState.asReadonly();
 32: 
 33:   /**
 34:    * æ ¹æ®ç»„ç»‡ ID åŠ è½½ç»„ç»‡æˆå‘˜åˆ—è¡¨
 35:    */
 36:   async loadMembersByOrganizationId(organizationId: string): Promise<OrganizationMember[]> {
 37:     this.loadingState.set(true);
 38:     this.errorState.set(null);
 39: 
 40:     try {
 41:       const members = (await firstValueFrom(
 42:         this.organizationMemberRepository.findByOrganizationId(organizationId)
 43:       )) as OrganizationMember[];
 44:       this.membersState.set(members);
 45:       return members;
 46:     } catch (error) {
 47:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½ç»„ç»‡æˆå‘˜åˆ—è¡¨å¤±è´¥');
 48:       throw error;
 49:     } finally {
 50:       this.loadingState.set(false);
 51:     }
 52:   }
 53: 
 54:   /**
 55:    * æ·»åŠ ç»„ç»‡æˆå‘˜
 56:    */
 57:   async addMember(data: { organizationId: string; accountId: string; role?: OrganizationMemberRole }): Promise<OrganizationMember> {
 58:     this.loadingState.set(true);
 59:     this.errorState.set(null);
 60: 
 61:     try {
 62:       const memberData: OrganizationMemberInsert = {
 63:         organization_id: data.organizationId,
 64:         account_id: data.accountId,
 65:         role: data.role || OrganizationMemberRole.MEMBER
 66:       };
 67: 
 68:       const member = (await firstValueFrom(this.organizationMemberRepository.create(memberData))) as OrganizationMember;
 69: 
 70:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
 71:       this.membersState.update(members => [...members, member]);
 72:       return member;
 73:     } catch (error) {
 74:       this.errorState.set(error instanceof Error ? error.message : 'æ·»åŠ ç»„ç»‡æˆå‘˜å¤±è´¥');
 75:       throw error;
 76:     } finally {
 77:       this.loadingState.set(false);
 78:     }
 79:   }
 80: 
 81:   /**
 82:    * æ›´æ–°ç»„ç»‡æˆå‘˜è§’è‰²
 83:    */
 84:   async updateMemberRole(memberId: string, role: OrganizationMemberRole): Promise<OrganizationMember> {
 85:     this.loadingState.set(true);
 86:     this.errorState.set(null);
 87: 
 88:     try {
 89:       const updateData: OrganizationMemberUpdate = {
 90:         role
 91:       };
 92: 
 93:       const member = (await firstValueFrom(this.organizationMemberRepository.update(memberId, updateData))) as OrganizationMember;
 94: 
 95:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
 96:       this.membersState.update(members => members.map(m => (m.id === memberId ? member : m)));
 97:       return member;
 98:     } catch (error) {
 99:       this.errorState.set(error instanceof Error ? error.message : 'æ›´æ–°ç»„ç»‡æˆå‘˜è§’è‰²å¤±è´¥');
100:       throw error;
101:     } finally {
102:       this.loadingState.set(false);
103:     }
104:   }
105: 
106:   /**
107:    * ç§»é™¤ç»„ç»‡æˆå‘˜
108:    */
109:   async removeMember(memberId: string): Promise<void> {
110:     this.loadingState.set(true);
111:     this.errorState.set(null);
112: 
113:     try {
114:       await firstValueFrom(this.organizationMemberRepository.delete(memberId));
115: 
116:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
117:       this.membersState.update(members => members.filter(m => m.id !== memberId));
118:     } catch (error) {
119:       this.errorState.set(error instanceof Error ? error.message : 'ç§»é™¤ç»„ç»‡æˆå‘˜å¤±è´¥');
120:       throw error;
121:     } finally {
122:       this.loadingState.set(false);
123:     }
124:   }
125: 
126:   /**
127:    * æ¸…ç©ºçŠ¶æ€
128:    */
129:   clearState(): void {
130:     this.membersState.set([]);
131:     this.errorState.set(null);
132:   }
133: }
````

## File: src/app/shared/services/account/team.service.ts
````typescript
  1: import { Injectable, inject, signal } from '@angular/core';
  2: import { Team, TeamInsert, TeamRepository, TeamUpdate } from '@core';
  3: import { firstValueFrom } from 'rxjs';
  4: 
  5: /**
  6:  * Team Service
  7:  *
  8:  * æä¾›å›¢é˜Ÿç›¸å…³çš„ä¸šåŠ¡é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†
  9:  * RLS ç­–ç•¥å·²å¤„ç†æ‰€æœ‰æƒé™æ£€æŸ¥
 10:  */
 11: @Injectable({
 12:   providedIn: 'root'
 13: })
 14: export class TeamService {
 15:   private teamRepository = inject(TeamRepository);
 16: 
 17:   // ä½¿ç”¨ Signals ç®¡ç†çŠ¶æ€
 18:   private teamsState = signal<Team[]>([]);
 19:   private selectedTeamState = signal<Team | null>(null);
 20:   private loadingState = signal<boolean>(false);
 21:   private errorState = signal<string | null>(null);
 22: 
 23:   // æš´éœ² ReadonlySignal ç»™ç»„ä»¶
 24:   readonly teams = this.teamsState.asReadonly();
 25:   readonly selectedTeam = this.selectedTeamState.asReadonly();
 26:   readonly loading = this.loadingState.asReadonly();
 27:   readonly error = this.errorState.asReadonly();
 28: 
 29:   /**
 30:    * åŠ è½½æ‰€æœ‰å›¢é˜Ÿ
 31:    */
 32:   async loadTeams(): Promise<void> {
 33:     this.loadingState.set(true);
 34:     this.errorState.set(null);
 35: 
 36:     try {
 37:       const teams = (await firstValueFrom(this.teamRepository.findAll())) as Team[];
 38:       this.teamsState.set(teams);
 39:     } catch (error) {
 40:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½å›¢é˜Ÿåˆ—è¡¨å¤±è´¥');
 41:       throw error;
 42:     } finally {
 43:       this.loadingState.set(false);
 44:     }
 45:   }
 46: 
 47:   /**
 48:    * æ ¹æ®ç»„ç»‡ ID åŠ è½½å›¢é˜Ÿåˆ—è¡¨
 49:    */
 50:   async loadTeamsByOrganizationId(organizationId: string): Promise<Team[]> {
 51:     this.loadingState.set(true);
 52:     this.errorState.set(null);
 53: 
 54:     try {
 55:       const teams = (await firstValueFrom(this.teamRepository.findByOrganizationId(organizationId))) as Team[];
 56:       this.teamsState.set(teams);
 57:       return teams;
 58:     } catch (error) {
 59:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½å›¢é˜Ÿåˆ—è¡¨å¤±è´¥');
 60:       throw error;
 61:     } finally {
 62:       this.loadingState.set(false);
 63:     }
 64:   }
 65: 
 66:   /**
 67:    * æ ¹æ® ID åŠ è½½å›¢é˜Ÿ
 68:    */
 69:   async loadTeamById(id: string): Promise<Team | null> {
 70:     this.loadingState.set(true);
 71:     this.errorState.set(null);
 72: 
 73:     try {
 74:       const team = (await firstValueFrom(this.teamRepository.findById(id))) as Team | null;
 75:       if (team) {
 76:         this.selectedTeamState.set(team);
 77:       }
 78:       return team;
 79:     } catch (error) {
 80:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½å›¢é˜Ÿå¤±è´¥');
 81:       throw error;
 82:     } finally {
 83:       this.loadingState.set(false);
 84:     }
 85:   }
 86: 
 87:   /**
 88:    * åˆ›å»ºå›¢é˜Ÿ
 89:    */
 90:   async createTeam(data: { organizationId: string; name: string; createdBy: string; description?: string | null }): Promise<Team> {
 91:     this.loadingState.set(true);
 92:     this.errorState.set(null);
 93: 
 94:     try {
 95:       const teamData = {
 96:         organization_id: data.organizationId,
 97:         name: data.name,
 98:         created_by: data.createdBy,
 99:         description: data.description ?? undefined
100:       } as TeamInsert;
101:       const team = (await firstValueFrom(this.teamRepository.create(teamData))) as Team;
102:       this.teamsState.update(teams => [...teams, team]);
103:       return team;
104:     } catch (error) {
105:       this.errorState.set(error instanceof Error ? error.message : 'åˆ›å»ºå›¢é˜Ÿå¤±è´¥');
106:       throw error;
107:     } finally {
108:       this.loadingState.set(false);
109:     }
110:   }
111: 
112:   /**
113:    * æ›´æ–°å›¢é˜Ÿ
114:    */
115:   async updateTeam(id: string, data: TeamUpdate): Promise<Team> {
116:     this.loadingState.set(true);
117:     this.errorState.set(null);
118: 
119:     try {
120:       const team = (await firstValueFrom(this.teamRepository.update(id, data))) as Team;
121:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
122:       this.teamsState.update(teams => teams.map(t => (t.id === id ? team : t)));
123:       // å¦‚æœæ›´æ–°çš„æ˜¯å½“å‰é€‰ä¸­çš„å›¢é˜Ÿï¼Œä¹Ÿæ›´æ–°é€‰ä¸­çŠ¶æ€
124:       if (this.selectedTeam()?.id === id) {
125:         this.selectedTeamState.set(team);
126:       }
127:       return team;
128:     } catch (error) {
129:       this.errorState.set(error instanceof Error ? error.message : 'æ›´æ–°å›¢é˜Ÿå¤±è´¥');
130:       throw error;
131:     } finally {
132:       this.loadingState.set(false);
133:     }
134:   }
135: 
136:   /**
137:    * åˆ é™¤å›¢é˜Ÿ
138:    */
139:   async deleteTeam(id: string): Promise<void> {
140:     this.loadingState.set(true);
141:     this.errorState.set(null);
142: 
143:     try {
144:       await firstValueFrom(this.teamRepository.delete(id));
145:       this.teamsState.update(teams => teams.filter(t => t.id !== id));
146:       if (this.selectedTeam()?.id === id) {
147:         this.selectedTeamState.set(null);
148:       }
149:     } catch (error) {
150:       this.errorState.set(error instanceof Error ? error.message : 'åˆ é™¤å›¢é˜Ÿå¤±è´¥');
151:       throw error;
152:     } finally {
153:       this.loadingState.set(false);
154:     }
155:   }
156: 
157:   /**
158:    * é‡ç½®çŠ¶æ€
159:    */
160:   reset(): void {
161:     this.teamsState.set([]);
162:     this.selectedTeamState.set(null);
163:     this.errorState.set(null);
164:   }
165: }
````

## File: src/app/shared/services/blueprint/branch-data-isolation.service.ts
````typescript
  1: import { Injectable, inject, signal, computed } from '@angular/core';
  2: import { BranchContextService } from '@core';
  3: import { BranchPermissionService, BranchPermissionLevel, AuthStateService } from '@shared';
  4: import { firstValueFrom } from 'rxjs';
  5: 
  6: /**
  7:  * Branch Data Isolation Service
  8:  *
  9:  * æä¾›åˆ†æ”¯æ•¸æ“šéš”é›¢ç›¸é—œçš„æ¥­å‹™é‚è¼¯
 10:  * å¯¦ç¾ä¸»åˆ†æ”¯èˆ‡çµ„ç¹”åˆ†æ”¯çš„æ•¸æ“šéš”é›¢æ©Ÿåˆ¶
 11:  *
 12:  * @example
 13:  * ```typescript
 14:  * const isolationService = inject(BranchDataIsolationService);
 15:  *
 16:  * // æª¢æŸ¥æ˜¯å¦å¯ä»¥è¨ªå•æ•¸æ“š
 17:  * const canAccess = await isolationService.canAccessData('task-id', 'read');
 18:  *
 19:  * // ç²å–æ•¸æ“šéæ¿¾æ¢ä»¶
 20:  * const filters = isolationService.getDataFilters();
 21:  * ```
 22:  */
 23: @Injectable({
 24:   providedIn: 'root'
 25: })
 26: export class BranchDataIsolationService {
 27:   private branchContext = inject(BranchContextService);
 28:   private branchPermissionService = inject(BranchPermissionService);
 29:   private authState = inject(AuthStateService);
 30: 
 31:   // ä½¿ç”¨ Signals ç®¡ç†ç‹€æ…‹
 32:   private isolationEnabledState = signal<boolean>(true);
 33:   private loadingState = signal<boolean>(false);
 34:   private errorState = signal<string | null>(null);
 35: 
 36:   // æš´éœ² ReadonlySignal çµ¦çµ„ä»¶
 37:   readonly isolationEnabled = this.isolationEnabledState.asReadonly();
 38:   readonly loading = this.loadingState.asReadonly();
 39:   readonly error = this.errorState.asReadonly();
 40: 
 41:   // Computed signals
 42:   readonly isMainBranch = computed(() => this.branchContext.isMainBranch());
 43:   readonly currentBranch = computed(() => this.branchContext.currentBranch());
 44:   readonly currentBranchId = computed(() => this.branchContext.currentBranchId());
 45: 
 46:   /**
 47:    * ç²å–æ•¸æ“šéæ¿¾æ¢ä»¶
 48:    * æ ¹æ“šç•¶å‰åˆ†æ”¯ç‹€æ…‹è¿”å›é©ç•¶çš„éæ¿¾æ¢ä»¶
 49:    *
 50:    * @returns éæ¿¾æ¢ä»¶å°è±¡
 51:    */
 52:   getDataFilters(): Record<string, any> {
 53:     const branch = this.currentBranch();
 54:     const filters: Record<string, any> = {};
 55: 
 56:     if (branch) {
 57:       // çµ„ç¹”åˆ†æ”¯ï¼šåªé¡¯ç¤ºè©²åˆ†æ”¯çš„æ•¸æ“š
 58:       filters['branchId'] = branch.id;
 59:     } else {
 60:       // ä¸»åˆ†æ”¯ï¼šé¡¯ç¤ºæ‰€æœ‰æ•¸æ“šï¼ˆä¸è¨­ç½®branchIdéæ¿¾ï¼‰
 61:       // æˆ–è€…å¯ä»¥è¨­ç½® branchId ç‚º null
 62:     }
 63: 
 64:     return filters;
 65:   }
 66: 
 67:   /**
 68:    * æª¢æŸ¥æ˜¯å¦å¯ä»¥è¨ªå•æŒ‡å®šæ•¸æ“š
 69:    *
 70:    * @param resourceId è³‡æºID
 71:    * @param action æ“ä½œé¡å‹ï¼ˆread/write/adminï¼‰
 72:    * @param resourceType è³‡æºé¡å‹ï¼ˆtask/daily_report/quality_checkç­‰ï¼‰
 73:    * @returns æ˜¯å¦æœ‰æ¬Šé™
 74:    */
 75:   async canAccessData(resourceId: string, action: 'read' | 'write' | 'admin', resourceType: string): Promise<boolean> {
 76:     const branch = this.currentBranch();
 77:     const currentUser = this.authState.user();
 78: 
 79:     if (!currentUser) {
 80:       return false;
 81:     }
 82: 
 83:     // ä¸»åˆ†æ”¯ï¼šè—åœ–æ“æœ‰è€…å¯ä»¥è¨ªå•æ‰€æœ‰æ•¸æ“š
 84:     if (!branch) {
 85:       // TODO: æª¢æŸ¥æ˜¯å¦ç‚ºè—åœ–æ“æœ‰è€…
 86:       return true;
 87:     }
 88: 
 89:     // çµ„ç¹”åˆ†æ”¯ï¼šæª¢æŸ¥åˆ†æ”¯æ¬Šé™
 90:     return await this.branchPermissionService.canPerformAction(branch.id, currentUser.id, action);
 91:   }
 92: 
 93:   /**
 94:    * æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹ä»»å‹™çµæ§‹
 95:    * åªæœ‰ä¸»åˆ†æ”¯çš„æ“æœ‰è€…å¯ä»¥ä¿®æ”¹ä»»å‹™çµæ§‹
 96:    *
 97:    * @returns æ˜¯å¦å¯ä»¥ä¿®æ”¹
 98:    */
 99:   async canModifyTaskStructure(): Promise<boolean> {
100:     const branch = this.currentBranch();
101:     const currentUser = this.authState.user();
102: 
103:     if (!currentUser) {
104:       return false;
105:     }
106: 
107:     // ä¸»åˆ†æ”¯ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºè—åœ–æ“æœ‰è€…
108:     if (!branch) {
109:       // TODO: æª¢æŸ¥æ˜¯å¦ç‚ºè—åœ–æ“æœ‰è€…
110:       return true;
111:     }
112: 
113:     // çµ„ç¹”åˆ†æ”¯ï¼šä¸èƒ½ä¿®æ”¹ä»»å‹™çµæ§‹
114:     return false;
115:   }
116: 
117:   /**
118:    * æª¢æŸ¥æ˜¯å¦å¯ä»¥å¡«å¯«æ‰¿æ”¬æ¬„ä½
119:    * åªæœ‰çµ„ç¹”åˆ†æ”¯å¯ä»¥å¡«å¯«æ‰¿æ”¬æ¬„ä½
120:    *
121:    * @returns æ˜¯å¦å¯ä»¥å¡«å¯«
122:    */
123:   async canFillContractorFields(): Promise<boolean> {
124:     const branch = this.currentBranch();
125:     const currentUser = this.authState.user();
126: 
127:     if (!currentUser || !branch) {
128:       return false;
129:     }
130: 
131:     return await this.branchPermissionService.canFillContractorFields(branch.id, currentUser.id);
132:   }
133: 
134:   /**
135:    * æª¢æŸ¥æ•¸æ“šæ˜¯å¦å±¬æ–¼ç•¶å‰åˆ†æ”¯
136:    *
137:    * @param dataBranchId æ•¸æ“šçš„åˆ†æ”¯IDï¼ˆå¯èƒ½ç‚ºnullè¡¨ç¤ºä¸»åˆ†æ”¯ï¼‰
138:    * @returns æ˜¯å¦å±¬æ–¼ç•¶å‰åˆ†æ”¯
139:    */
140:   belongsToCurrentBranch(dataBranchId: string | null): boolean {
141:     const currentBranch = this.currentBranch();
142: 
143:     // ä¸»åˆ†æ”¯ï¼šæ•¸æ“šçš„branchIdæ‡‰è©²ç‚ºnull
144:     if (!currentBranch) {
145:       return dataBranchId === null;
146:     }
147: 
148:     // çµ„ç¹”åˆ†æ”¯ï¼šæ•¸æ“šçš„branchIdæ‡‰è©²ç­‰æ–¼ç•¶å‰åˆ†æ”¯ID
149:     return dataBranchId === currentBranch.id;
150:   }
151: 
152:   /**
153:    * éæ¿¾æ•¸æ“šåˆ—è¡¨ï¼Œåªè¿”å›å±¬æ–¼ç•¶å‰åˆ†æ”¯çš„æ•¸æ“š
154:    *
155:    * @param dataList æ•¸æ“šåˆ—è¡¨
156:    * @param getBranchId ç²å–æ•¸æ“šåˆ†æ”¯IDçš„å‡½æ•¸
157:    * @returns éæ¿¾å¾Œçš„æ•¸æ“šåˆ—è¡¨
158:    */
159:   filterByCurrentBranch<T>(dataList: T[], getBranchId: (item: T) => string | null): T[] {
160:     return dataList.filter(item => this.belongsToCurrentBranch(getBranchId(item)));
161:   }
162: 
163:   /**
164:    * å•Ÿç”¨æ•¸æ“šéš”é›¢
165:    */
166:   enableIsolation(): void {
167:     this.isolationEnabledState.set(true);
168:   }
169: 
170:   /**
171:    * ç¦ç”¨æ•¸æ“šéš”é›¢ï¼ˆç”¨æ–¼ç®¡ç†å“¡æŸ¥çœ‹æ‰€æœ‰æ•¸æ“šï¼‰
172:    */
173:   disableIsolation(): void {
174:     this.isolationEnabledState.set(false);
175:   }
176: 
177:   /**
178:    * é‡ç½®ç‹€æ…‹
179:    */
180:   reset(): void {
181:     this.isolationEnabledState.set(true);
182:     this.errorState.set(null);
183:   }
184: }
````

## File: src/app/shared/services/blueprint/index.ts
````typescript
 1: /**
 2:  * è“å›¾æœåŠ¡å¯¼å‡º
 3:  *
 4:  * æä¾›è“å›¾ç³»ç»Ÿç›¸å…³çš„æœåŠ¡ï¼š
 5:  * - BlueprintService: è“å›¾ CRUD æ“ä½œå’Œä¸»åˆ†æ”¯ç®¡ç†
 6:  * - BranchService: åˆ†æ”¯ç®¡ç†å’Œ Fork æœºåˆ¶
 7:  * - PullRequestService: PR åˆ›å»ºã€å®¡æ ¸ã€åˆå¹¶
 8:  * - BranchDataIsolationService: åˆ†æ”¯æ•°æ®éš”ç¦»æœºåˆ¶
 9:  *
10:  * @module shared/services/blueprint
11:  */
12: 
13: export * from './blueprint.service';
14: export * from './branch.service';
15: export * from './pull-request.service';
16: export * from './branch-data-isolation.service';
````

## File: src/app/shared/services/permission/branch-permission.service.ts
````typescript
  1: import { Injectable, inject, signal, computed } from '@angular/core';
  2: import { BranchPermissionRepository, BranchPermissionInsert, BranchPermissionUpdate, BranchPermissionLevel } from '@core';
  3: import { BranchPermission } from '@shared';
  4: import { firstValueFrom, Observable } from 'rxjs';
  5: 
  6: /**
  7:  * BranchPermission Service
  8:  *
  9:  * æä¾›åˆ†æ”¯æ¬Šé™ç›¸é—œçš„æ¥­å‹™é‚è¼¯å’Œç‹€æ…‹ç®¡ç†
 10:  * å¯¦ç¾æ¬Šé™çŸ©é™£ï¼šæ“æœ‰è€…/å”ä½œçµ„ç¹”/æŸ¥çœ‹è€…æ¬Šé™å€åˆ†
 11:  *
 12:  * @example
 13:  * ```typescript
 14:  * const branchPermService = inject(BranchPermissionService);
 15:  *
 16:  * // æª¢æŸ¥æ¬Šé™
 17:  * const canWrite = await branchPermService.canPerformAction('branch-id', 'write');
 18:  *
 19:  * // æˆäºˆæ¬Šé™
 20:  * await branchPermService.grantPermission('branch-id', 'account-id', BranchPermissionLevel.WRITE);
 21:  * ```
 22:  */
 23: @Injectable({
 24:   providedIn: 'root'
 25: })
 26: export class BranchPermissionService {
 27:   private branchPermissionRepository = inject(BranchPermissionRepository);
 28: 
 29:   // ä½¿ç”¨ Signals ç®¡ç†ç‹€æ…‹
 30:   private permissionsState = signal<BranchPermission[]>([]);
 31:   private loadingState = signal<boolean>(false);
 32:   private errorState = signal<string | null>(null);
 33: 
 34:   // æš´éœ² ReadonlySignal çµ¦çµ„ä»¶
 35:   readonly permissions = this.permissionsState.asReadonly();
 36:   readonly loading = this.loadingState.asReadonly();
 37:   readonly error = this.errorState.asReadonly();
 38: 
 39:   // Computed signals
 40:   readonly ownerPermissions = computed(() => this.permissions().filter(p => p.permission_level === BranchPermissionLevel.OWNER));
 41: 
 42:   readonly adminPermissions = computed(() => this.permissions().filter(p => p.permission_level === BranchPermissionLevel.ADMIN));
 43: 
 44:   readonly writePermissions = computed(() => this.permissions().filter(p => p.permission_level === BranchPermissionLevel.WRITE));
 45: 
 46:   readonly readPermissions = computed(() => this.permissions().filter(p => p.permission_level === BranchPermissionLevel.READ));
 47: 
 48:   /**
 49:    * æ¬Šé™çŸ©é™£ï¼šå®šç¾©æ¯å€‹æ¬Šé™ç´šåˆ¥å¯ä»¥åŸ·è¡Œçš„æ“ä½œ
 50:    */
 51:   private readonly permissionMatrix: Record<BranchPermissionLevel, string[]> = {
 52:     [BranchPermissionLevel.OWNER]: [
 53:       'read',
 54:       'write',
 55:       'admin',
 56:       'create_task',
 57:       'modify_task_structure',
 58:       'fork_branch',
 59:       'review_pr',
 60:       'merge_pr',
 61:       'manage_permissions'
 62:     ],
 63:     [BranchPermissionLevel.ADMIN]: ['read', 'write', 'admin', 'create_task', 'review_pr', 'manage_permissions'],
 64:     [BranchPermissionLevel.WRITE]: ['read', 'write', 'fill_contractor_fields', 'submit_pr', 'create_daily_report', 'create_quality_check'],
 65:     [BranchPermissionLevel.READ]: ['read']
 66:   };
 67: 
 68:   /**
 69:    * åŠ è¼‰åˆ†æ”¯çš„æ‰€æœ‰æ¬Šé™
 70:    *
 71:    * @param branchId åˆ†æ”¯ ID
 72:    */
 73:   async loadPermissionsByBranchId(branchId: string): Promise<BranchPermission[]> {
 74:     this.loadingState.set(true);
 75:     this.errorState.set(null);
 76: 
 77:     try {
 78:       const permissions = await firstValueFrom(this.branchPermissionRepository.findByBranchId(branchId));
 79:       this.permissionsState.set(permissions);
 80:       return permissions;
 81:     } catch (error) {
 82:       const errorMessage = error instanceof Error ? error.message : 'åŠ è½½æƒé™åˆ—è¡¨å¤±è´¥';
 83:       this.errorState.set(errorMessage);
 84:       throw error;
 85:     } finally {
 86:       this.loadingState.set(false);
 87:     }
 88:   }
 89: 
 90:   /**
 91:    * åŠ è¼‰è³¬æˆ¶çš„æ‰€æœ‰åˆ†æ”¯æ¬Šé™
 92:    *
 93:    * @param accountId è³¬æˆ¶ ID
 94:    */
 95:   async loadPermissionsByAccountId(accountId: string): Promise<BranchPermission[]> {
 96:     this.loadingState.set(true);
 97:     this.errorState.set(null);
 98: 
 99:     try {
100:       const permissions = await firstValueFrom(this.branchPermissionRepository.findByAccountId(accountId));
101:       return permissions;
102:     } catch (error) {
103:       const errorMessage = error instanceof Error ? error.message : 'åŠ è½½æƒé™åˆ—è¡¨å¤±è´¥';
104:       this.errorState.set(errorMessage);
105:       throw error;
106:     } finally {
107:       this.loadingState.set(false);
108:     }
109:   }
110: 
111:   /**
112:    * æª¢æŸ¥è³¬æˆ¶åœ¨åˆ†æ”¯ä¸Šçš„æ¬Šé™ç´šåˆ¥
113:    *
114:    * @param branchId åˆ†æ”¯ ID
115:    * @param accountId è³¬æˆ¶ ID
116:    * @returns æ¬Šé™ç´šåˆ¥ï¼Œå¦‚æœæ²’æœ‰æ¬Šé™å‰‡è¿”å› null
117:    */
118:   async getPermissionLevel(branchId: string, accountId: string): Promise<BranchPermissionLevel | null> {
119:     try {
120:       const permission = await firstValueFrom(this.branchPermissionRepository.findByBranchAndAccount(branchId, accountId));
121: 
122:       if (!permission) {
123:         return null;
124:       }
125: 
126:       return permission.permission_level as BranchPermissionLevel;
127:     } catch (error) {
128:       this.errorState.set(error instanceof Error ? error.message : 'æŸ¥è¯¢æƒé™å¤±è´¥');
129:       return null;
130:     }
131:   }
132: 
133:   /**
134:    * æª¢æŸ¥æ˜¯å¦å¯ä»¥åŸ·è¡Œç‰¹å®šæ“ä½œ
135:    *
136:    * @param branchId åˆ†æ”¯ ID
137:    * @param accountId è³¬æˆ¶ ID
138:    * @param action æ“ä½œé¡å‹
139:    * @returns æ˜¯å¦æœ‰æ¬Šé™
140:    */
141:   async canPerformAction(branchId: string, accountId: string, action: string): Promise<boolean> {
142:     const permissionLevel = await this.getPermissionLevel(branchId, accountId);
143: 
144:     if (!permissionLevel) {
145:       return false;
146:     }
147: 
148:     const allowedActions = this.permissionMatrix[permissionLevel] || [];
149:     return allowedActions.includes(action);
150:   }
151: 
152:   /**
153:    * æˆäºˆåˆ†æ”¯æ¬Šé™
154:    *
155:    * @param branchId åˆ†æ”¯ ID
156:    * @param accountId è³¬æˆ¶ ID
157:    * @param permissionLevel æ¬Šé™ç´šåˆ¥
158:    * @param grantedBy æˆäºˆè€… ID
159:    * @returns å‰µå»ºçš„æ¬Šé™è¨˜éŒ„
160:    */
161:   async grantPermission(
162:     branchId: string,
163:     accountId: string,
164:     permissionLevel: BranchPermissionLevel,
165:     grantedBy: string
166:   ): Promise<BranchPermission> {
167:     this.loadingState.set(true);
168:     this.errorState.set(null);
169: 
170:     try {
171:       // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ¬Šé™
172:       const existing = await firstValueFrom(this.branchPermissionRepository.findByBranchAndAccount(branchId, accountId));
173: 
174:       if (existing) {
175:         // æ›´æ–°ç¾æœ‰æ¬Šé™
176:         const updated = await firstValueFrom(
177:           this.branchPermissionRepository.updatePermissionLevel(existing.id, permissionLevel, grantedBy)
178:         );
179:         // æ›´æ–°æœ¬åœ°ç‹€æ…‹
180:         this.permissionsState.update(permissions => permissions.map(p => (p.id === existing.id ? updated : p)));
181:         return updated;
182:       }
183: 
184:       // å‰µå»ºæ–°æ¬Šé™
185:       const permission = await firstValueFrom(
186:         this.branchPermissionRepository.grantPermission(branchId, accountId, permissionLevel, grantedBy)
187:       );
188:       // æ›´æ–°æœ¬åœ°ç‹€æ…‹
189:       this.permissionsState.update(permissions => [...permissions, permission]);
190:       return permission;
191:     } catch (error) {
192:       const errorMessage = error instanceof Error ? error.message : 'æˆäºˆæƒé™å¤±è´¥';
193:       this.errorState.set(errorMessage);
194:       throw error;
195:     } finally {
196:       this.loadingState.set(false);
197:     }
198:   }
199: 
200:   /**
201:    * æ›´æ–°æ¬Šé™ç´šåˆ¥
202:    *
203:    * @param id æ¬Šé™ ID
204:    * @param permissionLevel æ–°çš„æ¬Šé™ç´šåˆ¥
205:    * @param grantedBy æ›´æ–°è€… ID
206:    * @returns æ›´æ–°çš„æ¬Šé™è¨˜éŒ„
207:    */
208:   async updatePermissionLevel(id: string, permissionLevel: BranchPermissionLevel, grantedBy: string): Promise<BranchPermission> {
209:     this.loadingState.set(true);
210:     this.errorState.set(null);
211: 
212:     try {
213:       const permission = await firstValueFrom(this.branchPermissionRepository.updatePermissionLevel(id, permissionLevel, grantedBy));
214:       // æ›´æ–°æœ¬åœ°ç‹€æ…‹
215:       this.permissionsState.update(permissions => permissions.map(p => (p.id === id ? permission : p)));
216:       return permission;
217:     } catch (error) {
218:       const errorMessage = error instanceof Error ? error.message : 'æ›´æ–°æƒé™å¤±è´¥';
219:       this.errorState.set(errorMessage);
220:       throw error;
221:     } finally {
222:       this.loadingState.set(false);
223:     }
224:   }
225: 
226:   /**
227:    * æ’¤éŠ·æ¬Šé™
228:    *
229:    * @param branchId åˆ†æ”¯ ID
230:    * @param accountId è³¬æˆ¶ ID
231:    */
232:   async revokePermission(branchId: string, accountId: string): Promise<void> {
233:     this.loadingState.set(true);
234:     this.errorState.set(null);
235: 
236:     try {
237:       await firstValueFrom(this.branchPermissionRepository.revokePermission(branchId, accountId));
238:       // æ›´æ–°æœ¬åœ°ç‹€æ…‹
239:       this.permissionsState.update(permissions => permissions.filter(p => !(p.branch_id === branchId && p.account_id === accountId)));
240:     } catch (error) {
241:       const errorMessage = error instanceof Error ? error.message : 'æ’¤é”€æƒé™å¤±è´¥';
242:       this.errorState.set(errorMessage);
243:       throw error;
244:     } finally {
245:       this.loadingState.set(false);
246:     }
247:   }
248: 
249:   /**
250:    * æª¢æŸ¥æ˜¯å¦æ˜¯åˆ†æ”¯æ“æœ‰è€…
251:    *
252:    * @param branchId åˆ†æ”¯ ID
253:    * @param accountId è³¬æˆ¶ ID
254:    * @returns æ˜¯å¦æ˜¯æ“æœ‰è€…
255:    */
256:   async isOwner(branchId: string, accountId: string): Promise<boolean> {
257:     const permissionLevel = await this.getPermissionLevel(branchId, accountId);
258:     return permissionLevel === BranchPermissionLevel.OWNER;
259:   }
260: 
261:   /**
262:    * æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹ä»»å‹™çµæ§‹ï¼ˆåªæœ‰æ“æœ‰è€…å¯ä»¥ï¼‰
263:    *
264:    * @param branchId åˆ†æ”¯ ID
265:    * @param accountId è³¬æˆ¶ ID
266:    * @returns æ˜¯å¦å¯ä»¥ä¿®æ”¹
267:    */
268:   async canModifyTaskStructure(branchId: string, accountId: string): Promise<boolean> {
269:     return await this.canPerformAction(branchId, accountId, 'modify_task_structure');
270:   }
271: 
272:   /**
273:    * æª¢æŸ¥æ˜¯å¦å¯ä»¥å¡«å¯«æ‰¿æ”¬æ¬„ä½ï¼ˆå”ä½œçµ„ç¹”å¯ä»¥ï¼‰
274:    *
275:    * @param branchId åˆ†æ”¯ ID
276:    * @param accountId è³¬æˆ¶ ID
277:    * @returns æ˜¯å¦å¯ä»¥å¡«å¯«
278:    */
279:   async canFillContractorFields(branchId: string, accountId: string): Promise<boolean> {
280:     return await this.canPerformAction(branchId, accountId, 'fill_contractor_fields');
281:   }
282: 
283:   /**
284:    * æª¢æŸ¥æ˜¯å¦å¯ä»¥å¯©æ ¸ PRï¼ˆæ“æœ‰è€…å’Œç®¡ç†å“¡å¯ä»¥ï¼‰
285:    *
286:    * @param branchId åˆ†æ”¯ ID
287:    * @param accountId è³¬æˆ¶ ID
288:    * @returns æ˜¯å¦å¯ä»¥å¯©æ ¸
289:    */
290:   async canReviewPR(branchId: string, accountId: string): Promise<boolean> {
291:     return await this.canPerformAction(branchId, accountId, 'review_pr');
292:   }
293: 
294:   /**
295:    * é‡ç½®ç‹€æ…‹
296:    */
297:   reset(): void {
298:     this.permissionsState.set([]);
299:     this.errorState.set(null);
300:   }
301: }
````

## File: src/app/shared/services/permission/index.ts
````typescript
 1: /**
 2:  * æ¬Šé™æœå‹™å°å‡º
 3:  *
 4:  * æä¾›æ¬Šé™ç³»çµ±ç›¸é—œçš„æœå‹™ï¼š
 5:  * - BranchPermissionService: åˆ†æ”¯æ¬Šé™ç®¡ç†
 6:  *
 7:  * @module shared/services/permission
 8:  */
 9: 
10: export * from './branch-permission.service';
````

## File: src/app/shared/services/supabase-adapter.service.ts
````typescript
 1: import { Injectable, inject } from '@angular/core';
 2: import { SupabaseService } from '@core';
 3: import { SupabaseClient } from '@supabase/supabase-js';
 4: 
 5: /**
 6:  * Supabase Adapter Service
 7:  *
 8:  * æä¾›çµ±ä¸€çš„ Supabase å®¢æˆ¶ç«¯ä»‹é¢çµ¦ shared æ¨¡çµ„ä½¿ç”¨
 9:  * ä½œç‚º core/SupabaseService çš„é©é…å™¨å±¤ï¼Œä¿æŒé—œæ³¨é»åˆ†é›¢
10:  *
11:  * æ­¤æœå‹™ç‚º singletonï¼Œä¸æš´éœ²ä»»ä½•çœŸå¯¦é‡‘é‘°
12:  * æ‰€æœ‰é…ç½®é€éç’°å¢ƒè®Šæ•¸ç®¡ç†
13:  *
14:  * @example
15:  * ```typescript
16:  * const adapter = inject(SupabaseAdapterService);
17:  * const { data, error } = await adapter.client
18:  *   .from('quality_checks')
19:  *   .select('*')
20:  *   .eq('id', id)
21:  *   .single();
22:  * ```
23:  */
24: @Injectable({
25:   providedIn: 'root'
26: })
27: export class SupabaseAdapterService {
28:   private supabaseService = inject(SupabaseService);
29: 
30:   /**
31:    * ç²å– Supabase å®¢æˆ¶ç«¯å¯¦ä¾‹
32:    * é€é core/SupabaseService æä¾›çš„å–®ä¾‹å®¢æˆ¶ç«¯
33:    */
34:   get client(): SupabaseClient {
35:     return this.supabaseService.client;
36:   }
37: 
38:   /**
39:    * åŸ·è¡Œè³‡æ–™åº«æŸ¥è©¢
40:    * æä¾› type-safe çš„æŸ¥è©¢ä»‹é¢
41:    *
42:    * @param table è³‡æ–™è¡¨åç¨±
43:    * @returns Supabase query builder
44:    */
45:   from(table: string) {
46:     return this.client.from(table);
47:   }
48: 
49:   /**
50:    * ç²å–èªè­‰ç‹€æ…‹
51:    */
52:   get auth() {
53:     return this.client.auth;
54:   }
55: 
56:   /**
57:    * ç²å–å„²å­˜æœå‹™
58:    */
59:   get storage() {
60:     return this.client.storage;
61:   }
62: 
63:   /**
64:    * ç²å–å³æ™‚è¨‚é–±æœå‹™
65:    */
66:   get realtime() {
67:     return this.client.realtime;
68:   }
69: }
````

## File: src/app/shared/services/task/index.ts
````typescript
1: /**
2:  * ä»»åŠ¡æœåŠ¡æ¨¡å—å¯¼å‡º
3:  *
4:  * @module shared/services/task
5:  */
6: 
7: export * from './task.service';
8: export * from './task-staging.service';
9: export * from './task-state-machine';
````

## File: src/app/shared/services/task/task-staging.service.ts
````typescript
  1: import { Injectable, inject, signal, computed } from '@angular/core';
  2: import { TaskStagingRepository, TaskStagingInsert, TaskStagingUpdate, TaskStaging } from '@core';
  3: import { firstValueFrom } from 'rxjs';
  4: 
  5: /**
  6:  * Task Staging Service
  7:  *
  8:  * ç®¡ç†ä»»å‹™æš«å­˜å€é‚è¼¯ï¼š
  9:  * - 48 å°æ™‚æš«å­˜æ©Ÿåˆ¶
 10:  * - æ’¤å›æ¢ä»¶é©—è­‰
 11:  * - è‡ªå‹•ç‹€æ…‹åŒæ­¥
 12:  *
 13:  * @example
 14:  * ```typescript
 15:  * const stagingService = inject(TaskStagingService);
 16:  *
 17:  * // æäº¤åˆ°æš«å­˜å€
 18:  * await stagingService.submitToStaging(taskId, accountId, data);
 19:  *
 20:  * // æª¢æŸ¥æ˜¯å¦å¯æ’¤å›
 21:  * const canWithdraw = await stagingService.canWithdraw(stagingId);
 22:  *
 23:  * // æ’¤å›æš«å­˜
 24:  * await stagingService.withdrawStaging(stagingId);
 25:  * ```
 26:  */
 27: @Injectable({
 28:   providedIn: 'root'
 29: })
 30: export class TaskStagingService {
 31:   private taskStagingRepository = inject(TaskStagingRepository);
 32: 
 33:   // Signals for state management
 34:   private stagingItemsState = signal<TaskStaging[]>([]);
 35:   private loadingState = signal<boolean>(false);
 36:   private errorState = signal<string | null>(null);
 37: 
 38:   // Readonly signals
 39:   readonly stagingItems = this.stagingItemsState.asReadonly();
 40:   readonly loading = this.loadingState.asReadonly();
 41:   readonly error = this.errorState.asReadonly();
 42: 
 43:   // Computed signals
 44:   readonly withdrawableItems = computed(() =>
 45:     this.stagingItems().filter(item => item.can_withdraw && this.isWithinWithdrawPeriod(item))
 46:   );
 47: 
 48:   readonly expiredItems = computed(() => this.stagingItems().filter(item => this.isExpired(item)));
 49: 
 50:   /**
 51:    * æäº¤ä»»å‹™åˆ°æš«å­˜å€
 52:    *
 53:    * @param taskId ä»»å‹™ ID
 54:    * @param submittedBy æäº¤è€… ID
 55:    * @param stagingData æš«å­˜æ•¸æ“š
 56:    * @param photos ç…§ç‰‡ï¼ˆå¯é¸ï¼‰
 57:    * @param notes å‚™è¨»ï¼ˆå¯é¸ï¼‰
 58:    * @returns å»ºç«‹çš„æš«å­˜è¨˜éŒ„
 59:    */
 60:   async submitToStaging(
 61:     taskId: string,
 62:     submittedBy: string,
 63:     stagingData: Record<string, any>,
 64:     photos?: Record<string, any>[],
 65:     notes?: string
 66:   ): Promise<TaskStaging> {
 67:     this.loadingState.set(true);
 68:     this.errorState.set(null);
 69: 
 70:     try {
 71:       // æª¢æŸ¥æ˜¯å¦å·²æœ‰æš«å­˜è¨˜éŒ„
 72:       const existing = await firstValueFrom(this.taskStagingRepository.findByTaskId(taskId));
 73:       if (existing.length > 0) {
 74:         throw new Error('ä»»å‹™å·²æœ‰æš«å­˜è¨˜éŒ„ï¼Œè«‹å…ˆè™•ç†ç¾æœ‰æš«å­˜');
 75:       }
 76: 
 77:       // è¨ˆç®—éæœŸæ™‚é–“ï¼ˆ48 å°æ™‚å¾Œï¼‰
 78:       const expiresAt = new Date();
 79:       expiresAt.setHours(expiresAt.getHours() + 48);
 80: 
 81:       const insertData: TaskStagingInsert = {
 82:         task_id: taskId,
 83:         submitted_by: submittedBy,
 84:         staging_data: stagingData,
 85:         photos: photos || [],
 86:         notes: notes || null,
 87:         can_withdraw: true,
 88:         expires_at: expiresAt.toISOString(),
 89:         submitted_at: new Date().toISOString()
 90:       };
 91: 
 92:       const staging = await firstValueFrom(this.taskStagingRepository.create(insertData));
 93: 
 94:       // æ›´æ–°æœ¬åœ°ç‹€æ…‹
 95:       this.stagingItemsState.update(items => [...items, staging]);
 96: 
 97:       return staging;
 98:     } catch (error) {
 99:       this.errorState.set(error instanceof Error ? error.message : 'æäº¤åˆ°æš«å­˜å€å¤±æ•—');
100:       throw error;
101:     } finally {
102:       this.loadingState.set(false);
103:     }
104:   }
105: 
106:   /**
107:    * æª¢æŸ¥æ˜¯å¦å¯ä»¥æ’¤å›
108:    *
109:    * @param stagingId æš«å­˜è¨˜éŒ„ ID
110:    * @returns æ˜¯å¦å¯æ’¤å›
111:    */
112:   async canWithdraw(stagingId: string): Promise<boolean> {
113:     try {
114:       const staging = await firstValueFrom(this.taskStagingRepository.findById(stagingId));
115:       if (!staging) {
116:         return false;
117:       }
118: 
119:       // æª¢æŸ¥ can_withdraw æ¨™è¨˜
120:       if (!staging.can_withdraw) {
121:         return false;
122:       }
123: 
124:       // æª¢æŸ¥æ˜¯å¦åœ¨ 48 å°æ™‚å…§
125:       if (!this.isWithinWithdrawPeriod(staging)) {
126:         return false;
127:       }
128: 
129:       // æª¢æŸ¥æ˜¯å¦å·²ç¢ºèª
130:       if (staging.confirmed_at) {
131:         return false;
132:       }
133: 
134:       // æª¢æŸ¥æ˜¯å¦å·²æ’¤å›
135:       if (staging.withdrawn_at) {
136:         return false;
137:       }
138: 
139:       return true;
140:     } catch (error) {
141:       console.error('æª¢æŸ¥æ’¤å›æ¢ä»¶å¤±æ•—:', error);
142:       return false;
143:     }
144:   }
145: 
146:   /**
147:    * æ’¤å›æš«å­˜
148:    *
149:    * @param stagingId æš«å­˜è¨˜éŒ„ ID
150:    * @param accountId æ’¤å›è€… IDï¼ˆç”¨æ–¼æ¬Šé™æª¢æŸ¥ï¼‰
151:    * @returns æ›´æ–°å¾Œçš„æš«å­˜è¨˜éŒ„
152:    */
153:   async withdrawStaging(stagingId: string, accountId: string): Promise<TaskStaging> {
154:     this.loadingState.set(true);
155:     this.errorState.set(null);
156: 
157:     try {
158:       // æª¢æŸ¥æ˜¯å¦å¯æ’¤å›
159:       const canWithdrawResult = await this.canWithdraw(stagingId);
160:       if (!canWithdrawResult) {
161:         throw new Error('ç„¡æ³•æ’¤å›ï¼šå·²è¶…é 48 å°æ™‚æˆ–å·²ç¢ºèª/å·²æ’¤å›');
162:       }
163: 
164:       // æª¢æŸ¥æ¬Šé™ï¼šåªæœ‰æäº¤è€…å¯ä»¥æ’¤å›
165:       const staging = await firstValueFrom(this.taskStagingRepository.findById(stagingId));
166:       if (!staging) {
167:         throw new Error('æš«å­˜è¨˜éŒ„ä¸å­˜åœ¨');
168:       }
169: 
170:       if (staging.submitted_by !== accountId) {
171:         throw new Error('ç„¡æ¬Šæ’¤å›ï¼šåªæœ‰æäº¤è€…å¯ä»¥æ’¤å›');
172:       }
173: 
174:       // æ›´æ–°æš«å­˜è¨˜éŒ„
175:       const updateData: TaskStagingUpdate = {
176:         withdrawn_at: new Date().toISOString(),
177:         can_withdraw: false
178:       };
179: 
180:       const updated = await firstValueFrom(this.taskStagingRepository.update(stagingId, updateData));
181: 
182:       // æ›´æ–°æœ¬åœ°ç‹€æ…‹
183:       this.stagingItemsState.update(items => items.map(item => (item.id === stagingId ? updated : item)));
184: 
185:       return updated;
186:     } catch (error) {
187:       this.errorState.set(error instanceof Error ? error.message : 'æ’¤å›æš«å­˜å¤±æ•—');
188:       throw error;
189:     } finally {
190:       this.loadingState.set(false);
191:     }
192:   }
193: 
194:   /**
195:    * ç¢ºèªæš«å­˜ï¼ˆå®Œæˆå“æª¢ï¼Œç„¡æ³•æ’¤å›ï¼‰
196:    *
197:    * @param stagingId æš«å­˜è¨˜éŒ„ ID
198:    * @param confirmedBy ç¢ºèªè€… ID
199:    * @returns æ›´æ–°å¾Œçš„æš«å­˜è¨˜éŒ„
200:    */
201:   async confirmStaging(stagingId: string): Promise<TaskStaging> {
202:     this.loadingState.set(true);
203:     this.errorState.set(null);
204: 
205:     try {
206:       const updateData: TaskStagingUpdate = {
207:         confirmed_at: new Date().toISOString(),
208:         can_withdraw: false
209:       };
210: 
211:       const updated = await firstValueFrom(this.taskStagingRepository.update(stagingId, updateData));
212: 
213:       // æ›´æ–°æœ¬åœ°ç‹€æ…‹
214:       this.stagingItemsState.update(items => items.map(item => (item.id === stagingId ? updated : item)));
215: 
216:       return updated;
217:     } catch (error) {
218:       this.errorState.set(error instanceof Error ? error.message : 'ç¢ºèªæš«å­˜å¤±æ•—');
219:       throw error;
220:     } finally {
221:       this.loadingState.set(false);
222:     }
223:   }
224: 
225:   /**
226:    * è¼‰å…¥ä»»å‹™çš„æš«å­˜è¨˜éŒ„
227:    *
228:    * @param taskId ä»»å‹™ ID
229:    */
230:   async loadStagingByTaskId(taskId: string): Promise<void> {
231:     this.loadingState.set(true);
232:     this.errorState.set(null);
233: 
234:     try {
235:       const items = await firstValueFrom(this.taskStagingRepository.findByTaskId(taskId));
236:       this.stagingItemsState.set(items);
237:     } catch (error) {
238:       this.errorState.set(error instanceof Error ? error.message : 'è¼‰å…¥æš«å­˜è¨˜éŒ„å¤±æ•—');
239:       throw error;
240:     } finally {
241:       this.loadingState.set(false);
242:     }
243:   }
244: 
245:   /**
246:    * è¼‰å…¥æäº¤è€…çš„æ‰€æœ‰æš«å­˜è¨˜éŒ„
247:    *
248:    * @param accountId å¸³è™Ÿ ID
249:    */
250:   async loadStagingBySubmitter(accountId: string): Promise<void> {
251:     this.loadingState.set(true);
252:     this.errorState.set(null);
253: 
254:     try {
255:       const items = await firstValueFrom(this.taskStagingRepository.findBySubmittedBy(accountId));
256:       this.stagingItemsState.set(items);
257:     } catch (error) {
258:       this.errorState.set(error instanceof Error ? error.message : 'è¼‰å…¥æš«å­˜è¨˜éŒ„å¤±æ•—');
259:       throw error;
260:     } finally {
261:       this.loadingState.set(false);
262:     }
263:   }
264: 
265:   /**
266:    * æª¢æŸ¥æš«å­˜æ˜¯å¦åœ¨æ’¤å›æœŸé™å…§ï¼ˆ48 å°æ™‚ï¼‰
267:    *
268:    * @param staging æš«å­˜è¨˜éŒ„
269:    * @returns æ˜¯å¦åœ¨æœŸé™å…§
270:    */
271:   private isWithinWithdrawPeriod(staging: TaskStaging): boolean {
272:     if (!staging.expires_at) {
273:       return false;
274:     }
275: 
276:     const expiresAt = new Date(staging.expires_at);
277:     const now = new Date();
278:     return now < expiresAt;
279:   }
280: 
281:   /**
282:    * æª¢æŸ¥æš«å­˜æ˜¯å¦å·²éæœŸ
283:    *
284:    * @param staging æš«å­˜è¨˜éŒ„
285:    * @returns æ˜¯å¦å·²éæœŸ
286:    */
287:   private isExpired(staging: TaskStaging): boolean {
288:     if (!staging.expires_at) {
289:       return false;
290:     }
291: 
292:     const expiresAt = new Date(staging.expires_at);
293:     const now = new Date();
294:     return now >= expiresAt;
295:   }
296: 
297:   /**
298:    * ç²å–æš«å­˜å‰©é¤˜æ™‚é–“ï¼ˆå°æ™‚ï¼‰
299:    *
300:    * @param staging æš«å­˜è¨˜éŒ„
301:    * @returns å‰©é¤˜å°æ™‚æ•¸
302:    */
303:   getRemainingHours(staging: TaskStaging): number {
304:     if (!staging.expires_at) {
305:       return 0;
306:     }
307: 
308:     const expiresAt = new Date(staging.expires_at);
309:     const now = new Date();
310:     const diffMs = expiresAt.getTime() - now.getTime();
311:     const diffHours = diffMs / (1000 * 60 * 60);
312: 
313:     return Math.max(0, Math.floor(diffHours));
314:   }
315: 
316:   /**
317:    * æ¸…é™¤éŒ¯èª¤ç‹€æ…‹
318:    */
319:   clearError(): void {
320:     this.errorState.set(null);
321:   }
322: }
````

## File: src/app/shared/services/task/task-state-machine.ts
````typescript
  1: /**
  2:  * Task State Machine
  3:  *
  4:  * å®šç¾©ä»»å‹™ç‹€æ…‹è½‰æ›è¦å‰‡å’Œé©—è­‰é‚è¼¯
  5:  * å¯¦ç¾ 8 ç¨®ç‹€æ…‹çš„æœ‰æ•ˆè½‰æ›è·¯å¾‘
  6:  *
  7:  * ç‹€æ…‹æµè½‰åœ–ï¼š
  8:  * pending â†’ assigned â†’ in_progress â†’ staging â†’ in_qa â†’ in_inspection â†’ completed
  9:  *                          â†“                      â†“           â†“
 10:  *                      cancelled              cancelled   cancelled
 11:  */
 12: 
 13: import { TaskStatus } from '@core';
 14: 
 15: /**
 16:  * ç‹€æ…‹è½‰æ›çµæœ
 17:  */
 18: export interface StateTransitionResult {
 19:   /** æ˜¯å¦å…è¨±è½‰æ› */
 20:   allowed: boolean;
 21:   /** éŒ¯èª¤è¨Šæ¯ï¼ˆå¦‚æœä¸å…è¨±ï¼‰ */
 22:   reason?: string;
 23:   /** è­¦å‘Šè¨Šæ¯ï¼ˆå…è¨±ä½†éœ€æ³¨æ„ï¼‰ */
 24:   warning?: string;
 25: }
 26: 
 27: /**
 28:  * ç‹€æ…‹è½‰æ›è¦å‰‡æ˜ å°„
 29:  * key: ç•¶å‰ç‹€æ…‹
 30:  * value: å…è¨±è½‰æ›åˆ°çš„ä¸‹ä¸€å€‹ç‹€æ…‹åˆ—è¡¨
 31:  */
 32: const STATE_TRANSITIONS: Record<TaskStatus, TaskStatus[]> = {
 33:   [TaskStatus.PENDING]: [TaskStatus.ASSIGNED, TaskStatus.CANCELLED],
 34:   [TaskStatus.ASSIGNED]: [TaskStatus.IN_PROGRESS, TaskStatus.PENDING, TaskStatus.CANCELLED],
 35:   [TaskStatus.IN_PROGRESS]: [TaskStatus.STAGING, TaskStatus.ASSIGNED, TaskStatus.CANCELLED],
 36:   [TaskStatus.STAGING]: [TaskStatus.IN_QA, TaskStatus.IN_PROGRESS, TaskStatus.CANCELLED],
 37:   [TaskStatus.IN_QA]: [TaskStatus.IN_INSPECTION, TaskStatus.STAGING, TaskStatus.CANCELLED],
 38:   [TaskStatus.IN_INSPECTION]: [TaskStatus.COMPLETED, TaskStatus.IN_QA, TaskStatus.CANCELLED],
 39:   [TaskStatus.COMPLETED]: [], // å·²å®Œæˆä¸å¯è½‰æ›
 40:   [TaskStatus.CANCELLED]: [] // å·²å–æ¶ˆä¸å¯è½‰æ›
 41: };
 42: 
 43: /**
 44:  * æª¢æŸ¥ç‹€æ…‹è½‰æ›æ˜¯å¦æœ‰æ•ˆ
 45:  *
 46:  * @param fromStatus ç•¶å‰ç‹€æ…‹
 47:  * @param toStatus ç›®æ¨™ç‹€æ…‹
 48:  * @returns è½‰æ›çµæœ
 49:  */
 50: export function validateStateTransition(fromStatus: TaskStatus, toStatus: TaskStatus): StateTransitionResult {
 51:   // ç›¸åŒç‹€æ…‹ä¸éœ€è¦è½‰æ›
 52:   if (fromStatus === toStatus) {
 53:     return {
 54:       allowed: true,
 55:       warning: 'ç‹€æ…‹æœªæ”¹è®Š'
 56:     };
 57:   }
 58: 
 59:   // æª¢æŸ¥è½‰æ›æ˜¯å¦åœ¨å…è¨±åˆ—è¡¨ä¸­
 60:   const allowedTransitions = STATE_TRANSITIONS[fromStatus] || [];
 61:   const isAllowed = allowedTransitions.includes(toStatus);
 62: 
 63:   if (!isAllowed) {
 64:     return {
 65:       allowed: false,
 66:       reason: `ä¸å…è¨±å¾ ${fromStatus} è½‰æ›åˆ° ${toStatus}ã€‚å…è¨±çš„è½‰æ›ï¼š${allowedTransitions.join(', ')}`
 67:     };
 68:   }
 69: 
 70:   // ç‰¹æ®Šæƒ…æ³è­¦å‘Š
 71:   let warning: string | undefined;
 72: 
 73:   // å›é€€è­¦å‘Š
 74:   if (isRollbackTransition(fromStatus, toStatus)) {
 75:     warning = 'é€™æ˜¯å›é€€æ“ä½œï¼Œè«‹ç¢ºèªæ˜¯å¦æ­£ç¢º';
 76:   }
 77: 
 78:   // è·³ééšæ®µè­¦å‘Š
 79:   if (isSkippingStages(fromStatus, toStatus)) {
 80:     warning = 'è·³éäº†æŸäº›éšæ®µï¼Œè«‹ç¢ºèªæµç¨‹æ­£ç¢º';
 81:   }
 82: 
 83:   return {
 84:     allowed: true,
 85:     warning
 86:   };
 87: }
 88: 
 89: /**
 90:  * æª¢æŸ¥æ˜¯å¦ç‚ºå›é€€æ“ä½œ
 91:  */
 92: function isRollbackTransition(fromStatus: TaskStatus, toStatus: TaskStatus): boolean {
 93:   const progressOrder = [
 94:     TaskStatus.PENDING,
 95:     TaskStatus.ASSIGNED,
 96:     TaskStatus.IN_PROGRESS,
 97:     TaskStatus.STAGING,
 98:     TaskStatus.IN_QA,
 99:     TaskStatus.IN_INSPECTION,
100:     TaskStatus.COMPLETED
101:   ];
102: 
103:   const fromIndex = progressOrder.indexOf(fromStatus);
104:   const toIndex = progressOrder.indexOf(toStatus);
105: 
106:   return fromIndex > toIndex && fromIndex !== -1 && toIndex !== -1;
107: }
108: 
109: /**
110:  * æª¢æŸ¥æ˜¯å¦è·³éäº†éšæ®µ
111:  */
112: function isSkippingStages(fromStatus: TaskStatus, toStatus: TaskStatus): boolean {
113:   const progressOrder = [
114:     TaskStatus.PENDING,
115:     TaskStatus.ASSIGNED,
116:     TaskStatus.IN_PROGRESS,
117:     TaskStatus.STAGING,
118:     TaskStatus.IN_QA,
119:     TaskStatus.IN_INSPECTION,
120:     TaskStatus.COMPLETED
121:   ];
122: 
123:   const fromIndex = progressOrder.indexOf(fromStatus);
124:   const toIndex = progressOrder.indexOf(toStatus);
125: 
126:   // å¦‚æœè·³éè¶…é1å€‹éšæ®µï¼Œè¦–ç‚ºè·³é
127:   return toIndex - fromIndex > 1 && fromIndex !== -1 && toIndex !== -1;
128: }
129: 
130: /**
131:  * ç²å–ç‹€æ…‹çš„æ‰€æœ‰å…è¨±è½‰æ›
132:  */
133: export function getAllowedTransitions(status: TaskStatus): TaskStatus[] {
134:   return STATE_TRANSITIONS[status] || [];
135: }
136: 
137: /**
138:  * ç²å–ä¸‹ä¸€å€‹æ¨è–¦ç‹€æ…‹ï¼ˆæ­£å¸¸æµç¨‹ï¼‰
139:  */
140: export function getNextStatus(currentStatus: TaskStatus): TaskStatus | null {
141:   const statusOrder: Record<TaskStatus, TaskStatus | null> = {
142:     [TaskStatus.PENDING]: TaskStatus.ASSIGNED,
143:     [TaskStatus.ASSIGNED]: TaskStatus.IN_PROGRESS,
144:     [TaskStatus.IN_PROGRESS]: TaskStatus.STAGING,
145:     [TaskStatus.STAGING]: TaskStatus.IN_QA,
146:     [TaskStatus.IN_QA]: TaskStatus.IN_INSPECTION,
147:     [TaskStatus.IN_INSPECTION]: TaskStatus.COMPLETED,
148:     [TaskStatus.COMPLETED]: null,
149:     [TaskStatus.CANCELLED]: null
150:   };
151: 
152:   return statusOrder[currentStatus];
153: }
154: 
155: /**
156:  * æª¢æŸ¥ç‹€æ…‹æ˜¯å¦ç‚ºçµ‚æ­¢ç‹€æ…‹
157:  */
158: export function isFinalStatus(status: TaskStatus): boolean {
159:   return status === TaskStatus.COMPLETED || status === TaskStatus.CANCELLED;
160: }
161: 
162: /**
163:  * æª¢æŸ¥ç‹€æ…‹æ˜¯å¦å¯ä»¥æ’¤å›ï¼ˆè™•æ–¼ staging éšæ®µï¼‰
164:  */
165: export function isWithdrawableStatus(status: TaskStatus): boolean {
166:   return status === TaskStatus.STAGING;
167: }
````

## File: src/app/shared/services/task/task.service.ts
````typescript
  1: import { Injectable, inject, signal, computed } from '@angular/core';
  2: import { TaskRepository, TaskInsert, TaskUpdate, TaskAssignmentRepository, TaskListRepository } from '@core';
  3: import { Task, TaskStatus, TaskPriority, TaskDetail, TaskTreeNode } from '@shared';
  4: import { firstValueFrom } from 'rxjs';
  5: import {
  6:   validateStateTransition,
  7:   getAllowedTransitions,
  8:   getNextStatus,
  9:   isFinalStatus,
 10:   isWithdrawableStatus
 11: } from './task-state-machine';
 12: 
 13: /**
 14:  * Task Service
 15:  *
 16:  * æä¾›ä»»åŠ¡ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†
 17:  * ä½¿ç”¨ Signals ç®¡ç†çŠ¶æ€ï¼Œæš´éœ² ReadonlySignal ç»™ç»„ä»¶
 18:  *
 19:  * @example
 20:  * ```typescript
 21:  * const taskService = inject(TaskService);
 22:  *
 23:  * // è®¢é˜…ä»»åŠ¡åˆ—è¡¨
 24:  * effect(() => {
 25:  *   console.log('Tasks:', taskService.tasks());
 26:  * });
 27:  *
 28:  * // åŠ è½½ä»»åŠ¡åˆ—è¡¨
 29:  * await taskService.loadTasksByBlueprint('blueprint-id');
 30:  * ```
 31:  */
 32: @Injectable({
 33:   providedIn: 'root'
 34: })
 35: export class TaskService {
 36:   private taskRepository = inject(TaskRepository);
 37:   private taskAssignmentRepository = inject(TaskAssignmentRepository);
 38:   private taskListRepository = inject(TaskListRepository);
 39: 
 40:   // ä½¿ç”¨ Signals ç®¡ç†çŠ¶æ€
 41:   private tasksState = signal<Task[]>([]);
 42:   private selectedTaskState = signal<Task | null>(null);
 43:   private taskTreeState = signal<TaskTreeNode[]>([]);
 44:   private loadingState = signal<boolean>(false);
 45:   private errorState = signal<string | null>(null);
 46: 
 47:   // æš´éœ² ReadonlySignal ç»™ç»„ä»¶
 48:   readonly tasks = this.tasksState.asReadonly();
 49:   readonly selectedTask = this.selectedTaskState.asReadonly();
 50:   readonly taskTree = this.taskTreeState.asReadonly();
 51:   readonly loading = this.loadingState.asReadonly();
 52:   readonly error = this.errorState.asReadonly();
 53: 
 54:   // Computed signals
 55:   readonly pendingTasks = computed(() => this.tasks().filter(t => t.status === TaskStatus.PENDING));
 56: 
 57:   readonly inProgressTasks = computed(() => this.tasks().filter(t => t.status === TaskStatus.IN_PROGRESS));
 58: 
 59:   readonly completedTasks = computed(() => this.tasks().filter(t => t.status === TaskStatus.COMPLETED));
 60: 
 61:   readonly stagingTasks = computed(() => this.tasks().filter(t => t.status === TaskStatus.STAGING));
 62: 
 63:   readonly highPriorityTasks = computed(() =>
 64:     this.tasks().filter(t => t.priority === TaskPriority.HIGH || t.priority === TaskPriority.URGENT)
 65:   );
 66: 
 67:   /**
 68:    * åŠ è½½æ‰€æœ‰ä»»åŠ¡ï¼ˆæŒ‰è“å›¾ï¼‰
 69:    */
 70:   async loadTasksByBlueprint(blueprintId: string): Promise<void> {
 71:     this.loadingState.set(true);
 72:     this.errorState.set(null);
 73: 
 74:     try {
 75:       const tasks = await firstValueFrom(this.taskRepository.findByBlueprintId(blueprintId));
 76:       this.tasksState.set(tasks);
 77:     } catch (error) {
 78:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥');
 79:       throw error;
 80:     } finally {
 81:       this.loadingState.set(false);
 82:     }
 83:   }
 84: 
 85:   /**
 86:    * æ ¹æ® ID åŠ è½½ä»»åŠ¡è¯¦æƒ…
 87:    */
 88:   async loadTaskById(id: string): Promise<TaskDetail | null> {
 89:     this.loadingState.set(true);
 90:     this.errorState.set(null);
 91: 
 92:     try {
 93:       const task = await firstValueFrom(this.taskRepository.findById(id));
 94:       if (!task) {
 95:         this.selectedTaskState.set(null);
 96:         return null;
 97:       }
 98: 
 99:       // åŠ è½½å…³è”æ•°æ®
100:       // æ³¨æ„ï¼šBaseRepositoryä¼šè‡ªåŠ¨è½¬æ¢snake_caseåˆ°camelCaseï¼Œæ‰€ä»¥è¿è¡Œæ—¶task.parentTaskIdå­˜åœ¨
101:       const taskData = task as any;
102:       const [assignments, children, parent] = await Promise.all([
103:         firstValueFrom(this.taskAssignmentRepository.findByTaskId(id)),
104:         firstValueFrom(this.taskRepository.findChildren(id)),
105:         taskData.parentTaskId ? firstValueFrom(this.taskRepository.findById(taskData.parentTaskId)) : Promise.resolve(null)
106:       ]);
107: 
108:       const taskDetail: TaskDetail = {
109:         ...task,
110:         assignments: assignments.map(a => ({
111:           ...a,
112:           assignee: undefined, // TODO: åŠ è½½æŒ‡æ´¾å¯¹è±¡ä¿¡æ¯
113:           assignedBy: undefined // TODO: åŠ è½½æŒ‡æ´¾è€…ä¿¡æ¯
114:         })),
115:         children,
116:         parent: parent || undefined
117:       };
118: 
119:       this.selectedTaskState.set(task);
120:       return taskDetail;
121:     } catch (error) {
122:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½ä»»åŠ¡å¤±è´¥');
123:       throw error;
124:     } finally {
125:       this.loadingState.set(false);
126:     }
127:   }
128: 
129:   /**
130:    * åˆ›å»ºä»»åŠ¡
131:    *
132:    * @param data ä»»åŠ¡æ•°æ®
133:    * @returns åˆ›å»ºçš„ä»»åŠ¡
134:    */
135:   async createTask(data: TaskInsert): Promise<Task> {
136:     this.loadingState.set(true);
137:     this.errorState.set(null);
138: 
139:     try {
140:       // TODO: è‡ªåŠ¨ç”Ÿæˆ tree_path å’Œ tree_level
141:       // å¦‚æœ parent_task_id å­˜åœ¨ï¼Œéœ€è¦è®¡ç®—è·¯å¾„
142:       const task = await firstValueFrom(this.taskRepository.create(data));
143: 
144:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
145:       this.tasksState.update(tasks => [...tasks, task]);
146: 
147:       return task;
148:     } catch (error) {
149:       this.errorState.set(error instanceof Error ? error.message : 'åˆ›å»ºä»»åŠ¡å¤±è´¥');
150:       throw error;
151:     } finally {
152:       this.loadingState.set(false);
153:     }
154:   }
155: 
156:   /**
157:    * æ›´æ–°ä»»åŠ¡
158:    *
159:    * @param id ä»»åŠ¡ ID
160:    * @param data æ›´æ–°æ•°æ®
161:    * @returns æ›´æ–°åçš„ä»»åŠ¡
162:    */
163:   async updateTask(id: string, data: TaskUpdate): Promise<Task> {
164:     this.loadingState.set(true);
165:     this.errorState.set(null);
166: 
167:     try {
168:       // å¦‚æœæ›´æ–°åŒ…å«ç‹€æ…‹è®Šæ›´ï¼Œå…ˆé©—è­‰
169:       if (data.status) {
170:         const currentTask = await firstValueFrom(this.taskRepository.findById(id));
171:         if (!currentTask) {
172:           throw new Error('ä»»å‹™ä¸å­˜åœ¨');
173:         }
174: 
175:         // ç¢ºä¿ status æ˜¯æœ‰æ•ˆçš„ TaskStatus
176:         const currentStatus = currentTask.status as TaskStatus;
177:         const newStatus = data.status as TaskStatus;
178:         await this.validateAndUpdateStatus(id, currentStatus, newStatus);
179:       }
180: 
181:       const task = await firstValueFrom(this.taskRepository.update(id, data));
182: 
183:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
184:       this.tasksState.update(tasks => tasks.map(t => (t.id === id ? task : t)));
185:       if (this.selectedTaskState()?.id === id) {
186:         this.selectedTaskState.set(task);
187:       }
188: 
189:       return task;
190:     } catch (error) {
191:       this.errorState.set(error instanceof Error ? error.message : 'æ›´æ–°ä»»åŠ¡å¤±è´¥');
192:       throw error;
193:     } finally {
194:       this.loadingState.set(false);
195:     }
196:   }
197: 
198:   /**
199:    * åˆ é™¤ä»»åŠ¡
200:    *
201:    * @param id ä»»åŠ¡ ID
202:    */
203:   async deleteTask(id: string): Promise<void> {
204:     this.loadingState.set(true);
205:     this.errorState.set(null);
206: 
207:     try {
208:       // TODO: æ£€æŸ¥æ˜¯å¦æœ‰å­ä»»åŠ¡ï¼Œå¦‚æœæœ‰éœ€è¦å¤„ç†
209:       await firstValueFrom(this.taskRepository.delete(id));
210: 
211:       // æ›´æ–°æœ¬åœ°çŠ¶æ€
212:       this.tasksState.update(tasks => tasks.filter(t => t.id !== id));
213:       if (this.selectedTaskState()?.id === id) {
214:         this.selectedTaskState.set(null);
215:       }
216:     } catch (error) {
217:       this.errorState.set(error instanceof Error ? error.message : 'åˆ é™¤ä»»åŠ¡å¤±è´¥');
218:       throw error;
219:     } finally {
220:       this.loadingState.set(false);
221:     }
222:   }
223: 
224:   /**
225:    * æ„å»ºä»»åŠ¡æ ‘
226:    *
227:    * @param tasks ä»»åŠ¡åˆ—è¡¨
228:    * @returns ä»»åŠ¡æ ‘èŠ‚ç‚¹æ•°ç»„
229:    */
230:   buildTaskTree(tasks: Task[]): TaskTreeNode[] {
231:     const taskMap = new Map<string, TaskTreeNode>();
232:     const rootTasks: TaskTreeNode[] = [];
233: 
234:     // åˆ›å»ºèŠ‚ç‚¹æ˜ å°„
235:     tasks.forEach(task => {
236:       taskMap.set(task.id, {
237:         ...task,
238:         children: [],
239:         expanded: false,
240:         loading: false
241:       });
242:     });
243: 
244:     // æ„å»ºæ ‘ç»“æ„
245:     // æ³¨æ„ï¼šBaseRepositoryä¼šè‡ªåŠ¨è½¬æ¢snake_caseåˆ°camelCaseï¼Œæ‰€ä»¥è¿è¡Œæ—¶task.parentTaskIdå­˜åœ¨
246:     tasks.forEach(task => {
247:       const node = taskMap.get(task.id)!;
248:       const taskData = task as any;
249:       const parentTaskId = taskData.parentTaskId;
250:       if (parentTaskId) {
251:         const parent = taskMap.get(parentTaskId);
252:         if (parent) {
253:           parent.children = parent.children || [];
254:           parent.children.push(node);
255:         }
256:       } else {
257:         rootTasks.push(node);
258:       }
259:     });
260: 
261:     return rootTasks;
262:   }
263: 
264:   /**
265:    * åŠ è½½ä»»åŠ¡æ ‘ï¼ˆæŒ‰è“å›¾ï¼‰
266:    */
267:   async loadTaskTree(blueprintId: string): Promise<void> {
268:     this.loadingState.set(true);
269:     this.errorState.set(null);
270: 
271:     try {
272:       const tasks = await firstValueFrom(this.taskRepository.findByBlueprintId(blueprintId));
273:       const tree = this.buildTaskTree(tasks);
274:       this.taskTreeState.set(tree);
275:       this.tasksState.set(tasks);
276:     } catch (error) {
277:       this.errorState.set(error instanceof Error ? error.message : 'åŠ è½½ä»»åŠ¡æ ‘å¤±è´¥');
278:       throw error;
279:     } finally {
280:       this.loadingState.set(false);
281:     }
282:   }
283: 
284:   /**
285:    * é€‰æ‹©ä»»åŠ¡
286:    */
287:   selectTask(task: Task | null): void {
288:     this.selectedTaskState.set(task);
289:   }
290: 
291:   /**
292:    * æ¸…é™¤é”™è¯¯çŠ¶æ€
293:    */
294:   clearError(): void {
295:     this.errorState.set(null);
296:   }
297: 
298:   /**
299:    * é©—è­‰ä¸¦æ›´æ–°ä»»å‹™ç‹€æ…‹
300:    *
301:    * @param taskId ä»»å‹™ ID
302:    * @param fromStatus ç•¶å‰ç‹€æ…‹
303:    * @param toStatus ç›®æ¨™ç‹€æ…‹
304:    */
305:   private async validateAndUpdateStatus(taskId: string, fromStatus: TaskStatus, toStatus: TaskStatus): Promise<void> {
306:     const validation = validateStateTransition(fromStatus, toStatus);
307: 
308:     if (!validation.allowed) {
309:       throw new Error(validation.reason || 'ä¸å…è¨±çš„ç‹€æ…‹è½‰æ›');
310:     }
311: 
312:     // å¦‚æœæœ‰è­¦å‘Šï¼Œå¯ä»¥è¨˜éŒ„æˆ–æç¤ºç”¨æˆ¶
313:     if (validation.warning) {
314:       console.warn(`ä»»å‹™ ${taskId} ç‹€æ…‹è½‰æ›è­¦å‘Š: ${validation.warning}`);
315:     }
316:   }
317: 
318:   /**
319:    * æ›´æ–°ä»»å‹™ç‹€æ…‹ï¼ˆå«é©—è­‰ï¼‰
320:    *
321:    * @param taskId ä»»å‹™ ID
322:    * @param newStatus æ–°ç‹€æ…‹
323:    * @returns æ›´æ–°å¾Œçš„ä»»å‹™
324:    */
325:   async updateTaskStatus(taskId: string, newStatus: TaskStatus): Promise<Task> {
326:     this.loadingState.set(true);
327:     this.errorState.set(null);
328: 
329:     try {
330:       // ç²å–ç•¶å‰ä»»å‹™
331:       const currentTask = await firstValueFrom(this.taskRepository.findById(taskId));
332:       if (!currentTask) {
333:         throw new Error('ä»»å‹™ä¸å­˜åœ¨');
334:       }
335: 
336:       // ç¢ºä¿ status æ˜¯æœ‰æ•ˆçš„ TaskStatus
337:       const currentStatus = currentTask.status as TaskStatus;
338: 
339:       // é©—è­‰ç‹€æ…‹è½‰æ›
340:       await this.validateAndUpdateStatus(taskId, currentStatus, newStatus);
341: 
342:       // åŸ·è¡Œæ›´æ–°
343:       const task = await firstValueFrom(this.taskRepository.update(taskId, { status: newStatus }));
344: 
345:       // æ›´æ–°æœ¬åœ°ç‹€æ…‹
346:       this.tasksState.update(tasks => tasks.map(t => (t.id === taskId ? task : t)));
347:       if (this.selectedTaskState()?.id === taskId) {
348:         this.selectedTaskState.set(task);
349:       }
350: 
351:       return task;
352:     } catch (error) {
353:       this.errorState.set(error instanceof Error ? error.message : 'æ›´æ–°ä»»å‹™ç‹€æ…‹å¤±æ•—');
354:       throw error;
355:     } finally {
356:       this.loadingState.set(false);
357:     }
358:   }
359: 
360:   /**
361:    * ç²å–ä»»å‹™å…è¨±çš„ä¸‹ä¸€æ­¥ç‹€æ…‹
362:    *
363:    * @param taskId ä»»å‹™ ID
364:    * @returns å…è¨±çš„ç‹€æ…‹åˆ—è¡¨
365:    */
366:   async getAllowedNextStatuses(taskId: string): Promise<TaskStatus[]> {
367:     const task = await firstValueFrom(this.taskRepository.findById(taskId));
368:     if (!task) {
369:       return [];
370:     }
371: 
372:     const status = task.status as TaskStatus;
373:     return getAllowedTransitions(status);
374:   }
375: 
376:   /**
377:    * ç²å–ä»»å‹™çš„æ¨è–¦ä¸‹ä¸€æ­¥ç‹€æ…‹
378:    *
379:    * @param taskId ä»»å‹™ ID
380:    * @returns æ¨è–¦ç‹€æ…‹ï¼ˆå¦‚æœæœ‰ï¼‰
381:    */
382:   async getRecommendedNextStatus(taskId: string): Promise<TaskStatus | null> {
383:     const task = await firstValueFrom(this.taskRepository.findById(taskId));
384:     if (!task) {
385:       return null;
386:     }
387: 
388:     const status = task.status as TaskStatus;
389:     return getNextStatus(status);
390:   }
391: 
392:   /**
393:    * æª¢æŸ¥ä»»å‹™æ˜¯å¦è™•æ–¼çµ‚æ­¢ç‹€æ…‹
394:    *
395:    * @param taskId ä»»å‹™ ID
396:    * @returns æ˜¯å¦ç‚ºçµ‚æ­¢ç‹€æ…‹
397:    */
398:   async isTaskFinalized(taskId: string): Promise<boolean> {
399:     const task = await firstValueFrom(this.taskRepository.findById(taskId));
400:     if (!task) {
401:       return false;
402:     }
403: 
404:     const status = task.status as TaskStatus;
405:     return isFinalStatus(status);
406:   }
407: 
408:   /**
409:    * æª¢æŸ¥ä»»å‹™æ˜¯å¦å¯æ’¤å›ï¼ˆè™•æ–¼ staging ç‹€æ…‹ï¼‰
410:    *
411:    * @param taskId ä»»å‹™ ID
412:    * @returns æ˜¯å¦å¯æ’¤å›
413:    */
414:   async isTaskWithdrawable(taskId: string): Promise<boolean> {
415:     const task = await firstValueFrom(this.taskRepository.findById(taskId));
416:     if (!task) {
417:       return false;
418:     }
419: 
420:     const status = task.status as TaskStatus;
421:     return isWithdrawableStatus(status);
422:   }
423: }
````

## File: src/app/shared/services/todo/index.ts
````typescript
1: /**
2:  * å¾…è¾¦æœå‹™æ¨¡çµ„å°å‡º
3:  *
4:  * @module shared/services/todo
5:  */
6: 
7: export * from './personal-todo.service';
````

## File: src/app/shared/shared-imports.ts
````typescript
 1: // Angular Common ç®¡é“èˆ‡æŒ‡ä»¤ â€” https://angular.dev/guide/pipes
 2: import {
 3:   AsyncPipe,
 4:   CurrencyPipe,
 5:   DatePipe,
 6:   DecimalPipe,
 7:   I18nPluralPipe,
 8:   I18nSelectPipe,
 9:   JsonPipe,
10:   KeyValuePipe,
11:   LowerCasePipe,
12:   NgClass,
13:   NgComponentOutlet,
14:   NgStyle,
15:   NgTemplateOutlet,
16:   PercentPipe,
17:   SlicePipe,
18:   TitleCasePipe,
19:   UpperCasePipe
20: } from '@angular/common';
21: // è¡¨å–®æ¨¡çµ„ï¼ˆæ¨¡æ¿å¼ / éŸ¿æ‡‰å¼ï¼‰ â€” https://angular.dev/guide/forms
22: import { FormsModule, ReactiveFormsModule } from '@angular/forms';
23: // è·¯ç”±ï¼ˆRouterLink/RouterOutletï¼‰ â€” https://angular.dev/guide/routing
24: import { RouterOutlet, RouterLink } from '@angular/router';
25: // @delon/theme ç®¡é“ï¼ˆI18n/Dateï¼‰ â€” https://ng-alain.com/theme
26: // æ³¨æ„ï¼š@delon/theme çš„ DatePipe åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨ `_date` pipeï¼ŒAngular Common çš„ DatePipe ä½¿ç”¨ `date` pipe
27: import { DatePipe as DelonDatePipe, I18nPipe } from '@delon/theme';
28: 
29: import { SHARED_DELON_MODULES } from './shared-delon.module';
30: import { SHARED_ZORRO_MODULES } from './shared-zorro.module';
31: 
32: // Shared Components
33: import { AccountSelectorComponent } from './components/account-selector';
34: import { FormErrorComponent } from './components/form-error';
35: import { LoadingIndicatorComponent } from './components/loading-indicator';
36: import { EmptyStateComponent } from './components/empty-state';
37: import { PhotoGalleryComponent } from './components/photo-gallery';
38: import { TodoWidgetComponent } from './components/todo-widget';
39: import { CommentThreadComponent } from './components/comment-thread';
40: import { ChartWrapperComponent } from './components/chart-wrapper';
41: import { QcCameraComponent } from './components/qc-camera';
42: 
43: export const SHARED_IMPORTS = [
44:   // ========== Angular è¡¨å–®æ¨¡çµ„ ==========
45:   FormsModule, // æ¨¡æ¿å¼è¡¨å–® â€” https://angular.dev/guide/forms#template-driven-forms
46:   ReactiveFormsModule, // éŸ¿æ‡‰å¼è¡¨å–® â€” https://angular.dev/guide/forms#reactive-forms
47: 
48:   // ========== Angular è·¯ç”± ==========
49:   RouterLink, // è·¯ç”±é€£çµæŒ‡ä»¤ â€” https://angular.dev/guide/routing#routerlink
50:   RouterOutlet, // è·¯ç”±æ’åº§ â€” https://angular.dev/guide/routing#routeroutlet
51:   NgTemplateOutlet, // å‹•æ…‹åµŒå…¥æ¨¡æ¿ â€” https://angular.dev/api/common/NgTemplateOutlet
52:   NgComponentOutlet, // å‹•æ…‹çµ„ä»¶åµŒå…¥ â€” https://angular.dev/api/common/NgComponentOutlet
53: 
54:   // ========== Angular Common æ¨™æº–ç®¡é“ ==========
55:   DatePipe, // æ—¥æœŸæ ¼å¼åŒ–ï¼ˆæ¨¡æ¿ä½¿ç”¨: `{{ value | date }}`ï¼‰ â€” https://angular.dev/api/common/DatePipe
56:   CurrencyPipe, // è²¨å¹£æ ¼å¼åŒ–ï¼ˆæ¨¡æ¿ä½¿ç”¨: `{{ value | currency }}`ï¼‰ â€” https://angular.dev/api/common/CurrencyPipe
57:   DecimalPipe, // æ•¸å­—æ ¼å¼åŒ–ï¼ˆæ¨¡æ¿ä½¿ç”¨: `{{ value | number }}`ï¼‰ â€” https://angular.dev/api/common/DecimalPipe
58:   PercentPipe, // ç™¾åˆ†æ¯”æ ¼å¼åŒ–ï¼ˆæ¨¡æ¿ä½¿ç”¨: `{{ value | percent }}`ï¼‰ â€” https://angular.dev/api/common/PercentPipe
59:   LowerCasePipe, // è½‰å°å¯«ï¼ˆæ¨¡æ¿ä½¿ç”¨: `{{ value | lowercase }}`ï¼‰ â€” https://angular.dev/api/common/LowerCasePipe
60:   UpperCasePipe, // è½‰å¤§å¯«ï¼ˆæ¨¡æ¿ä½¿ç”¨: `{{ value | uppercase }}`ï¼‰ â€” https://angular.dev/api/common/UpperCasePipe
61:   TitleCasePipe, // æ¨™é¡Œå¤§å°å¯«ï¼ˆæ¨¡æ¿ä½¿ç”¨: `{{ value | titlecase }}`ï¼‰ â€” https://angular.dev/api/common/TitleCasePipe
62:   SlicePipe, // é™£åˆ—/å­—ä¸²åˆ‡ç‰‡ï¼ˆæ¨¡æ¿ä½¿ç”¨: `{{ value | slice:start:end }}`ï¼‰ â€” https://angular.dev/api/common/SlicePipe
63:   KeyValuePipe, // éµå€¼å°éæ­·ï¼ˆæ¨¡æ¿ä½¿ç”¨: `@for (item of obj | keyvalue)`ï¼‰ â€” https://angular.dev/api/common/KeyValuePipe
64:   JsonPipe, // ç‰©ä»¶è½‰ JSON å­—ä¸²ï¼ˆæ¨¡æ¿ä½¿ç”¨: `{{ value | json }}`ï¼‰ â€” https://angular.dev/api/common/JsonPipe
65:   AsyncPipe, // è§€å¯Ÿå€¼/Promise éåŒæ­¥è§£åŒ…ï¼ˆæ¨¡æ¿ä½¿ç”¨: `{{ value$ | async }}`ï¼‰ â€” https://angular.dev/api/common/AsyncPipe
66:   I18nPluralPipe, // è¤‡æ•¸å½¢å¼æ˜ å°„ï¼ˆæ¨¡æ¿ä½¿ç”¨: `{{ count | i18nPlural:mapping }}`ï¼‰ â€” https://angular.dev/api/common/I18nPluralPipe
67:   I18nSelectPipe, // éµå€¼æ˜ å°„é¸æ“‡ï¼ˆæ¨¡æ¿ä½¿ç”¨: `{{ value | i18nSelect:mapping }}`ï¼‰ â€” https://angular.dev/api/common/I18nSelectPipe
68:   NgClass, // å‹•æ…‹ CSS é¡ï¼ˆæ¨¡æ¿ä½¿ç”¨: `[ngClass]="..."`ï¼‰ â€” https://angular.dev/api/common/NgClass
69:   NgStyle, // å‹•æ…‹å…§è¯æ¨£å¼ï¼ˆæ¨¡æ¿ä½¿ç”¨: `[ngStyle]="..."`ï¼‰ â€” https://angular.dev/api/common/NgStyle
70: 
71:   // ========== @delon/theme ç®¡é“ ==========
72:   I18nPipe, // åœ‹éš›åŒ–ç¿»è­¯ç®¡é“ï¼ˆæ¨¡æ¿ä½¿ç”¨: `{{ key | i18n }}`ï¼‰ â€” https://ng-alain.com/theme
73:   DelonDatePipe, // @delon/theme æ—¥æœŸç®¡é“ï¼ˆæ¨¡æ¿ä½¿ç”¨: `{{ value | _date }}`ï¼‰ â€” https://ng-alain.com/theme
74: 
75:   // ========== @delon çµ„ä»¶/æŒ‡ä»¤é›†åˆ ==========
76:   // https://ng-alain.com/components
77:   ...SHARED_DELON_MODULES,
78: 
79:   // ========== ng-zorro-antd çµ„ä»¶é›†åˆ ==========
80:   // https://ng.ant.design/components/overview/zh
81:   ...SHARED_ZORRO_MODULES,
82: 
83:   // ========== Shared è‡ªè¨‚å…ƒä»¶ ==========
84:   // ä¼æ¥­ç´šå…±ç”¨å…ƒä»¶
85:   AccountSelectorComponent, // å¸³æˆ¶é¸æ“‡å™¨
86:   FormErrorComponent, // è¡¨å–®éŒ¯èª¤é¡¯ç¤º
87:   LoadingIndicatorComponent, // è¼‰å…¥æŒ‡ç¤ºå™¨
88:   EmptyStateComponent, // ç©ºç‹€æ…‹é¡¯ç¤º
89:   PhotoGalleryComponent, // ç…§ç‰‡ç•«å»Š (Lightbox + EXIF)
90:   TodoWidgetComponent, // å¾…è¾¦å°å·¥å…·
91:   CommentThreadComponent, // è¨è«–ä¸² (å·¢ç‹€ç•™è¨€ + @æåŠ)
92:   ChartWrapperComponent, // åœ–è¡¨å°è£å…ƒä»¶
93:   QcCameraComponent // å“ç®¡ç›¸æ©Ÿ (æ‹ç…§ + æ¨™è¨»)
94: ];
````

## File: src/app/core/infra/repositories/activity-log.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: 
 4: import { BaseRepository, QueryOptions } from './base.repository';
 5: import { Database } from '../types/database.types';
 6: 
 7: /**
 8:  * ActivityLog å¯¦é«”é¡å‹ï¼ˆcamelCaseï¼‰
 9:  * æ³¨æ„ï¼šBaseRepository æœƒè‡ªå‹•é€²è¡Œ snake_case â†’ camelCase è½‰æ›
10:  */
11: type ActivityLogRow = Database['public']['Tables']['activity_logs']['Row'];
12: type ActivityLogInsert = Database['public']['Tables']['activity_logs']['Insert'];
13: 
14: export type ActivityLog = ActivityLogRow;
15: export type { ActivityLogInsert };
16: 
17: /**
18:  * ActivityLog Repository
19:  *
20:  * æä¾›æ´»å‹•è¨˜éŒ„ç›¸é—œçš„è³‡æ–™å­˜å–æ–¹æ³•
21:  */
22: @Injectable({
23:   providedIn: 'root'
24: })
25: export class ActivityLogRepository extends BaseRepository<ActivityLog, ActivityLogInsert, never> {
26:   protected tableName = 'activity_logs';
27: 
28:   /**
29:    * æ ¹æ“šè—åœ– ID æŸ¥è©¢æ´»å‹•è¨˜éŒ„
30:    *
31:    * @param blueprintId è—åœ– ID
32:    * @param options æŸ¥è©¢é¸é …
33:    * @returns Observable<ActivityLog[]>
34:    */
35:   findByBlueprintId(blueprintId: string, options?: QueryOptions): Observable<ActivityLog[]> {
36:     return this.findAll({
37:       ...options,
38:       filters: {
39:         ...options?.filters,
40:         blueprintId // æœƒè‡ªå‹•è½‰æ›ç‚º blueprint_id
41:       },
42:       orderBy: 'created_at',
43:       orderDirection: 'desc'
44:     });
45:   }
46: 
47:   /**
48:    * æ ¹æ“šæ“ä½œè€… ID æŸ¥è©¢æ´»å‹•è¨˜éŒ„
49:    *
50:    * @param actorId æ“ä½œè€… ID
51:    * @param options æŸ¥è©¢é¸é …
52:    * @returns Observable<ActivityLog[]>
53:    */
54:   findByActorId(actorId: string, options?: QueryOptions): Observable<ActivityLog[]> {
55:     return this.findAll({
56:       ...options,
57:       filters: {
58:         ...options?.filters,
59:         actorId // æœƒè‡ªå‹•è½‰æ›ç‚º actor_id
60:       },
61:       orderBy: 'created_at',
62:       orderDirection: 'desc'
63:     });
64:   }
65: 
66:   /**
67:    * æ ¹æ“šè³‡æºé¡å‹å’Œ ID æŸ¥è©¢æ´»å‹•è¨˜éŒ„
68:    *
69:    * @param resourceType è³‡æºé¡å‹
70:    * @param resourceId è³‡æº ID
71:    * @param options æŸ¥è©¢é¸é …
72:    * @returns Observable<ActivityLog[]>
73:    */
74:   findByResource(resourceType: string, resourceId: string, options?: QueryOptions): Observable<ActivityLog[]> {
75:     return this.findAll({
76:       ...options,
77:       filters: {
78:         ...options?.filters,
79:         resourceType, // æœƒè‡ªå‹•è½‰æ›ç‚º resource_type
80:         resourceId // æœƒè‡ªå‹•è½‰æ›ç‚º resource_id
81:       },
82:       orderBy: 'created_at',
83:       orderDirection: 'desc'
84:     });
85:   }
86: }
````

## File: src/app/core/infra/repositories/inspection-photo.repository.ts
````typescript
 1: import { Injectable } from '@angular/core';
 2: import { Observable } from 'rxjs';
 3: 
 4: import { BaseRepository, QueryOptions } from './base.repository';
 5: import { Database } from '../types/database.types';
 6: 
 7: /**
 8:  * InspectionPhoto å®ä½“ç±»å‹ï¼ˆcamelCaseï¼‰
 9:  */
10: type InspectionPhotoRow = Database['public']['Tables']['inspection_photos']['Row'];
11: type InspectionPhotoInsert = Database['public']['Tables']['inspection_photos']['Insert'];
12: type InspectionPhotoUpdate = Database['public']['Tables']['inspection_photos']['Update'];
13: 
14: export type InspectionPhoto = InspectionPhotoRow;
15: export type { InspectionPhotoInsert, InspectionPhotoUpdate };
16: 
17: /**
18:  * InspectionPhoto Repository
19:  *
20:  * æä¾›éªŒæ”¶ç…§ç‰‡ç›¸å…³çš„æ•°æ®è®¿é—®æ–¹æ³•
21:  */
22: @Injectable({
23:   providedIn: 'root'
24: })
25: export class InspectionPhotoRepository extends BaseRepository<InspectionPhoto, InspectionPhotoInsert, InspectionPhotoUpdate> {
26:   protected tableName = 'inspection_photos';
27: 
28:   /**
29:    * æ ¹æ®éªŒæ”¶è®°å½• ID æŸ¥è¯¢ç…§ç‰‡
30:    *
31:    * @param inspectionId éªŒæ”¶è®°å½• ID
32:    * @param options æŸ¥è¯¢é€‰é¡¹
33:    * @returns Observable<InspectionPhoto[]>
34:    */
35:   findByInspectionId(inspectionId: string, options?: QueryOptions): Observable<InspectionPhoto[]> {
36:     return this.findAll({
37:       ...options,
38:       filters: {
39:         ...options?.filters,
40:         inspectionId // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º inspection_id
41:       },
42:       orderBy: 'sequence_order',
43:       orderDirection: 'asc'
44:     });
45:   }
46: 
47:   /**
48:    * æ ¹æ®ç…§ç‰‡ç±»å‹æŸ¥è¯¢
49:    *
50:    * @param photoType ç…§ç‰‡ç±»å‹
51:    * @param options æŸ¥è¯¢é€‰é¡¹
52:    * @returns Observable<InspectionPhoto[]>
53:    */
54:   findByPhotoType(photoType: string, options?: QueryOptions): Observable<InspectionPhoto[]> {
55:     return this.findAll({
56:       ...options,
57:       filters: {
58:         ...options?.filters,
59:         photoType // ä¼šè‡ªåŠ¨è½¬æ¢ä¸º photo_type
60:       },
61:       orderBy: 'uploaded_at',
62:       orderDirection: 'desc'
63:     });
64:   }
65: }
````

## File: src/app/routes/accounts/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: 
 3: import { BotListComponent } from './bots/bot-list.component';
 4: import { CreateBotComponent } from './create/create-bot.component';
 5: import { CreateOrganizationComponent } from './create/create-organization.component';
 6: import { AccountDetailComponent } from './detail/account-detail.component';
 7: import { AccountFormComponent } from './form/account-form.component';
 8: import { AccountListComponent } from './list/account-list.component';
 9: import { OrganizationListComponent } from './organizations/organization-list/organization-list.component';
10: import { ScheduleListComponent } from './schedules/schedule-list.component';
11: import { TeamCreateComponent } from './teams/team-create/team-create.component';
12: import { TeamDetailComponent } from './teams/team-detail/team-detail.component';
13: import { TeamEditComponent } from './teams/team-edit/team-edit.component';
14: import { TeamListComponent } from './teams/team-list/team-list.component';
15: import { UserListComponent } from './users/user-list.component';
16: 
17: export const routes: Routes = [
18:   { path: '', redirectTo: 'list', pathMatch: 'full' },
19:   { path: 'list', component: AccountListComponent },
20:   // åˆ›å»ºè·¯ç”±ï¼šæŒ‰è´¦æˆ·ç±»å‹åˆ†ç¦»
21:   // æ³¨æ„ï¼šUser è´¦æˆ·é€šè¿‡æ³¨å†Œæµç¨‹çš„è§¦å‘å™¨è‡ªåŠ¨åˆ›å»ºï¼Œä¸éœ€è¦æ‰‹åŠ¨åˆ›å»ºç»„ä»¶
22:   { path: 'create/organization', component: CreateOrganizationComponent },
23:   { path: 'create/bot', component: CreateBotComponent },
24:   // å…·ä½“è·¯å¾„å¿…é¡»æ”¾åœ¨åŠ¨æ€è·¯å¾„ï¼ˆ:idï¼‰ä¹‹å‰ï¼Œé¿å…è·¯ç”±å†²çª
25:   { path: 'users', component: UserListComponent },
26:   { path: 'organizations', component: OrganizationListComponent },
27:   { path: 'bots', component: BotListComponent },
28:   { path: 'teams/create', component: TeamCreateComponent },
29:   { path: 'teams', component: TeamListComponent },
30:   { path: 'teams/:id/edit', component: TeamEditComponent },
31:   { path: 'teams/:id', component: TeamDetailComponent },
32:   { path: 'schedules', component: ScheduleListComponent },
33:   // åŠ¨æ€è·¯å¾„æ”¾åœ¨æœ€å
34:   { path: ':id', component: AccountDetailComponent },
35:   { path: ':id/edit', component: AccountFormComponent }
36: ];
````

## File: src/app/routes/accounts/teams/team-list/team-list.component.ts
````typescript
  1: import { Component, OnInit, computed, inject, signal } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { STColumn } from '@delon/abc/st';
  4: import { AccountService, SHARED_IMPORTS, Team, TeamService } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: import { NzModalService } from 'ng-zorro-antd/modal';
  7: 
  8: import { TeamCreateComponent } from '../team-create/team-create.component';
  9: 
 10: @Component({
 11:   selector: 'app-team-list',
 12:   standalone: true,
 13:   imports: [SHARED_IMPORTS],
 14:   template: `
 15:     <page-header [title]="'å›¢é˜Ÿç®¡ç†'"></page-header>
 16: 
 17:     <div style="padding: 16px;">
 18:       <!-- ç»„ç»‡é€‰æ‹©å™¨å’Œæ–°å»ºå›¢é˜ŸæŒ‰é’® -->
 19:       <nz-card nzTitle="é€‰æ‹©ç»„ç»‡" style="margin-bottom: 16px;">
 20:         <nz-form-item>
 21:           <nz-form-label>ç»„ç»‡</nz-form-label>
 22:           <nz-form-control>
 23:             <div style="display: flex; gap: 8px; align-items: center;">
 24:               <nz-select
 25:                 [ngModel]="selectedOrganizationId()"
 26:                 (ngModelChange)="onOrganizationChange($event)"
 27:                 nzPlaceHolder="è¯·é€‰æ‹©ç»„ç»‡"
 28:                 [nzLoading]="accountService.loading()"
 29:                 style="width: 300px;"
 30:               >
 31:                 @for (org of accountService.organizationAccounts(); track org.id) {
 32:                   <nz-option [nzValue]="org.id" [nzLabel]="org.name"></nz-option>
 33:                 }
 34:               </nz-select>
 35:               <button nz-button nzType="primary" (click)="createTeam()">
 36:                 <span nz-icon nzType="plus"></span>
 37:                 æ–°å»ºå›¢é˜Ÿ
 38:               </button>
 39:             </div>
 40:           </nz-form-control>
 41:         </nz-form-item>
 42:         @if (!selectedOrganizationId()) {
 43:           <nz-alert
 44:             nzType="info"
 45:             nzMessage="è¯·å…ˆé€‰æ‹©ç»„ç»‡"
 46:             nzDescription="å›¢é˜Ÿæ˜¯ç»„ç»‡ä¸“æœ‰åŠŸèƒ½ï¼Œè¯·å…ˆé€‰æ‹©ä¸€ä¸ªç»„ç»‡ä»¥æŸ¥çœ‹è¯¥ç»„ç»‡çš„å›¢é˜Ÿã€‚"
 47:             nzShowIcon
 48:             style="margin-top: 16px;"
 49:           ></nz-alert>
 50:         }
 51:       </nz-card>
 52: 
 53:       <!-- å›¢é˜Ÿåˆ—è¡¨ -->
 54:       @if (selectedOrganizationId()) {
 55:         <nz-card [nzTitle]="'ç»„ç»‡å›¢é˜Ÿåˆ—è¡¨ï¼š' + selectedOrganizationName()">
 56:           <st
 57:             #st
 58:             [data]="teamService.teams()"
 59:             [columns]="columns"
 60:             [loading]="teamService.loading()"
 61:             [page]="{ front: false, show: true, showSize: true }"
 62:           >
 63:             <ng-template #description let-record>
 64:               {{ record.description || '-' }}
 65:             </ng-template>
 66:           </st>
 67:         </nz-card>
 68:       }
 69:     </div>
 70:   `
 71: })
 72: export class TeamListComponent implements OnInit {
 73:   teamService = inject(TeamService);
 74:   accountService = inject(AccountService);
 75:   router = inject(Router);
 76:   message = inject(NzMessageService);
 77:   private modal = inject(NzModalService);
 78: 
 79:   selectedOrganizationId = signal<string | null>(null);
 80: 
 81:   columns: STColumn[] = [
 82:     { title: 'ID', index: 'id', width: 100 },
 83:     { title: 'å›¢é˜Ÿåç§°', index: 'name', width: 200 },
 84:     { title: 'æè¿°', index: 'description', width: 300, render: 'description' },
 85:     { title: 'ç»„ç»‡ID', index: 'organization_id', width: 200 },
 86:     { title: 'åˆ›å»ºæ—¶é—´', index: 'created_at', type: 'date', width: 180 },
 87:     {
 88:       title: 'æ“ä½œ',
 89:       width: 100,
 90:       buttons: [
 91:         {
 92:           text: 'æŸ¥çœ‹è¯¦æƒ…',
 93:           click: (record: Team) => this.viewDetail(record.id)
 94:         }
 95:       ]
 96:     }
 97:   ];
 98: 
 99:   selectedOrganizationName = computed(() => {
100:     const orgId = this.selectedOrganizationId();
101:     if (!orgId) return '';
102:     const org = this.accountService.organizationAccounts().find(o => o.id === orgId);
103:     return org?.name || '';
104:   });
105: 
106:   ngOnInit(): void {
107:     // å…ˆåŠ è½½ç»„ç»‡åˆ—è¡¨
108:     this.loadOrganizations();
109:   }
110: 
111:   async loadOrganizations(): Promise<void> {
112:     try {
113:       await this.accountService.loadAccounts();
114:       // å¦‚æœåªæœ‰ä¸€ä¸ªç»„ç»‡ï¼Œè‡ªåŠ¨é€‰æ‹©
115:       const orgs = this.accountService.organizationAccounts();
116:       if (orgs.length === 1) {
117:         this.selectedOrganizationId.set(orgs[0].id);
118:         await this.loadTeams(orgs[0].id);
119:       }
120:     } catch (error) {
121:       console.error('åŠ è½½ç»„ç»‡åˆ—è¡¨å¤±è´¥:', error);
122:       this.message.error('åŠ è½½ç»„ç»‡åˆ—è¡¨å¤±è´¥');
123:     }
124:   }
125: 
126:   async onOrganizationChange(organizationId: string | null): Promise<void> {
127:     this.selectedOrganizationId.set(organizationId);
128:     if (organizationId) {
129:       await this.loadTeams(organizationId);
130:     }
131:     // å¦‚æœæ²¡æœ‰é€‰æ‹©ç»„ç»‡ï¼Œåˆ—è¡¨ä¼šé€šè¿‡ RLS ç­–ç•¥è‡ªåŠ¨è¿‡æ»¤ä¸ºç©º
132:   }
133: 
134:   async loadTeams(organizationId: string): Promise<void> {
135:     try {
136:       await this.teamService.loadTeamsByOrganizationId(organizationId);
137:     } catch (error) {
138:       const errorMessage = error instanceof Error ? error.message : 'åŠ è½½å›¢é˜Ÿåˆ—è¡¨å¤±è´¥';
139:       this.message.error(errorMessage);
140:     }
141:   }
142: 
143:   createTeam(): void {
144:     const orgId = this.selectedOrganizationId();
145: 
146:     const modalRef = this.modal.create({
147:       nzTitle: 'åˆ›å»ºå›¢é˜Ÿ',
148:       nzContent: TeamCreateComponent,
149:       nzData: {
150:         organizationId: orgId || null
151:       },
152:       nzWidth: 800,
153:       nzFooter: null
154:     });
155: 
156:     modalRef.afterClose.subscribe(result => {
157:       if (result) {
158:         // å¦‚æœåˆ›å»ºæˆåŠŸï¼Œåˆ·æ–°å›¢é˜Ÿåˆ—è¡¨
159:         if (orgId) {
160:           this.loadTeams(orgId);
161:         }
162:       }
163:     });
164:   }
165: 
166:   viewDetail(id: string): void {
167:     this.router.navigate(['/accounts/teams', id]);
168:   }
169: }
````

## File: src/app/routes/blueprints/branches/branch-detail.component.ts
````typescript
  1: import { Component, inject, signal, OnInit, computed } from '@angular/core';
  2: import { SHARED_IMPORTS, BranchService, BlueprintBranch } from '@shared';
  3: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
  4: 
  5: export interface BranchDetailData {
  6:   branchId: string;
  7: }
  8: 
  9: @Component({
 10:   selector: 'app-branch-detail',
 11:   standalone: true,
 12:   imports: [SHARED_IMPORTS],
 13:   template: `
 14:     @if (loading()) {
 15:       <div style="text-align: center; padding: 40px;">
 16:         <nz-spin nzSize="large"></nz-spin>
 17:       </div>
 18:     } @else if (branch()) {
 19:       <nz-descriptions nzBordered [nzColumn]="2">
 20:         <nz-descriptions-item nzTitle="åˆ†æ”¯ID" [nzSpan]="2">{{ branch()!.id }}</nz-descriptions-item>
 21:         <nz-descriptions-item nzTitle="åˆ†æ”¯åç§°" [nzSpan]="2">{{ branch()!.branch_name }}</nz-descriptions-item>
 22:         <nz-descriptions-item nzTitle="è“å›¾ID" [nzSpan]="1">{{ branch()!.blueprint_id }}</nz-descriptions-item>
 23:         <nz-descriptions-item nzTitle="ç»„ç»‡ID" [nzSpan]="1">{{ branch()!.organization_id }}</nz-descriptions-item>
 24:         <nz-descriptions-item nzTitle="åˆ†æ”¯ç±»å‹" [nzSpan]="1">
 25:           @switch (branch()!.branch_type) {
 26:             @case ('contractor') {
 27:               <nz-tag nzColor="blue">æ‰¿æ½å•†</nz-tag>
 28:             }
 29:             @case ('subcontractor') {
 30:               <nz-tag nzColor="cyan">æ¬¡æ‰¿æ½å•†</nz-tag>
 31:             }
 32:             @case ('consultant') {
 33:               <nz-tag nzColor="purple">é¡¾é—®</nz-tag>
 34:             }
 35:             @default {
 36:               <nz-tag>{{ branch()!.branch_type }}</nz-tag>
 37:             }
 38:           }
 39:         </nz-descriptions-item>
 40:         <nz-descriptions-item nzTitle="çŠ¶æ€" [nzSpan]="1">
 41:           @switch (branch()!.status) {
 42:             @case ('active') {
 43:               <nz-tag nzColor="green">æ´»è·ƒ</nz-tag>
 44:             }
 45:             @case ('closed') {
 46:               <nz-tag nzColor="default">å·²å…³é—­</nz-tag>
 47:             }
 48:             @case ('archived') {
 49:               <nz-tag nzColor="orange">å·²å½’æ¡£</nz-tag>
 50:             }
 51:             @default {
 52:               <nz-tag>{{ branch()!.status }}</nz-tag>
 53:             }
 54:           }
 55:         </nz-descriptions-item>
 56:         @if (branch()!.notes) {
 57:           <nz-descriptions-item nzTitle="å¤‡æ³¨" [nzSpan]="2">
 58:             <pre style="white-space: pre-wrap; margin: 0;">{{ branch()!.notes }}</pre>
 59:           </nz-descriptions-item>
 60:         }
 61:         <nz-descriptions-item nzTitle="åˆ›å»ºæ—¶é—´" [nzSpan]="1">
 62:           {{ branch()!.forked_at | date: 'yyyy-MM-dd HH:mm:ss' }}
 63:         </nz-descriptions-item>
 64:         @if (branch()!.last_sync_at) {
 65:           <nz-descriptions-item nzTitle="æœ€ååŒæ­¥æ—¶é—´" [nzSpan]="2">
 66:             {{ branch()!.last_sync_at | date: 'yyyy-MM-dd HH:mm:ss' }}
 67:           </nz-descriptions-item>
 68:         }
 69:       </nz-descriptions>
 70: 
 71:       <div style="margin-top: 16px; text-align: right;">
 72:         <button nz-button nzType="default" (click)="close()">å…³é—­</button>
 73:       </div>
 74:     } @else {
 75:       <nz-empty nzNotFoundContent="åˆ†æ”¯ä¸å­˜åœ¨"></nz-empty>
 76:     }
 77:   `
 78: })
 79: export class BranchDetailComponent implements OnInit {
 80:   private modalRef = inject(NzModalRef);
 81:   private branchService = inject(BranchService);
 82: 
 83:   readonly data: BranchDetailData = inject(NZ_MODAL_DATA);
 84:   readonly loading = signal(false);
 85:   readonly branch = signal<BlueprintBranch | null>(null);
 86: 
 87:   async ngOnInit(): Promise<void> {
 88:     await this.loadBranch();
 89:   }
 90: 
 91:   async loadBranch(): Promise<void> {
 92:     this.loading.set(true);
 93:     try {
 94:       const result = await this.branchService.loadBranchById(this.data.branchId);
 95:       this.branch.set(result);
 96:     } catch (error) {
 97:       console.error('åŠ è½½åˆ†æ”¯è¯¦æƒ…å¤±è´¥:', error);
 98:       this.branch.set(null);
 99:     } finally {
100:       this.loading.set(false);
101:     }
102:   }
103: 
104:   close(): void {
105:     this.modalRef.close();
106:   }
107: }
````

## File: src/app/routes/blueprints/pull-requests/detail/pull-request-detail.spec.ts
````typescript
 1: import { ComponentFixture, TestBed } from '@angular/core/testing';
 2: import { ActivatedRoute, Router } from '@angular/router';
 3: import { NzMessageService } from 'ng-zorro-antd/message';
 4: 
 5: import { PullRequestDetailComponent } from './pull-request-detail';
 6: 
 7: describe('PullRequestDetail', () => {
 8:   let component: PullRequestDetailComponent;
 9:   let fixture: ComponentFixture<PullRequestDetailComponent>;
10:   let mockRouter: jasmine.SpyObj<Router>;
11:   let mockActivatedRoute: Partial<ActivatedRoute>;
12:   let mockMessageService: jasmine.SpyObj<NzMessageService>;
13: 
14:   beforeEach(async () => {
15:     mockRouter = jasmine.createSpyObj('Router', ['navigate']);
16:     mockActivatedRoute = {
17:       snapshot: {
18:         paramMap: {
19:           get: jasmine.createSpy('get').and.returnValue(null)
20:         }
21:       } as unknown as ActivatedRoute['snapshot']
22:     };
23:     mockMessageService = jasmine.createSpyObj('NzMessageService', ['info', 'error', 'success']);
24: 
25:     await TestBed.configureTestingModule({
26:       imports: [PullRequestDetailComponent],
27:       providers: [
28:         { provide: Router, useValue: mockRouter },
29:         { provide: ActivatedRoute, useValue: mockActivatedRoute },
30:         { provide: NzMessageService, useValue: mockMessageService }
31:       ]
32:     }).compileComponents();
33: 
34:     fixture = TestBed.createComponent(PullRequestDetailComponent);
35:     component = fixture.componentInstance;
36:   });
37: 
38:   it('should create', () => {
39:     expect(component).toBeTruthy();
40:   });
41: 
42:   it('should initialize with loading state', () => {
43:     expect(component.loading()).toBe(true);
44:   });
45: 
46:   it('should load mock data on init when no id provided', done => {
47:     fixture.detectChanges();
48: 
49:     setTimeout(() => {
50:       expect(component.loading()).toBe(false);
51:       expect(component.pullRequest()).toBeTruthy();
52:       expect(component.activities().length).toBeGreaterThan(0);
53:       done();
54:     }, 1000);
55:   });
56: 
57:   it('should compute correct status color', done => {
58:     fixture.detectChanges();
59: 
60:     setTimeout(() => {
61:       expect(component.statusColor()).toBeTruthy();
62:       done();
63:     }, 1000);
64:   });
65: 
66:   it('should compute correct status text', done => {
67:     fixture.detectChanges();
68: 
69:     setTimeout(() => {
70:       expect(component.statusText()).toBeTruthy();
71:       done();
72:     }, 1000);
73:   });
74: 
75:   it('should navigate back when goBack is called', () => {
76:     component.goBack();
77:     expect(mockRouter.navigate).toHaveBeenCalledWith(['/blueprints/pull-requests']);
78:   });
79: 
80:   it('should show info message when merge is called', () => {
81:     component.merge();
82:     expect(mockMessageService.info).toHaveBeenCalledWith('åˆä½µåŠŸèƒ½å¾…å¯¦ä½œ');
83:   });
84: 
85:   it('should show info message when close is called', () => {
86:     component.close();
87:     expect(mockMessageService.info).toHaveBeenCalledWith('é—œé–‰åŠŸèƒ½å¾…å¯¦ä½œ');
88:   });
89: 
90:   it('should show info message when approve is called', () => {
91:     component.approve();
92:     expect(mockMessageService.info).toHaveBeenCalledWith('æ ¸å‡†åŠŸèƒ½å¾…å¯¦ä½œ');
93:   });
94: 
95:   it('should show info message when requestChanges is called', () => {
96:     component.requestChanges();
97:     expect(mockMessageService.info).toHaveBeenCalledWith('è«‹æ±‚è®Šæ›´åŠŸèƒ½å¾…å¯¦ä½œ');
98:   });
99: });
````

## File: src/app/routes/blueprints/pull-requests/detail/pull-request-detail.ts
````typescript
  1: import { ChangeDetectionStrategy, Component, OnInit, computed, inject, signal } from '@angular/core';
  2: import { ActivatedRoute, Router } from '@angular/router';
  3: import { SHARED_IMPORTS } from '@shared';
  4: import { NzMessageService } from 'ng-zorro-antd/message';
  5: 
  6: interface PullRequest {
  7:   readonly id: string;
  8:   readonly title: string;
  9:   readonly description: string;
 10:   readonly status: 'open' | 'merged' | 'closed';
 11:   readonly source_branch: string;
 12:   readonly target_branch: string;
 13:   readonly author: string;
 14:   readonly created_at: string;
 15:   readonly updated_at: string;
 16:   readonly reviewers?: string[];
 17: }
 18: 
 19: interface Activity {
 20:   readonly id: string;
 21:   readonly type: 'commit' | 'comment' | 'review' | 'status_change';
 22:   readonly title: string;
 23:   readonly description: string;
 24:   readonly author: string;
 25:   readonly timestamp: string;
 26:   readonly color: string;
 27: }
 28: 
 29: @Component({
 30:   selector: 'app-pull-request-detail',
 31:   standalone: true,
 32:   imports: [SHARED_IMPORTS],
 33:   templateUrl: './pull-request-detail.html',
 34:   styleUrl: './pull-request-detail.less',
 35:   changeDetection: ChangeDetectionStrategy.OnPush
 36: })
 37: export class PullRequestDetailComponent implements OnInit {
 38:   private route = inject(ActivatedRoute);
 39:   private router = inject(Router);
 40:   private message = inject(NzMessageService);
 41: 
 42:   // Signals for state management
 43:   loading = signal<boolean>(true);
 44:   pullRequest = signal<PullRequest | null>(null);
 45:   activities = signal<Activity[]>([]);
 46:   error = signal<string | null>(null);
 47: 
 48:   // Computed properties
 49:   statusColor = computed(() => {
 50:     const pr = this.pullRequest();
 51:     if (!pr) return 'default';
 52:     switch (pr.status) {
 53:       case 'open':
 54:         return 'processing';
 55:       case 'merged':
 56:         return 'success';
 57:       case 'closed':
 58:         return 'error';
 59:       default:
 60:         return 'default';
 61:     }
 62:   });
 63: 
 64:   statusText = computed(() => {
 65:     const pr = this.pullRequest();
 66:     if (!pr) return '';
 67:     switch (pr.status) {
 68:       case 'open':
 69:         return 'é€²è¡Œä¸­';
 70:       case 'merged':
 71:         return 'å·²åˆä½µ';
 72:       case 'closed':
 73:         return 'å·²é—œé–‰';
 74:       default:
 75:         return pr.status;
 76:     }
 77:   });
 78: 
 79:   ngOnInit(): void {
 80:     const prId = this.route.snapshot.paramMap.get('id');
 81:     if (prId) {
 82:       this.loadPullRequest(prId);
 83:     } else {
 84:       // Load with mock data for demonstration
 85:       this.loadMockData();
 86:     }
 87:   }
 88: 
 89:   private loadMockData(): void {
 90:     // Simulate API call delay
 91:     setTimeout(() => {
 92:       this.pullRequest.set({
 93:         id: 'pr-001',
 94:         title: 'æ–°å¢ä»»å‹™æŒ‡æ´¾åŠŸèƒ½',
 95:         description: 'å¯¦ä½œä»»å‹™æŒ‡æ´¾åŠŸèƒ½ï¼Œæ”¯æ´å¤šäººå”ä½œèˆ‡æ¬Šé™æ§åˆ¶',
 96:         status: 'open',
 97:         source_branch: 'feature/task-assignment',
 98:         target_branch: 'main',
 99:         author: 'Developer A',
100:         created_at: '2025-11-15 10:30:00',
101:         updated_at: '2025-11-16 14:20:00',
102:         reviewers: ['Reviewer B', 'Reviewer C']
103:       });
104: 
105:       this.activities.set([
106:         {
107:           id: 'act-1',
108:           type: 'commit',
109:           title: 'å»ºç«‹ Pull Request',
110:           description: 'ç”± Developer A å¾ feature/task-assignment åˆ†æ”¯å»ºç«‹',
111:           author: 'Developer A',
112:           timestamp: '2025-11-15 10:30:00',
113:           color: 'blue'
114:         },
115:         {
116:           id: 'act-2',
117:           type: 'review',
118:           title: 'è«‹æ±‚å¯©æŸ¥',
119:           description: 'æŒ‡æ´¾çµ¦ Reviewer B, Reviewer C é€²è¡Œå¯©æŸ¥',
120:           author: 'System',
121:           timestamp: '2025-11-15 10:32:00',
122:           color: 'purple'
123:         },
124:         {
125:           id: 'act-3',
126:           type: 'commit',
127:           title: 'æ–°å¢ 3 å€‹æäº¤',
128:           description: 'æ›´æ–°ä»»å‹™æŒ‡æ´¾é‚è¼¯èˆ‡æ¸¬è©¦',
129:           author: 'Developer A',
130:           timestamp: '2025-11-16 09:15:00',
131:           color: 'green'
132:         },
133:         {
134:           id: 'act-4',
135:           type: 'comment',
136:           title: 'Reviewer B è©•è«–',
137:           description: 'å»ºè­°å„ªåŒ–æ¬Šé™æª¢æŸ¥é‚è¼¯',
138:           author: 'Reviewer B',
139:           timestamp: '2025-11-16 11:45:00',
140:           color: 'orange'
141:         },
142:         {
143:           id: 'act-5',
144:           type: 'commit',
145:           title: 'ä¿®æ­£å¯©æŸ¥æ„è¦‹',
146:           description: 'å„ªåŒ–æ¬Šé™æª¢æŸ¥èˆ‡éŒ¯èª¤è™•ç†',
147:           author: 'Developer A',
148:           timestamp: '2025-11-16 14:20:00',
149:           color: 'green'
150:         }
151:       ]);
152: 
153:       this.loading.set(false);
154:     }, 800);
155:   }
156: 
157:   private async loadPullRequest(_id: string): Promise<void> {
158:     try {
159:       this.loading.set(true);
160:       this.error.set(null);
161: 
162:       // TODO: Replace with actual API call
163:       // const data = await this.pullRequestService.getById(id);
164:       // this.pullRequest.set(data);
165: 
166:       // For now, load mock data
167:       this.loadMockData();
168:     } catch {
169:       this.error.set('è¼‰å…¥ Pull Request è©³æƒ…å¤±æ•—');
170:       this.message.error('è¼‰å…¥å¤±æ•—');
171:       this.loading.set(false);
172:     }
173:   }
174: 
175:   goBack(): void {
176:     this.router.navigate(['/blueprints/pull-requests']);
177:   }
178: 
179:   merge(): void {
180:     this.message.info('åˆä½µåŠŸèƒ½å¾…å¯¦ä½œ');
181:   }
182: 
183:   close(): void {
184:     this.message.info('é—œé–‰åŠŸèƒ½å¾…å¯¦ä½œ');
185:   }
186: 
187:   approve(): void {
188:     this.message.info('æ ¸å‡†åŠŸèƒ½å¾…å¯¦ä½œ');
189:   }
190: 
191:   requestChanges(): void {
192:     this.message.info('è«‹æ±‚è®Šæ›´åŠŸèƒ½å¾…å¯¦ä½œ');
193:   }
194: }
````

## File: src/app/routes/blueprints/pull-requests/pull-request-detail.component.ts
````typescript
  1: import { Component, inject, signal, OnInit, computed } from '@angular/core';
  2: import { SHARED_IMPORTS, PullRequestService, PullRequest } from '@shared';
  3: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
  4: 
  5: export interface PRDetailData {
  6:   prId: string;
  7: }
  8: 
  9: @Component({
 10:   selector: 'app-pull-request-detail',
 11:   standalone: true,
 12:   imports: [SHARED_IMPORTS],
 13:   template: `
 14:     @if (loading()) {
 15:       <div style="text-align: center; padding: 40px;">
 16:         <nz-spin nzSize="large"></nz-spin>
 17:       </div>
 18:     } @else if (pr()) {
 19:       <nz-descriptions nzBordered [nzColumn]="2">
 20:         <nz-descriptions-item nzTitle="PR ID" [nzSpan]="2">{{ pr()!.id }}</nz-descriptions-item>
 21:         <nz-descriptions-item nzTitle="æ ‡é¢˜" [nzSpan]="2">{{ pr()!.title }}</nz-descriptions-item>
 22:         <nz-descriptions-item nzTitle="è“å›¾ID" [nzSpan]="1">{{ pr()!.blueprint_id }}</nz-descriptions-item>
 23:         <nz-descriptions-item nzTitle="åˆ†æ”¯ID" [nzSpan]="1">{{ pr()!.branch_id }}</nz-descriptions-item>
 24:         <nz-descriptions-item nzTitle="çŠ¶æ€" [nzSpan]="2">
 25:           @switch (pr()!.status) {
 26:             @case ('open') {
 27:               <nz-tag nzColor="blue">æ‰“å¼€</nz-tag>
 28:             }
 29:             @case ('reviewing') {
 30:               <nz-tag nzColor="orange">å®¡æ ¸ä¸­</nz-tag>
 31:             }
 32:             @case ('approved') {
 33:               <nz-tag nzColor="green">å·²æ‰¹å‡†</nz-tag>
 34:             }
 35:             @case ('rejected') {
 36:               <nz-tag nzColor="red">å·²æ‹’ç»</nz-tag>
 37:             }
 38:             @case ('merged') {
 39:               <nz-tag nzColor="purple">å·²åˆå¹¶</nz-tag>
 40:             }
 41:             @case ('closed') {
 42:               <nz-tag nzColor="default">å·²å…³é—­</nz-tag>
 43:             }
 44:             @default {
 45:               <nz-tag>{{ pr()!.status }}</nz-tag>
 46:             }
 47:           }
 48:         </nz-descriptions-item>
 49:         <nz-descriptions-item nzTitle="æè¿°" [nzSpan]="2">
 50:           <pre style="white-space: pre-wrap; margin: 0;">{{ pr()!.description }}</pre>
 51:         </nz-descriptions-item>
 52:         @if (changesList().length > 0) {
 53:           <nz-descriptions-item nzTitle="å˜æ›´æ‘˜è¦" [nzSpan]="2">
 54:             <ul style="margin: 0; padding-left: 20px;">
 55:               @for (change of changesList(); track $index) {
 56:                 <li>{{ change }}</li>
 57:               }
 58:             </ul>
 59:           </nz-descriptions-item>
 60:         }
 61:         <nz-descriptions-item nzTitle="æäº¤è€…ID" [nzSpan]="1">{{ pr()!.submitted_by }}</nz-descriptions-item>
 62:         <nz-descriptions-item nzTitle="æäº¤æ—¶é—´" [nzSpan]="1">
 63:           {{ pr()!.submitted_at | date: 'yyyy-MM-dd HH:mm:ss' }}
 64:         </nz-descriptions-item>
 65:         @if (pr()!.reviewed_by) {
 66:           <nz-descriptions-item nzTitle="å®¡æ ¸è€…ID" [nzSpan]="1">{{ pr()!.reviewed_by }}</nz-descriptions-item>
 67:           <nz-descriptions-item nzTitle="å®¡æ ¸æ—¶é—´" [nzSpan]="1">
 68:             {{ pr()!.reviewed_at | date: 'yyyy-MM-dd HH:mm:ss' }}
 69:           </nz-descriptions-item>
 70:         }
 71:         @if (pr()!.merged_by) {
 72:           <nz-descriptions-item nzTitle="åˆå¹¶è€…ID" [nzSpan]="1">{{ pr()!.merged_by }}</nz-descriptions-item>
 73:           <nz-descriptions-item nzTitle="åˆå¹¶æ—¶é—´" [nzSpan]="1">
 74:             {{ pr()!.merged_at | date: 'yyyy-MM-dd HH:mm:ss' }}
 75:           </nz-descriptions-item>
 76:         }
 77:       </nz-descriptions>
 78: 
 79:       <div style="margin-top: 16px; text-align: right;">
 80:         <button nz-button nzType="default" (click)="close()">å…³é—­</button>
 81:       </div>
 82:     } @else {
 83:       <nz-empty nzNotFoundContent="Pull Request ä¸å­˜åœ¨"></nz-empty>
 84:     }
 85:   `
 86: })
 87: export class PullRequestDetailComponent implements OnInit {
 88:   private modalRef = inject(NzModalRef);
 89:   private prService = inject(PullRequestService);
 90: 
 91:   readonly data: PRDetailData = inject(NZ_MODAL_DATA);
 92:   readonly loading = signal(false);
 93:   readonly pr = signal<PullRequest | null>(null);
 94: 
 95:   readonly changesList = computed(() => {
 96:     const prData = this.pr();
 97:     if (!prData || !prData.changes_summary) return [];
 98: 
 99:     // Try to parse changes_summary
100:     if (typeof prData.changes_summary === 'object') {
101:       const summary: any = prData.changes_summary;
102:       if (Array.isArray(summary.changes)) {
103:         return summary.changes;
104:       }
105:       // Try to extract any array values
106:       return Object.values(summary).filter(v => typeof v === 'string');
107:     }
108: 
109:     return [];
110:   });
111: 
112:   async ngOnInit(): Promise<void> {
113:     await this.loadPR();
114:   }
115: 
116:   async loadPR(): Promise<void> {
117:     this.loading.set(true);
118:     try {
119:       const result = await this.prService.loadPullRequestById(this.data.prId);
120:       this.pr.set(result);
121:     } catch (error) {
122:       console.error('åŠ è½½ Pull Request è¯¦æƒ…å¤±è´¥:', error);
123:       this.pr.set(null);
124:     } finally {
125:       this.loading.set(false);
126:     }
127:   }
128: 
129:   close(): void {
130:     this.modalRef.close();
131:   }
132: }
````

## File: src/app/routes/blueprints/pull-requests/pull-request-form.component.ts
````typescript
  1: import { Component, inject, signal, OnInit } from '@angular/core';
  2: import { FormBuilder, FormGroup, Validators } from '@angular/forms';
  3: import { SHARED_IMPORTS, PullRequestService } from '@shared';
  4: import { NzMessageService } from 'ng-zorro-antd/message';
  5: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
  6: 
  7: export interface PRFormData {
  8:   blueprintId: string;
  9:   branchId: string;
 10:   submittedBy: string;
 11: }
 12: 
 13: @Component({
 14:   selector: 'app-pull-request-form',
 15:   standalone: true,
 16:   imports: [SHARED_IMPORTS],
 17:   template: `
 18:     <form nz-form [formGroup]="form" (ngSubmit)="submit()">
 19:       <nz-form-item>
 20:         <nz-form-label [nzSpan]="6" nzRequired>PR æ ‡é¢˜</nz-form-label>
 21:         <nz-form-control [nzSpan]="18" nzErrorTip="è¯·è¾“å…¥ PR æ ‡é¢˜">
 22:           <input nz-input formControlName="title" placeholder="ä¾‹å¦‚ï¼šæäº¤ç¬¬ä¸€æœŸæ–½å·¥æ•°æ®" />
 23:         </nz-form-control>
 24:       </nz-form-item>
 25: 
 26:       <nz-form-item>
 27:         <nz-form-label [nzSpan]="6" nzRequired>æè¿°</nz-form-label>
 28:         <nz-form-control [nzSpan]="18" nzErrorTip="è¯·è¾“å…¥æè¿°">
 29:           <textarea
 30:             nz-input
 31:             formControlName="description"
 32:             [nzAutosize]="{ minRows: 4, maxRows: 8 }"
 33:             placeholder="è¯¦ç»†æè¿°æœ¬æ¬¡æäº¤çš„å˜æ›´å†…å®¹å’Œç›®çš„"
 34:           ></textarea>
 35:         </nz-form-control>
 36:       </nz-form-item>
 37: 
 38:       <nz-form-item>
 39:         <nz-form-label [nzSpan]="6">å˜æ›´æ‘˜è¦</nz-form-label>
 40:         <nz-form-control [nzSpan]="18">
 41:           <textarea
 42:             nz-input
 43:             formControlName="changesSummary"
 44:             [nzAutosize]="{ minRows: 3, maxRows: 6 }"
 45:             placeholder="åˆ—å‡ºä¸»è¦å˜æ›´å†…å®¹ï¼ˆå¯é€‰ï¼‰&#10;ä¾‹å¦‚ï¼š&#10;- å®Œæˆä»»åŠ¡ A çš„æ–½å·¥æ—¥å¿—&#10;- æäº¤å“è´¨æ£€æŸ¥æŠ¥å‘Š&#10;- æ›´æ–°è¿›åº¦æ•°æ®"
 46:           ></textarea>
 47:         </nz-form-control>
 48:       </nz-form-item>
 49: 
 50:       <nz-alert
 51:         nzType="info"
 52:         nzMessage="æç¤º"
 53:         nzDescription="æäº¤ Pull Request åï¼Œå°†ç­‰å¾…è“å›¾æ‹¥æœ‰è€…å®¡æ ¸ã€‚å®¡æ ¸é€šè¿‡åï¼Œæ‚¨çš„å˜æ›´å°†è¢«åˆå¹¶åˆ°ä¸»åˆ†æ”¯ã€‚"
 54:         nzShowIcon
 55:         style="margin-bottom: 16px;"
 56:       ></nz-alert>
 57: 
 58:       <nz-form-item>
 59:         <nz-form-control [nzSpan]="18" [nzOffset]="6">
 60:           <button nz-button nzType="default" type="button" (click)="cancel()" [disabled]="submitting()" style="margin-right: 8px;">
 61:             å–æ¶ˆ
 62:           </button>
 63:           <button nz-button nzType="primary" type="submit" [nzLoading]="submitting()" [disabled]="!form.valid || submitting()">
 64:             æäº¤ PR
 65:           </button>
 66:         </nz-form-control>
 67:       </nz-form-item>
 68:     </form>
 69:   `
 70: })
 71: export class PullRequestFormComponent implements OnInit {
 72:   private fb = inject(FormBuilder);
 73:   private modalRef = inject(NzModalRef);
 74:   private message = inject(NzMessageService);
 75:   private prService = inject(PullRequestService);
 76: 
 77:   readonly data: PRFormData = inject(NZ_MODAL_DATA);
 78:   readonly submitting = signal(false);
 79: 
 80:   form!: FormGroup;
 81: 
 82:   ngOnInit(): void {
 83:     this.form = this.fb.group({
 84:       title: ['', [Validators.required, Validators.minLength(5)]],
 85:       description: ['', [Validators.required, Validators.minLength(10)]],
 86:       changesSummary: ['']
 87:     });
 88:   }
 89: 
 90:   async submit(): Promise<void> {
 91:     if (!this.form.valid) {
 92:       Object.values(this.form.controls).forEach(control => {
 93:         if (control.invalid) {
 94:           control.markAsDirty();
 95:           control.updateValueAndValidity({ onlySelf: true });
 96:         }
 97:       });
 98:       return;
 99:     }
100: 
101:     this.submitting.set(true);
102:     try {
103:       const formValue = this.form.value;
104: 
105:       // Parse changes summary as JSON array
106:       let changesSummary = null;
107:       if (formValue.changesSummary) {
108:         const changesArray = formValue.changesSummary
109:           .split('\n')
110:           .filter((item: string) => item.trim())
111:           .map((item: string) => item.trim());
112: 
113:         if (changesArray.length > 0) {
114:           changesSummary = { changes: changesArray };
115:         }
116:       }
117: 
118:       await this.prService.createPullRequest({
119:         blueprint_id: this.data.blueprintId,
120:         branch_id: this.data.branchId,
121:         title: formValue.title,
122:         description: formValue.description,
123:         changes_summary: changesSummary,
124:         submitted_by: this.data.submittedBy
125:       });
126: 
127:       this.message.success('Pull Request åˆ›å»ºæˆåŠŸï¼Œç­‰å¾…å®¡æ ¸');
128:       this.modalRef.close(true);
129:     } catch (error: any) {
130:       console.error('åˆ›å»º Pull Request å¤±è´¥:', error);
131:       this.message.error(error.message || 'åˆ›å»º Pull Request å¤±è´¥ï¼Œè¯·é‡è¯•');
132:     } finally {
133:       this.submitting.set(false);
134:     }
135:   }
136: 
137:   cancel(): void {
138:     this.modalRef.close(false);
139:   }
140: }
````

## File: src/app/routes/blueprints/pull-requests/pull-request-list.component.ts
````typescript
  1: import { Component, OnInit, inject, computed } from '@angular/core';
  2: import { ActivatedRoute, Router } from '@angular/router';
  3: import { PRStatus } from '@core';
  4: import { STColumn } from '@delon/abc/st';
  5: import { AccountService, AccountType, BlueprintService, PullRequest, PullRequestService, SHARED_IMPORTS } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: import { NzModalService } from 'ng-zorro-antd/modal';
  8: 
  9: import { PullRequestDetailComponent } from './pull-request-detail.component';
 10: import { PullRequestFormComponent } from './pull-request-form.component';
 11: import { PullRequestMergeComponent } from './pull-request-merge.component';
 12: import { PullRequestReviewComponent } from './pull-request-review.component';
 13: 
 14: @Component({
 15:   selector: 'app-pull-request-list',
 16:   standalone: true,
 17:   imports: [SHARED_IMPORTS],
 18:   template: `
 19:     <page-header [title]="'Pull Request ç®¡ç†'">
 20:       <ng-template #extra>
 21:         <button nz-button nzType="default" (click)="goBack()" style="margin-right: 8px;">
 22:           <span nz-icon nzType="arrow-left"></span>
 23:           è¿”å›
 24:         </button>
 25:         @if (!isPersonalBlueprint()) {
 26:           <button nz-button nzType="primary" (click)="createPR()">
 27:             <span nz-icon nzType="plus"></span>
 28:             åˆ›å»º PR
 29:           </button>
 30:         } @else {
 31:           <nz-tooltip nzTitle="ä¸ªäººè“å›¾ä¸æ”¯æŒPRåŠŸèƒ½ï¼ˆéœ€è¦ç»„ç»‡åˆ†æ”¯ï¼‰">
 32:             <button nz-button nzType="primary" nzDisabled>
 33:               <span nz-icon nzType="plus"></span>
 34:               åˆ›å»º PR
 35:             </button>
 36:           </nz-tooltip>
 37:         }
 38:       </ng-template>
 39:     </page-header>
 40: 
 41:     <nz-card nzTitle="Pull Request åˆ—è¡¨" style="margin-top: 16px;">
 42:       <st
 43:         #st
 44:         [data]="prService.pullRequests()"
 45:         [columns]="columns"
 46:         [loading]="prService.loading()"
 47:         [page]="{ front: false, show: true, showSize: true }"
 48:         (change)="onTableChange()"
 49:       >
 50:         <ng-template #status let-record>
 51:           @switch (record.status) {
 52:             @case ('open') {
 53:               <nz-tag nzColor="blue">æ‰“å¼€</nz-tag>
 54:             }
 55:             @case ('reviewing') {
 56:               <nz-tag nzColor="orange">å®¡æ ¸ä¸­</nz-tag>
 57:             }
 58:             @case ('approved') {
 59:               <nz-tag nzColor="green">å·²æ‰¹å‡†</nz-tag>
 60:             }
 61:             @case ('rejected') {
 62:               <nz-tag nzColor="red">å·²æ‹’ç»</nz-tag>
 63:             }
 64:             @case ('merged') {
 65:               <nz-tag nzColor="purple">å·²åˆå¹¶</nz-tag>
 66:             }
 67:             @case ('closed') {
 68:               <nz-tag nzColor="default">å·²å…³é—­</nz-tag>
 69:             }
 70:             @default {
 71:               <nz-tag>æœªçŸ¥</nz-tag>
 72:             }
 73:           }
 74:         </ng-template>
 75:       </st>
 76:     </nz-card>
 77:   `
 78: })
 79: export class PullRequestListComponent implements OnInit {
 80:   prService = inject(PullRequestService);
 81:   accountService = inject(AccountService);
 82:   blueprintService = inject(BlueprintService);
 83:   route = inject(ActivatedRoute);
 84:   router = inject(Router);
 85:   message = inject(NzMessageService);
 86:   modal = inject(NzModalService);
 87: 
 88:   blueprintId = computed(() => this.route.snapshot.paramMap.get('id') || '');
 89: 
 90:   // è“å›¾ä¿¡æ¯
 91:   blueprint = computed(() => this.blueprintService.selectedBlueprint());
 92: 
 93:   // åˆ¤æ–­æ˜¯å¦ä¸ºä¸ªäººè“å›¾
 94:   isPersonalBlueprint = computed(() => {
 95:     const bp = this.blueprint();
 96:     if (!bp) return false;
 97:     const owner = this.accountService.accounts().find(a => a.id === bp.owner_id);
 98:     return owner?.type === AccountType.USER;
 99:   });
100: 
101:   // å¯¼å‡ºæšä¸¾ä¾›æ¨¡æ¿ä½¿ç”¨
102:   AccountType = AccountType;
103: 
104:   columns: STColumn[] = [
105:     { title: 'ID', index: 'id', width: 100 },
106:     { title: 'æ ‡é¢˜', index: 'title', width: 200 },
107:     { title: 'åˆ†æ”¯ID', index: 'branch_id', width: 150 },
108:     { title: 'æäº¤è€…', index: 'submitted_by', width: 150 },
109:     { title: 'çŠ¶æ€', index: 'status', width: 100, render: 'status' },
110:     { title: 'åˆ›å»ºæ—¶é—´', index: 'created_at', type: 'date', width: 180 },
111:     {
112:       title: 'æ“ä½œ',
113:       width: 250,
114:       buttons: [
115:         {
116:           text: 'æŸ¥çœ‹',
117:           click: (record: PullRequest) => this.viewPR(record.id)
118:         },
119:         {
120:           text: 'å®¡æ ¸',
121:           click: (record: PullRequest) => this.reviewPR(record.id)
122:         },
123:         {
124:           text: 'åˆå¹¶',
125:           click: (record: PullRequest) => this.mergePR(record.id)
126:         }
127:       ]
128:     }
129:   ];
130: 
131:   ngOnInit(): void {
132:     const id = this.blueprintId();
133:     if (id) {
134:       this.loadBlueprint(id);
135:       this.loadPRs(id);
136:     }
137:   }
138: 
139:   async loadBlueprint(id: string): Promise<void> {
140:     try {
141:       await this.blueprintService.loadBlueprintById(id);
142:       // åŠ è½½æ‹¥æœ‰è€…è´¦æˆ·ä¿¡æ¯
143:       const blueprint = this.blueprint();
144:       if (blueprint) {
145:         await this.accountService.loadAccountById(blueprint.owner_id);
146:       }
147:     } catch (error) {
148:       // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ä¸»æµç¨‹
149:       console.error('åŠ è½½è“å›¾ä¿¡æ¯å¤±è´¥:', error);
150:     }
151:   }
152: 
153:   async loadPRs(blueprintId: string): Promise<void> {
154:     try {
155:       await this.prService.loadPullRequestsByBlueprintId(blueprintId);
156:     } catch (error) {
157:       this.message.error('åŠ è½½ Pull Request åˆ—è¡¨å¤±è´¥');
158:     }
159:   }
160: 
161:   onTableChange(): void {
162:     // è¡¨æ ¼å˜åŒ–å¤„ç†
163:   }
164: 
165:   goBack(): void {
166:     const blueprintId = this.blueprintId();
167:     if (blueprintId) {
168:       this.router.navigate(['/blueprints', blueprintId]);
169:     } else {
170:       this.router.navigate(['/blueprints/list']);
171:     }
172:   }
173: 
174:   createPR(): void {
175:     const blueprintId = this.blueprintId();
176:     if (!blueprintId) {
177:       this.message.warning('æ— æ³•è·å–è“å›¾ID');
178:       return;
179:     }
180: 
181:     // TODO: å®é™…åº”è¯¥é€‰æ‹©å…·ä½“çš„åˆ†æ”¯ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
182:     const modalRef = this.modal.create({
183:       nzTitle: 'åˆ›å»º Pull Request',
184:       nzContent: PullRequestFormComponent,
185:       nzData: {
186:         blueprintId,
187:         branchId: 'temp-branch-id', // å®é™…åº”è¯¥ä»å½“å‰ä¸Šä¸‹æ–‡è·å–
188:         submittedBy: 'temp-user-id' // å®é™…åº”è¯¥ä»å½“å‰ç™»å½•ç”¨æˆ·è·å–
189:       },
190:       nzWidth: 720,
191:       nzFooter: null
192:     });
193: 
194:     modalRef.afterClose.subscribe(result => {
195:       if (result) {
196:         this.loadPRs(blueprintId);
197:       }
198:     });
199:   }
200: 
201:   viewPR(prId: string): void {
202:     this.modal.create({
203:       nzTitle: 'Pull Request è¯¦æƒ…',
204:       nzContent: PullRequestDetailComponent,
205:       nzData: {
206:         prId
207:       },
208:       nzWidth: 900,
209:       nzFooter: null
210:     });
211:   }
212: 
213:   async reviewPR(prId: string): Promise<void> {
214:     const pr = this.prService.pullRequests().find(p => p.id === prId);
215:     if (!pr) {
216:       this.message.error('æ‰¾ä¸åˆ°è¯¥ Pull Request');
217:       return;
218:     }
219: 
220:     if (pr.status !== 'open' && pr.status !== 'reviewing') {
221:       this.message.warning('åªèƒ½å®¡æ ¸æ‰“å¼€æˆ–å®¡æ ¸ä¸­çš„ Pull Request');
222:       return;
223:     }
224: 
225:     const modalRef = this.modal.create({
226:       nzTitle: 'å®¡æ ¸ Pull Request',
227:       nzContent: PullRequestReviewComponent,
228:       nzData: {
229:         pr,
230:         reviewerId: 'temp-reviewer-id' // å®é™…åº”è¯¥ä»å½“å‰ç™»å½•ç”¨æˆ·è·å–
231:       },
232:       nzWidth: 720,
233:       nzFooter: null
234:     });
235: 
236:     modalRef.afterClose.subscribe(result => {
237:       if (result) {
238:         const blueprintId = this.blueprintId();
239:         if (blueprintId) {
240:           this.loadPRs(blueprintId);
241:         }
242:       }
243:     });
244:   }
245: 
246:   async mergePR(prId: string): Promise<void> {
247:     const pr = this.prService.pullRequests().find(p => p.id === prId);
248:     if (!pr) {
249:       this.message.error('æ‰¾ä¸åˆ°è¯¥ Pull Request');
250:       return;
251:     }
252: 
253:     if (pr.status !== 'approved') {
254:       this.message.warning('åªèƒ½åˆå¹¶å·²æ‰¹å‡†çš„ Pull Request');
255:       return;
256:     }
257: 
258:     const modalRef = this.modal.create({
259:       nzTitle: 'åˆå¹¶ Pull Request',
260:       nzContent: PullRequestMergeComponent,
261:       nzData: {
262:         pr,
263:         mergedBy: 'temp-merger-id' // å®é™…åº”è¯¥ä»å½“å‰ç™»å½•ç”¨æˆ·è·å–
264:       },
265:       nzWidth: 600,
266:       nzFooter: null
267:     });
268: 
269:     modalRef.afterClose.subscribe(result => {
270:       if (result) {
271:         const blueprintId = this.blueprintId();
272:         if (blueprintId) {
273:           this.loadPRs(blueprintId);
274:         }
275:       }
276:     });
277:   }
278: }
````

## File: src/app/routes/blueprints/pull-requests/pull-request-merge.component.ts
````typescript
  1: import { Component, inject, signal } from '@angular/core';
  2: import { SHARED_IMPORTS, PullRequestService, PullRequest } from '@shared';
  3: import { NzMessageService } from 'ng-zorro-antd/message';
  4: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
  5: 
  6: export interface PRMergeData {
  7:   pr: PullRequest;
  8:   mergedBy: string;
  9: }
 10: 
 11: @Component({
 12:   selector: 'app-pull-request-merge',
 13:   standalone: true,
 14:   imports: [SHARED_IMPORTS],
 15:   template: `
 16:     <div style="margin-bottom: 16px;">
 17:       <nz-descriptions nzBordered [nzColumn]="1" nzSize="small">
 18:         <nz-descriptions-item nzTitle="PR æ ‡é¢˜">{{ data.pr.title }}</nz-descriptions-item>
 19:         <nz-descriptions-item nzTitle="æäº¤è€…">{{ data.pr.submitted_by }}</nz-descriptions-item>
 20:         <nz-descriptions-item nzTitle="åˆ†æ”¯">{{ data.pr.branch_id }}</nz-descriptions-item>
 21:         <nz-descriptions-item nzTitle="çŠ¶æ€">
 22:           @switch (data.pr.status) {
 23:             @case ('approved') {
 24:               <nz-tag nzColor="green">å·²æ‰¹å‡†</nz-tag>
 25:             }
 26:             @default {
 27:               <nz-tag nzColor="orange">{{ data.pr.status }}</nz-tag>
 28:             }
 29:           }
 30:         </nz-descriptions-item>
 31:       </nz-descriptions>
 32:     </div>
 33: 
 34:     @if (data.pr.status !== 'approved') {
 35:       <nz-alert
 36:         nzType="warning"
 37:         nzMessage="æ— æ³•åˆå¹¶"
 38:         nzDescription="åªæœ‰å·²æ‰¹å‡†çš„ Pull Request æ‰èƒ½åˆå¹¶ã€‚è¯·å…ˆå®Œæˆå®¡æ ¸æµç¨‹ã€‚"
 39:         nzShowIcon
 40:         style="margin-bottom: 16px;"
 41:       ></nz-alert>
 42:     } @else {
 43:       <nz-alert
 44:         nzType="info"
 45:         nzMessage="åˆå¹¶è¯´æ˜"
 46:         nzDescription="åˆå¹¶æ“ä½œå°†æŠŠåˆ†æ”¯ä¸­çš„æ‰¿æ½å­—æ®µæ•°æ®æ›´æ–°åˆ°ä¸»åˆ†æ”¯ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·ç¡®è®¤åç»§ç»­ã€‚"
 47:         nzShowIcon
 48:         style="margin-bottom: 16px;"
 49:       ></nz-alert>
 50: 
 51:       <div style="margin-top: 16px; text-align: center;">
 52:         <nz-checkbox [(ngModel)]="confirmedValue" (ngModelChange)="confirmed.set($event)">
 53:           æˆ‘å·²ç¡®è®¤å˜æ›´å†…å®¹ï¼ŒåŒæ„åˆå¹¶æ­¤ Pull Request
 54:         </nz-checkbox>
 55:       </div>
 56:     }
 57: 
 58:     <div style="margin-top: 24px; text-align: right;">
 59:       <button nz-button nzType="default" (click)="cancel()" [disabled]="submitting()" style="margin-right: 8px;"> å–æ¶ˆ </button>
 60:       <button nz-button nzType="primary" nzDanger (click)="merge()" [nzLoading]="submitting()" [disabled]="!canMerge() || submitting()">
 61:         ç¡®è®¤åˆå¹¶
 62:       </button>
 63:     </div>
 64:   `
 65: })
 66: export class PullRequestMergeComponent {
 67:   private modalRef = inject(NzModalRef);
 68:   private message = inject(NzMessageService);
 69:   private prService = inject(PullRequestService);
 70: 
 71:   readonly data: PRMergeData = inject(NZ_MODAL_DATA);
 72:   readonly submitting = signal(false);
 73:   readonly confirmed = signal(false);
 74:   confirmedValue = false;
 75: 
 76:   canMerge(): boolean {
 77:     return this.data.pr.status === 'approved' && this.confirmed();
 78:   }
 79: 
 80:   async merge(): Promise<void> {
 81:     if (!this.canMerge()) {
 82:       return;
 83:     }
 84: 
 85:     this.submitting.set(true);
 86:     try {
 87:       await this.prService.mergePullRequest(this.data.pr.id, this.data.mergedBy);
 88: 
 89:       this.message.success('Pull Request åˆå¹¶æˆåŠŸ');
 90:       this.modalRef.close(true);
 91:     } catch (error: any) {
 92:       console.error('åˆå¹¶ Pull Request å¤±è´¥:', error);
 93:       this.message.error(error.message || 'åˆå¹¶å¤±è´¥ï¼Œè¯·é‡è¯•');
 94:     } finally {
 95:       this.submitting.set(false);
 96:     }
 97:   }
 98: 
 99:   cancel(): void {
100:     this.modalRef.close(false);
101:   }
102: }
````

## File: src/app/routes/blueprints/pull-requests/pull-request-review.component.ts
````typescript
  1: import { Component, inject, signal, OnInit } from '@angular/core';
  2: import { FormBuilder, FormGroup, Validators } from '@angular/forms';
  3: import { SHARED_IMPORTS, PullRequestService, PullRequest } from '@shared';
  4: import { NzMessageService } from 'ng-zorro-antd/message';
  5: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
  6: 
  7: export interface PRReviewData {
  8:   pr: PullRequest;
  9:   reviewerId: string;
 10: }
 11: 
 12: @Component({
 13:   selector: 'app-pull-request-review',
 14:   standalone: true,
 15:   imports: [SHARED_IMPORTS],
 16:   template: `
 17:     <div style="margin-bottom: 16px;">
 18:       <nz-descriptions nzBordered [nzColumn]="1" nzSize="small">
 19:         <nz-descriptions-item nzTitle="PR æ ‡é¢˜">{{ data.pr.title }}</nz-descriptions-item>
 20:         <nz-descriptions-item nzTitle="æäº¤è€…">{{ data.pr.submitted_by }}</nz-descriptions-item>
 21:         <nz-descriptions-item nzTitle="æäº¤æ—¶é—´">{{ data.pr.submitted_at | date: 'yyyy-MM-dd HH:mm:ss' }}</nz-descriptions-item>
 22:       </nz-descriptions>
 23:     </div>
 24: 
 25:     <form nz-form [formGroup]="form" (ngSubmit)="submit()">
 26:       <nz-form-item>
 27:         <nz-form-label [nzSpan]="6" nzRequired>å®¡æ ¸å†³å®š</nz-form-label>
 28:         <nz-form-control [nzSpan]="18" nzErrorTip="è¯·é€‰æ‹©å®¡æ ¸å†³å®š">
 29:           <nz-radio-group formControlName="decision">
 30:             <label nz-radio nzValue="approved">æ‰¹å‡†</label>
 31:             <label nz-radio nzValue="rejected">æ‹’ç»</label>
 32:           </nz-radio-group>
 33:         </nz-form-control>
 34:       </nz-form-item>
 35: 
 36:       <nz-form-item>
 37:         <nz-form-label [nzSpan]="6">å®¡æ ¸æ„è§</nz-form-label>
 38:         <nz-form-control [nzSpan]="18">
 39:           <textarea
 40:             nz-input
 41:             formControlName="comments"
 42:             [nzAutosize]="{ minRows: 3, maxRows: 6 }"
 43:             placeholder="è¯·è¾“å…¥å®¡æ ¸æ„è§æˆ–å»ºè®®ï¼ˆå¯é€‰ï¼‰"
 44:           ></textarea>
 45:         </nz-form-control>
 46:       </nz-form-item>
 47: 
 48:       @if (form.value.decision === 'approved') {
 49:         <nz-alert
 50:           nzType="success"
 51:           nzMessage="æ‰¹å‡†æç¤º"
 52:           nzDescription="æ‰¹å‡†åï¼Œæ­¤ PR å°†è¿›å…¥å·²æ‰¹å‡†çŠ¶æ€ï¼Œç­‰å¾…åˆå¹¶æ“ä½œã€‚"
 53:           nzShowIcon
 54:           style="margin-bottom: 16px;"
 55:         ></nz-alert>
 56:       }
 57: 
 58:       @if (form.value.decision === 'rejected') {
 59:         <nz-alert
 60:           nzType="warning"
 61:           nzMessage="æ‹’ç»æç¤º"
 62:           nzDescription="æ‹’ç»åï¼Œæäº¤è€…éœ€è¦æ ¹æ®å®¡æ ¸æ„è§è¿›è¡Œä¿®æ”¹ï¼Œå¹¶é‡æ–°æäº¤ã€‚"
 63:           nzShowIcon
 64:           style="margin-bottom: 16px;"
 65:         ></nz-alert>
 66:       }
 67: 
 68:       <nz-form-item>
 69:         <nz-form-control [nzSpan]="18" [nzOffset]="6">
 70:           <button nz-button nzType="default" type="button" (click)="cancel()" [disabled]="submitting()" style="margin-right: 8px;">
 71:             å–æ¶ˆ
 72:           </button>
 73:           <button nz-button nzType="primary" type="submit" [nzLoading]="submitting()" [disabled]="!form.valid || submitting()">
 74:             æäº¤å®¡æ ¸
 75:           </button>
 76:         </nz-form-control>
 77:       </nz-form-item>
 78:     </form>
 79:   `
 80: })
 81: export class PullRequestReviewComponent implements OnInit {
 82:   private fb = inject(FormBuilder);
 83:   private modalRef = inject(NzModalRef);
 84:   private message = inject(NzMessageService);
 85:   private prService = inject(PullRequestService);
 86: 
 87:   readonly data: PRReviewData = inject(NZ_MODAL_DATA);
 88:   readonly submitting = signal(false);
 89: 
 90:   form!: FormGroup;
 91: 
 92:   ngOnInit(): void {
 93:     this.form = this.fb.group({
 94:       decision: ['approved', [Validators.required]],
 95:       comments: ['']
 96:     });
 97:   }
 98: 
 99:   async submit(): Promise<void> {
100:     if (!this.form.valid) {
101:       Object.values(this.form.controls).forEach(control => {
102:         if (control.invalid) {
103:           control.markAsDirty();
104:           control.updateValueAndValidity({ onlySelf: true });
105:         }
106:       });
107:       return;
108:     }
109: 
110:     this.submitting.set(true);
111:     try {
112:       const formValue = this.form.value;
113: 
114:       if (formValue.decision === 'approved') {
115:         await this.prService.approvePullRequest(this.data.pr.id, this.data.reviewerId);
116:       } else {
117:         await this.prService.rejectPullRequest(this.data.pr.id, this.data.reviewerId);
118:       }
119: 
120:       this.message.success(`Pull Request å·²${formValue.decision === 'approved' ? 'æ‰¹å‡†' : 'æ‹’ç»'}`);
121:       this.modalRef.close(true);
122:     } catch (error: any) {
123:       console.error('å®¡æ ¸ Pull Request å¤±è´¥:', error);
124:       this.message.error(error.message || 'å®¡æ ¸å¤±è´¥ï¼Œè¯·é‡è¯•');
125:     } finally {
126:       this.submitting.set(false);
127:     }
128:   }
129: 
130:   cancel(): void {
131:     this.modalRef.close(false);
132:   }
133: }
````

## File: src/app/routes/quality/checks/quality-check-detail.component.ts
````typescript
  1: import { Component, inject, signal, OnInit } from '@angular/core';
  2: import { QualityCheckRepository, QualityCheck } from '@core';
  3: import { SHARED_IMPORTS } from '@shared';
  4: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
  5: import { firstValueFrom } from 'rxjs';
  6: 
  7: export interface QualityCheckDetailData {
  8:   checkId: string;
  9: }
 10: 
 11: @Component({
 12:   selector: 'app-quality-check-detail',
 13:   standalone: true,
 14:   imports: [SHARED_IMPORTS],
 15:   template: `
 16:     @if (loading()) {
 17:       <div style="text-align: center; padding: 40px;">
 18:         <nz-spin nzSize="large"></nz-spin>
 19:       </div>
 20:     } @else if (check()) {
 21:       <nz-descriptions nzBordered [nzColumn]="2">
 22:         <nz-descriptions-item nzTitle="æ£€æŸ¥ID" [nzSpan]="2">{{ check()!.id }}</nz-descriptions-item>
 23:         <nz-descriptions-item nzTitle="ä»»åŠ¡ID" [nzSpan]="2">{{ check()!.task_id }}</nz-descriptions-item>
 24:         <nz-descriptions-item nzTitle="æ£€æŸ¥ç±»å‹" [nzSpan]="1">
 25:           @switch (check()!.check_type) {
 26:             @case ('routine') {
 27:               <nz-tag nzColor="blue">å¸¸è§„æ£€æŸ¥</nz-tag>
 28:             }
 29:             @case ('milestone') {
 30:               <nz-tag nzColor="orange">é‡Œç¨‹ç¢‘æ£€æŸ¥</nz-tag>
 31:             }
 32:             @case ('final') {
 33:               <nz-tag nzColor="purple">æœ€ç»ˆæ£€æŸ¥</nz-tag>
 34:             }
 35:             @case ('spot_check') {
 36:               <nz-tag nzColor="cyan">æŠ½æŸ¥</nz-tag>
 37:             }
 38:             @default {
 39:               <nz-tag>{{ check()!.check_type }}</nz-tag>
 40:             }
 41:           }
 42:         </nz-descriptions-item>
 43:         <nz-descriptions-item nzTitle="çŠ¶æ€" [nzSpan]="1">
 44:           @switch (check()!.status) {
 45:             @case ('pending') {
 46:               <nz-tag nzColor="default">å¾…æ£€æŸ¥</nz-tag>
 47:             }
 48:             @case ('in_progress') {
 49:               <nz-tag nzColor="blue">æ£€æŸ¥ä¸­</nz-tag>
 50:             }
 51:             @case ('passed') {
 52:               <nz-tag nzColor="green">é€šè¿‡</nz-tag>
 53:             }
 54:             @case ('failed') {
 55:               <nz-tag nzColor="red">ä¸é€šè¿‡</nz-tag>
 56:             }
 57:             @case ('conditional_pass') {
 58:               <nz-tag nzColor="orange">æœ‰æ¡ä»¶é€šè¿‡</nz-tag>
 59:             }
 60:             @default {
 61:               <nz-tag>{{ check()!.status }}</nz-tag>
 62:             }
 63:           }
 64:         </nz-descriptions-item>
 65:         <nz-descriptions-item nzTitle="æ£€æŸ¥é¡¹ç›®" [nzSpan]="2">
 66:           @if (checkItemsArray().length > 0) {
 67:             <ul style="margin: 0; padding-left: 20px;">
 68:               @for (item of checkItemsArray(); track $index) {
 69:                 <li>{{ item }}</li>
 70:               }
 71:             </ul>
 72:           } @else {
 73:             <span>æ— </span>
 74:           }
 75:         </nz-descriptions-item>
 76:         @if (check()!.findings) {
 77:           <nz-descriptions-item nzTitle="æ£€æŸ¥å‘ç°" [nzSpan]="2">
 78:             <pre style="white-space: pre-wrap; margin: 0;">{{ check()!.findings }}</pre>
 79:           </nz-descriptions-item>
 80:         }
 81:         @if (check()!.recommendations) {
 82:           <nz-descriptions-item nzTitle="å»ºè®®" [nzSpan]="2">
 83:             <pre style="white-space: pre-wrap; margin: 0;">{{ check()!.recommendations }}</pre>
 84:           </nz-descriptions-item>
 85:         }
 86:         <nz-descriptions-item nzTitle="æ£€æŸ¥å‘˜ID" [nzSpan]="1">{{ check()!.inspector_id }}</nz-descriptions-item>
 87:         <nz-descriptions-item nzTitle="æ£€æŸ¥æ—¶é—´" [nzSpan]="1">
 88:           {{ check()!.checked_at | date: 'yyyy-MM-dd HH:mm:ss' }}
 89:         </nz-descriptions-item>
 90:         @if (check()!.completed_at) {
 91:           <nz-descriptions-item nzTitle="å®Œæˆæ—¶é—´" [nzSpan]="2">
 92:             {{ check()!.completed_at | date: 'yyyy-MM-dd HH:mm:ss' }}
 93:           </nz-descriptions-item>
 94:         }
 95:       </nz-descriptions>
 96: 
 97:       <div style="margin-top: 16px; text-align: right;">
 98:         <button nz-button nzType="default" (click)="close()">å…³é—­</button>
 99:       </div>
100:     } @else {
101:       <nz-empty nzNotFoundContent="å“è´¨æ£€æŸ¥ä¸å­˜åœ¨"></nz-empty>
102:     }
103:   `
104: })
105: export class QualityCheckDetailComponent implements OnInit {
106:   private modalRef = inject(NzModalRef);
107:   private qualityCheckRepo = inject(QualityCheckRepository);
108: 
109:   readonly data: QualityCheckDetailData = inject(NZ_MODAL_DATA);
110:   readonly loading = signal(false);
111:   readonly check = signal<QualityCheck | null>(null);
112: 
113:   readonly checkItemsArray = signal<string[]>([]);
114: 
115:   async ngOnInit(): Promise<void> {
116:     await this.loadCheck();
117:   }
118: 
119:   async loadCheck(): Promise<void> {
120:     this.loading.set(true);
121:     try {
122:       const result = await firstValueFrom(this.qualityCheckRepo.findById(this.data.checkId));
123:       this.check.set(result);
124: 
125:       // Parse check_items
126:       if (result && result.check_items) {
127:         if (Array.isArray(result.check_items)) {
128:           this.checkItemsArray.set(result.check_items as string[]);
129:         } else if (typeof result.check_items === 'object') {
130:           // If it's an object, try to extract items
131:           this.checkItemsArray.set(Object.values(result.check_items).filter((v): v is string => typeof v === 'string'));
132:         }
133:       }
134:     } catch (error) {
135:       console.error('åŠ è½½å“è´¨æ£€æŸ¥è¯¦æƒ…å¤±è´¥:', error);
136:       this.check.set(null);
137:     } finally {
138:       this.loading.set(false);
139:     }
140:   }
141: 
142:   close(): void {
143:     this.modalRef.close();
144:   }
145: }
````

## File: src/app/routes/quality/checks/quality-check-form.component.ts
````typescript
  1: import { Component, inject, signal, OnInit } from '@angular/core';
  2: import { FormBuilder, FormGroup, Validators } from '@angular/forms';
  3: import { QualityCheckRepository } from '@core';
  4: import { SHARED_IMPORTS, Task } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
  7: import { firstValueFrom } from 'rxjs';
  8: 
  9: export interface QualityCheckFormData {
 10:   task: Task;
 11: }
 12: 
 13: @Component({
 14:   selector: 'app-quality-check-form',
 15:   standalone: true,
 16:   imports: [SHARED_IMPORTS],
 17:   template: `
 18:     <form nz-form [formGroup]="form" (ngSubmit)="submit()">
 19:       <nz-form-item>
 20:         <nz-form-label [nzSpan]="6" nzRequired>ä»»åŠ¡</nz-form-label>
 21:         <nz-form-control [nzSpan]="18">
 22:           <input nz-input [value]="data.task.title" disabled />
 23:         </nz-form-control>
 24:       </nz-form-item>
 25: 
 26:       <nz-form-item>
 27:         <nz-form-label [nzSpan]="6" nzRequired>æ£€æŸ¥ç±»å‹</nz-form-label>
 28:         <nz-form-control [nzSpan]="18" nzErrorTip="è¯·é€‰æ‹©æ£€æŸ¥ç±»å‹">
 29:           <nz-select formControlName="checkType" nzPlaceHolder="é€‰æ‹©æ£€æŸ¥ç±»å‹">
 30:             <nz-option nzValue="routine" nzLabel="å¸¸è§„æ£€æŸ¥"></nz-option>
 31:             <nz-option nzValue="milestone" nzLabel="é‡Œç¨‹ç¢‘æ£€æŸ¥"></nz-option>
 32:             <nz-option nzValue="final" nzLabel="æœ€ç»ˆæ£€æŸ¥"></nz-option>
 33:             <nz-option nzValue="spot_check" nzLabel="æŠ½æŸ¥"></nz-option>
 34:           </nz-select>
 35:         </nz-form-control>
 36:       </nz-form-item>
 37: 
 38:       <nz-form-item>
 39:         <nz-form-label [nzSpan]="6" nzRequired>æ£€æŸ¥é¡¹ç›®</nz-form-label>
 40:         <nz-form-control [nzSpan]="18" nzErrorTip="è¯·è¾“å…¥æ£€æŸ¥é¡¹ç›®">
 41:           <textarea
 42:             nz-input
 43:             formControlName="checkItems"
 44:             [nzAutosize]="{ minRows: 4, maxRows: 8 }"
 45:             placeholder="æ¯è¡Œä¸€ä¸ªæ£€æŸ¥é¡¹ç›®ï¼Œä¾‹å¦‚ï¼š&#10;- æ··å‡åœŸå¼ºåº¦æ£€æŸ¥&#10;- é’¢ç­‹ç»‘æ‰è§„èŒƒæ£€æŸ¥&#10;- æ¨¡æ¿å®‰è£…è´¨é‡æ£€æŸ¥"
 46:           ></textarea>
 47:         </nz-form-control>
 48:       </nz-form-item>
 49: 
 50:       <nz-form-item>
 51:         <nz-form-label [nzSpan]="6">æ£€æŸ¥å‘ç°</nz-form-label>
 52:         <nz-form-control [nzSpan]="18">
 53:           <textarea
 54:             nz-input
 55:             formControlName="findings"
 56:             [nzAutosize]="{ minRows: 3, maxRows: 6 }"
 57:             placeholder="è®°å½•æ£€æŸ¥è¿‡ç¨‹ä¸­çš„å‘ç°å’Œé—®é¢˜"
 58:           ></textarea>
 59:         </nz-form-control>
 60:       </nz-form-item>
 61: 
 62:       <nz-form-item>
 63:         <nz-form-label [nzSpan]="6">å»ºè®®</nz-form-label>
 64:         <nz-form-control [nzSpan]="18">
 65:           <textarea
 66:             nz-input
 67:             formControlName="recommendations"
 68:             [nzAutosize]="{ minRows: 3, maxRows: 6 }"
 69:             placeholder="é’ˆå¯¹å‘ç°çš„é—®é¢˜æå‡ºæ”¹è¿›å»ºè®®"
 70:           ></textarea>
 71:         </nz-form-control>
 72:       </nz-form-item>
 73: 
 74:       <nz-form-item>
 75:         <nz-form-label [nzSpan]="6" nzRequired>æ£€æŸ¥çŠ¶æ€</nz-form-label>
 76:         <nz-form-control [nzSpan]="18" nzErrorTip="è¯·é€‰æ‹©æ£€æŸ¥çŠ¶æ€">
 77:           <nz-select formControlName="status" nzPlaceHolder="é€‰æ‹©æ£€æŸ¥çŠ¶æ€">
 78:             <nz-option nzValue="pending" nzLabel="å¾…æ£€æŸ¥"></nz-option>
 79:             <nz-option nzValue="in_progress" nzLabel="æ£€æŸ¥ä¸­"></nz-option>
 80:             <nz-option nzValue="passed" nzLabel="é€šè¿‡"></nz-option>
 81:             <nz-option nzValue="failed" nzLabel="ä¸é€šè¿‡"></nz-option>
 82:             <nz-option nzValue="conditional_pass" nzLabel="æœ‰æ¡ä»¶é€šè¿‡"></nz-option>
 83:           </nz-select>
 84:         </nz-form-control>
 85:       </nz-form-item>
 86: 
 87:       <nz-form-item>
 88:         <nz-form-control [nzSpan]="18" [nzOffset]="6">
 89:           <button nz-button nzType="default" type="button" (click)="cancel()" [disabled]="submitting()" style="margin-right: 8px;">
 90:             å–æ¶ˆ
 91:           </button>
 92:           <button nz-button nzType="primary" type="submit" [nzLoading]="submitting()" [disabled]="!form.valid || submitting()">
 93:             æäº¤
 94:           </button>
 95:         </nz-form-control>
 96:       </nz-form-item>
 97:     </form>
 98:   `
 99: })
100: export class QualityCheckFormComponent implements OnInit {
101:   private fb = inject(FormBuilder);
102:   private modalRef = inject(NzModalRef);
103:   private message = inject(NzMessageService);
104:   private qualityCheckRepo = inject(QualityCheckRepository);
105: 
106:   readonly data: QualityCheckFormData = inject(NZ_MODAL_DATA);
107:   readonly submitting = signal(false);
108: 
109:   form!: FormGroup;
110: 
111:   ngOnInit(): void {
112:     this.form = this.fb.group({
113:       checkType: ['routine', [Validators.required]],
114:       checkItems: ['', [Validators.required, Validators.minLength(10)]],
115:       findings: [''],
116:       recommendations: [''],
117:       status: ['pending', [Validators.required]]
118:     });
119:   }
120: 
121:   async submit(): Promise<void> {
122:     if (!this.form.valid) {
123:       Object.values(this.form.controls).forEach(control => {
124:         if (control.invalid) {
125:           control.markAsDirty();
126:           control.updateValueAndValidity({ onlySelf: true });
127:         }
128:       });
129:       return;
130:     }
131: 
132:     this.submitting.set(true);
133:     try {
134:       const formValue = this.form.value;
135: 
136:       // Parse check items as JSON array
137:       const checkItemsArray = formValue.checkItems
138:         .split('\n')
139:         .filter((item: string) => item.trim())
140:         .map((item: string) => item.trim());
141: 
142:       const qualityCheck = {
143:         task_id: this.data.task.id,
144:         inspector_id: this.data.task.created_by, // ä½¿ç”¨ä»»åŠ¡åˆ›å»ºè€…IDï¼Œå®é™…åº”è¯¥ç”¨å½“å‰ç™»å½•ç”¨æˆ·ID
145:         check_type: formValue.checkType,
146:         status: formValue.status,
147:         check_items: checkItemsArray,
148:         findings: formValue.findings || null,
149:         recommendations: formValue.recommendations || null,
150:         checked_at: new Date().toISOString(),
151:         completed_at: ['passed', 'failed', 'conditional_pass'].includes(formValue.status) ? new Date().toISOString() : null
152:       };
153: 
154:       await firstValueFrom(this.qualityCheckRepo.create(qualityCheck));
155:       this.message.success('å“è´¨æ£€æŸ¥åˆ›å»ºæˆåŠŸ');
156:       this.modalRef.close(true);
157:     } catch (error: any) {
158:       console.error('åˆ›å»ºå“è´¨æ£€æŸ¥å¤±è´¥:', error);
159:       this.message.error(error.message || 'åˆ›å»ºå“è´¨æ£€æŸ¥å¤±è´¥ï¼Œè¯·é‡è¯•');
160:     } finally {
161:       this.submitting.set(false);
162:     }
163:   }
164: 
165:   cancel(): void {
166:     this.modalRef.close(false);
167:   }
168: }
````

## File: src/app/routes/quality/checks/quality-checks.component.ts
````typescript
  1: import { Component, OnInit, inject, signal } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { QualityCheckRepository } from '@core';
  4: import { STColumn } from '@delon/abc/st';
  5: import { SHARED_IMPORTS, BlueprintService, TaskService } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: import { NzModalService } from 'ng-zorro-antd/modal';
  8: import { firstValueFrom } from 'rxjs';
  9: 
 10: import { QualityCheckDetailComponent } from './quality-check-detail.component';
 11: import { QualityCheckFormComponent } from './quality-check-form.component';
 12: 
 13: @Component({
 14:   selector: 'app-quality-checks',
 15:   standalone: true,
 16:   imports: [SHARED_IMPORTS],
 17:   template: `
 18:     <page-header [title]="'è´¨é‡æ£€æŸ¥'">
 19:       <ng-template #extra>
 20:         <nz-select
 21:           [ngModel]="selectedBlueprintId()"
 22:           (ngModelChange)="selectedBlueprintId.set($event); onBlueprintChange()"
 23:           nzPlaceHolder="è¯·é€‰æ‹©è“å›¾"
 24:           style="width: 300px; margin-right: 8px;"
 25:         >
 26:           @for (blueprint of blueprintService.blueprints(); track blueprint.id) {
 27:             <nz-option [nzValue]="blueprint.id" [nzLabel]="blueprint.name"></nz-option>
 28:           }
 29:         </nz-select>
 30:         <button nz-button nzType="primary" (click)="createCheck()">
 31:           <span nz-icon nzType="plus"></span>
 32:           æ–°å»ºæ£€æŸ¥
 33:         </button>
 34:       </ng-template>
 35:     </page-header>
 36: 
 37:     <nz-card style="margin-top: 16px;">
 38:       @if (!selectedBlueprintId()) {
 39:         <nz-empty nzNotFoundContent="è¯·å…ˆé€‰æ‹©è“å›¾"></nz-empty>
 40:       } @else if (loading()) {
 41:         <div style="text-align: center; padding: 40px;">
 42:           <nz-spin nzSize="large"></nz-spin>
 43:         </div>
 44:       } @else {
 45:         <st #st [data]="checks()" [columns]="columns" [loading]="loading()" [page]="{ front: false, show: true, showSize: true }"> </st>
 46:       }
 47:     </nz-card>
 48:   `
 49: })
 50: export class QualityChecksComponent implements OnInit {
 51:   readonly blueprintService = inject(BlueprintService);
 52:   readonly taskService = inject(TaskService);
 53:   private readonly router = inject(Router);
 54:   private readonly message = inject(NzMessageService);
 55:   private readonly modal = inject(NzModalService);
 56:   private readonly qualityCheckRepo = inject(QualityCheckRepository);
 57: 
 58:   readonly selectedBlueprintId = signal<string | null>(null);
 59:   readonly loading = signal<boolean>(false);
 60:   readonly checks = signal<any[]>([]);
 61: 
 62:   columns: STColumn[] = [
 63:     { title: 'ID', index: 'id', width: 100 },
 64:     { title: 'ä»»åŠ¡æ ‡é¢˜', index: 'taskTitle', width: 200 },
 65:     { title: 'æ£€æŸ¥ç±»å‹', index: 'check_type', width: 120 },
 66:     { title: 'çŠ¶æ€', index: 'status', width: 100 },
 67:     { title: 'æ£€æŸ¥æ—¶é—´', index: 'checked_at', type: 'date', width: 180 },
 68:     { title: 'æ£€æŸ¥å‘˜ID', index: 'inspector_id', width: 120 },
 69:     {
 70:       title: 'æ“ä½œ',
 71:       width: 150,
 72:       buttons: [
 73:         {
 74:           text: 'æŸ¥çœ‹',
 75:           click: (record: any) => this.viewDetail(record.id)
 76:         }
 77:       ]
 78:     }
 79:   ];
 80: 
 81:   ngOnInit(): void {
 82:     this.loadBlueprints();
 83:   }
 84: 
 85:   async loadBlueprints(): Promise<void> {
 86:     try {
 87:       await this.blueprintService.loadBlueprints();
 88:     } catch (error) {
 89:       this.message.error('åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
 90:     }
 91:   }
 92: 
 93:   async onBlueprintChange(): Promise<void> {
 94:     const blueprintId = this.selectedBlueprintId();
 95:     if (blueprintId) {
 96:       this.loading.set(true);
 97:       try {
 98:         // å…ˆåŠ è½½ä»»åŠ¡åˆ—è¡¨
 99:         await this.taskService.loadTasksByBlueprint(blueprintId);
100: 
101:         // ç„¶ååŠ è½½æ‰€æœ‰ä»»åŠ¡çš„å“è´¨æ£€æŸ¥
102:         const tasks = this.taskService.tasks();
103:         const checkPromises = tasks.map(task => firstValueFrom(this.qualityCheckRepo.findByTaskId(task.id)));
104:         const checkArrays = await Promise.all(checkPromises);
105:         const allChecks = checkArrays.flat();
106: 
107:         // å…³è”ä»»åŠ¡æ ‡é¢˜
108:         const checksWithTask = allChecks.map(check => {
109:           const task = tasks.find(t => t.id === check.task_id);
110:           return {
111:             ...check,
112:             taskTitle: task?.title || 'ä»»åŠ¡ä¸å­˜åœ¨'
113:           };
114:         });
115: 
116:         this.checks.set(checksWithTask);
117:       } catch (error) {
118:         this.message.error('åŠ è½½å“è´¨æ£€æŸ¥æ•°æ®å¤±è´¥');
119:       } finally {
120:         this.loading.set(false);
121:       }
122:     }
123:   }
124: 
125:   createCheck(): void {
126:     const blueprintId = this.selectedBlueprintId();
127:     if (!blueprintId) {
128:       this.message.warning('è¯·å…ˆé€‰æ‹©è“å›¾');
129:       return;
130:     }
131: 
132:     const tasks = this.taskService.tasks();
133:     if (tasks.length === 0) {
134:       this.message.warning('å½“å‰è“å›¾æ²¡æœ‰ä»»åŠ¡ï¼Œè¯·å…ˆåˆ›å»ºä»»åŠ¡');
135:       return;
136:     }
137: 
138:     // ç®€å•èµ·è§ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªä»»åŠ¡ã€‚å®é™…åº”è¯¥è®©ç”¨æˆ·é€‰æ‹©ä»»åŠ¡
139:     const task = tasks[0];
140: 
141:     const modalRef = this.modal.create({
142:       nzTitle: 'åˆ›å»ºå“è´¨æ£€æŸ¥',
143:       nzContent: QualityCheckFormComponent,
144:       nzData: {
145:         task
146:       },
147:       nzWidth: 720,
148:       nzFooter: null
149:     });
150: 
151:     modalRef.afterClose.subscribe(result => {
152:       if (result) {
153:         // åˆ·æ–°åˆ—è¡¨
154:         this.onBlueprintChange();
155:       }
156:     });
157:   }
158: 
159:   viewDetail(id: string): void {
160:     this.modal.create({
161:       nzTitle: 'å“è´¨æ£€æŸ¥è¯¦æƒ…',
162:       nzContent: QualityCheckDetailComponent,
163:       nzData: {
164:         checkId: id
165:       },
166:       nzWidth: 800,
167:       nzFooter: null
168:     });
169:   }
170: }
````

## File: src/app/routes/quality/inspections/detail/quality-inspection-detail.spec.ts
````typescript
  1: import { ComponentFixture, TestBed } from '@angular/core/testing';
  2: import { ActivatedRoute, Router } from '@angular/router';
  3: import { NzMessageService } from 'ng-zorro-antd/message';
  4: 
  5: import { QualityInspectionDetailComponent } from './quality-inspection-detail';
  6: 
  7: describe('QualityInspectionDetail', () => {
  8:   let component: QualityInspectionDetailComponent;
  9:   let fixture: ComponentFixture<QualityInspectionDetailComponent>;
 10:   let mockRouter: jasmine.SpyObj<Router>;
 11:   let mockActivatedRoute: Partial<ActivatedRoute>;
 12:   let mockMessageService: jasmine.SpyObj<NzMessageService>;
 13: 
 14:   beforeEach(async () => {
 15:     mockRouter = jasmine.createSpyObj('Router', ['navigate']);
 16:     mockActivatedRoute = {
 17:       snapshot: {
 18:         paramMap: {
 19:           get: jasmine.createSpy('get').and.returnValue(null)
 20:         }
 21:       } as unknown as ActivatedRoute['snapshot']
 22:     };
 23:     mockMessageService = jasmine.createSpyObj('NzMessageService', ['info', 'error', 'success']);
 24: 
 25:     await TestBed.configureTestingModule({
 26:       imports: [QualityInspectionDetailComponent],
 27:       providers: [
 28:         { provide: Router, useValue: mockRouter },
 29:         { provide: ActivatedRoute, useValue: mockActivatedRoute },
 30:         { provide: NzMessageService, useValue: mockMessageService }
 31:       ]
 32:     }).compileComponents();
 33: 
 34:     fixture = TestBed.createComponent(QualityInspectionDetailComponent);
 35:     component = fixture.componentInstance;
 36:   });
 37: 
 38:   it('should create', () => {
 39:     expect(component).toBeTruthy();
 40:   });
 41: 
 42:   it('should initialize with loading state', () => {
 43:     expect(component.loading()).toBe(true);
 44:   });
 45: 
 46:   it('should load mock data on init when no id provided', done => {
 47:     fixture.detectChanges();
 48: 
 49:     setTimeout(() => {
 50:       expect(component.loading()).toBe(false);
 51:       expect(component.inspection()).toBeTruthy();
 52:       expect(component.inspectionItems().length).toBeGreaterThan(0);
 53:       expect(component.photos().length).toBeGreaterThan(0);
 54:       expect(component.history().length).toBeGreaterThan(0);
 55:       done();
 56:     }, 1000);
 57:   });
 58: 
 59:   it('should compute correct status color', done => {
 60:     fixture.detectChanges();
 61: 
 62:     setTimeout(() => {
 63:       expect(component.statusColor()).toBeTruthy();
 64:       done();
 65:     }, 1000);
 66:   });
 67: 
 68:   it('should compute correct status text', done => {
 69:     fixture.detectChanges();
 70: 
 71:     setTimeout(() => {
 72:       expect(component.statusText()).toBeTruthy();
 73:       done();
 74:     }, 1000);
 75:   });
 76: 
 77:   it('should compute pass rate correctly', done => {
 78:     fixture.detectChanges();
 79: 
 80:     setTimeout(() => {
 81:       const rate = component.passRate();
 82:       expect(rate).toBeGreaterThanOrEqual(0);
 83:       expect(rate).toBeLessThanOrEqual(100);
 84:       done();
 85:     }, 1000);
 86:   });
 87: 
 88:   it('should compute pass rate text correctly', done => {
 89:     fixture.detectChanges();
 90: 
 91:     setTimeout(() => {
 92:       const rateText = component.passRateText();
 93:       expect(rateText).toContain('%');
 94:       done();
 95:     }, 1000);
 96:   });
 97: 
 98:   it('should compute total items correctly', done => {
 99:     fixture.detectChanges();
100: 
101:     setTimeout(() => {
102:       expect(component.totalItems()).toBeGreaterThan(0);
103:       done();
104:     }, 1000);
105:   });
106: 
107:   it('should navigate back when goBack is called', () => {
108:     component.goBack();
109:     expect(mockRouter.navigate).toHaveBeenCalledWith(['/quality/inspections']);
110:   });
111: 
112:   it('should show info message when approve is called', () => {
113:     component.approve();
114:     expect(mockMessageService.info).toHaveBeenCalledWith('æ ¸å‡†åŠŸèƒ½å¾…å¯¦ä½œ');
115:   });
116: 
117:   it('should show info message when reject is called', () => {
118:     component.reject();
119:     expect(mockMessageService.info).toHaveBeenCalledWith('é€€å›åŠŸèƒ½å¾…å¯¦ä½œ');
120:   });
121: 
122:   it('should show info message when exportReport is called', () => {
123:     component.exportReport();
124:     expect(mockMessageService.info).toHaveBeenCalledWith('åŒ¯å‡ºå ±è¡¨åŠŸèƒ½å¾…å¯¦ä½œ');
125:   });
126: 
127:   it('should return correct result color', () => {
128:     expect(component.getResultColor('pass')).toBe('success');
129:     expect(component.getResultColor('fail')).toBe('error');
130:     expect(component.getResultColor('na')).toBe('default');
131:   });
132: 
133:   it('should return correct result text', () => {
134:     expect(component.getResultText('pass')).toBe('åˆæ ¼');
135:     expect(component.getResultText('fail')).toBe('ä¸åˆæ ¼');
136:     expect(component.getResultText('na')).toBe('ä¸é©ç”¨');
137:   });
138: });
````

## File: src/app/routes/quality/inspections/detail/quality-inspection-detail.ts
````typescript
  1: import { ChangeDetectionStrategy, Component, OnInit, computed, inject, signal } from '@angular/core';
  2: import { ActivatedRoute, Router } from '@angular/router';
  3: import { SHARED_IMPORTS } from '@shared';
  4: import { NzMessageService } from 'ng-zorro-antd/message';
  5: 
  6: interface QualityInspection {
  7:   readonly id: string;
  8:   readonly task_name: string;
  9:   readonly inspector: string;
 10:   readonly inspection_date: string;
 11:   readonly status: 'pending' | 'passed' | 'failed' | 'conditional_pass';
 12:   readonly score: number;
 13:   readonly location: string;
 14:   readonly weather: string;
 15:   readonly temperature: string;
 16: }
 17: 
 18: interface InspectionItem {
 19:   readonly id: string;
 20:   readonly category: string;
 21:   readonly item_name: string;
 22:   readonly standard: string;
 23:   readonly result: 'pass' | 'fail' | 'na';
 24:   readonly measured_value?: string;
 25:   readonly notes?: string;
 26: }
 27: 
 28: interface InspectionPhoto {
 29:   readonly id: string;
 30:   readonly url: string;
 31:   readonly description: string;
 32:   readonly timestamp: string;
 33: }
 34: 
 35: interface InspectionHistory {
 36:   readonly id: string;
 37:   readonly action: string;
 38:   readonly operator: string;
 39:   readonly timestamp: string;
 40:   readonly notes: string;
 41: }
 42: 
 43: @Component({
 44:   selector: 'app-quality-inspection-detail',
 45:   standalone: true,
 46:   imports: [SHARED_IMPORTS],
 47:   templateUrl: './quality-inspection-detail.html',
 48:   styleUrl: './quality-inspection-detail.less',
 49:   changeDetection: ChangeDetectionStrategy.OnPush
 50: })
 51: export class QualityInspectionDetailComponent implements OnInit {
 52:   private route = inject(ActivatedRoute);
 53:   private router = inject(Router);
 54:   private message = inject(NzMessageService);
 55: 
 56:   // Signals for state management
 57:   loading = signal<boolean>(true);
 58:   inspection = signal<QualityInspection | null>(null);
 59:   inspectionItems = signal<InspectionItem[]>([]);
 60:   photos = signal<InspectionPhoto[]>([]);
 61:   history = signal<InspectionHistory[]>([]);
 62:   error = signal<string | null>(null);
 63: 
 64:   // Computed properties
 65:   statusColor = computed(() => {
 66:     const insp = this.inspection();
 67:     if (!insp) return 'default';
 68:     switch (insp.status) {
 69:       case 'passed':
 70:         return 'success';
 71:       case 'failed':
 72:         return 'error';
 73:       case 'conditional_pass':
 74:         return 'warning';
 75:       case 'pending':
 76:         return 'processing';
 77:       default:
 78:         return 'default';
 79:     }
 80:   });
 81: 
 82:   statusText = computed(() => {
 83:     const insp = this.inspection();
 84:     if (!insp) return '';
 85:     switch (insp.status) {
 86:       case 'passed':
 87:         return 'åˆæ ¼';
 88:       case 'failed':
 89:         return 'ä¸åˆæ ¼';
 90:       case 'conditional_pass':
 91:         return 'æ¢ä»¶æ€§é€šé';
 92:       case 'pending':
 93:         return 'å¾…å¯©æŸ¥';
 94:       default:
 95:         return insp.status;
 96:     }
 97:   });
 98: 
 99:   passRate = computed(() => {
100:     const items = this.inspectionItems();
101:     if (items.length === 0) return 0;
102:     const passCount = items.filter(item => item.result === 'pass').length;
103:     return Math.round((passCount / items.length) * 100);
104:   });
105: 
106:   passRateText = computed(() => `${this.passRate()}%`);
107: 
108:   totalItems = computed(() => this.inspectionItems().length);
109:   passedItems = computed(() => this.inspectionItems().filter(item => item.result === 'pass').length);
110:   failedItems = computed(() => this.inspectionItems().filter(item => item.result === 'fail').length);
111: 
112:   ngOnInit(): void {
113:     const inspectionId = this.route.snapshot.paramMap.get('id');
114:     if (inspectionId) {
115:       this.loadInspection(inspectionId);
116:     } else {
117:       // Load with mock data for demonstration
118:       this.loadMockData();
119:     }
120:   }
121: 
122:   private loadMockData(): void {
123:     // Simulate API call delay
124:     setTimeout(() => {
125:       this.inspection.set({
126:         id: 'qc-001',
127:         task_name: 'äºŒæ¨“çµæ§‹æ··å‡åœŸæ¾†ç½®',
128:         inspector: 'å“ç®¡å·¥ç¨‹å¸« å¼µä¸‰',
129:         inspection_date: '2025-11-16 14:30:00',
130:         status: 'passed',
131:         score: 92,
132:         location: 'XX å•†æ¥­å¤§æ¨“ 2F',
133:         weather: 'æ™´å¤©',
134:         temperature: '22Â°C'
135:       });
136: 
137:       this.inspectionItems.set([
138:         {
139:           id: 'item-1',
140:           category: 'æ··å‡åœŸå“è³ª',
141:           item_name: 'æŠ—å£“å¼·åº¦',
142:           standard: 'â‰¥ 30 MPa',
143:           result: 'pass',
144:           measured_value: '32.5 MPa',
145:           notes: 'ç¬¦åˆè¦ç¯„è¦æ±‚'
146:         },
147:         {
148:           id: 'item-2',
149:           category: 'æ··å‡åœŸå“è³ª',
150:           item_name: 'ååº¦æ¸¬è©¦',
151:           standard: '180 Â± 20 mm',
152:           result: 'pass',
153:           measured_value: '175 mm'
154:         },
155:         {
156:           id: 'item-3',
157:           category: 'æ–½å·¥å“è³ª',
158:           item_name: 'é‹¼ç­‹ç¶ç´®',
159:           standard: 'ç¬¦åˆè¨­è¨ˆåœ–èªª',
160:           result: 'pass',
161:           notes: 'ç¶ç´®ç‰¢å›ºï¼Œé–“è·ç¬¦åˆè¦æ±‚'
162:         },
163:         {
164:           id: 'item-4',
165:           category: 'æ–½å·¥å“è³ª',
166:           item_name: 'æ¨¡æ¿æ”¯æ’',
167:           standard: 'ç©©å›ºç„¡æ™ƒå‹•',
168:           result: 'pass'
169:         },
170:         {
171:           id: 'item-5',
172:           category: 'å®‰å…¨æª¢æŸ¥',
173:           item_name: 'ä½œæ¥­äººå“¡é˜²è­·',
174:           standard: 'å®Œæ•´é…æˆ´å®‰å…¨è£å‚™',
175:           result: 'pass',
176:           notes: 'å…¨å“¡é…æˆ´å®‰å…¨å¸½èˆ‡å®‰å…¨å¸¶'
177:         },
178:         {
179:           id: 'item-6',
180:           category: 'ç’°å¢ƒæª¢æŸ¥',
181:           item_name: 'æ–½å·¥ç’°å¢ƒæ•´æ½”',
182:           standard: 'ç„¡é›œç‰©å †ç©',
183:           result: 'fail',
184:           notes: 'å±€éƒ¨å€åŸŸæœ‰ææ–™æ•£è½ï¼Œéœ€ç«‹å³æ¸…ç†'
185:         }
186:       ]);
187: 
188:       this.photos.set([
189:         {
190:           id: 'photo-1',
191:           url: 'https://via.placeholder.com/400x300?text=æ··å‡åœŸæ¾†ç½®å…¨æ™¯',
192:           description: 'æ··å‡åœŸæ¾†ç½®å…¨æ™¯ç…§ç‰‡',
193:           timestamp: '2025-11-16 14:35:00'
194:         },
195:         {
196:           id: 'photo-2',
197:           url: 'https://via.placeholder.com/400x300?text=é‹¼ç­‹ç¶ç´®ç´°éƒ¨',
198:           description: 'é‹¼ç­‹ç¶ç´®ç´°éƒ¨ç…§ç‰‡',
199:           timestamp: '2025-11-16 14:40:00'
200:         },
201:         {
202:           id: 'photo-3',
203:           url: 'https://via.placeholder.com/400x300?text=ååº¦æ¸¬è©¦',
204:           description: 'ååº¦æ¸¬è©¦ç¾å ´ç…§ç‰‡',
205:           timestamp: '2025-11-16 14:45:00'
206:         }
207:       ]);
208: 
209:       this.history.set([
210:         {
211:           id: 'hist-1',
212:           action: 'å»ºç«‹æª¢æŸ¥å–®',
213:           operator: 'å“ç®¡å·¥ç¨‹å¸« å¼µä¸‰',
214:           timestamp: '2025-11-16 14:00:00',
215:           notes: 'é–‹å§‹é€²è¡Œå“è³ªæª¢æŸ¥'
216:         },
217:         {
218:           id: 'hist-2',
219:           action: 'å®Œæˆç¾å ´æª¢æŸ¥',
220:           operator: 'å“ç®¡å·¥ç¨‹å¸« å¼µä¸‰',
221:           timestamp: '2025-11-16 15:30:00',
222:           notes: 'å®Œæˆæ‰€æœ‰é …ç›®æª¢æŸ¥'
223:         },
224:         {
225:           id: 'hist-3',
226:           action: 'åˆ¤å®šçµæœ',
227:           operator: 'å“ç®¡å·¥ç¨‹å¸« å¼µä¸‰',
228:           timestamp: '2025-11-16 15:45:00',
229:           notes: 'åˆ¤å®šç‚ºåˆæ ¼ï¼Œç’°å¢ƒæ•´æ½”é …ç›®éœ€æ”¹å–„'
230:         }
231:       ]);
232: 
233:       this.loading.set(false);
234:     }, 800);
235:   }
236: 
237:   private async loadInspection(_id: string): Promise<void> {
238:     try {
239:       this.loading.set(true);
240:       this.error.set(null);
241: 
242:       // TODO: Replace with actual API call
243:       // const data = await this.inspectionService.getById(id);
244:       // this.inspection.set(data);
245: 
246:       // For now, load mock data
247:       this.loadMockData();
248:     } catch {
249:       this.error.set('è¼‰å…¥æª¢æŸ¥è©³æƒ…å¤±æ•—');
250:       this.message.error('è¼‰å…¥å¤±æ•—');
251:       this.loading.set(false);
252:     }
253:   }
254: 
255:   goBack(): void {
256:     this.router.navigate(['/quality/inspections']);
257:   }
258: 
259:   approve(): void {
260:     this.message.info('æ ¸å‡†åŠŸèƒ½å¾…å¯¦ä½œ');
261:   }
262: 
263:   reject(): void {
264:     this.message.info('é€€å›åŠŸèƒ½å¾…å¯¦ä½œ');
265:   }
266: 
267:   exportReport(): void {
268:     this.message.info('åŒ¯å‡ºå ±è¡¨åŠŸèƒ½å¾…å¯¦ä½œ');
269:   }
270: 
271:   getResultColor(result: string): string {
272:     switch (result) {
273:       case 'pass':
274:         return 'success';
275:       case 'fail':
276:         return 'error';
277:       case 'na':
278:         return 'default';
279:       default:
280:         return 'default';
281:     }
282:   }
283: 
284:   getResultText(result: string): string {
285:     switch (result) {
286:       case 'pass':
287:         return 'åˆæ ¼';
288:       case 'fail':
289:         return 'ä¸åˆæ ¼';
290:       case 'na':
291:         return 'ä¸é©ç”¨';
292:       default:
293:         return result;
294:     }
295:   }
296: }
````

## File: src/app/routes/quality/photos/quality-photo-upload.component.ts
````typescript
  1: import { Component, inject, signal, OnInit } from '@angular/core';
  2: import { FormBuilder, FormGroup, Validators } from '@angular/forms';
  3: import { InspectionPhotoRepository } from '@core';
  4: import { SHARED_IMPORTS } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
  7: import { firstValueFrom } from 'rxjs';
  8: 
  9: export interface QualityPhotoUploadData {
 10:   inspectionId: string;
 11: }
 12: 
 13: @Component({
 14:   selector: 'app-quality-photo-upload',
 15:   standalone: true,
 16:   imports: [SHARED_IMPORTS],
 17:   template: `
 18:     <form nz-form [formGroup]="form" (ngSubmit)="submit()">
 19:       <nz-form-item>
 20:         <nz-form-label [nzSpan]="6" nzRequired>ç…§ç‰‡ç±»å‹</nz-form-label>
 21:         <nz-form-control [nzSpan]="18" nzErrorTip="è¯·é€‰æ‹©ç…§ç‰‡ç±»å‹">
 22:           <nz-select formControlName="photoType" nzPlaceHolder="é€‰æ‹©ç…§ç‰‡ç±»å‹">
 23:             <nz-option nzValue="acceptance" nzLabel="éªŒæ”¶ç…§ç‰‡"></nz-option>
 24:             <nz-option nzValue="defect" nzLabel="ç¼ºé™·ç…§ç‰‡"></nz-option>
 25:             <nz-option nzValue="before_correction" nzLabel="çº æ­£å‰"></nz-option>
 26:             <nz-option nzValue="after_correction" nzLabel="çº æ­£å"></nz-option>
 27:             <nz-option nzValue="handover" nzLabel="ç§»äº¤ç…§ç‰‡"></nz-option>
 28:           </nz-select>
 29:         </nz-form-control>
 30:       </nz-form-item>
 31: 
 32:       <nz-form-item>
 33:         <nz-form-label [nzSpan]="6">ç…§ç‰‡è¯´æ˜</nz-form-label>
 34:         <nz-form-control [nzSpan]="18">
 35:           <textarea
 36:             nz-input
 37:             formControlName="caption"
 38:             [nzAutosize]="{ minRows: 2, maxRows: 4 }"
 39:             placeholder="è¯·è¾“å…¥ç…§ç‰‡è¯´æ˜ï¼ˆå¯é€‰ï¼‰"
 40:           ></textarea>
 41:         </nz-form-control>
 42:       </nz-form-item>
 43: 
 44:       <nz-form-item>
 45:         <nz-form-label [nzSpan]="6" nzRequired>é€‰æ‹©ç…§ç‰‡</nz-form-label>
 46:         <nz-form-control [nzSpan]="18" nzErrorTip="è¯·é€‰æ‹©ç…§ç‰‡æ–‡ä»¶">
 47:           <nz-upload nzType="drag" [nzMultiple]="false" [nzBeforeUpload]="beforeUpload" nzAccept="image/*">
 48:             <p class="ant-upload-drag-icon">
 49:               <span nz-icon nzType="inbox"></span>
 50:             </p>
 51:             <p class="ant-upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸä¸Šä¼ </p>
 52:             <p class="ant-upload-hint">æ”¯æŒ JPGã€PNGã€GIF ç­‰å›¾ç‰‡æ ¼å¼</p>
 53:           </nz-upload>
 54:           @if (selectedFile()) {
 55:             <div style="margin-top: 8px;">
 56:               <nz-tag nzColor="green">
 57:                 <span nz-icon nzType="file-image"></span>
 58:                 {{ selectedFile()?.name }}
 59:               </nz-tag>
 60:             </div>
 61:           }
 62:         </nz-form-control>
 63:       </nz-form-item>
 64: 
 65:       <nz-alert
 66:         nzType="info"
 67:         nzMessage="æç¤º"
 68:         nzDescription="ç…§ç‰‡ä¸Šä¼ åå°†å…³è”åˆ°å½“å‰éªŒæ”¶è®°å½•ã€‚å®é™…é¡¹ç›®ä¸­ï¼Œç…§ç‰‡ä¼šå…ˆä¸Šä¼ åˆ° Supabase Storageï¼Œç„¶ååˆ›å»º document è®°å½•ã€‚"
 69:         nzShowIcon
 70:         style="margin-bottom: 16px;"
 71:       ></nz-alert>
 72: 
 73:       <nz-form-item>
 74:         <nz-form-control [nzSpan]="18" [nzOffset]="6">
 75:           <button nz-button nzType="default" type="button" (click)="cancel()" [disabled]="submitting()" style="margin-right: 8px;">
 76:             å–æ¶ˆ
 77:           </button>
 78:           <button nz-button nzType="primary" type="submit" [nzLoading]="submitting()" [disabled]="!canSubmit() || submitting()">
 79:             ä¸Šä¼ 
 80:           </button>
 81:         </nz-form-control>
 82:       </nz-form-item>
 83:     </form>
 84:   `
 85: })
 86: export class QualityPhotoUploadComponent implements OnInit {
 87:   private fb = inject(FormBuilder);
 88:   private modalRef = inject(NzModalRef);
 89:   private message = inject(NzMessageService);
 90:   private inspectionPhotoRepo = inject(InspectionPhotoRepository);
 91: 
 92:   readonly data: QualityPhotoUploadData = inject(NZ_MODAL_DATA);
 93:   readonly submitting = signal(false);
 94:   readonly selectedFile = signal<File | null>(null);
 95: 
 96:   form!: FormGroup;
 97: 
 98:   // File upload handler
 99:   beforeUpload = (file: any): boolean => {
100:     // Validate file type
101:     const isImage = file.type?.startsWith('image/');
102:     if (!isImage) {
103:       this.message.error('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼');
104:       return false;
105:     }
106: 
107:     // Validate file size (max 5MB)
108:     const isLt5M = file.size / 1024 / 1024 < 5;
109:     if (!isLt5M) {
110:       this.message.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MBï¼');
111:       return false;
112:     }
113: 
114:     // Store the original file
115:     if (file.originFileObj) {
116:       this.selectedFile.set(file.originFileObj);
117:     } else {
118:       this.selectedFile.set(file);
119:     }
120:     return false; // Prevent automatic upload
121:   };
122: 
123:   ngOnInit(): void {
124:     this.form = this.fb.group({
125:       photoType: ['acceptance', [Validators.required]],
126:       caption: ['']
127:     });
128:   }
129: 
130:   canSubmit(): boolean {
131:     return this.form.valid && this.selectedFile() !== null;
132:   }
133: 
134:   async submit(): Promise<void> {
135:     if (!this.canSubmit()) {
136:       this.message.warning('è¯·é€‰æ‹©ç…§ç‰‡æ–‡ä»¶');
137:       return;
138:     }
139: 
140:     this.submitting.set(true);
141:     try {
142:       const formValue = this.form.value;
143:       const file = this.selectedFile();
144: 
145:       if (!file) {
146:         throw new Error('æœªé€‰æ‹©æ–‡ä»¶');
147:       }
148: 
149:       // TODO: å®é™…å®ç°ä¸­ï¼Œéœ€è¦å…ˆä¸Šä¼ åˆ° Supabase Storageï¼Œç„¶ååˆ›å»º document è®°å½•
150:       // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ document_id
151:       const tempDocumentId = `temp-qc-${Date.now()}`;
152: 
153:       const photoRecord = {
154:         inspection_id: this.data.inspectionId,
155:         document_id: tempDocumentId,
156:         photo_type: formValue.photoType,
157:         caption: formValue.caption || null,
158:         sequence_order: 0,
159:         uploaded_by: 'temp-user-id' // å®é™…åº”è¯¥ä»å½“å‰ç™»å½•ç”¨æˆ·è·å–
160:       };
161: 
162:       await firstValueFrom(this.inspectionPhotoRepo.create(photoRecord));
163: 
164:       this.message.success('ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰');
165:       this.modalRef.close(true);
166:     } catch (error: any) {
167:       console.error('ä¸Šä¼ ç…§ç‰‡å¤±è´¥:', error);
168:       this.message.error(error.message || 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
169:     } finally {
170:       this.submitting.set(false);
171:     }
172:   }
173: 
174:   cancel(): void {
175:     this.modalRef.close(false);
176:   }
177: }
````

## File: src/app/routes/quality/photos/quality-photo-viewer.component.ts
````typescript
 1: import { Component, inject } from '@angular/core';
 2: import { SHARED_IMPORTS, InspectionPhoto } from '@shared';
 3: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
 4: 
 5: export interface QualityPhotoViewData {
 6:   photo: InspectionPhoto;
 7:   photoUrl: string;
 8: }
 9: 
10: @Component({
11:   selector: 'app-quality-photo-viewer',
12:   standalone: true,
13:   imports: [SHARED_IMPORTS],
14:   template: `
15:     <div style="text-align: center;">
16:       <img [src]="data.photoUrl" [alt]="data.photo.caption || 'éªŒæ”¶ç…§ç‰‡'" style="max-width: 100%; max-height: 70vh; object-fit: contain;" />
17:     </div>
18: 
19:     <nz-divider></nz-divider>
20: 
21:     <nz-descriptions nzBordered [nzColumn]="1" nzSize="small">
22:       @if (data.photo.caption) {
23:         <nz-descriptions-item nzTitle="è¯´æ˜">{{ data.photo.caption }}</nz-descriptions-item>
24:       }
25:       <nz-descriptions-item nzTitle="ç±»å‹">
26:         @switch (data.photo.photo_type) {
27:           @case ('acceptance') {
28:             <nz-tag nzColor="blue">éªŒæ”¶ç…§ç‰‡</nz-tag>
29:           }
30:           @case ('defect') {
31:             <nz-tag nzColor="red">ç¼ºé™·ç…§ç‰‡</nz-tag>
32:           }
33:           @case ('before_correction') {
34:             <nz-tag nzColor="orange">çº æ­£å‰</nz-tag>
35:           }
36:           @case ('after_correction') {
37:             <nz-tag nzColor="green">çº æ­£å</nz-tag>
38:           }
39:           @case ('handover') {
40:             <nz-tag nzColor="purple">ç§»äº¤ç…§ç‰‡</nz-tag>
41:           }
42:           @default {
43:             <nz-tag>{{ data.photo.photo_type }}</nz-tag>
44:           }
45:         }
46:       </nz-descriptions-item>
47:       <nz-descriptions-item nzTitle="ä¸Šä¼ æ—¶é—´">
48:         {{ data.photo.uploaded_at | date: 'yyyy-MM-dd HH:mm:ss' }}
49:       </nz-descriptions-item>
50:       <nz-descriptions-item nzTitle="ä¸Šä¼ è€…ID">{{ data.photo.uploaded_by }}</nz-descriptions-item>
51:     </nz-descriptions>
52: 
53:     <div style="margin-top: 16px; text-align: right;">
54:       <button nz-button nzType="default" (click)="close()">å…³é—­</button>
55:     </div>
56:   `
57: })
58: export class QualityPhotoViewerComponent {
59:   private modalRef = inject(NzModalRef);
60:   readonly data: QualityPhotoViewData = inject(NZ_MODAL_DATA);
61: 
62:   close(): void {
63:     this.modalRef.close();
64:   }
65: }
````

## File: src/app/routes/quality/photos/quality-photos.component.ts
````typescript
  1: import { Component, OnInit, inject, signal } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { InspectionRepository, InspectionPhotoRepository } from '@core';
  4: import { SHARED_IMPORTS, BlueprintService, TaskService, InspectionPhoto } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: import { NzModalService } from 'ng-zorro-antd/modal';
  7: import { firstValueFrom } from 'rxjs';
  8: 
  9: import { QualityPhotoUploadComponent } from './quality-photo-upload.component';
 10: import { QualityPhotoViewerComponent } from './quality-photo-viewer.component';
 11: 
 12: @Component({
 13:   selector: 'app-quality-photos',
 14:   standalone: true,
 15:   imports: [SHARED_IMPORTS],
 16:   template: `
 17:     <page-header [title]="'éªŒæ”¶ç…§ç‰‡'">
 18:       <ng-template #extra>
 19:         <nz-select
 20:           [ngModel]="selectedBlueprintId()"
 21:           (ngModelChange)="selectedBlueprintId.set($event); onBlueprintChange()"
 22:           nzPlaceHolder="è¯·é€‰æ‹©è“å›¾"
 23:           style="width: 300px; margin-right: 8px;"
 24:         >
 25:           @for (blueprint of blueprintService.blueprints(); track blueprint.id) {
 26:             <nz-option [nzValue]="blueprint.id" [nzLabel]="blueprint.name"></nz-option>
 27:           }
 28:         </nz-select>
 29:         <button nz-button nzType="primary" (click)="uploadPhoto()">
 30:           <span nz-icon nzType="upload"></span>
 31:           ä¸Šä¼ ç…§ç‰‡
 32:         </button>
 33:       </ng-template>
 34:     </page-header>
 35: 
 36:     <nz-card style="margin-top: 16px;">
 37:       @if (!selectedBlueprintId()) {
 38:         <nz-empty nzNotFoundContent="è¯·å…ˆé€‰æ‹©è“å›¾"></nz-empty>
 39:       } @else if (loading()) {
 40:         <div style="text-align: center; padding: 40px;">
 41:           <nz-spin nzSize="large"></nz-spin>
 42:         </div>
 43:       } @else if (photos().length === 0) {
 44:         <nz-empty nzNotFoundContent="æš‚æ— ç…§ç‰‡"></nz-empty>
 45:       } @else {
 46:         <nz-spin [nzSpinning]="loading()">
 47:           <div nz-row [nzGutter]="[16, 16]">
 48:             @for (photo of photos(); track photo.id) {
 49:               <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6" [nzXl]="4">
 50:                 <nz-card [nzHoverable]="true" [nzCover]="cover" style="cursor: pointer;" (click)="viewPhoto(photo)">
 51:                   <ng-template #cover>
 52:                     <div
 53:                       style="width: 100%; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;"
 54:                     >
 55:                       <span nz-icon nzType="picture" nzTheme="outline" style="font-size: 48px; color: #ccc;"></span>
 56:                     </div>
 57:                   </ng-template>
 58:                   <nz-card-meta [nzTitle]="photo.caption || 'æ— æ ‡é¢˜'" [nzDescription]="photo.photo_type || 'éªŒæ”¶ç…§ç‰‡'"></nz-card-meta>
 59:                   <div style="margin-top: 8px; font-size: 12px; color: #999;">
 60:                     {{ photo.uploaded_at | date: 'yyyy-MM-dd HH:mm' }}
 61:                   </div>
 62:                 </nz-card>
 63:               </div>
 64:             }
 65:           </div>
 66:         </nz-spin>
 67:       }
 68:     </nz-card>
 69:   `
 70: })
 71: export class QualityPhotosComponent implements OnInit {
 72:   readonly blueprintService = inject(BlueprintService);
 73:   readonly taskService = inject(TaskService);
 74:   private readonly inspectionRepo = inject(InspectionRepository);
 75:   private readonly inspectionPhotoRepo = inject(InspectionPhotoRepository);
 76:   private readonly router = inject(Router);
 77:   private readonly message = inject(NzMessageService);
 78:   private readonly modal = inject(NzModalService);
 79: 
 80:   readonly selectedBlueprintId = signal<string | null>(null);
 81:   readonly loading = signal<boolean>(false);
 82:   readonly photos = signal<InspectionPhoto[]>([]);
 83: 
 84:   ngOnInit(): void {
 85:     this.loadBlueprints();
 86:   }
 87: 
 88:   async loadBlueprints(): Promise<void> {
 89:     try {
 90:       await this.blueprintService.loadBlueprints();
 91:     } catch (error) {
 92:       this.message.error('åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
 93:     }
 94:   }
 95: 
 96:   async onBlueprintChange(): Promise<void> {
 97:     const blueprintId = this.selectedBlueprintId();
 98:     if (!blueprintId) return;
 99: 
100:     this.loading.set(true);
101:     try {
102:       // å…ˆåŠ è½½ä»»åŠ¡åˆ—è¡¨
103:       await this.taskService.loadTasksByBlueprint(blueprintId);
104: 
105:       // ç„¶ååŠ è½½æ‰€æœ‰ä»»åŠ¡çš„éªŒæ”¶è®°å½•
106:       const tasks = this.taskService.tasks();
107:       const inspectionPromises = tasks.map(task => firstValueFrom(this.inspectionRepo.findByTaskId(task.id)));
108:       const inspectionArrays = await Promise.all(inspectionPromises);
109:       const allInspections = inspectionArrays.flat();
110: 
111:       // åŠ è½½æ‰€æœ‰éªŒæ”¶è®°å½•çš„ç…§ç‰‡
112:       const photoPromises = allInspections.map(inspection => firstValueFrom(this.inspectionPhotoRepo.findByInspectionId(inspection.id)));
113:       const photoArrays = await Promise.all(photoPromises);
114:       const allPhotos = photoArrays.flat();
115: 
116:       this.photos.set(allPhotos);
117:     } catch (error) {
118:       this.message.error('åŠ è½½éªŒæ”¶ç…§ç‰‡å¤±è´¥');
119:     } finally {
120:       this.loading.set(false);
121:     }
122:   }
123: 
124:   async uploadPhoto(): Promise<void> {
125:     const blueprintId = this.selectedBlueprintId();
126:     if (!blueprintId) {
127:       this.message.warning('è¯·å…ˆé€‰æ‹©è“å›¾');
128:       return;
129:     }
130: 
131:     const tasks = this.taskService.tasks();
132:     if (tasks.length === 0) {
133:       this.message.warning('å½“å‰è“å›¾æ²¡æœ‰ä»»åŠ¡ï¼Œè¯·å…ˆåˆ›å»ºä»»åŠ¡');
134:       return;
135:     }
136: 
137:     // éœ€è¦å…ˆæœ‰éªŒæ”¶è®°å½•æ‰èƒ½ä¸Šä¼ ç…§ç‰‡
138:     const inspections = await firstValueFrom(this.inspectionRepo.findByTaskId(tasks[0].id));
139: 
140:     if (inspections.length === 0) {
141:       this.message.warning('è¯·å…ˆåˆ›å»ºéªŒæ”¶è®°å½•ï¼Œç„¶åæ‰èƒ½ä¸Šä¼ ç…§ç‰‡');
142:       return;
143:     }
144: 
145:     const modalRef = this.modal.create({
146:       nzTitle: 'ä¸Šä¼ éªŒæ”¶ç…§ç‰‡',
147:       nzContent: QualityPhotoUploadComponent,
148:       nzData: {
149:         inspectionId: inspections[0].id // ä½¿ç”¨ç¬¬ä¸€ä¸ªéªŒæ”¶è®°å½•ï¼Œå®é™…åº”è¯¥è®©ç”¨æˆ·é€‰æ‹©
150:       },
151:       nzWidth: 600,
152:       nzFooter: null
153:     });
154: 
155:     modalRef.afterClose.subscribe(result => {
156:       if (result) {
157:         // åˆ·æ–°åˆ—è¡¨
158:         this.onBlueprintChange();
159:       }
160:     });
161:   }
162: 
163:   viewPhoto(photo: InspectionPhoto): void {
164:     this.modal.create({
165:       nzTitle: 'æŸ¥çœ‹éªŒæ”¶ç…§ç‰‡',
166:       nzContent: QualityPhotoViewerComponent,
167:       nzData: {
168:         photo,
169:         photoUrl: this.getPhotoUrl(photo.document_id)
170:       },
171:       nzWidth: 900,
172:       nzFooter: null
173:     });
174:   }
175: 
176:   getPhotoUrl(documentId: string): string {
177:     // TODO: ä»æ–‡æ¡£æœåŠ¡è·å–å›¾ç‰‡URL
178:     return `/api/documents/${documentId}/download`;
179:   }
180: }
````

## File: src/app/routes/quality/results/inspection-detail.component.ts
````typescript
  1: import { Component, inject, signal, OnInit, computed } from '@angular/core';
  2: import { InspectionRepository, Inspection } from '@core';
  3: import { SHARED_IMPORTS } from '@shared';
  4: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
  5: import { firstValueFrom } from 'rxjs';
  6: 
  7: export interface InspectionDetailData {
  8:   inspectionId: string;
  9: }
 10: 
 11: @Component({
 12:   selector: 'app-inspection-detail',
 13:   standalone: true,
 14:   imports: [SHARED_IMPORTS],
 15:   template: `
 16:     @if (loading()) {
 17:       <div style="text-align: center; padding: 40px;">
 18:         <nz-spin nzSize="large"></nz-spin>
 19:       </div>
 20:     } @else if (inspection()) {
 21:       <nz-descriptions nzBordered [nzColumn]="2">
 22:         <nz-descriptions-item nzTitle="éªŒæ”¶ID" [nzSpan]="2">{{ inspection()!.id }}</nz-descriptions-item>
 23:         <nz-descriptions-item nzTitle="ä»»åŠ¡ID" [nzSpan]="2">{{ inspection()!.task_id }}</nz-descriptions-item>
 24:         <nz-descriptions-item nzTitle="éªŒæ”¶ç±»å‹" [nzSpan]="1">
 25:           @switch (inspection()!.inspection_type) {
 26:             @case ('preliminary') {
 27:               <nz-tag nzColor="blue">åˆæ­¥éªŒæ”¶</nz-tag>
 28:             }
 29:             @case ('final') {
 30:               <nz-tag nzColor="purple">æœ€ç»ˆéªŒæ”¶</nz-tag>
 31:             }
 32:             @case ('warranty') {
 33:               <nz-tag nzColor="orange">ä¿ä¿®éªŒæ”¶</nz-tag>
 34:             }
 35:             @case ('handover') {
 36:               <nz-tag nzColor="cyan">ç§»äº¤éªŒæ”¶</nz-tag>
 37:             }
 38:             @default {
 39:               <nz-tag>{{ inspection()!.inspection_type }}</nz-tag>
 40:             }
 41:           }
 42:         </nz-descriptions-item>
 43:         <nz-descriptions-item nzTitle="çŠ¶æ€" [nzSpan]="1">
 44:           @switch (inspection()!.status) {
 45:             @case ('pending') {
 46:               <nz-tag nzColor="default">å¾…éªŒæ”¶</nz-tag>
 47:             }
 48:             @case ('in_progress') {
 49:               <nz-tag nzColor="blue">éªŒæ”¶ä¸­</nz-tag>
 50:             }
 51:             @case ('accepted') {
 52:               <nz-tag nzColor="green">å·²æ¥å—</nz-tag>
 53:             }
 54:             @case ('rejected') {
 55:               <nz-tag nzColor="red">å·²æ‹’ç»</nz-tag>
 56:             }
 57:             @case ('conditional_accept') {
 58:               <nz-tag nzColor="orange">æœ‰æ¡ä»¶æ¥å—</nz-tag>
 59:             }
 60:             @default {
 61:               <nz-tag>{{ inspection()!.status }}</nz-tag>
 62:             }
 63:           }
 64:         </nz-descriptions-item>
 65:         <nz-descriptions-item nzTitle="éªŒæ”¶é¡¹ç›®" [nzSpan]="2">
 66:           @if (inspectionItemsArray().length > 0) {
 67:             <ul style="margin: 0; padding-left: 20px;">
 68:               @for (item of inspectionItemsArray(); track $index) {
 69:                 <li>{{ item }}</li>
 70:               }
 71:             </ul>
 72:           } @else {
 73:             <span>æ— </span>
 74:           }
 75:         </nz-descriptions-item>
 76:         @if (defectsArray().length > 0) {
 77:           <nz-descriptions-item nzTitle="å‘ç°ç¼ºé™·" [nzSpan]="2">
 78:             <ul style="margin: 0; padding-left: 20px;">
 79:               @for (defect of defectsArray(); track $index) {
 80:                 <li style="color: #ff4d4f;">{{ defect }}</li>
 81:               }
 82:             </ul>
 83:           </nz-descriptions-item>
 84:         }
 85:         @if (inspection()!.acceptance_criteria) {
 86:           <nz-descriptions-item nzTitle="éªŒæ”¶æ ‡å‡†" [nzSpan]="2">
 87:             <pre style="white-space: pre-wrap; margin: 0;">{{ inspection()!.acceptance_criteria }}</pre>
 88:           </nz-descriptions-item>
 89:         }
 90:         @if (inspection()!.findings) {
 91:           <nz-descriptions-item nzTitle="éªŒæ”¶å‘ç°" [nzSpan]="2">
 92:             <pre style="white-space: pre-wrap; margin: 0;">{{ inspection()!.findings }}</pre>
 93:           </nz-descriptions-item>
 94:         }
 95:         @if (inspection()!.corrective_actions) {
 96:           <nz-descriptions-item nzTitle="çº æ­£æªæ–½" [nzSpan]="2">
 97:             <pre style="white-space: pre-wrap; margin: 0;">{{ inspection()!.corrective_actions }}</pre>
 98:           </nz-descriptions-item>
 99:         }
100:         <nz-descriptions-item nzTitle="è´£ä»»è½¬ç§»" [nzSpan]="1">
101:           @if (inspection()!.responsibility_transferred) {
102:             <nz-tag nzColor="green">å·²è½¬ç§»</nz-tag>
103:           } @else {
104:             <nz-tag nzColor="default">æœªè½¬ç§»</nz-tag>
105:           }
106:         </nz-descriptions-item>
107:         @if (inspection()!.transfer_date) {
108:           <nz-descriptions-item nzTitle="è½¬ç§»æ—¥æœŸ" [nzSpan]="1">
109:             {{ inspection()!.transfer_date }}
110:           </nz-descriptions-item>
111:         }
112:         <nz-descriptions-item nzTitle="éªŒæ”¶äººID" [nzSpan]="1">{{ inspection()!.inspector_id }}</nz-descriptions-item>
113:         <nz-descriptions-item nzTitle="éªŒæ”¶æ—¶é—´" [nzSpan]="1">
114:           {{ inspection()!.inspected_at | date: 'yyyy-MM-dd HH:mm:ss' }}
115:         </nz-descriptions-item>
116:         @if (inspection()!.completed_at) {
117:           <nz-descriptions-item nzTitle="å®Œæˆæ—¶é—´" [nzSpan]="2">
118:             {{ inspection()!.completed_at | date: 'yyyy-MM-dd HH:mm:ss' }}
119:           </nz-descriptions-item>
120:         }
121:       </nz-descriptions>
122: 
123:       <div style="margin-top: 16px; text-align: right;">
124:         <button nz-button nzType="default" (click)="close()">å…³é—­</button>
125:       </div>
126:     } @else {
127:       <nz-empty nzNotFoundContent="éªŒæ”¶è®°å½•ä¸å­˜åœ¨"></nz-empty>
128:     }
129:   `
130: })
131: export class InspectionDetailComponent implements OnInit {
132:   private modalRef = inject(NzModalRef);
133:   private inspectionRepo = inject(InspectionRepository);
134: 
135:   readonly data: InspectionDetailData = inject(NZ_MODAL_DATA);
136:   readonly loading = signal(false);
137:   readonly inspection = signal<Inspection | null>(null);
138: 
139:   readonly inspectionItemsArray = computed(() => {
140:     const insp = this.inspection();
141:     if (!insp || !insp.inspection_items) return [];
142: 
143:     if (Array.isArray(insp.inspection_items)) {
144:       return insp.inspection_items as string[];
145:     } else if (typeof insp.inspection_items === 'object') {
146:       return Object.values(insp.inspection_items).filter((v): v is string => typeof v === 'string');
147:     }
148:     return [];
149:   });
150: 
151:   readonly defectsArray = computed(() => {
152:     const insp = this.inspection();
153:     if (!insp || !insp.defects_found) return [];
154: 
155:     if (Array.isArray(insp.defects_found)) {
156:       return insp.defects_found as string[];
157:     } else if (typeof insp.defects_found === 'object') {
158:       return Object.values(insp.defects_found).filter((v): v is string => typeof v === 'string');
159:     }
160:     return [];
161:   });
162: 
163:   async ngOnInit(): Promise<void> {
164:     await this.loadInspection();
165:   }
166: 
167:   async loadInspection(): Promise<void> {
168:     this.loading.set(true);
169:     try {
170:       const result = await firstValueFrom(this.inspectionRepo.findById(this.data.inspectionId));
171:       this.inspection.set(result);
172:     } catch (error) {
173:       console.error('åŠ è½½éªŒæ”¶è®°å½•è¯¦æƒ…å¤±è´¥:', error);
174:       this.inspection.set(null);
175:     } finally {
176:       this.loading.set(false);
177:     }
178:   }
179: 
180:   close(): void {
181:     this.modalRef.close();
182:   }
183: }
````

## File: src/app/routes/quality/results/quality-results.component.ts
````typescript
  1: import { Component, OnInit, inject, signal, computed } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { InspectionRepository } from '@core';
  4: import { STColumn } from '@delon/abc/st';
  5: import { SHARED_IMPORTS, BlueprintService, TaskService } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: import { NzModalService } from 'ng-zorro-antd/modal';
  8: import { firstValueFrom } from 'rxjs';
  9: 
 10: import { InspectionDetailComponent } from './inspection-detail.component';
 11: 
 12: @Component({
 13:   selector: 'app-quality-results',
 14:   standalone: true,
 15:   imports: [SHARED_IMPORTS],
 16:   template: `
 17:     <page-header [title]="'éªŒæ”¶ç»“æœ'">
 18:       <ng-template #extra>
 19:         <nz-select
 20:           [ngModel]="selectedBlueprintId()"
 21:           (ngModelChange)="selectedBlueprintId.set($event); onBlueprintChange()"
 22:           nzPlaceHolder="è¯·é€‰æ‹©è“å›¾"
 23:           style="width: 300px; margin-right: 8px;"
 24:         >
 25:           @for (blueprint of blueprintService.blueprints(); track blueprint.id) {
 26:             <nz-option [nzValue]="blueprint.id" [nzLabel]="blueprint.name"></nz-option>
 27:           }
 28:         </nz-select>
 29:         <nz-select [ngModel]="selectedStatus()" (ngModelChange)="selectedStatus.set($event)" nzPlaceHolder="ç­›é€‰çŠ¶æ€" style="width: 150px;">
 30:           <nz-option [nzValue]="'all'" nzLabel="å…¨éƒ¨"></nz-option>
 31:           <nz-option [nzValue]="'passed'" nzLabel="é€šè¿‡"></nz-option>
 32:           <nz-option [nzValue]="'failed'" nzLabel="ä¸é€šè¿‡"></nz-option>
 33:           <nz-option [nzValue]="'pending'" nzLabel="å¾…éªŒæ”¶"></nz-option>
 34:         </nz-select>
 35:       </ng-template>
 36:     </page-header>
 37: 
 38:     <nz-card style="margin-top: 16px;">
 39:       @if (!selectedBlueprintId()) {
 40:         <nz-empty nzNotFoundContent="è¯·å…ˆé€‰æ‹©è“å›¾"></nz-empty>
 41:       } @else if (loading()) {
 42:         <div style="text-align: center; padding: 40px;">
 43:           <nz-spin nzSize="large"></nz-spin>
 44:         </div>
 45:       } @else {
 46:         <st #st [data]="filteredResults()" [columns]="columns" [loading]="loading()" [page]="{ front: false, show: true, showSize: true }">
 47:           <ng-template #result let-record>
 48:             @switch (record.result) {
 49:               @case ('passed') {
 50:                 <nz-tag nzColor="success">é€šè¿‡</nz-tag>
 51:               }
 52:               @case ('failed') {
 53:                 <nz-tag nzColor="error">ä¸é€šè¿‡</nz-tag>
 54:               }
 55:               @case ('pending') {
 56:                 <nz-tag nzColor="default">å¾…éªŒæ”¶</nz-tag>
 57:               }
 58:             }
 59:           </ng-template>
 60:         </st>
 61:       }
 62:     </nz-card>
 63:   `
 64: })
 65: export class QualityResultsComponent implements OnInit {
 66:   readonly blueprintService = inject(BlueprintService);
 67:   readonly taskService = inject(TaskService);
 68:   private readonly inspectionRepo = inject(InspectionRepository);
 69:   private readonly router = inject(Router);
 70:   private readonly message = inject(NzMessageService);
 71:   private readonly modal = inject(NzModalService);
 72: 
 73:   readonly selectedBlueprintId = signal<string | null>(null);
 74:   readonly selectedStatus = signal<string>('all');
 75:   readonly loading = signal<boolean>(false);
 76:   readonly results = signal<any[]>([]);
 77: 
 78:   readonly filteredResults = computed(() => {
 79:     const status = this.selectedStatus();
 80:     const allResults = this.results();
 81:     if (status === 'all') {
 82:       return allResults;
 83:     }
 84:     return allResults.filter(r => r.result === status);
 85:   });
 86: 
 87:   columns: STColumn[] = [
 88:     { title: 'ID', index: 'id', width: 100 },
 89:     { title: 'éªŒæ”¶åç§°', index: 'name', width: 200 },
 90:     { title: 'éªŒæ”¶ç±»å‹', index: 'type', width: 120 },
 91:     { title: 'ç»“æœ', index: 'result', width: 100, render: 'result' },
 92:     { title: 'éªŒæ”¶æ—¥æœŸ', index: 'inspection_date', type: 'date', width: 120 },
 93:     { title: 'éªŒæ”¶äºº', index: 'inspector', width: 120 },
 94:     { title: 'å¤‡æ³¨', index: 'notes', width: 200 },
 95:     { title: 'åˆ›å»ºæ—¶é—´', index: 'created_at', type: 'date', width: 180 },
 96:     {
 97:       title: 'æ“ä½œ',
 98:       width: 150,
 99:       buttons: [
100:         {
101:           text: 'æŸ¥çœ‹',
102:           click: (record: any) => this.viewDetail(record.id)
103:         }
104:       ]
105:     }
106:   ];
107: 
108:   ngOnInit(): void {
109:     this.loadBlueprints();
110:   }
111: 
112:   async loadBlueprints(): Promise<void> {
113:     try {
114:       await this.blueprintService.loadBlueprints();
115:     } catch (error) {
116:       this.message.error('åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
117:     }
118:   }
119: 
120:   async onBlueprintChange(): Promise<void> {
121:     const blueprintId = this.selectedBlueprintId();
122:     if (!blueprintId) return;
123: 
124:     this.loading.set(true);
125:     try {
126:       // å…ˆåŠ è½½ä»»åŠ¡åˆ—è¡¨
127:       await this.taskService.loadTasksByBlueprint(blueprintId);
128: 
129:       // ç„¶ååŠ è½½æ‰€æœ‰ä»»åŠ¡çš„éªŒæ”¶è®°å½•
130:       const tasks = this.taskService.tasks();
131:       const inspectionPromises = tasks.map(task => firstValueFrom(this.inspectionRepo.findByTaskId(task.id)));
132:       const inspectionArrays = await Promise.all(inspectionPromises);
133:       const allInspections = inspectionArrays.flat();
134: 
135:       // å…³è”ä»»åŠ¡æ ‡é¢˜å’Œæ˜ å°„åˆ°ç»“æœæ ¼å¼
136:       const inspectionsWithTask = allInspections.map(inspection => {
137:         const task = tasks.find(t => t.id === inspection.task_id);
138:         return {
139:           id: inspection.id,
140:           name: `éªŒæ”¶-${task?.title || 'æœªçŸ¥ä»»åŠ¡'}`,
141:           type: inspection.inspection_type,
142:           result: inspection.status === 'accepted' ? 'passed' : inspection.status === 'rejected' ? 'failed' : 'pending',
143:           inspection_date: inspection.inspected_at,
144:           inspector: inspection.inspector_id,
145:           notes: inspection.findings || '',
146:           created_at: inspection.inspected_at
147:         };
148:       });
149: 
150:       this.results.set(inspectionsWithTask);
151:     } catch (error) {
152:       this.message.error('åŠ è½½éªŒæ”¶ç»“æœæ•°æ®å¤±è´¥');
153:     } finally {
154:       this.loading.set(false);
155:     }
156:   }
157: 
158:   viewDetail(id: string): void {
159:     this.modal.create({
160:       nzTitle: 'éªŒæ”¶è®°å½•è¯¦æƒ…',
161:       nzContent: InspectionDetailComponent,
162:       nzData: {
163:         inspectionId: id
164:       },
165:       nzWidth: 900,
166:       nzFooter: null
167:     });
168:   }
169: }
````

## File: src/app/routes/quality/routes.ts
````typescript
 1: import { Routes } from '@angular/router';
 2: 
 3: export const QUALITY_ROUTES: Routes = [
 4:   {
 5:     path: '',
 6:     redirectTo: 'checks',
 7:     pathMatch: 'full'
 8:   },
 9:   {
10:     path: 'checks',
11:     loadComponent: () => import('./checks/quality-checks.component').then(m => m.QualityChecksComponent)
12:   },
13:   {
14:     path: 'checks/:id',
15:     loadComponent: () => import('./checks/detail/quality-check-detail.component').then(m => m.QualityCheckDetailComponent)
16:   },
17:   {
18:     path: 'submit',
19:     loadComponent: () => import('./submit/quality-submit.component').then(m => m.QualitySubmitComponent)
20:   },
21:   {
22:     path: 'inspections',
23:     loadComponent: () => import('./inspections/quality-inspections.component').then(m => m.QualityInspectionsComponent)
24:   },
25:   {
26:     path: 'inspections/detail',
27:     loadComponent: () => import('./inspections/detail/quality-inspection-detail').then(m => m.QualityInspectionDetailComponent)
28:   },
29:   {
30:     path: 'photos',
31:     loadComponent: () => import('./photos/quality-photos.component').then(m => m.QualityPhotosComponent)
32:   },
33:   {
34:     path: 'results',
35:     loadComponent: () => import('./results/quality-results.component').then(m => m.QualityResultsComponent)
36:   }
37: ];
````

## File: src/app/routes/tasks/photos/photo-upload.component.ts
````typescript
  1: import { Component, inject, signal, OnInit } from '@angular/core';
  2: import { FormBuilder, FormGroup, Validators } from '@angular/forms';
  3: import { ReportPhotoRepository } from '@core';
  4: import { SHARED_IMPORTS } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
  7: import { firstValueFrom } from 'rxjs';
  8: 
  9: export interface PhotoUploadData {
 10:   reportId: string;
 11:   reportType: 'daily' | 'quality';
 12: }
 13: 
 14: @Component({
 15:   selector: 'app-photo-upload',
 16:   standalone: true,
 17:   imports: [SHARED_IMPORTS],
 18:   template: `
 19:     <form nz-form [formGroup]="form" (ngSubmit)="submit()">
 20:       <nz-form-item>
 21:         <nz-form-label [nzSpan]="6" nzRequired>ç…§ç‰‡ç±»å‹</nz-form-label>
 22:         <nz-form-control [nzSpan]="18" nzErrorTip="è¯·é€‰æ‹©ç…§ç‰‡ç±»å‹">
 23:           <nz-select formControlName="photoType" nzPlaceHolder="é€‰æ‹©ç…§ç‰‡ç±»å‹">
 24:             <nz-option nzValue="progress" nzLabel="æ–½å·¥è¿›åº¦"></nz-option>
 25:             <nz-option nzValue="before" nzLabel="æ–½å·¥å‰"></nz-option>
 26:             <nz-option nzValue="after" nzLabel="æ–½å·¥å"></nz-option>
 27:             <nz-option nzValue="issue" nzLabel="é—®é¢˜è®°å½•"></nz-option>
 28:             <nz-option nzValue="equipment" nzLabel="è®¾å¤‡"></nz-option>
 29:             <nz-option nzValue="material" nzLabel="ææ–™"></nz-option>
 30:           </nz-select>
 31:         </nz-form-control>
 32:       </nz-form-item>
 33: 
 34:       <nz-form-item>
 35:         <nz-form-label [nzSpan]="6">ç…§ç‰‡è¯´æ˜</nz-form-label>
 36:         <nz-form-control [nzSpan]="18">
 37:           <textarea
 38:             nz-input
 39:             formControlName="caption"
 40:             [nzAutosize]="{ minRows: 2, maxRows: 4 }"
 41:             placeholder="è¯·è¾“å…¥ç…§ç‰‡è¯´æ˜ï¼ˆå¯é€‰ï¼‰"
 42:           ></textarea>
 43:         </nz-form-control>
 44:       </nz-form-item>
 45: 
 46:       <nz-form-item>
 47:         <nz-form-label [nzSpan]="6" nzRequired>é€‰æ‹©ç…§ç‰‡</nz-form-label>
 48:         <nz-form-control [nzSpan]="18" nzErrorTip="è¯·é€‰æ‹©ç…§ç‰‡æ–‡ä»¶">
 49:           <nz-upload nzType="drag" [nzMultiple]="false" [nzBeforeUpload]="beforeUpload" nzAccept="image/*">
 50:             <p class="ant-upload-drag-icon">
 51:               <span nz-icon nzType="inbox"></span>
 52:             </p>
 53:             <p class="ant-upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸä¸Šä¼ </p>
 54:             <p class="ant-upload-hint">æ”¯æŒ JPGã€PNGã€GIF ç­‰å›¾ç‰‡æ ¼å¼</p>
 55:           </nz-upload>
 56:           @if (selectedFile()) {
 57:             <div style="margin-top: 8px;">
 58:               <nz-tag nzColor="green">
 59:                 <span nz-icon nzType="file-image"></span>
 60:                 {{ selectedFile()?.name }}
 61:               </nz-tag>
 62:             </div>
 63:           }
 64:         </nz-form-control>
 65:       </nz-form-item>
 66: 
 67:       <nz-alert
 68:         nzType="info"
 69:         nzMessage="æç¤º"
 70:         nzDescription="ç…§ç‰‡ä¸Šä¼ åå°†å…³è”åˆ°å½“å‰æŠ¥å‘Šã€‚å®é™…é¡¹ç›®ä¸­ï¼Œç…§ç‰‡ä¼šå…ˆä¸Šä¼ åˆ° Supabase Storageï¼Œç„¶ååˆ›å»º document è®°å½•ã€‚"
 71:         nzShowIcon
 72:         style="margin-bottom: 16px;"
 73:       ></nz-alert>
 74: 
 75:       <nz-form-item>
 76:         <nz-form-control [nzSpan]="18" [nzOffset]="6">
 77:           <button nz-button nzType="default" type="button" (click)="cancel()" [disabled]="submitting()" style="margin-right: 8px;">
 78:             å–æ¶ˆ
 79:           </button>
 80:           <button nz-button nzType="primary" type="submit" [nzLoading]="submitting()" [disabled]="!canSubmit() || submitting()">
 81:             ä¸Šä¼ 
 82:           </button>
 83:         </nz-form-control>
 84:       </nz-form-item>
 85:     </form>
 86:   `
 87: })
 88: export class PhotoUploadComponent implements OnInit {
 89:   private fb = inject(FormBuilder);
 90:   private modalRef = inject(NzModalRef);
 91:   private message = inject(NzMessageService);
 92:   private reportPhotoRepo = inject(ReportPhotoRepository);
 93: 
 94:   readonly data: PhotoUploadData = inject(NZ_MODAL_DATA);
 95:   readonly submitting = signal(false);
 96:   readonly selectedFile = signal<File | null>(null);
 97: 
 98:   form!: FormGroup;
 99: 
100:   // File upload handler
101:   beforeUpload = (file: any): boolean => {
102:     // Validate file type
103:     const isImage = file.type?.startsWith('image/');
104:     if (!isImage) {
105:       this.message.error('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼');
106:       return false;
107:     }
108: 
109:     // Validate file size (max 5MB)
110:     const isLt5M = file.size / 1024 / 1024 < 5;
111:     if (!isLt5M) {
112:       this.message.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MBï¼');
113:       return false;
114:     }
115: 
116:     // Store the original file
117:     if (file.originFileObj) {
118:       this.selectedFile.set(file.originFileObj);
119:     } else {
120:       this.selectedFile.set(file);
121:     }
122:     return false; // Prevent automatic upload
123:   };
124: 
125:   ngOnInit(): void {
126:     this.form = this.fb.group({
127:       photoType: ['progress', [Validators.required]],
128:       caption: ['']
129:     });
130:   }
131: 
132:   canSubmit(): boolean {
133:     return this.form.valid && this.selectedFile() !== null;
134:   }
135: 
136:   async submit(): Promise<void> {
137:     if (!this.canSubmit()) {
138:       this.message.warning('è¯·é€‰æ‹©ç…§ç‰‡æ–‡ä»¶');
139:       return;
140:     }
141: 
142:     this.submitting.set(true);
143:     try {
144:       const formValue = this.form.value;
145:       const file = this.selectedFile();
146: 
147:       if (!file) {
148:         throw new Error('æœªé€‰æ‹©æ–‡ä»¶');
149:       }
150: 
151:       // TODO: å®é™…å®ç°ä¸­ï¼Œéœ€è¦å…ˆä¸Šä¼ åˆ° Supabase Storageï¼Œç„¶ååˆ›å»º document è®°å½•
152:       // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ document_id
153:       const tempDocumentId = `temp-${Date.now()}`;
154: 
155:       const photoRecord = {
156:         report_id: this.data.reportId,
157:         document_id: tempDocumentId,
158:         photo_type: formValue.photoType,
159:         caption: formValue.caption || null,
160:         sequence_order: 0,
161:         uploaded_by: 'temp-user-id' // å®é™…åº”è¯¥ä»å½“å‰ç™»å½•ç”¨æˆ·è·å–
162:       };
163: 
164:       await firstValueFrom(this.reportPhotoRepo.create(photoRecord));
165: 
166:       this.message.success('ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰');
167:       this.modalRef.close(true);
168:     } catch (error: any) {
169:       console.error('ä¸Šä¼ ç…§ç‰‡å¤±è´¥:', error);
170:       this.message.error(error.message || 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
171:     } finally {
172:       this.submitting.set(false);
173:     }
174:   }
175: 
176:   cancel(): void {
177:     this.modalRef.close(false);
178:   }
179: }
````

## File: src/app/routes/tasks/photos/photo-viewer.component.ts
````typescript
 1: import { Component, inject } from '@angular/core';
 2: import { SHARED_IMPORTS, ReportPhoto } from '@shared';
 3: import { NZ_MODAL_DATA, NzModalRef } from 'ng-zorro-antd/modal';
 4: 
 5: export interface PhotoViewData {
 6:   photo: ReportPhoto;
 7:   photoUrl: string;
 8: }
 9: 
10: @Component({
11:   selector: 'app-photo-viewer',
12:   standalone: true,
13:   imports: [SHARED_IMPORTS],
14:   template: `
15:     <div style="text-align: center;">
16:       <img [src]="data.photoUrl" [alt]="data.photo.caption || 'ç…§ç‰‡'" style="max-width: 100%; max-height: 70vh; object-fit: contain;" />
17:     </div>
18: 
19:     <nz-divider></nz-divider>
20: 
21:     <nz-descriptions nzBordered [nzColumn]="1" nzSize="small">
22:       @if (data.photo.caption) {
23:         <nz-descriptions-item nzTitle="è¯´æ˜">{{ data.photo.caption }}</nz-descriptions-item>
24:       }
25:       <nz-descriptions-item nzTitle="ç±»å‹">
26:         @switch (data.photo.photo_type) {
27:           @case ('progress') {
28:             <nz-tag nzColor="blue">æ–½å·¥è¿›åº¦</nz-tag>
29:           }
30:           @case ('before') {
31:             <nz-tag nzColor="orange">æ–½å·¥å‰</nz-tag>
32:           }
33:           @case ('after') {
34:             <nz-tag nzColor="green">æ–½å·¥å</nz-tag>
35:           }
36:           @case ('issue') {
37:             <nz-tag nzColor="red">é—®é¢˜è®°å½•</nz-tag>
38:           }
39:           @case ('equipment') {
40:             <nz-tag nzColor="purple">è®¾å¤‡</nz-tag>
41:           }
42:           @case ('material') {
43:             <nz-tag nzColor="cyan">ææ–™</nz-tag>
44:           }
45:           @default {
46:             <nz-tag>{{ data.photo.photo_type }}</nz-tag>
47:           }
48:         }
49:       </nz-descriptions-item>
50:       <nz-descriptions-item nzTitle="ä¸Šä¼ æ—¶é—´">
51:         {{ data.photo.uploaded_at | date: 'yyyy-MM-dd HH:mm:ss' }}
52:       </nz-descriptions-item>
53:       <nz-descriptions-item nzTitle="ä¸Šä¼ è€…ID">{{ data.photo.uploaded_by }}</nz-descriptions-item>
54:     </nz-descriptions>
55: 
56:     <div style="margin-top: 16px; text-align: right;">
57:       <button nz-button nzType="default" (click)="close()">å…³é—­</button>
58:     </div>
59:   `
60: })
61: export class PhotoViewerComponent {
62:   private modalRef = inject(NzModalRef);
63:   readonly data: PhotoViewData = inject(NZ_MODAL_DATA);
64: 
65:   close(): void {
66:     this.modalRef.close();
67:   }
68: }
````

## File: src/app/routes/tasks/photos/task-photos.component.ts
````typescript
  1: import { Component, OnInit, inject, signal, computed } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { ReportPhotoRepository, DailyReportRepository } from '@core';
  4: import { SHARED_IMPORTS, TaskService, Task, ReportPhoto, BlueprintService } from '@shared';
  5: import { NzMessageService } from 'ng-zorro-antd/message';
  6: import { NzModalService } from 'ng-zorro-antd/modal';
  7: import { firstValueFrom } from 'rxjs';
  8: 
  9: import { PhotoUploadComponent } from './photo-upload.component';
 10: import { PhotoViewerComponent } from './photo-viewer.component';
 11: 
 12: @Component({
 13:   selector: 'app-task-photos',
 14:   standalone: true,
 15:   imports: [SHARED_IMPORTS],
 16:   template: `
 17:     <page-header [title]="'æ–½å·¥ç…§ç‰‡'">
 18:       <ng-template #extra>
 19:         <nz-select
 20:           [ngModel]="selectedBlueprintId()"
 21:           (ngModelChange)="selectedBlueprintId.set($event); onBlueprintChange()"
 22:           nzPlaceHolder="è¯·é€‰æ‹©è“å›¾"
 23:           style="width: 300px; margin-right: 8px;"
 24:         >
 25:           @for (blueprint of blueprintService.blueprints(); track blueprint.id) {
 26:             <nz-option [nzValue]="blueprint.id" [nzLabel]="blueprint.name"></nz-option>
 27:           }
 28:         </nz-select>
 29:         <button nz-button nzType="primary" (click)="uploadPhoto()">
 30:           <span nz-icon nzType="upload"></span>
 31:           ä¸Šä¼ ç…§ç‰‡
 32:         </button>
 33:       </ng-template>
 34:     </page-header>
 35: 
 36:     <nz-card style="margin-top: 16px;">
 37:       @if (!selectedBlueprintId()) {
 38:         <nz-empty nzNotFoundContent="è¯·å…ˆé€‰æ‹©è“å›¾"></nz-empty>
 39:       } @else if (loading()) {
 40:         <div style="text-align: center; padding: 40px;">
 41:           <nz-spin nzSize="large"></nz-spin>
 42:         </div>
 43:       } @else if (photos().length === 0) {
 44:         <nz-empty nzNotFoundContent="æš‚æ— ç…§ç‰‡"></nz-empty>
 45:       } @else {
 46:         <nz-spin [nzSpinning]="loading()">
 47:           <div nz-row [nzGutter]="[16, 16]">
 48:             @for (photo of photos(); track photo.id) {
 49:               <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6" [nzXl]="4">
 50:                 <nz-card [nzHoverable]="true" [nzCover]="cover" style="cursor: pointer;" (click)="viewPhoto(photo)">
 51:                   <ng-template #cover>
 52:                     @if (photo.document_id) {
 53:                       <img
 54:                         [src]="getPhotoUrl(photo.document_id)"
 55:                         [alt]="photo.caption || 'æ–½å·¥ç…§ç‰‡'"
 56:                         style="width: 100%; height: 200px; object-fit: cover;"
 57:                       />
 58:                     } @else {
 59:                       <div
 60:                         style="width: 100%; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;"
 61:                       >
 62:                         <span nz-icon nzType="picture" nzTheme="outline" style="font-size: 48px; color: #ccc;"></span>
 63:                       </div>
 64:                     }
 65:                   </ng-template>
 66:                   <nz-card-meta [nzTitle]="photo.caption || 'æ— æ ‡é¢˜'" [nzDescription]="photo.photo_type"></nz-card-meta>
 67:                   <div style="margin-top: 8px; font-size: 12px; color: #999;">
 68:                     {{ photo.uploaded_at | date: 'yyyy-MM-dd HH:mm' }}
 69:                   </div>
 70:                 </nz-card>
 71:               </div>
 72:             }
 73:           </div>
 74:         </nz-spin>
 75:       }
 76:     </nz-card>
 77:   `
 78: })
 79: export class TaskPhotosComponent implements OnInit {
 80:   readonly taskService = inject(TaskService);
 81:   readonly blueprintService = inject(BlueprintService);
 82:   private readonly reportPhotoRepository = inject(ReportPhotoRepository);
 83:   private readonly dailyReportRepository = inject(DailyReportRepository);
 84:   private readonly router = inject(Router);
 85:   private readonly message = inject(NzMessageService);
 86:   private readonly modal = inject(NzModalService);
 87: 
 88:   readonly selectedBlueprintId = signal<string | null>(null);
 89:   readonly loading = signal<boolean>(false);
 90:   readonly photos = signal<ReportPhoto[]>([]);
 91: 
 92:   ngOnInit(): void {
 93:     this.loadBlueprints();
 94:   }
 95: 
 96:   async loadBlueprints(): Promise<void> {
 97:     try {
 98:       await this.blueprintService.loadBlueprints();
 99:     } catch (error) {
100:       this.message.error('åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
101:     }
102:   }
103: 
104:   async onBlueprintChange(): Promise<void> {
105:     const blueprintId = this.selectedBlueprintId();
106:     if (!blueprintId) return;
107: 
108:     this.loading.set(true);
109:     try {
110:       // å…ˆåŠ è½½ä»»åŠ¡åˆ—è¡¨
111:       await this.taskService.loadTasksByBlueprint(blueprintId);
112: 
113:       // ç„¶ååŠ è½½æ‰€æœ‰ä»»åŠ¡çš„æ–½å·¥æ—¥å¿—
114:       const tasks = this.taskService.tasks();
115:       const reportPromises = tasks.map(task => firstValueFrom(this.dailyReportRepository.findByTaskId(task.id)));
116:       const reportArrays = await Promise.all(reportPromises);
117:       const allReports = reportArrays.flat();
118: 
119:       // åŠ è½½æ‰€æœ‰æŠ¥å‘Šçš„ç…§ç‰‡
120:       const photoPromises = allReports.map(report => firstValueFrom(this.reportPhotoRepository.findByReportId(report.id)));
121:       const photoArrays = await Promise.all(photoPromises);
122:       const allPhotos = photoArrays.flat();
123: 
124:       this.photos.set(allPhotos);
125:     } catch (error) {
126:       this.message.error('åŠ è½½æ–½å·¥ç…§ç‰‡å¤±è´¥');
127:     } finally {
128:       this.loading.set(false);
129:     }
130:   }
131: 
132:   async uploadPhoto(): Promise<void> {
133:     const blueprintId = this.selectedBlueprintId();
134:     if (!blueprintId) {
135:       this.message.warning('è¯·å…ˆé€‰æ‹©è“å›¾');
136:       return;
137:     }
138: 
139:     const tasks = this.taskService.tasks();
140:     if (tasks.length === 0) {
141:       this.message.warning('å½“å‰è“å›¾æ²¡æœ‰ä»»åŠ¡ï¼Œè¯·å…ˆåˆ›å»ºä»»åŠ¡');
142:       return;
143:     }
144: 
145:     // ç®€åŒ–å¤„ç†ï¼šéœ€è¦å…ˆæœ‰æ—¥å¿—æ‰èƒ½ä¸Šä¼ ç…§ç‰‡
146:     const reports = await firstValueFrom(this.dailyReportRepository.findByBlueprintId(blueprintId));
147:     if (reports.length === 0) {
148:       this.message.warning('è¯·å…ˆåˆ›å»ºæ–½å·¥æ—¥å¿—ï¼Œç„¶åæ‰èƒ½ä¸Šä¼ ç…§ç‰‡');
149:       return;
150:     }
151: 
152:     const modalRef = this.modal.create({
153:       nzTitle: 'ä¸Šä¼ æ–½å·¥ç…§ç‰‡',
154:       nzContent: PhotoUploadComponent,
155:       nzData: {
156:         reportId: reports[0].id, // ä½¿ç”¨ç¬¬ä¸€ä¸ªæŠ¥å‘Šï¼Œå®é™…åº”è¯¥è®©ç”¨æˆ·é€‰æ‹©
157:         reportType: 'daily'
158:       },
159:       nzWidth: 600,
160:       nzFooter: null
161:     });
162: 
163:     modalRef.afterClose.subscribe(result => {
164:       if (result) {
165:         // åˆ·æ–°åˆ—è¡¨
166:         this.onBlueprintChange();
167:       }
168:     });
169:   }
170: 
171:   getPhotoUrl(documentId: string): string {
172:     // TODO: ä»æ–‡æ¡£æœåŠ¡è·å–å›¾ç‰‡URL
173:     return `/api/documents/${documentId}/download`;
174:   }
175: 
176:   viewPhoto(photo: ReportPhoto): void {
177:     this.modal.create({
178:       nzTitle: 'æŸ¥çœ‹ç…§ç‰‡',
179:       nzContent: PhotoViewerComponent,
180:       nzData: {
181:         photo,
182:         photoUrl: this.getPhotoUrl(photo.document_id)
183:       },
184:       nzWidth: 900,
185:       nzFooter: null
186:     });
187:   }
188: }
````

## File: src/app/routes/tasks/progress/task-progress.spec.ts
````typescript
  1: import { ComponentFixture, TestBed } from '@angular/core/testing';
  2: import { ActivatedRoute, Router } from '@angular/router';
  3: import { NzMessageService } from 'ng-zorro-antd/message';
  4: 
  5: import { TaskProgressComponent } from './task-progress';
  6: 
  7: describe('TaskProgress', () => {
  8:   let component: TaskProgressComponent;
  9:   let fixture: ComponentFixture<TaskProgressComponent>;
 10:   let mockRouter: jasmine.SpyObj<Router>;
 11:   let mockActivatedRoute: Partial<ActivatedRoute>;
 12:   let mockMessageService: jasmine.SpyObj<NzMessageService>;
 13: 
 14:   beforeEach(async () => {
 15:     mockRouter = jasmine.createSpyObj('Router', ['navigate']);
 16:     mockActivatedRoute = {
 17:       snapshot: {
 18:         paramMap: {
 19:           get: jasmine.createSpy('get').and.returnValue(null)
 20:         }
 21:       } as unknown as ActivatedRoute['snapshot']
 22:     };
 23:     mockMessageService = jasmine.createSpyObj('NzMessageService', ['info', 'error', 'success']);
 24: 
 25:     await TestBed.configureTestingModule({
 26:       imports: [TaskProgressComponent],
 27:       providers: [
 28:         { provide: Router, useValue: mockRouter },
 29:         { provide: ActivatedRoute, useValue: mockActivatedRoute },
 30:         { provide: NzMessageService, useValue: mockMessageService }
 31:       ]
 32:     }).compileComponents();
 33: 
 34:     fixture = TestBed.createComponent(TaskProgressComponent);
 35:     component = fixture.componentInstance;
 36:   });
 37: 
 38:   it('should create', () => {
 39:     expect(component).toBeTruthy();
 40:   });
 41: 
 42:   it('should initialize with loading state', () => {
 43:     expect(component.loading()).toBe(true);
 44:   });
 45: 
 46:   it('should load mock data on init when no id provided', done => {
 47:     fixture.detectChanges();
 48: 
 49:     setTimeout(() => {
 50:       expect(component.loading()).toBe(false);
 51:       expect(component.taskProgress()).toBeTruthy();
 52:       expect(component.progressItems().length).toBeGreaterThan(0);
 53:       expect(component.milestones().length).toBeGreaterThan(0);
 54:       done();
 55:     }, 1000);
 56:   });
 57: 
 58:   it('should compute overall progress correctly', done => {
 59:     fixture.detectChanges();
 60: 
 61:     setTimeout(() => {
 62:       const progress = component.overallProgress();
 63:       expect(progress).toBeGreaterThanOrEqual(0);
 64:       expect(progress).toBeLessThanOrEqual(100);
 65:       done();
 66:     }, 1000);
 67:   });
 68: 
 69:   it('should compute completion rate correctly', done => {
 70:     fixture.detectChanges();
 71: 
 72:     setTimeout(() => {
 73:       const rate = component.completionRate();
 74:       expect(rate).toContain('%');
 75:       done();
 76:     }, 1000);
 77:   });
 78: 
 79:   it('should compute schedule status correctly', done => {
 80:     fixture.detectChanges();
 81: 
 82:     setTimeout(() => {
 83:       const status = component.scheduleStatus();
 84:       expect(['success', 'normal', 'exception']).toContain(status);
 85:       done();
 86:     }, 1000);
 87:   });
 88: 
 89:   it('should navigate back when goBack is called', () => {
 90:     component.goBack();
 91:     expect(mockRouter.navigate).toHaveBeenCalledWith(['/tasks']);
 92:   });
 93: 
 94:   it('should show info message when exportReport is called', () => {
 95:     component.exportReport();
 96:     expect(mockMessageService.info).toHaveBeenCalledWith('åŒ¯å‡ºå ±è¡¨åŠŸèƒ½å¾…å¯¦ä½œ');
 97:   });
 98: 
 99:   it('should show info message when viewDetails is called', () => {
100:     component.viewDetails('item-1');
101:     expect(mockMessageService.info).toHaveBeenCalledWith('æŸ¥çœ‹é …ç›® item-1 è©³æƒ…');
102:   });
103: 
104:   it('should return correct status color', () => {
105:     expect(component.getStatusColor('completed')).toBe('success');
106:     expect(component.getStatusColor('qc')).toBe('processing');
107:     expect(component.getStatusColor('staging')).toBe('warning');
108:     expect(component.getStatusColor('issue')).toBe('error');
109:     expect(component.getStatusColor('pending')).toBe('default');
110:   });
111: 
112:   it('should return correct status text', () => {
113:     expect(component.getStatusText('completed')).toBe('å·²å®Œæˆ');
114:     expect(component.getStatusText('qc')).toBe('å“æª¢ä¸­');
115:     expect(component.getStatusText('staging')).toBe('æš«å­˜å€');
116:     expect(component.getStatusText('issue')).toBe('å•é¡Œè¿½è¹¤');
117:     expect(component.getStatusText('pending')).toBe('é€²è¡Œä¸­');
118:   });
119: });
````

## File: src/app/routes/tasks/progress/task-progress.ts
````typescript
  1: import { ChangeDetectionStrategy, Component, OnInit, computed, inject, signal } from '@angular/core';
  2: import { ActivatedRoute, Router } from '@angular/router';
  3: import { SHARED_IMPORTS } from '@shared';
  4: import { NzMessageService } from 'ng-zorro-antd/message';
  5: 
  6: interface TaskProgressData {
  7:   readonly task_id: string;
  8:   readonly task_name: string;
  9:   readonly blueprint_name: string;
 10:   readonly total_items: number;
 11:   readonly completed_items: number;
 12:   readonly pending_items: number;
 13:   readonly staging_items: number;
 14:   readonly qc_items: number;
 15:   readonly issue_items: number;
 16:   readonly start_date: string;
 17:   readonly target_date: string;
 18:   readonly current_date: string;
 19: }
 20: 
 21: interface ProgressItem {
 22:   readonly id: string;
 23:   readonly name: string;
 24:   readonly status: 'completed' | 'pending' | 'staging' | 'qc' | 'issue';
 25:   readonly assignee: string;
 26:   readonly updated_at: string;
 27:   readonly progress: number;
 28: }
 29: 
 30: interface Milestone {
 31:   readonly id: string;
 32:   readonly name: string;
 33:   readonly date: string;
 34:   readonly completed: boolean;
 35:   readonly description: string;
 36: }
 37: 
 38: @Component({
 39:   selector: 'app-task-progress',
 40:   standalone: true,
 41:   imports: [SHARED_IMPORTS],
 42:   templateUrl: './task-progress.html',
 43:   styleUrl: './task-progress.less',
 44:   changeDetection: ChangeDetectionStrategy.OnPush
 45: })
 46: export class TaskProgressComponent implements OnInit {
 47:   private route = inject(ActivatedRoute);
 48:   private router = inject(Router);
 49:   private message = inject(NzMessageService);
 50: 
 51:   // Signals for state management
 52:   loading = signal<boolean>(true);
 53:   taskProgress = signal<TaskProgressData | null>(null);
 54:   progressItems = signal<ProgressItem[]>([]);
 55:   milestones = signal<Milestone[]>([]);
 56:   error = signal<string | null>(null);
 57: 
 58:   // Computed properties
 59:   overallProgress = computed(() => {
 60:     const progress = this.taskProgress();
 61:     if (!progress || progress.total_items === 0) return 0;
 62:     return Math.round((progress.completed_items / progress.total_items) * 100);
 63:   });
 64: 
 65:   completionRate = computed(() => {
 66:     const progress = this.taskProgress();
 67:     if (!progress || progress.total_items === 0) return '0%';
 68:     return `${this.overallProgress()}%`;
 69:   });
 70: 
 71:   scheduleStatus = computed(() => {
 72:     const progress = this.taskProgress();
 73:     if (!progress) return 'normal';
 74: 
 75:     const current = new Date(progress.current_date);
 76:     const target = new Date(progress.target_date);
 77:     const start = new Date(progress.start_date);
 78: 
 79:     const totalDays = Math.ceil((target.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));
 80:     const elapsedDays = Math.ceil((current.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));
 81:     const timeProgress = (elapsedDays / totalDays) * 100;
 82:     const workProgress = this.overallProgress();
 83: 
 84:     if (workProgress >= timeProgress) return 'success';
 85:     if (workProgress >= timeProgress - 10) return 'normal';
 86:     return 'exception';
 87:   });
 88: 
 89:   progressColor = computed(() => {
 90:     const status = this.scheduleStatus();
 91:     switch (status) {
 92:       case 'success':
 93:         return '#52c41a';
 94:       case 'normal':
 95:         return '#1890ff';
 96:       case 'exception':
 97:         return '#ff4d4f';
 98:       default:
 99:         return '#1890ff';
100:     }
101:   });
102: 
103:   ngOnInit(): void {
104:     const taskId = this.route.snapshot.paramMap.get('id');
105:     if (taskId) {
106:       this.loadTaskProgress(taskId);
107:     } else {
108:       // Load with mock data for demonstration
109:       this.loadMockData();
110:     }
111:   }
112: 
113:   private loadMockData(): void {
114:     // Simulate API call delay
115:     setTimeout(() => {
116:       this.taskProgress.set({
117:         task_id: 'task-001',
118:         task_name: 'å»ºç¯‰ä¸»é«”çµæ§‹æ–½å·¥',
119:         blueprint_name: 'XX å•†æ¥­å¤§æ¨“å»ºè¨­å°ˆæ¡ˆ',
120:         total_items: 25,
121:         completed_items: 15,
122:         pending_items: 3,
123:         staging_items: 4,
124:         qc_items: 2,
125:         issue_items: 1,
126:         start_date: '2025-10-01',
127:         target_date: '2025-12-31',
128:         current_date: '2025-11-16'
129:       });
130: 
131:       this.progressItems.set([
132:         {
133:           id: 'item-1',
134:           name: 'åŸºç¤å·¥ç¨‹å®Œæˆ',
135:           status: 'completed',
136:           assignee: 'Team A',
137:           updated_at: '2025-10-15',
138:           progress: 100
139:         },
140:         {
141:           id: 'item-2',
142:           name: 'ä¸€æ¨“çµæ§‹æ–½å·¥',
143:           status: 'completed',
144:           assignee: 'Team A',
145:           updated_at: '2025-11-01',
146:           progress: 100
147:         },
148:         {
149:           id: 'item-3',
150:           name: 'äºŒæ¨“çµæ§‹æ–½å·¥',
151:           status: 'qc',
152:           assignee: 'Team B',
153:           updated_at: '2025-11-10',
154:           progress: 95
155:         },
156:         {
157:           id: 'item-4',
158:           name: 'ä¸‰æ¨“çµæ§‹æ–½å·¥',
159:           status: 'staging',
160:           assignee: 'Team B',
161:           updated_at: '2025-11-15',
162:           progress: 85
163:         },
164:         {
165:           id: 'item-5',
166:           name: 'å››æ¨“çµæ§‹æ–½å·¥',
167:           status: 'pending',
168:           assignee: 'Team C',
169:           updated_at: '2025-11-16',
170:           progress: 30
171:         }
172:       ]);
173: 
174:       this.milestones.set([
175:         {
176:           id: 'ms-1',
177:           name: 'åŸºç¤å·¥ç¨‹å®Œå·¥',
178:           date: '2025-10-15',
179:           completed: true,
180:           description: 'åœ°åŸºèˆ‡åŸºç¤çµæ§‹å®Œæˆ'
181:         },
182:         {
183:           id: 'ms-2',
184:           name: 'ä¸»é«”çµæ§‹ 50% å®Œæˆ',
185:           date: '2025-11-15',
186:           completed: true,
187:           description: 'å»ºç¯‰ä¸»é«”çµæ§‹é”åˆ° 50% é€²åº¦'
188:         },
189:         {
190:           id: 'ms-3',
191:           name: 'ä¸»é«”çµæ§‹å°é ‚',
192:           date: '2025-12-15',
193:           completed: false,
194:           description: 'å»ºç¯‰ä¸»é«”çµæ§‹å®Œå·¥'
195:         },
196:         {
197:           id: 'ms-4',
198:           name: 'å°ˆæ¡ˆé©—æ”¶',
199:           date: '2025-12-31',
200:           completed: false,
201:           description: 'å®Œæˆæœ€çµ‚é©—æ”¶èˆ‡äº¤ä»˜'
202:         }
203:       ]);
204: 
205:       this.loading.set(false);
206:     }, 800);
207:   }
208: 
209:   private async loadTaskProgress(_id: string): Promise<void> {
210:     try {
211:       this.loading.set(true);
212:       this.error.set(null);
213: 
214:       // TODO: Replace with actual API call
215:       // const data = await this.taskService.getProgressById(id);
216:       // this.taskProgress.set(data);
217: 
218:       // For now, load mock data
219:       this.loadMockData();
220:     } catch {
221:       this.error.set('è¼‰å…¥ä»»å‹™é€²åº¦å¤±æ•—');
222:       this.message.error('è¼‰å…¥å¤±æ•—');
223:       this.loading.set(false);
224:     }
225:   }
226: 
227:   goBack(): void {
228:     this.router.navigate(['/tasks']);
229:   }
230: 
231:   viewDetails(_itemId: string): void {
232:     this.message.info(`æŸ¥çœ‹é …ç›® ${_itemId} è©³æƒ…`);
233:   }
234: 
235:   exportReport(): void {
236:     this.message.info('åŒ¯å‡ºå ±è¡¨åŠŸèƒ½å¾…å¯¦ä½œ');
237:   }
238: 
239:   getStatusColor(status: string): string {
240:     switch (status) {
241:       case 'completed':
242:         return 'success';
243:       case 'qc':
244:         return 'processing';
245:       case 'staging':
246:         return 'warning';
247:       case 'issue':
248:         return 'error';
249:       case 'pending':
250:         return 'default';
251:       default:
252:         return 'default';
253:     }
254:   }
255: 
256:   getStatusText(status: string): string {
257:     switch (status) {
258:       case 'completed':
259:         return 'å·²å®Œæˆ';
260:       case 'qc':
261:         return 'å“æª¢ä¸­';
262:       case 'staging':
263:         return 'æš«å­˜å€';
264:       case 'issue':
265:         return 'å•é¡Œè¿½è¹¤';
266:       case 'pending':
267:         return 'é€²è¡Œä¸­';
268:       default:
269:         return status;
270:     }
271:   }
272: }
````

## File: src/app/routes/tasks/staging/task-staging.component.ts
````typescript
  1: import { Component, OnInit, inject, signal, computed } from '@angular/core';
  2: import { Router } from '@angular/router';
  3: import { TaskStagingRepository } from '@core';
  4: import { STColumn } from '@delon/abc/st';
  5: import { SHARED_IMPORTS, TaskService, Task, TaskStaging, BlueprintService } from '@shared';
  6: import { NzMessageService } from 'ng-zorro-antd/message';
  7: import { firstValueFrom } from 'rxjs';
  8: 
  9: @Component({
 10:   selector: 'app-task-staging',
 11:   standalone: true,
 12:   imports: [SHARED_IMPORTS],
 13:   template: `
 14:     <page-header [title]="'æš‚å­˜åŒº'">
 15:       <ng-template #extra>
 16:         <nz-select
 17:           [ngModel]="selectedBlueprintId()"
 18:           (ngModelChange)="selectedBlueprintId.set($event); onBlueprintChange()"
 19:           nzPlaceHolder="è¯·é€‰æ‹©è“å›¾"
 20:           style="width: 300px; margin-right: 8px;"
 21:         >
 22:           @for (blueprint of blueprintService.blueprints(); track blueprint.id) {
 23:             <nz-option [nzValue]="blueprint.id" [nzLabel]="blueprint.name"></nz-option>
 24:           }
 25:         </nz-select>
 26:       </ng-template>
 27:     </page-header>
 28: 
 29:     <nz-card style="margin-top: 16px;">
 30:       <nz-alert
 31:         nzType="info"
 32:         nzMessage="æš‚å­˜åŒºè¯´æ˜"
 33:         nzDescription="æ­¤é¡µé¢æ˜¾ç¤º48å°æ—¶å†…å¯æ’¤å›çš„ä»»åŠ¡ã€‚ä»»åŠ¡æäº¤åè¿›å…¥æš‚å­˜åŒºï¼Œ48å°æ—¶å†…å¯ä»¥æ’¤å›ã€‚"
 34:         [nzShowIcon]="true"
 35:         style="margin-bottom: 16px;"
 36:       ></nz-alert>
 37: 
 38:       @if (!selectedBlueprintId()) {
 39:         <nz-empty nzNotFoundContent="è¯·å…ˆé€‰æ‹©è“å›¾"></nz-empty>
 40:       } @else if (loading()) {
 41:         <div style="text-align: center; padding: 40px;">
 42:           <nz-spin nzSize="large"></nz-spin>
 43:         </div>
 44:       } @else if (stagingTasks().length === 0) {
 45:         <nz-empty nzNotFoundContent="æš‚å­˜åŒºæš‚æ— ä»»åŠ¡"></nz-empty>
 46:       } @else {
 47:         <st #st [data]="stagingTasks()" [columns]="columns" [loading]="loading()" [page]="{ front: false, show: true, showSize: true }">
 48:           <ng-template #canWithdraw let-record>
 49:             @if (record.can_withdraw) {
 50:               <nz-tag nzColor="green">å¯æ’¤å›</nz-tag>
 51:             } @else {
 52:               <nz-tag nzColor="default">ä¸å¯æ’¤å›</nz-tag>
 53:             }
 54:           </ng-template>
 55:         </st>
 56:       }
 57:     </nz-card>
 58:   `
 59: })
 60: export class TaskStagingComponent implements OnInit {
 61:   readonly taskService = inject(TaskService);
 62:   readonly blueprintService = inject(BlueprintService);
 63:   private readonly taskStagingRepository = inject(TaskStagingRepository);
 64:   private readonly router = inject(Router);
 65:   private readonly message = inject(NzMessageService);
 66: 
 67:   readonly selectedBlueprintId = signal<string | null>(null);
 68:   readonly loading = signal<boolean>(false);
 69:   readonly stagingRecords = signal<TaskStaging[]>([]);
 70: 
 71:   readonly stagingTasks = computed(() => {
 72:     const records = this.stagingRecords();
 73:     const tasks = this.taskService.tasks();
 74: 
 75:     // å°†æš‚å­˜è®°å½•ä¸ä»»åŠ¡å…³è”
 76:     return records.map(record => {
 77:       const task = tasks.find(t => t.id === record.task_id);
 78:       return {
 79:         ...record,
 80:         task: task || null,
 81:         taskTitle: task?.title || 'ä»»åŠ¡ä¸å­˜åœ¨'
 82:       };
 83:     });
 84:   });
 85: 
 86:   columns: STColumn[] = [
 87:     { title: 'ä»»åŠ¡ID', index: 'task_id', width: 120 },
 88:     { title: 'ä»»åŠ¡æ ‡é¢˜', index: 'taskTitle', width: 200 },
 89:     { title: 'æäº¤è€…ID', index: 'submitted_by', width: 120 },
 90:     { title: 'æäº¤æ—¶é—´', index: 'submitted_at', type: 'date', width: 180 },
 91:     { title: 'è¿‡æœŸæ—¶é—´', index: 'expires_at', type: 'date', width: 180 },
 92:     { title: 'å¯æ’¤å›', index: 'can_withdraw', width: 100, render: 'canWithdraw' },
 93:     {
 94:       title: 'æ“ä½œ',
 95:       width: 200,
 96:       buttons: [
 97:         {
 98:           text: 'æŸ¥çœ‹ä»»åŠ¡',
 99:           click: (record: any) => this.viewTask(record.task_id)
100:         },
101:         {
102:           text: 'æ’¤å›',
103:           type: 'del',
104:           pop: true,
105:           popTitle: 'ç¡®è®¤æ’¤å›',
106:           click: (record: any) => this.withdraw(record)
107:         }
108:       ]
109:     }
110:   ];
111: 
112:   ngOnInit(): void {
113:     this.loadBlueprints();
114:   }
115: 
116:   async loadBlueprints(): Promise<void> {
117:     try {
118:       await this.blueprintService.loadBlueprints();
119:     } catch (error) {
120:       this.message.error('åŠ è½½è“å›¾åˆ—è¡¨å¤±è´¥');
121:     }
122:   }
123: 
124:   async onBlueprintChange(): Promise<void> {
125:     const blueprintId = this.selectedBlueprintId();
126:     if (!blueprintId) return;
127: 
128:     this.loading.set(true);
129:     try {
130:       // å…ˆåŠ è½½ä»»åŠ¡åˆ—è¡¨
131:       await this.taskService.loadTasksByBlueprint(blueprintId);
132: 
133:       // ç„¶ååŠ è½½æ‰€æœ‰ä»»åŠ¡çš„æš‚å­˜è®°å½•
134:       const tasks = this.taskService.tasks();
135:       const stagingPromises = tasks.map(task => firstValueFrom(this.taskStagingRepository.findByTaskId(task.id)));
136:       const stagingArrays = await Promise.all(stagingPromises);
137:       const allStaging = stagingArrays.flat();
138: 
139:       // è¿‡æ»¤å‡ºå¯æ’¤å›çš„è®°å½•ï¼ˆ48å°æ—¶å†…ï¼‰
140:       const now = new Date();
141:       const withdrawable = allStaging.filter(record => {
142:         if (!record.expires_at || !record.can_withdraw) return false;
143:         const expiresAt = new Date(record.expires_at);
144:         return expiresAt > now;
145:       });
146: 
147:       this.stagingRecords.set(withdrawable);
148:     } catch (error) {
149:       this.message.error('åŠ è½½æš‚å­˜åŒºæ•°æ®å¤±è´¥');
150:     } finally {
151:       this.loading.set(false);
152:     }
153:   }
154: 
155:   viewTask(taskId: string): void {
156:     this.router.navigate(['/tasks', taskId]);
157:   }
158: 
159:   async withdraw(record: any): Promise<void> {
160:     if (!record.can_withdraw) {
161:       this.message.warning('è¯¥ä»»åŠ¡å·²ä¸å¯æ’¤å›');
162:       return;
163:     }
164: 
165:     // æ£€æŸ¥æ˜¯å¦åœ¨48å°æ—¶å†…
166:     const now = new Date();
167:     const expiresAt = new Date(record.expires_at);
168:     if (expiresAt <= now) {
169:       this.message.warning('æ’¤å›æ—¶é—´å·²è¿‡ï¼ˆè¶…è¿‡48å°æ—¶ï¼‰');
170:       return;
171:     }
172: 
173:     try {
174:       // æ›´æ–°æš‚å­˜è®°å½•çŠ¶æ€
175:       await firstValueFrom(
176:         this.taskStagingRepository.update(record.id, {
177:           can_withdraw: false,
178:           confirmed_at: new Date().toISOString()
179:         })
180:       );
181: 
182:       // æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼Œå°†ä»»åŠ¡ä» staging æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€
183:       // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥è®°å½•ä»»åŠ¡ä¹‹å‰çš„çŠ¶æ€
184:       const task = this.taskService.tasks().find(t => t.id === record.task_id);
185:       if (task) {
186:         // å‡è®¾æ’¤å›åä»»åŠ¡å›åˆ° assigned çŠ¶æ€
187:         await this.taskService.updateTask(record.task_id, {
188:           status: 'assigned'
189:         });
190:       }
191: 
192:       this.message.success('ä»»åŠ¡å·²æˆåŠŸæ’¤å›');
193: 
194:       // åˆ·æ–°åˆ—è¡¨
195:       await this.onBlueprintChange();
196:     } catch (error: any) {
197:       console.error('æ’¤å›ä»»åŠ¡å¤±è´¥:', error);
198:       this.message.error(error.message || 'æ’¤å›å¤±è´¥ï¼Œè¯·é‡è¯•');
199:     }
200:   }
201: }
````

## File: src/app/routes/accounts/teams/team-detail/team-detail.component.ts
````typescript
  1: import { Component, OnInit, computed, inject } from '@angular/core';
  2: import { ActivatedRoute, Router } from '@angular/router';
  3: import { SHARED_IMPORTS, TeamService } from '@shared';
  4: import { NzMessageService } from 'ng-zorro-antd/message';
  5: import { NzModalService } from 'ng-zorro-antd/modal';
  6: 
  7: import { TeamDeleteComponent, TeamDeleteData } from '../team-delete/team-delete.component';
  8: import { TeamRoleManageComponent } from '../team-role-manage/team-role-manage.component';
  9: 
 10: @Component({
 11:   selector: 'app-team-detail',
 12:   standalone: true,
 13:   imports: [SHARED_IMPORTS, TeamRoleManageComponent],
 14:   template: `
 15:     <page-header [title]="'å›¢é˜Ÿè¯¦æƒ…'" [extra]="headerExtra">
 16:       <ng-template #headerExtra>
 17:         <button nz-button nzType="default" (click)="goBack()" style="margin-right: 8px;">
 18:           <span nz-icon nzType="arrow-left"></span>
 19:           è¿”å›
 20:         </button>
 21:         @if (team()) {
 22:           <button nz-button nzType="primary" (click)="edit()" style="margin-right: 8px;">
 23:             <span nz-icon nzType="edit"></span>
 24:             ç¼–è¾‘
 25:           </button>
 26:           <button nz-button nzDanger (click)="delete()">
 27:             <span nz-icon nzType="delete"></span>
 28:             åˆ é™¤
 29:           </button>
 30:         }
 31:       </ng-template>
 32:     </page-header>
 33: 
 34:     @if (teamService.loading()) {
 35:       <nz-spin nzSimple [nzSize]="'large'" style="display: block; padding: 50px; text-align: center;">
 36:         <ng-template #indicator>
 37:           <span nz-icon nzType="loading" style="font-size: 24px;"></span>
 38:         </ng-template>
 39:       </nz-spin>
 40:     } @else if (teamService.error()) {
 41:       <nz-alert nzType="error" [nzMessage]="'åŠ è½½å¤±è´¥'" [nzDescription]="teamService.error()" nzShowIcon style="margin: 16px;"></nz-alert>
 42:     } @else if (team()) {
 43:       <div style="padding: 16px;">
 44:         <!-- å›¢é˜ŸåŸºæœ¬ä¿¡æ¯ -->
 45:         <nz-card nzTitle="åŸºæœ¬ä¿¡æ¯" style="margin-bottom: 16px;">
 46:           <nz-descriptions nzBordered [nzColumn]="{ xxl: 3, xl: 2, lg: 2, md: 1, sm: 1, xs: 1 }">
 47:             <nz-descriptions-item nzTitle="ID">{{ team()!.id }}</nz-descriptions-item>
 48:             <nz-descriptions-item nzTitle="å›¢é˜Ÿåç§°">{{ team()!.name }}</nz-descriptions-item>
 49:             <nz-descriptions-item nzTitle="æè¿°">{{ team()!.description || '-' }}</nz-descriptions-item>
 50:             <nz-descriptions-item nzTitle="ç»„ç»‡ID">{{ team()!.organization_id }}</nz-descriptions-item>
 51:             <nz-descriptions-item nzTitle="åˆ›å»ºæ—¶é—´">
 52:               {{ team()!.created_at | date: 'yyyy-MM-dd HH:mm:ss' }}
 53:             </nz-descriptions-item>
 54:             <nz-descriptions-item nzTitle="æ›´æ–°æ—¶é—´">
 55:               {{ team()!.updated_at | date: 'yyyy-MM-dd HH:mm:ss' }}
 56:             </nz-descriptions-item>
 57:           </nz-descriptions>
 58:         </nz-card>
 59: 
 60:         <!-- å›¢é˜Ÿæˆå‘˜å’Œè§’è‰²ç®¡ç† -->
 61:         @if (team()?.id) {
 62:           <app-team-role-manage [teamId]="team()!.id"></app-team-role-manage>
 63:         }
 64:       </div>
 65:     } @else {
 66:       <nz-empty nzNotFoundContent="å›¢é˜Ÿä¸å­˜åœ¨"></nz-empty>
 67:     }
 68:   `
 69: })
 70: export class TeamDetailComponent implements OnInit {
 71:   teamService = inject(TeamService);
 72:   private route = inject(ActivatedRoute);
 73:   private router = inject(Router);
 74:   private message = inject(NzMessageService);
 75:   private modal = inject(NzModalService);
 76: 
 77:   team = computed(() => this.teamService.selectedTeam());
 78: 
 79:   ngOnInit(): void {
 80:     const teamId = this.route.snapshot.paramMap.get('id');
 81:     if (teamId) {
 82:       this.loadTeam(teamId);
 83:     }
 84:   }
 85: 
 86:   async loadTeam(id: string): Promise<void> {
 87:     try {
 88:       const team = await this.teamService.loadTeamById(id);
 89:       if (!team) {
 90:         this.message.warning('å›¢é˜Ÿä¸å­˜åœ¨');
 91:         this.goBack();
 92:       }
 93:     } catch (error) {
 94:       const errorMessage = error instanceof Error ? error.message : 'åŠ è½½å›¢é˜Ÿè¯¦æƒ…å¤±è´¥';
 95:       this.message.error(errorMessage);
 96:     }
 97:   }
 98: 
 99:   goBack(): void {
100:     this.router.navigate(['/accounts/teams']);
101:   }
102: 
103:   edit(): void {
104:     if (this.team()) {
105:       this.router.navigate(['/accounts/teams', this.team()!.id, 'edit']);
106:     }
107:   }
108: 
109:   delete(): void {
110:     if (!this.team()) {
111:       return;
112:     }
113: 
114:     const modalRef = this.modal.create({
115:       nzTitle: 'åˆ é™¤å›¢é˜Ÿ',
116:       nzContent: TeamDeleteComponent,
117:       nzData: {
118:         teamId: this.team()!.id,
119:         teamName: this.team()!.name
120:       } as TeamDeleteData,
121:       nzWidth: 500,
122:       nzFooter: null
123:     });
124: 
125:     modalRef.afterClose.subscribe(result => {
126:       if (result) {
127:         this.goBack();
128:       }
129:     });
130:   }
131: }
````

## File: src/app/routes/blueprints/branches/branch-management.component.ts
````typescript
  1: import { Component, OnInit, computed, inject } from '@angular/core';
  2: import { FormControl, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
  3: import { ActivatedRoute, Router } from '@angular/router';
  4: import { BranchType, BranchContextService } from '@core';
  5: import { STColumn } from '@delon/abc/st';
  6: import { DA_SERVICE_TOKEN } from '@delon/auth';
  7: import { AccountService, AccountType, BlueprintBranch, BlueprintService, BranchService, SHARED_IMPORTS } from '@shared';
  8: import { NzMessageService } from 'ng-zorro-antd/message';
  9: import { NzModalRef, NzModalService } from 'ng-zorro-antd/modal';
 10: 
 11: import { BranchDetailComponent } from './branch-detail.component';
 12: 
 13: // Fork åˆ†æ”¯å¯¹è¯æ¡†ç»„ä»¶
 14: @Component({
 15:   selector: 'app-fork-branch-dialog',
 16:   standalone: true,
 17:   imports: [SHARED_IMPORTS, ReactiveFormsModule],
 18:   template: `
 19:     <div>
 20:       <form nz-form [formGroup]="form">
 21:         <nz-form-item>
 22:           <nz-form-label [nzSpan]="6" nzRequired>ç»„ç»‡</nz-form-label>
 23:           <nz-form-control [nzSpan]="18" [nzErrorTip]="'è¯·é€‰æ‹©ç»„ç»‡'">
 24:             <nz-select formControlName="organizationId" nzPlaceHolder="è¯·é€‰æ‹©ç»„ç»‡" [nzLoading]="loading()">
 25:               @for (org of organizations(); track org.id) {
 26:                 <nz-option [nzValue]="org.id" [nzLabel]="org.name || org.id"></nz-option>
 27:               }
 28:             </nz-select>
 29:           </nz-form-control>
 30:         </nz-form-item>
 31: 
 32:         <nz-form-item>
 33:           <nz-form-label [nzSpan]="6" nzRequired>åˆ†æ”¯åç§°</nz-form-label>
 34:           <nz-form-control [nzSpan]="18" [nzErrorTip]="'è¯·è¾“å…¥åˆ†æ”¯åç§°'">
 35:             <input nz-input formControlName="branchName" placeholder="è¯·è¾“å…¥åˆ†æ”¯åç§°" />
 36:           </nz-form-control>
 37:         </nz-form-item>
 38: 
 39:         <nz-form-item>
 40:           <nz-form-label [nzSpan]="6" nzRequired>åˆ†æ”¯ç±»å‹</nz-form-label>
 41:           <nz-form-control [nzSpan]="18" [nzErrorTip]="'è¯·é€‰æ‹©åˆ†æ”¯ç±»å‹'">
 42:             <nz-select formControlName="branchType" nzPlaceHolder="è¯·é€‰æ‹©åˆ†æ”¯ç±»å‹">
 43:               <nz-option [nzValue]="BranchType.CONTRACTOR" nzLabel="æ‰¿æ½å•†"></nz-option>
 44:               <nz-option [nzValue]="BranchType.SUBCONTRACTOR" nzLabel="æ¬¡æ‰¿æ½å•†"></nz-option>
 45:               <nz-option [nzValue]="BranchType.CONSULTANT" nzLabel="é¡¾é—®"></nz-option>
 46:             </nz-select>
 47:           </nz-form-control>
 48:         </nz-form-item>
 49: 
 50:         <nz-form-item>
 51:           <nz-form-label [nzSpan]="6">å¤‡æ³¨</nz-form-label>
 52:           <nz-form-control [nzSpan]="18">
 53:             <textarea
 54:               nz-input
 55:               formControlName="notes"
 56:               [nzAutosize]="{ minRows: 3, maxRows: 6 }"
 57:               placeholder="è¯·è¾“å…¥å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"
 58:             ></textarea>
 59:           </nz-form-control>
 60:         </nz-form-item>
 61:       </form>
 62:     </div>
 63:   `
 64: })
 65: class ForkBranchDialogComponent implements OnInit {
 66:   modal = inject(NzModalRef);
 67:   accountService = inject(AccountService);
 68:   BranchType = BranchType;
 69: 
 70:   form = new FormGroup({
 71:     organizationId: new FormControl<string>('', [Validators.required]),
 72:     branchName: new FormControl<string>('', [Validators.required]),
 73:     branchType: new FormControl<BranchType>(BranchType.CONTRACTOR, [Validators.required]),
 74:     notes: new FormControl<string>('')
 75:   });
 76: 
 77:   organizations = this.accountService.organizationAccounts;
 78:   loading = this.accountService.loading;
 79: 
 80:   ngOnInit(): void {
 81:     // åŠ è½½ç»„ç»‡åˆ—è¡¨
 82:     this.accountService.loadAccounts().catch(() => {
 83:       // é”™è¯¯å¤„ç†å·²åœ¨serviceä¸­å®Œæˆ
 84:     });
 85:   }
 86: 
 87:   submit(): void {
 88:     if (this.form.valid) {
 89:       this.modal.close(this.form.value);
 90:     }
 91:   }
 92: 
 93:   cancel(): void {
 94:     this.modal.destroy();
 95:   }
 96: }
 97: 
 98: @Component({
 99:   selector: 'app-branch-management',
100:   standalone: true,
101:   imports: [SHARED_IMPORTS, ReactiveFormsModule],
102:   template: `
103:     <page-header [title]="'åˆ†æ”¯ç®¡ç†'">
104:       <ng-template #extra>
105:         <button nz-button nzType="default" (click)="goBack()" style="margin-right: 8px;">
106:           <span nz-icon nzType="arrow-left"></span>
107:           è¿”å›
108:         </button>
109:         @if (!isPersonalBlueprint()) {
110:           <button nz-button nzType="primary" (click)="forkBranch()">
111:             <span nz-icon nzType="git-branch"></span>
112:             Fork åˆ†æ”¯
113:           </button>
114:         } @else {
115:           <nz-tooltip nzTitle="ä¸ªäººè“å›¾ä¸æ”¯æŒForkåŠŸèƒ½">
116:             <button nz-button nzType="primary" nzDisabled>
117:               <span nz-icon nzType="git-branch"></span>
118:               Fork åˆ†æ”¯
119:             </button>
120:           </nz-tooltip>
121:         }
122:       </ng-template>
123:     </page-header>
124: 
125:     <nz-card nzTitle="è“å›¾åˆ†æ”¯åˆ—è¡¨" style="margin-top: 16px;">
126:       <st
127:         #st
128:         [data]="branchService.branches()"
129:         [columns]="columns"
130:         [loading]="branchService.loading()"
131:         [page]="{ front: false, show: true, showSize: true }"
132:         (change)="onTableChange()"
133:       >
134:         <ng-template #type let-record>
135:           @switch (record.branch_type) {
136:             @case ('contractor') {
137:               <nz-tag nzColor="blue">æ‰¿æ½å•†</nz-tag>
138:             }
139:             @case ('subcontractor') {
140:               <nz-tag nzColor="cyan">æ¬¡æ‰¿æ½å•†</nz-tag>
141:             }
142:             @case ('consultant') {
143:               <nz-tag nzColor="purple">é¡¾é—®</nz-tag>
144:             }
145:             @default {
146:               <nz-tag>æœªçŸ¥</nz-tag>
147:             }
148:           }
149:         </ng-template>
150: 
151:         <ng-template #status let-record>
152:           @switch (record.status) {
153:             @case ('active') {
154:               <nz-tag nzColor="success">æ´»è·ƒ</nz-tag>
155:             }
156:             @case ('merged') {
157:               <nz-tag nzColor="blue">å·²åˆå¹¶</nz-tag>
158:             }
159:             @case ('closed') {
160:               <nz-tag nzColor="default">å·²å…³é—­</nz-tag>
161:             }
162:             @default {
163:               <nz-tag>æœªçŸ¥</nz-tag>
164:             }
165:           }
166:         </ng-template>
167: 
168:         <ng-template #organization let-record>
169:           @if (getOrganizationName(record.organization_id)) {
170:             <span>{{ getOrganizationName(record.organization_id) }}</span>
171:           } @else {
172:             <span style="color: #999;">{{ record.organization_id }}</span>
173:           }
174:         </ng-template>
175:       </st>
176:     </nz-card>
177:   `
178: })
179: export class BranchManagementComponent implements OnInit {
180:   branchService = inject(BranchService);
181:   accountService = inject(AccountService);
182:   blueprintService = inject(BlueprintService);
183:   branchContext = inject(BranchContextService);
184:   route = inject(ActivatedRoute);
185:   router = inject(Router);
186:   message = inject(NzMessageService);
187:   modal = inject(NzModalService);
188:   tokenService = inject(DA_SERVICE_TOKEN);
189: 
190:   blueprintId = computed(() => this.route.snapshot.paramMap.get('id') || '');
191: 
192:   // è“å›¾ä¿¡æ¯
193:   blueprint = computed(() => this.blueprintService.selectedBlueprint());
194: 
195:   // åˆ¤æ–­æ˜¯å¦ä¸ºä¸ªäººè“å›¾
196:   isPersonalBlueprint = computed(() => {
197:     const bp = this.blueprint();
198:     if (!bp) return false;
199:     const owner = this.accountService.accounts().find(a => a.id === bp.owner_id);
200:     return owner?.type === AccountType.USER;
201:   });
202: 
203:   // å¯¼å‡ºæšä¸¾ä¾›æ¨¡æ¿ä½¿ç”¨
204:   AccountType = AccountType;
205: 
206:   columns: STColumn[] = [
207:     { title: 'åˆ†æ”¯åç§°', index: 'branch_name', width: 200 },
208:     { title: 'ç»„ç»‡', index: 'organization_id', width: 200, render: 'organization' },
209:     { title: 'åˆ†æ”¯ç±»å‹', index: 'branch_type', width: 120, render: 'type' },
210:     { title: 'çŠ¶æ€', index: 'status', width: 100, render: 'status' },
211:     { title: 'åˆ›å»ºæ—¶é—´', index: 'created_at', type: 'date', width: 180 },
212:     {
213:       title: 'æ“ä½œ',
214:       width: 250,
215:       buttons: [
216:         {
217:           text: 'åˆ‡æ¢',
218:           type: 'link',
219:           click: (record: BlueprintBranch) => this.switchToBranch(record.id)
220:         },
221:         {
222:           text: 'æŸ¥çœ‹',
223:           type: 'link',
224:           click: (record: BlueprintBranch) => this.viewBranch(record.id)
225:         },
226:         {
227:           text: 'åŒæ­¥',
228:           type: 'link',
229:           click: (record: BlueprintBranch) => this.syncBranch(record.id)
230:         },
231:         {
232:           text: 'å…³é—­',
233:           type: 'link',
234:           click: (record: BlueprintBranch) => this.closeBranch(record.id),
235:           pop: {
236:             title: 'ç¡®è®¤å…³é—­',
237:             okText: 'ç¡®å®š',
238:             cancelText: 'å–æ¶ˆ'
239:           }
240:         }
241:       ]
242:     }
243:   ];
244: 
245:   ngOnInit(): void {
246:     const id = this.blueprintId();
247:     if (id) {
248:       this.loadBlueprint(id);
249:       this.loadBranches(id);
250:       // åŠ è¼‰çµ„ç¹”åˆ—è¡¨ä»¥ä¾¿é¡¯ç¤ºçµ„ç¹”åç¨±
251:       this.accountService.loadAccounts().catch(() => {
252:         // éŒ¯èª¤è™•ç†å·²åœ¨serviceä¸­å®Œæˆ
253:       });
254:     }
255:   }
256: 
257:   async loadBlueprint(id: string): Promise<void> {
258:     try {
259:       await this.blueprintService.loadBlueprintById(id);
260:       // åŠ è½½æ‹¥æœ‰è€…è´¦æˆ·ä¿¡æ¯
261:       const blueprint = this.blueprint();
262:       if (blueprint) {
263:         await this.accountService.loadAccountById(blueprint.owner_id);
264:       }
265:     } catch (error) {
266:       // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ä¸»æµç¨‹
267:       console.error('åŠ è½½è“å›¾ä¿¡æ¯å¤±è´¥:', error);
268:     }
269:   }
270: 
271:   async loadBranches(blueprintId: string): Promise<void> {
272:     try {
273:       await this.branchService.loadBranchesByBlueprintId(blueprintId);
274:     } catch (error) {
275:       this.message.error('åŠ è½½åˆ†æ”¯åˆ—è¡¨å¤±è´¥');
276:     }
277:   }
278: 
279:   onTableChange(): void {
280:     // è¡¨æ ¼å˜åŒ–å¤„ç†
281:   }
282: 
283:   goBack(): void {
284:     const blueprintId = this.blueprintId();
285:     if (blueprintId) {
286:       this.router.navigate(['/blueprints', blueprintId]);
287:     } else {
288:       this.router.navigate(['/blueprints/list']);
289:     }
290:   }
291: 
292:   forkBranch(): void {
293:     const blueprintId = this.blueprintId();
294:     if (!blueprintId) {
295:       this.message.error('è“å›¾IDä¸å­˜åœ¨');
296:       return;
297:     }
298: 
299:     // è·å–å½“å‰ç”¨æˆ·ID
300:     const currentUser = this.tokenService.get()?.['user'];
301:     if (!currentUser?.id) {
302:       this.message.error('è¯·å…ˆç™»å½•');
303:       return;
304:     }
305: 
306:     // æ‰“å¼€Forkåˆ†æ”¯å¯¹è¯æ¡†
307:     const modalRef = this.modal.create({
308:       nzTitle: 'Fork åˆ†æ”¯',
309:       nzContent: ForkBranchDialogComponent,
310:       nzWidth: 600,
311:       nzFooter: [
312:         {
313:           label: 'å–æ¶ˆ',
314:           onClick: () => modalRef.destroy()
315:         },
316:         {
317:           label: 'ç¡®å®š',
318:           type: 'primary',
319:           onClick: () => {
320:             const component = modalRef.getContentComponent() as ForkBranchDialogComponent;
321:             if (component.form.valid) {
322:               const formValue = component.form.value;
323:               this.handleForkBranch(
324:                 blueprintId,
325:                 currentUser.id,
326:                 {
327:                   organizationId: formValue.organizationId ?? null,
328:                   branchName: formValue.branchName ?? null,
329:                   branchType: formValue.branchType ?? null,
330:                   notes: formValue.notes ?? null
331:                 },
332:                 modalRef
333:               );
334:             } else {
335:               // æ ‡è®°è¡¨å•ä¸ºtouchedä»¥æ˜¾ç¤ºéªŒè¯é”™è¯¯
336:               Object.values(component.form.controls).forEach(control => {
337:                 control.markAsTouched();
338:                 control.updateValueAndValidity();
339:               });
340:             }
341:           }
342:         }
343:       ]
344:     });
345:   }
346: 
347:   private async handleForkBranch(
348:     blueprintId: string,
349:     forkedBy: string,
350:     formValue: { organizationId: string | null; branchName: string | null; branchType: BranchType | null; notes?: string | null },
351:     modalRef: any
352:   ): Promise<void> {
353:     if (!formValue.organizationId || !formValue.branchName || !formValue.branchType) {
354:       this.message.error('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
355:       return;
356:     }
357: 
358:     try {
359:       await this.branchService.forkBranch(
360:         blueprintId,
361:         formValue.organizationId,
362:         formValue.branchName,
363:         formValue.branchType,
364:         forkedBy,
365:         formValue.notes || undefined
366:       );
367:       this.message.success('Fork åˆ†æ”¯æˆåŠŸ');
368:       modalRef.destroy();
369:       // åˆ·æ–°åˆ†æ”¯åˆ—è¡¨
370:       await this.loadBranches(blueprintId);
371:     } catch (error) {
372:       const errorMessage = error instanceof Error ? error.message : 'Fork åˆ†æ”¯å¤±è´¥';
373:       this.message.error(errorMessage);
374:     }
375:   }
376: 
377:   viewBranch(branchId: string): void {
378:     this.modal.create({
379:       nzTitle: 'åˆ†æ”¯è¯¦æƒ…',
380:       nzContent: BranchDetailComponent,
381:       nzData: {
382:         branchId
383:       },
384:       nzWidth: 800,
385:       nzFooter: null
386:     });
387:   }
388: 
389:   async syncBranch(branchId: string): Promise<void> {
390:     try {
391:       await this.branchService.syncFromMainBranch(branchId);
392:       this.message.success('åŒæ­¥æˆåŠŸ');
393:     } catch (error) {
394:       this.message.error('åŒæ­¥å¤±è´¥');
395:     }
396:   }
397: 
398:   async closeBranch(branchId: string): Promise<void> {
399:     try {
400:       await this.branchService.closeBranch(branchId);
401:       this.message.success('å…³é—­æˆåŠŸ');
402:       const blueprintId = this.blueprintId();
403:       if (blueprintId) {
404:         await this.loadBranches(blueprintId);
405:       }
406:     } catch (error) {
407:       this.message.error('å…³é—­å¤±è´¥');
408:     }
409:   }
410: 
411:   /**
412:    * åˆ‡æ›åˆ°æŒ‡å®šåˆ†æ”¯
413:    */
414:   async switchToBranch(branchId: string): Promise<void> {
415:     const blueprintId = this.blueprintId();
416:     if (!blueprintId) {
417:       this.message.error('è“å›¾IDä¸å­˜åœ¨');
418:       return;
419:     }
420: 
421:     try {
422:       // åŠ è¼‰åˆ†æ”¯ä¸¦è¨­ç½®ç‚ºç•¶å‰åˆ†æ”¯
423:       const branch = await this.branchService.loadBranchById(branchId);
424:       if (branch) {
425:         // ä½¿ç”¨BranchContextServiceè¨­ç½®ç•¶å‰åˆ†æ”¯
426:         this.branchContext.setCurrentBranch(branch);
427: 
428:         // å°èˆªåˆ°è—åœ–ä¸»é é¢
429:         this.router.navigate(['/blueprints', blueprintId], {
430:           queryParams: { branchId: branchId }
431:         });
432:         this.message.success(`å·²åˆ‡æ›åˆ°åˆ†æ”¯ï¼š${branch.branch_name}`);
433:       } else {
434:         this.message.error('åˆ†æ”¯ä¸å­˜åœ¨');
435:       }
436:     } catch (error) {
437:       this.message.error('åˆ‡æ›åˆ†æ”¯å¤±æ•—');
438:       console.error('Switch branch error:', error);
439:     }
440:   }
441: 
442:   /**
443:    * ç²å–çµ„ç¹”åç¨±
444:    */
445:   getOrganizationName(organizationId: string): string | null {
446:     const org = this.accountService.accounts().find(a => a.id === organizationId);
447:     return org?.name || null;
448:   }
449: }
````

## File: src/app/routes/quality/checks/detail/quality-check-detail.component.ts
````typescript
  1: import { Component, OnInit, inject, signal, ChangeDetectionStrategy } from '@angular/core';
  2: import { FormBuilder, FormGroup, FormControl, Validators } from '@angular/forms';
  3: import { ActivatedRoute, Router } from '@angular/router';
  4: import { SHARED_IMPORTS, QualityCheckService, QualityCheckStatus, QualityCheckItem } from '@shared';
  5: import type { QualityCheckDetail } from '@shared';
  6: 
  7: @Component({
  8:   selector: 'app-quality-check-detail',
  9:   imports: [SHARED_IMPORTS],
 10:   templateUrl: './quality-check-detail.component.html',
 11:   styleUrl: './quality-check-detail.component.less',
 12:   standalone: true,
 13:   changeDetection: ChangeDetectionStrategy.OnPush
 14: })
 15: export class QualityCheckDetailComponent implements OnInit {
 16:   private route = inject(ActivatedRoute);
 17:   private router = inject(Router);
 18:   private fb = inject(FormBuilder);
 19:   private qualityCheckService = inject(QualityCheckService);
 20: 
 21:   // Signals for component state
 22:   qualityCheck = signal<QualityCheckDetail | null>(null);
 23:   loading = signal<boolean>(false);
 24:   error = signal<string | null>(null);
 25:   isEditMode = signal<boolean>(false);
 26:   saving = signal<boolean>(false);
 27: 
 28:   // Typed reactive form
 29:   editForm!: FormGroup<{
 30:     status: FormControl<QualityCheckStatus | null>;
 31:     findings: FormControl<string | null>;
 32:     recommendations: FormControl<string | null>;
 33:   }>;
 34: 
 35:   // Status options
 36:   statusOptions = [
 37:     { label: 'å¾…æª¢æŸ¥', value: QualityCheckStatus.PENDING },
 38:     { label: 'æª¢æŸ¥ä¸­', value: QualityCheckStatus.IN_PROGRESS },
 39:     { label: 'é€šé', value: QualityCheckStatus.PASSED },
 40:     { label: 'æœªé€šé', value: QualityCheckStatus.FAILED },
 41:     { label: 'æ¢ä»¶é€šé', value: QualityCheckStatus.CONDITIONAL_PASS }
 42:   ];
 43: 
 44:   ngOnInit(): void {
 45:     this.initForm();
 46:     this.loadQualityCheck();
 47:   }
 48: 
 49:   private initForm(): void {
 50:     this.editForm = this.fb.group({
 51:       status: this.fb.control<QualityCheckStatus | null>(QualityCheckStatus.PENDING, Validators.required),
 52:       findings: this.fb.control<string | null>(''),
 53:       recommendations: this.fb.control<string | null>('')
 54:     });
 55:   }
 56: 
 57:   private async loadQualityCheck(): Promise<void> {
 58:     const id = this.route.snapshot.paramMap.get('id');
 59:     if (!id) {
 60:       this.error.set('ç¼ºå°‘å“è³ªæª¢æŸ¥ ID');
 61:       return;
 62:     }
 63: 
 64:     this.loading.set(true);
 65:     this.error.set(null);
 66: 
 67:     try {
 68:       const data = await this.qualityCheckService.getById(id);
 69:       if (data) {
 70:         this.qualityCheck.set(data);
 71:         this.updateForm(data);
 72:       } else {
 73:         this.error.set('æ‰¾ä¸åˆ°å“è³ªæª¢æŸ¥è¨˜éŒ„');
 74:       }
 75:     } catch (err) {
 76:       this.error.set(err instanceof Error ? err.message : 'è¼‰å…¥å¤±æ•—');
 77:     } finally {
 78:       this.loading.set(false);
 79:     }
 80:   }
 81: 
 82:   private updateForm(data: QualityCheckDetail): void {
 83:     this.editForm.patchValue({
 84:       status: (data.status as QualityCheckStatus) || null,
 85:       findings: data.findings || '',
 86:       recommendations: data.recommendations || ''
 87:     });
 88:   }
 89: 
 90:   toggleEditMode(): void {
 91:     this.isEditMode.set(!this.isEditMode());
 92:     if (!this.isEditMode() && this.qualityCheck()) {
 93:       this.updateForm(this.qualityCheck()!);
 94:     }
 95:   }
 96: 
 97:   async saveChanges(): Promise<void> {
 98:     if (this.editForm.invalid || !this.qualityCheck()) {
 99:       return;
100:     }
101: 
102:     this.saving.set(true);
103:     this.error.set(null);
104: 
105:     try {
106:       const formValue = this.editForm.value;
107:       await this.qualityCheckService.update(this.qualityCheck()!.id, {
108:         status: formValue.status ?? undefined,
109:         findings: formValue.findings || null,
110:         recommendations: formValue.recommendations || null,
111:         completedAt:
112:           formValue.status === QualityCheckStatus.PASSED ||
113:           formValue.status === QualityCheckStatus.FAILED ||
114:           formValue.status === QualityCheckStatus.CONDITIONAL_PASS
115:             ? new Date().toISOString()
116:             : null
117:       } as any); // ä½¿ç”¨é¡å‹æ–·è¨€ï¼Œå› ç‚º Service å±¤æœƒè™•ç† snake_case è½‰æ›
118: 
119:       // é‡æ–°è¼‰å…¥æœ€æ–°è³‡æ–™
120:       await this.loadQualityCheck();
121:       this.isEditMode.set(false);
122:     } catch (err) {
123:       this.error.set(err instanceof Error ? err.message : 'å„²å­˜å¤±æ•—');
124:     } finally {
125:       this.saving.set(false);
126:     }
127:   }
128: 
129:   goBack(): void {
130:     this.router.navigate(['/quality/checks']);
131:   }
132: 
133:   getStatusLabel(status: string | null): string {
134:     if (!status) return 'æœªçŸ¥';
135:     const statusEnum = status as QualityCheckStatus;
136:     const option = this.statusOptions.find(opt => opt.value === statusEnum);
137:     return option ? option.label : status;
138:   }
139: 
140:   getStatusColor(status: string | null): string {
141:     if (!status) return 'default';
142:     const statusEnum = status as QualityCheckStatus;
143:     switch (statusEnum) {
144:       case QualityCheckStatus.PASSED:
145:         return 'success';
146:       case QualityCheckStatus.FAILED:
147:         return 'error';
148:       case QualityCheckStatus.CONDITIONAL_PASS:
149:         return 'warning';
150:       case QualityCheckStatus.IN_PROGRESS:
151:         return 'processing';
152:       default:
153:         return 'default';
154:     }
155:   }
156: 
157:   /**
158:    * æª¢æŸ¥ checkItems æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸çµ„
159:    */
160:   hasCheckItems(checkItems: unknown[] | null): boolean {
161:     return checkItems !== null && Array.isArray(checkItems) && checkItems.length > 0;
162:   }
163: 
164:   /**
165:    * ç²å– checkItems æ•¸çµ„ï¼ˆç¢ºä¿é¡å‹å®‰å…¨ï¼‰
166:    */
167:   getCheckItems(checkItems: unknown[] | null): QualityCheckItem[] {
168:     if (checkItems === null || !Array.isArray(checkItems)) {
169:       return [];
170:     }
171:     // é¡å‹æ–·è¨€ï¼šå‡è¨­æ•¸çµ„ä¸­çš„é …ç›®ç¬¦åˆ QualityCheckItem çµæ§‹
172:     return checkItems as QualityCheckItem[];
173:   }
174: }
````

## File: src/app/shared/services/todo/personal-todo.service.ts
````typescript
  1: import { Injectable, computed, inject, signal } from '@angular/core';
  2: import { PersonalTodo, PersonalTodoRepository, SupabaseService, TodoStatusTracking, TodoStatusTrackingRepository } from '@core';
  3: import { RealtimeChannel } from '@supabase/supabase-js';
  4: import { firstValueFrom } from 'rxjs';
  5: 
  6: /**
  7:  * å¾…è¾¦ç‹€æ…‹æšèˆ‰
  8:  */
  9: export enum TodoStatus {
 10:   /** å¾…åŸ·è¡Œ ğŸŸ¦ */
 11:   PENDING = 'pending',
 12:   /** æš«å­˜ä¸­ ğŸŸ¨ */
 13:   STAGING = 'staging',
 14:   /** å“ç®¡ä¸­ ğŸŸ§ */
 15:   IN_QA = 'in_qa',
 16:   /** é©—æ”¶ä¸­ ğŸŸ¥ */
 17:   IN_INSPECTION = 'in_inspection',
 18:   /** å•é¡Œè¿½è¹¤ âš ï¸ */
 19:   ISSUE_TRACKING = 'issue_tracking',
 20:   /** å·²å®Œæˆ âœ… */
 21:   COMPLETED = 'completed'
 22: }
 23: 
 24: /**
 25:  * å¾…è¾¦é¡å‹æšèˆ‰
 26:  */
 27: export enum TodoType {
 28:   /** ä»»å‹™ */
 29:   TASK = 'task',
 30:   /** å“æª¢ */
 31:   QUALITY_CHECK = 'quality_check',
 32:   /** é©—æ”¶ */
 33:   INSPECTION = 'inspection',
 34:   /** å•é¡Œ */
 35:   ISSUE = 'issue',
 36:   /** é€šçŸ¥ */
 37:   NOTIFICATION = 'notification'
 38: }
 39: 
 40: /**
 41:  * å¾…è¾¦å„ªå…ˆç´šæšèˆ‰
 42:  */
 43: export enum TodoPriority {
 44:   /** ä½ */
 45:   LOW = 'low',
 46:   /** ä¸­ */
 47:   MEDIUM = 'medium',
 48:   /** é«˜ */
 49:   HIGH = 'high',
 50:   /** ç·Šæ€¥ */
 51:   URGENT = 'urgent'
 52: }
 53: 
 54: /**
 55:  * å¾…è¾¦çµ±è¨ˆä»‹é¢
 56:  */
 57: export interface TodoStatistics {
 58:   /** ç¸½æ•¸ */
 59:   total: number;
 60:   /** å¾…åŸ·è¡Œæ•¸é‡ ğŸŸ¦ */
 61:   pending: number;
 62:   /** æš«å­˜ä¸­æ•¸é‡ ğŸŸ¨ */
 63:   staging: number;
 64:   /** å“ç®¡ä¸­æ•¸é‡ ğŸŸ§ */
 65:   inQa: number;
 66:   /** é©—æ”¶ä¸­æ•¸é‡ ğŸŸ¥ */
 67:   inInspection: number;
 68:   /** å•é¡Œè¿½è¹¤æ•¸é‡ âš ï¸ */
 69:   issueTracking: number;
 70:   /** å·²å®Œæˆæ•¸é‡ âœ… */
 71:   completed: number;
 72:   /** é€¾æœŸæ•¸é‡ */
 73:   overdue: number;
 74: }
 75: 
 76: /**
 77:  * Personal Todo Service
 78:  *
 79:  * ç®¡ç†å€‹äººå¾…è¾¦ä¸­å¿ƒï¼Œæä¾›äº”ç¨®ç‹€æ…‹åˆ†é¡èˆ‡ Realtime å³æ™‚æ›´æ–°ï¼š
 80:  * - ğŸŸ¦ å¾…åŸ·è¡Œï¼ˆpendingï¼‰
 81:  * - ğŸŸ¨ æš«å­˜ä¸­ï¼ˆstagingï¼‰
 82:  * - ğŸŸ§ å“ç®¡ä¸­ï¼ˆin_qaï¼‰
 83:  * - ğŸŸ¥ é©—æ”¶ä¸­ï¼ˆin_inspectionï¼‰
 84:  * - âš ï¸ å•é¡Œè¿½è¹¤ï¼ˆissue_trackingï¼‰
 85:  *
 86:  * @example
 87:  * ```typescript
 88:  * const todoService = inject(PersonalTodoService);
 89:  *
 90:  * // è¨‚é–± Realtime æ›´æ–°
 91:  * await todoService.subscribeToUpdates(accountId);
 92:  *
 93:  * // å–å¾—åˆ†é¡å¾…è¾¦
 94:  * const pendingTodos = todoService.pendingTodos();
 95:  * const stagingTodos = todoService.stagingTodos();
 96:  * const qaTodos = todoService.qaTodos();
 97:  *
 98:  * // çµ±è¨ˆæ•¸æ“š
 99:  * const stats = todoService.statistics();
100:  * ```
101:  */
102: @Injectable({
103:   providedIn: 'root'
104: })
105: export class PersonalTodoService {
106:   private personalTodoRepository = inject(PersonalTodoRepository);
107:   private todoStatusTrackingRepository = inject(TodoStatusTrackingRepository);
108:   private supabaseService = inject(SupabaseService);
109: 
110:   // Realtime é »é“
111:   private realtimeChannel: RealtimeChannel | null = null;
112: 
113:   // Signals for state management
114:   private todosState = signal<PersonalTodo[]>([]);
115:   private loadingState = signal<boolean>(false);
116:   private errorState = signal<string | null>(null);
117:   private currentAccountIdState = signal<string | null>(null);
118: 
119:   // Readonly signals
120:   readonly todos = this.todosState.asReadonly();
121:   readonly loading = this.loadingState.asReadonly();
122:   readonly error = this.errorState.asReadonly();
123:   readonly currentAccountId = this.currentAccountIdState.asReadonly();
124: 
125:   // ğŸŸ¦ å¾…åŸ·è¡Œå¾…è¾¦ï¼ˆpendingï¼‰
126:   readonly pendingTodos = computed(() => this.todosState().filter(todo => !todo.status || todo.status === TodoStatus.PENDING));
127: 
128:   // ğŸŸ¨ æš«å­˜ä¸­å¾…è¾¦ï¼ˆstagingï¼‰
129:   readonly stagingTodos = computed(() => this.todosState().filter(todo => todo.status === TodoStatus.STAGING));
130: 
131:   // ğŸŸ§ å“ç®¡ä¸­å¾…è¾¦ï¼ˆin_qaï¼‰
132:   readonly qaTodos = computed(() => this.todosState().filter(todo => todo.status === TodoStatus.IN_QA));
133: 
134:   // ğŸŸ¥ é©—æ”¶ä¸­å¾…è¾¦ï¼ˆin_inspectionï¼‰
135:   readonly inspectionTodos = computed(() => this.todosState().filter(todo => todo.status === TodoStatus.IN_INSPECTION));
136: 
137:   // âš ï¸ å•é¡Œè¿½è¹¤å¾…è¾¦ï¼ˆissue_trackingï¼‰
138:   readonly issueTrackingTodos = computed(() => this.todosState().filter(todo => todo.status === TodoStatus.ISSUE_TRACKING));
139: 
140:   // âœ… å·²å®Œæˆå¾…è¾¦ï¼ˆcompletedï¼‰
141:   readonly completedTodos = computed(() => this.todosState().filter(todo => todo.status === TodoStatus.COMPLETED));
142: 
143:   // é€¾æœŸå¾…è¾¦
144:   readonly overdueTodos = computed(() => {
145:     const now = new Date();
146:     return this.todosState().filter(todo => {
147:       if (!todo.due_date || todo.status === TodoStatus.COMPLETED) {
148:         return false;
149:       }
150:       const dueDate = new Date(todo.due_date);
151:       return dueDate < now;
152:     });
153:   });
154: 
155:   // é«˜å„ªå…ˆç´šå¾…è¾¦
156:   readonly urgentTodos = computed(() =>
157:     this.todosState().filter(todo => todo.priority === TodoPriority.URGENT || todo.priority === TodoPriority.HIGH)
158:   );
159: 
160:   // çµ±è¨ˆæ•¸æ“š
161:   readonly statistics = computed<TodoStatistics>(() => ({
162:     total: this.todosState().length,
163:     pending: this.pendingTodos().length,
164:     staging: this.stagingTodos().length,
165:     inQa: this.qaTodos().length,
166:     inInspection: this.inspectionTodos().length,
167:     issueTracking: this.issueTrackingTodos().length,
168:     completed: this.completedTodos().length,
169:     overdue: this.overdueTodos().length
170:   }));
171: 
172:   /**
173:    * è¼‰å…¥å¸³è™Ÿçš„æ‰€æœ‰å¾…è¾¦
174:    *
175:    * @param accountId å¸³è™Ÿ ID
176:    */
177:   async loadTodos(accountId: string): Promise<void> {
178:     this.loadingState.set(true);
179:     this.errorState.set(null);
180: 
181:     try {
182:       const todos = await firstValueFrom(this.personalTodoRepository.findByAccountId(accountId));
183:       this.todosState.set(todos);
184:       this.currentAccountIdState.set(accountId);
185:     } catch (error) {
186:       this.errorState.set(error instanceof Error ? error.message : 'è¼‰å…¥å¾…è¾¦å¤±æ•—');
187:       throw error;
188:     } finally {
189:       this.loadingState.set(false);
190:     }
191:   }
192: 
193:   /**
194:    * è¨‚é–± Realtime æ›´æ–°
195:    *
196:    * @param accountId å¸³è™Ÿ ID
197:    */
198:   async subscribeToUpdates(accountId: string): Promise<void> {
199:     // å…ˆå–æ¶ˆèˆŠçš„è¨‚é–±
200:     await this.unsubscribeFromUpdates();
201: 
202:     // è¼‰å…¥åˆå§‹æ•¸æ“š
203:     await this.loadTodos(accountId);
204: 
205:     // å»ºç«‹ Realtime é »é“
206:     this.realtimeChannel = this.supabaseService.client
207:       .channel(`personal_todos:${accountId}`)
208:       .on(
209:         'postgres_changes',
210:         {
211:           event: '*',
212:           schema: 'public',
213:           table: 'personal_todos',
214:           filter: `account_id=eq.${accountId}`
215:         },
216:         payload => {
217:           this.handleRealtimeEvent(payload);
218:         }
219:       )
220:       .subscribe();
221:   }
222: 
223:   /**
224:    * å–æ¶ˆè¨‚é–± Realtime æ›´æ–°
225:    */
226:   async unsubscribeFromUpdates(): Promise<void> {
227:     if (this.realtimeChannel) {
228:       await this.supabaseService.client.removeChannel(this.realtimeChannel);
229:       this.realtimeChannel = null;
230:     }
231:   }
232: 
233:   /**
234:    * è™•ç† Realtime äº‹ä»¶
235:    */
236:   private handleRealtimeEvent(payload: any): void {
237:     const { eventType, new: newRecord, old: oldRecord } = payload;
238: 
239:     switch (eventType) {
240:       case 'INSERT':
241:         // æ–°å¢å¾…è¾¦
242:         this.todosState.update(todos => [...todos, newRecord as PersonalTodo]);
243:         break;
244: 
245:       case 'UPDATE':
246:         // æ›´æ–°å¾…è¾¦
247:         this.todosState.update(todos => todos.map(todo => (todo.id === newRecord.id ? (newRecord as PersonalTodo) : todo)));
248:         break;
249: 
250:       case 'DELETE':
251:         // åˆªé™¤å¾…è¾¦
252:         this.todosState.update(todos => todos.filter(todo => todo.id !== oldRecord.id));
253:         break;
254:     }
255:   }
256: 
257:   /**
258:    * æ–°å¢å¾…è¾¦
259:    *
260:    * @param accountId å¸³è™Ÿ ID
261:    * @param data å¾…è¾¦æ•¸æ“š
262:    * @returns å»ºç«‹çš„å¾…è¾¦
263:    */
264:   async createTodo(
265:     accountId: string,
266:     data: {
267:       title: string;
268:       description?: string;
269:       todoType: TodoType;
270:       relatedType?: string;
271:       relatedId?: string;
272:       priority?: TodoPriority;
273:       dueDate?: string;
274:       tags?: string[];
275:       metadata?: Record<string, any>;
276:     }
277:   ): Promise<PersonalTodo> {
278:     this.loadingState.set(true);
279:     this.errorState.set(null);
280: 
281:     try {
282:       const todo = await firstValueFrom(
283:         this.personalTodoRepository.create({
284:           account_id: accountId,
285:           title: data.title,
286:           description: data.description || null,
287:           todo_type: data.todoType,
288:           related_type: data.relatedType || null,
289:           related_id: data.relatedId || null,
290:           status: TodoStatus.PENDING,
291:           priority: data.priority || TodoPriority.MEDIUM,
292:           due_date: data.dueDate || null
293:         })
294:       );
295: 
296:       // Realtime æœƒè‡ªå‹•æ›´æ–°ï¼Œä½†ç‚ºäº†ç«‹å³åæ‡‰ï¼Œæ‰‹å‹•æ›´æ–°
297:       if (!this.realtimeChannel) {
298:         this.todosState.update(todos => [...todos, todo]);
299:       }
300: 
301:       return todo;
302:     } catch (error) {
303:       this.errorState.set(error instanceof Error ? error.message : 'æ–°å¢å¾…è¾¦å¤±æ•—');
304:       throw error;
305:     } finally {
306:       this.loadingState.set(false);
307:     }
308:   }
309: 
310:   /**
311:    * æ›´æ–°å¾…è¾¦ç‹€æ…‹
312:    *
313:    * @param todoId å¾…è¾¦ ID
314:    * @param newStatus æ–°ç‹€æ…‹
315:    * @param changedBy è®Šæ›´äºº ID
316:    * @param reason è®Šæ›´åŸå› 
317:    * @returns æ›´æ–°å¾Œçš„å¾…è¾¦
318:    */
319:   async updateTodoStatus(todoId: string, newStatus: TodoStatus, changedBy: string, reason?: string): Promise<PersonalTodo> {
320:     this.loadingState.set(true);
321:     this.errorState.set(null);
322: 
323:     try {
324:       // å–å¾—ç•¶å‰å¾…è¾¦
325:       const currentTodo = await firstValueFrom(this.personalTodoRepository.findById(todoId));
326:       if (!currentTodo) {
327:         throw new Error('å¾…è¾¦ä¸å­˜åœ¨');
328:       }
329: 
330:       const oldStatus = currentTodo.status || TodoStatus.PENDING;
331: 
332:       // æ›´æ–°å¾…è¾¦ç‹€æ…‹
333:       const todo = await firstValueFrom(
334:         this.personalTodoRepository.update(todoId, {
335:           status: newStatus
336:         })
337:       );
338: 
339:       // è¨˜éŒ„ç‹€æ…‹è®Šæ›´æ­·å²
340:       await firstValueFrom(
341:         this.todoStatusTrackingRepository.create({
342:           todo_id: todoId,
343:           from_status: oldStatus,
344:           to_status: newStatus,
345:           changed_by: changedBy,
346:           changed_at: new Date().toISOString(),
347:           change_note: reason || null
348:         })
349:       );
350: 
351:       // Realtime æœƒè‡ªå‹•æ›´æ–°ï¼Œä½†ç‚ºäº†ç«‹å³åæ‡‰ï¼Œæ‰‹å‹•æ›´æ–°
352:       if (!this.realtimeChannel) {
353:         this.todosState.update(todos => todos.map(t => (t.id === todoId ? todo : t)));
354:       }
355: 
356:       return todo;
357:     } catch (error) {
358:       this.errorState.set(error instanceof Error ? error.message : 'æ›´æ–°å¾…è¾¦ç‹€æ…‹å¤±æ•—');
359:       throw error;
360:     } finally {
361:       this.loadingState.set(false);
362:     }
363:   }
364: 
365:   /**
366:    * å®Œæˆå¾…è¾¦
367:    *
368:    * @param todoId å¾…è¾¦ ID
369:    * @param accountId å¸³è™Ÿ ID
370:    * @returns æ›´æ–°å¾Œçš„å¾…è¾¦
371:    */
372:   async completeTodo(todoId: string, accountId: string): Promise<PersonalTodo> {
373:     return this.updateTodoStatus(todoId, TodoStatus.COMPLETED, accountId, 'æ‰‹å‹•å®Œæˆ');
374:   }
375: 
376:   /**
377:    * åˆªé™¤å¾…è¾¦
378:    *
379:    * @param todoId å¾…è¾¦ ID
380:    */
381:   async deleteTodo(todoId: string): Promise<void> {
382:     this.loadingState.set(true);
383:     this.errorState.set(null);
384: 
385:     try {
386:       await firstValueFrom(this.personalTodoRepository.delete(todoId));
387: 
388:       // Realtime æœƒè‡ªå‹•æ›´æ–°ï¼Œä½†ç‚ºäº†ç«‹å³åæ‡‰ï¼Œæ‰‹å‹•æ›´æ–°
389:       if (!this.realtimeChannel) {
390:         this.todosState.update(todos => todos.filter(t => t.id !== todoId));
391:       }
392:     } catch (error) {
393:       this.errorState.set(error instanceof Error ? error.message : 'åˆªé™¤å¾…è¾¦å¤±æ•—');
394:       throw error;
395:     } finally {
396:       this.loadingState.set(false);
397:     }
398:   }
399: 
400:   /**
401:    * å–å¾—å¾…è¾¦çš„ç‹€æ…‹æ­·å²
402:    *
403:    * @param todoId å¾…è¾¦ ID
404:    * @returns ç‹€æ…‹æ­·å²åˆ—è¡¨
405:    */
406:   async getTodoStatusHistory(todoId: string): Promise<TodoStatusTracking[]> {
407:     try {
408:       return await firstValueFrom(this.todoStatusTrackingRepository.findByTodoId(todoId));
409:     } catch (error) {
410:       this.errorState.set(error instanceof Error ? error.message : 'è¼‰å…¥ç‹€æ…‹æ­·å²å¤±æ•—');
411:       throw error;
412:     }
413:   }
414: 
415:   /**
416:    * æ ¹æ“šå¾…è¾¦é¡å‹ç¯©é¸
417:    *
418:    * @param todoType å¾…è¾¦é¡å‹
419:    * @returns ç¯©é¸å¾Œçš„å¾…è¾¦åˆ—è¡¨
420:    */
421:   filterByType(todoType: TodoType): PersonalTodo[] {
422:     return this.todosState().filter(todo => todo.todo_type === todoType);
423:   }
424: 
425:   /**
426:    * æ ¹æ“šå„ªå…ˆç´šç¯©é¸
427:    *
428:    * @param priority å„ªå…ˆç´š
429:    * @returns ç¯©é¸å¾Œçš„å¾…è¾¦åˆ—è¡¨
430:    */
431:   filterByPriority(priority: TodoPriority): PersonalTodo[] {
432:     return this.todosState().filter(todo => todo.priority === priority);
433:   }
434: 
435:   /**
436:    * æ ¹æ“šç‹€æ…‹ç¯©é¸
437:    *
438:    * @param status ç‹€æ…‹
439:    * @returns ç¯©é¸å¾Œçš„å¾…è¾¦åˆ—è¡¨
440:    */
441:   filterByStatus(status: TodoStatus): PersonalTodo[] {
442:     return this.todosState().filter(todo => todo.status === status);
443:   }
444: 
445:   /**
446:    * æ¸…é™¤éŒ¯èª¤ç‹€æ…‹
447:    */
448:   clearError(): void {
449:     this.errorState.set(null);
450:   }
451: 
452:   /**
453:    * æ¸…é™¤æ‰€æœ‰è³‡æ–™
454:    */
455:   clear(): void {
456:     this.todosState.set([]);
457:     this.currentAccountIdState.set(null);
458:     this.errorState.set(null);
459:   }
460: }
````

## File: src/app/shared/services/index.ts
````typescript
 1: /**
 2:  * å…±äº«æœåŠ¡ç»Ÿä¸€å¯¼å‡º
 3:  *
 4:  * æŒ‰ä¸šåŠ¡æ¨¡å—åˆ†ç±»çš„æœåŠ¡ï¼š
 5:  * - account: è´¦æˆ·æœåŠ¡
 6:  * - repository: Repository æ¨¡å¼æœåŠ¡ï¼ˆè§„åˆ’ä¸­ï¼‰
 7:  * - storage: Storage æœåŠ¡ï¼ˆè§„åˆ’ä¸­ï¼‰
 8:  *
 9:  * @module shared/services
10:  */
11: 
12: // æŒ‰æ¨¡å—å¯¼å‡º
13: export * from './account';
14: export * from './auth';
15: export * from './collaboration';
16: export * from './blueprint';
17: export * from './task';
18: export * from './todo';
19: export * from './permission';
20: 
21: // Supabase adapter
22: export * from './supabase-adapter.service';
23: 
24: // Quality & Analytics services
25: export * from './quality-check.service';
26: export * from './analytics.service';
````

## File: src/app/core/infra/repositories/index.ts
````typescript
 1: /**
 2:  * Repository æ¨¡å—å¯¼å‡º
 3:  *
 4:  * æ³¨æ„ï¼šPermission, Role, UserRole é¡å‹å·²åœ¨ @core/permissions ä¸­å®šç¾©
 5:  * æ­¤è™•åªå°å‡º Repository é¡ï¼Œä¸å°å‡ºé¡å‹ä»¥é¿å…è¡çª
 6:  */
 7: export * from './account.repository';
 8: export * from './activity-log.repository';
 9: export * from './base.repository';
10: export * from './blueprint-branch.repository';
11: export * from './blueprint-config.repository';
12: export * from './blueprint.repository';
13: export * from './bot-execution-log.repository';
14: export * from './bot-task.repository';
15: export * from './bot.repository';
16: export * from './branch-fork.repository';
17: export * from './branch-permission.repository';
18: export * from './collaboration-invitation.repository';
19: export * from './collaboration-member.repository';
20: export * from './comment.repository';
21: export * from './daily-report.repository';
22: export * from './document-thumbnail.repository';
23: export * from './document-version.repository';
24: export * from './document.repository';
25: export * from './feature-flag.repository';
26: export * from './inspection-photo.repository';
27: export * from './inspection.repository';
28: export * from './issue-assignment.repository';
29: export * from './issue-photo.repository';
30: export * from './issue-sync-log.repository';
31: export * from './issue.repository';
32: export * from './notification-rule.repository';
33: export * from './notification-subscription.repository';
34: export * from './notification.repository';
35: export * from './organization-collaboration.repository';
36: export * from './organization-member.repository';
37: export * from './organization-schedule.repository';
38: export * from './personal-todo.repository';
39: // åªå°å‡º Repository é¡ï¼Œä¸å°å‡ºé¡å‹ï¼ˆé¿å…èˆ‡ @core/permissions è¡çªï¼‰
40: export * from './analytics-cache.repository';
41: export { PermissionRepository } from './permission.repository';
42: export type { PermissionInsert, PermissionUpdate } from './permission.repository';
43: export * from './progress-tracking.repository';
44: export * from './pull-request.repository';
45: export * from './qc-photo.repository';
46: export * from './quality-check.repository';
47: export * from './report-photo.repository';
48: export * from './role-permission.repository';
49: export * from './setting.repository';
50: // åªå°å‡º Repository é¡ï¼Œä¸å°å‡ºé¡å‹ï¼ˆé¿å…èˆ‡ @core/permissions è¡çªï¼‰
51: export { RoleRepository } from './role.repository';
52: export type { RoleInsert, RoleUpdate } from './role.repository';
53: export * from './task-assignment.repository';
54: export * from './task-dependency.repository';
55: export * from './task-list.repository';
56: export * from './task-staging.repository';
57: export * from './task-template.repository';
58: export * from './task.repository';
59: export * from './team-member.repository';
60: export * from './team.repository';
61: export * from './todo-status-tracking.repository';
62: // åªå°å‡º Repository é¡ï¼Œä¸å°å‡ºé¡å‹ï¼ˆé¿å…èˆ‡ @core/permissions è¡çªï¼‰
63: export { UserRoleRepository } from './user-role.repository';
64: export type { UserRoleInsert, UserRoleUpdate } from './user-role.repository';
65: export * from './weather-cache.repository';
````

## File: src/app/shared/models/index.ts
````typescript
 1: /**
 2:  * æ•°æ®æ¨¡å‹ç»Ÿä¸€å¯¼å‡º
 3:  *
 4:  * æŒ‰ 11 ä¸ªä¸šåŠ¡æ¨¡å—åˆ†ç±»ï¼š
 5:  * - account: è´¦æˆ·ä¸èº«ä»½ç³»ç»Ÿï¼ˆ4 å¼ è¡¨ï¼‰
 6:  * - collaboration: ç»„ç»‡åä½œç³»ç»Ÿï¼ˆ3 å¼ è¡¨ï¼‰
 7:  * - permission: æƒé™ç³»ç»Ÿï¼ˆ5 å¼ è¡¨ï¼‰
 8:  * - blueprint: è“å›¾/ä¸“æ¡ˆç³»ç»Ÿï¼ˆ5 å¼ è¡¨ï¼‰
 9:  * - task: ä»»åŠ¡æ‰§è¡Œç³»ç»Ÿï¼ˆ9 å¼ è¡¨ï¼‰
10:  * - quality: å“è´¨éªŒæ”¶ç³»ç»Ÿï¼ˆ4 å¼ è¡¨ï¼‰
11:  * - issue: é—®é¢˜è¿½è¸ªç³»ç»Ÿï¼ˆ4 å¼ è¡¨ï¼‰
12:  * - communication: åä½œæ²Ÿé€šç³»ç»Ÿï¼ˆ6 å¼ è¡¨ï¼‰
13:  * - data: èµ„æ–™åˆ†æç³»ç»Ÿï¼ˆ6 å¼ è¡¨ï¼‰
14:  * - bot: æœºå™¨äººç³»ç»Ÿï¼ˆ3 å¼ è¡¨ï¼‰
15:  * - system: ç³»ç»Ÿç®¡ç†ï¼ˆ2 å¼ è¡¨ï¼‰
16:  *
17:  * @module shared/models
18:  */
19: 
20: // æŒ‰æ¨¡å—å¯¼å‡ºï¼ˆæŒ‰ä¾èµ–é¡ºåºï¼‰
21: export * from './account.models';
22: export * from './blueprint.models';
23: export * from './bot.models';
24: export * from './collaboration.models';
25: export * from './communication.models';
26: export * from './data.models';
27: export * from './issue.models';
28: export * from './permission.models';
29: export * from './quality.models';
30: export * from './system.models';
31: export * from './task.models';
32: 
33: // æ³¨æ„ï¼šquality-check.model.ts å’Œ activity-log.model.ts å·²è¿ç§»åˆ°æ¨¡å—ç›®å½•å¹¶åˆ é™¤
34: // è¯·ä½¿ç”¨ @shared/models/quality å’Œ @shared/models/data å¯¼å…¥
35: // - QualityCheck ç›¸å…³ç±»å‹ï¼šä» @shared/models/quality å¯¼å…¥
36: // - ActivityLog ç›¸å…³ç±»å‹ï¼šä» @shared/models/data å¯¼å…¥
````

## File: src/app/shared/services/analytics.service.ts
````typescript
  1: import { Injectable, inject, signal } from '@angular/core';
  2: import { ActivityLogRepository, ActivityLog as ActivityLogDb } from '@core';
  3: import { ActivityLog, ActivityLogDetail, ActivityLogFilters, ActivityLogResourceType } from '@shared';
  4: import type { ActivityLogInsert } from '@shared';
  5: import { firstValueFrom } from 'rxjs';
  6: 
  7: /**
  8:  * Analytics Service
  9:  *
 10:  * æä¾›æ´»å‹•è¨˜éŒ„èˆ‡åˆ†æç›¸é—œçš„æ¥­å‹™é‚è¼¯
 11:  * ä½¿ç”¨ Signals ç®¡ç†ç‹€æ…‹
 12:  *
 13:  * @example
 14:  * ```typescript
 15:  * const analyticsService = inject(AnalyticsService);
 16:  *
 17:  * // è¼‰å…¥æ´»å‹•è¨˜éŒ„è©³æƒ…
 18:  * await analyticsService.getActivityLogById('log-id');
 19:  * ```
 20:  */
 21: @Injectable({
 22:   providedIn: 'root'
 23: })
 24: export class AnalyticsService {
 25:   private activityLogRepository = inject(ActivityLogRepository);
 26: 
 27:   // ä½¿ç”¨ Signals ç®¡ç†ç‹€æ…‹
 28:   private loadingState = signal<boolean>(false);
 29:   private errorState = signal<string | null>(null);
 30: 
 31:   // æš´éœ² ReadonlySignal çµ¦çµ„ä»¶
 32:   readonly loading = this.loadingState.asReadonly();
 33:   readonly error = this.errorState.asReadonly();
 34: 
 35:   /**
 36:    * å°‡è³‡æ–™åº«é¡å‹è½‰æ›ç‚ºæ‡‰ç”¨æ¨¡å‹é¡å‹ï¼ˆcamelCaseï¼‰
 37:    * æ³¨æ„ï¼šè¿”å›çš„å°è±¡ä½¿ç”¨ camelCase å±¬æ€§åç¨±
 38:    */
 39:   private mapToActivityLog(dbLog: ActivityLogDb): {
 40:     id: string;
 41:     blueprintId: string;
 42:     branchId: string | null;
 43:     actorId: string;
 44:     action: string;
 45:     resourceType: string;
 46:     resourceId: string | null;
 47:     actionDetails: Record<string, unknown> | null;
 48:     ipAddress: string | null;
 49:     userAgent: string | null;
 50:     createdAt: string;
 51:   } {
 52:     return {
 53:       id: dbLog.id,
 54:       blueprintId: dbLog.blueprint_id,
 55:       branchId: dbLog.branch_id,
 56:       actorId: dbLog.actor_id,
 57:       action: dbLog.action,
 58:       resourceType: dbLog.resource_type,
 59:       resourceId: dbLog.resource_id,
 60:       actionDetails: dbLog.action_details as Record<string, unknown> | null,
 61:       ipAddress: dbLog.ip_address as string | null,
 62:       userAgent: dbLog.user_agent,
 63:       createdAt: dbLog.created_at ?? new Date().toISOString()
 64:     };
 65:   }
 66: 
 67:   /**
 68:    * æ ¹æ“š ID å–å¾—æ´»å‹•è¨˜éŒ„è©³æƒ…
 69:    */
 70:   async getActivityLogById(id: string): Promise<ActivityLogDetail | null> {
 71:     this.loadingState.set(true);
 72:     this.errorState.set(null);
 73: 
 74:     try {
 75:       const dbLog = await firstValueFrom(this.activityLogRepository.findById(id));
 76: 
 77:       if (!dbLog) {
 78:         return null;
 79:       }
 80: 
 81:       // å°‡è³‡æ–™åº«é¡å‹è½‰æ›ç‚ºæ‡‰ç”¨æ¨¡å‹é¡å‹
 82:       const activityLog = this.mapToActivityLog(dbLog);
 83: 
 84:       // å°‡è³‡æ–™è½‰æ›ç‚º ActivityLogDetail æ ¼å¼
 85:       const activityLogDetail: ActivityLogDetail = {
 86:         id: activityLog.id,
 87:         blueprintId: activityLog.blueprintId,
 88:         branchId: activityLog.branchId,
 89:         actorId: activityLog.actorId,
 90:         action: activityLog.action,
 91:         resourceType: activityLog.resourceType as ActivityLogResourceType,
 92:         resourceId: activityLog.resourceId,
 93:         actionDetails: activityLog.actionDetails,
 94:         ipAddress: activityLog.ipAddress,
 95:         userAgent: activityLog.userAgent,
 96:         createdAt: activityLog.createdAt,
 97:         // TODO: è¼‰å…¥é—œè¯çš„ actor, blueprint, branch è³‡æ–™
 98:         actor: undefined,
 99:         blueprint: undefined,
100:         branch: undefined
101:       };
102: 
103:       return activityLogDetail;
104:     } catch (error) {
105:       const errorMessage = error instanceof Error ? error.message : 'è¼‰å…¥æ´»å‹•è¨˜éŒ„å¤±æ•—';
106:       this.errorState.set(errorMessage);
107:       throw error;
108:     } finally {
109:       this.loadingState.set(false);
110:     }
111:   }
112: 
113:   /**
114:    * æŸ¥è©¢æ´»å‹•è¨˜éŒ„åˆ—è¡¨
115:    */
116:   async getActivityLogs(filters: ActivityLogFilters = {}, limit = 50): Promise<ActivityLog[]> {
117:     this.loadingState.set(true);
118:     this.errorState.set(null);
119: 
120:     try {
121:       const options: any = {
122:         limit,
123:         filters: {}
124:       };
125: 
126:       if (filters.blueprintId) {
127:         options.filters.blueprintId = filters.blueprintId;
128:       }
129:       if (filters.branchId !== undefined) {
130:         options.filters.branchId = filters.branchId;
131:       }
132:       if (filters.actorId) {
133:         options.filters.actorId = filters.actorId;
134:       }
135:       if (filters.resourceType) {
136:         options.filters.resourceType = filters.resourceType;
137:       }
138:       if (filters.resourceId) {
139:         options.filters.resourceId = filters.resourceId;
140:       }
141: 
142:       const dbLogs = await firstValueFrom(this.activityLogRepository.findAll(options));
143:       return dbLogs.map(dbLog => this.mapToActivityLog(dbLog));
144:     } catch (error) {
145:       const errorMessage = error instanceof Error ? error.message : 'è¼‰å…¥æ´»å‹•è¨˜éŒ„åˆ—è¡¨å¤±æ•—';
146:       this.errorState.set(errorMessage);
147:       throw error;
148:     } finally {
149:       this.loadingState.set(false);
150:     }
151:   }
152: 
153:   /**
154:    * æ–°å¢æ´»å‹•è¨˜éŒ„
155:    */
156:   async createActivityLog(data: ActivityLogInsert): Promise<ActivityLog> {
157:     this.loadingState.set(true);
158:     this.errorState.set(null);
159: 
160:     try {
161:       // ä½¿ç”¨ camelCaseï¼ŒBaseRepository æœƒè‡ªå‹•è½‰æ›ç‚º snake_case
162:       const dbInsertData = {
163:         actorId: data.actorId,
164:         blueprintId: data.blueprintId,
165:         branchId: data.branchId,
166:         action: data.action,
167:         resourceType: data.resourceType,
168:         resourceId: data.resourceId,
169:         actionDetails: data.actionDetails,
170:         ipAddress: data.ipAddress,
171:         userAgent: data.userAgent
172:       } as any; // é¡å‹æ–·è¨€ï¼Œå› ç‚º BaseRepository æœƒè™•ç†è½‰æ›
173: 
174:       const dbLog = await firstValueFrom(this.activityLogRepository.create(dbInsertData));
175:       return this.mapToActivityLog(dbLog);
176:     } catch (error) {
177:       const errorMessage = error instanceof Error ? error.message : 'æ–°å¢æ´»å‹•è¨˜éŒ„å¤±æ•—';
178:       this.errorState.set(errorMessage);
179:       throw error;
180:     } finally {
181:       this.loadingState.set(false);
182:     }
183:   }
184: 
185:   /**
186:    * æ¸…é™¤éŒ¯èª¤ç‹€æ…‹
187:    */
188:   clearError(): void {
189:     this.errorState.set(null);
190:   }
191: }
````

## File: src/app/shared/services/quality-check.service.ts
````typescript
  1: import { Injectable, inject, signal } from '@angular/core';
  2: import { QualityCheckRepository, QualityCheck as QualityCheckDb } from '@core';
  3: import { QualityCheck, QualityCheckDetail } from '@shared';
  4: import type { QualityCheckInsert, QualityCheckUpdate } from '@shared';
  5: import { firstValueFrom } from 'rxjs';
  6: 
  7: /**
  8:  * Quality Check Service
  9:  *
 10:  * æä¾›å“è³ªæª¢æŸ¥ç›¸é—œçš„æ¥­å‹™é‚è¼¯å’Œç‹€æ…‹ç®¡ç†
 11:  * ä½¿ç”¨ Signals ç®¡ç†ç‹€æ…‹ï¼Œæš´éœ² ReadonlySignal çµ¦çµ„ä»¶
 12:  *
 13:  * @example
 14:  * ```typescript
 15:  * const qcService = inject(QualityCheckService);
 16:  *
 17:  * // è¼‰å…¥å“è³ªæª¢æŸ¥è©³æƒ…
 18:  * await qcService.getById('check-id');
 19:  * ```
 20:  */
 21: @Injectable({
 22:   providedIn: 'root'
 23: })
 24: export class QualityCheckService {
 25:   private qualityCheckRepository = inject(QualityCheckRepository);
 26: 
 27:   // ä½¿ç”¨ Signals ç®¡ç†ç‹€æ…‹
 28:   private loadingState = signal<boolean>(false);
 29:   private errorState = signal<string | null>(null);
 30: 
 31:   // æš´éœ² ReadonlySignal çµ¦çµ„ä»¶
 32:   readonly loading = this.loadingState.asReadonly();
 33:   readonly error = this.errorState.asReadonly();
 34: 
 35:   /**
 36:    * å°‡è³‡æ–™åº«é¡å‹è½‰æ›ç‚ºæ‡‰ç”¨æ¨¡å‹é¡å‹
 37:    */
 38:   private mapToQualityCheck(dbCheck: QualityCheckDb): QualityCheck {
 39:     return {
 40:       id: dbCheck.id,
 41:       taskId: dbCheck.task_id,
 42:       stagingId: dbCheck.staging_id,
 43:       inspectorId: dbCheck.inspector_id,
 44:       checkType: dbCheck.check_type as any,
 45:       status: dbCheck.status as any,
 46:       checkItems: dbCheck.check_items as any,
 47:       findings: dbCheck.findings,
 48:       recommendations: dbCheck.recommendations,
 49:       checkedAt: dbCheck.checked_at ?? new Date().toISOString(),
 50:       completedAt: dbCheck.completed_at
 51:     };
 52:   }
 53: 
 54:   /**
 55:    * æ ¹æ“š ID å–å¾—å“è³ªæª¢æŸ¥è©³æƒ…
 56:    */
 57:   async getById(id: string): Promise<QualityCheckDetail | null> {
 58:     this.loadingState.set(true);
 59:     this.errorState.set(null);
 60: 
 61:     try {
 62:       const dbCheck = await firstValueFrom(this.qualityCheckRepository.findById(id));
 63: 
 64:       if (!dbCheck) {
 65:         return null;
 66:       }
 67: 
 68:       // å°‡è³‡æ–™åº«é¡å‹è½‰æ›ç‚ºæ‡‰ç”¨æ¨¡å‹é¡å‹
 69:       const qualityCheck = this.mapToQualityCheck(dbCheck);
 70: 
 71:       // å°‡è³‡æ–™è½‰æ›ç‚º QualityCheckDetail æ ¼å¼
 72:       const qualityCheckDetail: QualityCheckDetail = {
 73:         id: qualityCheck.id,
 74:         taskId: qualityCheck.taskId,
 75:         stagingId: qualityCheck.stagingId,
 76:         inspectorId: qualityCheck.inspectorId,
 77:         checkType: qualityCheck.checkType,
 78:         status: qualityCheck.status,
 79:         checkItems: qualityCheck.checkItems,
 80:         findings: qualityCheck.findings,
 81:         recommendations: qualityCheck.recommendations,
 82:         checkedAt: qualityCheck.checkedAt,
 83:         completedAt: qualityCheck.completedAt,
 84:         // TODO: è¼‰å…¥é—œè¯çš„ task å’Œ inspector è³‡æ–™
 85:         task: undefined,
 86:         inspector: undefined,
 87:         photos: undefined
 88:       };
 89: 
 90:       return qualityCheckDetail;
 91:     } catch (error) {
 92:       const errorMessage = error instanceof Error ? error.message : 'è¼‰å…¥å“è³ªæª¢æŸ¥å¤±æ•—';
 93:       this.errorState.set(errorMessage);
 94:       throw error;
 95:     } finally {
 96:       this.loadingState.set(false);
 97:     }
 98:   }
 99: 
100:   /**
101:    * æ–°å¢å“è³ªæª¢æŸ¥
102:    */
103:   async create(data: QualityCheckInsert): Promise<QualityCheck> {
104:     this.loadingState.set(true);
105:     this.errorState.set(null);
106: 
107:     try {
108:       const dbInsertData = {
109:         task_id: data.taskId,
110:         staging_id: data.stagingId,
111:         inspector_id: data.inspectorId,
112:         check_type: data.checkType,
113:         status: data.status,
114:         check_items: data.checkItems as any,
115:         findings: data.findings,
116:         recommendations: data.recommendations,
117:         checked_at: data.checkedAt,
118:         completed_at: data.completedAt
119:       };
120: 
121:       const dbCheck = await firstValueFrom(this.qualityCheckRepository.create(dbInsertData));
122:       return this.mapToQualityCheck(dbCheck);
123:     } catch (error) {
124:       const errorMessage = error instanceof Error ? error.message : 'æ–°å¢å“è³ªæª¢æŸ¥å¤±æ•—';
125:       this.errorState.set(errorMessage);
126:       throw error;
127:     } finally {
128:       this.loadingState.set(false);
129:     }
130:   }
131: 
132:   /**
133:    * æ›´æ–°å“è³ªæª¢æŸ¥
134:    */
135:   async update(id: string, data: QualityCheckUpdate): Promise<QualityCheck> {
136:     this.loadingState.set(true);
137:     this.errorState.set(null);
138: 
139:     try {
140:       // ä½¿ç”¨ camelCaseï¼ŒBaseRepository æœƒè‡ªå‹•è½‰æ›ç‚º snake_case
141:       const dbUpdateData: Record<string, unknown> = {};
142:       if (data.status !== undefined) dbUpdateData['status'] = data.status;
143:       if (data.checkItems !== undefined) dbUpdateData['checkItems'] = data.checkItems;
144:       if (data.findings !== undefined) dbUpdateData['findings'] = data.findings;
145:       if (data.recommendations !== undefined) dbUpdateData['recommendations'] = data.recommendations;
146:       if (data.completedAt !== undefined) dbUpdateData['completedAt'] = data.completedAt;
147: 
148:       const dbCheck = await firstValueFrom(this.qualityCheckRepository.update(id, dbUpdateData));
149:       return this.mapToQualityCheck(dbCheck);
150:     } catch (error) {
151:       const errorMessage = error instanceof Error ? error.message : 'æ›´æ–°å“è³ªæª¢æŸ¥å¤±æ•—';
152:       this.errorState.set(errorMessage);
153:       throw error;
154:     } finally {
155:       this.loadingState.set(false);
156:     }
157:   }
158: 
159:   /**
160:    * åˆªé™¤å“è³ªæª¢æŸ¥
161:    */
162:   async delete(id: string): Promise<void> {
163:     this.loadingState.set(true);
164:     this.errorState.set(null);
165: 
166:     try {
167:       await firstValueFrom(this.qualityCheckRepository.delete(id));
168:     } catch (error) {
169:       const errorMessage = error instanceof Error ? error.message : 'åˆªé™¤å“è³ªæª¢æŸ¥å¤±æ•—';
170:       this.errorState.set(errorMessage);
171:       throw error;
172:     } finally {
173:       this.loadingState.set(false);
174:     }
175:   }
176: 
177:   /**
178:    * æ¸…é™¤éŒ¯èª¤ç‹€æ…‹
179:    */
180:   clearError(): void {
181:     this.errorState.set(null);
182:   }
183: }
````
