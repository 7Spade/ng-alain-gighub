# 蓝图设计问题分析

**日期**：2025-01-15  
**范围**：蓝图创建、拥有者管理、个人/组织蓝图支持

---

## 🔍 发现的设计不一致

### 1. 数据库约束 vs 架构文档 vs 用户需求

#### 当前状态

**数据库约束**（`docs/30-0-完整SQL表結構定義.md`）：
```sql
CONSTRAINT chk_owner_is_org CHECK (
  EXISTS (SELECT 1 FROM accounts WHERE id = owner_id AND type = 'Organization')
)
```
- ❌ **只允许 Organization 类型作为拥有者**

**架构文档**（`docs/27-完整架構流程圖.mermaid.md` 第68-70行）：
```mermaid
User -.直接擁有/建立.-> CreateBlueprint
Bot -.直接擁有/建立.-> CreateBlueprint
Org -.直接擁有/建立 Main.-> CreateBlueprint
```
- ✅ **显示 User、Bot、Organization 都可以建立蓝图**

**系统架构思维导图**（`docs/10-系統架構思維導圖.mermaid.md` 第72-75行）：
```
拥有权
  个人专案
  组织专案
  团队协作
```
- ✅ **明确支持"个人专案"和"组织专案"**

**用户需求**：
- ✅ **蓝图是个人/组织都可以建立的**

#### 问题

**设计不一致**：
- 数据库约束只允许 Organization
- 但架构文档和用户需求都支持个人蓝图
- 这导致个人用户无法创建蓝图

---

### 2. RLS 策略限制

#### 当前 RLS 策略

**INSERT 策略**（`Organizations can create blueprints`）：
```sql
WITH CHECK (
  owner_id IN (
    SELECT a.id
    FROM accounts a
    WHERE (
      (a.type)::text = 'Organization'::text
      AND EXISTS (
        SELECT 1
        FROM ((team_members tm
          JOIN teams t ON ((tm.team_id = t.id)))
          JOIN accounts user_account ON ((tm.account_id = user_account.id)))
        WHERE (
          (t.organization_id = a.id)
          AND (user_account.auth_user_id = auth.uid())
          AND ((tm.role)::text = 'leader'::text)
        )
      )
    )
  )
)
```
- ❌ **只允许组织团队的 leader 创建蓝图**

**SELECT 策略**（`Users can view blueprints they own or collaborate on`）：
```sql
USING (
  (owner_id IN (
    SELECT accounts.id
    FROM accounts
    WHERE (accounts.auth_user_id = auth.uid())
  ))
  OR
  (EXISTS (...协作关系检查...))
)
```
- ✅ **允许用户查看自己拥有的蓝图**（通过 `auth_user_id` 匹配）

#### 问题

**RLS 策略不一致**：
- INSERT 策略只允许组织创建
- SELECT 策略允许用户查看自己拥有的蓝图（暗示用户可以是拥有者）
- 这导致用户无法创建个人蓝图，但可以查看（如果存在）

---

### 3. 前端表单设计问题

#### 当前实现（`blueprint-form.component.ts`）

**拥有者ID输入**：
```typescript
<nz-form-item>
  <nz-form-label [nzSpan]="4" nzRequired>拥有者ID</nz-form-label>
  <nz-form-control [nzSpan]="20" [nzErrorTip]="'请输入拥有者ID'">
    <input nz-input formControlName="ownerId" placeholder="请输入拥有者ID" />
  </nz-form-control>
</nz-form-item>
```

#### 问题

1. **用户体验差**：
   - 要求用户手动输入 UUID
   - 用户不知道自己的账户 ID 或组织 ID
   - 没有验证机制

2. **缺少选择器**：
   - 没有提供账户选择器（个人账户 vs 组织账户）
   - 没有显示用户可用的账户列表
   - 没有区分个人蓝图和组织蓝图

3. **缺少默认值**：
   - 创建时没有自动填充当前用户的账户 ID
   - 没有根据用户类型（个人/组织成员）提供建议

---

### 4. 蓝图列表显示问题

#### 当前实现（`blueprint-list.component.ts`）

**拥有者显示**：
```typescript
{ title: '拥有者', index: 'owner_id', width: 150 }
```
- ❌ **只显示 UUID，不显示账户名称或类型**

#### 问题

1. **可读性差**：
   - 显示 UUID 而不是账户名称
   - 无法区分个人蓝图和组织蓝图
   - 用户无法快速识别蓝图的拥有者

2. **缺少过滤**：
   - 没有按拥有者类型过滤（个人/组织）
   - 没有按当前用户拥有的蓝图过滤
   - 没有按组织过滤

---

### 5. 蓝图详情页显示问题

#### 当前实现（`blueprint-detail.component.ts`）

**拥有者显示**：
```typescript
<nz-descriptions-item nzTitle="拥有者">{{ blueprint()!.owner_id }}</nz-descriptions-item>
```
- ❌ **只显示 UUID**

#### 问题

1. **信息不完整**：
   - 无法知道拥有者是个人还是组织
   - 无法显示拥有者名称
   - 无法链接到拥有者详情页

---

## 📋 设计不明确的地方

### 1. 个人蓝图 vs 组织蓝图

#### 问题

- **个人蓝图**：用户直接拥有，是否可以 Fork 给组织？
- **组织蓝图**：组织拥有，是否可以转移给个人？
- **权限差异**：个人蓝图和组织蓝图的权限管理是否相同？

#### 需要明确

1. **个人蓝图的特点**：
   - 是否可以 Fork 给组织？
   - 是否可以邀请组织协作？
   - 权限管理是否与组织蓝图相同？

2. **组织蓝图的特点**：
   - 是否只有组织成员可以查看？
   - 是否可以转移给个人？
   - 组织解散后蓝图如何处理？

---

### 2. 蓝图创建流程

#### 问题

- 用户创建蓝图时，如何选择拥有者？
- 是否应该自动创建为个人蓝图？
- 组织成员创建蓝图时，是否应该默认选择组织？

#### 需要明确

1. **创建流程**：
   - 用户点击"创建蓝图"后，是否应该先选择拥有者类型（个人/组织）？
   - 如果用户只属于一个组织，是否应该自动选择该组织？
   - 如果用户属于多个组织，如何选择？

2. **默认行为**：
   - 个人用户创建蓝图时，是否应该默认选择个人账户？
   - 组织成员创建蓝图时，是否应该默认选择组织？

---

### 3. 蓝图拥有者变更

#### 问题

- 个人蓝图是否可以转移给组织？
- 组织蓝图是否可以转移给个人？
- 转移后权限如何处理？

#### 需要明确

1. **转移规则**：
   - 谁可以发起转移？
   - 转移是否需要审批？
   - 转移后历史数据如何处理？

2. **权限继承**：
   - 转移后，原拥有者的权限如何处理？
   - 新拥有者的权限如何设置？

---

### 4. 蓝图列表过滤和搜索

#### 问题

- 如何区分个人蓝图和组织蓝图？
- 如何过滤"我拥有的蓝图"？
- 如何过滤"我参与协作的蓝图"？

#### 需要明确

1. **过滤选项**：
   - 按拥有者类型过滤（个人/组织）
   - 按拥有者过滤（我拥有的/我参与的）
   - 按状态过滤

2. **搜索功能**：
   - 是否支持按拥有者名称搜索？
   - 是否支持按项目代码搜索？

---

### 5. 蓝图权限管理

#### 问题

- 个人蓝图的权限管理是否与组织蓝图相同？
- 个人蓝图是否可以设置协作组织？
- 组织蓝图是否可以设置个人协作者？

#### 需要明确

1. **权限模型**：
   - 个人蓝图是否支持角色权限？
   - 组织蓝图是否支持个人协作者？

2. **协作关系**：
   - 个人蓝图是否可以邀请组织协作？
   - 组织蓝图是否可以邀请个人协作？

---

## 🎯 建议的解决方案

### 方案 A：支持个人和组织蓝图（推荐）

#### 数据库变更

1. **移除约束**：
   ```sql
   ALTER TABLE blueprints DROP CONSTRAINT IF EXISTS chk_owner_is_org;
   ```

2. **更新 RLS 策略**：
   - INSERT：允许用户创建个人蓝图（`owner_id = 用户账户ID`）
   - INSERT：允许组织成员创建组织蓝图（`owner_id = 组织账户ID`）
   - SELECT：保持现有策略（支持个人和组织）

#### 前端变更

1. **创建表单**：
   - 添加拥有者类型选择器（个人/组织）
   - 添加账户选择器（显示用户账户和所属组织）
   - 自动填充默认值（个人用户默认选择个人账户）

2. **列表页面**：
   - 显示拥有者名称和类型
   - 添加过滤选项（个人/组织/我拥有的/我参与的）
   - 添加搜索功能

3. **详情页面**：
   - 显示拥有者名称和类型
   - 添加拥有者链接
   - 显示拥有者类型标签

---

### 方案 B：只支持组织蓝图（不推荐）

#### 数据库变更

1. **保持约束**：继续要求 `owner_id` 必须是 Organization

2. **更新架构文档**：移除 User/Bot 可以创建蓝图的描述

3. **更新前端**：
   - 只允许选择组织作为拥有者
   - 个人用户需要先创建组织才能创建蓝图

#### 问题

- 不符合用户需求（个人/组织都可以建立）
- 增加使用门槛（个人用户需要先创建组织）

---

## 📝 实施建议

### 优先级 1：修复数据库约束和 RLS 策略

1. **移除 `chk_owner_is_org` 约束**
2. **更新 INSERT RLS 策略**，支持个人和组织创建
3. **验证 SELECT/UPDATE/DELETE 策略**，确保支持个人和组织

### 优先级 2：改进前端表单

1. **添加拥有者选择器**
   - 显示用户账户和所属组织
   - 支持切换个人/组织
   - 自动填充默认值

2. **改进用户体验**
   - 添加帮助文本
   - 添加验证提示
   - 添加账户类型标签

### 优先级 3：改进列表和详情页

1. **显示拥有者信息**
   - 显示账户名称和类型
   - 添加过滤和搜索功能

2. **添加权限提示**
   - 显示用户对蓝图的权限
   - 显示协作关系

---

## 🔍 相关文件

### 需要修改的文件

1. **数据库**：
   - 移除 `chk_owner_is_org` 约束
   - 更新 RLS 策略

2. **前端**：
   - `src/app/routes/blueprints/form/blueprint-form.component.ts`
   - `src/app/routes/blueprints/list/blueprint-list.component.ts`
   - `src/app/routes/blueprints/detail/blueprint-detail.component.ts`

3. **文档**：
   - `docs/30-0-完整SQL表結構定義.md`
   - `docs/27-完整架構流程圖.mermaid.md`
   - `docs/10-系統架構思維導圖.mermaid.md`

---

**最后更新**：2025-01-15  
**维护者**：开发团队

