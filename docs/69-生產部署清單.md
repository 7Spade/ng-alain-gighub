# 生產部署清單

**版本**: 1.0  
**最後更新**: 2025-11-16  
**適用範圍**: Phase 4-5 功能部署  
**描述**: TaskListComponent 增強功能與測試的生產環境部署檢查清單

---

## 📋 概覽

本清單確保 Phase 4-5 實施的功能安全、正確地部署到生產環境。所有檢查項目必須完成並驗證通過才能進行部署。

**部署範圍**:
- TaskListComponent UI 增強
- 狀態機整合
- 暫存控制功能
- 響應式過濾器
- 單元測試

---

## ⚙️ 部署前檢查

### 1. 程式碼品質 ✓

#### 1.1 程式碼審查

- [ ] 所有程式碼已通過 Code Review
- [ ] 無未解決的 PR 評論
- [ ] 符合專案編碼規範
- [ ] 無 console.log 或調試程式碼

**驗證命令**:
```bash
# 檢查未提交的變更
git status

# 檢查分支狀態
git log --oneline -10
```

#### 1.2 靜態分析

- [ ] TypeScript 編譯無錯誤
- [ ] ESLint 檢查通過
- [ ] 樣式檢查通過
- [ ] 無型別錯誤

**驗證命令**:
```bash
# TypeScript 類型檢查
yarn type-check

# ESLint 檢查
yarn lint:ts

# 樣式檢查
yarn lint:style
```

**預期結果**: 所有檢查通過，無錯誤或警告

#### 1.3 建置驗證

- [ ] 開發建置成功
- [ ] 生產建置成功
- [ ] 建置時間合理（<60 秒）
- [ ] 輸出檔案大小合理

**驗證命令**:
```bash
# 開發建置
yarn build

# 檢查輸出大小
ls -lh dist/ng-alain-gighub/
```

**預期結果**:
- 建置成功，無錯誤
- 主要 chunk < 500KB
- 總大小 < 5MB

---

### 2. 測試驗證 ✓

#### 2.1 單元測試

- [ ] 所有單元測試通過
- [ ] TaskListComponent 測試通過（30+ 案例）
- [ ] 測試覆蓋率 ≥ 80%
- [ ] 無跳過的測試

**驗證命令**:
```bash
# 執行所有測試
yarn test --watch=false

# 執行特定測試
yarn test --include='**/task-list.component.spec.ts' --watch=false

# 檢查覆蓋率
yarn test-coverage
```

**預期結果**:
- 所有測試通過（綠色）
- 覆蓋率 ≥ 80%
- 無失敗或錯誤

#### 2.2 整合測試

- [ ] 服務整合測試通過
- [ ] TaskService 整合測試
- [ ] TaskStagingService 整合測試
- [ ] AuthStateService 整合測試

**驗證方式**:
- 手動測試關鍵流程
- 驗證服務間通訊
- 確認資料流正確

#### 2.3 E2E 測試（可選）

- [ ] 關鍵使用者流程測試
- [ ] 狀態轉換流程
- [ ] 暫存撤回流程
- [ ] 過濾器功能

**注意**: Phase 5.2 E2E 測試標記為可選

---

### 3. 資料庫準備 ✓

#### 3.1 Schema 驗證

- [ ] 所有必要資料表存在
- [ ] `tasks` 表結構正確
- [ ] `task_staging` 表結構正確
- [ ] `personal_todos` 表結構正確（Phase 3 修正）
- [ ] `todo_status_tracking` 表結構正確（Phase 3 修正）

**驗證方式**:
```sql
-- 檢查表存在
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
  AND table_name IN ('tasks', 'task_staging', 'personal_todos', 'todo_status_tracking');

-- 檢查 personal_todos 欄位（不應有 tags）
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'personal_todos';

-- 檢查 todo_status_tracking 欄位（應有 change_note 而非 reason）
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'todo_status_tracking';
```

**預期結果**:
- 所有表存在
- `personal_todos` 無 `tags` 欄位
- `todo_status_tracking` 有 `change_note` 欄位

#### 3.2 RLS 策略

- [ ] `tasks` 表 RLS 啟用
- [ ] `task_staging` 表 RLS 啟用
- [ ] `personal_todos` 表 RLS 啟用
- [ ] 所有策略正確設定

**驗證方式**:
```sql
-- 檢查 RLS 啟用狀態
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' 
  AND tablename IN ('tasks', 'task_staging', 'personal_todos');

-- 列出所有策略
SELECT schemaname, tablename, policyname, cmd, roles 
FROM pg_policies 
WHERE tablename IN ('tasks', 'task_staging', 'personal_todos');
```

**預期結果**:
- 所有表 `rowsecurity = true`
- 每個表至少有 2 個策略（SELECT, INSERT/UPDATE）

#### 3.3 測試資料

- [ ] 開發環境有測試資料
- [ ] 測試資料涵蓋所有狀態
- [ ] 測試資料包含暫存任務
- [ ] 測試資料包含過期案例

**建議測試資料**:
```sql
-- 插入測試任務（各種狀態）
INSERT INTO tasks (blueprint_id, title, status, priority, task_type) VALUES
  ('blueprint-1', '測試待處理任務', 'pending', 'medium', 'task'),
  ('blueprint-1', '測試進行中任務', 'in_progress', 'high', 'task'),
  ('blueprint-1', '測試暫存任務', 'staging', 'urgent', 'task'),
  ('blueprint-1', '測試完成任務', 'completed', 'low', 'task');

-- 插入暫存測試資料
INSERT INTO task_staging (task_id, submitted_by, staging_data, expires_at) VALUES
  ('task-id', 'user-id', '{}', NOW() + INTERVAL '48 hours');
```

---

### 4. 安全檢查 ✓

#### 4.1 認證與授權

- [ ] 所有 API 端點受保護
- [ ] Supabase Auth 正常運作
- [ ] Token 驗證正確
- [ ] 權限檢查正確實施

**檢查項目**:
```typescript
// AuthStateService 正確整合
authState.user() // 返回當前用戶或 null

// 權限檢查實施
if (!currentUser) {
  this.message.error('未登录用户无法执行此操作');
  return;
}
```

#### 4.2 輸入驗證

- [ ] 所有使用者輸入已驗證
- [ ] 狀態轉換驗證（狀態機）
- [ ] 撤回權限驗證
- [ ] 無 SQL 注入風險

**驗證方式**:
- 測試無效狀態轉換
- 測試未授權撤回
- 測試邊界條件

#### 4.3 敏感資料

- [ ] 無敏感資料暴露於前端
- [ ] 無 API 金鑰於程式碼中
- [ ] 環境變數正確設定
- [ ] .env 檔案於 .gitignore

**檢查命令**:
```bash
# 搜尋潛在敏感資料
grep -r "password\|secret\|api_key\|token" src/ --exclude-dir=node_modules

# 檢查 .gitignore
cat .gitignore | grep .env
```

---

### 5. 效能驗證 ✓

#### 5.1 載入時間

- [ ] 首次載入 < 3 秒
- [ ] 藍圖切換 < 1 秒
- [ ] 過濾器回應 < 100ms
- [ ] 狀態變更 < 500ms

**測試方式**:
- Chrome DevTools Performance tab
- Network tab 檢查請求時間
- 手動計時關鍵操作

#### 5.2 記憶體使用

- [ ] 無記憶體洩漏
- [ ] 組件正確清理
- [ ] Signal 訂閱正確取消
- [ ] 長時間運行穩定

**驗證命令**:
```typescript
// 確認 OnDestroy 實作
ngOnDestroy(): void {
  // 清理邏輯
}
```

#### 5.3 大數據處理

- [ ] 100 個任務載入正常
- [ ] 1000 個任務載入可接受
- [ ] 過濾器處理大列表無延遲
- [ ] Computed Signal 效能良好

**測試方式**:
- 建立大量測試資料
- 測試過濾器效能
- 監控 CPU 使用率

---

### 6. 使用者體驗 ✓

#### 6.1 回饋訊息

- [ ] 成功操作有確認訊息
- [ ] 錯誤操作有明確說明
- [ ] Loading 狀態正確顯示
- [ ] 所有訊息使用中文

**檢查項目**:
```typescript
// 成功訊息
this.message.success('状态更新成功');

// 錯誤訊息
this.message.error('找不到暂存信息');
```

#### 6.2 視覺設計

- [ ] 所有狀態標籤正確顏色
- [ ] 倒計時清晰可見
- [ ] 按鈕狀態明確（啟用/停用）
- [ ] 響應式設計正常

**檢查點**:
- 桌面版（1920x1080）
- 平板版（768x1024）
- 手機版（375x667）

#### 6.3 無障礙性

- [ ] 所有按鈕有明確標籤
- [ ] 鍵盤導航可用
- [ ] 顏色對比度符合 WCAG 2.1
- [ ] 螢幕閱讀器友善

---

### 7. 文檔完整性 ✓

#### 7.1 技術文檔

- [x] `docs/54-Phase4-5實施報告.md` 已建立
- [x] `docs/55-TaskList功能使用指南.md` 已建立
- [x] `docs/56-生產部署清單.md` 已建立（本文件）
- [ ] `CHANGELOG.md` 已更新

#### 7.2 程式碼文檔

- [ ] 所有公開方法有 JSDoc
- [ ] 複雜邏輯有註釋
- [ ] README.md 已更新
- [ ] API 文檔已更新

#### 7.3 使用者文檔

- [x] 功能使用指南完整
- [ ] 常見問題已整理
- [ ] 疑難排解指南已準備
- [ ] 視覺輔助（截圖/影片）

---

## 🚀 部署執行

### 部署步驟

#### Step 1: 最終確認

```bash
# 1. 確認所有檢查項目完成
# 2. 確認當前分支乾淨
git status

# 3. 確認最新程式碼
git pull origin main
```

#### Step 2: 建置生產版本

```bash
# 建置生產版本
yarn build --configuration=production

# 檢查輸出
ls -lh dist/ng-alain-gighub/
```

#### Step 3: 部署到環境

```bash
# 方案 A: Vercel 部署
vercel --prod

# 方案 B: 其他平台
# 依照平台文檔執行
```

#### Step 4: 部署後驗證

- [ ] 應用程式可存取
- [ ] 登入功能正常
- [ ] TaskListComponent 載入
- [ ] 所有功能正常運作

**驗證 URL**:
```
生產環境: https://your-domain.com
測試帳號: test@example.com
```

---

## 🔄 回滾計畫

### 回滾觸發條件

以下任一情況發生時，立即執行回滾:
- ❌ 應用程式無法載入
- ❌ 認證系統失敗
- ❌ 資料遺失或損壞
- ❌ 效能嚴重下降（>50%）
- ❌ 關鍵功能無法使用

### 回滾步驟

#### Step 1: 立即通知

```bash
# 通知團隊
# 記錄問題詳情
# 開始回滾程序
```

#### Step 2: 程式碼回滾

```bash
# 返回前一版本
git revert HEAD

# 或回滾到特定 commit
git reset --hard <previous-commit>

# 強制推送（謹慎使用）
git push --force-with-lease
```

#### Step 3: 重新部署

```bash
# 重新建置
yarn build --configuration=production

# 部署舊版本
vercel --prod
```

#### Step 4: 驗證回滾

- [ ] 應用程式恢復正常
- [ ] 所有功能運作
- [ ] 資料完整性確認
- [ ] 使用者可正常使用

### 回滾後處理

1. **問題分析**
   - 記錄失敗原因
   - 分析根本原因
   - 制定修復計畫

2. **修復與重試**
   - 在開發環境修復
   - 完整測試驗證
   - 重新執行部署流程

3. **文檔更新**
   - 更新已知問題
   - 記錄解決方案
   - 分享經驗教訓

---

## 📊 監控設定

### 關鍵指標

#### 1. 應用程式效能

```typescript
// 追蹤指標
- 頁面載入時間
- API 回應時間
- 使用者操作延遲
- 錯誤率
```

**工具**:
- Google Analytics
- Vercel Analytics
- Sentry
- Custom metrics

#### 2. 使用者行為

```typescript
// 追蹤事件
- 藍圖選擇
- 狀態變更次數
- 撤回操作次數
- 過濾器使用率
```

#### 3. 錯誤追蹤

```typescript
// 監控錯誤
- 狀態轉換失敗
- 撤回失敗
- API 錯誤
- 認證失敗
```

**設定範例**:
```typescript
// Sentry 整合
import * as Sentry from "@sentry/angular";

Sentry.init({
  dsn: "your-sentry-dsn",
  environment: "production"
});
```

---

## ✅ 部署檢查表總覽

### 必須完成項目

#### 程式碼品質
- [ ] Code Review 完成
- [ ] 靜態分析通過
- [ ] 建置成功

#### 測試
- [ ] 單元測試通過（30+案例）
- [ ] 測試覆蓋率 ≥ 80%
- [ ] 整合測試通過

#### 資料庫
- [ ] Schema 驗證完成
- [ ] RLS 策略確認
- [ ] 測試資料準備

#### 安全
- [ ] 認證授權驗證
- [ ] 輸入驗證完整
- [ ] 無敏感資料洩漏

#### 效能
- [ ] 載入時間合格
- [ ] 無記憶體洩漏
- [ ] 大數據處理正常

#### 使用者體驗
- [ ] 回饋訊息完整
- [ ] 視覺設計正確
- [ ] 響應式設計正常

#### 文檔
- [x] 實施報告完成
- [x] 使用指南完成
- [x] 部署清單完成
- [ ] CHANGELOG 更新

---

## 📝 部署記錄

### 部署資訊模板

```markdown
## Phase 4-5 部署記錄

**部署日期**: YYYY-MM-DD HH:MM
**部署人員**: [姓名]
**版本號**: v1.0.0
**Commit Hash**: [hash]

### 部署內容
- TaskListComponent 增強功能
- 單元測試（30+案例）
- 文檔更新（3 份）

### 驗證結果
- [ ] 所有檢查項目通過
- [ ] 生產環境驗證完成
- [ ] 監控設定完成

### 問題記錄
- 無

### 後續行動
- 監控效能指標
- 收集使用者回饋
- 規劃 Phase 6 後續功能
```

---

## 🔗 相關資源

### 文檔連結

- **實施報告**: `docs/54-Phase4-5實施報告.md`
- **使用指南**: `docs/55-TaskList功能使用指南.md`
- **開發指南**: `docs/00-開發作業指引.md`
- **架構文檔**: `docs/10-系統架構思維導圖.mermaid.md`

### 工具連結

- **GitHub Repository**: https://github.com/7Spade/ng-alain-gighub
- **Issue Tracker**: https://github.com/7Spade/ng-alain-gighub/issues
- **CI/CD**: [您的 CI/CD 平台]
- **監控面板**: [您的監控平台]

### 聯絡資訊

- **技術負責人**: Development Team
- **緊急聯絡**: [聯絡方式]
- **支援時間**: 週一至週五 9:00-18:00

---

## 📞 緊急聯絡流程

### Level 1: 一般問題
- 📧 Email: support@example.com
- 💬 Slack: #support
- ⏰ 回應時間: 2-4 小時

### Level 2: 重要問題
- 📞 電話: [電話號碼]
- 💬 Slack: #urgent
- ⏰ 回應時間: 30 分鐘

### Level 3: 緊急狀況
- 🚨 緊急熱線: [緊急號碼]
- 💬 Slack: @here 在 #critical
- ⏰ 回應時間: 立即

---

**版本**: 1.0  
**維護者**: Development Team  
**最後更新**: 2025-11-16  
**狀態**: ✅ 準備部署

---

**注意**: 本清單應根據實際部署環境與組織需求調整。所有檢查項目必須完成才能進行生產部署。
