# 14-æ¥­å‹™æµç¨‹åœ–

> **ç›®çš„**ï¼šå±•ç¤ºç³»çµ±çš„æ ¸å¿ƒæ¥­å‹™æµç¨‹ï¼ŒåŒ…å«ç”¨æˆ¶ç™»å…¥ã€ä»»å‹™ç®¡ç†ã€å“è³ªé©—æ”¶ã€å•é¡Œè™•ç†ç­‰å®Œæ•´æµç¨‹

**æœ€å¾Œæ›´æ–°**ï¼š2025-11-15  
**ç‰ˆæœ¬**ï¼šv2.0ï¼ˆGit-like åˆ†æ”¯æ¨¡å‹ï¼‰  
**å¯¦ç¾ç‹€æ…‹**ï¼š
- âœ… **èªè­‰ç³»çµ±å·²å¯¦ç¾**ï¼šSupabase Auth + @delon/auth å”ä½œæ•´åˆ
  - å¯¦ç¾ä½ç½®ï¼š`src/app/shared/services/auth/` (AuthService)
  - é©é…å™¨ï¼š`src/app/core/supabase/supabase-session-adapter.service.ts`
  - Session ç®¡ç†ï¼šSupabase Session â†’ SupabaseSessionAdapter â†’ @delon/auth TokenService

---

## èªè­‰æ¶æ§‹èªªæ˜

æœ¬ç³»çµ±æ¡ç”¨ **Supabase Auth** ä½œç‚ºåº•å±¤èªè­‰æœå‹™ï¼Œä¸¦é€é **SupabaseSessionAdapter** å°‡ Session åŒæ­¥è‡³ **@delon/auth** çš„ TokenServiceï¼Œå¯¦ç¾å…©å€‹èªè­‰ç³»çµ±çš„ç„¡ç¸«æ•´åˆã€‚

### èªè­‰æµç¨‹
1. ç”¨æˆ¶é€é Supabase Auth é€²è¡Œç™»å…¥/è¨»å†Š
2. SupabaseSessionAdapter å°‡ Supabase Session è½‰æ›ç‚º @delon/auth Token æ ¼å¼
3. åŒæ­¥è‡³ TokenServiceï¼Œä¾› @delon ç³»çµ±ä½¿ç”¨ï¼ˆè·¯ç”±å®ˆè¡›ã€HTTP æ””æˆªå™¨ç­‰ï¼‰
4. å¾ accounts è¡¨è¼‰å…¥ç”¨æˆ¶å®Œæ•´è³‡æ–™ï¼ˆAccount æ¨¡å‹ï¼‰

### ç›¸é—œæ–‡ä»¶
- èªè­‰æœå‹™å¯¦ç¾ï¼š`src/app/shared/services/auth/auth.service.ts`
- Session é©é…å™¨ï¼š`src/app/core/supabase/supabase-session-adapter.service.ts`
- èªè­‰ç‹€æ…‹ç®¡ç†ï¼š`src/app/shared/services/auth/auth.state.ts`
- å¸³æˆ¶è³‡æ–™è¨ªå•ï¼š`src/app/core/repositories/account.repository.ts`

---

## æ¥­å‹™æµç¨‹åœ–

flowchart TD
    Start([ğŸ‘¤ ç”¨æˆ¶ç™»å…¥ç³»çµ±]) --> AuthCheck{Supabase Auth<br/>èº«ä»½é©—è­‰<br/>âœ… å·²å¯¦ç¾}
    
    Note1["ğŸ“Œ èªè­‰æ¶æ§‹èªªæ˜ï¼š<br/>Supabase Auth + @delon/auth å”ä½œ<br/>SupabaseSessionAdapter è² è²¬ Session è½‰æ›<br/>å¯¦ç¾æ–‡ä»¶ï¼šshared/services/auth/"]
    
    AuthCheck -->|é©—è­‰å¤±æ•—| AuthFail[âŒ è¿”å›ç™»å…¥é ]
    AuthCheck -->|é©—è­‰æˆåŠŸ| SessionSync[Session åŒæ­¥<br/>Supabase â†’ @delon/auth<br/>SupabaseSessionAdapter]
    SessionSync --> LoadUser[è¼‰å…¥ç”¨æˆ¶è³‡æ–™<br/>DB: accounts]
    
    LoadUser --> CheckRole{æª¢æŸ¥è§’è‰²æ¬Šé™<br/>RLS + branch_roles}
    CheckRole --> Dashboard[ğŸ“Š é€²å…¥å°ˆæ¡ˆå„€è¡¨æ¿<br/>DB: blueprints]
    
    Dashboard --> SelectBlueprint{é¸æ“‡è—åœ– / åˆ†æ”¯}
    SelectBlueprint -->|ä¸»åˆ†æ”¯| MainView[ä¸»åˆ†æ”¯æ§åˆ¶å°]
    SelectBlueprint -->|æ‰¿æ”¬åˆ†æ”¯| BranchView[æ‰¿æ”¬åˆ†æ”¯é¢æ¿]
    
    MainView --> SelectAction{é¸æ“‡æ“ä½œ}
    BranchView --> SelectAction
    
    %% ==================== åˆ†æ”¯æ²»ç†æµç¨‹ ====================
    SelectAction -->|Fork ä»»å‹™| ForkFlow[ğŸ”€ å»ºç«‹ Fork<br/>DB: branch_forks]
    ForkFlow --> CreateBranch[ğŸŒ¿ å»ºç«‹åˆ†æ”¯<br/>DB: blueprint_branches]
    CreateBranch --> InviteOrg[ğŸ¤ å”ä½œé‚€è«‹<br/>DB: organization_collaborations]
    InviteOrg --> BranchReady([åˆ†æ”¯å•Ÿç”¨])
    
    SelectAction -->|æäº¤ PR| PRSubmit[ğŸ“® æäº¤ Pull Request<br/>DB: pull_requests]
    PRSubmit --> ReviewFlow[ğŸ” å¯©æŸ¥è®Šæ›´<br/>DB: pull_request_reviews]
    ReviewFlow --> MergeDecision{å¯©æŸ¥é€šé?}
    MergeDecision -->|æ˜¯| MergeMain[âœ… åˆä½µä¸»åˆ†æ”¯<br/>Edge Function: branch-merge]
    MergeDecision -->|å¦| BranchAdjust[â†©ï¸ èª¿æ•´åˆ†æ”¯]
    
    %% ==================== ä»»å‹™åŸ·è¡Œæµç¨‹ ====================
    SelectAction -->|å»ºç«‹ä»»å‹™| CreateTask[ğŸ“‹ å»ºç«‹æ–°ä»»å‹™<br/>DB: tasks]
    CreateTask --> AssignTask[æŒ‡æ´¾è² è²¬äºº<br/>Realtime é€šçŸ¥]
    AssignTask --> TaskNotify[âš¡ Realtime æ¨é€é€šçŸ¥<br/>DB: notifications]
    TaskNotify --> WorkStart[ğŸ‘· é–‹å§‹æ–½å·¥]
    
    WorkStart --> DailyReport{æ¯æ—¥å ±è¡¨æµç¨‹}
    
    DailyReport --> UploadPhoto[ğŸ“· ä¸Šå‚³æ–½å·¥ç…§ç‰‡<br/>Storage: images/]
    UploadPhoto --> RecordWeather[â˜ï¸ è¨˜éŒ„å¤©æ°£<br/>Edge Function: å¤©æ°£API<br/>DB: weather_cache]
    RecordWeather --> SaveReport[ğŸ’¾ å„²å­˜æ—¥å ±<br/>DB: daily_reports]
    SaveReport --> TriggerLog1[ğŸ”” è§¸ç™¼æ´»å‹•è¨˜éŒ„<br/>DB Trigger â†’ activity_logs]
    
    TriggerLog1 --> CheckComplete{ä»»å‹™å®Œæˆ?}
    
    CheckComplete -->|å¦| WorkStart
    CheckComplete -->|æ˜¯| SubmitQC[æäº¤å“è³ªé©—æ”¶<br/>DB: quality_checks]
    
    %% ==================== å“è³ªé©—æ”¶æµç¨‹ ====================
    SubmitQC --> QCInspect[ğŸ” é©—æ”¶äººå“¡æª¢æŸ¥]
    QCInspect --> QCPhoto[ğŸ“· æ‹æ”é©—æ”¶ç…§ç‰‡<br/>Storage: images/]
    QCPhoto --> QCResult{é©—æ”¶çµæœ}
    
    QCResult -->|ä¸åˆæ ¼| OpenIssue[âš ï¸ é–‹ç«‹å•é¡Œ<br/>DB: issues]
    QCResult -->|åˆæ ¼| UpdateProgress[âœ… æ›´æ–°é€²åº¦<br/>DB: progress_tracking<br/>Edge Function: è¨ˆç®—é€²åº¦]
    
    UpdateProgress --> NotifyComplete[âš¡ Realtime é€šçŸ¥å®Œæˆ]
    NotifyComplete --> EndTask([ä»»å‹™å®Œæˆ])
    
    %% ==================== æš«å­˜èˆ‡å¾…è¾¦ç‹€æ…‹ ====================
    TaskTree["ğŸŒ³ ä»»å‹™æ¨¹ç‹€çµæ§‹"] --> TaskAssign
    TaskAssign -->|åŠ å…¥å¾…è¾¦| TaskList[å¾…è¾¦ä¸­å¿ƒ]
    TaskList -->|é–‹å§‹åŸ·è¡Œ| TaskSubmit[âœ… æäº¤å®Œæˆ]
    TaskSubmit -->|å…ˆé€²æš«å­˜| StagingArea["ğŸ“¦ æš«å­˜å€ (48h)"]
    StagingArea --> RecallDecision{48h å…§æ’¤å›?}
    RecallDecision -->|æ˜¯| TaskList
    RecallDecision -->|å¦| DailyReport
    StagingArea -->|åŒæ­¥å“ç®¡| QualityMgmt[ğŸ” å“è³ªç®¡ç†]
    
    %% ==================== å•é¡Œè™•ç†æµç¨‹ ====================
    SelectAction -->|å›å ±å•é¡Œ| OpenIssue
    OpenIssue --> IssueAssign[æŒ‡æ´¾è™•ç†äººå“¡<br/>DB: issue_assignments]
    IssueAssign --> IssueNotify[âš¡ Realtime æ¨é€<br/>Edge Function: é€šçŸ¥é‚è¼¯]
    IssueNotify --> IssueHandle[ğŸ‘· è™•ç†å•é¡Œ]
    
    IssueHandle --> UploadIssueFix[ğŸ“· ä¸Šå‚³è™•ç†ç…§ç‰‡<br/>Storage: images/]
    UploadIssueFix --> IssueDiscuss[ğŸ’¬ è¨è«–å€æºé€š<br/>DB: comments<br/>Realtime è¨‚é–±]
    IssueDiscuss --> IssueResolve{å•é¡Œè§£æ±º?}
    
    IssueResolve -->|å¦| IssueHandle
    IssueResolve -->|æ˜¯| CloseIssue[âœ… é—œé–‰å•é¡Œ<br/>Edge Function: çµæ¡ˆé€šçŸ¥]
    CloseIssue --> TriggerLog2[ğŸ”” è§¸ç™¼æ´»å‹•è¨˜éŒ„<br/>DB Trigger]
    TriggerLog2 --> EndIssue([å•é¡Œçµæ¡ˆ])
    
    %% ==================== æ•¸æ“šåˆ†ææµç¨‹ ====================
    SelectAction -->|æŸ¥çœ‹å ±è¡¨| AnalyzeData[ğŸ“Š æ•¸æ“šåˆ†æ<br/>Edge Function: çµ±è¨ˆè¨ˆç®—]
    AnalyzeData --> QueryData[æŸ¥è©¢è³‡æ–™<br/>DB: Materialized Views]
    QueryData --> GenerateChart[ç”Ÿæˆåœ–è¡¨<br/>å‰ç«¯æ¸²æŸ“]
    GenerateChart --> ExportReport[ğŸ“„ åŒ¯å‡ºå ±è¡¨]
    ExportReport --> EndReport([å ±è¡¨å®Œæˆ])
    
    %% ==================== æ–‡ä»¶ç®¡ç†æµç¨‹ ====================
    SelectAction -->|ä¸Šå‚³æ–‡ä»¶| UploadDoc[ğŸ“¦ ä¸Šå‚³æ–‡ä»¶<br/>Storage: documents/]
    UploadDoc --> SaveDocMeta[ğŸ’¾ å„²å­˜æ–‡ä»¶å…ƒè³‡æ–™<br/>DB: documents]
    SaveDocMeta --> PermCheck[ğŸ”’ è¨­å®šæ¬Šé™<br/>RLS Policy]
    PermCheck --> EndDoc([æ–‡ä»¶å·²ä¸Šå‚³])
    
    %% ==================== å”ä½œæºé€šæµç¨‹ ====================
    SelectAction -->|è¨è«–å”ä½œ| OpenDiscuss[ğŸ’¬ é–‹å•Ÿè¨è«–å€<br/>DB: comments]
    OpenDiscuss --> PostComment[ç™¼å¸ƒç•™è¨€<br/>Realtime å»£æ’­]
    PostComment --> NotifyTeam[âš¡ é€šçŸ¥åœ˜éšŠæˆå“¡<br/>DB: notifications]
    NotifyTeam --> EndDiscuss([è¨è«–å®Œæˆ])
    
    %% æ¨£å¼å®šç¾©
    classDef startEnd fill:#4CAF50,stroke:#2E7D32,color:#fff,stroke-width:3px
    classDef process fill:#2196F3,stroke:#1565C0,color:#fff,stroke-width:2px
    classDef decision fill:#FF9800,stroke:#E65100,color:#fff,stroke-width:2px
    classDef storage fill:#9C27B0,stroke:#6A1B9A,color:#fff,stroke-width:2px
    classDef realtime fill:#F44336,stroke:#C62828,color:#fff,stroke-width:2px
    classDef error fill:#f44336,stroke:#c62828,color:#fff,stroke-width:2px
    
    %% èªè­‰èªªæ˜æ¨£å¼
    classDef noteStyle fill:#E8F5E9,stroke:#4CAF50,color:#1B5E20,stroke-width:2px,stroke-dasharray: 5 5
    
    class Start,EndTask,EndIssue,EndReport,EndDoc,EndDiscuss,BranchReady startEnd
    class LoadUser,CreateTask,AssignTask,WorkStart,UploadPhoto,RecordWeather,SaveReport,SubmitQC,QCInspect,QCPhoto,UpdateProgress,IssueAssign,IssueHandle,UploadIssueFix,CloseIssue,AnalyzeData,QueryData,GenerateChart,ExportReport,UploadDoc,SaveDocMeta,PermCheck,OpenDiscuss,PostComment,ForkFlow,CreateBranch,InviteOrg,PRSubmit,ReviewFlow,SessionSync process
    class AuthCheck,CheckRole,SelectAction,DailyReport,CheckComplete,QCResult,IssueResolve,SelectBlueprint,MergeDecision,RecallDecision decision
    class TriggerLog1,TriggerLog2,OpenIssue storage
    class TaskNotify,IssueNotify,NotifyComplete,IssueDiscuss,PostComment,NotifyTeam realtime
    class AuthFail error
    class Note1 noteStyle