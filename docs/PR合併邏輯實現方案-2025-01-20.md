# PR åˆä½µé‚è¼¯å¯¦ç¾æ–¹æ¡ˆ

> **æ—¥æœŸ**ï¼š2025-01-20  
> **ç›®çš„**ï¼šè¨˜éŒ„ PR åˆä½µé‚è¼¯çš„å®Œæ•´å¯¦ç¾æ–¹æ¡ˆï¼ˆä¸ä½¿ç”¨ Edge Functionsï¼‰  
> **ç‹€æ…‹**ï¼šâœ… è¨­è¨ˆå®Œæˆï¼Œå¾…å¯¦æ–½

---

## ğŸ“‹ ç›®éŒ„

1. [è¨­è¨ˆæ±ºç­–](#è¨­è¨ˆæ±ºç­–)
2. [æ¶æ§‹è¨­è¨ˆ](#æ¶æ§‹è¨­è¨ˆ)
3. [å¯¦ç¾æ–¹æ¡ˆ](#å¯¦ç¾æ–¹æ¡ˆ)
4. [ä»»å‹™å°æ‡‰é—œä¿‚](#ä»»å‹™å°æ‡‰é—œä¿‚)
5. [éŒ¯èª¤è™•ç†](#éŒ¯èª¤è™•ç†)
6. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
7. [æ¸¬è©¦ç­–ç•¥](#æ¸¬è©¦ç­–ç•¥)

---

## ğŸ¯ è¨­è¨ˆæ±ºç­–

### ç‚ºä»€éº¼ä¸ä½¿ç”¨ Edge Functionsï¼Ÿ

**æ±ºç­–**ï¼šåœ¨ Service å±¤ç›´æ¥å¯¦ç¾ PR åˆä½µé‚è¼¯ï¼Œä¸ä½¿ç”¨ Supabase Edge Functionsã€‚

**åŸå› **ï¼š
1. **ç°¡åŒ–æ¶æ§‹**ï¼šå·¥åœ°ä»»å‹™ç³»çµ±çš„åˆä½µé‚è¼¯æ¯” GitHub ç°¡å–®ï¼Œä¸éœ€è¦è¤‡é›œçš„æœå‹™ç«¯è™•ç†
2. **æ˜“æ–¼ç¶­è­·**ï¼šä»£ç¢¼é›†ä¸­åœ¨ Angular Service å±¤ï¼Œä¾¿æ–¼èª¿è©¦å’Œç¶­è­·
3. **æ¸›å°‘ä¾è³´**ï¼šä¸éœ€è¦éƒ¨ç½²å’Œç®¡ç† Edge Functions
4. **æ›´å¥½çš„é¡å‹å®‰å…¨**ï¼šTypeScript é¡å‹æª¢æŸ¥åœ¨ Service å±¤æ›´å®Œå–„
5. **çµ±ä¸€éŒ¯èª¤è™•ç†**ï¼šå¯ä»¥ä½¿ç”¨ç¾æœ‰çš„ ErrorStateService çµ±ä¸€è™•ç†éŒ¯èª¤

### åˆä½µé‚è¼¯ç°¡åŒ–

èˆ‡ GitHub çš„ PR åˆä½µä¸åŒï¼Œå·¥åœ°ä»»å‹™ç³»çµ±çš„åˆä½µé‚è¼¯æ›´ç°¡å–®ï¼š

- **ä¸éœ€è¦**ï¼šä»£ç¢¼å·®ç•°æ¯”è¼ƒã€è¡çªè§£æ±ºã€æ–‡ä»¶åˆä½µ
- **åªéœ€è¦**ï¼šå°‡åˆ†æ”¯ä»»å‹™çš„ `contractor_fields` åˆä½µåˆ°ä¸»åˆ†æ”¯å°æ‡‰ä»»å‹™
- **å–®å‘åˆä½µ**ï¼šåˆ†æ”¯ â†’ ä¸»åˆ†æ”¯ï¼Œä¸æœƒå½±éŸ¿åˆ†æ”¯æ•¸æ“š

---

## ğŸ—ï¸ æ¶æ§‹è¨­è¨ˆ

### æ•¸æ“šæµ

```
ç”¨æˆ¶æ“ä½œï¼ˆåˆä½µ PRï¼‰
  â†“
PullRequestService.mergePullRequest()
  â†“
1. é©—è­‰ PR ç‹€æ…‹ï¼ˆå¿…é ˆæ˜¯ APPROVEDï¼‰
  â†“
2. ç²å–åˆ†æ”¯ä»»å‹™ï¼ˆæœ‰ contractor_fields çš„ä»»å‹™ï¼‰
  â†“
3. å»ºç«‹ä»»å‹™å°æ‡‰é—œä¿‚ï¼ˆé€šé branch_forks è¡¨ï¼‰
  â†“
4. æ›´æ–°ä¸»åˆ†æ”¯ä»»å‹™çš„ contractor_fields
  â†“
5. æ›´æ–° PR ç‹€æ…‹ç‚º MERGED
  â†“
6. è¨˜éŒ„æ´»å‹•æ—¥èªŒ
```

### æ ¸å¿ƒçµ„ä»¶

1. **PullRequestService**ï¼šPR åˆä½µé‚è¼¯çš„ä¸»è¦å…¥å£
2. **TaskService**ï¼šæä¾› `updateTaskContractorFields()` æ–¹æ³•
3. **BranchForkRepository**ï¼šæŸ¥è©¢ä»»å‹™å°æ‡‰é—œä¿‚
4. **BlueprintActivityService**ï¼šè¨˜éŒ„æ´»å‹•æ—¥èªŒ

---

## ğŸ’» å¯¦ç¾æ–¹æ¡ˆ

### 1. TaskService.updateTaskContractorFields()

**ä½ç½®**ï¼š`src/app/shared/services/task/task.service.ts`

**åŠŸèƒ½**ï¼šæ›´æ–°ä»»å‹™çš„æ‰¿æ”¬æ¬„ä½ï¼Œç”¨æ–¼ PR åˆä½µæ™‚æ›´æ–°ä¸»åˆ†æ”¯ä»»å‹™ã€‚

**å¯¦ç¾**ï¼š

```typescript
/**
 * æ›´æ–°ä»»å‹™çš„æ‰¿æ”¬æ¬„ä½ï¼ˆcontractor_fieldsï¼‰
 * 
 * ç”¨æ–¼ PR åˆä½µæ™‚æ›´æ–°ä¸»åˆ†æ”¯çš„ä»»å‹™æ‰¿æ”¬æ¬„ä½
 * æœƒåˆä½µç¾æœ‰æ•¸æ“šï¼Œä¿ç•™åŸæœ‰æ¬„ä½ï¼Œæ›´æ–°æ–°æ¬„ä½
 * 
 * @param taskId ä»»å‹™ ID
 * @param contractorFields æ‰¿æ”¬æ¬„ä½æ•¸æ“šï¼ˆæœƒåˆä½µåˆ°ç¾æœ‰æ•¸æ“šï¼‰
 * @returns æ›´æ–°å¾Œçš„ä»»å‹™
 */
async updateTaskContractorFields(
  taskId: string,
  contractorFields: Record<string, unknown>
): Promise<Task> {
  this.loadingState.set(true);
  this.errorState.set(null);

  try {
    // 1. ç²å–ç•¶å‰ä»»å‹™
    const currentTask = await firstValueFrom(this.taskRepository.findById(taskId));
    if (!currentTask) {
      throw new Error(`ä»»å‹™ä¸å­˜åœ¨: ${taskId}`);
    }

    // 2. åˆä½µæ‰¿æ”¬æ¬„ä½ï¼ˆä¿ç•™ç¾æœ‰æ•¸æ“šï¼Œæ›´æ–°æ–°æ•¸æ“šï¼‰
    const currentContractorFields = (currentTask.contractorFields || {}) as Record<string, unknown>;
    const mergedContractorFields = {
      ...currentContractorFields,
      ...contractorFields,
      // æ·»åŠ æ›´æ–°æ™‚é–“æˆ³å’Œåˆä½µä¾†æº
      _lastUpdated: new Date().toISOString(),
      _lastMergedAt: new Date().toISOString()
    };

    // 3. æ›´æ–°ä»»å‹™
    const updatedTask = await firstValueFrom(
      this.taskRepository.update(taskId, {
        contractorFields: mergedContractorFields
      } as TaskUpdate)
    );

    // 4. æ›´æ–°æœ¬åœ°ç‹€æ…‹
    this.tasksState.update(tasks => 
      tasks.map(t => t.id === taskId ? updatedTask : t)
    );
    if (this.selectedTask()?.id === taskId) {
      this.selectedTaskState.set(updatedTask);
    }

    return updatedTask;
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : 'æ›´æ–°æ‰¿æ”¬æ¬„ä½å¤±æ•—';
    this.errorState.set(errorMessage);
    throw error;
  } finally {
    this.loadingState.set(false);
  }
}
```

**é—œéµç‰¹æ€§**ï¼š
- âœ… åˆä½µç¾æœ‰æ•¸æ“šï¼Œä¸æœƒè¦†è“‹åŸæœ‰æ¬„ä½
- âœ… æ·»åŠ æ™‚é–“æˆ³è¨˜éŒ„åˆä½µæ™‚é–“
- âœ… æ›´æ–°æœ¬åœ° Signal ç‹€æ…‹
- âœ… å®Œæ•´çš„éŒ¯èª¤è™•ç†

---

### 2. PullRequestService.mergePullRequest() å®Œæ•´å¯¦ç¾

**ä½ç½®**ï¼š`src/app/shared/services/blueprint/pull-request.service.ts`

**åŠŸèƒ½**ï¼šåŸ·è¡Œ PR åˆä½µï¼Œå°‡åˆ†æ”¯ä»»å‹™çš„ `contractor_fields` åˆä½µåˆ°ä¸»åˆ†æ”¯å°æ‡‰ä»»å‹™ã€‚

**ä¾è³´æ³¨å…¥**ï¼š

```typescript
private branchForkRepository = inject(BranchForkRepository);
private blueprintBranchRepository = inject(BlueprintBranchRepository);
private taskService = inject(TaskService);
private activityService = inject(BlueprintActivityService);
```

**å®Œæ•´å¯¦ç¾**ï¼š

```typescript
/**
 * åˆä½µ PRï¼ˆå®Œæ•´å¯¦ç¾ï¼‰
 * 
 * æµç¨‹ï¼š
 * 1. é©—è­‰ PR ç‹€æ…‹ï¼ˆå¿…é ˆæ˜¯ APPROVEDï¼‰
 * 2. ç²å–åˆ†æ”¯ä¿¡æ¯å’Œä¸»åˆ†æ”¯è—åœ– ID
 * 3. ç²å–åˆ†æ”¯ä»»å‹™ï¼ˆæœ‰ contractor_fields çš„ä»»å‹™ï¼‰
 * 4. é€šé branch_forks è¡¨å»ºç«‹ä»»å‹™å°æ‡‰é—œä¿‚
 * 5. æ›´æ–°ä¸»åˆ†æ”¯ä»»å‹™çš„ contractor_fields
 * 6. æ›´æ–° PR ç‹€æ…‹ç‚º MERGED
 * 7. è¨˜éŒ„æ´»å‹•æ—¥èªŒ
 * 
 * @param prId PR ID
 * @param mergedBy åˆä½µè€… ID
 * @param changesSummary è®Šæ›´æ‘˜è¦ï¼ˆå¯é¸ï¼‰
 * @returns Promise<PullRequest> Merged PR
 */
async mergePullRequest(prId: string, mergedBy: string, changesSummary?: any): Promise<PullRequest> {
  this.loadingState.set(true);
  this.errorState.set(null);

  try {
    // 1. ç²å– PR è©³æƒ…
    const pr = await firstValueFrom(this.pullRequestRepository.findById(prId));
    if (!pr) {
      throw new Error(`Pull Request ä¸å­˜åœ¨: ${prId}`);
    }

    // 2. é©—è­‰ PR ç‹€æ…‹ï¼ˆå¿…é ˆæ˜¯ APPROVEDï¼‰
    if (pr.status !== PRStatus.APPROVED) {
      throw new Error(`Pull Request å¿…é ˆå…ˆè¢«æ‰¹å‡†æ‰èƒ½åˆä½µã€‚ç•¶å‰ç‹€æ…‹: ${pr.status}`);
    }

    // 3. ç²å–åˆ†æ”¯ä¿¡æ¯
    const branchId = pr.branch_id;
    const branch = await firstValueFrom(this.blueprintBranchRepository.findById(branchId));
    if (!branch) {
      throw new Error(`åˆ†æ”¯ä¸å­˜åœ¨: ${branchId}`);
    }

    // 4. ç²å–ä¸»åˆ†æ”¯è—åœ– IDï¼ˆé€šé PR çš„ blueprint_idï¼Œé€™æ˜¯ä¸»åˆ†æ”¯è—åœ–ï¼‰
    const mainBlueprintId = pr.blueprint_id;
    
    // 5. ç²å–åˆ†æ”¯è—åœ– IDï¼ˆçµ„ç¹”åˆ†æ”¯çš„è—åœ–ï¼‰
    const branchBlueprintId = branch.blueprint_id;

    // 6. ç²å–åˆ†æ”¯ä»»å‹™ï¼ˆæœ‰ contractor_fields çš„ä»»å‹™ï¼‰
    const branchTasks = await firstValueFrom(
      this.taskRepository.findByBlueprintId(branchBlueprintId)
    );

    // éæ¿¾å‡ºæœ‰ contractor_fields çš„ä»»å‹™
    const tasksWithContractorFields = branchTasks.filter(
      task => task.contractorFields && 
      Object.keys(task.contractorFields as Record<string, unknown>).length > 0
    );

    console.log('[PullRequestService] æº–å‚™åˆä½µä»»å‹™:', {
      prId,
      branchId,
      branchBlueprintId,
      mainBlueprintId,
      tasksCount: tasksWithContractorFields.length
    });

    // 7. å»ºç«‹ä»»å‹™å°æ‡‰é—œä¿‚ï¼ˆé€šé branch_forks è¡¨ï¼‰
    const taskMappings = await this.buildTaskMappings(
      branchBlueprintId,
      mainBlueprintId
    );

    // 8. åˆä½µä»»å‹™çš„ contractor_fields
    const mergeResults: Array<{
      branchTaskId: string;
      mainTaskId: string | null;
      status: 'merged' | 'skipped' | 'failed';
      error?: string;
    }> = [];

    for (const branchTask of tasksWithContractorFields) {
      const mainTaskId = taskMappings.get(branchTask.id);

      if (!mainTaskId) {
        console.warn('[PullRequestService] æ‰¾ä¸åˆ°å°æ‡‰çš„ä¸»åˆ†æ”¯ä»»å‹™:', {
          branchTaskId: branchTask.id,
          branchTaskTitle: branchTask.title
        });
        mergeResults.push({
          branchTaskId: branchTask.id,
          mainTaskId: null,
          status: 'skipped',
          error: 'æ‰¾ä¸åˆ°å°æ‡‰çš„ä¸»åˆ†æ”¯ä»»å‹™'
        });
        continue;
      }

      try {
        // åˆä½µ contractor_fields
        await this.taskService.updateTaskContractorFields(
          mainTaskId,
          branchTask.contractorFields as Record<string, unknown>
        );

        mergeResults.push({
          branchTaskId: branchTask.id,
          mainTaskId,
          status: 'merged'
        });

        console.log('[PullRequestService] ä»»å‹™åˆä½µæˆåŠŸ:', {
          branchTaskId: branchTask.id,
          mainTaskId,
          contractorFields: branchTask.contractorFields
        });
      } catch (error) {
        console.error('[PullRequestService] ä»»å‹™åˆä½µå¤±æ•—:', {
          branchTaskId: branchTask.id,
          mainTaskId,
          error
        });
        mergeResults.push({
          branchTaskId: branchTask.id,
          mainTaskId,
          status: 'failed',
          error: error instanceof Error ? error.message : 'æœªçŸ¥éŒ¯èª¤'
        });
      }
    }

    // 9. ç”Ÿæˆè®Šæ›´æ‘˜è¦
    const mergedCount = mergeResults.filter(r => r.status === 'merged').length;
    const skippedCount = mergeResults.filter(r => r.status === 'skipped').length;
    const failedCount = mergeResults.filter(r => r.status === 'failed').length;

    const finalChangesSummary = changesSummary || {
      tasksWithContractorFields: mergedCount,
      totalTasksReviewed: tasksWithContractorFields.length,
      mergedTasks: mergeResults.filter(r => r.status === 'merged'),
      skippedTasks: mergeResults.filter(r => r.status === 'skipped'),
      failedTasks: mergeResults.filter(r => r.status === 'failed'),
      mergedAt: new Date().toISOString()
    };

    // 10. æ›´æ–° PR ç‹€æ…‹ç‚º MERGED
    const mergedPR = await this.updatePullRequest(prId, {
      status: PRStatus.MERGED,
      mergedBy,
      mergedAt: new Date().toISOString(),
      changesSummary: finalChangesSummary
    } as any);

    // 11. è¨˜éŒ„æ´»å‹•æ—¥èªŒ
    try {
      await this.activityService.logActivity(
        mainBlueprintId,
        'pull_request',
        prId,
        'pr_merged',
        [{
          field: 'status',
          oldValue: PRStatus.APPROVED,
          newValue: PRStatus.MERGED
        }],
        {
          mergedBy,
          mergedTasksCount: mergedCount,
          skippedTasksCount: skippedCount,
          failedTasksCount: failedCount
        }
      );
    } catch (error) {
      // æ´»å‹•æ—¥èªŒè¨˜éŒ„å¤±æ•—ä¸å½±éŸ¿åˆä½µæµç¨‹
      console.warn('[PullRequestService] æ´»å‹•æ—¥èªŒè¨˜éŒ„å¤±æ•—:', error);
    }

    console.log('[PullRequestService] PR åˆä½µå®Œæˆ:', {
      prId,
      mergedTasks: mergedCount,
      skippedTasks: skippedCount,
      failedTasks: failedCount,
      totalTasks: tasksWithContractorFields.length
    });

    return mergedPR;
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : 'åˆä½µ Pull Request å¤±æ•—';
    this.errorState.set(errorMessage);
    console.error('[PullRequestService] åˆä½µéŒ¯èª¤:', error);
    throw error;
  } finally {
    this.loadingState.set(false);
  }
}
```

**é—œéµç‰¹æ€§**ï¼š
- âœ… å®Œæ•´çš„ç‹€æ…‹é©—è­‰
- âœ… ä»»å‹™å°æ‡‰é—œä¿‚å»ºç«‹
- âœ… æ‰¹é‡åˆä½µè™•ç†
- âœ… è©³ç´°çš„åˆä½µçµæœè¨˜éŒ„
- âœ… æ´»å‹•æ—¥èªŒè¨˜éŒ„
- âœ… å®Œæ•´çš„éŒ¯èª¤è™•ç†

---

## ğŸ”— ä»»å‹™å°æ‡‰é—œä¿‚

### å•é¡Œæè¿°

PR åˆä½µæ™‚éœ€è¦çŸ¥é“ï¼š
- åˆ†æ”¯ä»»å‹™ A å°æ‡‰ä¸»åˆ†æ”¯ä»»å‹™ B
- å°‡åˆ†æ”¯ä»»å‹™ A çš„ `contractor_fields` åˆä½µåˆ°ä¸»åˆ†æ”¯ä»»å‹™ B

### è§£æ±ºæ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1ï¼šé€šé branch_forks è¡¨ï¼ˆæ¨è–¦ï¼‰

`branch_forks` è¡¨è¨˜éŒ„äº†åˆ†æ”¯ Fork çš„æ­·å²ï¼Œå¯ä»¥é€šéå®ƒå»ºç«‹ä»»å‹™å°æ‡‰é—œä¿‚ã€‚

**è¡¨çµæ§‹**ï¼š
```sql
CREATE TABLE branch_forks (
  id UUID PRIMARY KEY,
  blueprint_id UUID NOT NULL,  -- åˆ†æ”¯è—åœ– ID
  branch_id UUID NOT NULL,      -- åˆ†æ”¯ ID
  forked_from_task_id UUID,     -- ä¸»åˆ†æ”¯ä»»å‹™ ID
  forked_by UUID NOT NULL,
  fork_reason TEXT,
  forked_at TIMESTAMPTZ DEFAULT NOW()
);
```

**å¯¦ç¾**ï¼š

```typescript
/**
 * å»ºç«‹ä»»å‹™å°æ‡‰é—œä¿‚
 * 
 * é€šé branch_forks è¡¨æŸ¥æ‰¾åˆ†æ”¯ä»»å‹™èˆ‡ä¸»åˆ†æ”¯ä»»å‹™çš„å°æ‡‰é—œä¿‚
 * 
 * @param branchBlueprintId åˆ†æ”¯è—åœ– ID
 * @param mainBlueprintId ä¸»åˆ†æ”¯è—åœ– ID
 * @returns Map<åˆ†æ”¯ä»»å‹™ID, ä¸»åˆ†æ”¯ä»»å‹™ID>
 */
private async buildTaskMappings(
  branchBlueprintId: string,
  mainBlueprintId: string
): Promise<Map<string, string>> {
  const mappings = new Map<string, string>();

  try {
    // æ–¹æ³• 1: é€šé branch_forks è¡¨æŸ¥æ‰¾å°æ‡‰é—œä¿‚
    const forks = await firstValueFrom(
      this.branchForkRepository.findByBlueprintId(branchBlueprintId)
    );

    // æ³¨æ„ï¼šbranch_forks è¡¨çš„ forked_from_task_id æ˜¯ä¸»åˆ†æ”¯ä»»å‹™ ID
    // ä½†æ²’æœ‰ç›´æ¥è¨˜éŒ„åˆ†æ”¯ä»»å‹™ IDï¼Œéœ€è¦é€šéå…¶ä»–æ–¹å¼å»ºç«‹å°æ‡‰é—œä¿‚
    
    // ç²å–åˆ†æ”¯çš„æ‰€æœ‰ä»»å‹™
    const branchTasks = await firstValueFrom(
      this.taskRepository.findByBlueprintId(branchBlueprintId)
    );

    // æ–¹æ³• 2: å¦‚æœ branch_forks æ²’æœ‰è¨˜éŒ„ï¼Œå˜—è©¦é€šéä»»å‹™æ¨™è­˜ç¬¦åŒ¹é…
    // ä¾‹å¦‚ï¼šä»»å‹™æ¨™é¡Œã€ä»»å‹™è·¯å¾‘ç­‰
    const mainTasks = await firstValueFrom(
      this.taskRepository.findByBlueprintId(mainBlueprintId)
    );

    // é€šéæ¨™é¡ŒåŒ¹é…ï¼ˆç°¡å–®å¯¦ç¾ï¼Œå¯¦éš›å¯èƒ½éœ€è¦æ›´è¤‡é›œçš„åŒ¹é…é‚è¼¯ï¼‰
    for (const branchTask of branchTasks) {
      const matchedMainTask = mainTasks.find(
        mainTask => mainTask.title === branchTask.title
      );
      
      if (matchedMainTask) {
        mappings.set(branchTask.id, matchedMainTask.id);
      }
    }

    console.log('[PullRequestService] ä»»å‹™å°æ‡‰é—œä¿‚å»ºç«‹å®Œæˆ:', {
      branchBlueprintId,
      mainBlueprintId,
      mappingsCount: mappings.size
    });

    return mappings;
  } catch (error) {
    console.error('[PullRequestService] å»ºç«‹ä»»å‹™å°æ‡‰é—œä¿‚å¤±æ•—:', error);
    return mappings; // è¿”å›ç©ºæ˜ å°„ï¼Œåˆä½µæ™‚æœƒè·³éé€™äº›ä»»å‹™
  }
}
```

#### æ–¹æ¡ˆ 2ï¼šæ“´å±• branch_forks è¡¨ï¼ˆæœªä¾†æ”¹é€²ï¼‰

å¦‚æœç•¶å‰ `branch_forks` è¡¨ç„¡æ³•æ»¿è¶³éœ€æ±‚ï¼Œå¯ä»¥è€ƒæ…®æ“´å±•ï¼š

```sql
-- æ·»åŠ åˆ†æ”¯ä»»å‹™ ID æ¬„ä½
ALTER TABLE branch_forks 
ADD COLUMN forked_to_task_id UUID REFERENCES tasks(id);

-- å‰µå»ºç´¢å¼•
CREATE INDEX idx_branch_forks_task_mapping 
ON branch_forks(forked_from_task_id, forked_to_task_id);
```

é€™æ¨£åœ¨å‰µå»ºåˆ†æ”¯æ™‚ï¼Œå¯ä»¥è¨˜éŒ„å®Œæ•´çš„ä»»å‹™å°æ‡‰é—œä¿‚ï¼š

```typescript
// åœ¨å‰µå»ºåˆ†æ”¯æ™‚ï¼Œè¨˜éŒ„ä»»å‹™å°æ‡‰é—œä¿‚
async createBranchWithTaskMappings(
  mainBlueprintId: string,
  branchBlueprintId: string,
  taskMappings: Array<{ mainTaskId: string; branchTaskId: string }>
) {
  for (const mapping of taskMappings) {
    await firstValueFrom(
      this.branchForkRepository.create({
        blueprint_id: branchBlueprintId,
        branch_id: branchId,
        forked_from_task_id: mapping.mainTaskId,
        forked_to_task_id: mapping.branchTaskId,  // æ–°å¢æ¬„ä½
        forked_by: userId
      } as any)
    );
  }
}
```

#### æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ä»»å‹™å”¯ä¸€æ¨™è­˜ç¬¦ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰

å¦‚æœä»»å‹™æœ‰å”¯ä¸€æ¨™è­˜ç¬¦ï¼ˆå¦‚ `task_code`ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨å®ƒä¾†åŒ¹é…ï¼š

```typescript
private async buildTaskMappings(
  branchBlueprintId: string,
  mainBlueprintId: string
): Promise<Map<string, string>> {
  const mappings = new Map<string, string>();

  const [branchTasks, mainTasks] = await Promise.all([
    firstValueFrom(this.taskRepository.findByBlueprintId(branchBlueprintId)),
    firstValueFrom(this.taskRepository.findByBlueprintId(mainBlueprintId))
  ]);

  // é€šé task_code åŒ¹é…ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
  for (const branchTask of branchTasks) {
    const branchTaskCode = (branchTask as any).taskCode;
    if (branchTaskCode) {
      const matchedMainTask = mainTasks.find(
        (mainTask: any) => mainTask.taskCode === branchTaskCode
      );
      if (matchedMainTask) {
        mappings.set(branchTask.id, matchedMainTask.id);
      }
    }
  }

  return mappings;
}
```

---

## âš ï¸ éŒ¯èª¤è™•ç†

### éŒ¯èª¤åˆ†é¡

1. **é©—è­‰éŒ¯èª¤**ï¼š
   - PR ä¸å­˜åœ¨
   - PR ç‹€æ…‹ä¸æ˜¯ APPROVED
   - åˆ†æ”¯ä¸å­˜åœ¨

2. **æ•¸æ“šéŒ¯èª¤**ï¼š
   - æ‰¾ä¸åˆ°å°æ‡‰çš„ä¸»åˆ†æ”¯ä»»å‹™
   - ä»»å‹™æ•¸æ“šä¸å®Œæ•´

3. **åˆä½µéŒ¯èª¤**ï¼š
   - æ›´æ–°ä»»å‹™å¤±æ•—
   - æ•¸æ“šåº«æ“ä½œå¤±æ•—

### éŒ¯èª¤è™•ç†ç­–ç•¥

1. **é©—è­‰éŒ¯èª¤**ï¼šç›´æ¥æ‹‹å‡ºéŒ¯èª¤ï¼Œé˜»æ­¢åˆä½µ
2. **æ•¸æ“šéŒ¯èª¤**ï¼šè¨˜éŒ„ç‚º `skipped`ï¼Œç¹¼çºŒè™•ç†å…¶ä»–ä»»å‹™
3. **åˆä½µéŒ¯èª¤**ï¼šè¨˜éŒ„ç‚º `failed`ï¼Œç¹¼çºŒè™•ç†å…¶ä»–ä»»å‹™

### éŒ¯èª¤è¨˜éŒ„

æ‰€æœ‰éŒ¯èª¤éƒ½æœƒè¨˜éŒ„åœ¨ `changesSummary` ä¸­ï¼š

```typescript
{
  mergedTasks: [...],      // æˆåŠŸåˆä½µçš„ä»»å‹™
  skippedTasks: [...],     // è·³éçš„ä»»å‹™ï¼ˆæ‰¾ä¸åˆ°å°æ‡‰é—œä¿‚ï¼‰
  failedTasks: [...]       // å¤±æ•—çš„ä»»å‹™ï¼ˆåˆä½µæ™‚å‡ºéŒ¯ï¼‰
}
```

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åœ¨çµ„ä»¶ä¸­ä½¿ç”¨

```typescript
// åœ¨ PR è©³æƒ…çµ„ä»¶ä¸­
export class PullRequestDetailComponent {
  private prService = inject(PullRequestService);
  private message = inject(NzMessageService);
  private authService = inject(AuthService);

  async mergePR() {
    try {
      const currentUser = await this.authService.getCurrentUser();
      if (!currentUser) {
        this.message.error('è«‹å…ˆç™»å…¥');
        return;
      }

      const mergedPR = await this.prService.mergePullRequest(
        this.prId,
        currentUser.id
      );
      
      this.message.success('PR åˆä½µæˆåŠŸ');
      
      // åˆ·æ–° PR åˆ—è¡¨
      await this.prService.loadPullRequests();
      
      // å°èˆªåˆ° PR åˆ—è¡¨
      this.router.navigate(['/blueprints', this.blueprintId, 'pull-requests']);
    } catch (error) {
      console.error('åˆä½µ PR å¤±æ•—:', error);
      this.message.error(error instanceof Error ? error.message : 'åˆä½µå¤±æ•—ï¼Œè«‹é‡è©¦');
    }
  }
}
```

### åœ¨ Facade ä¸­ä½¿ç”¨

```typescript
// åœ¨ BlueprintFacade ä¸­
async mergePullRequest(prId: string, mergedBy: string): Promise<PullRequest> {
  this.loading.set(true);
  this.error.set(null);

  try {
    const mergedPR = await this.pullRequestService.mergePullRequest(prId, mergedBy);
    
    // åˆ·æ–° PR åˆ—è¡¨
    await this.loadPullRequests(mergedPR.blueprint_id);
    
    // è§¸ç™¼èšåˆåˆ·æ–°
    this.aggregationRefreshService.emit(mergedPR.blueprint_id, ['tasks', 'progress']);
    
    return mergedPR;
  } catch (error) {
    this.error.set(error instanceof Error ? error.message : 'åˆä½µå¤±æ•—');
    throw error;
  } finally {
    this.loading.set(false);
  }
}
```

---

## ğŸ§ª æ¸¬è©¦ç­–ç•¥

### å–®å…ƒæ¸¬è©¦

#### TaskService.updateTaskContractorFields() æ¸¬è©¦

```typescript
describe('TaskService.updateTaskContractorFields', () => {
  it('æ‡‰è©²åˆä½µæ‰¿æ”¬æ¬„ä½', async () => {
    const taskId = 'task-1';
    const existingFields = { actualAmount: 1000 };
    const newFields = { actualStartDate: '2024-01-01' };
    
    // Mock ç¾æœ‰ä»»å‹™
    spyOn(taskRepository, 'findById').and.returnValue(
      of({ id: taskId, contractorFields: existingFields })
    );
    
    // Mock æ›´æ–°
    spyOn(taskRepository, 'update').and.returnValue(
      of({ id: taskId, contractorFields: { ...existingFields, ...newFields } })
    );
    
    const result = await taskService.updateTaskContractorFields(taskId, newFields);
    
    expect(result.contractorFields).toEqual({
      ...existingFields,
      ...newFields,
      _lastUpdated: jasmine.any(String),
      _lastMergedAt: jasmine.any(String)
    });
  });
});
```

#### PullRequestService.mergePullRequest() æ¸¬è©¦

```typescript
describe('PullRequestService.mergePullRequest', () => {
  it('æ‡‰è©²æˆåŠŸåˆä½µ PR', async () => {
    const prId = 'pr-1';
    const mergedBy = 'user-1';
    
    // Mock PRï¼ˆç‹€æ…‹ç‚º APPROVEDï¼‰
    const pr = {
      id: prId,
      status: PRStatus.APPROVED,
      branch_id: 'branch-1',
      blueprint_id: 'main-blueprint-1'
    };
    
    // Mock åˆ†æ”¯
    const branch = {
      id: 'branch-1',
      blueprint_id: 'branch-blueprint-1'
    };
    
    // Mock åˆ†æ”¯ä»»å‹™
    const branchTasks = [
      {
        id: 'branch-task-1',
        title: 'ä»»å‹™ 1',
        contractorFields: { actualAmount: 1000 }
      }
    ];
    
    // Mock ä»»å‹™å°æ‡‰é—œä¿‚
    const taskMappings = new Map([
      ['branch-task-1', 'main-task-1']
    ]);
    
    // ... è¨­ç½® Mock
    
    const result = await prService.mergePullRequest(prId, mergedBy);
    
    expect(result.status).toBe(PRStatus.MERGED);
    expect(result.mergedBy).toBe(mergedBy);
  });
  
  it('æ‡‰è©²æ‹’çµ•æœªæ‰¹å‡†çš„ PR', async () => {
    const pr = {
      id: 'pr-1',
      status: PRStatus.OPEN  // æœªæ‰¹å‡†
    };
    
    // ... è¨­ç½® Mock
    
    await expectAsync(
      prService.mergePullRequest('pr-1', 'user-1')
    ).toBeRejectedWithError('Pull Request å¿…é ˆå…ˆè¢«æ‰¹å‡†æ‰èƒ½åˆä½µ');
  });
});
```

### é›†æˆæ¸¬è©¦

```typescript
describe('PR åˆä½µé›†æˆæ¸¬è©¦', () => {
  it('æ‡‰è©²å®Œæ•´åŸ·è¡Œ PR åˆä½µæµç¨‹', async () => {
    // 1. å‰µå»ºä¸»åˆ†æ”¯è—åœ–
    const mainBlueprint = await createBlueprint();
    
    // 2. å‰µå»ºä¸»åˆ†æ”¯ä»»å‹™
    const mainTask = await createTask(mainBlueprint.id);
    
    // 3. å‰µå»ºåˆ†æ”¯
    const branch = await createBranch(mainBlueprint.id);
    
    // 4. å‰µå»ºåˆ†æ”¯ä»»å‹™ï¼ˆæœ‰ contractor_fieldsï¼‰
    const branchTask = await createTask(branch.blueprint_id, {
      contractorFields: { actualAmount: 1000 }
    });
    
    // 5. å»ºç«‹ä»»å‹™å°æ‡‰é—œä¿‚
    await createBranchFork({
      blueprint_id: branch.blueprint_id,
      branch_id: branch.id,
      forked_from_task_id: mainTask.id
    });
    
    // 6. å‰µå»º PR
    const pr = await createPR({
      blueprint_id: mainBlueprint.id,
      branch_id: branch.id
    });
    
    // 7. æ‰¹å‡† PR
    await approvePR(pr.id);
    
    // 8. åˆä½µ PR
    const mergedPR = await mergePR(pr.id, 'user-1');
    
    // 9. é©—è­‰çµæœ
    expect(mergedPR.status).toBe(PRStatus.MERGED);
    
    // 10. é©—è­‰ä¸»åˆ†æ”¯ä»»å‹™å·²æ›´æ–°
    const updatedMainTask = await getTask(mainTask.id);
    expect(updatedMainTask.contractorFields).toEqual({
      actualAmount: 1000,
      _lastUpdated: jasmine.any(String),
      _lastMergedAt: jasmine.any(String)
    });
  });
});
```

---

## ğŸ“Š å¯¦æ–½æª¢æŸ¥æ¸…å–®

### ä»£ç¢¼å¯¦ç¾

- [ ] å¯¦ç¾ `TaskService.updateTaskContractorFields()` æ–¹æ³•
- [ ] å®Œå–„ `PullRequestService.mergePullRequest()` æ–¹æ³•
- [ ] å¯¦ç¾ `buildTaskMappings()` æ–¹æ³•
- [ ] æ·»åŠ å¿…è¦çš„ä¾è³´æ³¨å…¥
- [ ] æ·»åŠ éŒ¯èª¤è™•ç†å’Œæ—¥èªŒè¨˜éŒ„

### æ¸¬è©¦

- [ ] å–®å…ƒæ¸¬è©¦ï¼š`TaskService.updateTaskContractorFields()`
- [ ] å–®å…ƒæ¸¬è©¦ï¼š`PullRequestService.mergePullRequest()`
- [ ] å–®å…ƒæ¸¬è©¦ï¼š`buildTaskMappings()`
- [ ] é›†æˆæ¸¬è©¦ï¼šå®Œæ•´ PR åˆä½µæµç¨‹
- [ ] éŒ¯èª¤å ´æ™¯æ¸¬è©¦

### æ–‡æª”

- [ ] æ›´æ–° API æ–‡æª”
- [ ] æ›´æ–°ç”¨æˆ¶æŒ‡å—
- [ ] æ›´æ–°é–‹ç™¼æ–‡æª”

---

## ğŸ”„ å¾ŒçºŒæ”¹é€²

### çŸ­æœŸæ”¹é€²

1. **ä»»å‹™å°æ‡‰é—œä¿‚å„ªåŒ–**ï¼š
   - æ“´å±• `branch_forks` è¡¨ï¼Œè¨˜éŒ„å®Œæ•´çš„ä»»å‹™å°æ‡‰é—œä¿‚
   - åœ¨å‰µå»ºåˆ†æ”¯æ™‚è‡ªå‹•å»ºç«‹ä»»å‹™å°æ‡‰é—œä¿‚

2. **éŒ¯èª¤è™•ç†å¢å¼·**ï¼š
   - å¯¦ç¾å›æ»¾æ©Ÿåˆ¶ï¼ˆå¦‚æœåˆä½µå¤±æ•—ï¼‰
   - æ·»åŠ æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯

3. **æ€§èƒ½å„ªåŒ–**ï¼š
   - æ‰¹é‡æ›´æ–°ä»»å‹™ï¼ˆå¦‚æœä»»å‹™æ•¸é‡å¾ˆå¤šï¼‰
   - ä½¿ç”¨äº‹å‹™ç¢ºä¿æ•¸æ“šä¸€è‡´æ€§

### é•·æœŸæ”¹é€²

1. **è¡çªæª¢æ¸¬**ï¼š
   - æª¢æ¸¬ä¸»åˆ†æ”¯ä»»å‹™çš„ `contractor_fields` æ˜¯å¦åœ¨ PR å¯©æ ¸æœŸé–“è¢«ä¿®æ”¹
   - æä¾›è¡çªè§£æ±ºæ©Ÿåˆ¶

2. **åˆä½µé è¦½**ï¼š
   - åœ¨åˆä½µå‰é¡¯ç¤ºå°‡è¦åˆä½µçš„è®Šæ›´
   - å…è¨±ç”¨æˆ¶é¸æ“‡è¦åˆä½µçš„æ¬„ä½

3. **å¯©è¨ˆæ—¥èªŒ**ï¼š
   - è¨˜éŒ„æ¯æ¬¡åˆä½µçš„è©³ç´°ä¿¡æ¯
   - æ”¯æŒåˆä½µæ­·å²æŸ¥è©¢

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [å®Œæ•´æ¶æ§‹æµç¨‹åœ–](./27-å®Œæ•´æ¶æ§‹æµç¨‹åœ–.mermaid.md)
- [è—åœ–å°ˆæ¡ˆç³»çµ± Tracking](./99-Tracking-è—åœ–å°ˆæ¡ˆç³»çµ±.md)
- [å°ˆæ¡ˆç¼ºå£åˆ†æ](./99-Tracking-å°ˆæ¡ˆç¼ºå£åˆ†æ.md)
- [Edge Function é–‹ç™¼æŒ‡å—](./51-Edge-Functioné–‹ç™¼æŒ‡å—.md)

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-01-20  
**ç¶­è­·è€…**ï¼šé–‹ç™¼åœ˜éšŠ  
**ç‹€æ…‹**ï¼šâœ… è¨­è¨ˆå®Œæˆï¼Œå¾…å¯¦æ–½

