# å·¥ä½œç¸½çµ - ä¿®å¾©å¤±æ•—åŸå› åˆ†æ

> **æ—¥æœŸ**ï¼š2025-01-15  
> **å•é¡Œ**ï¼šaccounts è¡¨ RLS éæ­¸å•é¡Œä¿®å¾©å¤±æ•—  
> **ç‹€æ…‹**ï¼šâœ… å·²åˆ†æ

---

## ğŸ” å•é¡Œåˆ†æ

### ç‚ºä»€éº¼ä¿®å¾©æœƒå¤±æ•—ï¼Ÿ

**æ ¹æœ¬åŸå› **ï¼šä¿®å¾©è¢«å¾©åŸäº†ï¼

1. **ç¬¬ä¸€æ¬¡ä¿®å¾©**ï¼ˆ2025-01-15 æ—©æœŸï¼‰ï¼š
   - âœ… å‰µå»ºäº† SECURITY DEFINER å‡½æ•¸ï¼ˆ`is_user_org_member`, `is_user_org_admin`ï¼‰
   - âœ… æ›´æ–°äº† accounts è¡¨çš„ RLS ç­–ç•¥ä½¿ç”¨é€™äº›å‡½æ•¸
   - âœ… ä¿®å¾©äº†éæ­¸å•é¡Œ

2. **å¾©åŸæ“ä½œ**ï¼ˆ2025-01-15 ä¸­æœŸï¼‰ï¼š
   - âŒ ç”¨æˆ¶è¦æ±‚å¾©åŸæ‰€æœ‰ RLS ä¿®æ”¹
   - âŒ åˆªé™¤äº†æ‰€æœ‰ SECURITY DEFINER å‡½æ•¸
   - âŒ æ¢å¾©äº† accounts è¡¨çš„**åŸå§‹ RLS ç­–ç•¥**

3. **ç•¶å‰ç‹€æ…‹**ï¼ˆ2025-01-15 ç¾åœ¨ï¼‰ï¼š
   - âŒ accounts è¡¨åˆå›åˆ°äº†æœ‰éæ­¸å•é¡Œçš„åŸå§‹ç‹€æ…‹
   - âŒ æŸ¥è©¢è¿”å›ï¼š`"infinite recursion detected in policy for relation \"accounts\""`

---

## ğŸ“‹ ç•¶å‰ accounts è¡¨ RLS ç­–ç•¥åˆ†æ

### SELECT ç­–ç•¥ï¼ˆæœ‰éæ­¸å•é¡Œï¼‰

```sql
"Users can view own account or organization accounts they belong"
```

**ç­–ç•¥è¡¨é”å¼**ï¼š
```sql
((auth.uid() = auth_user_id) 
OR 
(((type)::text = 'Organization'::text) 
AND 
(EXISTS (
  SELECT 1
  FROM (teams t JOIN team_members tm ON ((t.id = tm.team_id)))
  WHERE ((t.organization_id = accounts.id) 
    AND (tm.account_id = (
      SELECT accounts_1.id
      FROM accounts accounts_1  -- âš ï¸ é€™è£¡æŸ¥è©¢ accounts è¡¨ï¼
      WHERE (accounts_1.auth_user_id = auth.uid())
    ))
  )
))))
```

### éæ­¸å•é¡Œçš„æ ¹æº

**å•é¡Œæ‰€åœ¨**ï¼š
- ç­–ç•¥ä¸­ç›´æ¥æŸ¥è©¢ `accounts` è¡¨ï¼š`SELECT accounts_1.id FROM accounts accounts_1`
- ç•¶æŸ¥è©¢ `accounts` è¡¨æ™‚ï¼ŒPostgreSQL æœƒæª¢æŸ¥ RLS ç­–ç•¥
- ç­–ç•¥ä¸­åˆæŸ¥è©¢ `accounts` è¡¨ï¼Œè§¸ç™¼ RLS æª¢æŸ¥
- å½¢æˆç„¡é™å¾ªç’°ï¼š`accounts` â†’ RLS ç­–ç•¥ â†’ æŸ¥è©¢ `accounts` â†’ RLS ç­–ç•¥ â†’ ...

---

## âœ… æ­£ç¢ºçš„ä¿®å¾©æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šä½¿ç”¨ SECURITY DEFINER å‡½æ•¸

æ ¹æ“š Supabase å®˜æ–¹æ–‡æª”ï¼Œæ‡‰è©²ï¼š

1. **å‰µå»º private schema**ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
2. **å‰µå»º SECURITY DEFINER å‡½æ•¸**ä¾†é¿å…éæ­¸
3. **æ›´æ–° RLS ç­–ç•¥**ä½¿ç”¨é€™äº›å‡½æ•¸

### ä¿®å¾©æ­¥é©Ÿ

#### 1. å‰µå»º private schema

```sql
create schema if not exists private;
```

#### 2. å‰µå»º SECURITY DEFINER å‡½æ•¸

```sql
-- æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æ˜¯çµ„ç¹”æˆå“¡
create or replace function private.is_user_org_member(
  org_account_id UUID, 
  user_auth_id UUID
)
returns boolean
language plpgsql
security definer  -- é—œéµï¼šä»¥å‰µå»ºè€…æ¬Šé™åŸ·è¡Œï¼Œç¹é RLS
set search_path = ''  -- é˜²æ­¢ search_path æ³¨å…¥æ”»æ“Š
as $$
begin
  return exists (
    select 1
    from public.team_members tm
    join public.teams t on tm.team_id = t.id
    join public.accounts a on tm.account_id = a.id
    where t.organization_id = org_account_id
      and a.auth_user_id = user_auth_id
  );
end;
$$;

-- æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æ˜¯çµ„ç¹”ç®¡ç†å“¡
create or replace function private.is_user_org_admin(
  org_account_id UUID, 
  user_auth_id UUID
)
returns boolean
language plpgsql
security definer
set search_path = ''
as $$
begin
  return exists (
    select 1
    from public.team_members tm
    join public.teams t on tm.team_id = t.id
    join public.accounts a on tm.account_id = a.id
    where t.organization_id = org_account_id
      and a.auth_user_id = user_auth_id
      and tm.role = 'leader'
  );
end;
$$;
```

#### 3. æ›´æ–° RLS ç­–ç•¥

```sql
-- åˆªé™¤èˆŠç­–ç•¥
drop policy if exists "Users can view own account or organization accounts they belong" on accounts;
drop policy if exists "Users can update own account or organization accounts they mana" on accounts;

-- å‰µå»ºæ–°ç­–ç•¥ï¼ˆä½¿ç”¨ SECURITY DEFINER å‡½æ•¸ï¼‰
create policy "Users can view own account or organization accounts they belong"
on accounts for select
to authenticated
using (
  (select auth.uid()) = auth_user_id
  OR (
    type = 'Organization'
    AND (select private.is_user_org_member(id, auth.uid()))
  )
);

create policy "Users can update own account or organization accounts they manage"
on accounts for update
to authenticated
using (
  (select auth.uid()) = auth_user_id
  OR (
    type = 'Organization'
    AND (select private.is_user_org_admin(id, auth.uid()))
  )
)
with check (
  (select auth.uid()) = auth_user_id
  OR (
    type = 'Organization'
    AND (select private.is_user_org_admin(id, auth.uid()))
  )
);
```

---

## ğŸ”‘ é—œéµå·®ç•°

### âŒ åŸå§‹ç­–ç•¥ï¼ˆæœ‰éæ­¸å•é¡Œï¼‰

```sql
-- ç­–ç•¥ä¸­ç›´æ¥æŸ¥è©¢ accounts è¡¨
tm.account_id = (
  SELECT accounts_1.id
  FROM accounts accounts_1  -- âš ï¸ è§¸ç™¼ RLS æª¢æŸ¥ï¼Œå½¢æˆéæ­¸
  WHERE accounts_1.auth_user_id = auth.uid()
)
```

### âœ… ä¿®å¾©å¾Œçš„ç­–ç•¥ï¼ˆç„¡éæ­¸å•é¡Œï¼‰

```sql
-- ä½¿ç”¨ SECURITY DEFINER å‡½æ•¸
(select private.is_user_org_member(id, auth.uid()))
-- å‡½æ•¸å…§éƒ¨æŸ¥è©¢ accounts è¡¨æ™‚ï¼Œä»¥å‰µå»ºè€…æ¬Šé™åŸ·è¡Œï¼Œç¹é RLS
```

---

## ğŸ“Š é©—è­‰æ­¥é©Ÿ

ä¿®å¾©å¾Œæ‡‰è©²ï¼š

1. âœ… **å‡½æ•¸å­˜åœ¨**ï¼š
```sql
SELECT proname, prosecdef 
FROM pg_proc 
WHERE pronamespace = 'private'::regnamespace;
```

2. âœ… **æŸ¥è©¢æˆåŠŸ**ï¼š
```sql
-- æ‡‰è©²è¿”å› 200 OKï¼Œä¸å†å‡ºç¾éæ­¸éŒ¯èª¤
GET /rest/v1/accounts?select=*
```

3. âœ… **æ¬Šé™æ§åˆ¶æ­£å¸¸**ï¼š
- ç”¨æˆ¶åªèƒ½çœ‹åˆ°è‡ªå·±çš„ account
- ç”¨æˆ¶å¯ä»¥çœ‹åˆ°æ‰€å±¬çµ„ç¹”çš„ account
- ç”¨æˆ¶åªèƒ½æ›´æ–°è‡ªå·±çš„ account æˆ–ç®¡ç†çš„çµ„ç¹” account

---

## ğŸ“ ç¶“é©—ç¸½çµ

### ç‚ºä»€éº¼ç¬¬ä¸€æ¬¡ä¿®å¾©æœƒå¤±æ•—ï¼Ÿ

1. **ä¿®å¾©æœ¬èº«æ˜¯æ­£ç¢ºçš„**ï¼šä½¿ç”¨ SECURITY DEFINER å‡½æ•¸æ˜¯å®˜æ–¹æ¨è–¦çš„æ–¹æ³•
2. **ä½†è¢«å¾©åŸäº†**ï¼šå› ç‚ºç”¨æˆ¶è¦æ±‚å¾©åŸæ‰€æœ‰ RLS ä¿®æ”¹
3. **åŸå§‹ç­–ç•¥æœ‰å•é¡Œ**ï¼šaccounts è¡¨çš„åŸå§‹ RLS ç­–ç•¥è¨­è¨ˆå°±æœ‰éæ­¸å•é¡Œ

### æ•™è¨“

1. **ä¸è¦å¾©åŸæ­£ç¢ºçš„ä¿®å¾©**ï¼šå¦‚æœä¿®å¾©æ–¹æ¡ˆæ˜¯æ­£ç¢ºçš„ï¼ˆç¬¦åˆå®˜æ–¹æœ€ä½³å¯¦è¸ï¼‰ï¼Œä¸æ‡‰è©²å¾©åŸ
2. **å€åˆ†å•é¡Œå’Œè§£æ±ºæ–¹æ¡ˆ**ï¼š
   - **å•é¡Œ**ï¼šè¨»å†Šæ™‚æ²’æœ‰å‰µå»º account è¨˜éŒ„ï¼ˆå·²é€šéè§¸ç™¼å™¨è§£æ±ºï¼‰
   - **å•é¡Œ**ï¼šaccounts è¡¨çš„ RLS ç­–ç•¥æœ‰éæ­¸å•é¡Œï¼ˆéœ€è¦ SECURITY DEFINER å‡½æ•¸è§£æ±ºï¼‰
3. **å…©å€‹å•é¡Œæ˜¯ç¨ç«‹çš„**ï¼š
   - å³ä½¿ account è¨˜éŒ„å·²å‰µå»ºï¼ŒRLS ç­–ç•¥çš„éæ­¸å•é¡Œä»ç„¶å­˜åœ¨
   - éœ€è¦åˆ†åˆ¥è§£æ±º

---

## ğŸ”„ ä¸‹ä¸€æ­¥è¡Œå‹•

1. **é‡æ–°å¯¦æ–½ä¿®å¾©**ï¼šä½¿ç”¨ SECURITY DEFINER å‡½æ•¸ä¿®å¾© accounts è¡¨çš„ RLS éæ­¸å•é¡Œ
2. **é©—è­‰ä¿®å¾©**ï¼šæ¸¬è©¦æŸ¥è©¢æ˜¯å¦æˆåŠŸ
3. **æ–‡æª”æ›´æ–°**ï¼šè¨˜éŒ„ä¿®å¾©éç¨‹å’Œé©—è­‰çµæœ

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-01-15  
**ç¶­è­·è€…**ï¼šé–‹ç™¼åœ˜éšŠ

