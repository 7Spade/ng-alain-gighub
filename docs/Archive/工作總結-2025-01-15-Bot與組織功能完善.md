# å·¥ä½œç¸½çµ - Bot èˆ‡çµ„ç¹”åŠŸèƒ½å®Œå–„

**æ—¥æœŸ**ï¼š2025-01-15  
**ç¯„åœ**ï¼šBot è³¬æˆ¶å€åˆ†æ©Ÿåˆ¶ã€åœ˜éšŠå’Œæ’ç­çµ„ç¹”å°ˆæœ‰åŠŸèƒ½å¯¦æ–½

---

## ğŸ“‹ å·¥ä½œæ¦‚è¿°

æœ¬æ¬¡å·¥ä½œä¸»è¦å®Œæˆäº†ä»¥ä¸‹ä¸‰å€‹æ ¸å¿ƒä»»å‹™ï¼š

1. **å€‹äºº Bot èˆ‡çµ„ç¹” Bot å€åˆ†æ©Ÿåˆ¶å¯¦æ–½**
2. **åœ˜éšŠå’Œæ’ç­åŠŸèƒ½æ”¹ç‚ºçµ„ç¹”å°ˆæœ‰**
3. **æ§‹å»ºéŒ¯èª¤ä¿®å¾©**

---

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. å€‹äºº Bot èˆ‡çµ„ç¹” Bot å€åˆ†æ©Ÿåˆ¶

#### è¨­è¨ˆæ–¹æ¡ˆ

ä½¿ç”¨ `auth_organization_id` å­—æ®µå€åˆ†å€‹äºº Bot å’Œçµ„ç¹” Botï¼š

- **å€‹äºº Bot**ï¼š`auth_organization_id = NULL`
- **çµ„ç¹” Bot**ï¼š`auth_organization_id = çµ„ç¹”è³¬æˆ¶ID`

#### å­—æ®µèªç¾©

- `auth_bot_id`ï¼šè¨˜éŒ„å‰µå»ºè€…ï¼ˆç”¨æˆ¶IDï¼‰ï¼Œæ‰€æœ‰ Bot éƒ½æœ‰
- `auth_organization_id`ï¼š
  - å°æ–¼ Organization è³¬æˆ¶ï¼šè¨˜éŒ„å‰µå»ºè€…ï¼ˆç”¨æˆ¶IDï¼‰
  - å°æ–¼ Bot è³¬æˆ¶ï¼šè¨˜éŒ„æ‰€å±¬çµ„ç¹”ï¼ˆNULL = å€‹äºº Botï¼Œæœ‰å€¼ = çµ„ç¹” Botï¼‰

#### å¯¦æ–½å…§å®¹

**æ•¸æ“šåº«å±¤**ï¼š

1. **æ›´æ–° `create_bot_account` å‡½æ•¸**
   - æ·»åŠ  `p_organization_id` åƒæ•¸ï¼ˆå¯é¸ï¼Œé»˜èªç‚º NULLï¼‰
   - é©—è­‰çµ„ç¹”å­˜åœ¨æ€§å’Œç”¨æˆ¶æ¬Šé™
   - æ”¯æŒå‰µå»ºå€‹äºº Bot å’Œçµ„ç¹” Bot

2. **æ›´æ–° RLS ç­–ç•¥**
   - SELECT ç­–ç•¥æ”¯æŒçµ„ç¹”æˆå“¡æŸ¥çœ‹çµ„ç¹” Bot
   - å€‹äºº Botï¼šåªæœ‰å‰µå»ºè€…å¯æŸ¥çœ‹
   - çµ„ç¹” Botï¼šå‰µå»ºè€…å’Œçµ„ç¹”æˆå“¡éƒ½å¯æŸ¥çœ‹

3. **æ¸…ç†èˆŠæ•¸æ“š**
   - åˆªé™¤æ‰€æœ‰ `auth_bot_id` ç‚º NULL çš„èˆŠ Bot è³¬æˆ¶
   - åˆªé™¤æ‰€æœ‰ `auth_organization_id` ç‚º NULL çš„èˆŠçµ„ç¹”è³¬æˆ¶

**å‰ç«¯å±¤**ï¼š

1. **AccountRepository**
   - `createBotAccount` æ–¹æ³•æ·»åŠ  `organizationId` åƒæ•¸

2. **AccountService**
   - `createBotAccount` æ–¹æ³•æ·»åŠ  `organizationId` åƒæ•¸
   - æ–°å¢ `personalBotAccounts` computed signalï¼ˆå€‹äºº Bot åˆ—è¡¨ï¼‰
   - æ–°å¢ `organizationBotAccounts` computed signalï¼ˆçµ„ç¹” Bot åˆ—è¡¨ï¼‰

3. **CreateBotComponent**
   - ä¿æŒç¾æœ‰å¯¦ç¾ï¼Œé»˜èªå‰µå»ºå€‹äºº Botï¼ˆ`organizationId = null`ï¼‰
   - æœªä¾†å¯æ“´å±•æ”¯æŒé¸æ“‡çµ„ç¹”å‰µå»ºçµ„ç¹” Bot

#### æ¬Šé™æ§åˆ¶çŸ©é™£

| Bot é¡å‹ | å‰µå»ºè€…æ¬Šé™ | çµ„ç¹”æˆå“¡æ¬Šé™ | å…¶ä»–ç”¨æˆ¶æ¬Šé™ |
|---------|----------|------------|------------|
| å€‹äºº Bot | âœ… å¯æŸ¥çœ‹ | âŒ ä¸å¯æŸ¥çœ‹ | âŒ ä¸å¯æŸ¥çœ‹ |
| çµ„ç¹” Bot | âœ… å¯æŸ¥çœ‹ | âœ… å¯æŸ¥çœ‹ | âŒ ä¸å¯æŸ¥çœ‹ |

---

### 2. åœ˜éšŠå’Œæ’ç­åŠŸèƒ½æ”¹ç‚ºçµ„ç¹”å°ˆæœ‰

#### è¨­è¨ˆåŸå‰‡

- **çµ„ç¹”å°ˆæœ‰åŠŸèƒ½**ï¼šåœ˜éšŠå’Œæ’ç­å¿…é ˆé—œè¯åˆ°çµ„ç¹”
- **æ˜ç¢ºçš„æ•¸æ“šç¯„åœ**ï¼šé€šéçµ„ç¹”é¸æ“‡å™¨æ˜ç¢ºç•¶å‰æ“ä½œçš„çµ„ç¹”
- **ç”¨æˆ¶é«”é©—**ï¼šè‡ªå‹•é¸æ“‡å–®å€‹çµ„ç¹”ï¼Œæ¸›å°‘æ“ä½œæ­¥é©Ÿ
- **æ•¸æ“šå®‰å…¨**ï¼šRLS ç­–ç•¥ç¢ºä¿ç”¨æˆ¶åªèƒ½è¨ªå•æœ‰æ¬Šé™çš„æ•¸æ“š

#### å¯¦æ–½å…§å®¹

**TeamListComponentï¼ˆåœ˜éšŠåˆ—è¡¨ï¼‰**ï¼š

1. **æ·»åŠ çµ„ç¹”é¸æ“‡å™¨**
   - ç”¨æˆ¶å¿…é ˆå…ˆé¸æ“‡çµ„ç¹”æ‰èƒ½æŸ¥çœ‹åœ˜éšŠ
   - å¦‚æœç”¨æˆ¶åªæœ‰ä¸€å€‹çµ„ç¹”ï¼Œè‡ªå‹•é¸æ“‡ä¸¦åŠ è¼‰

2. **ä½¿ç”¨ `loadTeamsByOrganizationId`**
   - åƒ…åŠ è¼‰é¸ä¸­çµ„ç¹”çš„åœ˜éšŠ
   - åˆªé™¤å¾Œä½¿ç”¨çµ„ç¹” ID é‡æ–°åŠ è¼‰

3. **å‰µå»ºåœ˜éšŠ**
   - å‚³éçµ„ç¹” ID åˆ°å‰µå»ºé é¢

**ScheduleListComponentï¼ˆæ’ç­åˆ—è¡¨ï¼‰**ï¼š

1. **æ·»åŠ çµ„ç¹”é¸æ“‡å™¨**
   - ç”¨æˆ¶å¿…é ˆå…ˆé¸æ“‡çµ„ç¹”æ‰èƒ½æŸ¥çœ‹æ’ç­
   - å¦‚æœç”¨æˆ¶åªæœ‰ä¸€å€‹çµ„ç¹”ï¼Œè‡ªå‹•é¸æ“‡ä¸¦åŠ è¼‰

2. **ä½¿ç”¨ `loadSchedulesByOrganizationId`**
   - åƒ…åŠ è¼‰é¸ä¸­çµ„ç¹”çš„æ’ç­
   - åˆªé™¤å¾Œä½¿ç”¨çµ„ç¹” ID é‡æ–°åŠ è¼‰

3. **å‰µå»º/ç·¨è¼¯æ’ç­**
   - å°èˆªåˆ°çµ„ç¹”è©³æƒ…é é¢é€²è¡Œæ“ä½œ

#### ç”¨æˆ¶é«”é©—æ”¹é€²

- **æç¤ºä¿¡æ¯**ï¼šæœªé¸æ“‡çµ„ç¹”æ™‚é¡¯ç¤ºå‹å¥½æç¤º
- **çµ„ç¹”åç¨±é¡¯ç¤º**ï¼šåˆ—è¡¨æ¨™é¡Œé¡¯ç¤ºç•¶å‰é¸æ“‡çš„çµ„ç¹”åç¨±
- **æ¢ä»¶é¡¯ç¤º**ï¼šåªæœ‰é¸æ“‡çµ„ç¹”å¾Œæ‰é¡¯ç¤º"æ–°å»º"æŒ‰éˆ•å’Œåˆ—è¡¨

---

### 3. æ§‹å»ºéŒ¯èª¤ä¿®å¾©

#### ä¿®å¾©çš„å•é¡Œ

1. **åˆªé™¤æ–¹æ³•ç¼ºå°‘åƒæ•¸**
   - `schedule-list.component.ts`ï¼š`delete` æ–¹æ³•ä¸­èª¿ç”¨ `loadSchedules()` æ™‚ç¼ºå°‘ `organizationId` åƒæ•¸
   - `team-list.component.ts`ï¼š`delete` æ–¹æ³•ä¸­èª¿ç”¨ `loadTeams()` æ™‚ç¼ºå°‘ `organizationId` åƒæ•¸

   **ä¿®å¾©**ï¼šåœ¨åˆªé™¤æˆåŠŸå¾Œï¼Œä½¿ç”¨ç•¶å‰é¸æ“‡çš„çµ„ç¹” ID é‡æ–°åŠ è¼‰æ•¸æ“šã€‚

2. **é¡å‹å®šç¾©å•é¡Œ**
   - `account.service.ts`ï¼š`authOrganizationId` å±¬æ€§åœ¨é¡å‹å®šç¾©ä¸­ä¸å­˜åœ¨

   **ä¿®å¾©**ï¼šä½¿ç”¨é¡å‹æ–·è¨€ `(a as any).authOrganizationId` è‡¨æ™‚è§£æ±ºã€‚ç”±æ–¼ `BaseRepository` æœƒè‡ªå‹•å°‡ `auth_organization_id` è½‰æ›ç‚º `authOrganizationId`ï¼Œé‹è¡Œæ™‚æ˜¯æ­£ç¢ºçš„ã€‚

#### æ§‹å»ºçµæœ

- âœ… æ§‹å»ºæˆåŠŸï¼Œç„¡ TypeScript éŒ¯èª¤
- âš ï¸ æœ‰ä¸€å€‹è­¦å‘Šï¼šbundle å¤§å°è¶…éé ç®—ï¼ˆ3.49 MB > 2.00 MBï¼‰ï¼Œé€™æ˜¯æ€§èƒ½å„ªåŒ–å»ºè­°ï¼Œä¸å½±éŸ¿åŠŸèƒ½

---

## ğŸ“Š æŠ€è¡“ç´°ç¯€

### æ•¸æ“šåº«å‡½æ•¸

#### `create_bot_account` å‡½æ•¸

```sql
CREATE OR REPLACE FUNCTION public.create_bot_account(
  p_name character varying,
  p_email character varying DEFAULT NULL::character varying,
  p_status character varying DEFAULT 'active'::character varying,
  p_organization_id uuid DEFAULT NULL::uuid
)
RETURNS uuid
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path TO 'public'
```

**åŠŸèƒ½**ï¼š
- æ”¯æŒå‰µå»ºå€‹äºº Botï¼ˆ`p_organization_id = NULL`ï¼‰
- æ”¯æŒå‰µå»ºçµ„ç¹” Botï¼ˆ`p_organization_id = çµ„ç¹”ID`ï¼‰
- é©—è­‰çµ„ç¹”å­˜åœ¨æ€§å’Œç”¨æˆ¶æ¬Šé™

### RLS ç­–ç•¥æ›´æ–°

#### accounts è¡¨ SELECT ç­–ç•¥

```sql
USING (
  -- è‡ªå·±çš„è³¬æˆ¶
  (auth_user_id = auth.uid())
  OR
  -- è‡ªå·±å‰µå»ºçš„çµ„ç¹”è³¬æˆ¶
  (type = 'Organization' AND auth_organization_id = auth.uid())
  OR
  -- è‡ªå·±å‰µå»ºçš„ Botï¼ˆå€‹äººæˆ–çµ„ç¹”ï¼‰
  (type = 'Bot' AND auth_bot_id = auth.uid())
  OR
  -- æ‰€å±¬çµ„ç¹”çš„ Botï¼ˆçµ„ç¹”æˆå“¡å¯æŸ¥çœ‹ï¼‰
  (
    type = 'Bot' 
    AND auth_organization_id IS NOT NULL
    AND is_user_org_member(auth_organization_id, auth.uid())
  )
  OR
  -- æ‰€å±¬çš„çµ„ç¹”è³¬æˆ¶
  (type = 'Organization' AND is_user_org_member(accounts.id, auth.uid()))
)
```

### å‰ç«¯ä»£ç¢¼è®Šæ›´

#### AccountService æ–°å¢æ–¹æ³•

```typescript
/** å€‹äºº Bot è³¬æˆ¶ï¼ˆauth_organization_id ç‚º NULLï¼‰ */
readonly personalBotAccounts = computed(() =>
  this.accounts().filter(a => a.type === AccountType.BOT && !(a as any).authOrganizationId)
);

/** çµ„ç¹” Bot è³¬æˆ¶ï¼ˆauth_organization_id ä¸ç‚º NULLï¼‰ */
readonly organizationBotAccounts = computed(() =>
  this.accounts().filter(a => a.type === AccountType.BOT && !!(a as any).authOrganizationId)
);
```

---

## ğŸ¯ è¨­è¨ˆæ±ºç­–

### ç‚ºä»€éº¼ä½¿ç”¨ `auth_organization_id` å€åˆ† Bot é¡å‹ï¼Ÿ

1. **ä¸éœ€è¦ä¿®æ”¹è¡¨çµæ§‹**ï¼šå¾©ç”¨ç¾æœ‰å­—æ®µ
2. **èªç¾©æ¸…æ™°**ï¼š
   - `auth_bot_id`ï¼šèª°å‰µå»ºäº†é€™å€‹ Botï¼ˆç¸½æ˜¯ç”¨æˆ¶ï¼‰
   - `auth_organization_id`ï¼šBot å±¬æ–¼å“ªå€‹çµ„ç¹”ï¼ˆNULL = å€‹äºº Botï¼Œæœ‰å€¼ = çµ„ç¹” Botï¼‰
3. **èˆ‡ Organization è³¬æˆ¶ä¸€è‡´**ï¼šOrganization è³¬æˆ¶ä¹Ÿä½¿ç”¨ `auth_organization_id` è¨˜éŒ„å‰µå»ºè€…

### ç‚ºä»€éº¼åœ˜éšŠå’Œæ’ç­éœ€è¦çµ„ç¹”é¸æ“‡å™¨ï¼Ÿ

1. **æ˜ç¢ºæ•¸æ“šç¯„åœ**ï¼šç”¨æˆ¶å¯èƒ½å±¬æ–¼å¤šå€‹çµ„ç¹”ï¼Œéœ€è¦æ˜ç¢ºç•¶å‰æ“ä½œçš„çµ„ç¹”
2. **ç¬¦åˆæ¥­å‹™é‚è¼¯**ï¼šåœ˜éšŠå’Œæ’ç­æ˜¯çµ„ç¹”å°ˆæœ‰åŠŸèƒ½ï¼Œå¿…é ˆé—œè¯åˆ°çµ„ç¹”
3. **æ•¸æ“šå®‰å…¨**ï¼šRLS ç­–ç•¥ç¢ºä¿ç”¨æˆ¶åªèƒ½è¨ªå•æ‰€å±¬çµ„ç¹”çš„æ•¸æ“š

---

## ğŸ“ å¾ŒçºŒå·¥ä½œå»ºè­°

1. **æ›´æ–° TypeScript é¡å‹å®šç¾©**
   - ä½¿ç”¨ Supabase MCP å·¥å…·é‡æ–°ç”Ÿæˆé¡å‹å®šç¾©ï¼ŒåŒ…å« `auth_organization_id` å’Œ `auth_bot_id` å­—æ®µ
   - ç§»é™¤è‡¨æ™‚çš„é¡å‹æ–·è¨€

2. **æ“´å±• CreateBotComponent**
   - æ·»åŠ çµ„ç¹”é¸æ“‡å™¨ï¼Œæ”¯æŒå‰µå»ºçµ„ç¹” Bot
   - æ ¹æ“šé¸æ“‡çš„çµ„ç¹”é¡å‹é¡¯ç¤ºä¸åŒçš„è¡¨å–®

3. **æ€§èƒ½å„ªåŒ–**
   - è€ƒæ…®å„ªåŒ– bundle å¤§å°ï¼ˆç•¶å‰ 3.49 MB > 2.00 MB é ç®—ï¼‰
   - ä½¿ç”¨ä»£ç¢¼åˆ†å‰²å’Œæ‡¶åŠ è¼‰å„ªåŒ–åˆå§‹åŠ è¼‰æ™‚é–“

4. **æ–‡æª”æ›´æ–°**
   - æ›´æ–° API æ–‡æª”ï¼Œèªªæ˜ Bot å‰µå»º API çš„æ–°åƒæ•¸
   - æ›´æ–°ç”¨æˆ¶æŒ‡å—ï¼Œèªªæ˜å€‹äºº Bot å’Œçµ„ç¹” Bot çš„å€åˆ¥

---

## ğŸ” ç›¸é—œæ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶

- `src/app/core/infra/repositories/account.repository.ts`
- `src/app/shared/services/account/account.service.ts`
- `src/app/routes/accounts/teams/team-list.component.ts`
- `src/app/routes/accounts/schedules/schedule-list.component.ts`

### æ•¸æ“šåº«é·ç§»

- `update_create_bot_account_support_organization` - æ›´æ–° Bot å‰µå»ºå‡½æ•¸
- `update_accounts_rls_support_organization_bot` - æ›´æ–° RLS ç­–ç•¥

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-01-15  
**ç¶­è­·è€…**ï¼šé–‹ç™¼åœ˜éšŠ

