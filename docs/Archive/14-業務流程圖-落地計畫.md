# 14｜業務流程圖落地計畫（生產就緒版）

> 日期：2025-11-15  
> 對應文件：`docs/14-業務流程圖.mermaid-自適應.md`  
> 範圍：Supabase（DB/RLS/Storage/Edge Functions/Realtime）、Angular 20（ng-alain）、測試與可觀測性

---

## 1. 目標與範圍
- 將流程圖的每個節點對應到具體交付物（資料表、API、Function、前端頁面/元件、測試用例）。
- 優先交付任務主線（Task → 日報 → QC → 進度 → 通知），並為分支/Fork/PR 打下基建（RLS、審查/合併流程骨架）。
- 提供可運行的技術骨架、統一事件模型、與可驗收的測試標準。

## 2. 關鍵決策與原則
- 權限模型：以 `branch_roles` 為分支級別授權核心，結合 Supabase RLS，採最小授權原則（owner/maintainer/contributor/viewer）。
- 暫存區（48h）：採主表 `status = 'staging' + expires_at` 模型，Supabase Scheduler 定時 Job 處理到期（轉正或清理），保留可撤回語意。
- PR 合併一致性：`branch-merge` Function 內部採用版本快照與衝突檢測，冪等鍵（`pr_id`）與重試安全；寫 `activity_logs`。
- Realtime：通道命名規約 `branch:{id}:*`、`pr:{id}:*`、`org:{id}:notifications`；payload 統一（`event`, `entity`, `id`, `summary`, `by`, `at`）。
- 報表一致性與效能：核心統計用 Materialized Views（MV），重要寫入後以事件觸發刷新，輔以定時全量刷新。
- Storage 安全：`images/`, `documents/` 皆私有；上傳採簽名 URL，下載權限綁定分支角色；圖片縮圖與壓縮走上傳 Hook。
- 活動記錄：所有關鍵表 insert/update 產生活動事件，敏感欄位遮罩，冪等寫入，便於審計與回溯。

## 3. 交付物分解（按領域）
- 後端 Edge Functions（Supabase Functions）
  - branch-merge：PR 合併、衝突檢測、版本快照、活動記錄。
  - weather-api：天氣查詢 + `weather_cache` 快取（TTL、限流、退化）。
  - notify：事件 → 受眾解析 → `notifications` 寫入 + Realtime 廣播。
  - progress-calc：任務/QC 事件 → 進度計算 → `progress_tracking` 更新。
- DB 與 RLS/Trigger
  - RLS：`blueprints`, `blueprint_branches`, `branch_roles`, `tasks`, `pull_requests`, `daily_reports`, `issues`, `comments`, `documents`, `notifications`。
  - 觸發器：統一 `activity_logs`；`daily_reports`、`issues`、`pull_requests` 事件化。
  - 暫存區：主表 `status, expires_at`；Scheduler Job `staging-finalize`。
  - 視圖與 MV：任務完成率、日報數、QC 合格率、分支進度快照。
- Realtime 設計
  - 通道：`branch:{id}:tasks|comments|issues|progress`、`pr:{id}:reviews`、`org:{id}:notifications`。
  - 授權：僅分支成員/PR 參與者可訂閱；payload schema 固定。
- Storage 策略
  - Buckets：`images/`（含 `images/thumbnails/`）、`documents/`（私有）。
  - 縮圖：上傳 Hook 觸發，寫 meta 與縮圖路徑。
- 前端（Angular 20 + ng-alain）
  - 路由：Dashboard、Blueprint/Branch 選擇、Main/Branch Console、Task/ToDo、中繼（日報/天氣/照片）、QC、Issues、Reports、Documents、Discuss。
  - 共用元件：上傳器、評論串、通知列表、進度視覺化、PR 審查面板。
  - 狀態：Signals + Repository 模式；統一錯誤與載入處理；`SHARED_IMPORTS`。
- 測試與可觀測性
  - 單元/整合：Functions 套件化測試、RLS 測試、前端元件與守衛。
  - 端對端：主線與 PR 合併流程；錄製關鍵路徑。
  - 觀測：結構化日誌、指標（成功率/延遲/重試）、MV 刷新監控。

## 4. Edge Functions 介面契約（草案）
- branch-merge
  - Input: `{ pr_id: string, actor: string }`
  - Auth: `actor` 必須為目標主分支 `maintainer` 以上；PR 狀態需 `approved`。
  - Output: `{ merged: boolean, snapshot_id: string, conflicts?: Array<{path:string, reason:string}> }`
  - Side effects: 寫 `activity_logs`、更新 `blueprint_branches`、通知 `org:{id}:notifications`。
- weather-api
  - Input: `{ lat: number, lon: number, date: string }`
  - Output: `{ tempC: number, summary: string, source: 'cache'|'api' }`
  - Cache: `weather_cache` by `(lat,lon,date)` TTL；外部 API 限流與失敗退化。
- notify
  - Input: `{ event: string, entity: string, id: string, audience: { type: 'org'|'branch'|'user', ref: string }, by: string }`
  - Output: `{ delivered: number }`
- progress-calc
  - Input: `{ task_id: string, trigger: 'daily_report'|'qc_pass'|'manual' }`
  - Output: `{ progress: number, updated_at: string }`

## 5. DB 與 RLS 策略（要點）
- `branch_roles`
  - Columns: `branch_id, user_id, role in ('owner','maintainer','contributor','viewer')`
  - RLS: 使用者可讀取屬於自身之記錄；owner/maintainer 可管理該分支角色。
- `tasks`
  - RLS 讀：分支成員可讀。
  - RLS 寫：`creator` 或 `assignee` 可更新內容；`maintainer` 可變更狀態/指派。
  - 暫存：`status='staging'` + `expires_at`；超時 Job 轉正/清理。
- `pull_requests`
  - 讀：主分支維護者、來源分支成員。
  - 寫：來源分支成員提交/更新內容；審查者可變更 `review` 狀態。
- `daily_reports`
  - 讀：分支成員；QC/審查關聯者。
  - 寫：對應任務的 `assignee`。
- `issues`, `comments`, `documents`, `notifications`
  - 皆以分支/實體關聯 + 角色授權控制；下載需簽名 URL 或服務端代理。
- 觸發器 `activity_logs`
  - 通用格式：`{entity, entity_id, action, by, at, summary}`；避免存放敏感全文。

## 6. Realtime 規約
- 通道命名：
  - `branch:{id}:tasks|comments|issues|progress`
  - `pr:{id}:reviews`
  - `org:{id}:notifications`
- Payload：`{ event, entity, id, summary, by, at }`
- 安全：加入前校驗使用者是否具備對應分支/PR 權限；payload 僅含必要摘要。

## 7. Storage 與縮圖策略
- Buckets：`images/` 與 `documents/` 全私有。
- 上傳：前端請求簽名 URL，上傳完成回填 meta（MIME/size/hash/owner/branch_id）。
- 下載：簽名 URL 限時；或透過 Edge Function 檢查後代理下載。
- 縮圖：上傳 Hook 產生 `images/thumbnails/{object}`，並在 meta 指向縮圖路徑。

## 8. 前端工作包（Angular 20 + ng-alain）
- 路由與頁面骨架：
  - `/dashboard` 儀表板（分支/藍圖選擇）
  - `/branch/:id` 分支面板（任務列表、待辦中心、通知）
  - `/task/:id` 任務詳情（日報、照片、天氣、討論）
  - `/qc` 品質驗收面板（QC 任務、拍照上傳、結果）
  - `/issues` 問題管理（指派、處理、討論、結案）
  - `/reports` 報表（圖表、匯出）
  - `/documents` 文件中心（上傳、權限、版本）
  - `/pr` PR/Review 面板（後續接合併）
- 共用元件：Uploader（圖片/文件）、CommentThread、NotificationList、ProgressBar、PRReviewPanel。
- 狀態/資料層：Signals + Repository；統一 `error/loading`；遵循 `SHARED_IMPORTS`。

## 9. 測試與可觀測性
- 單元：Functions（邏輯、冪等、錯誤）、前端元件/守衛、RLS 策略（正反測）。
- 整合：任務→日報→QC→進度；PR 提交→審查→合併。
- 端對端：關鍵 happy path，錄製 + 截圖保證。
- 可觀測：Function 結構化日誌、成功率/延遲/重試；MV 刷新耗時與錯誤率；通知投遞率。

## 10. 里程碑與時程（建議）
- Phase 0（週1）：RLS 最小集、`activity_logs`、Storage 政策、Realtime 規約、Functions 骨架與 CI。
- Phase 1（週2-3）：Task 主線 + 日報/天氣/照片 + 通知 + 基礎報表 MV；e2e 主流程。
- Phase 2（週4）：Fork/Branch/PR 流程骨架，`branch-merge` 可運行，審查看板。
- Phase 3（週5）：QC 與 `progress-calc`、進度視覺化、MV 刷新策略完整化。
- Phase 4（週6）：性能與治理、縮圖/壓縮、觀測指標完善、匯出模板化。

## 11. 本週優先事項（可立即執行）
1) RLS 核心策略原型：`branch_roles`, `tasks`, `pull_requests`, `comments`, `documents`。  
2) 暫存區落地：`status + expires_at`、Scheduler Job `staging-finalize`。  
3) Functions 介面契約：`branch-merge`, `weather-api`, `notify`, `progress-calc`。  
4) Realtime 規約與前端事件匯流排骨架。  
5) 前端頁殼與共用元件骨架，串 `_mock`。  
6) 報表 MV 原型（任務完成率、日報數）。

## 12. 風險與緩解
- PR 合併衝突複雜：加入預檢與模擬合併；提供回滾快照。
- RLS 過嚴或過寬：以測試樣例先行，逐步收斂；審計日誌監控拒絕/允許率。
- Realtime 噪音與授權：通道劃分清晰、payload 最小化；訂閱時再次校驗。
- 外部天氣 API 限流：先查快取，退化為最近可用；指標監控與告警。

## 13. 驗收標準（抽樣）
- 任務主線：在權限正確情況下，全流程 3 次連續成功，平均用時與錯誤率在目標內。
- PR 合併：含 1 次衝突案例可被檢出並拒絕；通過案例成功合併且可回滾。
- 報表：MV 刷新在 SLA 內（< 2 分鐘），查詢 P95 < 300ms。
- Storage：非成員無法透過 URL 直接存取原檔與縮圖。

## 14. 指標與監控
- Functions：成功率 ≥ 99%，P95 延遲 < 500ms，重試率 < 1%。
- Realtime：投遞成功率 ≥ 99%，訂閱授權失敗率 < 0.5%。
- MV：刷新錯誤率 < 1%，刷新耗時 P95 < 30s。
- 前端：關鍵互動錯誤率 < 0.5%，CLP 事件覆蓋 ≥ 90%。

## 15. 附錄：流程節點 → 交付物映射（摘錄）
- AuthCheck → Supabase Auth + `accounts` RLS；前端路由守衛。
- Dashboard/SelectBlueprint → `blueprints`、`blueprint_branches` 查詢視圖。
- ForkFlow/CreateBranch/InviteOrg → `branch_forks`、`blueprint_branches`、`organization_collaborations` + RLS。
- PRSubmit/ReviewFlow/MergeDecision → `pull_requests`、`pull_request_reviews`、Function `branch-merge`、活動記錄。
- CreateTask/AssignTask/TaskNotify → `tasks`、`notifications`、Realtime `branch:{id}:tasks`。
- DailyReport/UploadPhoto/RecordWeather/SaveReport → `daily_reports`、`images/`、Function `weather-api`、`weather_cache`。
- SubmitQC/QCInspect/QCPhoto/QCResult → `quality_checks`、`images/`、`issues`（不合格）。
- UpdateProgress/NotifyComplete → Function `progress-calc`、`progress_tracking`、Realtime `branch:{id}:progress`。
- OpenIssue/IssueAssign/IssueNotify/IssueHandle/IssueDiscuss/CloseIssue → `issues`、`issue_assignments`、`comments`、`notifications`。
- AnalyzeData/QueryData/GenerateChart/ExportReport → MV + 前端圖表渲染與匯出。
- UploadDoc/SaveDocMeta/PermCheck → `documents`、RLS、簽名 URL。
- OpenDiscuss/PostComment/NotifyTeam → `comments`、Realtime `branch:{id}:comments`。

---

### 下一步建議
- 我們可立即：
  1) 新增 `docs/rls-policies-draft.sql` 草案（核心 5 表）。
  2) 在 `src/app/` 生成路由與頁殼骨架，接 `_mock`。
  3) 建立 `supabase/functions/` 目錄與 4 個 Functions 骨架 + 測試樣板。
- 請確認是否先從 RLS 草案與 Functions 骨架開始，我將直接提交對應檔案與最小可運行模板。
