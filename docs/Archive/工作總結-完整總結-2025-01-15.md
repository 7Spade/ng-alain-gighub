# å·¥ä½œç¸½çµ - accounts è¡¨ RLS éæ­¸å•é¡Œä¿®å¾©å®Œæ•´ç¸½çµ

> **æ—¥æœŸ**ï¼š2025-01-15  
> **ç‹€æ…‹**ï¼šâœ… å®Œæˆä¸¦é©—è­‰é€šé

---

## ğŸ“‹ ä»»å‹™æ¦‚è¿°

ä¿®å¾© accounts è¡¨çš„ RLSï¼ˆRow Level Securityï¼‰éæ­¸å•é¡Œï¼Œè©²å•é¡Œå°è‡´æŸ¥è©¢ accounts è¡¨æ™‚è¿”å› 500 éŒ¯èª¤ï¼š`"infinite recursion detected in policy for relation \"accounts\""`ã€‚

---

## ğŸ” å•é¡Œè¨ºæ–·

### å•é¡Œç™¼ç¾

1. **åˆå§‹å•é¡Œ**ï¼šç”¨æˆ¶è¨»å†Šå¾Œæ²’æœ‰è‡ªå‹•å‰µå»º account è¨˜éŒ„
   - **è§£æ±ºæ–¹æ¡ˆ**ï¼šå‰µå»ºäº† `handle_new_user()` è§¸ç™¼å™¨è‡ªå‹•å‰µå»º account

2. **å¾ŒçºŒå•é¡Œ**ï¼šaccounts è¡¨æŸ¥è©¢è¿”å› 500 éŒ¯èª¤
   - **éŒ¯èª¤ä¿¡æ¯**ï¼š`"infinite recursion detected in policy for relation \"accounts\""`
   - **æ ¹æœ¬åŸå› **ï¼šRLS ç­–ç•¥ä¸­ç›´æ¥æŸ¥è©¢ accounts è¡¨ï¼Œå½¢æˆå¾ªç’°æŸ¥è©¢

### å•é¡Œæ ¹æº

accounts è¡¨çš„ SELECT ç­–ç•¥ä¸­å­˜åœ¨éæ­¸æŸ¥è©¢ï¼š

```sql
-- åŸå§‹ç­–ç•¥ï¼ˆæœ‰å•é¡Œï¼‰
tm.account_id = (
  SELECT accounts_1.id
  FROM accounts accounts_1  -- âš ï¸ è§¸ç™¼ RLS æª¢æŸ¥ï¼Œå½¢æˆéæ­¸
  WHERE accounts_1.auth_user_id = auth.uid()
)
```

**éæ­¸éˆ**ï¼š
- æŸ¥è©¢ `accounts` è¡¨ â†’ è§¸ç™¼ RLS ç­–ç•¥æª¢æŸ¥
- ç­–ç•¥ä¸­åˆæŸ¥è©¢ `accounts` è¡¨ â†’ å†æ¬¡è§¸ç™¼ RLS ç­–ç•¥æª¢æŸ¥
- ç„¡é™å¾ªç’° â†’ éæ­¸éŒ¯èª¤

---

## ğŸ”§ è§£æ±ºæ–¹æ¡ˆ

### åƒè€ƒ Supabase å®˜æ–¹æ–‡æª”

æŸ¥é–± Supabase å®˜æ–¹æ–‡æª”å¾Œï¼Œç¢ºèªä½¿ç”¨ **SECURITY DEFINER å‡½æ•¸**æ˜¯å®˜æ–¹æ¨è–¦çš„è§£æ±ºæ–¹æ¡ˆã€‚

**åƒè€ƒæ–‡æª”**ï¼š
- [Row Level Security æ–‡æª”](https://supabase.com/docs/guides/database/postgres/row-level-security#use-security-definer-functions)
- åœ¨ "Use security definer functions" ç« ç¯€ä¸­æœ‰è©³ç´°èªªæ˜

### å¯¦æ–½æ­¥é©Ÿ

#### 1. å‰µå»º private schema

```sql
create schema if not exists private;
```

#### 2. å‰µå»º SECURITY DEFINER å‡½æ•¸

**`private.is_user_org_member`**ï¼š
- åŠŸèƒ½ï¼šæª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æ˜¯çµ„ç¹”æˆå“¡
- åƒæ•¸ï¼š`org_account_id UUID`, `user_auth_id UUID`
- è¿”å›ï¼š`boolean`
- å®‰å…¨ç´šåˆ¥ï¼š`SECURITY DEFINER`

**`private.is_user_org_admin`**ï¼š
- åŠŸèƒ½ï¼šæª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æ˜¯çµ„ç¹”ç®¡ç†å“¡
- åƒæ•¸ï¼š`org_account_id UUID`, `user_auth_id UUID`
- è¿”å›ï¼š`boolean`
- å®‰å…¨ç´šåˆ¥ï¼š`SECURITY DEFINER`

#### 3. æ›´æ–° RLS ç­–ç•¥

- åˆªé™¤èˆŠçš„ SELECT å’Œ UPDATE ç­–ç•¥
- å‰µå»ºæ–°ç­–ç•¥ä½¿ç”¨ SECURITY DEFINER å‡½æ•¸

---

## âœ… ä¿®å¾©çµæœ

### é·ç§»æ–‡ä»¶

**é·ç§»åç¨±**ï¼š`fix_accounts_rls_recursion_with_security_definer`

**åŒ…å«å…§å®¹**ï¼š
1. âœ… å‰µå»º `private` schema
2. âœ… å‰µå»º `private.is_user_org_member()` å‡½æ•¸
3. âœ… å‰µå»º `private.is_user_org_admin()` å‡½æ•¸
4. âœ… æ›´æ–° accounts è¡¨çš„ SELECT ç­–ç•¥
5. âœ… æ›´æ–° accounts è¡¨çš„ UPDATE ç­–ç•¥

### é©—è­‰çµæœ

#### ä¿®å¾©å‰

- âŒ `GET /rest/v1/accounts?select=*` â†’ 500 Internal Server Error
- âŒ éŒ¯èª¤ï¼š`"infinite recursion detected in policy for relation \"accounts\""`
- âŒ é é¢ç„¡æ³•é¡¯ç¤ºæ•¸æ“š

#### ä¿®å¾©å¾Œ

- âœ… `GET /rest/v1/accounts?select=*` â†’ 200 OK
- âœ… æˆåŠŸè¿”å›æ•¸æ“šï¼š
```json
[{
  "id": "cdfc428d-d23d-4a7d-a881-9f10e921d85f",
  "auth_user_id": "037e1c67-3976-4c55-ba3a-e32982d7c9ef",
  "type": "User",
  "name": "ac7x",
  "email": "ac7x@pm.me",
  "status": "active",
  ...
}]
```
- âœ… é é¢æ­£å¸¸é¡¯ç¤ºæ•¸æ“š
- âœ… éŸ¿æ‡‰æ™‚é–“ï¼š4msï¼ˆæ€§èƒ½è‰¯å¥½ï¼‰

### åŠŸèƒ½é©—è­‰

ä½¿ç”¨ MCP å·¥å…·ç™»å…¥é©—è­‰ï¼ˆå¸³è™Ÿï¼šac7x@pm.meï¼Œå¯†ç¢¼ï¼š123123ï¼‰ï¼š

1. âœ… **ç™»å…¥æˆåŠŸ**ï¼šPOST /auth/v1/token â†’ 200 OK
2. âœ… **æŸ¥è©¢æˆåŠŸ**ï¼šGET /rest/v1/accounts â†’ 200 OK
3. âœ… **é é¢é¡¯ç¤º**ï¼šæˆåŠŸé¡¯ç¤º account åˆ—è¡¨
4. âœ… **æ•¸æ“šæ­£ç¢º**ï¼šé¡¯ç¤ºç”¨æˆ¶çš„ account è¨˜éŒ„

---

## ğŸ”‘ æŠ€è¡“è¦é»

### SECURITY DEFINER å‡½æ•¸çš„ä½œç”¨

1. **ç¹é RLS æª¢æŸ¥**ï¼š
   - å‡½æ•¸ä»¥å‰µå»ºè€…ï¼ˆ`postgres` è§’è‰²ï¼‰çš„æ¬Šé™åŸ·è¡Œ
   - å‰µå»ºè€…å…·æœ‰ `bypassrls` æ¬Šé™
   - å‡½æ•¸å…§éƒ¨æŸ¥è©¢ä¸å— RLS é™åˆ¶

2. **é¿å…éæ­¸**ï¼š
   - å‡½æ•¸å…§éƒ¨æŸ¥è©¢ `accounts` è¡¨æ™‚ä¸æœƒè§¸ç™¼ RLS ç­–ç•¥
   - æ‰“ç ´å¾ªç’°æŸ¥è©¢éˆï¼Œé¿å…ç„¡é™éæ­¸

3. **å®‰å…¨æ€§**ï¼š
   - ä½¿ç”¨ `set search_path = ''` é˜²æ­¢ search_path æ³¨å…¥æ”»æ“Š
   - å‡½æ•¸æ”¾åœ¨ `private` schema ä¸­ï¼Œä¸åœ¨ "Exposed schemas" ä¸­

### ä¿®å¾©å‰å¾Œå°æ¯”

| é …ç›® | ä¿®å¾©å‰ | ä¿®å¾©å¾Œ |
|------|--------|--------|
| accounts æŸ¥è©¢ | âŒ 500 Error | âœ… 200 OK |
| éŒ¯èª¤ä¿¡æ¯ | `"infinite recursion..."` | âœ… ç„¡éŒ¯èª¤ |
| é é¢é¡¯ç¤º | âŒ é¡¯ç¤ºéŒ¯èª¤ | âœ… æ­£å¸¸é¡¯ç¤ºæ•¸æ“š |
| éŸ¿æ‡‰æ™‚é–“ | N/Aï¼ˆå¤±æ•—ï¼‰ | âœ… 4ms |
| å‡½æ•¸ | âŒ ä¸å­˜åœ¨ | âœ… 2 å€‹ SECURITY DEFINER å‡½æ•¸ |
| ç­–ç•¥ | âŒ æœ‰éæ­¸å•é¡Œ | âœ… ä½¿ç”¨ SECURITY DEFINER å‡½æ•¸ |

---

## ğŸ“š ç›¸é—œæ–‡æª”

### å‰µå»ºçš„æ–‡æª”

1. **`docs/Supabase-RLSéæ­¸å•é¡Œè™•ç†æ–¹æ³•.md`**
   - Supabase å®˜æ–¹è™•ç† RLS éæ­¸å•é¡Œçš„æ–¹æ³•
   - åŒ…å«å®Œæ•´çš„å¯¦æ–½æ­¥é©Ÿå’Œç¤ºä¾‹

2. **`docs/å·¥ä½œç¸½çµ-ä¿®å¾©å¤±æ•—åŸå› åˆ†æ-2025-01-15.md`**
   - åˆ†æç‚ºä»€éº¼ç¬¬ä¸€æ¬¡ä¿®å¾©æœƒå¤±æ•—ï¼ˆè¢«å¾©åŸäº†ï¼‰
   - èªªæ˜å•é¡Œæ ¹æºå’Œè§£æ±ºæ–¹æ¡ˆ

3. **`docs/å·¥ä½œç¸½çµ-accounts-RLSä¿®å¾©å®Œæˆ-2025-01-15.md`**
   - è©³ç´°çš„ä¿®å¾©éç¨‹å’Œé©—è­‰çµæœ

4. **`docs/å·¥ä½œç¸½çµ-æœ€çµ‚é©—è­‰-accounts-RLSä¿®å¾©-2025-01-15.md`**
   - ä½¿ç”¨ MCP å·¥å…·çš„æœ€çµ‚é©—è­‰çµæœ

5. **`docs/å·¥ä½œç¸½çµ-å®Œæ•´æµç¨‹-accounts-RLSä¿®å¾©-2025-01-15.md`**
   - å®Œæ•´çš„ä¿®å¾©æµç¨‹ç¸½çµ

### æ›´æ–°çš„æ–‡æª”

1. **`docs/fyi.md`**
   - æ·»åŠ  accounts è¡¨ RLS éæ­¸å•é¡Œä¿®å¾©è¨˜éŒ„

2. **`docs/fyi-history.md`**
   - æ·»åŠ è©³ç´°çš„æ­·å²è¨˜éŒ„

3. **`docs/fyi-development.md`**
   - æ·»åŠ æŠ€è¡“æ±ºç­–è¨˜éŒ„

### åƒè€ƒè³‡æº

- [Supabase RLS æ–‡æª”](https://supabase.com/docs/guides/database/postgres/row-level-security)
- [SECURITY DEFINER å‡½æ•¸èªªæ˜](https://supabase.com/docs/guides/database/postgres/row-level-security#use-security-definer-functions)
- [RLS æ€§èƒ½æœ€ä½³å¯¦è¸](https://github.com/orgs/supabase/discussions/14576)

---

## ğŸ¯ æœ€çµ‚çµè«–

**accounts è¡¨ RLS éæ­¸å•é¡Œå·²å®Œå…¨ä¿®å¾©ä¸¦é©—è­‰é€šéï¼**

### æˆåŠŸé …ç›®

1. âœ… **ä¿®å¾©æˆåŠŸ**ï¼šä½¿ç”¨ Supabase å®˜æ–¹æ¨è–¦çš„ SECURITY DEFINER å‡½æ•¸æ–¹æ³•
2. âœ… **æŸ¥è©¢æ­£å¸¸**ï¼šaccounts è¡¨æŸ¥è©¢è¿”å› 200 OK
3. âœ… **æ•¸æ“šæ­£ç¢º**ï¼šæˆåŠŸè¿”å›ç”¨æˆ¶çš„ account è¨˜éŒ„
4. âœ… **é é¢æ­£å¸¸**ï¼šaccount åˆ—è¡¨é é¢æ­£å¸¸é¡¯ç¤º
5. âœ… **æ€§èƒ½è‰¯å¥½**ï¼šæŸ¥è©¢éŸ¿æ‡‰æ™‚é–“ 4ms
6. âœ… **æ¬Šé™æ§åˆ¶**ï¼šRLS ç­–ç•¥æ­£å¸¸å·¥ä½œï¼Œæ¬Šé™æ§åˆ¶é‚è¼¯ä¿æŒä¸è®Š

### ç¶“é©—ç¸½çµ

1. **å•é¡Œè¨ºæ–·**ï¼šæ­£ç¢ºè­˜åˆ¥å•é¡Œæ ¹æºï¼ˆRLS ç­–ç•¥éæ­¸ï¼‰
2. **è§£æ±ºæ–¹æ¡ˆ**ï¼šåƒè€ƒå®˜æ–¹æ–‡æª”ï¼Œä½¿ç”¨æ¨™æº–è§£æ±ºæ–¹æ¡ˆ
3. **é©—è­‰æ–¹æ³•**ï¼šä½¿ç”¨ MCP å·¥å…·é€²è¡Œç«¯åˆ°ç«¯é©—è­‰
4. **æ–‡æª”è¨˜éŒ„**ï¼šå®Œæ•´è¨˜éŒ„å•é¡Œã€è§£æ±ºæ–¹æ¡ˆå’Œé©—è­‰éç¨‹

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-01-15  
**ç¶­è­·è€…**ï¼šé–‹ç™¼åœ˜éšŠ


