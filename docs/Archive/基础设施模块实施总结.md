# åŸºç¡€è®¾æ–½æ¨¡å—å®æ–½æ€»ç»“

> **æ—¥æœŸ**ï¼š2025-01-15  
> **ç›®æ ‡**ï¼šå»ºç«‹æ•°æ®è®¿é—®å±‚åŸºç¡€è®¾æ–½ï¼Œä¸ºåç»­ä¸šåŠ¡å¼€å‘æä¾›åšå®åŸºç¡€

---

## ğŸ“‹ å®æ–½æ¦‚è¿°

æœ¬æ¬¡å®æ–½å»ºç«‹äº†å®Œæ•´çš„æ•°æ®è®¿é—®å±‚åŸºç¡€è®¾æ–½ï¼Œé‡‡ç”¨ Repository æ¨¡å¼ï¼Œæä¾›ç±»å‹å®‰å…¨ã€ç»Ÿä¸€é”™è¯¯å¤„ç†ã€è‡ªåŠ¨æ•°æ®è½¬æ¢ç­‰åŠŸèƒ½ã€‚éµå¾ª"å…ˆåšåŸºç¡€ã€æ–¹ä¾¿æ‰©å±•ã€å¼€å‘å¹³é¡ºã€é¿å…é”™è¯¯"çš„åŸåˆ™ã€‚

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. TypeScript ç±»å‹å®šä¹‰ç”Ÿæˆ

**æ–‡ä»¶**ï¼š`src/app/core/infra/types/database.types.ts`

- âœ… ä½¿ç”¨ Supabase MCP å·¥å…·ç”Ÿæˆå®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- âœ… åŒ…å«æ‰€æœ‰ 51 å¼ è¡¨çš„ç±»å‹å®šä¹‰ï¼ˆRowã€Insertã€Updateï¼‰
- âœ… åŒ…å«ç±»å‹è¾…åŠ©å·¥å…·ï¼ˆTablesã€TablesInsertã€TablesUpdateã€Enumsï¼‰
- âœ… æ–‡ä»¶å¤§å°ï¼š2977 è¡Œ

**ä½¿ç”¨æ–¹å¼**ï¼š
```typescript
import { Database, Tables } from '@core/infra';

type Blueprint = Tables<'blueprints'>;
type BlueprintInsert = TablesInsert<'blueprints'>;
type BlueprintUpdate = TablesUpdate<'blueprints'>;
```

---

### 2. ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶

**æ–‡ä»¶**ï¼š
- `src/app/core/infra/errors/error.types.ts`
- `src/app/core/infra/errors/supabase-error.transformer.ts`

**åŠŸèƒ½**ï¼š
- âœ… å®šä¹‰ç»Ÿä¸€çš„é”™è¯¯ç±»å‹ï¼ˆAppErrorï¼‰
- âœ… é”™è¯¯åˆ†ç±»ï¼šhttpã€networkã€validationã€businessã€permissionã€unknown
- âœ… é”™è¯¯ä¸¥é‡ç¨‹åº¦ï¼šcriticalã€errorã€warningã€info
- âœ… Supabase é”™è¯¯è‡ªåŠ¨è½¬æ¢ä¸ºå‹å¥½çš„åº”ç”¨é”™è¯¯
- âœ… æ”¯æŒé”™è¯¯ä»£ç æ˜ å°„å’Œè¯¦ç»†ä¿¡æ¯

**ä½¿ç”¨æ–¹å¼**ï¼š
```typescript
import { transformSupabaseError, handleSupabaseResponse } from '@core/infra/errors';

// è‡ªåŠ¨è½¬æ¢é”™è¯¯
const data = handleSupabaseResponse(response, 'MyService');
```

---

### 3. æ•°æ®è½¬æ¢å·¥å…·

**æ–‡ä»¶**ï¼š`src/app/core/infra/utils/transformers.ts`

**åŠŸèƒ½**ï¼š
- âœ… snake_case â†” camelCase è‡ªåŠ¨è½¬æ¢
- âœ… æ”¯æŒåµŒå¥—å¯¹è±¡è½¬æ¢
- âœ… æ”¯æŒæ•°ç»„è½¬æ¢
- âœ… é€’å½’å¤„ç†å¤æ‚æ•°æ®ç»“æ„

**ä½¿ç”¨æ–¹å¼**ï¼š
```typescript
import { toCamelCaseData, toSnakeCaseData } from '@core/infra/utils';

// æ•°æ®åº“æ•°æ® â†’ åº”ç”¨æ•°æ®
const appData = toCamelCaseData(dbData);

// åº”ç”¨æ•°æ® â†’ æ•°æ®åº“æ•°æ®
const dbData = toSnakeCaseData(appData);
```

**æ³¨æ„**ï¼šBaseRepository ä¼šè‡ªåŠ¨å¤„ç†è½¬æ¢ï¼Œé€šå¸¸æ— éœ€æ‰‹åŠ¨è°ƒç”¨ã€‚

---

### 4. åŸºç¡€ Repository ç±»

**æ–‡ä»¶**ï¼š`src/app/core/infra/repositories/base.repository.ts`

**åŠŸèƒ½**ï¼š
- âœ… é€šç”¨ CRUD æ“ä½œï¼ˆfindAllã€findByIdã€createã€updateã€deleteï¼‰
- âœ… åˆ†é¡µæŸ¥è¯¢ï¼ˆfindPaginatedï¼‰
- âœ… æ”¯æŒç­›é€‰ã€æ’åºã€åˆ†é¡µ
- âœ… è‡ªåŠ¨æ•°æ®è½¬æ¢ï¼ˆsnake_case â†” camelCaseï¼‰
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
- âœ… ç±»å‹å®‰å…¨ï¼ˆæ³›å‹æ”¯æŒï¼‰
- âœ… è¿”å› Observableï¼ˆä¸ç°æœ‰ä»£ç é£æ ¼ä¸€è‡´ï¼‰

**å¯ç”¨æ–¹æ³•**ï¼š
```typescript
abstract class BaseRepository<T, TInsert, TUpdate> {
  findAll(options?: QueryOptions): Observable<T[]>;
  findById(id: string): Observable<T | null>;
  create(data: TInsert): Observable<T>;
  update(id: string, data: TUpdate): Observable<T>;
  delete(id: string): Observable<void>;
  findPaginated(options: QueryOptions & { page: number; pageSize: number }): Observable<PaginatedResult<T>>;
}
```

---

### 5. BlueprintRepository ç¤ºä¾‹

**æ–‡ä»¶**ï¼š`src/app/core/infra/repositories/blueprint.repository.ts`

**åŠŸèƒ½**ï¼š
- âœ… ç»§æ‰¿ BaseRepository
- âœ… å®ç°è“å›¾ç‰¹å®šçš„æŸ¥è¯¢æ–¹æ³•
- âœ… ä½œä¸ºå…¶ä»– Repository çš„å‚è€ƒå®ç°

**ç¤ºä¾‹æ–¹æ³•**ï¼š
```typescript
findByOwnerId(ownerId: string, options?: QueryOptions): Observable<Blueprint[]>;
findByStatus(status: string, options?: QueryOptions): Observable<Blueprint[]>;
findByProjectCode(projectCode: string): Observable<Blueprint | null>;
findActive(options?: QueryOptions): Observable<Blueprint[]>;
```

---

### 6. æ¨¡å—å¯¼å‡ºå’Œç´¢å¼•

**æ–‡ä»¶**ï¼š
- `src/app/core/infra/index.ts` - ç»Ÿä¸€å¯¼å‡º
- `src/app/core/infra/repositories/index.ts`
- `src/app/core/infra/types/index.ts`
- `src/app/core/infra/errors/index.ts`
- `src/app/core/infra/utils/index.ts`
- `src/app/core/index.ts` - æ›´æ–°å¯¼å‡º

**ä½¿ç”¨æ–¹å¼**ï¼š
```typescript
import { 
  BaseRepository, 
  BlueprintRepository,
  Database,
  Tables,
  AppError,
  toCamelCaseData,
  toSnakeCaseData
} from '@core/infra';
```

---

### 7. æ–‡æ¡£ç¼–å†™

**æ–‡ä»¶**ï¼š
- `src/app/core/infra/README.md` - å®Œæ•´ä½¿ç”¨æŒ‡å—
- `src/app/core/infra/QUICK_START.md` - å¿«é€Ÿå¼€å§‹æŒ‡å—
- `src/app/core/README.md` - æ›´æ–° Core æ¨¡å—è¯´æ˜

**å†…å®¹**ï¼š
- âœ… æ¨¡å—ç»“æ„è¯´æ˜
- âœ… æ ¸å¿ƒåŠŸèƒ½è¯´æ˜
- âœ… ä½¿ç”¨ç¤ºä¾‹
- âœ… æ‰©å±•æ–¹å¼
- âœ… é”™è¯¯é¢„é˜²æœºåˆ¶
- âœ… æ³¨æ„äº‹é¡¹

---

## ğŸ—ï¸ æ–‡ä»¶ç»“æ„

```
src/app/core/infra/
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ database.types.ts      âœ… (2977 è¡Œï¼Œ51 å¼ è¡¨ç±»å‹å®šä¹‰)
â”‚   â””â”€â”€ index.ts               âœ…
â”œâ”€â”€ repositories/
â”‚   â”œâ”€â”€ base.repository.ts     âœ… (261 è¡Œï¼ŒåŸºç¡€ Repository ç±»)
â”‚   â”œâ”€â”€ blueprint.repository.ts âœ… (102 è¡Œï¼Œç¤ºä¾‹ Repository)
â”‚   â””â”€â”€ index.ts               âœ…
â”œâ”€â”€ errors/
â”‚   â”œâ”€â”€ error.types.ts         âœ… (é”™è¯¯ç±»å‹å®šä¹‰)
â”‚   â”œâ”€â”€ supabase-error.transformer.ts âœ… (é”™è¯¯è½¬æ¢å·¥å…·)
â”‚   â””â”€â”€ index.ts               âœ…
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ transformers.ts        âœ… (æ•°æ®è½¬æ¢å·¥å…·)
â”‚   â””â”€â”€ index.ts               âœ…
â”œâ”€â”€ index.ts                   âœ… (ç»Ÿä¸€å¯¼å‡º)
â”œâ”€â”€ README.md                  âœ… (å®Œæ•´ä½¿ç”¨æŒ‡å—)
â””â”€â”€ QUICK_START.md             âœ… (å¿«é€Ÿå¼€å§‹æŒ‡å—)
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ç±»å‹å®‰å…¨

- âœ… æ‰€æœ‰æ–¹æ³•éƒ½æœ‰å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- âœ… æ•°æ®åº“ç±»å‹ä¸ TypeScript ç±»å‹è‡ªåŠ¨åŒæ­¥
- âœ… ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
- âœ… ä½¿ç”¨æ³›å‹ç¡®ä¿ç±»å‹å®‰å…¨

### é”™è¯¯å¤„ç†

- âœ… ç»Ÿä¸€çš„é”™è¯¯è½¬æ¢æœºåˆ¶
- âœ… å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
- âœ… é”™è¯¯åˆ†ç±»å’Œä¸¥é‡ç¨‹åº¦æ ‡è®°
- âœ… æ”¯æŒé”™è¯¯ä»£ç æ˜ å°„

### æ•°æ®è½¬æ¢

- âœ… è‡ªåŠ¨å¤„ç†å­—æ®µåè½¬æ¢ï¼ˆsnake_case â†” camelCaseï¼‰
- âœ… æ”¯æŒåµŒå¥—å¯¹è±¡è½¬æ¢
- âœ… æ”¯æŒæ•°ç»„è½¬æ¢
- âœ… é€’å½’å¤„ç†å¤æ‚æ•°æ®ç»“æ„

### ä»£ç é£æ ¼

- âœ… ä½¿ç”¨ `inject()` è¿›è¡Œä¾èµ–æ³¨å…¥ï¼ˆAngular 20 é£æ ¼ï¼‰
- âœ… è¿”å› Observableï¼ˆä¸ç°æœ‰ä»£ç é£æ ¼ä¸€è‡´ï¼‰
- âœ… ä½¿ç”¨ RxJS æ“ä½œç¬¦å¤„ç†å¼‚æ­¥æ“ä½œ
- âœ… éµå¾ªé¡¹ç›®ä»£ç è§„èŒƒ

---

## ğŸš€ ä½¿ç”¨æ–¹å¼

### åˆ›å»ºæ–°çš„ Repository

åªéœ€ä¸‰æ­¥ï¼š

```typescript
// 1. å®šä¹‰ç±»å‹
import { Database } from '@core/infra/types';

type Task = Database['public']['Tables']['tasks']['Row'];
type TaskInsert = Database['public']['Tables']['tasks']['Insert'];
type TaskUpdate = Database['public']['Tables']['tasks']['Update'];

// 2. ç»§æ‰¿ BaseRepository
import { BaseRepository } from '@core/infra';

@Injectable({ providedIn: 'root' })
export class TaskRepository extends BaseRepository<Task, TaskInsert, TaskUpdate> {
  protected tableName = 'tasks';

  // 3. å¯é€‰ï¼šæ·»åŠ ç‰¹å®šæŸ¥è¯¢æ–¹æ³•
  findByBlueprintId(blueprintId: string): Observable<Task[]> {
    return this.findAll({
      filters: { blueprintId } // è‡ªåŠ¨è½¬æ¢ä¸º blueprint_id
    });
  }
}
```

### åœ¨ Service ä¸­ä½¿ç”¨

```typescript
import { Injectable, inject } from '@angular/core';
import { BlueprintRepository } from '@core/infra';

@Injectable({ providedIn: 'root' })
export class BlueprintService {
  private readonly blueprintRepo = inject(BlueprintRepository);

  getUserBlueprints(userId: string): Observable<Blueprint[]> {
    return this.blueprintRepo.findByOwnerId(userId);
  }
}
```

---

## ğŸ›¡ï¸ é”™è¯¯é¢„é˜²æœºåˆ¶

### 1. ç±»å‹å®‰å…¨

- âœ… ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- âœ… æ•°æ®åº“ç±»å‹ä¸ TypeScript ç±»å‹è‡ªåŠ¨åŒæ­¥
- âœ… æ³›å‹ç¡®ä¿ç±»å‹å®‰å…¨

### 2. ç»Ÿä¸€é”™è¯¯å¤„ç†

- âœ… è‡ªåŠ¨è½¬æ¢ Supabase é”™è¯¯ä¸ºå‹å¥½çš„åº”ç”¨é”™è¯¯
- âœ… é”™è¯¯åˆ†ç±»å’Œä¸¥é‡ç¨‹åº¦æ ‡è®°
- âœ… ç»Ÿä¸€çš„é”™è¯¯æ¶ˆæ¯æ ¼å¼

### 3. è‡ªåŠ¨æ•°æ®è½¬æ¢

- âœ… è‡ªåŠ¨å¤„ç†å­—æ®µåè½¬æ¢
- âœ… æ— éœ€æ‰‹åŠ¨è½¬æ¢ï¼Œå‡å°‘é”™è¯¯

---

## ğŸ“Š æ„å»ºéªŒè¯

### æ„å»ºç»“æœ

- âœ… **æ„å»ºçŠ¶æ€**ï¼šæˆåŠŸ
- âœ… **ç¼–è¯‘æ—¶é—´**ï¼šçº¦ 10.9 ç§’
- âœ… **é”™è¯¯æ•°é‡**ï¼š0
- âœ… **è­¦å‘Šæ•°é‡**ï¼š1ï¼ˆbundle å¤§å°è¶…è¿‡é¢„ç®—ï¼Œå¯æ¥å—ï¼‰
- âœ… **åˆå§‹ bundle å¤§å°**ï¼š3.44 MB

### ä¿®å¤çš„é—®é¢˜

1. âœ… ä¿®å¤äº† `token?.user` è®¿é—®é—®é¢˜ï¼ˆæ”¹ä¸º `token?.['user']`ï¼‰
2. âœ… ä¿®å¤äº† `from` å¯¼å…¥ç¼ºå¤±é—®é¢˜
3. âœ… ä¿®å¤äº† Repository ä¸­çš„ç±»å‹æ–­è¨€é—®é¢˜
4. âœ… ä¿®å¤äº† `shared/models/index.ts` å’Œ `shared/services/index.ts` çš„ç©ºæ¨¡å—é—®é¢˜

---

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. å…ˆåšåŸºç¡€

- âœ… åªæä¾›å¿…è¦çš„é€šç”¨åŠŸèƒ½
- âœ… ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
- âœ… ä¿æŒç®€å•

### 2. æ–¹ä¾¿æ‰©å±•

- âœ… é€šè¿‡ç»§æ‰¿ BaseRepository è½»æ¾æ·»åŠ æ–° Repository
- âœ… ä¸‰æ­¥å®Œæˆï¼šå®šä¹‰ç±»å‹ â†’ ç»§æ‰¿ç±» â†’ è®¾ç½®è¡¨å
- âœ… å¯ä»¥æ·»åŠ ç‰¹å®šæŸ¥è¯¢æ–¹æ³•

### 3. å¼€å‘å¹³é¡º

- âœ… è‡ªåŠ¨å¤„ç†æ•°æ®è½¬æ¢
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
- âœ… ç±»å‹å®‰å…¨ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯

### 4. é¿å…é”™è¯¯

- âœ… ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… è‡ªåŠ¨æ•°æ®è½¬æ¢ï¼Œå‡å°‘æ‰‹åŠ¨é”™è¯¯

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´ä½¿ç”¨æŒ‡å—](../src/app/core/infra/README.md)
- [å¿«é€Ÿå¼€å§‹æŒ‡å—](../src/app/core/infra/QUICK_START.md)
- [Core æ¨¡å—è¯´æ˜](../src/app/core/README.md)
- [API è®¾è®¡è§„èŒƒ](../.cursor/rules/api-design.mdc)
- [é”™è¯¯å¤„ç†è§„èŒƒ](../.cursor/rules/error-handling.mdc)

---

## ğŸ”„ æœªæ¥æ‰©å±•

### æ·»åŠ æ–°çš„ Repository

åªéœ€ä¸‰æ­¥ï¼š
1. åˆ›å»ºæ–°æ–‡ä»¶ï¼ˆå¦‚ `task.repository.ts`ï¼‰
2. ç»§æ‰¿ `BaseRepository`
3. è®¾ç½® `tableName` å’Œæ·»åŠ ç‰¹å®šæ–¹æ³•ï¼ˆå¯é€‰ï¼‰

### æ‰©å±• BaseRepository

å¦‚æœéœ€è¦æ·»åŠ æ–°çš„é€šç”¨åŠŸèƒ½ï¼š
1. åœ¨ `BaseRepository` ä¸­æ·»åŠ æ–°æ–¹æ³•
2. æ‰€æœ‰å­ç±»è‡ªåŠ¨è·å¾—æ–°åŠŸèƒ½

### æ·»åŠ æ–°çš„é”™è¯¯ç±»å‹

1. åœ¨ `error.types.ts` ä¸­æ·»åŠ æ–°ç±»å‹
2. åœ¨ `supabase-error.transformer.ts` ä¸­æ·»åŠ è½¬æ¢é€»è¾‘

---

## âœ… å®ŒæˆçŠ¶æ€

- âœ… TypeScript ç±»å‹å®šä¹‰ï¼ˆ51 å¼ è¡¨ï¼‰
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… æ•°æ®è½¬æ¢å·¥å…·
- âœ… åŸºç¡€ Repository ç±»
- âœ… BlueprintRepository ç¤ºä¾‹
- âœ… æ¨¡å—å¯¼å‡ºå’Œç´¢å¼•
- âœ… æ–‡æ¡£ç¼–å†™
- âœ… æ„å»ºéªŒè¯é€šè¿‡

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **è¡¨åä½¿ç”¨ snake_case** - æ•°æ®åº“è¡¨åå¿…é¡»ä½¿ç”¨ snake_case
2. **ç±»å‹ä» Database æå–** - ä½¿ç”¨ `Database['public']['Tables']['table_name']['Row']` æå–ç±»å‹
3. **è‡ªåŠ¨è½¬æ¢** - å­—æ®µåä¼šè‡ªåŠ¨è½¬æ¢ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†
4. **é”™è¯¯å¤„ç†** - æ‰€æœ‰é”™è¯¯éƒ½ä¼šè‡ªåŠ¨è½¬æ¢ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†

---

**æœ€åæ›´æ–°**ï¼š2025-01-15  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ

