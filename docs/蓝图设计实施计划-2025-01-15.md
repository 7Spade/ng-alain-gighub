# 蓝图设计实施计划

**日期**：2025-01-15  
**目标**：支持个人和组织蓝图，确保开发平顺

---

## 📊 当前状态分析

### 数据库状态

- ✅ **无现有蓝图数据**：数据库中没有蓝图记录，可以安全修改约束
- ❌ **约束限制**：`chk_owner_is_org` 只允许 Organization 作为拥有者
- ❌ **RLS 策略限制**：INSERT 策略只允许组织创建蓝图
- ✅ **SELECT 策略**：已支持用户查看自己拥有的蓝图（通过 `auth_user_id` 匹配）

### 代码状态

- ✅ **Repository 层**：已支持 `owner_id`，无需修改
- ✅ **Service 层**：已支持 `owner_id`，无需修改
- ❌ **UI 层**：需要大幅改进（添加选择器、显示账户信息）
- ⚠️ **权限检查**：需要更新以支持个人和组织

### 依赖关系

- ⚠️ **分支系统**：`blueprint_branches` 要求 `organization_id` 必须是 Organization
- ⚠️ **协作系统**：`organization_collaborations` 用于组织间协作
- ⚠️ **权限系统**：`PermissionService` 需要更新以支持个人蓝图

---

## 🎯 实施目标

### 核心目标

1. **支持个人蓝图**：用户可以直接创建个人蓝图
2. **支持组织蓝图**：组织成员可以创建组织蓝图
3. **向后兼容**：现有组织蓝图功能不受影响
4. **用户体验**：提供直观的拥有者选择器

### 功能范围

#### 阶段 1：基础支持（MVP）
- ✅ 移除数据库约束
- ✅ 更新 RLS 策略
- ✅ 改进创建表单（添加选择器）
- ✅ 改进列表显示（显示拥有者信息）

#### 阶段 2：完整功能
- ⏳ 个人蓝图权限管理
- ⏳ 个人蓝图是否可以 Fork（需要明确）
- ⏳ 拥有者转移功能
- ⏳ 过滤和搜索功能

#### 阶段 3：高级功能（未来）
- ⏳ 个人蓝图协作功能
- ⏳ 蓝图模板功能
- ⏳ 批量操作功能

---

## 📋 分阶段实施计划

### 阶段 1：基础支持（MVP）- 优先级最高

#### 1.1 数据库层修改

**任务 1.1.1：移除约束**
- 移除 `chk_owner_is_org` 约束
- 验证不影响现有数据（当前无数据）

**任务 1.1.2：更新 RLS 策略**
- 更新 INSERT 策略，支持个人和组织创建
- 验证 SELECT/UPDATE/DELETE 策略支持个人和组织
- 测试权限控制

**风险评估**：
- ⚠️ **低风险**：当前无蓝图数据，不会影响现有功能
- ⚠️ **需要验证**：确保 RLS 策略正确工作

**回滚方案**：
- 保留约束删除的 SQL 脚本
- 可以快速恢复约束

---

#### 1.2 前端表单改进

**任务 1.2.1：添加拥有者选择器**
- 创建账户选择器组件
- 显示用户账户和所属组织
- 支持切换个人/组织

**任务 1.2.2：自动填充默认值**
- 个人用户默认选择个人账户
- 组织成员默认选择组织（如果只有一个）
- 多个组织时显示选择器

**任务 1.2.3：表单验证**
- 验证选择的账户存在
- 验证用户有权限使用该账户
- 显示友好的错误提示

**技术实现**：
```typescript
// 需要注入 AccountService
accountService = inject(AccountService);

// 获取用户账户
userAccount = computed(() => 
  accountService.userAccounts().find(a => a.authUserId === currentUserId)
);

// 获取用户所属组织
userOrganizations = computed(() => 
  accountService.organizationAccounts()
);

// 默认值逻辑
if (userAccount()) {
  // 默认选择个人账户
  defaultOwnerId = userAccount()!.id;
} else if (userOrganizations().length === 1) {
  // 只有一个组织，默认选择组织
  defaultOwnerId = userOrganizations()[0].id;
}
```

**风险评估**：
- ⚠️ **低风险**：只是 UI 改进，不影响现有功能
- ⚠️ **需要测试**：确保选择器正确工作

---

#### 1.3 列表和详情页改进

**任务 1.3.1：显示拥有者信息**
- 查询拥有者账户信息
- 显示账户名称和类型
- 添加账户类型标签（个人/组织）

**任务 1.3.2：改进列表显示**
- 替换 UUID 为账户名称
- 添加账户类型列
- 添加拥有者类型图标

**技术实现**：
```typescript
// 在 BlueprintService 中添加方法
async loadBlueprintsWithOwners(): Promise<BlueprintWithOwner[]> {
  const blueprints = await this.loadBlueprints();
  const ownerIds = [...new Set(blueprints.map(b => b.owner_id))];
  const accounts = await this.accountService.loadAccountsByIds(ownerIds);
  
  return blueprints.map(b => ({
    ...b,
    owner: accounts.find(a => a.id === b.owner_id)
  }));
}
```

**风险评估**：
- ⚠️ **低风险**：只是显示改进，不影响功能
- ⚠️ **性能考虑**：需要批量查询账户信息

---

### 阶段 2：权限和功能完善

#### 2.1 权限系统更新

**任务 2.1.1：更新 PermissionService**
- 更新 `canModifyTaskStructure` 支持个人和组织
- 更新 `canAccessBlueprint` 支持个人蓝图
- 添加个人蓝图权限检查

**任务 2.1.2：更新 RLS 策略**
- 确保所有 RLS 策略支持个人和组织
- 测试权限边界情况

**风险评估**：
- ⚠️ **中风险**：权限系统是关键功能，需要仔细测试
- ⚠️ **需要验证**：确保权限检查正确工作

---

#### 2.2 个人蓝图功能明确

**任务 2.2.1：明确个人蓝图是否可以 Fork**
- **选项 A**：个人蓝图可以 Fork 给组织
  - 需要更新 `blueprint_branches` 约束
  - 需要更新 Fork 逻辑
- **选项 B**：个人蓝图不能 Fork（推荐）
  - 保持现有约束
  - 简化实现

**推荐方案**：选项 B（个人蓝图不能 Fork）
- **理由**：
  - 个人蓝图通常是个人项目
  - Fork 功能主要用于组织间协作
  - 简化实现，降低复杂度

**任务 2.2.2：明确个人蓝图协作方式**
- 个人蓝图是否可以邀请组织协作？
- 个人蓝图是否可以转移给组织？

**推荐方案**：
- 个人蓝图可以转移给组织
- 个人蓝图可以邀请组织协作（通过 `organization_collaborations`）

---

#### 2.3 拥有者转移功能

**任务 2.3.1：实现转移功能**
- 添加转移蓝图拥有者的方法
- 验证转移权限
- 更新相关数据（分支、协作关系等）

**任务 2.3.2：转移后权限处理**
- 原拥有者权限如何处理？
- 新拥有者权限如何设置？

**风险评估**：
- ⚠️ **中风险**：转移功能涉及多个表，需要事务处理
- ⚠️ **需要测试**：确保转移后数据一致性

---

### 阶段 3：高级功能（未来）

#### 3.1 过滤和搜索功能

**任务 3.1.1：添加过滤选项**
- 按拥有者类型过滤（个人/组织）
- 按拥有者过滤（我拥有的/我参与的）
- 按状态过滤

**任务 3.1.2：添加搜索功能**
- 按拥有者名称搜索
- 按项目代码搜索
- 按项目名称搜索

---

## 🔧 技术实施细节

### 数据库迁移脚本

```sql
-- 1. 移除约束
ALTER TABLE blueprints DROP CONSTRAINT IF EXISTS chk_owner_is_org;

-- 2. 更新 RLS INSERT 策略
DROP POLICY IF EXISTS "Organizations can create blueprints" ON blueprints;

CREATE POLICY "Users and organizations can create blueprints"
ON blueprints FOR INSERT
TO authenticated
WITH CHECK (
  -- 用户创建个人蓝图（owner_id = 用户账户ID）
  (
    owner_id IN (
      SELECT a.id
      FROM accounts a
      WHERE a.auth_user_id = auth.uid()
      AND a.type = 'User'
    )
  )
  OR
  -- 组织成员创建组织蓝图（owner_id = 组织账户ID，且用户是组织成员）
  (
    owner_id IN (
      SELECT a.id
      FROM accounts a
      WHERE a.type = 'Organization'
      AND (
        -- 用户是组织创建者
        a.auth_organization_id = auth.uid()
        OR
        -- 用户是组织成员（通过团队）
        EXISTS (
          SELECT 1
          FROM team_members tm
          JOIN teams t ON tm.team_id = t.id
          JOIN accounts user_account ON tm.account_id = user_account.id
          WHERE t.organization_id = a.id
          AND user_account.auth_user_id = auth.uid()
          AND tm.role = 'leader'
        )
      )
    )
  )
);

-- 3. 验证 SELECT 策略（应该已经支持）
-- 当前策略已经支持用户查看自己拥有的蓝图
```

---

### 前端组件设计

#### 账户选择器组件

```typescript
@Component({
  selector: 'app-account-selector',
  template: `
    <nz-form-item>
      <nz-form-label [nzSpan]="4" nzRequired>拥有者</nz-form-label>
      <nz-form-control [nzSpan]="20">
        <nz-radio-group [(ngModel)]="ownerType" (ngModelChange)="onOwnerTypeChange()">
          <label nz-radio [nzValue]="'user'">个人账户</label>
          <label nz-radio [nzValue]="'organization'">组织账户</label>
        </nz-radio-group>
        
        @if (ownerType === 'user') {
          <nz-select
            [(ngModel)]="selectedAccountId"
            nzPlaceHolder="选择个人账户"
            style="width: 100%; margin-top: 8px;"
          >
            @for (account of userAccounts(); track account.id) {
              <nz-option [nzValue]="account.id" [nzLabel]="account.name"></nz-option>
            }
          </nz-select>
        } @else {
          <nz-select
            [(ngModel)]="selectedAccountId"
            nzPlaceHolder="选择组织账户"
            style="width: 100%; margin-top: 8px;"
          >
            @for (org of organizationAccounts(); track org.id) {
              <nz-option [nzValue]="org.id" [nzLabel]="org.name"></nz-option>
            }
          </nz-select>
        }
      </nz-form-control>
    </nz-form-item>
  `
})
export class AccountSelectorComponent {
  accountService = inject(AccountService);
  
  ownerType = signal<'user' | 'organization'>('user');
  selectedAccountId = signal<string>('');
  
  userAccounts = computed(() => this.accountService.userAccounts());
  organizationAccounts = computed(() => this.accountService.organizationAccounts());
  
  ngOnInit(): void {
    // 设置默认值
    const userAccount = this.userAccounts()[0];
    if (userAccount) {
      this.ownerType.set('user');
      this.selectedAccountId.set(userAccount.id);
    } else if (this.organizationAccounts().length === 1) {
      this.ownerType.set('organization');
      this.selectedAccountId.set(this.organizationAccounts()[0].id);
    }
  }
  
  onOwnerTypeChange(): void {
    // 切换类型时自动选择第一个账户
    if (this.ownerType() === 'user' && this.userAccounts().length > 0) {
      this.selectedAccountId.set(this.userAccounts()[0].id);
    } else if (this.ownerType() === 'organization' && this.organizationAccounts().length > 0) {
      this.selectedAccountId.set(this.organizationAccounts()[0].id);
    }
  }
}
```

---

## ✅ 验证和测试计划

### 单元测试

1. **数据库约束测试**
   - 测试个人账户可以创建蓝图
   - 测试组织账户可以创建蓝图
   - 测试无效账户不能创建蓝图

2. **RLS 策略测试**
   - 测试用户只能创建自己拥有的蓝图
   - 测试组织成员只能创建组织蓝图
   - 测试用户只能查看有权限的蓝图

3. **前端组件测试**
   - 测试选择器正确显示账户
   - 测试默认值正确设置
   - 测试表单验证正确工作

### 集成测试

1. **创建蓝图流程**
   - 个人用户创建个人蓝图
   - 组织成员创建组织蓝图
   - 验证创建后可以正确查看

2. **权限测试**
   - 测试个人蓝图权限
   - 测试组织蓝图权限
   - 测试权限边界情况

### 用户验收测试

1. **功能测试**
   - 创建个人蓝图
   - 创建组织蓝图
   - 查看蓝图列表
   - 查看蓝图详情

2. **用户体验测试**
   - 选择器是否直观
   - 默认值是否合理
   - 错误提示是否友好

---

## 🚨 风险评估和缓解

### 高风险项

1. **RLS 策略错误**
   - **风险**：权限控制错误可能导致数据泄露
   - **缓解**：
     - 仔细测试所有权限场景
     - 使用 Supabase MCP 工具验证策略
     - 分阶段部署，先测试环境

2. **数据一致性**
   - **风险**：转移拥有者时数据不一致
   - **缓解**：
     - 使用数据库事务
     - 添加数据验证
     - 测试边界情况

### 中风险项

1. **性能问题**
   - **风险**：批量查询账户信息可能影响性能
   - **缓解**：
     - 使用批量查询
     - 添加缓存
     - 优化查询语句

2. **向后兼容**
   - **风险**：现有组织蓝图功能受影响
   - **缓解**：
     - 保持现有 RLS 策略逻辑
     - 只添加新的策略条件
     - 充分测试现有功能

---

## 📅 实施时间表

### 阶段 1：基础支持（1-2 天）

- **Day 1 上午**：数据库迁移（约束移除、RLS 更新）
- **Day 1 下午**：前端表单改进（选择器组件）
- **Day 2 上午**：列表和详情页改进
- **Day 2 下午**：测试和修复

### 阶段 2：权限和功能完善（2-3 天）

- **Day 3**：权限系统更新
- **Day 4**：个人蓝图功能明确和实现
- **Day 5**：拥有者转移功能（如果需要）

### 阶段 3：高级功能（未来）

- 根据需求优先级安排

---

## 📝 实施检查清单

### 阶段 1 检查清单

- [ ] 移除数据库约束
- [ ] 更新 RLS INSERT 策略
- [ ] 验证 RLS SELECT/UPDATE/DELETE 策略
- [ ] 创建账户选择器组件
- [ ] 更新创建表单
- [ ] 更新列表显示
- [ ] 更新详情页显示
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 用户验收测试通过

### 阶段 2 检查清单

- [ ] 更新 PermissionService
- [ ] 明确个人蓝图 Fork 规则
- [ ] 实现拥有者转移功能（如果需要）
- [ ] 更新相关文档
- [ ] 完整测试

---

## 🔄 回滚计划

### 如果出现问题

1. **数据库回滚**
   ```sql
   -- 恢复约束
   ALTER TABLE blueprints ADD CONSTRAINT chk_owner_is_org CHECK (
     EXISTS (SELECT 1 FROM accounts WHERE id = owner_id AND type = 'Organization')
   );
   
   -- 恢复 RLS 策略
   DROP POLICY IF EXISTS "Users and organizations can create blueprints" ON blueprints;
   -- 恢复原有策略
   ```

2. **代码回滚**
   - 使用 Git 回滚到之前版本
   - 保留选择器组件代码（可以禁用）

3. **数据清理**
   - 如果创建了个人蓝图，需要手动删除或转移

---

## 📚 相关文档更新

### 需要更新的文档

1. **数据库文档**
   - `docs/30-0-完整SQL表結構定義.md` - 移除约束说明
   - `docs/fyi-rls.md` - 更新 RLS 策略说明

2. **架构文档**
   - `docs/27-完整架構流程圖.mermaid.md` - 确认个人蓝图支持
   - `docs/10-系統架構思維導圖.mermaid.md` - 确认个人蓝图支持

3. **开发文档**
   - `docs/fyi-context.md` - 更新蓝图拥有者说明
   - `docs/fyi-architecture.md` - 更新蓝图系统架构

---

**最后更新**：2025-01-15  
**维护者**：开发团队

