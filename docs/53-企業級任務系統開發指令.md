# 企業級任務系統開發指令

**版本**: 1.0  
**最後更新**: 2025-01-15  
**描述**: 完整的任務系統開發指引，包含文檔清單、工具使用、開發流程和驗證清單

---

## 📚 文檔清單

### 優先級最高：必讀核心文檔

#### 架構設計文檔

##### `docs/27-完整架構流程圖.mermaid.md`
- **描述**: 完整架構流程（Git-like 分支模型、任務執行流程、待辦中心）
- **關鍵點**:
  - Git-like 分支模型
  - 任務執行流程
  - 待辦中心機制

##### `docs/28-架構審查報告.md`
- **描述**: 架構決策與設計原則
- **關鍵點**:
  - 架構決策
  - 設計原則
  - 最佳實踐

##### `docs/30-0-完整SQL表結構定義.md`
- **描述**: 51 張表的完整 SQL 定義
- **關鍵點**:
  - 任務相關表在第 469-703 行
  - 51 張資料表完整定義
  - 資料庫結構規範

#### 資料庫與資料模型

##### `docs/30-資料表清單總覽.md`
- **描述**: 51 張表清單（任務執行系統 9 張表）
- **關鍵點**:
  - 任務執行系統 9 張表
  - 資料表分類統計
  - 關鍵關聯關係

##### `docs/34-資料模型對照表.md`
- **描述**: 資料庫與 TypeScript 模型對照
- **關鍵點**:
  - 資料庫與 TypeScript 對照
  - 模型定義規範
  - 類型安全

#### 業務流程與狀態

##### `docs/14-業務流程圖.mermaid.md`
- **描述**: 任務執行、暫存、品管、驗收流程
- **關鍵點**:
  - 任務執行流程
  - 暫存區機制
  - 品管驗收流程

##### `docs/16-狀態圖.mermaid.md`
- **描述**: 任務狀態流轉圖
- **關鍵點**:
  - 狀態流轉規則
  - 狀態轉換條件
  - 狀態圖視覺化

##### `docs/43-狀態枚舉值定義.md`
- **描述**: 任務狀態定義（8 種狀態）
- **關鍵點**:
  - 8 種任務狀態
  - 狀態枚舉值
  - TypeScript 類型定義

### 優先級高：重要參考文檔

#### 開發規範

- `docs/00-開發作業指引.md` - 開發規範與流程
- `docs/35-開發工作流程.md` - 開發工作流程
- `docs/45-SHARED_IMPORTS-使用指南.md` - 共享模組使用規範

#### 相關系統文檔

- `docs/12-實體關係圖.mermaid.md` - 資料庫 ER 圖
- `docs/13-帳戶層流程圖.mermaid.md` - 帳戶層架構（任務指派涉及帳戶）
- `docs/21-安全與-RLS-權限矩陣.md` - 權限控制（任務權限）

### 優先級中：輔助參考文檔（按需查閱）

- `docs/33-API-接口詳細文檔.md` - API 接口定義
- `docs/37-錯誤處理指南.md` - 錯誤處理規範
- `docs/42-詞彙表.md` - 術語說明

---

## 📖 閱讀順序

### 步驟 1：先讀架構文檔
**目的**: 了解整體架構

- `docs/27-完整架構流程圖.mermaid.md`
- `docs/28-架構審查報告.md`

### 步驟 2：再讀資料庫結構
**目的**: 了解任務相關表結構（第 469-703 行）

- `docs/30-0-完整SQL表結構定義.md`

### 步驟 3：然後了解業務流程
**目的**: 了解業務流程

- `docs/14-業務流程圖.mermaid.md`
- `docs/16-狀態圖.mermaid.md`

### 步驟 4：最後了解開發規範
**目的**: 了解開發規範

- `docs/00-開發作業指引.md`
- `docs/45-SHARED_IMPORTS-使用指南.md`

---

## 🗄️ 任務系統

### 核心表（9 張表）

任務執行系統包含 9 張表：

#### 1. `tasks`
- **描述**: 任務主表（樹狀結構，無層級限制）
- **關鍵欄位**:
  - `id`
  - `blueprint_id`
  - `branch_id`
  - `parent_task_id`
  - `status`
  - `contractor_fields`

#### 2. `task_assignments`
- **描述**: 任務指派表（個人/團隊/組織/承攬）
- **關鍵欄位**:
  - `task_id`
  - `assignee_type`
  - `assignee_id`

#### 3. `task_lists`
- **描述**: 任務列表表（按指派對象分類）
- **關鍵欄位**:
  - `task_id`
  - `assignee_id`
  - `status`

#### 4. `task_staging`
- **描述**: 暫存區表（48 小時可撤回）
- **關鍵欄位**:
  - `task_id`
  - `staging_data`
  - `expires_at`
  - `can_withdraw`

#### 5. `daily_reports`
- **描述**: 施工日誌表（自動同步到主分支）
- **關鍵欄位**:
  - `task_id`
  - `report_date`
  - `work_content`

#### 6. `report_photos`
- **描述**: 報表照片表
- **關鍵欄位**:
  - `daily_report_id`
  - `photo_url`

#### 7. `task_dependencies`
- **描述**: 任務依賴關係表
- **關鍵欄位**:
  - `task_id`
  - `depends_on_task_id`

#### 8. `task_templates`
- **描述**: 任務模板表
- **關鍵欄位**:
  - `template_name`
  - `template_data`

#### 9. `weather_cache`
- **描述**: 天氣快取表
- **關鍵欄位**:
  - `location`
  - `date`
  - `weather_data`

### 待辦中心相關表（2 張表）

#### 1. `personal_todos`
- **描述**: 個人待辦中心表（五種狀態分類）

**狀態分類**:

| 狀態 | 圖示 | 名稱 | 來源 | 備註 |
|------|------|------|------|------|
| `pending` | 🟦 | 待執行 | `task_lists` | - |
| `staging` | 🟨 | 暫存中 | `task_staging` | 48 小時可撤回 |
| `in_qa` | 🟧 | 品管中 | `quality_checks` | - |
| `in_inspection` | 🟥 | 驗收中 | `inspections` | - |
| `open/in_progress` | ⚠️ | 問題追蹤 | `issues` | - |

#### 2. `todo_status_tracking`
- **描述**: 待辦狀態追蹤表
- **關鍵欄位**:
  - `todo_id`
  - `status`
  - `changed_at`

### 狀態流轉

#### 總狀態數：8 種

| 狀態值 | 名稱 | 描述 | 特殊說明 |
|--------|------|------|----------|
| `pending` | 待處理 | 任務已建立但未開始 | - |
| `assigned` | 已指派 | 任務已指派給負責人 | - |
| `in_progress` | 進行中 | 任務正在執行 | - |
| `staging` | 暫存中 | 任務已提交，進入 48 小時暫存區 | **48 小時可撤回機制** |
| `in_qa` | 品管中 | 任務進入品質檢查流程 | - |
| `in_inspection` | 驗收中 | 任務進入驗收流程 | **驗收通過後責任轉移** |
| `completed` | 已完成 | 任務已完成 | - |
| `cancelled` | 已取消 | 任務已取消 | - |

#### 狀態流轉流程

```
pending → assigned → in_progress → staging → in_qa → in_inspection → completed
```

#### 取消規則

可在任何階段取消（`pending`/`assigned`/`in_progress`/`staging`）

#### 關鍵節點

1. **`staging`**: 暫存區，48 小時可撤回機制
2. **`in_inspection`**: 驗收通過後責任轉移

---

## 🛠️ 工具

### AI 輔助工具

#### `@C7` - Context7
- **全名**: Context7
- **描述**: 獲取 Angular 20/ng-alain 最新信息和最佳實踐
- **使用方式**: 在做任何技術決策或修改前，必須以 `@C7` 取得官方資訊
- **使用時機**:
  - 技術決策前
  - 框架版本更新
  - 最佳實踐查詢

#### `@S7` - Sequential Thinking
- **全名**: Sequential Thinking
- **描述**: 複雜問題的系統性分析與拆解
- **使用方式**: 進入任務時依序執行 `@S7` 進行問題拆解
- **使用時機**:
  - 複雜問題分析
  - 架構設計
  - 根因分析

#### `@SPT` - Software Planning Tool
- **全名**: Software Planning Tool
- **描述**: 任務規劃、分解與進度追蹤
- **使用方式**: Level 3+ 任務必須使用 `@SPT` 進行規劃
- **使用時機**:
  - Level 3+ 複雜任務
  - 任務規劃
  - 進度追蹤

#### `@SC7` / `@SSC7` - Context7 + Sequential Thinking
- **全名**: Context7 + Sequential Thinking
- **描述**: 跨模組依賴分析
- **使用方式**: 多模組變更必須先以 `@SC7` 或 `@SSC7` 產生跨模組分析
- **使用時機**:
  - 跨模組重構
  - 共用 Service 調整
  - 資料模型變更

#### `@SUPABASE` - Supabase MCP
- **全名**: Supabase MCP
- **描述**: 資料庫操作與 RLS 驗證
- **使用方式**: 所有資料庫操作必須透過 `@SUPABASE` MCP 工具
- **使用時機**:
  - 資料庫查詢
  - RLS 策略驗證
  - 資料表結構檢查

### 使用指引

- **Level 1-2**: 直接開發
- **Level 3+**: 必須使用 `@S7` + `@SPT` 進行規劃
- **跨模組**: 使用 `@SC7` 或 `@SSC7` 進行依賴分析

---

## 🔄 開發流程

### 步驟 1：建立思考框架

**描述**: 啟用 Sequential Thinking 與 Software Planning Tool

**行動**:
1. 使用 `@S7` 進行任務分析
2. 使用 `@SPT` 進行任務拆解與優先級排序
3. 確保達到企業標準

### 步驟 2：開發推進

#### 2.1 將大任務分解為子任務

#### 2.2 為每個子任務設置優先級與預估時間

#### 2.3 使用 Sequential Thinking 分析任務順序

#### 2.4 如有需要，調用 Context7 或 Supabase MCP 協作

#### 2.5 完成任務後，執行 build 或專案對應 build 指令

#### 2.6 記錄錯誤資訊

---

## ⚠️ 錯誤處理

### 步驟 1：執行構建
執行 `yarn build` 或對應 build 指令

### 步驟 2：記錄錯誤資訊

### 步驟 3：根據錯誤類型採取對應措施

| 錯誤類型 | 處理方式 | 命令 |
|----------|----------|------|
| 類型錯誤 | 執行 `yarn type-check` 並修復 | `yarn type-check` |
| 代碼風格 | 執行 `yarn lint` 並修復 | `yarn lint` |
| 樣式錯誤 | 執行 `yarn lint:style` 並修復 | `yarn lint:style` |
| 構建錯誤 | 檢查 angular.json 配置 | 檢查配置文件 |

### 步驟 4：驗證修復
重新執行構建確保通過

---

## ✅ 驗證清單

### 提交前必須通過

- [ ] `yarn lint` - 代碼檢查無錯誤
- [ ] `yarn type-check` - 類型檢查通過
- [ ] `yarn test` - 單元測試通過
- [ ] `yarn build` - 構建成功
- [ ] 瀏覽器 Console - 無錯誤

### 關鍵檢查項

| 檢查項 | 描述 | 是否必需 |
|--------|------|----------|
| SHARED_IMPORTS | 使用 SHARED_IMPORTS（UI層） | ✅ 是 |
| 分層架構 | 遵循分層架構（routes → shared → core） | ✅ 是 |
| Signals | 使用 Signals 管理狀態 | ✅ 是 |
| OnPush | 使用 OnPush 變更檢測策略 | ✅ 是 |

---

## 💻 命令

### 開發命令

| 命令 | 描述 |
|------|------|
| `yarn start` | 啟動開發服務器 |
| `yarn hmr` | 熱模組替換模式 |

### 檢查命令

| 命令 | 描述 |
|------|------|
| `yarn lint` | 代碼檢查 |
| `yarn type-check` | 類型檢查 |
| `yarn test` | 運行測試 |
| `yarn build` | 構建項目 |

### 修復命令

| 命令 | 描述 |
|------|------|
| `yarn lint --fix` | 自動修復代碼風格 |
| `npx prettier --write "src/**/*.{ts,html,less}"` | 格式化代碼 |

---

## 🏗️ 技術棧

### 版本要求

| 技術 | 版本 |
|------|------|
| Angular | 20.3.x |
| ngZorro | 20.3.x |
| ngAlain | 20.0.x |
| Node.js | >= 20 |
| Yarn | 4.9.2+ |
| TypeScript | strict mode |
| Supabase | 最新版本 |

### 關鍵特性

- Standalone Components
- Signals 狀態管理
- ChangeDetectionStrategy.OnPush
- Typed Forms
- 現代控制流程（`@if`, `@for`, `@switch`）

---

## 🏛️ 架構

### Git-like 分支模型

系統採用 Git-like 分支模型，包含以下組件：

#### 主分支 (`blueprints`)
- **描述**: 擁有者全權控制任務結構

#### 組織分支 (`blueprint_branches`)
- **描述**: 協作組織只能填寫承攬欄位

#### Pull Request
- **描述**: 提交執行數據 → 擁有者審核 → 合併更新

### 資料庫

- **總表數**: 51 張
- **模組數**: 11 個
- **描述**: 系統共包含 51 張資料表，分為 11 個模組

### 核心設計原則

1. **暫存區機制**: 48h 可撤回
2. **待辦中心**: 五種狀態分類
3. **問題同步**: 即時同步至主分支
4. **活動記錄**: 集中記錄
5. **文件管理**: 版本控制、縮圖、軟刪除

---

## 📝 注意事項

### 重要提醒

- ✅ 所有資料庫操作必須透過 `@SUPABASE` MCP 工具
- ✅ UI 層必須使用 SHARED_IMPORTS
- ✅ 遵循分層架構：routes → shared → core
- ✅ 使用 Signals 進行狀態管理
- ✅ 使用 OnPush 變更檢測策略

### 禁止事項

- ❌ 禁止使用 workaround 或臨時解決方案
- ❌ 禁止繞過 PR 機制直接更新主分支數據
- ❌ 禁止協作組織修改任務結構（只能填寫承攬欄位）

---

**最後更新**: 2025-01-15  
**版本**: 1.0

