# éšæ®µ2ã€3å’Œæ•´åˆæ¸¬è©¦å¯¦æ–½è¨ˆåŠƒè©³ç´°èªªæ˜

> **ç›®çš„**ï¼šæä¾›æ¯å€‹ä»»å‹™çš„è©³ç´°å¯¦æ–½ç´°ç¯€ï¼ŒåŒ…æ‹¬æ–‡ä»¶çµæ§‹ã€æ¥å£å®šç¾©ã€å¯¦æ–½æ­¥é©Ÿå’Œé©—æ”¶æ¨™æº–

**æœ€å¾Œæ›´æ–°**ï¼š2025-11-16  
**ç‰ˆæœ¬**ï¼šv1.0

---

## ğŸ“‹ ç›®éŒ„

- [éšæ®µ2ï¼šä»»å‹™åŸ·è¡Œæµç¨‹èˆ‡æš«å­˜å€](#éšæ®µ2ä»»å‹™åŸ·è¡Œæµç¨‹èˆ‡æš«å­˜å€)
  - [2.1 TaskStagingService](#21-taskstagingserviceæš«å­˜å€æ¥­å‹™é‚è¼¯)
  - [2.2 æ“´å±• TaskService](#22-æ“´å±•-taskserviceä»»å‹™ç‹€æ…‹æµè½‰)
  - [2.3 DailyReportService](#23-dailyreportserviceæ–½å·¥æ—¥èªŒ)
  - [2.4 æ•´åˆæš«å­˜å€èˆ‡æ–½å·¥æ—¥èªŒ](#24-æ•´åˆæš«å­˜å€èˆ‡æ–½å·¥æ—¥èªŒ)
  - [2.5 æš«å­˜å€ UI çµ„ä»¶](#25-æš«å­˜å€-ui-çµ„ä»¶)
- [éšæ®µ3ï¼šPRå¯©æ ¸èˆ‡å”ä½œç³»çµ±](#éšæ®µ3prå¯©æ ¸èˆ‡å”ä½œç³»çµ±)
  - [3.1 å®Œå–„ PR å¯©æ ¸æµç¨‹](#31-å®Œå–„-pr-å¯©æ ¸æµç¨‹)
  - [3.2 Realtime é€šçŸ¥ç³»çµ±](#32-realtime-é€šçŸ¥ç³»çµ±)
  - [3.3 å¾…è¾¦ä¸­å¿ƒ](#33-å¾…è¾¦ä¸­å¿ƒpersonaltodoservice)
  - [3.4 PR å¯©æ ¸ UI çµ„ä»¶](#34-pr-å¯©æ ¸-ui-çµ„ä»¶)
- [æ•´åˆæ¸¬è©¦èˆ‡å„ªåŒ–](#æ•´åˆæ¸¬è©¦èˆ‡å„ªåŒ–)
  - [4.1 ç«¯åˆ°ç«¯æµç¨‹æ¸¬è©¦](#41-ç«¯åˆ°ç«¯æµç¨‹æ¸¬è©¦)
  - [4.2 æ€§èƒ½å„ªåŒ–èˆ‡ç›£æ§](#42-æ€§èƒ½å„ªåŒ–èˆ‡ç›£æ§)
  - [4.3 æ–‡æª”æ›´æ–°èˆ‡éƒ¨ç½²æº–å‚™](#43-æ–‡æª”æ›´æ–°èˆ‡éƒ¨ç½²æº–å‚™)

---

## éšæ®µ2ï¼šä»»å‹™åŸ·è¡Œæµç¨‹èˆ‡æš«å­˜å€

### 2.1 TaskStagingServiceï¼ˆæš«å­˜å€æ¥­å‹™é‚è¼¯ï¼‰

#### ğŸ“ æ–‡ä»¶ä½ç½®
- **Service**: `src/app/shared/services/task/task-staging.service.ts`
- **é¡å‹å®šç¾©**: `src/app/shared/models/task/types.ts` (å·²å­˜åœ¨ TaskStaging é¡å‹)
- **Repository**: `src/app/core/infra/repositories/task-staging.repository.ts` (å·²å­˜åœ¨)

#### ğŸ”§ ä¾è³´é—œä¿‚
- `TaskStagingRepository` (å·²å­˜åœ¨)
- `TaskService` (éœ€è¦æ“´å±•)
- `AuthStateService` (ç²å–ç•¶å‰ç”¨æˆ¶)
- `ActivityLogService` (è§¸ç™¼æ´»å‹•è¨˜éŒ„)

#### ğŸ“ æ¥å£å®šç¾©

```typescript
// src/app/shared/services/task/task-staging.service.ts
import { Injectable, inject, signal, computed } from '@angular/core';
import { TaskStagingRepository } from '@core';
import { TaskStaging, TaskStagingInsert, TaskStagingUpdate } from '@shared';
import { AuthStateService } from '@shared';
import { firstValueFrom } from 'rxjs';

@Injectable({ providedIn: 'root' })
export class TaskStagingService {
  private stagingRepository = inject(TaskStagingRepository);
  private authState = inject(AuthStateService);
  
  // Signals for state management
  private stagingState = signal<TaskStaging[]>([]);
  private selectedStagingState = signal<TaskStaging | null>(null);
  private loadingState = signal<boolean>(false);
  private errorState = signal<string | null>(null);
  
  // Expose ReadonlySignals
  readonly staging = this.stagingState.asReadonly();
  readonly selectedStaging = this.selectedStagingState.asReadonly();
  readonly loading = this.loadingState.asReadonly();
  readonly error = this.errorState.asReadonly();
  
  // Computed signals
  readonly withdrawableStaging = computed(() => 
    this.staging().filter(s => 
      s.can_withdraw === true && 
      s.withdrawn_at === null && 
      s.confirmed_at === null &&
      new Date(s.expires_at) > new Date()
    )
  );
  
  readonly expiredStaging = computed(() =>
    this.staging().filter(s =>
      s.confirmed_at === null &&
      s.withdrawn_at === null &&
      new Date(s.expires_at) <= new Date()
    )
  );
}
```

#### ğŸ¯ æ ¸å¿ƒæ–¹æ³•

##### 1. submitToStaging
```typescript
/**
 * æäº¤ä»»å‹™åˆ°æš«å­˜å€
 * 
 * @param taskId ä»»å‹™ ID
 * @param data æš«å­˜æ•¸æ“šï¼ˆåŒ…å« staging_data, photos, notesï¼‰
 * @returns å‰µå»ºçš„æš«å­˜è¨˜éŒ„
 */
async submitToStaging(
  taskId: string, 
  data: {
    stagingData: Record<string, unknown>;
    photos?: Array<{ url: string; caption?: string }>;
    notes?: string;
  }
): Promise<TaskStaging> {
  // 1. ç²å–ç•¶å‰ç”¨æˆ¶
  // 2. è¨ˆç®— expires_at = NOW() + 48 hours
  // 3. å‰µå»ºæš«å­˜è¨˜éŒ„
  // 4. æ›´æ–°æœ¬åœ°ç‹€æ…‹
  // 5. è§¸ç™¼æ´»å‹•è¨˜éŒ„
}
```

##### 2. withdrawStaging
```typescript
/**
 * æ’¤å›æš«å­˜ï¼ˆ48å°æ™‚å…§ï¼‰
 * 
 * @param stagingId æš«å­˜è¨˜éŒ„ ID
 * @returns void
 * @throws Error å¦‚æœå·²éæœŸæˆ–å·²ç¢ºèª
 */
async withdrawStaging(stagingId: string): Promise<void> {
  // 1. æª¢æŸ¥æš«å­˜è¨˜éŒ„æ˜¯å¦å­˜åœ¨
  // 2. æª¢æŸ¥ can_withdraw === true
  // 3. æª¢æŸ¥ expires_at > NOW()
  // 4. æª¢æŸ¥ confirmed_at === null
  // 5. è¨­ç½® withdrawn_at = NOW()
  // 6. æ›´æ–° can_withdraw = false
  // 7. æ›´æ–°æœ¬åœ°ç‹€æ…‹
  // 8. è§¸ç™¼æ´»å‹•è¨˜éŒ„
}
```

##### 3. confirmStaging
```typescript
/**
 * ç¢ºèªæš«å­˜ï¼ˆè½‰ç‚ºæ­£å¼è¨˜éŒ„ï¼‰
 * 
 * @param stagingId æš«å­˜è¨˜éŒ„ ID
 * @returns ç¢ºèªå¾Œçš„æš«å­˜è¨˜éŒ„
 */
async confirmStaging(stagingId: string): Promise<TaskStaging> {
  // 1. æª¢æŸ¥æš«å­˜è¨˜éŒ„æ˜¯å¦å­˜åœ¨
  // 2. æª¢æŸ¥ withdrawn_at === null
  // 3. è¨­ç½® confirmed_at = NOW()
  // 4. è¨­ç½® can_withdraw = false
  // 5. æ›´æ–°æœ¬åœ°ç‹€æ…‹
  // 6. è§¸ç™¼æ´»å‹•è¨˜éŒ„
  // 7. è¿”å›æ›´æ–°å¾Œçš„è¨˜éŒ„
}
```

##### 4. loadStagingByTaskId
```typescript
/**
 * æ ¹æ“šä»»å‹™ ID åŠ è¼‰æš«å­˜è¨˜éŒ„
 * 
 * @param taskId ä»»å‹™ ID
 */
async loadStagingByTaskId(taskId: string): Promise<void> {
  // 1. è¨­ç½® loading = true
  // 2. èª¿ç”¨ Repository.findByTaskId
  // 3. æ›´æ–°æœ¬åœ°ç‹€æ…‹
  // 4. è¨­ç½® loading = false
}
```

##### 5. loadWithdrawableStaging
```typescript
/**
 * åŠ è¼‰å¯æ’¤å›çš„æš«å­˜è¨˜éŒ„ï¼ˆç•¶å‰ç”¨æˆ¶ï¼‰
 */
async loadWithdrawableStaging(): Promise<void> {
  // 1. ç²å–ç•¶å‰ç”¨æˆ¶ ID
  // 2. èª¿ç”¨ Repository.findBySubmittedBy
  // 3. éæ¿¾ can_withdraw === true ä¸” expires_at > NOW()
  // 4. æ›´æ–°æœ¬åœ°ç‹€æ…‹
}
```

#### âœ… é©—æ”¶æ¨™æº–
- [ ] å¯ä»¥æäº¤ä»»å‹™åˆ°æš«å­˜å€
- [ ] 48å°æ™‚å…§å¯ä»¥æ’¤å›
- [ ] 48å°æ™‚å¾Œç„¡æ³•æ’¤å›
- [ ] å¯ä»¥ç¢ºèªæš«å­˜
- [ ] å·²æ’¤å›çš„æš«å­˜ç„¡æ³•ç¢ºèª
- [ ] å·²ç¢ºèªçš„æš«å­˜ç„¡æ³•æ’¤å›
- [ ] ç‹€æ…‹ç®¡ç†ä½¿ç”¨ Signals
- [ ] éŒ¯èª¤è™•ç†å®Œæ•´
- [ ] æ´»å‹•è¨˜éŒ„æ­£ç¢ºè§¸ç™¼

#### âš ï¸ æ³¨æ„äº‹é …
- `expires_at` åœ¨æ•¸æ“šåº«å±¤é¢æœ‰é»˜èªå€¼ï¼Œä½†æ‡‰ç”¨å±¤éœ€è¦æ˜ç¢ºè¨­ç½®
- éœ€è¦è™•ç†æ™‚å€å•é¡Œ
- éœ€è¦è™•ç†ä¸¦ç™¼æ’¤å›çš„æƒ…æ³

---

### 2.2 æ“´å±• TaskServiceï¼ˆä»»å‹™ç‹€æ…‹æµè½‰ï¼‰

#### ğŸ“ æ–‡ä»¶ä½ç½®
- **Service**: `src/app/shared/services/task/task.service.ts` (æ“´å±•ç¾æœ‰æ–‡ä»¶)

#### ğŸ”§ ä¾è³´é—œä¿‚
- `TaskStagingService` (æ–°å¢ä¾è³´)
- `ActivityLogService` (è§¸ç™¼æ´»å‹•è¨˜éŒ„)
- `TaskRepository` (å·²å­˜åœ¨)

#### ğŸ“ æ–°å¢æ–¹æ³•

##### 1. submitTaskToStaging
```typescript
/**
 * æäº¤ä»»å‹™åˆ°æš«å­˜å€ï¼ˆæ•´åˆ TaskStagingServiceï¼‰
 * 
 * @param taskId ä»»å‹™ ID
 * @param stagingData æš«å­˜æ•¸æ“š
 */
async submitTaskToStaging(
  taskId: string,
  stagingData: {
    stagingData: Record<string, unknown>;
    photos?: Array<{ url: string; caption?: string }>;
    notes?: string;
  }
): Promise<void> {
  // 1. èª¿ç”¨ TaskStagingService.submitToStaging
  // 2. æ›´æ–°ä»»å‹™ç‹€æ…‹ç‚º TaskStatus.STAGING
  // 3. è§¸ç™¼æ´»å‹•è¨˜éŒ„
}
```

##### 2. confirmTaskStaging
```typescript
/**
 * ç¢ºèªä»»å‹™æš«å­˜ï¼ˆè½‰ç‚ºæ­£å¼è¨˜éŒ„ï¼‰
 * 
 * @param taskId ä»»å‹™ ID
 * @param stagingId æš«å­˜è¨˜éŒ„ ID
 */
async confirmTaskStaging(taskId: string, stagingId: string): Promise<void> {
  // 1. èª¿ç”¨ TaskStagingService.confirmStaging
  // 2. æ›´æ–°ä»»å‹™ç‹€æ…‹ç‚º TaskStatus.COMPLETED
  // 3. è§¸ç™¼æ´»å‹•è¨˜éŒ„
}
```

##### 3. withdrawTaskStaging
```typescript
/**
 * æ’¤å›ä»»å‹™æš«å­˜
 * 
 * @param taskId ä»»å‹™ ID
 * @param stagingId æš«å­˜è¨˜éŒ„ ID
 */
async withdrawTaskStaging(taskId: string, stagingId: string): Promise<void> {
  // 1. èª¿ç”¨ TaskStagingService.withdrawStaging
  // 2. æ›´æ–°ä»»å‹™ç‹€æ…‹ç‚º TaskStatus.IN_PROGRESSï¼ˆæ¢å¾©åˆ°é€²è¡Œä¸­ï¼‰
  // 3. è§¸ç™¼æ´»å‹•è¨˜éŒ„
}
```

##### 4. updateTaskStatus
```typescript
/**
 * æ›´æ–°ä»»å‹™ç‹€æ…‹ï¼ˆå…§éƒ¨æ–¹æ³•ï¼Œçµ±ä¸€ç‹€æ…‹è®Šæ›´é‚è¼¯ï¼‰
 * 
 * @param taskId ä»»å‹™ ID
 * @param newStatus æ–°ç‹€æ…‹
 * @param reason ç‹€æ…‹è®Šæ›´åŸå› 
 */
private async updateTaskStatus(
  taskId: string,
  newStatus: TaskStatus,
  reason?: string
): Promise<void> {
  // 1. é©—è­‰ç‹€æ…‹è½‰æ›æ˜¯å¦åˆæ³•
  // 2. æ›´æ–°ä»»å‹™ç‹€æ…‹
  // 3. è§¸ç™¼æ´»å‹•è¨˜éŒ„ï¼ˆåŒ…å« reasonï¼‰
}
```

#### ğŸ“Š ç‹€æ…‹æµè½‰è¦å‰‡

```
pending â†’ assigned â†’ in_progress â†’ staging â†’ completed
                                    â†“
                                 (æ’¤å›)
                                    â†“
                                in_progress
```

#### âœ… é©—æ”¶æ¨™æº–
- [ ] ä»»å‹™ç‹€æ…‹å¯ä»¥æ­£ç¢ºæµè½‰
- [ ] ç‹€æ…‹è½‰æ›é©—è­‰æ­£ç¢º
- [ ] èˆ‡ TaskStagingService æ•´åˆç„¡èª¤
- [ ] æ´»å‹•è¨˜éŒ„æ­£ç¢ºè§¸ç™¼
- [ ] éŒ¯èª¤è™•ç†å®Œæ•´

---

### 2.3 DailyReportServiceï¼ˆæ–½å·¥æ—¥èªŒï¼‰

#### ğŸ“ æ–‡ä»¶ä½ç½®
- **Service**: `src/app/shared/services/task/daily-report.service.ts` (æ–°å»º)
- **Repository**: `src/app/core/infra/repositories/daily-report.repository.ts` (å·²å­˜åœ¨)
- **Repository**: `src/app/core/infra/repositories/report-photo.repository.ts` (éœ€è¦æª¢æŸ¥æ˜¯å¦å­˜åœ¨)
- **Repository**: `src/app/core/infra/repositories/weather-cache.repository.ts` (å·²å­˜åœ¨)

#### ğŸ”§ ä¾è³´é—œä¿‚
- `DailyReportRepository` (å·²å­˜åœ¨)
- `ReportPhotoRepository` (éœ€è¦æª¢æŸ¥)
- `WeatherCacheRepository` (å·²å­˜åœ¨)
- `DocumentService` (ä¸Šå‚³ç…§ç‰‡åˆ° Storage)
- `BranchContextService` (ç²å–ç•¶å‰åˆ†æ”¯)
- `ActivityLogService` (è§¸ç™¼æ´»å‹•è¨˜éŒ„)

#### ğŸ“ æ¥å£å®šç¾©

```typescript
// src/app/shared/services/task/daily-report.service.ts
import { Injectable, inject, signal, computed } from '@angular/core';
import { 
  DailyReportRepository, 
  ReportPhotoRepository, 
  WeatherCacheRepository 
} from '@core';
import { DailyReport, DailyReportInsert, DailyReportDetail } from '@shared';
import { BranchContextService } from '@core';
import { firstValueFrom } from 'rxjs';

@Injectable({ providedIn: 'root' })
export class DailyReportService {
  private dailyReportRepository = inject(DailyReportRepository);
  private reportPhotoRepository = inject(ReportPhotoRepository);
  private weatherCacheRepository = inject(WeatherCacheRepository);
  private branchContext = inject(BranchContextService);
  
  // Signals
  private reportsState = signal<DailyReport[]>([]);
  private loadingState = signal<boolean>(false);
  private errorState = signal<string | null>(null);
  
  readonly reports = this.reportsState.asReadonly();
  readonly loading = this.loadingState.asReadonly();
  readonly error = this.errorState.asReadonly();
}
```

#### ğŸ¯ æ ¸å¿ƒæ–¹æ³•

##### 1. createDailyReport
```typescript
/**
 * å‰µå»ºæ¯æ—¥æ–½å·¥æ—¥èªŒ
 * 
 * @param data æ–½å·¥æ—¥èªŒæ•¸æ“š
 * @param photos ç…§ç‰‡æ–‡ä»¶åˆ—è¡¨ï¼ˆå¯é¸ï¼‰
 * @returns å‰µå»ºçš„æ–½å·¥æ—¥èªŒ
 */
async createDailyReport(
  data: {
    taskId: string;
    blueprintId: string;
    reportDate: string; // YYYY-MM-DD
    workDescription: string;
    workerCount?: number;
    equipmentUsed?: string;
    materialsUsed?: string;
    progressNotes?: string;
    issuesEncountered?: string;
    location?: string; // ç”¨æ–¼ç²å–å¤©æ°£è³‡è¨Š
  },
  photos?: File[]
): Promise<DailyReportDetail> {
  // 1. ç²å–ç•¶å‰åˆ†æ”¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  // 2. ç²å–å¤©æ°£è³‡è¨Šï¼ˆå¦‚æœæä¾› locationï¼‰
  // 3. å‰µå»º daily_report è¨˜éŒ„
  // 4. å¦‚æœ branch_id å­˜åœ¨ï¼ŒåŒæ­¥å‰µå»ºä¸»åˆ†æ”¯è¨˜éŒ„ï¼ˆbranch_id = nullï¼‰
  // 5. ä¸Šå‚³ç…§ç‰‡åˆ° Storageï¼ˆå¦‚æœæä¾›ï¼‰
  // 6. å‰µå»º report_photos è¨˜éŒ„
  // 7. è§¸ç™¼æ´»å‹•è¨˜éŒ„
  // 8. è¿”å›åŒ…å«ç…§ç‰‡çš„å®Œæ•´è¨˜éŒ„
}
```

##### 2. syncToMainBranch
```typescript
/**
 * åŒæ­¥æ–½å·¥æ—¥èªŒåˆ°ä¸»åˆ†æ”¯ï¼ˆå…§éƒ¨æ–¹æ³•ï¼‰
 * 
 * @param report åˆ†æ”¯æ–½å·¥æ—¥èªŒ
 */
private async syncToMainBranch(report: DailyReport): Promise<void> {
  // 1. æª¢æŸ¥ report.branch_id æ˜¯å¦å­˜åœ¨
  // 2. å‰µå»ºä¸»åˆ†æ”¯è¨˜éŒ„ï¼ˆbranch_id = nullï¼Œå…¶ä»–å­—æ®µç›¸åŒï¼‰
  // 3. åŒæ­¥ç…§ç‰‡è¨˜éŒ„
  // 4. è§¸ç™¼æ´»å‹•è¨˜éŒ„
}
```

##### 3. getWeatherInfo
```typescript
/**
 * ç²å–å¤©æ°£è³‡è¨Šï¼ˆå¾å¿«å–æˆ– APIï¼‰
 * 
 * @param location åœ°é»
 * @param date æ—¥æœŸ
 * @returns å¤©æ°£è³‡è¨Š JSON
 */
private async getWeatherInfo(
  location: string, 
  date: string
): Promise<Record<string, unknown> | null> {
  // 1. æª¢æŸ¥ WeatherCache æ˜¯å¦æœ‰å¿«å–
  // 2. å¦‚æœæœ‰ä¸”æœªéæœŸï¼Œè¿”å›å¿«å–
  // 3. å¦‚æœæ²’æœ‰æˆ–å·²éæœŸï¼Œèª¿ç”¨å¤©æ°£ APIï¼ˆEdge Functionï¼‰
  // 4. ä¿å­˜åˆ° WeatherCache
  // 5. è¿”å›å¤©æ°£è³‡è¨Š
}
```

##### 4. uploadReportPhotos
```typescript
/**
 * ä¸Šå‚³æ–½å·¥ç…§ç‰‡
 * 
 * @param reportId æ–½å·¥æ—¥èªŒ ID
 * @param photos ç…§ç‰‡æ–‡ä»¶åˆ—è¡¨
 * @returns ç…§ç‰‡è¨˜éŒ„åˆ—è¡¨
 */
private async uploadReportPhotos(
  reportId: string,
  photos: File[]
): Promise<ReportPhoto[]> {
  // 1. ä¸Šå‚³ç…§ç‰‡åˆ° Supabase Storage (images/daily-reports/)
  // 2. å‰µå»º documents è¨˜éŒ„ï¼ˆå¦‚æœä½¿ç”¨çµ±ä¸€æ–‡ä»¶ç®¡ç†ï¼‰
  // 3. å‰µå»º report_photos è¨˜éŒ„
  // 4. è¿”å›ç…§ç‰‡è¨˜éŒ„åˆ—è¡¨
}
```

##### 5. loadReportsByTaskId
```typescript
/**
 * æ ¹æ“šä»»å‹™ ID åŠ è¼‰æ–½å·¥æ—¥èªŒåˆ—è¡¨
 * 
 * @param taskId ä»»å‹™ ID
 */
async loadReportsByTaskId(taskId: string): Promise<void> {
  // 1. è¨­ç½® loading = true
  // 2. èª¿ç”¨ Repository.findByTaskId
  // 3. åŠ è¼‰é—œè¯çš„ç…§ç‰‡
  // 4. æ›´æ–°æœ¬åœ°ç‹€æ…‹
  // 5. è¨­ç½® loading = false
}
```

#### âœ… é©—æ”¶æ¨™æº–
- [ ] å¯ä»¥å‰µå»ºæ–½å·¥æ—¥èªŒ
- [ ] åˆ†æ”¯æ–½å·¥æ—¥èªŒè‡ªå‹•åŒæ­¥åˆ°ä¸»åˆ†æ”¯ï¼ˆbranch_id = null çš„è¨˜éŒ„ï¼‰
- [ ] å¤©æ°£è³‡è¨Šæ­£ç¢ºç²å–å’Œå¿«å–ï¼ˆä½¿ç”¨ WeatherCacheï¼‰
- [ ] ç…§ç‰‡æ­£ç¢ºä¸Šå‚³åˆ° Storage ä¸¦å‰µå»º report_photos è¨˜éŒ„
- [ ] æŸ¥è©¢åŠŸèƒ½æ­£å¸¸ï¼ˆæŒ‰ä»»å‹™ã€æ—¥æœŸã€åˆ†æ”¯æŸ¥è©¢ï¼‰
- [ ] ç‹€æ…‹ç®¡ç†ä½¿ç”¨ Signals
- [ ] éŒ¯èª¤è™•ç†å®Œæ•´
- [ ] æ´»å‹•è¨˜éŒ„æ­£ç¢ºè§¸ç™¼

#### âš ï¸ æ³¨æ„äº‹é …
- æ–½å·¥æ—¥èªŒåŒæ­¥åˆ°ä¸»åˆ†æ”¯æ™‚ï¼Œéœ€è¦ä¿æŒæ•¸æ“šä¸€è‡´æ€§
- å¤©æ°£ API èª¿ç”¨éœ€è¦è™•ç†å¤±æ•—æƒ…æ³ï¼ˆä½¿ç”¨å¿«å–ä½œç‚ºå‚™é¸ï¼‰
- ç…§ç‰‡ä¸Šå‚³éœ€è¦è™•ç†å¤§æ–‡ä»¶å’Œä¸Šå‚³å¤±æ•—çš„æƒ…æ³

---

### 2.4 æ•´åˆæš«å­˜å€èˆ‡æ–½å·¥æ—¥èªŒ

#### ğŸ“ æ–‡ä»¶ä½ç½®
- **Service**: `src/app/shared/services/task/task-staging.service.ts` (æ“´å±•)
- **Service**: `src/app/shared/services/task/daily-report.service.ts` (æ“´å±•)

#### ğŸ”§ æ•´åˆé‚è¼¯

##### åœ¨ TaskStagingService.confirmStaging ä¸­
```typescript
async confirmStaging(stagingId: string): Promise<TaskStaging> {
  // ... ç¾æœ‰é‚è¼¯ ...
  
  // æ–°å¢ï¼šå¦‚æœ staging_data åŒ…å«æ–½å·¥æ—¥èªŒè³‡è¨Šï¼Œå‰µå»ºæ–½å·¥æ—¥èªŒ
  if (staging.staging_data?.dailyReport) {
    await this.dailyReportService.createDailyReportFromStaging(
      staging.task_id,
      staging.staging_data.dailyReport,
      staging.photos
    );
  }
  
  // ... è¿”å›æ›´æ–°å¾Œçš„è¨˜éŒ„ ...
}
```

##### åœ¨ TaskStagingService.withdrawStaging ä¸­
```typescript
async withdrawStaging(stagingId: string): Promise<void> {
  // ... ç¾æœ‰é‚è¼¯ ...
  
  // æ–°å¢ï¼šå¦‚æœå·²å‰µå»ºæ–½å·¥æ—¥èªŒï¼Œéœ€è¦æ¸…ç†ï¼ˆæ¨™è¨˜ç‚ºæ’¤å›ç›¸é—œï¼‰
  // æ³¨æ„ï¼šä¸ç›´æ¥åˆªé™¤ï¼Œè€Œæ˜¯æ¨™è¨˜é—œè¯é—œä¿‚
  if (staging.confirmed_at) {
    // å·²ç¢ºèªçš„æš«å­˜æ’¤å›æ™‚ï¼Œéœ€è¦è™•ç†å·²å‰µå»ºçš„æ–½å·¥æ—¥èªŒ
    // å¯ä»¥æ·»åŠ ä¸€å€‹æ¨™è¨˜å­—æ®µæˆ–å‰µå»ºæ’¤å›è¨˜éŒ„
  }
  
  // ... å®Œæˆæ’¤å› ...
}
```

#### âœ… é©—æ”¶æ¨™æº–
- [ ] æš«å­˜ç¢ºèªæ™‚è‡ªå‹•å‰µå»ºæ–½å·¥æ—¥èªŒ
- [ ] æš«å­˜æ’¤å›æ™‚æ­£ç¢ºè™•ç†ç›¸é—œæ–½å·¥æ—¥èªŒ
- [ ] æ•¸æ“šä¸€è‡´æ€§æª¢æŸ¥é€šé
- [ ] éŒ¯èª¤è™•ç†å®Œæ•´

---

### 2.5 æš«å­˜å€ UI çµ„ä»¶

#### ğŸ“ æ–‡ä»¶ä½ç½®
- **List Component**: `src/app/routes/tasks/staging/task-staging-list.component.ts`
- **Detail Component**: `src/app/routes/tasks/staging/detail/task-staging-detail.component.ts`
- **Form Component**: `src/app/routes/tasks/staging/form/task-staging-form.component.ts`

#### ğŸ¨ çµ„ä»¶è¨­è¨ˆ

##### TaskStagingListComponent
```typescript
// åŠŸèƒ½ï¼š
// - é¡¯ç¤ºç•¶å‰ç”¨æˆ¶çš„æš«å­˜è¨˜éŒ„åˆ—è¡¨
// - é¡¯ç¤ºå¯æ’¤å›ç‹€æ…‹ï¼ˆ48å°æ™‚å€’è¨ˆæ™‚ï¼‰
// - é¡¯ç¤ºå·²éæœŸç‹€æ…‹
// - æ”¯æŒç¯©é¸ï¼ˆå¯æ’¤å›ã€å·²ç¢ºèªã€å·²æ’¤å›ã€å·²éæœŸï¼‰
// - æ”¯æŒæ“ä½œï¼ˆæŸ¥çœ‹ã€æ’¤å›ã€ç¢ºèªï¼‰

// è¡¨æ ¼åˆ—ï¼š
// - ä»»å‹™åç¨±
// - æäº¤æ™‚é–“
// - éæœŸæ™‚é–“
// - ç‹€æ…‹ï¼ˆå¯æ’¤å›/å·²ç¢ºèª/å·²æ’¤å›/å·²éæœŸï¼‰
// - å€’è¨ˆæ™‚ï¼ˆ48å°æ™‚ï¼‰
// - æ“ä½œæŒ‰éˆ•
```

##### TaskStagingDetailComponent
```typescript
// åŠŸèƒ½ï¼š
// - é¡¯ç¤ºæš«å­˜è©³æƒ…
// - é¡¯ç¤º staging_data å…§å®¹
// - é¡¯ç¤ºç…§ç‰‡
// - é¡¯ç¤º notes
// - æ”¯æŒæ’¤å›ï¼ˆå¦‚æœå¯æ’¤å›ï¼‰
// - æ”¯æŒç¢ºèªï¼ˆå¦‚æœæœªç¢ºèªä¸”æœªæ’¤å›ï¼‰
// - é¡¯ç¤º48å°æ™‚å€’è¨ˆæ™‚
```

##### TaskStagingFormComponent
```typescript
// åŠŸèƒ½ï¼š
// - è¡¨å–®æäº¤ä»»å‹™åˆ°æš«å­˜å€
// - è¼¸å…¥ staging_dataï¼ˆJSON ç·¨è¼¯å™¨æˆ–çµæ§‹åŒ–è¡¨å–®ï¼‰
// - ä¸Šå‚³ç…§ç‰‡
// - è¼¸å…¥ notes
// - è¡¨å–®é©—è­‰
// - æäº¤åˆ° TaskStagingService
```

#### âœ… é©—æ”¶æ¨™æº–
- [ ] åˆ—è¡¨é¡¯ç¤ºæ­£ç¢º
- [ ] å€’è¨ˆæ™‚åŠŸèƒ½æ­£å¸¸
- [ ] æ’¤å›åŠŸèƒ½æ­£å¸¸
- [ ] ç¢ºèªåŠŸèƒ½æ­£å¸¸
- [ ] è¡¨å–®é©—è­‰æ­£ç¢º
- [ ] ç…§ç‰‡ä¸Šå‚³æ­£å¸¸
- [ ] éŸ¿æ‡‰å¼è¨­è¨ˆ

---

## éšæ®µ3ï¼šPRå¯©æ ¸èˆ‡å”ä½œç³»çµ±

### 3.1 å®Œå–„ PR å¯©æ ¸æµç¨‹

#### ğŸ“ æ–‡ä»¶ä½ç½®
- **Service**: `src/app/shared/services/blueprint/pull-request.service.ts` (æ“´å±•ç¾æœ‰æ–‡ä»¶)

#### ğŸ”§ ä¾è³´é—œä¿‚
- `PullRequestRepository` (å·²å­˜åœ¨)
- `BranchPermissionService` (æ¬Šé™æª¢æŸ¥)
- `TaskService` (åˆä½µæ™‚æ›´æ–°ä»»å‹™)
- `ActivityLogService` (è§¸ç™¼æ´»å‹•è¨˜éŒ„)
- `NotificationService` (ç™¼é€é€šçŸ¥)

#### ğŸ“ æ–°å¢æ–¹æ³•

##### 1. reviewPR
```typescript
/**
 * å¯©æ ¸ PRï¼ˆæ‰¹å‡†æˆ–æ‹’çµ•ï¼‰
 * 
 * @param prId PR ID
 * @param reviewData å¯©æ ¸æ•¸æ“š
 */
async reviewPR(
  prId: string,
  reviewData: {
    status: 'approve' | 'reject';
    comment?: string;
    reviewerId: string;
  }
): Promise<void> {
  // 1. æª¢æŸ¥æ¬Šé™ï¼ˆBranchPermissionService.canReviewPRï¼‰
  // 2. æª¢æŸ¥ PR ç‹€æ…‹å¿…é ˆç‚º OPEN æˆ– REVIEWING
  // 3. æ›´æ–° PR ç‹€æ…‹
  // 4. å‰µå»ºå¯©æ ¸è¨˜éŒ„ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
  // 5. è§¸ç™¼é€šçŸ¥ï¼ˆé€šçŸ¥æäº¤è€…ï¼‰
  // 6. è§¸ç™¼æ´»å‹•è¨˜éŒ„
}
```

##### 2. mergePR
```typescript
/**
 * åˆä½µ PRï¼ˆå°‡åˆ†æ”¯æ•¸æ“šåˆä½µåˆ°ä¸»åˆ†æ”¯ï¼‰
 * 
 * PR åˆä½µé‚è¼¯ï¼š
 * 1. å¾ PR çš„ pr_data JSONB å­—æ®µä¸­æå–è®Šæ›´æ•¸æ“š
 * 2. åˆä½µåˆ°ä¸»åˆ†æ”¯çš„ tasks è¡¨ï¼š
 *    - æ›´æ–° tasks.contractor_fieldsï¼ˆæ‰¿æ”¬æ¬„ä½ï¼‰
 *    - contractor_fields åŒ…å«ï¼šå¯¦éš›å·¥æ™‚ã€å¯¦éš›æˆæœ¬ã€æ–½å·¥ç…§ç‰‡ã€å‚™è¨»ç­‰
 * 3. åŒæ­¥ç›¸é—œæ•¸æ“šï¼š
 *    - daily_reportsï¼šå¦‚æœ branch_id å­˜åœ¨ï¼Œå‰µå»ºä¸»åˆ†æ”¯è¨˜éŒ„ï¼ˆbranch_id = nullï¼‰
 *    - quality_checksï¼šåŒæ­¥å“ç®¡è¨˜éŒ„
 * 4. æ›´æ–° PR ç‹€æ…‹ç‚º MERGED
 * 5. è§¸ç™¼é€šçŸ¥å’Œæ´»å‹•è¨˜éŒ„
 * 
 * @param prId PR ID
 */
async mergePR(prId: string): Promise<void> {
  // 1. æª¢æŸ¥ PR ç‹€æ…‹å¿…é ˆç‚º APPROVED
  const pr = await this.loadPullRequestById(prId);
  if (pr.status !== PRStatus.APPROVED) {
    throw new Error('PR å¿…é ˆå…ˆè¢«æ‰¹å‡†æ‰èƒ½åˆä½µ');
  }
  
  // 2. æª¢æŸ¥æ¬Šé™ï¼ˆåªæœ‰ OWNER æˆ– ADMIN å¯ä»¥åˆä½µï¼‰
  const currentUser = this.authState.user();
  if (!currentUser) throw new Error('æœªç™»å…¥');
  
  const hasPermission = await this.branchPermissionService.canModifyTaskStructure(
    pr.branch_id,
    currentUser.id
  );
  if (!hasPermission) {
    throw new Error('ç„¡æ¬Šé™åˆä½µ PR');
  }
  
  // 3. ç²å– PR çš„è®Šæ›´æ•¸æ“šï¼ˆå¾ pr_data JSONBï¼‰
  const prData = pr.pr_data as {
    tasks?: Array<{
      taskId: string;
      contractorFields: Record<string, unknown>;
    }>;
    dailyReports?: Array<DailyReportInsert>;
    qualityChecks?: Array<QualityCheckInsert>;
  };
  
  // 4. åˆä½µåˆ°ä¸»åˆ†æ”¯
  // 4.1 æ›´æ–° tasks è¡¨çš„æ‰¿æ”¬æ¬„ä½
  if (prData.tasks) {
    for (const taskChange of prData.tasks) {
      await this.taskService.updateTaskContractorFields(
        taskChange.taskId,
        taskChange.contractorFields
      );
    }
  }
  
  // 4.2 åŒæ­¥ daily_reportsï¼ˆå‰µå»ºä¸»åˆ†æ”¯è¨˜éŒ„ï¼‰
  if (prData.dailyReports) {
    for (const report of prData.dailyReports) {
      await this.dailyReportService.syncToMainBranch(report);
    }
  }
  
  // 4.3 åŒæ­¥ quality_checksï¼ˆå¦‚æœéœ€è¦ï¼‰
  // ...
  
  // 5. æ›´æ–° PR ç‹€æ…‹ç‚º MERGED
  await this.updatePullRequest(prId, {
    status: PRStatus.MERGED,
    mergedAt: new Date().toISOString(),
    mergedBy: currentUser.id
  } as any);
  
  // 6. è§¸ç™¼é€šçŸ¥
  await this.notificationService.createNotification({
    recipientId: pr.submitted_by,
    notificationType: 'pr_merged',
    title: 'PR å·²åˆä½µ',
    content: `PR #${pr.id} å·²æˆåŠŸåˆä½µåˆ°ä¸»åˆ†æ”¯`,
    relatedType: 'pull_request',
    relatedId: pr.id
  });
  
  // 7. è§¸ç™¼æ´»å‹•è¨˜éŒ„
  await this.activityLogService.createActivityLog({
    actorId: currentUser.id,
    blueprintId: pr.blueprint_id,
    branchId: pr.branch_id,
    action: 'merge_pr',
    resourceType: 'pr',
    resourceId: pr.id,
    actionDetails: {
      prId: pr.id,
      mergedTasks: prData.tasks?.length || 0
    }
  });
}
```

##### 3. closePR
```typescript
/**
 * é—œé–‰ PR
 * 
 * @param prId PR ID
 * @param reason é—œé–‰åŸå› 
 */
async closePR(prId: string, reason?: string): Promise<void> {
  // 1. æª¢æŸ¥æ¬Šé™ï¼ˆOWNERã€ADMIN æˆ–æäº¤è€…å¯ä»¥é—œé–‰ï¼‰
  const pr = await this.loadPullRequestById(prId);
  const currentUser = this.authState.user();
  if (!currentUser) throw new Error('æœªç™»å…¥');
  
  const canClose = 
    currentUser.id === pr.submitted_by ||
    await this.branchPermissionService.canReviewPR(pr.branch_id, currentUser.id);
  
  if (!canClose) {
    throw new Error('ç„¡æ¬Šé™é—œé–‰ PR');
  }
  
  // 2. æ›´æ–° PR ç‹€æ…‹ç‚º CLOSED
  await this.updatePullRequest(prId, {
    status: PRStatus.CLOSED,
    closedAt: new Date().toISOString(),
    closedBy: currentUser.id
  } as any);
  
  // 3. è§¸ç™¼é€šçŸ¥
  const recipientId = currentUser.id === pr.submitted_by 
    ? pr.reviewed_by || pr.blueprint_owner_id
    : pr.submitted_by;
  
  await this.notificationService.createNotification({
    recipientId,
    notificationType: 'pr_closed',
    title: 'PR å·²é—œé–‰',
    content: reason || `PR #${pr.id} å·²è¢«é—œé–‰`,
    relatedType: 'pull_request',
    relatedId: pr.id
  });
  
  // 4. è§¸ç™¼æ´»å‹•è¨˜éŒ„
  await this.activityLogService.createActivityLog({
    actorId: currentUser.id,
    blueprintId: pr.blueprint_id,
    branchId: pr.branch_id,
    action: 'close_pr',
    resourceType: 'pr',
    resourceId: pr.id,
    actionDetails: { reason }
  });
}
```

#### âœ… é©—æ”¶æ¨™æº–
- [ ] æ¬Šé™æª¢æŸ¥æ­£ç¢º
- [ ] PR å¯©æ ¸æµç¨‹æ­£ç¢º
- [ ] PR åˆä½µé‚è¼¯æ­£ç¢º
- [ ] æ•¸æ“šåˆä½µç„¡èª¤
- [ ] é€šçŸ¥æ­£ç¢ºç™¼é€
- [ ] æ´»å‹•è¨˜éŒ„æ­£ç¢ºè§¸ç™¼

---

### 3.2 Realtime é€šçŸ¥ç³»çµ±

#### ğŸ“ æ–‡ä»¶ä½ç½®
- **Service**: `src/app/shared/services/notification/notification.service.ts` (æ–°å»º)
- **Component**: `src/app/shared/components/notification-center/notification-center.component.ts` (æ–°å»º)
- **Repository**: `src/app/core/infra/repositories/notification.repository.ts` (å·²å­˜åœ¨)

#### ğŸ”§ ä¾è³´é—œä¿‚
- `NotificationRepository` (å·²å­˜åœ¨)
- `SupabaseService` (Realtime è¨‚é–±)
- `AuthStateService` (ç²å–ç•¶å‰ç”¨æˆ¶)

#### ğŸ“ æ¥å£å®šç¾©

```typescript
// src/app/shared/services/notification/notification.service.ts
import { Injectable, inject, signal, computed, effect } from '@angular/core';
import { NotificationRepository, SupabaseService } from '@core';
import { Notification, NotificationInsert } from '@shared';
import { AuthStateService } from '@shared';
import { firstValueFrom } from 'rxjs';

@Injectable({ providedIn: 'root' })
export class NotificationService {
  private notificationRepository = inject(NotificationRepository);
  private supabase = inject(SupabaseService);
  private authState = inject(AuthStateService);
  
  // Signals
  private notificationsState = signal<Notification[]>([]);
  private unreadCountState = signal<number>(0);
  private loadingState = signal<boolean>(false);
  
  readonly notifications = this.notificationsState.asReadonly();
  readonly unreadCount = this.unreadCountState.asReadonly();
  readonly loading = this.loadingState.asReadonly();
  
  // Realtime è¨‚é–±
  private channel: any = null;
  
  constructor() {
    // è¨‚é–±ç•¶å‰ç”¨æˆ¶çš„é€šçŸ¥
    effect(() => {
      const user = this.authState.user();
      if (user) {
        this.subscribeToNotifications(user.id);
        this.loadNotifications(user.id);
      } else {
        this.unsubscribeFromNotifications();
      }
    });
  }
  
  /**
   * è¨‚é–± Realtime é€šçŸ¥
   */
  private subscribeToNotifications(accountId: string): void {
    // 1. å–æ¶ˆèˆŠè¨‚é–±
    this.unsubscribeFromNotifications();
    
    // 2. å‰µå»ºæ–°è¨‚é–±
    this.channel = this.supabase.client
      .channel(`notifications:${accountId}`)
      .on(
        'postgres_changes',
        {
          event: 'INSERT',
          schema: 'public',
          table: 'notifications',
          filter: `recipient_id=eq.${accountId}`
        },
        (payload) => {
          // è™•ç†æ–°é€šçŸ¥
          this.handleNewNotification(payload.new as Notification);
        }
      )
      .subscribe();
  }
  
  /**
   * è™•ç†æ–°é€šçŸ¥
   */
  private handleNewNotification(notification: Notification): void {
    // 1. æ·»åŠ åˆ°æœ¬åœ°ç‹€æ…‹
    this.notificationsState.update(notifications => [notification, ...notifications]);
    
    // 2. æ›´æ–°æœªè®€è¨ˆæ•¸
    this.unreadCountState.update(count => count + 1);
    
    // 3. é¡¯ç¤ºæ¡Œé¢é€šçŸ¥ï¼ˆå¦‚æœå…è¨±ï¼‰
    if (Notification.permission === 'granted') {
      this.showDesktopNotification(notification);
    }
  }
  
  /**
   * å‰µå»ºé€šçŸ¥
   * 
   * @param data é€šçŸ¥æ•¸æ“š
   */
  async createNotification(data: {
    recipientId: string;
    senderId?: string;
    notificationType: 
      | 'task_assigned' | 'task_submitted' | 'task_approved' | 'task_rejected'
      | 'issue_created' | 'issue_assigned' | 'issue_resolved'
      | 'pr_created' | 'pr_reviewed' | 'pr_merged' | 'pr_closed'
      | 'comment_mention' | 'qa_required' | 'inspection_required'
      | 'deadline_reminder' | 'staging_expiring';
    title: string;
    content?: string;
    relatedType?: string;
    relatedId?: string;
    actionUrl?: string;
    priority?: 'low' | 'normal' | 'high' | 'urgent';
  }): Promise<Notification> {
    // 1. æª¢æŸ¥é€šçŸ¥è¦å‰‡ï¼ˆNotificationRuleï¼‰
    // 2. å‰µå»ºé€šçŸ¥è¨˜éŒ„
    // 3. æ›´æ–°æœ¬åœ°ç‹€æ…‹
    // 4. è¿”å›å‰µå»ºçš„é€šçŸ¥
  }
  
  /**
   * æ¨™è¨˜é€šçŸ¥ç‚ºå·²è®€
   */
  async markAsRead(notificationId: string): Promise<void> {
    // 1. æ›´æ–°é€šçŸ¥è¨˜éŒ„
    // 2. æ›´æ–°æœ¬åœ°ç‹€æ…‹
    // 3. æ›´æ–°æœªè®€è¨ˆæ•¸
  }
  
  /**
   * æ¨™è¨˜æ‰€æœ‰é€šçŸ¥ç‚ºå·²è®€
   */
  async markAllAsRead(recipientId: string): Promise<void> {
    // 1. æ‰¹é‡æ›´æ–°é€šçŸ¥è¨˜éŒ„ï¼ˆå¯èƒ½éœ€è¦ RPCï¼‰
    // 2. æ›´æ–°æœ¬åœ°ç‹€æ…‹
    // 3. é‡ç½®æœªè®€è¨ˆæ•¸
  }
  
  /**
   * é¡¯ç¤ºæ¡Œé¢é€šçŸ¥
   */
  private showDesktopNotification(notification: Notification): void {
    new Notification(notification.title, {
      body: notification.message,
      icon: '/assets/logo.png',
      tag: notification.id
    });
  }
  
  /**
   * è«‹æ±‚æ¡Œé¢é€šçŸ¥æ¬Šé™
   */
  async requestNotificationPermission(): Promise<boolean> {
    if (Notification.permission === 'default') {
      const permission = await Notification.requestPermission();
      return permission === 'granted';
    }
    return Notification.permission === 'granted';
  }
}
```

#### âœ… é©—æ”¶æ¨™æº–
- [ ] Realtime è¨‚é–±æ­£å¸¸
- [ ] æ–°é€šçŸ¥å³æ™‚é¡¯ç¤º
- [ ] æ¡Œé¢é€šçŸ¥æ­£å¸¸
- [ ] æœªè®€è¨ˆæ•¸æ­£ç¢º
- [ ] é€šçŸ¥åˆ—è¡¨æ­£ç¢º
- [ ] æ¨™è¨˜å·²è®€åŠŸèƒ½æ­£å¸¸

---

### 3.3 å¾…è¾¦ä¸­å¿ƒï¼ˆPersonalTodoServiceï¼‰

#### ğŸ“ æ–‡ä»¶ä½ç½®
- **Service**: `src/app/shared/services/todo/personal-todo.service.ts` (æ–°å»º)
- **Component**: `src/app/routes/todos/todo-center.component.ts` (æ–°å»º)
- **Repository**: `src/app/core/infra/repositories/personal-todo.repository.ts` (å·²å­˜åœ¨)

#### ğŸ”§ ä¾è³´é—œä¿‚
- `PersonalTodoRepository` (å·²å­˜åœ¨)
- `TodoStatusTrackingRepository` (ç‹€æ…‹è¿½è¹¤)
- `AuthStateService` (ç²å–ç•¶å‰ç”¨æˆ¶)

#### ğŸ“ æ¥å£å®šç¾©

```typescript
// src/app/shared/services/todo/personal-todo.service.ts
import { Injectable, inject, signal, computed } from '@angular/core';
import { PersonalTodoRepository, TodoStatusTrackingRepository } from '@core';
import { PersonalTodo, PersonalTodoInsert } from '@shared';
import { AuthStateService } from '@shared';
import { firstValueFrom } from 'rxjs';

/**
 * å¾…è¾¦ç‹€æ…‹æšèˆ‰
 * æ³¨æ„ï¼šæ•¸æ“šåº«ä¸­å®šç¾©çš„ç‹€æ…‹åŒ…æ‹¬ï¼š
 * - pending, in_progress, staging, in_qa, in_inspection, completed, cancelled
 * ä½†å¾…è¾¦ä¸­å¿ƒä¸»è¦ä½¿ç”¨ï¼špending, in_progress, completed, cancelled, archived
 */
export enum PersonalTodoStatus {
  PENDING = 'pending',
  IN_PROGRESS = 'in_progress',
  STAGING = 'staging', // æš«å­˜ä¸­ï¼ˆå°æ‡‰ä»»å‹™ç‹€æ…‹ï¼‰
  IN_QA = 'in_qa', // å“ç®¡ä¸­ï¼ˆå°æ‡‰ä»»å‹™ç‹€æ…‹ï¼‰
  IN_INSPECTION = 'in_inspection', // é©—æ”¶ä¸­ï¼ˆå°æ‡‰ä»»å‹™ç‹€æ…‹ï¼‰
  COMPLETED = 'completed',
  CANCELLED = 'cancelled',
  ARCHIVED = 'archived' // å·²æ­¸æª”ï¼ˆä¸åœ¨æ•¸æ“šåº«ä¸­ï¼Œæ‡‰ç”¨å±¤ç‹€æ…‹ï¼‰
}

@Injectable({ providedIn: 'root' })
export class PersonalTodoService {
  private todoRepository = inject(PersonalTodoRepository);
  private authState = inject(AuthStateService);
  
  // Signals
  private todosState = signal<PersonalTodo[]>([]);
  private loadingState = signal<boolean>(false);
  
  readonly todos = this.todosState.asReadonly();
  readonly loading = this.loadingState.asReadonly();
  
  // Computed signals
  readonly pendingTodos = computed(() =>
    this.todos().filter(t => t.status === PersonalTodoStatus.PENDING || !t.status)
  );
  
  readonly inProgressTodos = computed(() =>
    this.todos().filter(t => t.status === PersonalTodoStatus.IN_PROGRESS)
  );
  
  readonly completedTodos = computed(() =>
    this.todos().filter(t => t.status === PersonalTodoStatus.COMPLETED)
  );
}
```

#### âœ… é©—æ”¶æ¨™æº–
- [ ] å¯ä»¥å‰µå»ºå¾…è¾¦äº‹é …
- [ ] ç‹€æ…‹æµè½‰æ­£ç¢º
- [ ] ç‹€æ…‹è¿½è¹¤æ­£ç¢º
- [ ] æŸ¥è©¢åŠŸèƒ½æ­£å¸¸
- [ ] UI çµ„ä»¶æ­£å¸¸

---

### 3.4 PR å¯©æ ¸ UI çµ„ä»¶

#### ğŸ“ æ–‡ä»¶ä½ç½®
- **Detail Component**: `src/app/routes/blueprints/pull-requests/detail/pull-request-detail.component.ts`
- **Review Component**: `src/app/routes/blueprints/pull-requests/review/pull-request-review.component.ts`
- **Merge Component**: `src/app/routes/blueprints/pull-requests/merge/pull-request-merge.component.ts`

#### ğŸ¨ çµ„ä»¶è¨­è¨ˆ

##### PullRequestDetailComponent
```typescript
// åŠŸèƒ½ï¼š
// - é¡¯ç¤º PR è©³æƒ…
// - é¡¯ç¤ºè®Šæ›´å…§å®¹ï¼ˆdiff viewï¼‰
// - é¡¯ç¤ºå¯©æ ¸æ­·å²
// - é¡¯ç¤ºè©•è«–
// - æ”¯æŒæ“ä½œï¼ˆå¯©æ ¸ã€åˆä½µã€é—œé–‰ï¼‰
```

##### PullRequestReviewComponent
```typescript
// åŠŸèƒ½ï¼š
// - å¯©æ ¸è¡¨å–®ï¼ˆæ‰¹å‡†/æ‹’çµ•ï¼‰
// - å¯©æ ¸æ„è¦‹è¼¸å…¥
// - æäº¤å¯©æ ¸
```

##### PullRequestMergeComponent
```typescript
// åŠŸèƒ½ï¼š
// - åˆä½µç¢ºèªå°è©±æ¡†
// - é¡¯ç¤ºåˆä½µé è¦½
// - ç¢ºèªåˆä½µ
```

#### âœ… é©—æ”¶æ¨™æº–
- [ ] PR è©³æƒ…é¡¯ç¤ºæ­£ç¢º
- [ ] è®Šæ›´å…§å®¹é¡¯ç¤ºæ­£ç¢º
- [ ] å¯©æ ¸åŠŸèƒ½æ­£å¸¸
- [ ] åˆä½µåŠŸèƒ½æ­£å¸¸
- [ ] æ¬Šé™æª¢æŸ¥æ­£ç¢º

---

## æ•´åˆæ¸¬è©¦èˆ‡å„ªåŒ–

### 4.1 ç«¯åˆ°ç«¯æµç¨‹æ¸¬è©¦

#### ğŸ“ æ–‡ä»¶ä½ç½®
- **E2E Tests**: `e2e/tasks/task-staging-flow.spec.ts`
- **E2E Tests**: `e2e/pr/pr-review-flow.spec.ts`

#### ğŸ§ª æ¸¬è©¦å ´æ™¯

##### ä»»å‹™æš«å­˜æµç¨‹æ¸¬è©¦
```typescript
// æ¸¬è©¦æµç¨‹ï¼š
// 1. å‰µå»ºä»»å‹™
// 2. æäº¤åˆ°æš«å­˜å€
// 3. 48å°æ™‚å…§æ’¤å›
// 4. é‡æ–°æäº¤åˆ°æš«å­˜å€
// 5. ç¢ºèªæš«å­˜
// 6. é©—è­‰æ–½å·¥æ—¥èªŒå‰µå»º
// 7. é©—è­‰æ´»å‹•è¨˜éŒ„
```

##### PR å¯©æ ¸æµç¨‹æ¸¬è©¦
```typescript
// æ¸¬è©¦æµç¨‹ï¼š
// 1. å‰µå»ºåˆ†æ”¯
// 2. æäº¤ PR
// 3. å¯©æ ¸ PRï¼ˆæ‰¹å‡†ï¼‰
// 4. åˆä½µ PR
// 5. é©—è­‰æ•¸æ“šåˆä½µ
// 6. é©—è­‰é€šçŸ¥ç™¼é€
```

#### âœ… é©—æ”¶æ¨™æº–
- [ ] æ‰€æœ‰æ¸¬è©¦é€šé
- [ ] è¦†è“‹ä¸»è¦æ¥­å‹™æµç¨‹
- [ ] æ¸¬è©¦æ•¸æ“šéš”é›¢
- [ ] æ¸¬è©¦æ¬Šé™æ§åˆ¶

---

### 4.2 æ€§èƒ½å„ªåŒ–èˆ‡ç›£æ§

#### ğŸ“‹ å„ªåŒ–é …ç›®
1. æ•¸æ“šåº«æŸ¥è©¢å„ªåŒ–
2. Realtime è¨‚é–±å„ªåŒ–
3. åœ–ç‰‡ä¸Šå‚³å„ªåŒ–
4. å‰ç«¯æ€§èƒ½å„ªåŒ–

#### âœ… é©—æ”¶æ¨™æº–
- [ ] æŸ¥è©¢æ€§èƒ½é”æ¨™
- [ ] Realtime è¨‚é–±ç©©å®š
- [ ] åœ–ç‰‡ä¸Šå‚³é€Ÿåº¦é”æ¨™
- [ ] å‰ç«¯æ€§èƒ½æŒ‡æ¨™é”æ¨™

---

### 4.3 æ–‡æª”æ›´æ–°èˆ‡éƒ¨ç½²æº–å‚™

#### ğŸ“‹ æ–‡æª”æ›´æ–°
1. API æ–‡æª”
2. ç”¨æˆ¶æ‰‹å†Š
3. é–‹ç™¼æ–‡æª”
4. æ¶æ§‹æ±ºç­–è¨˜éŒ„

#### âœ… é©—æ”¶æ¨™æº–
- [ ] æ‰€æœ‰æ–‡æª”æ›´æ–°å®Œæˆ
- [ ] éƒ¨ç½²è…³æœ¬æº–å‚™å®Œæˆ
- [ ] æ•¸æ“šé·ç§»è…³æœ¬æº–å‚™å®Œæˆ
- [ ] å›æ»¾è¨ˆåŠƒæº–å‚™å®Œæˆ

---

## ğŸ“Š å¯¦æ–½æ™‚é–“è¡¨

| éšæ®µ | ä»»å‹™ | è¤‡é›œåº¦ | é è¨ˆæ™‚é–“ |
|------|------|--------|----------|
| éšæ®µ2 | 2.1 TaskStagingService | 6 | 2å¤© |
| éšæ®µ2 | 2.2 æ“´å±• TaskService | 5 | 1.5å¤© |
| éšæ®µ2 | 2.3 DailyReportService | 6 | 2å¤© |
| éšæ®µ2 | 2.4 æ•´åˆæš«å­˜å€èˆ‡æ–½å·¥æ—¥èªŒ | 5 | 1.5å¤© |
| éšæ®µ2 | 2.5 æš«å­˜å€ UI çµ„ä»¶ | 6 | 2å¤© |
| éšæ®µ3 | 3.1 å®Œå–„ PR å¯©æ ¸æµç¨‹ | 7 | 2.5å¤© |
| éšæ®µ3 | 3.2 Realtime é€šçŸ¥ç³»çµ± | 7 | 2.5å¤© |
| éšæ®µ3 | 3.3 å¾…è¾¦ä¸­å¿ƒ | 5 | 1.5å¤© |
| éšæ®µ3 | 3.4 PR å¯©æ ¸ UI çµ„ä»¶ | 6 | 2å¤© |
| æ•´åˆæ¸¬è©¦ | 4.1 ç«¯åˆ°ç«¯æµç¨‹æ¸¬è©¦ | 6 | 1å¤© |
| æ•´åˆæ¸¬è©¦ | 4.2 æ€§èƒ½å„ªåŒ–èˆ‡ç›£æ§ | 5 | 1å¤© |
| æ•´åˆæ¸¬è©¦ | 4.3 æ–‡æª”æ›´æ–°èˆ‡éƒ¨ç½²æº–å‚™ | 3 | 1å¤© |

**ç¸½è¨ˆ**ï¼šç´„ 3.5 é€±ï¼ˆ17.5 å€‹å·¥ä½œæ—¥ï¼‰

---

## ğŸ”— ä¾è³´é—œä¿‚åœ–

```
éšæ®µ2.1 (TaskStagingService)
  â†“
éšæ®µ2.2 (æ“´å±• TaskService) â† ä¾è³´ 2.1
  â†“
éšæ®µ2.3 (DailyReportService)
  â†“
éšæ®µ2.4 (æ•´åˆ) â† ä¾è³´ 2.1, 2.3
  â†“
éšæ®µ2.5 (UI) â† ä¾è³´ 2.1, 2.2, 2.4

éšæ®µ3.1 (PR å¯©æ ¸) â† ä¾è³´ éšæ®µ2
  â†“
éšæ®µ3.2 (é€šçŸ¥ç³»çµ±)
  â†“
éšæ®µ3.3 (å¾…è¾¦ä¸­å¿ƒ)
  â†“
éšæ®µ3.4 (PR UI) â† ä¾è³´ 3.1

æ•´åˆæ¸¬è©¦ â† ä¾è³´ éšæ®µ2, éšæ®µ3
```

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-11-16

