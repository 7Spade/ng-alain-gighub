@if (loading()) {
  <nz-spin nzSimple [nzSize]="'large'" style="display: block; text-align: center; padding: 50px;"></nz-spin>
} @else if (blueprint(); as bp) {
  <nz-tabs [nzSelectedIndex]="selectedTabIndex()" (nzSelectedIndexChange)="selectedTabIndex.set($event)">
    <!-- 基本資訊標籤 -->
    <nz-tab nzTitle="基本資訊">
      <nz-card [nzBordered]="false">
        <form [formGroup]="basicForm" (ngSubmit)="onSubmitBasic()" nz-form nzLayout="vertical">
          <nz-form-item>
            <nz-form-label nzRequired>藍圖名稱</nz-form-label>
            <nz-form-control [nzErrorTip]="'請輸入藍圖名稱'">
              <input nz-input formControlName="name" placeholder="請輸入藍圖名稱..." />
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label nzRequired>藍圖代號</nz-form-label>
            <nz-form-control [nzErrorTip]="'請輸入藍圖代號（僅允許小寫字母、數字和連字符）'">
              <input nz-input formControlName="slug" placeholder="例如：taipei-101-project" />
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label>描述</nz-form-label>
            <nz-form-control>
              <textarea
                nz-input
                formControlName="description"
                [nzAutosize]="{ minRows: 3, maxRows: 6 }"
                placeholder="藍圖簡介（選填）"
              ></textarea>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label>工地位置</nz-form-label>
            <nz-form-control>
              <input nz-input formControlName="site_location" placeholder="例如：臺北市信義區信義路五段7號" />
            </nz-form-control>
          </nz-form-item>

          <div nz-row [nzGutter]="16">
            <div nz-col nzXs="24" nzSm="12">
              <nz-form-item>
                <nz-form-label>專案狀態</nz-form-label>
                <nz-form-control>
                  <nz-select formControlName="status">
                    <nz-option [nzLabel]="'規劃中'" [nzValue]="'planning'"></nz-option>
                    <nz-option [nzLabel]="'進行中'" [nzValue]="'active'"></nz-option>
                    <nz-option [nzLabel]="'暫停'" [nzValue]="'on-hold'"></nz-option>
                    <nz-option [nzLabel]="'已完成'" [nzValue]="'completed'"></nz-option>
                    <nz-option [nzLabel]="'已歸檔'" [nzValue]="'archived'"></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div nz-col nzXs="24" nzSm="12">
              <nz-form-item>
                <nz-form-label>當前階段</nz-form-label>
                <nz-form-control>
                  <input nz-input formControlName="current_stage" placeholder="例如：設計階段" />
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>

          <div nz-row [nzGutter]="16">
            <div nz-col nzXs="24" nzSm="12">
              <nz-form-item>
                <nz-form-label>開始日期</nz-form-label>
                <nz-form-control>
                  <nz-date-picker formControlName="start_date" style="width: 100%" nzPlaceHolder="選擇開始日期"></nz-date-picker>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div nz-col nzXs="24" nzSm="12">
              <nz-form-item>
                <nz-form-label>結束日期</nz-form-label>
                <nz-form-control>
                  <nz-date-picker formControlName="end_date" style="width: 100%" nzPlaceHolder="選擇結束日期"></nz-date-picker>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>

          <nz-form-item>
            <nz-form-label>標籤</nz-form-label>
            <nz-form-control>
              <div class="tag-input-container">
                <nz-input-group [nzAddOnAfter]="addTagButton">
                  <input type="text" nz-input [ngModel]="tagInput()" (ngModelChange)="tagInput.set($event)" (keyup.enter)="addTag()" placeholder="輸入標籤並按 Enter" [ngModelOptions]="{standalone: true}" />
                </nz-input-group>
                <ng-template #addTagButton>
                  <button nz-button nzType="primary" (click)="addTag()">
                    <i nz-icon nzType="plus"></i>
                    添加
                  </button>
                </ng-template>
              </div>
              @if (tags().length > 0) {
                <div class="tags-container mt-sm">
                  @for (tag of tags(); track tag) {
                    <nz-tag nzMode="closeable" (nzOnClose)="removeTag(tag)">{{ tag }}</nz-tag>
                  }
                </div>
              }
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-control>
              <label nz-checkbox formControlName="is_private">
                <span>私有藍圖</span>
              </label>
              <div nz-form-explain>私有藍圖僅對成員可見</div>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-control>
              <button nz-button nzType="primary" [nzLoading]="saving()" [disabled]="basicForm.invalid" type="submit">
                保存設定
              </button>
            </nz-form-control>
          </nz-form-item>
        </form>
      </nz-card>
    </nz-tab>

    <!-- 成員管理標籤 -->
    <nz-tab nzTitle="成員管理">
      <nz-card [nzBordered]="false" [nzTitle]="memberTitle" [nzExtra]="memberExtra">
        <ng-template #memberTitle>
          <span>成員列表</span>
        </ng-template>
        <ng-template #memberExtra>
          <button nz-button nzType="primary" nzSize="small" (click)="openAddMemberModal()">
            <i nz-icon nzType="plus"></i>
            添加成員
          </button>
        </ng-template>

        @if (members().length === 0) {
          <nz-empty nzNotFoundContent="尚無成員"></nz-empty>
        } @else {
          <nz-table [nzData]="members()" [nzShowPagination]="false">
            <thead>
              <tr>
                <th>成員</th>
                <th>角色</th>
                <th>加入時間</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              @for (member of members(); track member.id) {
                <tr>
                  <td>
                    <div class="flex align-center gap-sm">
                      <nz-avatar [nzSrc]="member.user.avatar_url ?? undefined" [nzText]="member.user.display_name?.charAt(0)" nzSize="small"></nz-avatar>
                      <div>
                        <div>{{ member.user.display_name || member.user.email }}</div>
                        <div class="text-muted text-sm">{{ member.user.email }}</div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <nz-select
                      [ngModel]="member.role"
                      (ngModelChange)="updateMemberRole(member.id, $event)"
                      [ngModelOptions]="{standalone: true}"
                      style="width: 120px"
                    >
                      <nz-option [nzLabel]="'擁有者'" [nzValue]="'owner'"></nz-option>
                      <nz-option [nzLabel]="'管理者'" [nzValue]="'manager'"></nz-option>
                      <nz-option [nzLabel]="'成員'" [nzValue]="'member'"></nz-option>
                      <nz-option [nzLabel]="'查看者'" [nzValue]="'viewer'"></nz-option>
                    </nz-select>
                  </td>
                  <td>{{ member.joined_at | date: 'yyyy-MM-dd HH:mm' }}</td>
                  <td>
                    <button
                      nz-button
                      nzType="link"
                      nzSize="small"
                      nzDanger
                      nz-popconfirm
                      nzPopconfirmTitle="確定要移除這個成員嗎？"
                      (nzOnConfirm)="removeMember(member.id)"
                    >
                      <i nz-icon nzType="delete"></i>
                      移除
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </nz-table>
        }
      </nz-card>
    </nz-tab>

    <!-- 危險操作標籤 -->
    <nz-tab nzTitle="危險操作">
      <nz-card [nzBordered]="false" nzTitle="危險區域">
        <div class="danger-zone">
          <div class="danger-zone-item">
            <div class="danger-zone-header">
              <h3>刪除藍圖</h3>
              <button nz-button nzType="primary" nzDanger (click)="deleteBlueprint()">
                刪除藍圖
              </button>
            </div>
            <p class="text-muted">
              一旦刪除藍圖，所有相關的數據（任務、文件、進度記錄等）將被永久刪除。此操作無法撤銷。
            </p>
          </div>
        </div>
      </nz-card>
    </nz-tab>
  </nz-tabs>
} @else {
  <nz-empty nzNotFoundContent="藍圖不存在"></nz-empty>
}

<!-- 添加成員 Modal -->
<nz-modal
  [nzVisible]="showAddMemberModal()"
  (nzVisibleChange)="showAddMemberModal.set($event)"
  nzTitle="添加成員"
  (nzOnCancel)="showAddMemberModal.set(false); memberForm.reset(); searchResults.set([])"
  (nzOnOk)="onAddMember()"
  [nzOkLoading]="searchingUsers()"
>
  <div *nzModalContent>
    <form [formGroup]="memberForm" nz-form nzLayout="vertical">
      <nz-form-item>
        <nz-form-label nzRequired>用戶電子郵件</nz-form-label>
        <nz-form-control [nzErrorTip]="'請輸入有效的電子郵件地址'">
          <input nz-input formControlName="user_email" placeholder="例如：user@example.com" />
          <div nz-form-explain>輸入用戶的電子郵件地址以添加為成員</div>
        </nz-form-control>
      </nz-form-item>
      @if (searchResults().length > 0) {
        <div class="search-result">
          <div class="flex align-center gap-sm">
            <nz-avatar [nzSrc]="searchResults()[0].avatar_url ?? undefined" [nzText]="searchResults()[0].display_name?.charAt(0)" nzSize="small"></nz-avatar>
            <div>
              <div>{{ searchResults()[0].display_name || searchResults()[0].email }}</div>
              <div class="text-muted text-sm">{{ searchResults()[0].email }}</div>
            </div>
          </div>
        </div>
      }
      <nz-form-item>
        <nz-form-label nzRequired>角色</nz-form-label>
        <nz-form-control [nzErrorTip]="'請選擇角色'">
          <nz-select formControlName="role">
            <nz-option [nzLabel]="'擁有者'" [nzValue]="'owner'"></nz-option>
            <nz-option [nzLabel]="'管理者'" [nzValue]="'manager'"></nz-option>
            <nz-option [nzLabel]="'成員'" [nzValue]="'member'"></nz-option>
            <nz-option [nzLabel]="'查看者'" [nzValue]="'viewer'"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>
    </form>
  </div>
</nz-modal>
