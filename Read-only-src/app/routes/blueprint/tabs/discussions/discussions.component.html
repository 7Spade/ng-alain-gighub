@if (loading()) {
  <nz-spin nzSimple [nzSize]="'large'" style="display: block; text-align: center; padding: 50px;"></nz-spin>
} @else if (blueprint(); as bp) {
  <!-- 搜尋和創建 -->
  <nz-card [nzBordered]="false" class="mb-lg">
    <div class="flex gap-md align-center justify-between flex-wrap">
      <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton" style="width: 400px">
        <input
          type="text"
          nz-input
          [ngModel]="searchText()"
          (ngModelChange)="onSearchChange($event)"
          (keyup.enter)="onSearch()"
          placeholder="搜尋討論標題或內容..."
          [ngModelOptions]="{standalone: true}"
        />
        <ng-template #suffixIconButton>
          <button nz-button nzType="primary" nzSearch (click)="onSearch()">
            <i nz-icon nzType="search"></i>
          </button>
        </ng-template>
      </nz-input-group>

      <button nz-button nzType="primary" (click)="openCreateDiscussionModal()">
        <i nz-icon nzType="plus"></i>
        <span>新建討論</span>
      </button>
    </div>
  </nz-card>

  <!-- 討論列表 -->
  <nz-card [nzBordered]="false" nzTitle="討論與評論">
    @if (filteredDiscussions().length === 0) {
      <nz-empty nzNotFoundContent="尚無討論">
        <button *nzButton="null" nz-button nzType="primary" (click)="openCreateDiscussionModal()">
          <i nz-icon nzType="plus"></i>
          <span>創建第一個討論</span>
        </button>
      </nz-empty>
    } @else {
      <nz-list [nzDataSource]="filteredDiscussions()" nzSize="large">
        <ng-template #item let-item>
          <nz-list-item>
            <nz-list-item-meta [nzTitle]="title" [nzDescription]="description">
              <ng-template #title>
                <div class="flex align-center gap-sm">
                  @if (item.is_pinned) {
                    <i nz-icon nzType="pushpin" nzTheme="fill" style="color: #1890ff;"></i>
                  }
                  <a class="text-lg">{{ item.title }}</a>
                </div>
              </ng-template>
              <ng-template #description>
                <div class="text-muted">{{ item.content | slice: 0:100 }}{{ item.content.length > 100 ? '...' : '' }}</div>
                <div class="flex align-center gap-sm mt-xs flex-wrap">
                  @for (tag of item.tags; track tag) {
                    <nz-tag nzSize="small">{{ tag }}</nz-tag>
                  }
                </div>
              </ng-template>
              <ng-template #nzAvatar>
                <nz-avatar [nzSrc]="item.author_avatar ?? undefined" [nzText]="item.author_name?.charAt(0)"></nz-avatar>
              </ng-template>
            </nz-list-item-meta>
            <div class="flex align-center gap-md">
              <div class="text-muted text-sm">
                <i nz-icon nzType="message"></i>
                <span class="ml-xs">{{ item.comment_count }}</span>
              </div>
              <div class="text-muted text-sm">
                {{ item.updated_at | date: 'yyyy-MM-dd HH:mm' }}
              </div>
            </div>
          </nz-list-item>
        </ng-template>
      </nz-list>
    }
  </nz-card>
} @else {
  <nz-empty nzNotFoundContent="藍圖不存在"></nz-empty>
}

<!-- 創建/編輯討論 Modal -->
<nz-modal
  [nzVisible]="showDiscussionModal()"
  (nzVisibleChange)="showDiscussionModal.set($event)"
  [nzTitle]="editingDiscussion() ? '編輯討論' : '新建討論'"
  (nzOnCancel)="onCancel()"
  (nzOnOk)="onCreateSubmit()"
  [nzOkText]="'發布'"
  [nzCancelText]="'取消'"
  [nzWidth]="800"
>
  <div *nzModalContent>
    <form [formGroup]="discussionForm" nz-form nzLayout="vertical">
      <nz-form-item>
        <nz-form-label nzRequired>標題</nz-form-label>
        <nz-form-control [nzErrorTip]="'請輸入討論標題'">
          <input nz-input formControlName="title" placeholder="請輸入討論標題..." />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired>內容</nz-form-label>
        <nz-form-control [nzErrorTip]="'請輸入討論內容'">
          <textarea
            nz-input
            formControlName="content"
            [nzAutosize]="{ minRows: 6, maxRows: 12 }"
            placeholder="請輸入討論內容..."
          ></textarea>
        </nz-form-control>
      </nz-form-item>
    </form>
  </div>
</nz-modal>
