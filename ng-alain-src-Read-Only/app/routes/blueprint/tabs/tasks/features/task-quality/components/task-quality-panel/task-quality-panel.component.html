<div class="task-quality-panel">
  <div class="panel-header" nz-row [nzGutter]="16">
    <div nz-col nzXs="24" nzSm="12" nzMd="6">
      <div class="text-center">
        <div class="text-lg text-primary">{{ totalChecks() }}</div>
        <div class="text-muted">總檢查數</div>
      </div>
    </div>
    <div nz-col nzXs="24" nzSm="12" nzMd="6">
      <div class="text-center">
        <div class="text-lg text-success">{{ passedCount() }}</div>
        <div class="text-muted">已通過</div>
      </div>
    </div>
    <div nz-col nzXs="24" nzSm="12" nzMd="6">
      <div class="text-center">
        <div class="text-lg text-warning">{{ inProgressCount() }}</div>
        <div class="text-muted">檢查中</div>
      </div>
    </div>
    <div nz-col nzXs="24" nzSm="12" nzMd="6">
      <div class="text-center">
        <div class="text-lg text-danger">{{ failedCount() }}</div>
        <div class="text-muted">需改進</div>
      </div>
    </div>
  </div>

  <nz-card [nzBordered]="false" class="mb-lg">
    <div class="flex gap-md align-center flex-wrap">
      <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton" style="width: 300px">
        <input
          type="text"
          nz-input
          [ngModel]="searchText()"
          (ngModelChange)="setSearch($event)"
          (keyup.enter)="setSearch(searchText())"
          placeholder="搜尋檢查項目..."
          [ngModelOptions]="{ standalone: true }"
        />
        <ng-template #suffixIconButton>
          <button nz-button nzType="primary" nzSearch (click)="setSearch(searchText())">
            <i nz-icon nzType="search"></i>
          </button>
        </ng-template>
      </nz-input-group>

      <nz-select
        [ngModel]="categoryFilter()"
        (ngModelChange)="setCategory($event)"
        style="width: 150px"
        [ngModelOptions]="{ standalone: true }"
      >
        <nz-option [nzLabel]="'全部分類'" [nzValue]="'all'"></nz-option>
        <nz-option [nzLabel]="'安全'" [nzValue]="'safety'"></nz-option>
        <nz-option [nzLabel]="'結構'" [nzValue]="'structure'"></nz-option>
        <nz-option [nzLabel]="'材料'" [nzValue]="'material'"></nz-option>
        <nz-option [nzLabel]="'工藝'" [nzValue]="'process'"></nz-option>
        <nz-option [nzLabel]="'文檔'" [nzValue]="'documentation'"></nz-option>
        <nz-option [nzLabel]="'其他'" [nzValue]="'other'"></nz-option>
      </nz-select>

      <nz-select
        [ngModel]="statusFilter()"
        (ngModelChange)="setStatus($event)"
        style="width: 150px"
        [ngModelOptions]="{ standalone: true }"
      >
        <nz-option [nzLabel]="'全部狀態'" [nzValue]="'all'"></nz-option>
        <nz-option [nzLabel]="'待檢查'" [nzValue]="'pending'"></nz-option>
        <nz-option [nzLabel]="'檢查中'" [nzValue]="'in-progress'"></nz-option>
        <nz-option [nzLabel]="'通過'" [nzValue]="'passed'"></nz-option>
        <nz-option [nzLabel]="'未通過'" [nzValue]="'failed'"></nz-option>
        <nz-option [nzLabel]="'需改進'" [nzValue]="'needs-improvement'"></nz-option>
      </nz-select>

      <button nz-button nzType="primary" (click)="openCreate()" [disabled]="saving() || loading()">
        <i nz-icon nzType="plus"></i>
        <span>新建檢查</span>
      </button>
    </div>
  </nz-card>

  <nz-card [nzBordered]="false" nzTitle="品質管理">
    @if (filteredQualityChecks().length === 0) {
      <nz-empty nzNotFoundContent="尚無品質檢查記錄">
        <button *nzButton="null" nz-button nzType="primary" (click)="openCreate()" [disabled]="saving() || loading()">
          <i nz-icon nzType="plus"></i>
          <span>創建第一個品質檢查</span>
        </button>
      </nz-empty>
    } @else {
      <st
        [data]="filteredQualityChecks()"
        [columns]="[
          { title: '檢查項目', render: 'title' },
          { title: '分類', render: 'category' },
          { title: '狀態', render: 'status' },
          { title: '評分', render: 'score' },
          { title: '檢查員', render: 'inspector' },
          { title: '檢查日期', index: 'check_date', type: 'date' },
          { title: '操作', render: 'actions' }
        ]"
        [page]="{ show: true, showSize: true }"
        size="small"
      >
        <ng-template #title let-item>
          <div class="flex align-center gap-sm">
            <nz-tag [nzColor]="getCategoryColor(item.category)" nzSize="small">
              {{ getCategoryText(item.category) }}
            </nz-tag>
            <span class="font-medium">{{ item.title }}</span>
          </div>
        </ng-template>
        <ng-template #category let-item>
          <nz-tag [nzColor]="getCategoryColor(item.category)">
            {{ getCategoryText(item.category) }}
          </nz-tag>
        </ng-template>
        <ng-template #status let-item>
          <nz-tag [nzColor]="getStatusColor(item.status)">
            {{ getStatusText(item.status) }}
          </nz-tag>
        </ng-template>
        <ng-template #score let-item>
          @if (item.score !== null && item.score !== undefined) {
            <div class="flex align-center gap-sm">
              <nz-progress
                [nzPercent]="item.score"
                [nzStatus]="item.score >= 80 ? 'success' : item.score >= 60 ? 'active' : 'exception'"
                [nzShowInfo]="true"
                [nzFormat]="formatScore"
                style="width: 100px"
              ></nz-progress>
            </div>
          } @else {
            <span class="text-muted">未評分</span>
          }
        </ng-template>
        <ng-template #inspector let-item>
          @if (item.inspector) {
            <span>{{ item.inspector.display_name || item.inspector.email }}</span>
          } @else {
            <span class="text-muted">未指定</span>
          }
        </ng-template>
        <ng-template #actions let-item>
          <button nz-button nzType="link" nzSize="small" (click)="editQuality(item)">
            <i nz-icon nzType="edit"></i>
            編輯
          </button>
          <button nz-button nzType="link" nzDanger nzSize="small" (click)="deleteQuality(item)">
            <i nz-icon nzType="delete"></i>
            刪除
          </button>
        </ng-template>
      </st>
    }
  </nz-card>

  <nz-modal
    [nzVisible]="showForm()"
    (nzVisibleChange)="onModalVisibleChange($event)"
    [nzTitle]="editingQuality() ? '編輯品質檢查' : '新建品質檢查'"
    [nzWidth]="800"
    [nzFooter]="null"
  >
    <task-quality-form
      [blueprintId]="blueprintId()"
      [members]="members()"
      [editingQuality]="editingQuality()"
      (saved)="onFormSaved()"
      (cancelled)="onFormCancelled()"
    ></task-quality-form>
  </nz-modal>
</div>
