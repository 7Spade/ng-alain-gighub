@if (loading()) {
  <nz-spin nzSimple [nzSize]="'large'" style="display: block; text-align: center; padding: 50px;"></nz-spin>
} @else if (aggregation()) {
  <!-- 統計卡片區域 -->
  <nz-card [nzBordered]="false" class="mb-lg">
    <div nz-row [nzGutter]="16">
      <div nz-col nzXs="24" nzSm="12" nzMd="6">
        <nz-card [nzBordered]="false" class="text-center">
          <number-info [total]="totalTasks()" subTitle="總任務數" suffix="個" [subTotal]="taskCompletionTrend()" [status]="taskCompletionTrend() > 50 ? 'up' : 'down'" />
          <g2-mini-progress [percent]="taskCompletionTrend()" [strokeWidth]="8" />
        </nz-card>
      </div>
      <div nz-col nzXs="24" nzSm="12" nzMd="6">
        <nz-card [nzBordered]="false" class="text-center">
          <number-info [total]="completedTasks()" subTitle="已完成" suffix="個" [subTotal]="taskCompletionTrend()" [status]="'up'" />
        </nz-card>
      </div>
      <div nz-col nzXs="24" nzSm="12" nzMd="6">
        <nz-card [nzBordered]="false" class="text-center">
          <number-info [total]="totalMilestones()" subTitle="里程碑" suffix="個" [subTotal]="milestoneCompletionTrend()" [status]="milestoneCompletionTrend() > 50 ? 'up' : 'down'" />
          <g2-mini-progress [percent]="milestoneCompletionTrend()" [strokeWidth]="8" />
        </nz-card>
      </div>
      <div nz-col nzXs="24" nzSm="12" nzMd="6">
        <nz-card [nzBordered]="false" class="text-center">
          <number-info [total]="totalDailyReports()" subTitle="施工日誌" suffix="筆" />
        </nz-card>
      </div>
    </div>
  </nz-card>

  <!-- 主要圖表區域 - 第一行 -->
  <div nz-row [nzGutter]="16">
    <!-- 任務狀態分佈 -->
    <div nz-col nzXs="24" nzSm="12" nzMd="8" class="mb-lg">
      <nz-card [nzBordered]="false" nzTitle="任務狀態分佈">
        @if (taskStatusData().length > 0) {
          <g2-pie [data]="taskStatusData()" height="300" [inner]="0.6" [hasLegend]="true" (ready)="fixDark($event)" />
        } @else {
          <nz-empty nzNotFoundContent="尚無數據"></nz-empty>
        }
      </nz-card>
    </div>

    <!-- 任務完成率儀表盤 -->
    <div nz-col nzXs="24" nzSm="12" nzMd="8" class="mb-lg">
      <nz-card [nzBordered]="false" nzTitle="任務完成率" [nzBodyStyle]="{ 'text-align': 'center' }">
        @if (totalTasks() > 0) {
          <g2-gauge [title]="'完成率'" [height]="300" [percent]="taskCompletionRate()" />
        } @else {
          <nz-empty nzNotFoundContent="尚無任務"></nz-empty>
        }
      </nz-card>
    </div>

    <!-- 里程碑完成度水波圖 -->
    <div nz-col nzXs="24" nzSm="12" nzMd="8" class="mb-lg">
      <nz-card [nzBordered]="false" nzTitle="里程碑完成度" [nzBodyStyle]="{ 'text-align': 'center' }">
        @if (totalMilestones() > 0) {
          <g2-water-wave [title]="'完成度'" [percent]="milestoneCompletionRate()" [height]="300" />
        } @else {
          <nz-empty nzNotFoundContent="尚無里程碑"></nz-empty>
        }
      </nz-card>
    </div>
  </div>

  <!-- 主要圖表區域 - 第二行 -->
  <div nz-row [nzGutter]="16">
    <!-- 任務優先級分佈 -->
    <div nz-col nzXs="24" nzSm="12" nzMd="12" class="mb-lg">
      <nz-card [nzBordered]="false" nzTitle="任務優先級分佈">
        @if (taskPriorityData().length > 0) {
          <g2-bar [data]="taskPriorityData()" height="300" [padding]="[20, 30]" (ready)="fixDark($event)" />
        } @else {
          <nz-empty nzNotFoundContent="尚無數據"></nz-empty>
        }
      </nz-card>
    </div>

    <!-- 任務優先級雷達圖 -->
    <div nz-col nzXs="24" nzSm="12" nzMd="12" class="mb-lg">
      <nz-card [nzBordered]="false" nzTitle="任務狀態與優先級分析">
        @if (taskPriorityRadarData().length > 0) {
          <g2-radar [data]="taskPriorityRadarData()" height="300" (ready)="fixDark($event)" />
        } @else {
          <nz-empty nzNotFoundContent="尚無數據"></nz-empty>
        }
      </nz-card>
    </div>
  </div>

  <!-- 主要圖表區域 - 第三行 -->
  <div nz-row [nzGutter]="16">
    <!-- 進度趨勢 -->
    <div nz-col nzXs="24" nzSm="12" nzMd="12" class="mb-lg">
      <nz-card [nzBordered]="false" nzTitle="進度趨勢">
        @if (progressTrendData().length > 0) {
          <g2-mini-area [data]="progressTrendData()" height="300" [padding]="[20, 30]" [color]="'#1890ff'" (ready)="fixDark($event)" />
        } @else {
          <nz-empty nzNotFoundContent="尚無進度記錄"></nz-empty>
        }
      </nz-card>
    </div>

    <!-- 進度與任務關聯組合圖 -->
    <div nz-col nzXs="24" nzSm="12" nzMd="12" class="mb-lg">
      <nz-card [nzBordered]="false" nzTitle="進度與任務關聯">
        @if (progressTaskCombinedData().length > 0) {
          <chart-echarts [option]="getEChartsOption()" height="300" />
        } @else {
          <nz-empty nzNotFoundContent="尚無數據"></nz-empty>
        }
      </nz-card>
    </div>
  </div>

  <!-- 里程碑和時間軸區域 -->
  <div nz-row [nzGutter]="16">
    <!-- 里程碑狀態 -->
    <div nz-col nzXs="24" nzSm="12" nzMd="12" class="mb-lg">
      <nz-card [nzBordered]="false" nzTitle="里程碑狀態">
        @if (milestoneStatusData().length > 0) {
          <g2-pie [data]="milestoneStatusData()" height="300" [hasLegend]="true" (ready)="fixDark($event)" />
        } @else {
          <nz-empty nzNotFoundContent="尚無里程碑"></nz-empty>
        }
      </nz-card>
    </div>

    <!-- 任務/里程碑時間軸 -->
    <div nz-col nzXs="24" nzSm="12" nzMd="12" class="mb-lg">
      <nz-card [nzBordered]="false" nzTitle="任務與里程碑時間軸">
        @if (taskTimelineData().length > 0) {
          <g2-timeline [data]="taskTimelineData()" height="300" (ready)="fixDark($event)" />
        } @else {
          <nz-empty nzNotFoundContent="尚無時間軸數據"></nz-empty>
        }
      </nz-card>
    </div>
  </div>

  <!-- 施工日誌相關圖表區域 -->
  @if (totalDailyReports() > 0) {
    <div nz-row [nzGutter]="16">
      <!-- 施工日誌時間序列 -->
      <div nz-col nzXs="24" nzSm="12" nzMd="12" class="mb-lg">
        <nz-card [nzBordered]="false" nzTitle="施工日誌時間序列">
          @if (dailyReportTimeSeriesData().length > 0) {
            <g2-mini-area [data]="dailyReportTimeSeriesData()" height="300" [padding]="[20, 30]" [color]="'#52c41a'" (ready)="fixDark($event)" />
          } @else {
            <nz-empty nzNotFoundContent="尚無施工日誌"></nz-empty>
          }
        </nz-card>
      </div>

      <!-- 每日活動統計 -->
      <div nz-col nzXs="24" nzSm="12" nzMd="12" class="mb-lg">
        <nz-card [nzBordered]="false" nzTitle="每日活動統計">
          @if (dailyActivityData().length > 0) {
            <g2-mini-bar [data]="dailyActivityData()" height="300" [padding]="[20, 30]" [color]="'#faad14'" (ready)="fixDark($event)" />
          } @else {
            <nz-empty nzNotFoundContent="尚無活動數據"></nz-empty>
          }
        </nz-card>
      </div>
    </div>

    <div nz-row [nzGutter]="16">
      <!-- 天氣分佈 -->
      <div nz-col nzXs="24" nzSm="12" nzMd="8" class="mb-lg">
        <nz-card [nzBordered]="false" nzTitle="天氣分佈">
          @if (weatherDistributionData().length > 0) {
            <g2-pie [data]="weatherDistributionData()" height="300" [hasLegend]="true" (ready)="fixDark($event)" />
          } @else {
            <nz-empty nzNotFoundContent="尚無天氣數據"></nz-empty>
          }
        </nz-card>
      </div>

      <!-- 參與人員統計 -->
      <div nz-col nzXs="24" nzSm="12" nzMd="8" class="mb-lg">
        <nz-card [nzBordered]="false" nzTitle="參與人員統計">
          @if (participantStatsData().length > 0) {
            <g2-bar [data]="participantStatsData()" height="300" [padding]="[20, 30]" (ready)="fixDark($event)" />
          } @else {
            <nz-empty nzNotFoundContent="尚無參與人員數據"></nz-empty>
          }
        </nz-card>
      </div>

      <!-- 問題記錄統計 -->
      <div nz-col nzXs="24" nzSm="12" nzMd="8" class="mb-lg">
        <nz-card [nzBordered]="false" nzTitle="問題記錄統計">
          @if (issuesStatsData().length > 0) {
            <g2-pie [data]="issuesStatsData()" height="300" [hasLegend]="true" (ready)="fixDark($event)" />
          } @else {
            <nz-empty nzNotFoundContent="尚無問題記錄"></nz-empty>
          }
        </nz-card>
      </div>
    </div>
  }

  <!-- 任務標籤雲 -->
  @if (taskTagCloudData().length > 0) {
    <div nz-row [nzGutter]="16">
      <div nz-col nzXs="24" class="mb-lg">
        <nz-card [nzBordered]="false" nzTitle="任務標籤雲">
          <g2-tag-cloud [data]="taskTagCloudData()" height="300" />
        </nz-card>
      </div>
    </div>
  }
} @else {
  <nz-empty nzNotFoundContent="暫無聚合資料"></nz-empty>
}
