<page-header [title]="'藍圖管理'" />
<nz-card [nzBordered]="false">
  <div class="flex justify-between align-center mb-md">
    <div>
      <h2 class="mb-0">藍圖管理</h2>
      <p class="text-muted mb-0">管理工地專案進度追蹤</p>
    </div>
    <a nz-button nzType="primary" nzSize="large" [routerLink]="['/blueprint','new']">
      <i nz-icon nzType="plus"></i>
      <span>建立藍圖</span>
    </a>
  </div>

  <!-- 搜尋和篩選 -->
  <nz-card [nzBordered]="false" class="mb-md">
    <div class="flex gap-md align-center">
      <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton" style="width: 300px">
        <input type="text" nz-input [ngModel]="searchText()" (ngModelChange)="searchText.set($event)"
          placeholder="搜尋藍圖名稱、代號或描述..." />
        <ng-template #suffixIconButton>
          <button nz-button nzType="primary" nzSearch>
            <i nz-icon nzType="search"></i>
          </button>
        </ng-template>
      </nz-input-group>

      <nz-select [ngModel]="statusFilter()" (ngModelChange)="statusFilter.set($event)" style="width: 150px"
        placeholder="狀態">
        <nz-option [nzLabel]="'全部'" [nzValue]="'all'"></nz-option>
        <nz-option [nzLabel]="'規劃中'" [nzValue]="'planning'"></nz-option>
        <nz-option [nzLabel]="'進行中'" [nzValue]="'active'"></nz-option>
        <nz-option [nzLabel]="'暫停'" [nzValue]="'on-hold'"></nz-option>
        <nz-option [nzLabel]="'已完成'" [nzValue]="'completed'"></nz-option>
        <nz-option [nzLabel]="'已歸檔'" [nzValue]="'archived'"></nz-option>
      </nz-select>

      <nz-select [ngModel]="isPrivateFilter()" (ngModelChange)="isPrivateFilter.set($event)" style="width: 120px"
        placeholder="可見性">
        <nz-option [nzLabel]="'全部'" [nzValue]="'all'"></nz-option>
        <nz-option [nzLabel]="'公開'" [nzValue]="'public'"></nz-option>
        <nz-option [nzLabel]="'私有'" [nzValue]="'private'"></nz-option>
      </nz-select>
    </div>
  </nz-card>

  @if (loading()) {
  <nz-spin nzSimple [nzSize]="'large'" style="display: block; text-align: center; padding: 50px;"></nz-spin>
  } @else if (filteredBlueprints().length === 0) {
  <nz-empty nzNotFoundContent="尚無藍圖">
    <button *nzButton="null" nz-button nzType="primary" nzSize="large" (click)="openCreateModal()">
      <i nz-icon nzType="plus"></i>
      <span>建立第一個藍圖</span>
    </button>
  </nz-empty>
  } @else {
  <st #st [columns]="columns" [data]="filteredBlueprints()" [loading]="loading()" (change)="stChange($event)"
    (rowClick)="onRowClick($any($event))">
    <ng-template st-row="name" let-i>
      <div class="flex align-center gap-sm">
        @if (i.avatar_url) {
        <nz-avatar [nzSrc]="i.avatar_url" nzSize="small"></nz-avatar>
        } @else {
        <nz-avatar nzText="藍" nzSize="small"></nz-avatar>
        }
        <a (click)="navigateToDetail(i); $event.stopPropagation()" class="font-medium">
          {{ i.name }}
        </a>
      </div>
    </ng-template>
    <ng-template st-row="progress" let-i>
      <nz-progress [nzPercent]="i.progress_percentage"
        [nzStatus]="i.progress_percentage === 100 ? 'success' : 'active'"></nz-progress>
    </ng-template>
    <ng-template st-row="status" let-i>
      <nz-tag [nzColor]="getStatusColor(i.status)">
        {{ getStatusText(i.status) }}
      </nz-tag>
    </ng-template>
    <ng-template st-row="action" let-i>
      <button nz-button nzSize="small" nzType="link" (click)="navigateToDetail(i); $event.stopPropagation()">
        查看
      </button>
      <button nz-button nzSize="small" nzType="link" nzDanger (click)="deleteBlueprint(i); $event.stopPropagation()">
        刪除
      </button>
    </ng-template>
  </st>
  }
</nz-card>