@if (loading()) {
  <nz-spin nzSimple [nzSize]="'large'" style="display: block; text-align: center; padding: 50px;"></nz-spin>
} @else if (blueprint(); as bp) {
  <!-- 統計卡片 -->
  <nz-card [nzBordered]="false" class="mb-lg">
    <div nz-row [nzGutter]="16">
      <div nz-col nzXs="24" nzSm="12" nzMd="6">
        <div class="text-center">
          <div class="text-lg text-primary">{{ issues().length }}</div>
          <div class="text-muted">總問題數</div>
        </div>
      </div>
      <div nz-col nzXs="24" nzSm="12" nzMd="6">
        <div class="text-center">
          <div class="text-lg text-danger">{{ openCount() }}</div>
          <div class="text-muted">開啟中</div>
        </div>
      </div>
      <div nz-col nzXs="24" nzSm="12" nzMd="6">
        <div class="text-center">
          <div class="text-lg text-warning">{{ inProgressCount() }}</div>
          <div class="text-muted">處理中</div>
        </div>
      </div>
      <div nz-col nzXs="24" nzSm="12" nzMd="6">
        <div class="text-center">
          <div class="text-lg text-success">{{ resolvedCount() }}</div>
          <div class="text-muted">已解決</div>
        </div>
      </div>
    </div>
  </nz-card>

  <!-- 搜尋和篩選 -->
  <nz-card [nzBordered]="false" class="mb-lg">
    <div class="flex gap-md align-center flex-wrap">
      <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton" style="width: 300px">
        <input
          type="text"
          nz-input
          [ngModel]="searchText()"
          (ngModelChange)="searchText.set($event)"
          (keyup.enter)="onSearch()"
          placeholder="搜尋問題標題或描述..."
          [ngModelOptions]="{standalone: true}"
        />
        <ng-template #suffixIconButton>
          <button nz-button nzType="primary" nzSearch (click)="onSearch()">
            <i nz-icon nzType="search"></i>
          </button>
        </ng-template>
      </nz-input-group>

      <nz-select
        [ngModel]="statusFilter()"
        (ngModelChange)="statusFilter.set($event); onFilterChange()"
        style="width: 120px"
        [ngModelOptions]="{standalone: true}"
      >
        <nz-option [nzLabel]="'全部狀態'" [nzValue]="'all'"></nz-option>
        <nz-option [nzLabel]="'開啟'" [nzValue]="'open'"></nz-option>
        <nz-option [nzLabel]="'處理中'" [nzValue]="'in-progress'"></nz-option>
        <nz-option [nzLabel]="'已解決'" [nzValue]="'resolved'"></nz-option>
        <nz-option [nzLabel]="'已關閉'" [nzValue]="'closed'"></nz-option>
        <nz-option [nzLabel]="'已取消'" [nzValue]="'cancelled'"></nz-option>
      </nz-select>

      <nz-select
        [ngModel]="priorityFilter()"
        (ngModelChange)="priorityFilter.set($event); onFilterChange()"
        style="width: 120px"
        [ngModelOptions]="{standalone: true}"
      >
        <nz-option [nzLabel]="'全部優先級'" [nzValue]="'all'"></nz-option>
        <nz-option [nzLabel]="'低'" [nzValue]="'low'"></nz-option>
        <nz-option [nzLabel]="'中'" [nzValue]="'medium'"></nz-option>
        <nz-option [nzLabel]="'高'" [nzValue]="'high'"></nz-option>
        <nz-option [nzLabel]="'危急'" [nzValue]="'critical'"></nz-option>
      </nz-select>

      <nz-select
        [ngModel]="severityFilter()"
        (ngModelChange)="severityFilter.set($event); onFilterChange()"
        style="width: 120px"
        [ngModelOptions]="{standalone: true}"
      >
        <nz-option [nzLabel]="'全部嚴重性'" [nzValue]="'all'"></nz-option>
        <nz-option [nzLabel]="'低'" [nzValue]="'low'"></nz-option>
        <nz-option [nzLabel]="'中'" [nzValue]="'medium'"></nz-option>
        <nz-option [nzLabel]="'高'" [nzValue]="'high'"></nz-option>
        <nz-option [nzLabel]="'危急'" [nzValue]="'critical'"></nz-option>
      </nz-select>

      <button nz-button nzType="primary" (click)="openCreateIssueModal()">
        <i nz-icon nzType="plus"></i>
        <span>新建問題</span>
      </button>
    </div>
  </nz-card>

  <!-- 問題列表 -->
  <nz-card [nzBordered]="false" nzTitle="問題追蹤">
    @if (filteredIssues().length === 0) {
      <nz-empty nzNotFoundContent="尚無問題">
        <button *nzButton="null" nz-button nzType="primary" (click)="openCreateIssueModal()">
          <i nz-icon nzType="plus"></i>
          <span>創建第一個問題</span>
        </button>
      </nz-empty>
    } @else {
      <st
        [data]="filteredIssues()"
        [columns]="columns"
        [page]="{ show: true, showSize: true }"
        size="small"
      >
        <ng-template #title let-item>
          <div class="flex align-center gap-sm">
            <nz-badge [nzText]="getStatusText(item.status)"></nz-badge>
            <a class="font-medium">{{ item.title }}</a>
          </div>
        </ng-template>
        <ng-template #status let-item>
          <nz-tag [nzColor]="getStatusColor(item.status)">
            {{ getStatusText(item.status) }}
          </nz-tag>
        </ng-template>
        <ng-template #priority let-item>
          <nz-tag [nzColor]="getPriorityColor(item.priority)">
            {{ getPriorityText(item.priority) }}
          </nz-tag>
        </ng-template>
        <ng-template #severity let-item>
          <nz-tag [nzColor]="getSeverityColor(item.severity)">
            {{ getSeverityText(item.severity) }}
          </nz-tag>
        </ng-template>
        <ng-template #assigned let-item>
          @if (item.assigned_user) {
            <span>{{ item.assigned_user.display_name || item.assigned_user.email }}</span>
          } @else {
            <span class="text-muted">未分配</span>
          }
        </ng-template>
        <ng-template #actions let-item>
          <button nz-button nzType="link" nzSize="small" (click)="editIssue(item)">
            <i nz-icon nzType="edit"></i>
            編輯
          </button>
        </ng-template>
      </st>
    }
  </nz-card>
} @else {
  <nz-empty nzNotFoundContent="藍圖不存在"></nz-empty>
}

<!-- 創建/編輯問題 Modal -->
<nz-modal
  [nzVisible]="showIssueModal()"
  (nzVisibleChange)="showIssueModal.set($event)"
  [nzTitle]="editingIssue() ? '編輯問題' : '新建問題'"
  (nzOnCancel)="onCancel()"
  [nzWidth]="800"
>
  <div *nzModalFooter class="flex justify-end gap-sm">
    <button nz-button (click)="onCancel()">取消</button>
    <button nz-button nzType="primary" (click)="onCreateSubmit()">
      {{ editingIssue() ? '保存' : '建立' }}
    </button>
  </div>
  <div *nzModalContent>
    <form [formGroup]="issueForm" nz-form nzLayout="vertical">
      <nz-form-item>
        <nz-form-label nzRequired>標題</nz-form-label>
        <nz-form-control [nzErrorTip]="'請輸入問題標題'">
          <input nz-input formControlName="title" placeholder="請輸入問題標題..." />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired>描述</nz-form-label>
        <nz-form-control [nzErrorTip]="'請輸入問題描述'">
          <textarea
            nz-input
            formControlName="description"
            [nzAutosize]="{ minRows: 6, maxRows: 12 }"
            placeholder="請詳細描述問題..."
          ></textarea>
        </nz-form-control>
      </nz-form-item>

      <div nz-row [nzGutter]="16">
        <div nz-col nzXs="24" nzSm="8">
          <nz-form-item>
            <nz-form-label nzRequired>狀態</nz-form-label>
            <nz-form-control>
              <nz-select formControlName="status">
                <nz-option [nzLabel]="'開啟'" [nzValue]="'open'"></nz-option>
                <nz-option [nzLabel]="'處理中'" [nzValue]="'in-progress'"></nz-option>
                <nz-option [nzLabel]="'已解決'" [nzValue]="'resolved'"></nz-option>
                <nz-option [nzLabel]="'已關閉'" [nzValue]="'closed'"></nz-option>
                <nz-option [nzLabel]="'已取消'" [nzValue]="'cancelled'"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col nzXs="24" nzSm="8">
          <nz-form-item>
            <nz-form-label nzRequired>優先級</nz-form-label>
            <nz-form-control>
              <nz-select formControlName="priority">
                <nz-option [nzLabel]="'低'" [nzValue]="'low'"></nz-option>
                <nz-option [nzLabel]="'中'" [nzValue]="'medium'"></nz-option>
                <nz-option [nzLabel]="'高'" [nzValue]="'high'"></nz-option>
                <nz-option [nzLabel]="'危急'" [nzValue]="'critical'"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col nzXs="24" nzSm="8">
          <nz-form-item>
            <nz-form-label nzRequired>嚴重性</nz-form-label>
            <nz-form-control>
              <nz-select formControlName="severity">
                <nz-option [nzLabel]="'低'" [nzValue]="'low'"></nz-option>
                <nz-option [nzLabel]="'中'" [nzValue]="'medium'"></nz-option>
                <nz-option [nzLabel]="'高'" [nzValue]="'high'"></nz-option>
                <nz-option [nzLabel]="'危急'" [nzValue]="'critical'"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <div nz-row [nzGutter]="16">
        <div nz-col nzXs="24" nzSm="12">
          <nz-form-item>
            <nz-form-label>負責人</nz-form-label>
            <nz-form-control>
              <nz-select formControlName="assigned_to" nzAllowClear nzPlaceHolder="選擇負責人">
                @for (member of members(); track member.id) {
                  <nz-option
                    [nzLabel]="member.user ? (member.user.display_name || member.user.email || '未命名成員') : '未命名成員'"
                    [nzValue]="member.user_id"
                  ></nz-option>
                }
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col nzXs="24" nzSm="12">
          <nz-form-item>
            <nz-form-label>截止日期</nz-form-label>
            <nz-form-control>
              <nz-date-picker formControlName="due_date" style="width: 100%" nzPlaceHolder="選擇截止日期"></nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
    </form>
  </div>
</nz-modal>
