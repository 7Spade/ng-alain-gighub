@if (loading()) {
<nz-spin nzSimple [nzSize]="'large'" style="display: block; text-align: center; padding: 50px;"></nz-spin>
} @else {
<nz-card [nzBordered]="false" class="mb-lg">
  <div class="flex gap-md align-center flex-wrap">
    <div class="flex align-center gap-sm">
      <span class="text-muted">資料集：</span>
      <nz-select style="width: 200px;" [ngModel]="selectedDataset()" (ngModelChange)="onDatasetChange($event)"
        [nzOptions]="datasetOptions" [nzBorderless]="true">
      </nz-select>
    </div>
    <div class="flex align-center gap-sm">
      <span class="text-muted">查詢地點：</span>
      <nz-select style="width: 200px;" [ngModel]="selectedLocation()" (ngModelChange)="onLocationChange($event)"
        [nzShowSearch]="true" [nzOptions]="cityOptions" [nzPlaceHolder]="'請選擇縣市'">
      </nz-select>
    </div>
    @if (blueprint(); as bp) {
    @if (bp.site_location) {
    <nz-tag [nzColor]="'blue'">工地位置：{{ bp.site_location }}</nz-tag>
    }
    } @else {
    <nz-tag [nzColor]="'gold'">使用預設地點顯示天氣資訊</nz-tag>
    }
    <button nz-button nzType="default" nzSize="small" (click)="refreshWeather()" [disabled]="weatherLoading()">
      <i nz-icon nzType="reload" nzTheme="outline"></i>
      重新載入
    </button>
  </div>
  <div class="flex gap-sm align-center flex-wrap mt-md">
    <nz-tag>{{ currentDatasetSource() }}</nz-tag>
    @if (lastUpdated(); as updated) {
    <span class="text-muted">最後更新：{{ updated | date: 'yyyy/MM/dd HH:mm' }}</span>
    }
  </div>
</nz-card>

@if (!blueprint()) {
<nz-alert nzType="warning" nzShowIcon class="mb-md"
  [nzMessage]="'尚未載入藍圖詳情，改用預設縣市（臺北市）顯示天氣預報。'"></nz-alert>
}

@if (errorMessage(); as error) {
<nz-alert nzType="error" [nzMessage]="error" nzShowIcon class="mb-md"></nz-alert>
}

@if (weatherLoading()) {
<nz-card [nzBordered]="false">
  <nz-spin nzSimple [nzSize]="'large'" style="display: block; text-align: center; padding: 50px;"></nz-spin>
</nz-card>
} @else if (forecastView(); as forecast) {
@if (highlightForecast(); as highlight) {
<nz-card [nzBordered]="false" class="mb-md weather-highlight">
  <div nz-row nzGutter="16" class="highlight-row">
    <div nz-col nzXs="24" nzMd="12" class="highlight-main">
      <div class="highlight-temp">{{ highlight.temperature }}</div>
      <div class="highlight-meta">
        @if (highlight.rainProbability) {
        <span>降雨機率：{{ highlight.rainProbability }}</span>
        }
        @if (highlight.humidity) {
        <span>舒適度：{{ highlight.humidity }}</span>
        }
        @if (highlight.windSpeed) {
        <span>天氣狀況：{{ highlight.windSpeed }}</span>
        }
      </div>
      <p class="text-muted mb-0">資料集：{{ forecast.datasetId }}</p>
      <p class="text-muted mb-0">地點：{{ forecast.locationName }}</p>
    </div>
    <div nz-col nzXs="24" nzMd="12" class="highlight-chart">
      <div class="timeline-header">未來趨勢</div>
      <div class="timeline">
        @for (point of highlight.timeline; track point.label) {
        <div class="timeline-point">
          <span class="timeline-temp">{{ point.temperature }}°C</span>
          <span class="timeline-label">{{ point.label }}</span>
        </div>
        }
      </div>
    </div>
  </div>
</nz-card>
}

@if (dailySummaries().length > 0) {
<nz-card [nzBordered]="false" class="mb-md">
  <nz-tabs nzType="card">
    <nz-tab nzTitle="氣溫">
      <div class="daily-grid">
        @for (item of dailySummaries(); track item.label) {
        <div class="daily-item">
          <div class="daily-day">{{ item.label }}</div>
          @if (item.temperatureHigh || item.temperatureLow) {
          <div class="daily-temp">
            <span>{{ item.temperatureHigh ?? '—' }}</span>
            <span>{{ item.temperatureLow ?? '—' }}</span>
          </div>
          }
          <div class="daily-desc">{{ item.description || '—' }}</div>
          @if (item.rainProbability) {
          <div class="daily-meta text-muted">降雨機率：{{ item.rainProbability }}</div>
          }
        </div>
        }
      </div>
    </nz-tab>
  </nz-tabs>
</nz-card>
} @else {
<nz-card [nzBordered]="false">
  <nz-empty [nzNotFoundContent]="'目前無對應時間區段資料'" [nzNotFoundImage]="'simple'"></nz-empty>
</nz-card>
}
} @else {
<nz-card [nzBordered]="false">
  <nz-empty [nzNotFoundContent]="'尚未載入天氣資料'" [nzNotFoundImage]="'simple'"></nz-empty>
</nz-card>
}
}