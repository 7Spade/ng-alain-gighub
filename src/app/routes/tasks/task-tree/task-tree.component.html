<page-header [title]="'任務樹狀視圖'">
  <ng-template #extra>
    <button nz-button nzType="primary" (click)="router.navigate(['/tasks/create'])">
      <span nz-icon nzType="plus"></span>
      新建任務
    </button>
  </ng-template>
</page-header>

<nz-card nzTitle="任務樹狀視圖" [nzExtra]="statsTemplate" class="task-tree-card">
  <!-- Blueprint Selector -->
  <div class="task-tree-filters">
    <nz-form-item>
      <nz-form-label>選擇藍圖</nz-form-label>
      <nz-form-control>
        <nz-select
          [ngModel]="selectedBlueprintId()"
          (ngModelChange)="onBlueprintChange($event)"
          nzPlaceHolder="請選擇藍圖"
          nzShowSearch
          style="width: 300px;"
        >
          <!-- TODO: Add blueprint options -->
          <nz-option nzValue="test-blueprint-1" nzLabel="測試藍圖 1"></nz-option>
        </nz-select>
      </nz-form-control>
    </nz-form-item>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <nz-spin nzSimple></nz-spin>
      <p>載入任務中...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <nz-alert
      nzType="error"
      nzMessage="載入失敗"
      [nzDescription]="error()"
      nzShowIcon
      nzCloseable
    ></nz-alert>
  }

  <!-- Empty State -->
  @if (!loading() && !error() && taskTree().length === 0) {
    <nz-empty
      nzNotFoundContent="暫無任務"
      [nzNotFoundFooter]="emptyFooter"
    ></nz-empty>
    <ng-template #emptyFooter>
      <button nz-button nzType="primary" (click)="router.navigate(['/tasks/create'])">
        建立第一個任務
      </button>
    </ng-template>
  }

  <!-- Task Tree -->
  @if (!loading() && !error() && treeData().length > 0) {
    <div class="task-tree-container">
      <nz-tree
        [nzData]="treeData()"
        nzShowLine
        nzShowIcon
        (nzExpandChange)="onExpandChange($event)"
        (nzClick)="onTreeNodeClick($event)"
      >
        <ng-template #nzTreeTemplate let-node>
          <div class="task-node">
            <!-- Task Icon -->
            <span 
              nz-icon 
              [nzType]="getStatusIcon(node.origin.status || 'pending')" 
              class="task-icon"
            ></span>

            <!-- Task Name -->
            <span class="task-name">{{ node.origin.title }}</span>

            <!-- Task Status Tag -->
            <nz-tag [nzColor]="getStatusColor(node.origin.status || 'pending')" class="task-status">
              {{ getStatusLabel(node.origin.status || 'pending') }}
            </nz-tag>

            <!-- Task Priority -->
            @if (node.origin.priority) {
              <nz-tag 
                [nzColor]="node.origin.priority === 'high' ? 'red' : node.origin.priority === 'medium' ? 'orange' : 'default'"
                class="task-priority"
              >
                @switch (node.origin.priority) {
                  @case ('high') { 高優先 }
                  @case ('medium') { 中優先 }
                  @case ('low') { 低優先 }
                }
              </nz-tag>
            }

            <!-- Assignee Info -->
            @if (node.origin.assigned_to) {
              <span class="task-assignee">
                <span nz-icon nzType="user"></span>
                <span class="assignee-name">{{ node.origin.assigned_to }}</span>
              </span>
            }

            <!-- Task Type -->
            @if (node.origin.task_type) {
              <span class="task-type">
                @switch (node.origin.task_type) {
                  @case ('construction') { <span nz-icon nzType="build"></span> 施工 }
                  @case ('design') { <span nz-icon nzType="sketch"></span> 設計 }
                  @case ('inspection') { <span nz-icon nzType="safety"></span> 檢查 }
                  @case ('documentation') { <span nz-icon nzType="file-text"></span> 文檔 }
                  @case ('other') { <span nz-icon nzType="ellipsis"></span> 其他 }
                }
              </span>
            }

            <!-- Due Date -->
            @if (node.origin.due_date) {
              <span class="task-due-date">
                <span nz-icon nzType="calendar"></span>
                {{ node.origin.due_date | date:'yyyy-MM-dd' }}
              </span>
            }
          </div>
        </ng-template>
      </nz-tree>
    </div>
  }
</nz-card>

<!-- Stats Template for Card Extra -->
<ng-template #statsTemplate>
  <div class="task-stats">
    <nz-statistic 
      [nzValue]="taskStats().total" 
      [nzTitle]="'總任務'"
      [nzValueStyle]="{ fontSize: '20px' }"
    ></nz-statistic>
    <nz-divider nzType="vertical"></nz-divider>
    <nz-statistic 
      [nzValue]="taskStats().pending" 
      [nzTitle]="'待處理'"
      [nzValueStyle]="{ fontSize: '18px', color: '#999' }"
    ></nz-statistic>
    <nz-divider nzType="vertical"></nz-divider>
    <nz-statistic 
      [nzValue]="taskStats().inProgress" 
      [nzTitle]="'進行中'"
      [nzValueStyle]="{ fontSize: '18px', color: '#1890ff' }"
    ></nz-statistic>
    <nz-divider nzType="vertical"></nz-divider>
    <nz-statistic 
      [nzValue]="taskStats().completed" 
      [nzTitle]="'已完成'"
      [nzValueStyle]="{ fontSize: '18px', color: '#52c41a' }"
    ></nz-statistic>
  </div>
</ng-template>
