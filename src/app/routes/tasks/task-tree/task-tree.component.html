<page-header [title]="'任務樹狀視圖'">
  <ng-template #extra>
    <!-- Phase 5: Connection Status Indicator -->
    <app-connection-status 
      [status]="connectionStatus()"
      [lastUpdated]="lastConnectionUpdate()"
      [reconnectFn]="reconnectFn"
      style="margin-right: 16px;"
    />
    
    <button nz-button nzType="primary" (click)="router.navigate(['/tasks/create'])">
      <span nz-icon nzType="plus"></span>
      新建任務
    </button>
  </ng-template>
</page-header>

<nz-card nzTitle="任務樹狀視圖" [nzExtra]="statsTemplate" class="task-tree-card">
  <!-- Blueprint Selector -->
  <div class="task-tree-filters">
    <nz-form-item>
      <nz-form-label>選擇藍圖</nz-form-label>
      <nz-form-control>
        <nz-select
          [ngModel]="selectedBlueprintId()"
          (ngModelChange)="onBlueprintChange($event)"
          nzPlaceHolder="請選擇藍圖"
          nzShowSearch
          style="width: 300px;"
        >
          @for (blueprint of blueprintService.blueprints(); track blueprint.id) {
            <nz-option [nzValue]="blueprint.id" [nzLabel]="blueprint.name"></nz-option>
          }
        </nz-select>
      </nz-form-control>
    </nz-form-item>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <nz-spin nzSimple></nz-spin>
      <p>載入任務中...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <nz-alert
      nzType="error"
      nzMessage="載入失敗"
      [nzDescription]="error()"
      nzShowIcon
      nzCloseable
    ></nz-alert>
  }

  <!-- Empty State -->
  @if (!loading() && !error() && taskTree().length === 0) {
    <nz-empty
      nzNotFoundContent="暫無任務"
      [nzNotFoundFooter]="emptyFooter"
    ></nz-empty>
    <ng-template #emptyFooter>
      <button nz-button nzType="primary" (click)="router.navigate(['/tasks/create'])">
        建立第一個任務
      </button>
    </ng-template>
  }

  <!-- Task Tree with Drag-Drop -->
  @if (!loading() && !error() && treeData().length > 0) {
    <div class="task-tree-container" [class.is-dragging]="isDragging()">
      <!-- Phase 2.1.4: CDK DropList container -->
      <div cdkDropList [cdkDropListData]="taskTree()" (cdkDropListDropped)="onDrop($event)">
        <nz-tree
          [nzData]="treeData()"
          nzShowLine
          nzShowIcon
          (nzExpandChange)="onExpandChange($event)"
          (nzClick)="onTreeNodeClick($event)"
        >
          <ng-template #nzTreeTemplate let-node>
            <!-- Phase 2.1.4: CDK Drag wrapper -->
            <div 
              cdkDrag
              [cdkDragData]="node.origin"
              (cdkDragStarted)="onDragStarted(node.origin)"
              (cdkDragEnded)="onDragEnded()"
              class="task-node"
              [class.invalid-drop-target]="isDragging() && !canDropOn(node.origin.id)"
              [class.valid-drop-target]="isDragging() && canDropOn(node.origin.id)"
            >
              <!-- Phase 2.1.4: Drag handle -->
              <span cdkDragHandle class="drag-handle">
                <span nz-icon nzType="drag" nzTheme="outline"></span>
              </span>

              <!-- Task Icon -->
              <span 
                nz-icon 
                [nzType]="getStatusIcon(node.origin.status || 'pending')" 
                class="task-icon"
              ></span>

              <!-- Task Name -->
              <span class="task-name">{{ node.origin.title }}</span>

              <!-- Task Status Switcher (Phase 3.1.3) -->
              <app-task-status-switcher
                [taskId]="node.origin.id"
                [currentStatus]="node.origin.status || 'pending'"
                (statusChanged)="onStatusChange($event)"
                class="task-status"
              />

              <!-- Task Assignee Selector (Phase 3.2) -->
              <app-task-assignee-selector
                [taskId]="node.origin.id"
                [currentAssigneeId]="node.origin.assigned_to"
                [blueprintId]="selectedBlueprintId()"
                (assigneeChanged)="onAssignmentChange($event)"
                class="task-assignee"
              />

              <!-- Task Priority -->
              @if (node.origin.priority) {
                <nz-tag 
                  [nzColor]="node.origin.priority === 'high' ? 'red' : node.origin.priority === 'medium' ? 'orange' : 'default'"
                  class="task-priority"
                >
                  @switch (node.origin.priority) {
                    @case ('high') { 高優先 }
                    @case ('medium') { 中優先 }
                    @case ('low') { 低優先 }
                  }
                </nz-tag>
              }

              <!-- Task Type -->
              @if (node.origin.task_type) {
                <span class="task-type">
                  @switch (node.origin.task_type) {
                    @case ('construction') { <span nz-icon nzType="build"></span> 施工 }
                    @case ('design') { <span nz-icon nzType="sketch"></span> 設計 }
                    @case ('inspection') { <span nz-icon nzType="safety"></span> 檢查 }
                    @case ('documentation') { <span nz-icon nzType="file-text"></span> 文檔 }
                    @case ('other') { <span nz-icon nzType="ellipsis"></span> 其他 }
                  }
                </span>
              }

              <!-- Due Date -->
              @if (node.origin.due_date) {
                <span class="task-due-date">
                  <span nz-icon nzType="calendar"></span>
                  {{ node.origin.due_date | date:'yyyy-MM-dd' }}
                </span>
              }
            </div>
          </ng-template>
        </nz-tree>
      </div>
    </div>
  }
</nz-card>

<!-- Stats Template for Card Extra -->
<ng-template #statsTemplate>
  <div class="task-stats">
    <nz-statistic 
      [nzValue]="taskStats().total" 
      [nzTitle]="'總任務'"
      [nzValueStyle]="{ fontSize: '20px' }"
    ></nz-statistic>
    <nz-divider nzType="vertical"></nz-divider>
    <nz-statistic 
      [nzValue]="taskStats().pending" 
      [nzTitle]="'待處理'"
      [nzValueStyle]="{ fontSize: '18px', color: '#999' }"
    ></nz-statistic>
    <nz-divider nzType="vertical"></nz-divider>
    <nz-statistic 
      [nzValue]="taskStats().inProgress" 
      [nzTitle]="'進行中'"
      [nzValueStyle]="{ fontSize: '18px', color: '#1890ff' }"
    ></nz-statistic>
    <nz-divider nzType="vertical"></nz-divider>
    <nz-statistic 
      [nzValue]="taskStats().completed" 
      [nzTitle]="'已完成'"
      [nzValueStyle]="{ fontSize: '18px', color: '#52c41a' }"
    ></nz-statistic>
  </div>
</ng-template>
